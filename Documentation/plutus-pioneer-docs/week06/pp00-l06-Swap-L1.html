<!-- HTML generated using hilite.me --><div style="background: #f0f3f3; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #0099FF; font-style: italic">{-# LANGUAGE DataKinds             #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE DeriveAnyClass        #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE DeriveGeneric         #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE FlexibleContexts      #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE MultiParamTypeClasses #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE NoImplicitPrelude     #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE OverloadedStrings     #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE ScopedTypeVariables   #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE TemplateHaskell       #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE TypeApplications      #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE TypeFamilies          #-}</span>
<span style="color: #0099FF; font-style: italic">{-# LANGUAGE TypeOperators         #-}</span>

<span style="color: #006699; font-weight: bold">module</span> <span style="color: #00CCFF; font-weight: bold">Week06.Oracle.Swap</span>
    ( <span style="color: #007788; font-weight: bold">SwapSchema</span>
    , <span style="color: #CC00FF">swap</span>
    ) <span style="color: #006699; font-weight: bold">where</span>

<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Control.Monad</span>        <span style="color: #006699; font-weight: bold">hiding</span> (<span style="color: #CC00FF">fmap</span>)
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Data.List</span>            (<span style="color: #CC00FF">find</span>)
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #006699; font-weight: bold">qualified</span> <span style="color: #00CCFF; font-weight: bold">Data.Map</span>             <span style="color: #006699; font-weight: bold">as</span> Map
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Data.Maybe</span>           (<span style="color: #CC00FF">mapMaybe</span>)
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Data.Monoid</span>          (<span style="color: #007788; font-weight: bold">Last</span> (<span style="color: #555555">..</span>))
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Data.Text</span>            (<span style="color: #007788; font-weight: bold">Text</span>)
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Plutus.Contract</span>      <span style="color: #006699; font-weight: bold">as</span> Contract hiding (when)
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #006699; font-weight: bold">qualified</span> <span style="color: #00CCFF; font-weight: bold">PlutusTx</span>
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">PlutusTx.Prelude</span>     <span style="color: #006699; font-weight: bold">hiding</span> (<span style="color: #007788; font-weight: bold">Semigroup</span>(<span style="color: #555555">..</span>), (<span style="color: #555555">&lt;$&gt;</span>), <span style="color: #CC00FF">unless</span>, <span style="color: #CC00FF">mapMaybe</span>, <span style="color: #CC00FF">find</span>)
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Ledger</span>               <span style="color: #006699; font-weight: bold">hiding</span> (<span style="color: #CC00FF">singleton</span>)
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Ledger.Constraints</span>   <span style="color: #006699; font-weight: bold">as</span> Constraints
<span style="color: #006699; font-weight: bold">import</span> <span style="color: #006699; font-weight: bold">qualified</span> <span style="color: #00CCFF; font-weight: bold">Ledger.Typed.Scripts</span> <span style="color: #006699; font-weight: bold">as</span> Scripts
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Ledger.Ada</span>           <span style="color: #006699; font-weight: bold">as</span> Ada hiding (divide)
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Ledger.Value</span>         <span style="color: #006699; font-weight: bold">as</span> Value
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Prelude</span>              (<span style="color: #007788; font-weight: bold">Semigroup</span> (<span style="color: #555555">..</span>), (<span style="color: #555555">&lt;$&gt;</span>))

<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Week06.Oracle.Core</span>
<span style="color: #006699; font-weight: bold">import</span>           <span style="color: #00CCFF; font-weight: bold">Week06.Oracle.Funds</span>

<span style="color: #0099FF; font-style: italic">{-# INLINABLE price #-}</span>
<span style="color: #CC00FF">price</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Integer</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Integer</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Integer</span>
<span style="color: #CC00FF">price</span> lovelace exchangeRate <span style="color: #000000; font-weight: bold">=</span> (lovelace <span style="color: #555555">*</span> exchangeRate) `divide` <span style="color: #FF6600">1000000</span>

<span style="color: #0099FF; font-style: italic">{-# INLINABLE lovelaces #-}</span>
<span style="color: #CC00FF">lovelaces</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Value</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Integer</span>
<span style="color: #CC00FF">lovelaces</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Ada</span><span style="color: #555555">.</span>getLovelace <span style="color: #555555">.</span> <span style="color: #007788; font-weight: bold">Ada</span><span style="color: #555555">.</span>fromValue

<span style="color: #0099FF; font-style: italic">{-# INLINABLE mkSwapValidator #-}</span>
<span style="color: #CC00FF">mkSwapValidator</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Address</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">PubKeyHash</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #336666">()</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">ScriptContext</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Bool</span>
<span style="color: #CC00FF">mkSwapValidator</span> oracle addr pkh <span style="color: #336666">()</span> ctx <span style="color: #000000; font-weight: bold">=</span>
    txSignedBy info pkh <span style="color: #555555">||</span>
    (traceIfFalse <span style="color: #CC3300">&quot;expected exactly two script inputs&quot;</span> hasTwoScriptInputs <span style="color: #555555">&amp;&amp;</span>
     traceIfFalse <span style="color: #CC3300">&quot;price not paid&quot;</span>                     sellerPaid)

  <span style="color: #006699; font-weight: bold">where</span>
    info <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">TxInfo</span>
    info <span style="color: #000000; font-weight: bold">=</span> scriptContextTxInfo ctx

    oracleInput <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">TxOut</span>
    oracleInput <span style="color: #000000; font-weight: bold">=</span>
      <span style="color: #006699; font-weight: bold">let</span>
        ins <span style="color: #000000; font-weight: bold">=</span> [ o
              <span style="color: #555555">|</span> i <span style="color: #000000; font-weight: bold">&lt;-</span> txInfoInputs info
              , <span style="color: #006699; font-weight: bold">let</span> o <span style="color: #000000; font-weight: bold">=</span> txInInfoResolved i
              , txOutAddress o <span style="color: #555555">==</span> addr
              ]
      <span style="color: #006699; font-weight: bold">in</span>
        <span style="color: #006699; font-weight: bold">case</span> ins <span style="color: #006699; font-weight: bold">of</span>
            [o] <span style="color: #000000; font-weight: bold">-&gt;</span> o
            <span style="color: #006699; font-weight: bold">_</span>   <span style="color: #000000; font-weight: bold">-&gt;</span> traceError <span style="color: #CC3300">&quot;expected exactly one oracle input&quot;</span>

    oracleValue&#39; <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">case</span> oracleValue oracleInput (`findDatum` info) <span style="color: #006699; font-weight: bold">of</span>
        <span style="color: #007788; font-weight: bold">Nothing</span> <span style="color: #000000; font-weight: bold">-&gt;</span> traceError <span style="color: #CC3300">&quot;oracle value not found&quot;</span>
        <span style="color: #007788; font-weight: bold">Just</span> x  <span style="color: #000000; font-weight: bold">-&gt;</span> x

    hasTwoScriptInputs <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Bool</span>
    hasTwoScriptInputs <span style="color: #000000; font-weight: bold">=</span>
      <span style="color: #006699; font-weight: bold">let</span>
        xs <span style="color: #000000; font-weight: bold">=</span> filter (isJust <span style="color: #555555">.</span> toValidatorHash <span style="color: #555555">.</span> txOutAddress <span style="color: #555555">.</span> txInInfoResolved) <span style="color: #555555">$</span> txInfoInputs info
      <span style="color: #006699; font-weight: bold">in</span>
        length xs <span style="color: #555555">==</span> <span style="color: #FF6600">2</span>

    minPrice <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Integer</span>
    minPrice <span style="color: #000000; font-weight: bold">=</span>
      <span style="color: #006699; font-weight: bold">let</span>
        lovelaceIn <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">case</span> findOwnInput ctx <span style="color: #006699; font-weight: bold">of</span>
            <span style="color: #007788; font-weight: bold">Nothing</span> <span style="color: #000000; font-weight: bold">-&gt;</span> traceError <span style="color: #CC3300">&quot;own input not found&quot;</span>
            <span style="color: #007788; font-weight: bold">Just</span> i  <span style="color: #000000; font-weight: bold">-&gt;</span> lovelaces <span style="color: #555555">$</span> txOutValue <span style="color: #555555">$</span> txInInfoResolved i
      <span style="color: #006699; font-weight: bold">in</span>
        price lovelaceIn oracleValue&#39;

    sellerPaid <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Bool</span>
    sellerPaid <span style="color: #000000; font-weight: bold">=</span>
      <span style="color: #006699; font-weight: bold">let</span>
        pricePaid <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Integer</span>
        pricePaid <span style="color: #000000; font-weight: bold">=</span>  assetClassValueOf (valuePaidTo info pkh) (oAsset oracle)
      <span style="color: #006699; font-weight: bold">in</span>
        pricePaid <span style="color: #555555">&gt;=</span> minPrice

<span style="color: #006699; font-weight: bold">data</span> <span style="color: #007788; font-weight: bold">Swapping</span>
<span style="color: #006699; font-weight: bold">instance</span> <span style="color: #007788; font-weight: bold">Scripts</span><span style="color: #555555">.</span><span style="color: #007788; font-weight: bold">ScriptType</span> <span style="color: #007788; font-weight: bold">Swapping</span> <span style="color: #006699; font-weight: bold">where</span>
    <span style="color: #006699; font-weight: bold">type</span> <span style="color: #006699; font-weight: bold">instance</span> <span style="color: #007788; font-weight: bold">DatumType</span> <span style="color: #007788; font-weight: bold">Swapping</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">PubKeyHash</span>
    <span style="color: #006699; font-weight: bold">type</span> <span style="color: #006699; font-weight: bold">instance</span> <span style="color: #007788; font-weight: bold">RedeemerType</span> <span style="color: #007788; font-weight: bold">Swapping</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #336666">()</span>

<span style="color: #CC00FF">swapInst</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Scripts</span><span style="color: #555555">.</span><span style="color: #007788; font-weight: bold">ScriptInstance</span> <span style="color: #007788; font-weight: bold">Swapping</span>
<span style="color: #CC00FF">swapInst</span> oracle <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Scripts</span><span style="color: #555555">.</span>validator <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">Swapping</span>
    (<span style="color: #555555">$$</span>(<span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>compile [<span style="color: #555555">||</span> mkSwapValidator <span style="color: #555555">||</span>])
        `<span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>applyCode` <span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>liftCode oracle
        `<span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>applyCode` <span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>liftCode (oracleAddress oracle))
    <span style="color: #555555">$$</span>(<span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>compile [<span style="color: #555555">||</span> wrap <span style="color: #555555">||</span>])
  <span style="color: #006699; font-weight: bold">where</span>
    wrap <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Scripts</span><span style="color: #555555">.</span>wrapValidator <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">PubKeyHash</span> <span style="color: #555555">@</span><span style="color: #336666">()</span>

<span style="color: #CC00FF">swapValidator</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Validator</span>
<span style="color: #CC00FF">swapValidator</span> <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Scripts</span><span style="color: #555555">.</span>validatorScript <span style="color: #555555">.</span> swapInst

<span style="color: #CC00FF">swapAddress</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Ledger</span><span style="color: #555555">.</span><span style="color: #007788; font-weight: bold">Address</span>
<span style="color: #CC00FF">swapAddress</span> <span style="color: #000000; font-weight: bold">=</span> scriptAddress <span style="color: #555555">.</span> swapValidator

<span style="color: #CC00FF">offerSwap</span> <span style="color: #000000; font-weight: bold">::</span> forall w s<span style="color: #555555">.</span> <span style="color: #007788; font-weight: bold">HasBlockchainActions</span> s <span style="color: #000000; font-weight: bold">=&gt;</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Integer</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span> w s <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
<span style="color: #CC00FF">offerSwap</span> oracle amt <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">do</span>
    pkh <span style="color: #000000; font-weight: bold">&lt;-</span> pubKeyHash <span style="color: #555555">&lt;$&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span><span style="color: #555555">.</span>ownPubKey
    <span style="color: #006699; font-weight: bold">let</span> tx <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>mustPayToTheScript pkh <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">Ada</span><span style="color: #555555">.</span>lovelaceValueOf amt
    ledgerTx <span style="color: #000000; font-weight: bold">&lt;-</span> submitTxConstraints (swapInst oracle) tx
    awaitTxConfirmed <span style="color: #555555">$</span> txId ledgerTx
    logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #555555">$</span> <span style="color: #CC3300">&quot;offered &quot;</span> <span style="color: #555555">++</span> show amt <span style="color: #555555">++</span> <span style="color: #CC3300">&quot; lovelace for swap&quot;</span>

<span style="color: #CC00FF">findSwaps</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">HasBlockchainActions</span> s <span style="color: #000000; font-weight: bold">=&gt;</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> (<span style="color: #007788; font-weight: bold">PubKeyHash</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Bool</span>) <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span> w s <span style="color: #007788; font-weight: bold">Text</span> [(<span style="color: #007788; font-weight: bold">TxOutRef</span>, <span style="color: #007788; font-weight: bold">TxOutTx</span>, <span style="color: #007788; font-weight: bold">PubKeyHash</span>)]
<span style="color: #CC00FF">findSwaps</span> oracle p <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">do</span>
    utxos <span style="color: #000000; font-weight: bold">&lt;-</span> utxoAt <span style="color: #555555">$</span> swapAddress oracle
    return <span style="color: #555555">$</span> mapMaybe g <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">Map</span><span style="color: #555555">.</span>toList utxos
  <span style="color: #006699; font-weight: bold">where</span>
    f <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">TxOutTx</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Maybe</span> <span style="color: #007788; font-weight: bold">PubKeyHash</span>
    f o <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">do</span>
        dh        <span style="color: #000000; font-weight: bold">&lt;-</span> txOutDatumHash <span style="color: #555555">$</span> txOutTxOut o
        (<span style="color: #007788; font-weight: bold">Datum</span> d) <span style="color: #000000; font-weight: bold">&lt;-</span> <span style="color: #007788; font-weight: bold">Map</span><span style="color: #555555">.</span>lookup dh <span style="color: #555555">$</span> txData <span style="color: #555555">$</span> txOutTxTx o
        <span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>fromData d

    g <span style="color: #000000; font-weight: bold">::</span> (<span style="color: #007788; font-weight: bold">TxOutRef</span>, <span style="color: #007788; font-weight: bold">TxOutTx</span>) <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Maybe</span> (<span style="color: #007788; font-weight: bold">TxOutRef</span>, <span style="color: #007788; font-weight: bold">TxOutTx</span>, <span style="color: #007788; font-weight: bold">PubKeyHash</span>)
    g (oref, o) <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">do</span>
        pkh <span style="color: #000000; font-weight: bold">&lt;-</span> f o
        guard <span style="color: #555555">$</span> p pkh
        return (oref, o, pkh)

<span style="color: #CC00FF">retrieveSwaps</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">HasBlockchainActions</span> s <span style="color: #000000; font-weight: bold">=&gt;</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span> w s <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
<span style="color: #CC00FF">retrieveSwaps</span> oracle <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">do</span>
    pkh <span style="color: #000000; font-weight: bold">&lt;-</span> pubKeyHash <span style="color: #555555">&lt;$&gt;</span> ownPubKey
    xs <span style="color: #000000; font-weight: bold">&lt;-</span> findSwaps oracle (<span style="color: #555555">==</span> pkh)
    <span style="color: #006699; font-weight: bold">case</span> xs <span style="color: #006699; font-weight: bold">of</span>
        <span style="color: #007788; font-weight: bold">[]</span> <span style="color: #000000; font-weight: bold">-&gt;</span> logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #CC3300">&quot;no swaps found&quot;</span>
        <span style="color: #006699; font-weight: bold">_</span>  <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #006699; font-weight: bold">do</span>
            <span style="color: #006699; font-weight: bold">let</span> lookups <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>unspentOutputs (<span style="color: #007788; font-weight: bold">Map</span><span style="color: #555555">.</span>fromList [(oref, o) <span style="color: #555555">|</span> (oref, o, <span style="color: #006699; font-weight: bold">_</span>) <span style="color: #000000; font-weight: bold">&lt;-</span> xs]) <span style="color: #555555">&lt;&gt;</span>
                          <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>otherScript (swapValidator oracle)
                tx      <span style="color: #000000; font-weight: bold">=</span> mconcat [<span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>mustSpendScriptOutput oref <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">Redeemer</span> <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>toData <span style="color: #336666">()</span> <span style="color: #555555">|</span> (oref, <span style="color: #006699; font-weight: bold">_</span>, <span style="color: #006699; font-weight: bold">_</span>) <span style="color: #000000; font-weight: bold">&lt;-</span> xs]
            ledgerTx <span style="color: #000000; font-weight: bold">&lt;-</span> submitTxConstraintsWith <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">Swapping</span> lookups tx
            awaitTxConfirmed <span style="color: #555555">$</span> txId ledgerTx
            logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #555555">$</span> <span style="color: #CC3300">&quot;retrieved &quot;</span> <span style="color: #555555">++</span> show (length xs) <span style="color: #555555">++</span> <span style="color: #CC3300">&quot; swap(s)&quot;</span>

<span style="color: #CC00FF">useSwap</span> <span style="color: #000000; font-weight: bold">::</span> forall w s<span style="color: #555555">.</span> <span style="color: #007788; font-weight: bold">HasBlockchainActions</span> s <span style="color: #000000; font-weight: bold">=&gt;</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span> w s <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
<span style="color: #CC00FF">useSwap</span> oracle <span style="color: #000000; font-weight: bold">=</span> <span style="color: #006699; font-weight: bold">do</span>
    funds <span style="color: #000000; font-weight: bold">&lt;-</span> ownFunds
    <span style="color: #006699; font-weight: bold">let</span> amt <span style="color: #000000; font-weight: bold">=</span> assetClassValueOf funds <span style="color: #555555">$</span> oAsset oracle
    logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #555555">$</span> <span style="color: #CC3300">&quot;available assets: &quot;</span> <span style="color: #555555">++</span> show amt

    m <span style="color: #000000; font-weight: bold">&lt;-</span> findOracle oracle
    <span style="color: #006699; font-weight: bold">case</span> m <span style="color: #006699; font-weight: bold">of</span>
        <span style="color: #007788; font-weight: bold">Nothing</span>           <span style="color: #000000; font-weight: bold">-&gt;</span> logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #CC3300">&quot;oracle not found&quot;</span>
        <span style="color: #007788; font-weight: bold">Just</span> (oref, o, x) <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #006699; font-weight: bold">do</span>
            logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #555555">$</span> <span style="color: #CC3300">&quot;found oracle, exchange rate &quot;</span> <span style="color: #555555">++</span> show x
            pkh   <span style="color: #000000; font-weight: bold">&lt;-</span> pubKeyHash <span style="color: #555555">&lt;$&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span><span style="color: #555555">.</span>ownPubKey
            swaps <span style="color: #000000; font-weight: bold">&lt;-</span> findSwaps oracle (<span style="color: #555555">/=</span> pkh)
            <span style="color: #006699; font-weight: bold">case</span> find (f amt x) swaps <span style="color: #006699; font-weight: bold">of</span>
                <span style="color: #007788; font-weight: bold">Nothing</span>                <span style="color: #000000; font-weight: bold">-&gt;</span> logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #CC3300">&quot;no suitable swap found&quot;</span>
                <span style="color: #007788; font-weight: bold">Just</span> (oref&#39;, o&#39;, pkh&#39;) <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #006699; font-weight: bold">do</span>
                    <span style="color: #006699; font-weight: bold">let</span> v       <span style="color: #000000; font-weight: bold">=</span> txOutValue (txOutTxOut o) <span style="color: #555555">&lt;&gt;</span> lovelaceValueOf (oFee oracle)
                        p       <span style="color: #000000; font-weight: bold">=</span> assetClassValue (oAsset oracle) <span style="color: #555555">$</span> price (lovelaces <span style="color: #555555">$</span> txOutValue <span style="color: #555555">$</span> txOutTxOut o&#39;) x
                        lookups <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>otherScript (swapValidator oracle)                     <span style="color: #555555">&lt;&gt;</span>
                                  <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>otherScript (oracleValidator oracle)                   <span style="color: #555555">&lt;&gt;</span>
                                  <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>unspentOutputs (<span style="color: #007788; font-weight: bold">Map</span><span style="color: #555555">.</span>fromList [(oref, o), (oref&#39;, o&#39;)])
                        tx      <span style="color: #000000; font-weight: bold">=</span> <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>mustSpendScriptOutput oref  (<span style="color: #007788; font-weight: bold">Redeemer</span> <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>toData <span style="color: #007788; font-weight: bold">Use</span>) <span style="color: #555555">&lt;&gt;</span>
                                  <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>mustSpendScriptOutput oref&#39; (<span style="color: #007788; font-weight: bold">Redeemer</span> <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>toData <span style="color: #336666">()</span>)  <span style="color: #555555">&lt;&gt;</span>
                                  <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>mustPayToOtherScript
                                    (validatorHash <span style="color: #555555">$</span> oracleValidator oracle)
                                    (<span style="color: #007788; font-weight: bold">Datum</span> <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">PlutusTx</span><span style="color: #555555">.</span>toData x)
                                    v                                                                      <span style="color: #555555">&lt;&gt;</span>
                                  <span style="color: #007788; font-weight: bold">Constraints</span><span style="color: #555555">.</span>mustPayToPubKey pkh&#39; p
                    ledgerTx <span style="color: #000000; font-weight: bold">&lt;-</span> submitTxConstraintsWith <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">Swapping</span> lookups tx
                    awaitTxConfirmed <span style="color: #555555">$</span> txId ledgerTx
                    logInfo <span style="color: #555555">@</span><span style="color: #007788; font-weight: bold">String</span> <span style="color: #555555">$</span> <span style="color: #CC3300">&quot;made swap with price &quot;</span> <span style="color: #555555">++</span> show (<span style="color: #007788; font-weight: bold">Value</span><span style="color: #555555">.</span>flattenValue p)
  <span style="color: #006699; font-weight: bold">where</span>
    getPrice <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Integer</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">TxOutTx</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Integer</span>
    getPrice x o <span style="color: #000000; font-weight: bold">=</span> price (lovelaces <span style="color: #555555">$</span> txOutValue <span style="color: #555555">$</span> txOutTxOut o) x

    f <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Integer</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Integer</span> <span style="color: #000000; font-weight: bold">-&gt;</span> (<span style="color: #007788; font-weight: bold">TxOutRef</span>, <span style="color: #007788; font-weight: bold">TxOutTx</span>, <span style="color: #007788; font-weight: bold">PubKeyHash</span>) <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Bool</span>
    f amt x (<span style="color: #006699; font-weight: bold">_</span>, o, <span style="color: #006699; font-weight: bold">_</span>) <span style="color: #000000; font-weight: bold">=</span> getPrice x o <span style="color: #555555">&lt;=</span> amt

<span style="color: #006699; font-weight: bold">type</span> <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #000000; font-weight: bold">=</span>
    <span style="color: #007788; font-weight: bold">BlockchainActions</span>
        <span style="color: #555555">.\/</span> <span style="color: #007788; font-weight: bold">Endpoint</span> <span style="color: #CC3300">&quot;offer&quot;</span>    <span style="color: #007788; font-weight: bold">Integer</span>
        <span style="color: #555555">.\/</span> <span style="color: #007788; font-weight: bold">Endpoint</span> <span style="color: #CC3300">&quot;retrieve&quot;</span> <span style="color: #336666">()</span>
        <span style="color: #555555">.\/</span> <span style="color: #007788; font-weight: bold">Endpoint</span> <span style="color: #CC3300">&quot;use&quot;</span>      <span style="color: #336666">()</span>
        <span style="color: #555555">.\/</span> <span style="color: #007788; font-weight: bold">Endpoint</span> <span style="color: #CC3300">&quot;funds&quot;</span>    <span style="color: #336666">()</span>

<span style="color: #CC00FF">swap</span> <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Oracle</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span> (<span style="color: #007788; font-weight: bold">Last</span> <span style="color: #007788; font-weight: bold">Value</span>) <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
<span style="color: #CC00FF">swap</span> oracle <span style="color: #000000; font-weight: bold">=</span> (offer `select` retrieve `select` use `select` funds) <span style="color: #555555">&gt;&gt;</span> swap oracle
  <span style="color: #006699; font-weight: bold">where</span>
    offer <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Contract</span> (<span style="color: #007788; font-weight: bold">Last</span> <span style="color: #007788; font-weight: bold">Value</span>) <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
    offer <span style="color: #000000; font-weight: bold">=</span> h <span style="color: #555555">$</span> <span style="color: #006699; font-weight: bold">do</span>
        amt <span style="color: #000000; font-weight: bold">&lt;-</span> endpoint <span style="color: #555555">@</span><span style="color: #CC3300">&quot;offer&quot;</span>
        offerSwap oracle amt

    retrieve <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Contract</span> (<span style="color: #007788; font-weight: bold">Last</span> <span style="color: #007788; font-weight: bold">Value</span>) <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
    retrieve <span style="color: #000000; font-weight: bold">=</span> h <span style="color: #555555">$</span> <span style="color: #006699; font-weight: bold">do</span>
        endpoint <span style="color: #555555">@</span><span style="color: #CC3300">&quot;retrieve&quot;</span>
        retrieveSwaps oracle

    use <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Contract</span> (<span style="color: #007788; font-weight: bold">Last</span> <span style="color: #007788; font-weight: bold">Value</span>) <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
    use <span style="color: #000000; font-weight: bold">=</span> h <span style="color: #555555">$</span> <span style="color: #006699; font-weight: bold">do</span>
        endpoint <span style="color: #555555">@</span><span style="color: #CC3300">&quot;use&quot;</span>
        useSwap oracle

    funds <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Contract</span> (<span style="color: #007788; font-weight: bold">Last</span> <span style="color: #007788; font-weight: bold">Value</span>) <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
    funds <span style="color: #000000; font-weight: bold">=</span> h <span style="color: #555555">$</span> <span style="color: #006699; font-weight: bold">do</span>
        endpoint <span style="color: #555555">@</span><span style="color: #CC3300">&quot;funds&quot;</span>
        v <span style="color: #000000; font-weight: bold">&lt;-</span> ownFunds
        tell <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">Last</span> <span style="color: #555555">$</span> <span style="color: #007788; font-weight: bold">Just</span> v

    h <span style="color: #000000; font-weight: bold">::</span> <span style="color: #007788; font-weight: bold">Contract</span> (<span style="color: #007788; font-weight: bold">Last</span> <span style="color: #007788; font-weight: bold">Value</span>) <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span> <span style="color: #000000; font-weight: bold">-&gt;</span> <span style="color: #007788; font-weight: bold">Contract</span> (<span style="color: #007788; font-weight: bold">Last</span> <span style="color: #007788; font-weight: bold">Value</span>) <span style="color: #007788; font-weight: bold">SwapSchema</span> <span style="color: #007788; font-weight: bold">Text</span> <span style="color: #336666">()</span>
    h <span style="color: #000000; font-weight: bold">=</span> handleError logError
</pre></td></tr></table></div>


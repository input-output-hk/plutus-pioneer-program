<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Distribution/Backpack/Id.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE FlexibleInstances #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE PatternGuards #-}</span>
<a name="line-4"></a><span class='hs-comment'>-- | See &lt;https://github.com/ezyang/ghc-proposals/blob/backpack/proposals/0000-backpack.rst&gt;</span>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Distribution.Backpack.Id</span><span class='hs-layout'>(</span>
<a name="line-6"></a>    <span class='hs-varid'>computeComponentId</span><span class='hs-layout'>,</span>
<a name="line-7"></a>    <span class='hs-varid'>computeCompatPackageKey</span><span class='hs-layout'>,</span>
<a name="line-8"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-conid'>()</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Prelude</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.UnqualComponentName</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.Compiler</span>
<a name="line-15"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.PackageDescription</span>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.Setup</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Setup</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Distribution.Simple.InstallDirs</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>InstallDirs</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.LocalBuildInfo</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.ComponentId</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.UnitId</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.MungedPackageName</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Utils.Base62</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Version</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Pretty</span>
<a name="line-26"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>prettyShow</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Parsec</span> <span class='hs-layout'>(</span> <span class='hs-varid'>simpleParsec</span> <span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="computeComponentId"></a><span class='hs-comment'>-- | This method computes a default, "good enough" 'ComponentId'</span>
<a name="line-30"></a><span class='hs-comment'>-- for a package.  The intent is that cabal-install (or the user) will</span>
<a name="line-31"></a><span class='hs-comment'>-- specify a more detailed IPID via the @--ipid@ flag if necessary.</span>
<a name="line-32"></a><span class='hs-definition'>computeComponentId</span>
<a name="line-33"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- deterministic mode</span>
<a name="line-34"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Flag</span> <span class='hs-conid'>String</span>
<a name="line-35"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Flag</span> <span class='hs-conid'>ComponentId</span>
<a name="line-36"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageIdentifier</span>
<a name="line-37"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComponentName</span>
<a name="line-38"></a>    <span class='hs-comment'>-- This is used by cabal-install's legacy codepath</span>
<a name="line-39"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>ComponentId</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>FlagAssignment</span><span class='hs-layout'>)</span>
<a name="line-40"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComponentId</span>
<a name="line-41"></a><span class='hs-definition'>computeComponentId</span> <span class='hs-varid'>deterministic</span> <span class='hs-varid'>mb_ipid</span> <span class='hs-varid'>mb_cid</span> <span class='hs-varid'>pid</span> <span class='hs-varid'>cname</span> <span class='hs-varid'>mb_details</span> <span class='hs-keyglyph'>=</span>
<a name="line-42"></a>    <span class='hs-comment'>-- show is found to be faster than intercalate and then replacement of</span>
<a name="line-43"></a>    <span class='hs-comment'>-- special character used in intercalating. We cannot simply hash by</span>
<a name="line-44"></a>    <span class='hs-comment'>-- doubly concating list, as it just flatten out the nested list, so</span>
<a name="line-45"></a>    <span class='hs-comment'>-- different sources can produce same hash</span>
<a name="line-46"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>hash_suffix</span>
<a name="line-47"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>dep_ipids</span><span class='hs-layout'>,</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_details</span>
<a name="line-48"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-str'>"-"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>hashToBase62</span>
<a name="line-49"></a>                <span class='hs-comment'>-- For safety, include the package + version here</span>
<a name="line-50"></a>                <span class='hs-comment'>-- for GHC 7.10, where just the hash is used as</span>
<a name="line-51"></a>                <span class='hs-comment'>-- the package key</span>
<a name="line-52"></a>                    <span class='hs-layout'>(</span>    <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>pid</span>
<a name="line-53"></a>                      <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>dep_ipids</span>
<a name="line-54"></a>                      <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>flags</span>     <span class='hs-layout'>)</span>
<a name="line-55"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>""</span>
<a name="line-56"></a>        <span class='hs-varid'>generated_base</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>pid</span> <span class='hs-varop'>++</span> <span class='hs-varid'>hash_suffix</span>
<a name="line-57"></a>        <span class='hs-varid'>explicit_base</span> <span class='hs-varid'>cid0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromPathTemplate</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstallDirs.substPathTemplate</span> <span class='hs-varid'>env</span>
<a name="line-58"></a>                                                    <span class='hs-layout'>(</span><span class='hs-varid'>toPathTemplate</span> <span class='hs-varid'>cid0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-59"></a>            <span class='hs-comment'>-- Hack to reuse install dirs machinery</span>
<a name="line-60"></a>            <span class='hs-comment'>-- NB: no real IPID available at this point</span>
<a name="line-61"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>packageTemplateEnv</span> <span class='hs-varid'>pid</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnitId</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-62"></a>        <span class='hs-varid'>actual_base</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_ipid</span> <span class='hs-keyword'>of</span>
<a name="line-63"></a>                        <span class='hs-conid'>Flag</span> <span class='hs-varid'>ipid0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>explicit_base</span> <span class='hs-varid'>ipid0</span>
<a name="line-64"></a>                        <span class='hs-conid'>NoFlag</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>deterministic</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>pid</span>
<a name="line-65"></a>                               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>generated_base</span>
<a name="line-66"></a>    <span class='hs-keyword'>in</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_cid</span> <span class='hs-keyword'>of</span>
<a name="line-67"></a>          <span class='hs-conid'>Flag</span> <span class='hs-varid'>cid</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cid</span>
<a name="line-68"></a>          <span class='hs-conid'>NoFlag</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkComponentId</span> <span class='hs-varop'>$</span> <span class='hs-varid'>actual_base</span>
<a name="line-69"></a>                        <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>componentNameString</span> <span class='hs-varid'>cname</span> <span class='hs-keyword'>of</span>
<a name="line-70"></a>                                <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<a name="line-71"></a>                                <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"-"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>unUnqualComponentName</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="computeCompatPackageKey"></a><span class='hs-comment'>-- | In GHC 8.0, the string we pass to GHC to use for symbol</span>
<a name="line-74"></a><span class='hs-comment'>-- names for a package can be an arbitrary, IPID-compatible string.</span>
<a name="line-75"></a><span class='hs-comment'>-- However, prior to GHC 8.0 there are some restrictions on what</span>
<a name="line-76"></a><span class='hs-comment'>-- format this string can be (due to how ghc-pkg parsed the key):</span>
<a name="line-77"></a><span class='hs-comment'>--</span>
<a name="line-78"></a><span class='hs-comment'>--      1. In GHC 7.10, the string had either be of the form</span>
<a name="line-79"></a><span class='hs-comment'>--      foo_ABCD, where foo is a non-semantic alphanumeric/hyphenated</span>
<a name="line-80"></a><span class='hs-comment'>--      prefix and ABCD is two base-64 encoded 64-bit integers,</span>
<a name="line-81"></a><span class='hs-comment'>--      or a GHC 7.8 style identifier.</span>
<a name="line-82"></a><span class='hs-comment'>--</span>
<a name="line-83"></a><span class='hs-comment'>--      2. In GHC 7.8, the string had to be a valid package identifier</span>
<a name="line-84"></a><span class='hs-comment'>--      like foo-0.1.</span>
<a name="line-85"></a><span class='hs-comment'>--</span>
<a name="line-86"></a><span class='hs-comment'>-- So, the problem is that Cabal, in general, has a general IPID,</span>
<a name="line-87"></a><span class='hs-comment'>-- but needs to figure out a package key / package ID that the</span>
<a name="line-88"></a><span class='hs-comment'>-- old ghc-pkg will actually accept.  But there's an EVERY WORSE</span>
<a name="line-89"></a><span class='hs-comment'>-- problem: if ghc-pkg decides to parse an identifier foo-0.1-xxx</span>
<a name="line-90"></a><span class='hs-comment'>-- as if it were a package identifier, which means it will SILENTLY</span>
<a name="line-91"></a><span class='hs-comment'>-- DROP the "xxx" (because it's a tag, and Cabal does not allow tags.)</span>
<a name="line-92"></a><span class='hs-comment'>-- So we must CONNIVE to ensure that we don't pick something that</span>
<a name="line-93"></a><span class='hs-comment'>-- looks like this.</span>
<a name="line-94"></a><span class='hs-comment'>--</span>
<a name="line-95"></a><span class='hs-comment'>-- So this function attempts to define a mapping into the old formats.</span>
<a name="line-96"></a><span class='hs-comment'>--</span>
<a name="line-97"></a><span class='hs-comment'>-- The mapping for GHC 7.8 and before:</span>
<a name="line-98"></a><span class='hs-comment'>--</span>
<a name="line-99"></a><span class='hs-comment'>--      * We use the *compatibility* package name and version.  For</span>
<a name="line-100"></a><span class='hs-comment'>--        public libraries this is just the package identifier; for</span>
<a name="line-101"></a><span class='hs-comment'>--        internal libraries, it's something like "z-pkgname-z-libname-0.1".</span>
<a name="line-102"></a><span class='hs-comment'>--        See 'computeCompatPackageName' for more details.</span>
<a name="line-103"></a><span class='hs-comment'>--</span>
<a name="line-104"></a><span class='hs-comment'>-- The mapping for GHC 7.10:</span>
<a name="line-105"></a><span class='hs-comment'>--</span>
<a name="line-106"></a><span class='hs-comment'>--      * For CLibName:</span>
<a name="line-107"></a><span class='hs-comment'>--          If the IPID is of the form foo-0.1-ABCDEF where foo_ABCDEF would</span>
<a name="line-108"></a><span class='hs-comment'>--          validly parse as a package key, we pass "ABCDEF".  (NB: not</span>
<a name="line-109"></a><span class='hs-comment'>--          all hashes parse this way, because GHC 7.10 mandated that</span>
<a name="line-110"></a><span class='hs-comment'>--          these hashes be two base-62 encoded 64 bit integers),</span>
<a name="line-111"></a><span class='hs-comment'>--          but hashes that Cabal generated using 'computeComponentId'</span>
<a name="line-112"></a><span class='hs-comment'>--          are guaranteed to have this form.</span>
<a name="line-113"></a><span class='hs-comment'>--</span>
<a name="line-114"></a><span class='hs-comment'>--          If it is not of this form, we rehash the IPID into the</span>
<a name="line-115"></a><span class='hs-comment'>--          correct form and pass that.</span>
<a name="line-116"></a><span class='hs-comment'>--</span>
<a name="line-117"></a><span class='hs-comment'>--      * For sub-components, we rehash the IPID into the correct format</span>
<a name="line-118"></a><span class='hs-comment'>--        and pass that.</span>
<a name="line-119"></a><span class='hs-comment'>--</span>
<a name="line-120"></a><span class='hs-definition'>computeCompatPackageKey</span>
<a name="line-121"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Compiler</span>
<a name="line-122"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MungedPackageName</span>
<a name="line-123"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Version</span>
<a name="line-124"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitId</span>
<a name="line-125"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-126"></a><span class='hs-definition'>computeCompatPackageKey</span> <span class='hs-varid'>comp</span> <span class='hs-varid'>pkg_name</span> <span class='hs-varid'>pkg_version</span> <span class='hs-varid'>uid</span>
<a name="line-127"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageKeySupported</span> <span class='hs-varid'>comp</span> <span class='hs-varop'>||</span> <span class='hs-varid'>unitIdSupported</span> <span class='hs-varid'>comp</span><span class='hs-layout'>)</span>
<a name="line-128"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>pkg_name</span> <span class='hs-varop'>++</span> <span class='hs-str'>"-"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>pkg_version</span>
<a name="line-129"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>unifiedIPIDRequired</span> <span class='hs-varid'>comp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-130"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unUnitId</span> <span class='hs-varid'>uid</span> <span class='hs-comment'>-- assume no Backpack support</span>
<a name="line-131"></a>            <span class='hs-varid'>mb_verbatim_key</span>
<a name="line-132"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>simpleParsec</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PackageId</span> <span class='hs-keyword'>of</span>
<a name="line-133"></a>                    <span class='hs-comment'>-- Something like 'foo-0.1', use it verbatim.</span>
<a name="line-134"></a>                    <span class='hs-comment'>-- (NB: hash tags look like tags, so they are parsed,</span>
<a name="line-135"></a>                    <span class='hs-comment'>-- so the extra equality check tests if a tag was dropped.)</span>
<a name="line-136"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>pid0</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>pid0</span> <span class='hs-varop'>==</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>str</span>
<a name="line-137"></a>                    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-138"></a>            <span class='hs-varid'>mb_truncated_key</span>
<a name="line-139"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cand</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeWhile</span> <span class='hs-varid'>isAlphaNum</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-140"></a>                  <span class='hs-keyword'>in</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>length</span> <span class='hs-varid'>cand</span> <span class='hs-varop'>==</span> <span class='hs-num'>22</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isAlphaNum</span> <span class='hs-varid'>cand</span>
<a name="line-141"></a>                        <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cand</span>
<a name="line-142"></a>                        <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span>
<a name="line-143"></a>            <span class='hs-varid'>rehashed_key</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hashToBase62</span> <span class='hs-varid'>str</span>
<a name="line-144"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>rehashed_key</span> <span class='hs-layout'>(</span><span class='hs-varid'>mb_verbatim_key</span> <span class='hs-varop'>`mplus`</span> <span class='hs-varid'>mb_truncated_key</span><span class='hs-layout'>)</span>
<a name="line-145"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>uid</span>
</pre></body>
</html>

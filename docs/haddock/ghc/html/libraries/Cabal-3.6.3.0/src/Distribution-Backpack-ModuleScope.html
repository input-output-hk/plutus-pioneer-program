<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Distribution/Backpack/ModuleScope.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE DeriveFunctor #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE DeriveTraversable #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE DeriveFoldable #-}</span>
<a name="line-4"></a><span class='hs-comment'>-- | See &lt;https://github.com/ezyang/ghc-proposals/blob/backpack/proposals/0000-backpack.rst&gt;</span>
<a name="line-5"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Distribution.Backpack.ModuleScope</span> <span class='hs-layout'>(</span>
<a name="line-6"></a>    <span class='hs-comment'>-- * Module scopes</span>
<a name="line-7"></a>    <span class='hs-conid'>ModuleScope</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-8"></a>    <span class='hs-conid'>ModuleProvides</span><span class='hs-layout'>,</span>
<a name="line-9"></a>    <span class='hs-conid'>ModuleRequires</span><span class='hs-layout'>,</span>
<a name="line-10"></a>    <span class='hs-conid'>ModuleSource</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-11"></a>    <span class='hs-varid'>dispModuleSource</span><span class='hs-layout'>,</span>
<a name="line-12"></a>    <span class='hs-conid'>WithSource</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-13"></a>    <span class='hs-varid'>unWithSource</span><span class='hs-layout'>,</span>
<a name="line-14"></a>    <span class='hs-varid'>getSource</span><span class='hs-layout'>,</span>
<a name="line-15"></a>    <span class='hs-conid'>ModuleWithSource</span><span class='hs-layout'>,</span>
<a name="line-16"></a>    <span class='hs-varid'>emptyModuleScope</span><span class='hs-layout'>,</span>
<a name="line-17"></a><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-conid'>()</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Prelude</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.ModuleName</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.IncludeRenaming</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.PackageName</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.ComponentName</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.LibraryName</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Pretty</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Backpack</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Backpack.ModSubst</span>
<a name="line-31"></a>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text.PrettyPrint</span>
<a name="line-34"></a>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-comment'>-----------------------------------------------------------------------</span>
<a name="line-37"></a><span class='hs-comment'>-- Module scopes</span>
<a name="line-38"></a>
<a name="line-39"></a><span class='hs-comment'>-- Why is ModuleProvides so complicated?  The basic problem is that</span>
<a name="line-40"></a><span class='hs-comment'>-- we want to support this:</span>
<a name="line-41"></a><span class='hs-comment'>--</span>
<a name="line-42"></a><span class='hs-comment'>--  package p where</span>
<a name="line-43"></a><span class='hs-comment'>--      include q (A)</span>
<a name="line-44"></a><span class='hs-comment'>--      include r (A)</span>
<a name="line-45"></a><span class='hs-comment'>--      module B where</span>
<a name="line-46"></a><span class='hs-comment'>--          import "q" A</span>
<a name="line-47"></a><span class='hs-comment'>--          import "r" A</span>
<a name="line-48"></a><span class='hs-comment'>--</span>
<a name="line-49"></a><span class='hs-comment'>-- Specifically, in Cabal today it is NOT an error have two modules in</span>
<a name="line-50"></a><span class='hs-comment'>-- scope with the same identifier.  So we need to preserve this for</span>
<a name="line-51"></a><span class='hs-comment'>-- Backpack.  The modification is that an ambiguous module name is</span>
<a name="line-52"></a><span class='hs-comment'>-- OK... as long as it is NOT used to fill a requirement!</span>
<a name="line-53"></a><span class='hs-comment'>--</span>
<a name="line-54"></a><span class='hs-comment'>-- So as a first try, we might try deferring unifying provisions that</span>
<a name="line-55"></a><span class='hs-comment'>-- are being glommed together, and check for equality after the fact.</span>
<a name="line-56"></a><span class='hs-comment'>-- But this doesn't work, because what if a multi-module provision</span>
<a name="line-57"></a><span class='hs-comment'>-- is used to fill a requirement?!  So you do the equality test</span>
<a name="line-58"></a><span class='hs-comment'>-- IMMEDIATELY before a requirement fill happens... or never at all.</span>
<a name="line-59"></a><span class='hs-comment'>--</span>
<a name="line-60"></a><span class='hs-comment'>-- Alternate strategy: go ahead and unify, and then if it is revealed</span>
<a name="line-61"></a><span class='hs-comment'>-- that some requirements got filled "out-of-thin-air", error.</span>
<a name="line-62"></a>
<a name="line-63"></a>
<a name="line-64"></a><a name="ModuleScope"></a><span class='hs-comment'>-- | A 'ModuleScope' describes the modules and requirements that</span>
<a name="line-65"></a><a name="ModuleScope"></a><span class='hs-comment'>-- are in-scope as we are processing a Cabal package.  Unlike</span>
<a name="line-66"></a><a name="ModuleScope"></a><span class='hs-comment'>-- a 'ModuleShape', there may be multiple modules in scope at</span>
<a name="line-67"></a><a name="ModuleScope"></a><span class='hs-comment'>-- the same 'ModuleName'; this is only an error if we attempt</span>
<a name="line-68"></a><a name="ModuleScope"></a><span class='hs-comment'>-- to use those modules to fill a requirement.  A 'ModuleScope'</span>
<a name="line-69"></a><a name="ModuleScope"></a><span class='hs-comment'>-- can influence the 'ModuleShape' via a reexport.</span>
<a name="line-70"></a><a name="ModuleScope"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ModuleScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleScope</span> <span class='hs-layout'>{</span>
<a name="line-71"></a>    <span class='hs-varid'>modScopeProvides</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleProvides</span><span class='hs-layout'>,</span>
<a name="line-72"></a>    <span class='hs-varid'>modScopeRequires</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleRequires</span>
<a name="line-73"></a>    <span class='hs-layout'>}</span>
<a name="line-74"></a>
<a name="line-75"></a><a name="emptyModuleScope"></a><span class='hs-comment'>-- | An empty 'ModuleScope'.</span>
<a name="line-76"></a><span class='hs-definition'>emptyModuleScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleScope</span>
<a name="line-77"></a><span class='hs-definition'>emptyModuleScope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleScope</span> <span class='hs-conid'>Map.empty</span> <span class='hs-conid'>Map.empty</span>
<a name="line-78"></a>
<a name="line-79"></a><a name="ModuleProvides"></a><span class='hs-comment'>-- | Every 'Module' in scope at a 'ModuleName' is annotated with</span>
<a name="line-80"></a><a name="ModuleProvides"></a><span class='hs-comment'>-- the 'PackageName' it comes from.</span>
<a name="line-81"></a><a name="ModuleProvides"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ModuleProvides</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleWithSource</span><span class='hs-keyglyph'>]</span>
<a name="line-82"></a><a name="ModuleRequires"></a><span class='hs-comment'>-- | INVARIANT: entries for ModuleName m, have msrc_module is OpenModuleVar m</span>
<a name="line-83"></a><a name="ModuleRequires"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ModuleRequires</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleWithSource</span><span class='hs-keyglyph'>]</span>
<a name="line-84"></a><span class='hs-comment'>-- TODO: consider newtping the two types above.</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="ModuleSource"></a><span class='hs-comment'>-- | Description of where a module participating in mixin linking came</span>
<a name="line-87"></a><a name="ModuleSource"></a><span class='hs-comment'>-- from.</span>
<a name="line-88"></a><a name="ModuleSource"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ModuleSource</span>
<a name="line-89"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FromMixins</span>         <span class='hs-conid'>PackageName</span> <span class='hs-conid'>ComponentName</span> <span class='hs-conid'>IncludeRenaming</span>
<a name="line-90"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FromBuildDepends</span>   <span class='hs-conid'>PackageName</span> <span class='hs-conid'>ComponentName</span>
<a name="line-91"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FromExposedModules</span> <span class='hs-conid'>ModuleName</span>
<a name="line-92"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FromOtherModules</span>   <span class='hs-conid'>ModuleName</span>
<a name="line-93"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FromSignatures</span>     <span class='hs-conid'>ModuleName</span>
<a name="line-94"></a><span class='hs-comment'>-- We don't have line numbers, but if we did, we'd want to record that</span>
<a name="line-95"></a><span class='hs-comment'>-- too</span>
<a name="line-96"></a>
<a name="line-97"></a><a name="dispModuleSource"></a><span class='hs-comment'>-- TODO: Deduplicate this with Distribution.Backpack.UnifyM.ci_msg</span>
<a name="line-98"></a><span class='hs-definition'>dispModuleSource</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleSource</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Doc</span>
<a name="line-99"></a><span class='hs-definition'>dispModuleSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromMixins</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>cn</span> <span class='hs-varid'>incls</span><span class='hs-layout'>)</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"mixins:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dispComponent</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>cn</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>incls</span>
<a name="line-101"></a><span class='hs-definition'>dispModuleSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromBuildDepends</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>cn</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"build-depends:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dispComponent</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>cn</span>
<a name="line-103"></a><span class='hs-definition'>dispModuleSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromExposedModules</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"exposed-modules:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>m</span>
<a name="line-105"></a><span class='hs-definition'>dispModuleSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromOtherModules</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-106"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"other-modules:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>m</span>
<a name="line-107"></a><span class='hs-definition'>dispModuleSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>FromSignatures</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"signatures:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>m</span>
<a name="line-109"></a>
<a name="line-110"></a><a name="dispComponent"></a><span class='hs-comment'>-- Dependency</span>
<a name="line-111"></a><span class='hs-definition'>dispComponent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ComponentName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Doc</span>
<a name="line-112"></a><span class='hs-definition'>dispComponent</span> <span class='hs-varid'>pn</span> <span class='hs-varid'>cn</span> <span class='hs-keyglyph'>=</span>
<a name="line-113"></a>    <span class='hs-comment'>-- NB: This syntax isn't quite the source syntax, but it</span>
<a name="line-114"></a>    <span class='hs-comment'>-- should be clear enough.  To do source syntax, we'd</span>
<a name="line-115"></a>    <span class='hs-comment'>-- need to know what the package we're linking is.</span>
<a name="line-116"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>cn</span> <span class='hs-keyword'>of</span>
<a name="line-117"></a>        <span class='hs-conid'>CLibName</span> <span class='hs-conid'>LMainLibName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>pn</span>
<a name="line-118"></a>        <span class='hs-conid'>CLibName</span> <span class='hs-layout'>(</span><span class='hs-conid'>LSubLibName</span> <span class='hs-varid'>ucn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>pn</span> <span class='hs-varop'>&lt;&lt;&gt;&gt;</span> <span class='hs-varid'>colon</span> <span class='hs-varop'>&lt;&lt;&gt;&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>ucn</span>
<a name="line-119"></a>        <span class='hs-comment'>-- Case below shouldn't happen</span>
<a name="line-120"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pretty</span> <span class='hs-varid'>pn</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pretty</span> <span class='hs-varid'>cn</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a><a name="WithSource"></a><span class='hs-comment'>-- | An 'OpenModule', annotated with where it came from in a Cabal file.</span>
<a name="line-123"></a><a name="WithSource"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>WithSource</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WithSource</span> <span class='hs-conid'>ModuleSource</span> <span class='hs-varid'>a</span>
<a name="line-124"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Functor</span><span class='hs-layout'>,</span> <span class='hs-conid'>Foldable</span><span class='hs-layout'>,</span> <span class='hs-conid'>Traversable</span><span class='hs-layout'>)</span>
<a name="line-125"></a><a name="unWithSource"></a><span class='hs-definition'>unWithSource</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WithSource</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-126"></a><span class='hs-definition'>unWithSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>WithSource</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-127"></a><a name="getSource"></a><span class='hs-definition'>getSource</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WithSource</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleSource</span>
<a name="line-128"></a><span class='hs-definition'>getSource</span> <span class='hs-layout'>(</span><span class='hs-conid'>WithSource</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span>
<a name="line-129"></a><a name="ModuleWithSource"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ModuleWithSource</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WithSource</span> <span class='hs-conid'>OpenModule</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="instance%20ModSubst%20(WithSource%20a)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>ModSubst</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ModSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>WithSource</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-132"></a>    <span class='hs-varid'>modSubst</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>WithSource</span> <span class='hs-varid'>s</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WithSource</span> <span class='hs-varid'>s</span> <span class='hs-layout'>(</span><span class='hs-varid'>modSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
</pre></body>
</html>

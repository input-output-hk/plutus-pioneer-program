<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Distribution/Simple/SrcDist.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-5"></a><span class='hs-comment'>-- |</span>
<a name="line-6"></a><span class='hs-comment'>-- Module      :  Distribution.Simple.SrcDist</span>
<a name="line-7"></a><span class='hs-comment'>-- Copyright   :  Simon Marlow 2004</span>
<a name="line-8"></a><span class='hs-comment'>-- License     :  BSD3</span>
<a name="line-9"></a><span class='hs-comment'>--</span>
<a name="line-10"></a><span class='hs-comment'>-- Maintainer  :  cabal-devel@haskell.org</span>
<a name="line-11"></a><span class='hs-comment'>-- Portability :  portable</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>-- This handles the @sdist@ command. The module exports an 'sdist' action but</span>
<a name="line-14"></a><span class='hs-comment'>-- also some of the phases that make it up so that other tools can use just the</span>
<a name="line-15"></a><span class='hs-comment'>-- bits they need. In particular the preparation of the tree of files to go</span>
<a name="line-16"></a><span class='hs-comment'>-- into the source tarball is separated from actually building the source</span>
<a name="line-17"></a><span class='hs-comment'>-- tarball.</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-comment'>-- The 'createArchive' action uses the external @tar@ program and assumes that</span>
<a name="line-20"></a><span class='hs-comment'>-- it accepts the @-z@ flag. Neither of these assumptions are valid on Windows.</span>
<a name="line-21"></a><span class='hs-comment'>-- The 'sdist' action now also does some distribution QA checks.</span>
<a name="line-22"></a>
<a name="line-23"></a><span class='hs-comment'>-- NOTE: FIX: we don't have a great way of testing this module, since</span>
<a name="line-24"></a><span class='hs-comment'>-- we can't easily look inside a tarball once its created.</span>
<a name="line-25"></a>
<a name="line-26"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Distribution.Simple.SrcDist</span> <span class='hs-layout'>(</span>
<a name="line-27"></a>  <span class='hs-comment'>-- * The top level action</span>
<a name="line-28"></a>  <span class='hs-varid'>sdist</span><span class='hs-layout'>,</span>
<a name="line-29"></a>
<a name="line-30"></a>  <span class='hs-comment'>-- ** Parts of 'sdist'</span>
<a name="line-31"></a>  <span class='hs-varid'>printPackageProblems</span><span class='hs-layout'>,</span>
<a name="line-32"></a>  <span class='hs-varid'>prepareTree</span><span class='hs-layout'>,</span>
<a name="line-33"></a>  <span class='hs-varid'>createArchive</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-comment'>-- ** Snapshots</span>
<a name="line-36"></a>  <span class='hs-varid'>prepareSnapshotTree</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>snapshotPackage</span><span class='hs-layout'>,</span>
<a name="line-38"></a>  <span class='hs-varid'>snapshotVersion</span><span class='hs-layout'>,</span>
<a name="line-39"></a>  <span class='hs-varid'>dateToSnapshotNumber</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>  <span class='hs-comment'>-- * Extracting the source files</span>
<a name="line-42"></a>  <span class='hs-varid'>listPackageSources</span><span class='hs-layout'>,</span>
<a name="line-43"></a>  <span class='hs-varid'>listPackageSourcesWithDie</span><span class='hs-layout'>,</span>
<a name="line-44"></a>
<a name="line-45"></a>  <span class='hs-layout'>)</span>  <span class='hs-keyword'>where</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-conid'>()</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Prelude</span>
<a name="line-49"></a>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.PackageDescription</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.PackageDescription.Check</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-varid'>doesFileExist</span><span class='hs-layout'>)</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Package</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.ModuleName</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Distribution.ModuleName</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>ModuleName</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Version</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.Configure</span> <span class='hs-layout'>(</span><span class='hs-varid'>findDistPrefOrDefault</span><span class='hs-layout'>)</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.Glob</span> <span class='hs-layout'>(</span><span class='hs-varid'>matchDirFileGlobWithDie</span><span class='hs-layout'>)</span>
<a name="line-58"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.Utils</span>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.Setup</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.PreProcess</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.BuildPaths</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Simple.Program</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Pretty</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Verbosity</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Utils.Path</span>
<a name="line-66"></a>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Time</span> <span class='hs-layout'>(</span><span class='hs-conid'>UTCTime</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCurrentTime</span><span class='hs-layout'>,</span> <span class='hs-varid'>toGregorian</span><span class='hs-layout'>,</span> <span class='hs-varid'>utctDay</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Directory</span> <span class='hs-layout'>(</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-layout'>)</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOMode</span><span class='hs-layout'>(</span><span class='hs-conid'>WriteMode</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>hPutStrLn</span><span class='hs-layout'>,</span> <span class='hs-varid'>withFile</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.FilePath</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>dropExtension</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRelative</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a><a name="sdist"></a><span class='hs-comment'>-- |Create a source distribution.</span>
<a name="line-74"></a><span class='hs-definition'>sdist</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageDescription</span>     <span class='hs-comment'>-- ^ information from the tarball</span>
<a name="line-75"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDistFlags</span>             <span class='hs-comment'>-- ^ verbosity &amp; snapshot</span>
<a name="line-76"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ build prefix (temp dir)</span>
<a name="line-77"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ extra preprocessors (includes suffixes)</span>
<a name="line-78"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-79"></a><span class='hs-definition'>sdist</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>flags</span> <span class='hs-varid'>mkTmpDir</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-80"></a>
<a name="line-81"></a>  <span class='hs-varid'>distPref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findDistPrefOrDefault</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sDistDistPref</span> <span class='hs-varid'>flags</span>
<a name="line-82"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>targetPref</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>distPref</span>
<a name="line-83"></a>      <span class='hs-varid'>tmpTargetDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTmpDir</span> <span class='hs-varid'>distPref</span>
<a name="line-84"></a>
<a name="line-85"></a>  <span class='hs-comment'>-- When given --list-sources, just output the list of sources to a file.</span>
<a name="line-86"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>sDistListSources</span> <span class='hs-varid'>flags</span> <span class='hs-keyword'>of</span>
<a name="line-87"></a>    <span class='hs-conid'>Flag</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withFile</span> <span class='hs-varid'>path</span> <span class='hs-conid'>WriteMode</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>outHandle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-88"></a>      <span class='hs-varid'>ordinary</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>listPackageSources</span> <span class='hs-varid'>verbosity</span> <span class='hs-str'>"."</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>pps</span>
<a name="line-89"></a>      <span class='hs-varid'>traverse_</span> <span class='hs-layout'>(</span><span class='hs-varid'>hPutStrLn</span> <span class='hs-varid'>outHandle</span><span class='hs-layout'>)</span> <span class='hs-varid'>ordinary</span>
<a name="line-90"></a>      <span class='hs-varid'>notice</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"List of package sources written to file '"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>"'"</span>
<a name="line-91"></a>
<a name="line-92"></a>    <span class='hs-conid'>NoFlag</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-93"></a>      <span class='hs-comment'>-- do some QA</span>
<a name="line-94"></a>      <span class='hs-varid'>printPackageProblems</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg</span>
<a name="line-95"></a>
<a name="line-96"></a>      <span class='hs-varid'>date</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-97"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>pkg'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>snapshot</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snapshotPackage</span> <span class='hs-varid'>date</span> <span class='hs-varid'>pkg</span>
<a name="line-98"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkg</span>
<a name="line-99"></a>
<a name="line-100"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>flagToMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>sDistDirectory</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-101"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>targetDir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-102"></a>          <span class='hs-varid'>generateSourceDir</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>pkg'</span>
<a name="line-103"></a>          <span class='hs-varid'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Source directory created: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>targetDir</span>
<a name="line-104"></a>
<a name="line-105"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-106"></a>          <span class='hs-varid'>createDirectoryIfMissingVerbose</span> <span class='hs-varid'>verbosity</span> <span class='hs-conid'>True</span> <span class='hs-varid'>tmpTargetDir</span>
<a name="line-107"></a>          <span class='hs-varid'>withTempDirectory</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>tmpTargetDir</span> <span class='hs-str'>"sdist."</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>tmpDir</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-108"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>targetDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>tarBallName</span> <span class='hs-varid'>pkg'</span>
<a name="line-109"></a>            <span class='hs-varid'>generateSourceDir</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>pkg'</span>
<a name="line-110"></a>            <span class='hs-varid'>targzFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createArchive</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg'</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>targetPref</span>
<a name="line-111"></a>            <span class='hs-varid'>notice</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Source tarball created: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>targzFile</span>
<a name="line-112"></a>
<a name="line-113"></a>  <span class='hs-keyword'>where</span>
<a name="line-114"></a>    <span class='hs-varid'>generateSourceDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-115"></a>    <span class='hs-varid'>generateSourceDir</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>pkg'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-116"></a>      <span class='hs-varid'>setupMessage</span> <span class='hs-varid'>verbosity</span> <span class='hs-str'>"Building source dist for"</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageId</span> <span class='hs-varid'>pkg'</span><span class='hs-layout'>)</span>
<a name="line-117"></a>      <span class='hs-varid'>prepareTree</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg'</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>pps</span>
<a name="line-118"></a>      <span class='hs-varid'>when</span> <span class='hs-varid'>snapshot</span> <span class='hs-varop'>$</span>
<a name="line-119"></a>        <span class='hs-varid'>overwriteSnapshotPackageDesc</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg'</span> <span class='hs-varid'>targetDir</span>
<a name="line-120"></a>
<a name="line-121"></a>    <span class='hs-varid'>verbosity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromFlag</span> <span class='hs-layout'>(</span><span class='hs-varid'>sDistVerbosity</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span>
<a name="line-122"></a>    <span class='hs-varid'>snapshot</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromFlag</span> <span class='hs-layout'>(</span><span class='hs-varid'>sDistSnapshot</span> <span class='hs-varid'>flags</span><span class='hs-layout'>)</span>
<a name="line-123"></a>
<a name="line-124"></a><a name="listPackageSources"></a><span class='hs-comment'>-- | List all source files of a package.</span>
<a name="line-125"></a><span class='hs-comment'>--</span>
<a name="line-126"></a><span class='hs-comment'>-- Since @Cabal-3.4@ returns a single list. There shouldn't be any</span>
<a name="line-127"></a><span class='hs-comment'>-- executable files, they are hardly portable.</span>
<a name="line-128"></a><span class='hs-comment'>-- </span>
<a name="line-129"></a><span class='hs-definition'>listPackageSources</span>
<a name="line-130"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>          <span class='hs-comment'>-- ^ verbosity</span>
<a name="line-131"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^ directory with cabal file</span>
<a name="line-132"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-comment'>-- ^ info from the cabal file</span>
<a name="line-133"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ extra preprocessors (include suffixes)</span>
<a name="line-134"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ relative paths</span>
<a name="line-135"></a><span class='hs-definition'>listPackageSources</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>pkg_descr0</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-136"></a>    <span class='hs-comment'>-- Call helpers that actually do all work.</span>
<a name="line-137"></a>    <span class='hs-varid'>listPackageSources'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>die'</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-varid'>pps</span>
<a name="line-138"></a>  <span class='hs-keyword'>where</span>
<a name="line-139"></a>    <span class='hs-varid'>pkg_descr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterAutogenModules</span> <span class='hs-varid'>pkg_descr0</span>
<a name="line-140"></a>
<a name="line-141"></a><a name="listPackageSourcesWithDie"></a><span class='hs-comment'>-- | A variant of 'listPackageSources' with configurable 'die'.</span>
<a name="line-142"></a><span class='hs-comment'>--</span>
<a name="line-143"></a><span class='hs-comment'>-- /Note:/ may still 'die' directly. For example on missing include file.</span>
<a name="line-144"></a><span class='hs-comment'>--</span>
<a name="line-145"></a><span class='hs-comment'>-- Since @3.4.0.0</span>
<a name="line-146"></a><span class='hs-definition'>listPackageSourcesWithDie</span>
<a name="line-147"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>          <span class='hs-comment'>-- ^ verbosity</span>
<a name="line-148"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ 'die'' alternative</span>
<a name="line-149"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^ directory with cabal file</span>
<a name="line-150"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-comment'>-- ^ info from the cabal file</span>
<a name="line-151"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ extra preprocessors (include suffixes)</span>
<a name="line-152"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ relative paths</span>
<a name="line-153"></a><span class='hs-definition'>listPackageSourcesWithDie</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>pkg_descr0</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-154"></a>    <span class='hs-comment'>-- Call helpers that actually do all work.</span>
<a name="line-155"></a>    <span class='hs-varid'>listPackageSources'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-varid'>pps</span>
<a name="line-156"></a>  <span class='hs-keyword'>where</span>
<a name="line-157"></a>    <span class='hs-varid'>pkg_descr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterAutogenModules</span> <span class='hs-varid'>pkg_descr0</span>
<a name="line-158"></a>
<a name="line-159"></a>
<a name="line-160"></a><a name="listPackageSources'"></a><span class='hs-definition'>listPackageSources'</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-162"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-164"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span>
<a name="line-165"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span>
<a name="line-166"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-167"></a><span class='hs-definition'>listPackageSources'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>=</span>
<a name="line-168"></a>  <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>.</span> <span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span>
<a name="line-169"></a>  <span class='hs-keyglyph'>[</span>
<a name="line-170"></a>    <span class='hs-comment'>-- Library sources.</span>
<a name="line-171"></a>    <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-172"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withAllLib</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>Library</span> <span class='hs-layout'>{</span>
<a name="line-173"></a>                      <span class='hs-varid'>exposedModules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modules</span><span class='hs-layout'>,</span>
<a name="line-174"></a>                      <span class='hs-varid'>signatures</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>,</span>
<a name="line-175"></a>                      <span class='hs-varid'>libBuildInfo</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libBi</span>
<a name="line-176"></a>                    <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-177"></a>     <span class='hs-varid'>allSourcesBuildInfo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>libBi</span> <span class='hs-varid'>pps</span> <span class='hs-layout'>(</span><span class='hs-varid'>modules</span> <span class='hs-varop'>++</span> <span class='hs-varid'>sigs</span><span class='hs-layout'>)</span>
<a name="line-178"></a>
<a name="line-179"></a>    <span class='hs-comment'>-- Executables sources.</span>
<a name="line-180"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-181"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withAllExe</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-conid'>Executable</span> <span class='hs-layout'>{</span> <span class='hs-varid'>modulePath</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mainPath</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exeBi</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-182"></a>       <span class='hs-varid'>biSrcs</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allSourcesBuildInfo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>exeBi</span> <span class='hs-varid'>pps</span> <span class='hs-conid'>[]</span>
<a name="line-183"></a>       <span class='hs-varid'>mainSrc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findMainExeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>exeBi</span> <span class='hs-varid'>pps</span> <span class='hs-varid'>mainPath</span>
<a name="line-184"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mainSrc</span><span class='hs-conop'>:</span><span class='hs-varid'>biSrcs</span><span class='hs-layout'>)</span>
<a name="line-185"></a>
<a name="line-186"></a>    <span class='hs-comment'>-- Foreign library sources</span>
<a name="line-187"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-188"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withAllFLib</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>flib</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignLib</span> <span class='hs-layout'>{</span> <span class='hs-varid'>foreignLibBuildInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flibBi</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-189"></a>       <span class='hs-varid'>biSrcs</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allSourcesBuildInfo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>flibBi</span> <span class='hs-varid'>pps</span> <span class='hs-conid'>[]</span>
<a name="line-190"></a>       <span class='hs-varid'>defFiles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>findModDefFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>flibBi</span> <span class='hs-varid'>pps</span><span class='hs-layout'>)</span>
<a name="line-191"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>foreignLibModDefFile</span> <span class='hs-varid'>flib</span><span class='hs-layout'>)</span>
<a name="line-192"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>defFiles</span> <span class='hs-varop'>++</span> <span class='hs-varid'>biSrcs</span><span class='hs-layout'>)</span>
<a name="line-193"></a>
<a name="line-194"></a>    <span class='hs-comment'>-- Test suites sources.</span>
<a name="line-195"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-196"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withAllTest</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-197"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>bi</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>testBuildInfo</span> <span class='hs-varid'>t</span>
<a name="line-198"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>testInterface</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>of</span>
<a name="line-199"></a>         <span class='hs-conid'>TestSuiteExeV10</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mainPath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-200"></a>           <span class='hs-varid'>biSrcs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allSourcesBuildInfo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>pps</span> <span class='hs-conid'>[]</span>
<a name="line-201"></a>           <span class='hs-varid'>srcMainFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findMainExeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>pps</span> <span class='hs-varid'>mainPath</span>
<a name="line-202"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcMainFile</span><span class='hs-conop'>:</span><span class='hs-varid'>biSrcs</span><span class='hs-layout'>)</span>
<a name="line-203"></a>         <span class='hs-conid'>TestSuiteLibV09</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-204"></a>           <span class='hs-varid'>allSourcesBuildInfo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>m</span><span class='hs-keyglyph'>]</span>
<a name="line-205"></a>         <span class='hs-conid'>TestSuiteUnsupported</span> <span class='hs-varid'>tp</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-206"></a>           <span class='hs-varid'>rip</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Unsupported test suite type: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>tp</span>
<a name="line-207"></a>
<a name="line-208"></a>    <span class='hs-comment'>-- Benchmarks sources.</span>
<a name="line-209"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-210"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withAllBenchmark</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>bm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-211"></a>       <span class='hs-keyword'>let</span>  <span class='hs-varid'>bi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>benchmarkBuildInfo</span> <span class='hs-varid'>bm</span>
<a name="line-212"></a>       <span class='hs-keyword'>case</span> <span class='hs-varid'>benchmarkInterface</span> <span class='hs-varid'>bm</span> <span class='hs-keyword'>of</span>
<a name="line-213"></a>         <span class='hs-conid'>BenchmarkExeV10</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mainPath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-214"></a>           <span class='hs-varid'>biSrcs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allSourcesBuildInfo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>pps</span> <span class='hs-conid'>[]</span>
<a name="line-215"></a>           <span class='hs-varid'>srcMainFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findMainExeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>pps</span> <span class='hs-varid'>mainPath</span>
<a name="line-216"></a>           <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcMainFile</span><span class='hs-conop'>:</span><span class='hs-varid'>biSrcs</span><span class='hs-layout'>)</span>
<a name="line-217"></a>         <span class='hs-conid'>BenchmarkUnsupported</span> <span class='hs-varid'>tp</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-218"></a>            <span class='hs-varid'>rip</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Unsupported benchmark type: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>tp</span>
<a name="line-219"></a>
<a name="line-220"></a>    <span class='hs-comment'>-- Data files.</span>
<a name="line-221"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-222"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>for</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataFiles</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>filename</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-223"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>srcDataDirRaw</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataDir</span> <span class='hs-varid'>pkg_descr</span>
<a name="line-224"></a>            <span class='hs-varid'>srcDataDir</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>srcDataDirRaw</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"."</span>
<a name="line-225"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcDataDirRaw</span>
<a name="line-226"></a>        <span class='hs-varid'>matchDirFileGlobWithDie</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-layout'>(</span><span class='hs-varid'>specVersion</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span> <span class='hs-varid'>cwd</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcDataDir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>filename</span><span class='hs-layout'>)</span>
<a name="line-227"></a>
<a name="line-228"></a>    <span class='hs-comment'>-- Extra source files.</span>
<a name="line-229"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>.</span> <span class='hs-varid'>for</span> <span class='hs-layout'>(</span><span class='hs-varid'>extraSrcFiles</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>fpath</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-230"></a>    <span class='hs-varid'>matchDirFileGlobWithDie</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-layout'>(</span><span class='hs-varid'>specVersion</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>fpath</span>
<a name="line-231"></a>
<a name="line-232"></a>    <span class='hs-comment'>-- Extra doc files.</span>
<a name="line-233"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-234"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>for</span> <span class='hs-layout'>(</span><span class='hs-varid'>extraDocFiles</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>filename</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-235"></a>        <span class='hs-varid'>matchDirFileGlobWithDie</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-layout'>(</span><span class='hs-varid'>specVersion</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>filename</span>
<a name="line-236"></a>
<a name="line-237"></a>    <span class='hs-comment'>-- License file(s).</span>
<a name="line-238"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getSymbolicPath</span> <span class='hs-varop'>$</span> <span class='hs-varid'>licenseFiles</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span>
<a name="line-239"></a>
<a name="line-240"></a>    <span class='hs-comment'>-- Install-include files, without autogen-include files</span>
<a name="line-241"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span>
<a name="line-242"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withAllLib</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-243"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>lbi</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>libBuildInfo</span> <span class='hs-varid'>l</span>
<a name="line-244"></a>           <span class='hs-varid'>incls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`notElem`</span> <span class='hs-varid'>autogenIncludes</span> <span class='hs-varid'>lbi</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>installIncludes</span> <span class='hs-varid'>lbi</span><span class='hs-layout'>)</span>
<a name="line-245"></a>           <span class='hs-varid'>relincdirs</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"."</span> <span class='hs-conop'>:</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isRelative</span> <span class='hs-layout'>(</span><span class='hs-varid'>includeDirs</span> <span class='hs-varid'>lbi</span><span class='hs-layout'>)</span>
<a name="line-246"></a>       <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>findIncludeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>relincdirs</span><span class='hs-layout'>)</span> <span class='hs-varid'>incls</span>
<a name="line-247"></a>
<a name="line-248"></a>    <span class='hs-comment'>-- Setup script, if it exists.</span>
<a name="line-249"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>f</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>findSetupFile</span> <span class='hs-varid'>cwd</span>
<a name="line-250"></a>
<a name="line-251"></a>    <span class='hs-comment'>-- The .cabal file itself.</span>
<a name="line-252"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>d</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>d</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tryFindPackageDescCwd</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-str'>"."</span><span class='hs-layout'>)</span>
<a name="line-253"></a>
<a name="line-254"></a>  <span class='hs-keyglyph'>]</span>
<a name="line-255"></a>  <span class='hs-keyword'>where</span>
<a name="line-256"></a>    <span class='hs-comment'>-- We have to deal with all libs and executables, so we have local</span>
<a name="line-257"></a>    <span class='hs-comment'>-- versions of these functions that ignore the 'buildable' attribute:</span>
<a name="line-258"></a>    <span class='hs-varid'>withAllLib</span>       <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>action</span> <span class='hs-layout'>(</span><span class='hs-varid'>allLibraries</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span>
<a name="line-259"></a>    <span class='hs-varid'>withAllFLib</span>      <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>action</span> <span class='hs-layout'>(</span><span class='hs-varid'>foreignLibs</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span>
<a name="line-260"></a>    <span class='hs-varid'>withAllExe</span>       <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>action</span> <span class='hs-layout'>(</span><span class='hs-varid'>executables</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span>
<a name="line-261"></a>    <span class='hs-varid'>withAllTest</span>      <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>action</span> <span class='hs-layout'>(</span><span class='hs-varid'>testSuites</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span>
<a name="line-262"></a>    <span class='hs-varid'>withAllBenchmark</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>action</span> <span class='hs-layout'>(</span><span class='hs-varid'>benchmarks</span> <span class='hs-varid'>pkg_descr</span><span class='hs-layout'>)</span>
<a name="line-263"></a>
<a name="line-264"></a>
<a name="line-265"></a><a name="prepareTree"></a><span class='hs-comment'>-- |Prepare a directory tree of source files.</span>
<a name="line-266"></a><span class='hs-definition'>prepareTree</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>          <span class='hs-comment'>-- ^verbosity</span>
<a name="line-267"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-comment'>-- ^info from the cabal file</span>
<a name="line-268"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^source tree to populate</span>
<a name="line-269"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^extra preprocessors (includes suffixes)</span>
<a name="line-270"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-271"></a><span class='hs-definition'>prepareTree</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg_descr0</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-272"></a>    <span class='hs-varid'>ordinary</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>listPackageSources</span> <span class='hs-varid'>verbosity</span> <span class='hs-str'>"."</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-varid'>pps</span>
<a name="line-273"></a>    <span class='hs-varid'>installOrdinaryFiles</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>targetDir</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>ordinary</span><span class='hs-layout'>)</span>
<a name="line-274"></a>    <span class='hs-varid'>maybeCreateDefaultSetupScript</span> <span class='hs-varid'>targetDir</span>
<a name="line-275"></a>  <span class='hs-keyword'>where</span>
<a name="line-276"></a>    <span class='hs-varid'>pkg_descr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterAutogenModules</span> <span class='hs-varid'>pkg_descr0</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="findSetupFile"></a><span class='hs-comment'>-- | Find the setup script file, if it exists.</span>
<a name="line-279"></a><span class='hs-definition'>findSetupFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-280"></a><span class='hs-definition'>findSetupFile</span> <span class='hs-varid'>targetDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-281"></a>  <span class='hs-varid'>hsExists</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetDir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>setupHs</span><span class='hs-layout'>)</span>
<a name="line-282"></a>  <span class='hs-varid'>lhsExists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetDir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>setupLhs</span><span class='hs-layout'>)</span>
<a name="line-283"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>hsExists</span>
<a name="line-284"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>setupHs</span><span class='hs-layout'>)</span>
<a name="line-285"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>lhsExists</span>
<a name="line-286"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>setupLhs</span><span class='hs-layout'>)</span>
<a name="line-287"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-288"></a>    <span class='hs-keyword'>where</span>
<a name="line-289"></a>      <span class='hs-varid'>setupHs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Setup.hs"</span>
<a name="line-290"></a>      <span class='hs-varid'>setupLhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Setup.lhs"</span>
<a name="line-291"></a>
<a name="line-292"></a><a name="maybeCreateDefaultSetupScript"></a><span class='hs-comment'>-- | Create a default setup script in the target directory, if it doesn't exist.</span>
<a name="line-293"></a><span class='hs-definition'>maybeCreateDefaultSetupScript</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-294"></a><span class='hs-definition'>maybeCreateDefaultSetupScript</span> <span class='hs-varid'>targetDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-295"></a>  <span class='hs-varid'>mSetupFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findSetupFile</span> <span class='hs-varid'>targetDir</span>
<a name="line-296"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mSetupFile</span> <span class='hs-keyword'>of</span>
<a name="line-297"></a>    <span class='hs-conid'>Just</span> <span class='hs-sel'>_setupFile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-298"></a>    <span class='hs-conid'>Nothing</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-299"></a>      <span class='hs-varid'>writeUTF8File</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetDir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-str'>"Setup.hs"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unlines</span> <span class='hs-keyglyph'>[</span>
<a name="line-300"></a>        <span class='hs-str'>"import Distribution.Simple"</span><span class='hs-layout'>,</span>
<a name="line-301"></a>        <span class='hs-str'>"main = defaultMain"</span><span class='hs-keyglyph'>]</span>
<a name="line-302"></a>
<a name="line-303"></a><a name="findMainExeFile"></a><span class='hs-comment'>-- | Find the main executable file.</span>
<a name="line-304"></a><span class='hs-definition'>findMainExeFile</span>
<a name="line-305"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-306"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-comment'>-- ^ cwd</span>
<a name="line-307"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildInfo</span>
<a name="line-308"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span>
<a name="line-309"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-comment'>-- ^ main-is</span>
<a name="line-310"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-311"></a><span class='hs-definition'>findMainExeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>exeBi</span> <span class='hs-varid'>pps</span> <span class='hs-varid'>mainPath</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-312"></a>  <span class='hs-varid'>ppFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findFileCwdWithExtension</span> <span class='hs-varid'>cwd</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppSuffixes</span> <span class='hs-varid'>pps</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getSymbolicPath</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSourceDirs</span> <span class='hs-varid'>exeBi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-313"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>dropExtension</span> <span class='hs-varid'>mainPath</span><span class='hs-layout'>)</span>
<a name="line-314"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>ppFile</span> <span class='hs-keyword'>of</span>
<a name="line-315"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>findFileCwd</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getSymbolicPath</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSourceDirs</span> <span class='hs-varid'>exeBi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>mainPath</span>
<a name="line-316"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>pp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>pp</span>
<a name="line-317"></a>
<a name="line-318"></a><a name="findModDefFile"></a><span class='hs-comment'>-- | Find a module definition file</span>
<a name="line-319"></a><span class='hs-comment'>--</span>
<a name="line-320"></a><span class='hs-comment'>-- TODO: I don't know if this is right</span>
<a name="line-321"></a><span class='hs-definition'>findModDefFile</span>
<a name="line-322"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-323"></a><span class='hs-definition'>findModDefFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>flibBi</span> <span class='hs-sel'>_pps</span> <span class='hs-varid'>modDefPath</span> <span class='hs-keyglyph'>=</span>
<a name="line-324"></a>    <span class='hs-varid'>findFileCwd</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-layout'>(</span><span class='hs-str'>"."</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getSymbolicPath</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSourceDirs</span> <span class='hs-varid'>flibBi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>modDefPath</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="findIncludeFile"></a><span class='hs-comment'>-- | Given a list of include paths, try to find the include file named</span>
<a name="line-327"></a><span class='hs-comment'>-- @f@. Return the name of the file and the full path, or exit with error if</span>
<a name="line-328"></a><span class='hs-comment'>-- there's no such file.</span>
<a name="line-329"></a><span class='hs-definition'>findIncludeFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-330"></a><span class='hs-definition'>findIncludeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"can't find include file "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-331"></a><span class='hs-definition'>findIncludeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-332"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-333"></a>  <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-layout'>(</span><span class='hs-varid'>cwd</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span>
<a name="line-334"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span><span class='hs-varid'>path</span><span class='hs-layout'>)</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>findIncludeFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>ds</span> <span class='hs-varid'>f</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="filterAutogenModules"></a><span class='hs-comment'>-- | Remove the auto-generated modules (like 'Paths_*') from 'exposed-modules' </span>
<a name="line-337"></a><span class='hs-comment'>-- and 'other-modules'.</span>
<a name="line-338"></a><span class='hs-definition'>filterAutogenModules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span>
<a name="line-339"></a><span class='hs-definition'>filterAutogenModules</span> <span class='hs-varid'>pkg_descr0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapLib</span> <span class='hs-varid'>filterAutogenModuleLib</span> <span class='hs-varop'>$</span>
<a name="line-340"></a>                                 <span class='hs-varid'>mapAllBuildInfo</span> <span class='hs-varid'>filterAutogenModuleBI</span> <span class='hs-varid'>pkg_descr0</span>
<a name="line-341"></a>  <span class='hs-keyword'>where</span>
<a name="line-342"></a>    <span class='hs-varid'>mapLib</span> <span class='hs-varid'>f</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkg</span> <span class='hs-layout'>{</span> <span class='hs-varid'>library</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>library</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-343"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>subLibraries</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>subLibraries</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-344"></a>    <span class='hs-varid'>filterAutogenModuleLib</span> <span class='hs-varid'>lib</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lib</span> <span class='hs-layout'>{</span>
<a name="line-345"></a>      <span class='hs-varid'>exposedModules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterFunction</span> <span class='hs-layout'>(</span><span class='hs-varid'>libBuildInfo</span> <span class='hs-varid'>lib</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>exposedModules</span> <span class='hs-varid'>lib</span><span class='hs-layout'>)</span>
<a name="line-346"></a>    <span class='hs-layout'>}</span>
<a name="line-347"></a>    <span class='hs-varid'>filterAutogenModuleBI</span> <span class='hs-varid'>bi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bi</span> <span class='hs-layout'>{</span>
<a name="line-348"></a>      <span class='hs-varid'>otherModules</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>filterFunction</span> <span class='hs-varid'>bi</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>otherModules</span> <span class='hs-varid'>bi</span><span class='hs-layout'>)</span>
<a name="line-349"></a>    <span class='hs-layout'>}</span>
<a name="line-350"></a>    <span class='hs-varid'>pathsModule</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>autogenPathsModuleName</span> <span class='hs-varid'>pkg_descr0</span>
<a name="line-351"></a>    <span class='hs-varid'>filterFunction</span> <span class='hs-varid'>bi</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>mn</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-352"></a>                                   <span class='hs-varid'>mn</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>pathsModule</span>
<a name="line-353"></a>                                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mn</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>autogenModules</span> <span class='hs-varid'>bi</span><span class='hs-layout'>)</span>
<a name="line-354"></a>
<a name="line-355"></a><a name="prepareSnapshotTree"></a><span class='hs-comment'>-- | Prepare a directory tree of source files for a snapshot version.</span>
<a name="line-356"></a><span class='hs-comment'>-- It is expected that the appropriate snapshot version has already been set</span>
<a name="line-357"></a><span class='hs-comment'>-- in the package description, eg using 'snapshotPackage' or 'snapshotVersion'.</span>
<a name="line-358"></a><span class='hs-comment'>--</span>
<a name="line-359"></a><span class='hs-definition'>prepareSnapshotTree</span>
<a name="line-360"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>          <span class='hs-comment'>-- ^verbosity</span>
<a name="line-361"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-comment'>-- ^info from the cabal file</span>
<a name="line-362"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^source tree to populate</span>
<a name="line-363"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^extra preprocessors (includes suffixes)</span>
<a name="line-364"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-365"></a><span class='hs-definition'>prepareSnapshotTree</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>pps</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-366"></a>  <span class='hs-varid'>prepareTree</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>pps</span>
<a name="line-367"></a>  <span class='hs-varid'>overwriteSnapshotPackageDesc</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>targetDir</span>
<a name="line-368"></a>
<a name="line-369"></a><a name="overwriteSnapshotPackageDesc"></a><span class='hs-definition'>overwriteSnapshotPackageDesc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>          <span class='hs-comment'>-- ^verbosity</span>
<a name="line-370"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-comment'>-- ^info from the cabal file</span>
<a name="line-371"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^source tree</span>
<a name="line-372"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-373"></a><span class='hs-definition'>overwriteSnapshotPackageDesc</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>targetDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-374"></a>    <span class='hs-comment'>-- We could just writePackageDescription targetDescFile pkg_descr,</span>
<a name="line-375"></a>    <span class='hs-comment'>-- but that would lose comments and formatting.</span>
<a name="line-376"></a>    <span class='hs-varid'>descFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>defaultPackageDesc</span> <span class='hs-varid'>verbosity</span>
<a name="line-377"></a>    <span class='hs-varid'>withUTF8FileContents</span> <span class='hs-varid'>descFile</span> <span class='hs-varop'>$</span>
<a name="line-378"></a>      <span class='hs-varid'>writeUTF8File</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetDir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>descFile</span><span class='hs-layout'>)</span>
<a name="line-379"></a>        <span class='hs-varop'>.</span> <span class='hs-varid'>unlines</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>replaceVersion</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageVersion</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lines</span>
<a name="line-380"></a>
<a name="line-381"></a>  <span class='hs-keyword'>where</span>
<a name="line-382"></a>    <span class='hs-varid'>replaceVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Version</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-383"></a>    <span class='hs-varid'>replaceVersion</span> <span class='hs-varid'>version</span> <span class='hs-varid'>line</span>
<a name="line-384"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-str'>"version:"</span> <span class='hs-varop'>`isPrefixOf`</span> <span class='hs-varid'>map</span> <span class='hs-varid'>toLower</span> <span class='hs-varid'>line</span>
<a name="line-385"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-str'>"version: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>version</span>
<a name="line-386"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>line</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="snapshotPackage"></a><span class='hs-comment'>-- | Modifies a 'PackageDescription' by appending a snapshot number</span>
<a name="line-389"></a><span class='hs-comment'>-- corresponding to the given date.</span>
<a name="line-390"></a><span class='hs-comment'>--</span>
<a name="line-391"></a><span class='hs-definition'>snapshotPackage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UTCTime</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span>
<a name="line-392"></a><span class='hs-definition'>snapshotPackage</span> <span class='hs-varid'>date</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span>
<a name="line-393"></a>  <span class='hs-varid'>pkg</span> <span class='hs-layout'>{</span>
<a name="line-394"></a>    <span class='hs-varid'>package</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgid</span> <span class='hs-layout'>{</span> <span class='hs-varid'>pkgVersion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snapshotVersion</span> <span class='hs-varid'>date</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgVersion</span> <span class='hs-varid'>pkgid</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-395"></a>  <span class='hs-layout'>}</span>
<a name="line-396"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>pkgid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>packageId</span> <span class='hs-varid'>pkg</span>
<a name="line-397"></a>
<a name="line-398"></a><a name="snapshotVersion"></a><span class='hs-comment'>-- | Modifies a 'Version' by appending a snapshot number corresponding</span>
<a name="line-399"></a><span class='hs-comment'>-- to the given date.</span>
<a name="line-400"></a><span class='hs-comment'>--</span>
<a name="line-401"></a><span class='hs-definition'>snapshotVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UTCTime</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Version</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Version</span>
<a name="line-402"></a><span class='hs-definition'>snapshotVersion</span> <span class='hs-varid'>date</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>alterVersion</span> <span class='hs-layout'>(</span><span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>dateToSnapshotNumber</span> <span class='hs-varid'>date</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-403"></a>
<a name="line-404"></a><a name="dateToSnapshotNumber"></a><span class='hs-comment'>-- | Given a date produce a corresponding integer representation.</span>
<a name="line-405"></a><span class='hs-comment'>-- For example given a date @18/03/2008@ produce the number @20080318@.</span>
<a name="line-406"></a><span class='hs-comment'>--</span>
<a name="line-407"></a><span class='hs-definition'>dateToSnapshotNumber</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UTCTime</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-408"></a><span class='hs-definition'>dateToSnapshotNumber</span> <span class='hs-varid'>date</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>toGregorian</span> <span class='hs-layout'>(</span><span class='hs-varid'>utctDay</span> <span class='hs-varid'>date</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-409"></a>                            <span class='hs-layout'>(</span><span class='hs-varid'>year</span><span class='hs-layout'>,</span> <span class='hs-varid'>month</span><span class='hs-layout'>,</span> <span class='hs-varid'>day</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-410"></a>                                <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>year</span> <span class='hs-varop'>*</span> <span class='hs-num'>10000</span>
<a name="line-411"></a>                              <span class='hs-varop'>+</span> <span class='hs-varid'>month</span>             <span class='hs-varop'>*</span> <span class='hs-num'>100</span>
<a name="line-412"></a>                              <span class='hs-varop'>+</span> <span class='hs-varid'>day</span>
<a name="line-413"></a>
<a name="line-414"></a><a name="createArchive"></a><span class='hs-comment'>-- | Create an archive from a tree of source files, and clean up the tree.</span>
<a name="line-415"></a><span class='hs-definition'>createArchive</span>
<a name="line-416"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>            <span class='hs-comment'>-- ^ verbosity</span>
<a name="line-417"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span>   <span class='hs-comment'>-- ^ info from cabal file</span>
<a name="line-418"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>             <span class='hs-comment'>-- ^ source tree to archive</span>
<a name="line-419"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>             <span class='hs-comment'>-- ^ name of archive to create</span>
<a name="line-420"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-421"></a><span class='hs-definition'>createArchive</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>targetPref</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-422"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>tarBallFilePath</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPref</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>tarBallName</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-str'>"tar.gz"</span>
<a name="line-423"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>tarProg</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>requireProgram</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>tarProgram</span> <span class='hs-varid'>defaultProgramDb</span>
<a name="line-424"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>formatOptSupported</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-str'>"YES"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-425"></a>                           <span class='hs-conid'>Map.lookup</span> <span class='hs-str'>"Supports --format"</span>
<a name="line-426"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>programProperties</span> <span class='hs-varid'>tarProg</span><span class='hs-layout'>)</span>
<a name="line-427"></a>  <span class='hs-varid'>runProgram</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>tarProg</span> <span class='hs-varop'>$</span>
<a name="line-428"></a>    <span class='hs-comment'>-- Hmm: I could well be skating on thinner ice here by using the -C option</span>
<a name="line-429"></a>    <span class='hs-comment'>-- (=&gt; seems to be supported at least by GNU and *BSD tar) [The</span>
<a name="line-430"></a>    <span class='hs-comment'>-- prev. solution used pipes and sub-command sequences to set up the paths</span>
<a name="line-431"></a>    <span class='hs-comment'>-- correctly, which is problematic in a Windows setting.]</span>
<a name="line-432"></a>    <span class='hs-keyglyph'>[</span><span class='hs-str'>"-czf"</span><span class='hs-layout'>,</span> <span class='hs-varid'>tarBallFilePath</span><span class='hs-layout'>,</span> <span class='hs-str'>"-C"</span><span class='hs-layout'>,</span> <span class='hs-varid'>tmpDir</span><span class='hs-keyglyph'>]</span>
<a name="line-433"></a>    <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>formatOptSupported</span> <span class='hs-keyword'>then</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"--format"</span><span class='hs-layout'>,</span> <span class='hs-str'>"ustar"</span><span class='hs-keyglyph'>]</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-434"></a>    <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tarBallName</span> <span class='hs-varid'>pkg_descr</span><span class='hs-keyglyph'>]</span>
<a name="line-435"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>tarBallFilePath</span>
<a name="line-436"></a>
<a name="line-437"></a><a name="allSourcesBuildInfo"></a><span class='hs-comment'>-- | Given a buildinfo, return the names of all source files.</span>
<a name="line-438"></a><span class='hs-definition'>allSourcesBuildInfo</span>
<a name="line-439"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-440"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-441"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>          <span class='hs-comment'>-- ^ cwd -- change me to 'BuildPath Absolute PackageDir'</span>
<a name="line-442"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildInfo</span>
<a name="line-443"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PPSuffixHandler</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ Extra preprocessors</span>
<a name="line-444"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- ^ Exposed modules</span>
<a name="line-445"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-446"></a><span class='hs-definition'>allSourcesBuildInfo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>bi</span> <span class='hs-varid'>pps</span> <span class='hs-varid'>modules</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-447"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>searchDirs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getSymbolicPath</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSourceDirs</span> <span class='hs-varid'>bi</span><span class='hs-layout'>)</span>
<a name="line-448"></a>  <span class='hs-varid'>sources</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>concat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span>
<a name="line-449"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleName.toFilePath</span> <span class='hs-varid'>module_</span>
<a name="line-450"></a>      <span class='hs-comment'>-- NB: *Not* findFileWithExtension, because the same source</span>
<a name="line-451"></a>      <span class='hs-comment'>-- file may show up in multiple paths due to a conditional;</span>
<a name="line-452"></a>      <span class='hs-comment'>-- we need to package all of them.  See #367.</span>
<a name="line-453"></a>      <span class='hs-keyword'>in</span> <span class='hs-varid'>findAllFilesCwdWithExtension</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>suffixes</span> <span class='hs-varid'>searchDirs</span> <span class='hs-varid'>file</span>
<a name="line-454"></a>         <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>nonEmpty'</span> <span class='hs-layout'>(</span><span class='hs-varid'>notFound</span> <span class='hs-varid'>module_</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span>
<a name="line-455"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>module_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modules</span> <span class='hs-varop'>++</span> <span class='hs-varid'>otherModules</span> <span class='hs-varid'>bi</span> <span class='hs-keyglyph'>]</span>
<a name="line-456"></a>  <span class='hs-varid'>bootFiles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequenceA</span>
<a name="line-457"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModuleName.toFilePath</span> <span class='hs-varid'>module_</span>
<a name="line-458"></a>          <span class='hs-varid'>fileExts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"hs-boot"</span><span class='hs-layout'>,</span> <span class='hs-str'>"lhs-boot"</span><span class='hs-keyglyph'>]</span>
<a name="line-459"></a>      <span class='hs-keyword'>in</span> <span class='hs-varid'>findFileCwdWithExtension</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>fileExts</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>getSymbolicPath</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsSourceDirs</span> <span class='hs-varid'>bi</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>file</span>
<a name="line-460"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>module_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>modules</span> <span class='hs-varop'>++</span> <span class='hs-varid'>otherModules</span> <span class='hs-varid'>bi</span> <span class='hs-keyglyph'>]</span>
<a name="line-461"></a>
<a name="line-462"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sources</span> <span class='hs-varop'>++</span> <span class='hs-varid'>catMaybes</span> <span class='hs-varid'>bootFiles</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cSources</span> <span class='hs-varid'>bi</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cxxSources</span> <span class='hs-varid'>bi</span> <span class='hs-varop'>++</span>
<a name="line-463"></a>           <span class='hs-varid'>cmmSources</span> <span class='hs-varid'>bi</span> <span class='hs-varop'>++</span> <span class='hs-varid'>asmSources</span> <span class='hs-varid'>bi</span> <span class='hs-varop'>++</span> <span class='hs-varid'>jsSources</span> <span class='hs-varid'>bi</span>
<a name="line-464"></a>
<a name="line-465"></a>  <span class='hs-keyword'>where</span>
<a name="line-466"></a>    <span class='hs-varid'>nonEmpty'</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span>
<a name="line-467"></a>    <span class='hs-varid'>nonEmpty'</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-468"></a>    <span class='hs-varid'>nonEmpty'</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-varid'>xs</span>
<a name="line-469"></a>
<a name="line-470"></a>    <span class='hs-varid'>suffixes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppSuffixes</span> <span class='hs-varid'>pps</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>"hs"</span><span class='hs-layout'>,</span> <span class='hs-str'>"lhs"</span><span class='hs-layout'>,</span> <span class='hs-str'>"hsig"</span><span class='hs-layout'>,</span> <span class='hs-str'>"lhsig"</span><span class='hs-keyglyph'>]</span>
<a name="line-471"></a>
<a name="line-472"></a>    <span class='hs-varid'>notFound</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModuleName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-473"></a>    <span class='hs-varid'>notFound</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rip</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Error: Could not find module: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>m</span>
<a name="line-474"></a>                 <span class='hs-varop'>++</span> <span class='hs-str'>" with any suffix: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>suffixes</span> <span class='hs-varop'>++</span> <span class='hs-str'>". If the module "</span>
<a name="line-475"></a>                 <span class='hs-varop'>++</span> <span class='hs-str'>"is autogenerated it should be added to 'autogen-modules'."</span>
<a name="line-476"></a>
<a name="line-477"></a>
<a name="line-478"></a><a name="printPackageProblems"></a><span class='hs-comment'>-- | Note: must be called with the CWD set to the directory containing</span>
<a name="line-479"></a><span class='hs-comment'>-- the '.cabal' file.</span>
<a name="line-480"></a><span class='hs-definition'>printPackageProblems</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-481"></a><span class='hs-definition'>printPackageProblems</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-482"></a>  <span class='hs-varid'>ioChecks</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkPackageFiles</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>pkg_descr</span> <span class='hs-str'>"."</span>
<a name="line-483"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>pureChecks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkConfiguredPackage</span> <span class='hs-varid'>pkg_descr</span>
<a name="line-484"></a>      <span class='hs-varid'>isDistError</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageDistSuspicious</span>     <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-485"></a>      <span class='hs-varid'>isDistError</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageDistSuspiciousWarn</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-486"></a>      <span class='hs-varid'>isDistError</span> <span class='hs-keyword'>_</span>                             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-487"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>errors</span><span class='hs-layout'>,</span> <span class='hs-varid'>warnings</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>isDistError</span> <span class='hs-layout'>(</span><span class='hs-varid'>pureChecks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>ioChecks</span><span class='hs-layout'>)</span>
<a name="line-488"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>errors</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-489"></a>      <span class='hs-varid'>notice</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Distribution quality errors:\n"</span>
<a name="line-490"></a>                      <span class='hs-varop'>++</span> <span class='hs-varid'>unlines</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>explanation</span> <span class='hs-varid'>errors</span><span class='hs-layout'>)</span>
<a name="line-491"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>warnings</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-492"></a>      <span class='hs-varid'>notice</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Distribution quality warnings:\n"</span>
<a name="line-493"></a>                      <span class='hs-varop'>++</span> <span class='hs-varid'>unlines</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>explanation</span> <span class='hs-varid'>warnings</span><span class='hs-layout'>)</span>
<a name="line-494"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>errors</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-495"></a>      <span class='hs-varid'>notice</span> <span class='hs-varid'>verbosity</span>
<a name="line-496"></a>        <span class='hs-str'>"Note: the public hackage server would reject this package."</span>
<a name="line-497"></a>
<a name="line-498"></a><span class='hs-comment'>------------------------------------------------------------</span>
<a name="line-499"></a>
<a name="line-500"></a><a name="tarBallName"></a><span class='hs-comment'>-- | The name of the tarball without extension</span>
<a name="line-501"></a><span class='hs-comment'>--</span>
<a name="line-502"></a><span class='hs-definition'>tarBallName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PackageDescription</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-503"></a><span class='hs-definition'>tarBallName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varop'>.</span> <span class='hs-varid'>packageId</span>
<a name="line-504"></a>
<a name="line-505"></a><a name="mapAllBuildInfo"></a><span class='hs-definition'>mapAllBuildInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>BuildInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BuildInfo</span><span class='hs-layout'>)</span>
<a name="line-506"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>PackageDescription</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageDescription</span><span class='hs-layout'>)</span>
<a name="line-507"></a><span class='hs-definition'>mapAllBuildInfo</span> <span class='hs-varid'>f</span> <span class='hs-varid'>pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkg</span> <span class='hs-layout'>{</span>
<a name="line-508"></a>    <span class='hs-varid'>library</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>mapLibBi</span> <span class='hs-layout'>(</span><span class='hs-varid'>library</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-509"></a>    <span class='hs-varid'>subLibraries</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>mapLibBi</span> <span class='hs-layout'>(</span><span class='hs-varid'>subLibraries</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-510"></a>    <span class='hs-varid'>foreignLibs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>mapFLibBi</span> <span class='hs-layout'>(</span><span class='hs-varid'>foreignLibs</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-511"></a>    <span class='hs-varid'>executables</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>mapExeBi</span> <span class='hs-layout'>(</span><span class='hs-varid'>executables</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-512"></a>    <span class='hs-varid'>testSuites</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>mapTestBi</span> <span class='hs-layout'>(</span><span class='hs-varid'>testSuites</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-513"></a>    <span class='hs-varid'>benchmarks</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>mapBenchBi</span> <span class='hs-layout'>(</span><span class='hs-varid'>benchmarks</span> <span class='hs-varid'>pkg</span><span class='hs-layout'>)</span>
<a name="line-514"></a>  <span class='hs-layout'>}</span>
<a name="line-515"></a>  <span class='hs-keyword'>where</span>
<a name="line-516"></a>    <span class='hs-varid'>mapLibBi</span>   <span class='hs-varid'>lib</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lib</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>libBuildInfo</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>libBuildInfo</span> <span class='hs-varid'>lib</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-517"></a>    <span class='hs-varid'>mapFLibBi</span>  <span class='hs-varid'>flib</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flib</span> <span class='hs-layout'>{</span> <span class='hs-varid'>foreignLibBuildInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>foreignLibBuildInfo</span> <span class='hs-varid'>flib</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-518"></a>    <span class='hs-varid'>mapExeBi</span>   <span class='hs-varid'>exe</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exe</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>buildInfo</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>buildInfo</span> <span class='hs-varid'>exe</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-519"></a>    <span class='hs-varid'>mapTestBi</span>  <span class='hs-varid'>tst</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tst</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>testBuildInfo</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>testBuildInfo</span> <span class='hs-varid'>tst</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-520"></a>    <span class='hs-varid'>mapBenchBi</span> <span class='hs-varid'>bm</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bm</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>benchmarkBuildInfo</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>benchmarkBuildInfo</span> <span class='hs-varid'>bm</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre></body>
</html>

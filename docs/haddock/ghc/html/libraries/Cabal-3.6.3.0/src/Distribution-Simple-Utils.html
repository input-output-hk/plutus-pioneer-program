<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Distribution/Simple/Utils.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE GADTs #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE DeriveGeneric #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-10"></a><span class='hs-comment'>-- |</span>
<a name="line-11"></a><span class='hs-comment'>-- Module      :  Distribution.Simple.Utils</span>
<a name="line-12"></a><span class='hs-comment'>-- Copyright   :  Isaac Jones, Simon Marlow 2003-2004</span>
<a name="line-13"></a><span class='hs-comment'>-- License     :  BSD3</span>
<a name="line-14"></a><span class='hs-comment'>--                portions Copyright (c) 2007, Galois Inc.</span>
<a name="line-15"></a><span class='hs-comment'>--</span>
<a name="line-16"></a><span class='hs-comment'>-- Maintainer  :  cabal-devel@haskell.org</span>
<a name="line-17"></a><span class='hs-comment'>-- Portability :  portable</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-comment'>-- A large and somewhat miscellaneous collection of utility functions used</span>
<a name="line-20"></a><span class='hs-comment'>-- throughout the rest of the Cabal lib and in other tools that use the Cabal</span>
<a name="line-21"></a><span class='hs-comment'>-- lib like @cabal-install@. It has a very simple set of logging actions. It</span>
<a name="line-22"></a><span class='hs-comment'>-- has low level functions for running programs, a bunch of wrappers for</span>
<a name="line-23"></a><span class='hs-comment'>-- various directory and file functions that do extra logging.</span>
<a name="line-24"></a>
<a name="line-25"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Distribution.Simple.Utils</span> <span class='hs-layout'>(</span>
<a name="line-26"></a>        <span class='hs-varid'>cabalVersion</span><span class='hs-layout'>,</span>
<a name="line-27"></a>
<a name="line-28"></a>        <span class='hs-comment'>-- * logging and errors</span>
<a name="line-29"></a>        <span class='hs-varid'>dieNoVerbosity</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>die'</span><span class='hs-layout'>,</span> <span class='hs-varid'>dieWithLocation'</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>dieNoWrap</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>topHandler</span><span class='hs-layout'>,</span> <span class='hs-varid'>topHandlerWith</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>warn</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>notice</span><span class='hs-layout'>,</span> <span class='hs-varid'>noticeNoWrap</span><span class='hs-layout'>,</span> <span class='hs-varid'>noticeDoc</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>setupMessage</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>info</span><span class='hs-layout'>,</span> <span class='hs-varid'>infoNoWrap</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>debug</span><span class='hs-layout'>,</span> <span class='hs-varid'>debugNoWrap</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>chattyTry</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>annotateIO</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>printRawCommandAndArgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>printRawCommandAndArgsAndEnv</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>withOutputMarker</span><span class='hs-layout'>,</span>
<a name="line-42"></a>
<a name="line-43"></a>        <span class='hs-comment'>-- * exceptions</span>
<a name="line-44"></a>        <span class='hs-varid'>handleDoesNotExist</span><span class='hs-layout'>,</span>
<a name="line-45"></a>
<a name="line-46"></a>        <span class='hs-comment'>-- * running programs</span>
<a name="line-47"></a>        <span class='hs-varid'>rawSystemExit</span><span class='hs-layout'>,</span>
<a name="line-48"></a>        <span class='hs-varid'>rawSystemExitCode</span><span class='hs-layout'>,</span>
<a name="line-49"></a>        <span class='hs-varid'>rawSystemExitWithEnv</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>rawSystemStdout</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>rawSystemStdInOut</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-varid'>rawSystemIOWithEnv</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>rawSystemIOWithEnvAndAction</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>createProcessWithEnv</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>maybeExit</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>xargs</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>findProgramVersion</span><span class='hs-layout'>,</span>
<a name="line-58"></a>
<a name="line-59"></a>        <span class='hs-comment'>-- ** 'IOData' re-export</span>
<a name="line-60"></a>        <span class='hs-comment'>--</span>
<a name="line-61"></a>        <span class='hs-comment'>-- These types are re-exported from</span>
<a name="line-62"></a>        <span class='hs-comment'>-- "Distribution.Utils.IOData" for convience as they're</span>
<a name="line-63"></a>        <span class='hs-comment'>-- exposed in the API of 'rawSystemStdInOut'</span>
<a name="line-64"></a>        <span class='hs-conid'>IOData</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-conid'>KnownIODataMode</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-66"></a>        <span class='hs-conid'>IODataMode</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-67"></a>
<a name="line-68"></a>        <span class='hs-comment'>-- * copying files</span>
<a name="line-69"></a>        <span class='hs-varid'>createDirectoryIfMissingVerbose</span><span class='hs-layout'>,</span>
<a name="line-70"></a>        <span class='hs-varid'>copyFileVerbose</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-varid'>copyFiles</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>copyFileTo</span><span class='hs-layout'>,</span>
<a name="line-73"></a>
<a name="line-74"></a>        <span class='hs-comment'>-- * installing files</span>
<a name="line-75"></a>        <span class='hs-varid'>installOrdinaryFile</span><span class='hs-layout'>,</span>
<a name="line-76"></a>        <span class='hs-varid'>installExecutableFile</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>installMaybeExecutableFile</span><span class='hs-layout'>,</span>
<a name="line-78"></a>        <span class='hs-varid'>installOrdinaryFiles</span><span class='hs-layout'>,</span>
<a name="line-79"></a>        <span class='hs-varid'>installExecutableFiles</span><span class='hs-layout'>,</span>
<a name="line-80"></a>        <span class='hs-varid'>installMaybeExecutableFiles</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>installDirectoryContents</span><span class='hs-layout'>,</span>
<a name="line-82"></a>        <span class='hs-varid'>copyDirectoryRecursive</span><span class='hs-layout'>,</span>
<a name="line-83"></a>
<a name="line-84"></a>        <span class='hs-comment'>-- * File permissions</span>
<a name="line-85"></a>        <span class='hs-varid'>doesExecutableExist</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>setFileOrdinary</span><span class='hs-layout'>,</span>
<a name="line-87"></a>        <span class='hs-varid'>setFileExecutable</span><span class='hs-layout'>,</span>
<a name="line-88"></a>
<a name="line-89"></a>        <span class='hs-comment'>-- * file names</span>
<a name="line-90"></a>        <span class='hs-varid'>currentDir</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>shortRelativePath</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>dropExeExtension</span><span class='hs-layout'>,</span>
<a name="line-93"></a>        <span class='hs-varid'>exeExtensions</span><span class='hs-layout'>,</span>
<a name="line-94"></a>
<a name="line-95"></a>        <span class='hs-comment'>-- * finding files</span>
<a name="line-96"></a>        <span class='hs-varid'>findFileEx</span><span class='hs-layout'>,</span>
<a name="line-97"></a>        <span class='hs-varid'>findFileCwd</span><span class='hs-layout'>,</span>
<a name="line-98"></a>        <span class='hs-varid'>findFirstFile</span><span class='hs-layout'>,</span>
<a name="line-99"></a>        <span class='hs-varid'>findFileWithExtension</span><span class='hs-layout'>,</span>
<a name="line-100"></a>        <span class='hs-varid'>findFileCwdWithExtension</span><span class='hs-layout'>,</span>
<a name="line-101"></a>        <span class='hs-varid'>findFileWithExtension'</span><span class='hs-layout'>,</span>
<a name="line-102"></a>        <span class='hs-varid'>findAllFilesWithExtension</span><span class='hs-layout'>,</span>
<a name="line-103"></a>        <span class='hs-varid'>findAllFilesCwdWithExtension</span><span class='hs-layout'>,</span>
<a name="line-104"></a>        <span class='hs-varid'>findModuleFileEx</span><span class='hs-layout'>,</span>
<a name="line-105"></a>        <span class='hs-varid'>findModuleFilesEx</span><span class='hs-layout'>,</span>
<a name="line-106"></a>        <span class='hs-varid'>getDirectoryContentsRecursive</span><span class='hs-layout'>,</span>
<a name="line-107"></a>
<a name="line-108"></a>        <span class='hs-comment'>-- * environment variables</span>
<a name="line-109"></a>        <span class='hs-varid'>isInSearchPath</span><span class='hs-layout'>,</span>
<a name="line-110"></a>        <span class='hs-varid'>addLibraryPath</span><span class='hs-layout'>,</span>
<a name="line-111"></a>
<a name="line-112"></a>        <span class='hs-comment'>-- * modification time</span>
<a name="line-113"></a>        <span class='hs-varid'>moreRecentFile</span><span class='hs-layout'>,</span>
<a name="line-114"></a>        <span class='hs-varid'>existsAndIsMoreRecentThan</span><span class='hs-layout'>,</span>
<a name="line-115"></a>
<a name="line-116"></a>        <span class='hs-comment'>-- * temp files and dirs</span>
<a name="line-117"></a>        <span class='hs-conid'>TempFileOptions</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>defaultTempFileOptions</span><span class='hs-layout'>,</span>
<a name="line-118"></a>        <span class='hs-varid'>withTempFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>withTempFileEx</span><span class='hs-layout'>,</span>
<a name="line-119"></a>        <span class='hs-varid'>withTempDirectory</span><span class='hs-layout'>,</span> <span class='hs-varid'>withTempDirectoryEx</span><span class='hs-layout'>,</span>
<a name="line-120"></a>        <span class='hs-varid'>createTempDirectory</span><span class='hs-layout'>,</span>
<a name="line-121"></a>
<a name="line-122"></a>        <span class='hs-comment'>-- * .cabal and .buildinfo files</span>
<a name="line-123"></a>        <span class='hs-varid'>defaultPackageDesc</span><span class='hs-layout'>,</span>
<a name="line-124"></a>        <span class='hs-varid'>findPackageDesc</span><span class='hs-layout'>,</span>
<a name="line-125"></a>        <span class='hs-varid'>findPackageDescCwd</span><span class='hs-layout'>,</span>
<a name="line-126"></a>        <span class='hs-varid'>tryFindPackageDesc</span><span class='hs-layout'>,</span>
<a name="line-127"></a>        <span class='hs-varid'>tryFindPackageDescCwd</span><span class='hs-layout'>,</span>
<a name="line-128"></a>        <span class='hs-varid'>findHookedPackageDesc</span><span class='hs-layout'>,</span>
<a name="line-129"></a>
<a name="line-130"></a>        <span class='hs-comment'>-- * reading and writing files safely</span>
<a name="line-131"></a>        <span class='hs-varid'>withFileContents</span><span class='hs-layout'>,</span>
<a name="line-132"></a>        <span class='hs-varid'>writeFileAtomic</span><span class='hs-layout'>,</span>
<a name="line-133"></a>        <span class='hs-varid'>rewriteFileEx</span><span class='hs-layout'>,</span>
<a name="line-134"></a>        <span class='hs-varid'>rewriteFileLBS</span><span class='hs-layout'>,</span>
<a name="line-135"></a>
<a name="line-136"></a>        <span class='hs-comment'>-- * Unicode</span>
<a name="line-137"></a>        <span class='hs-varid'>fromUTF8BS</span><span class='hs-layout'>,</span>
<a name="line-138"></a>        <span class='hs-varid'>fromUTF8LBS</span><span class='hs-layout'>,</span>
<a name="line-139"></a>        <span class='hs-varid'>toUTF8BS</span><span class='hs-layout'>,</span>
<a name="line-140"></a>        <span class='hs-varid'>toUTF8LBS</span><span class='hs-layout'>,</span>
<a name="line-141"></a>        <span class='hs-varid'>readUTF8File</span><span class='hs-layout'>,</span>
<a name="line-142"></a>        <span class='hs-varid'>withUTF8FileContents</span><span class='hs-layout'>,</span>
<a name="line-143"></a>        <span class='hs-varid'>writeUTF8File</span><span class='hs-layout'>,</span>
<a name="line-144"></a>        <span class='hs-varid'>normaliseLineEndings</span><span class='hs-layout'>,</span>
<a name="line-145"></a>
<a name="line-146"></a>        <span class='hs-comment'>-- * BOM</span>
<a name="line-147"></a>        <span class='hs-varid'>ignoreBOM</span><span class='hs-layout'>,</span>
<a name="line-148"></a>
<a name="line-149"></a>        <span class='hs-comment'>-- * generic utils</span>
<a name="line-150"></a>        <span class='hs-varid'>dropWhileEndLE</span><span class='hs-layout'>,</span>
<a name="line-151"></a>        <span class='hs-varid'>takeWhileEndLE</span><span class='hs-layout'>,</span>
<a name="line-152"></a>        <span class='hs-varid'>equating</span><span class='hs-layout'>,</span>
<a name="line-153"></a>        <span class='hs-varid'>comparing</span><span class='hs-layout'>,</span>
<a name="line-154"></a>        <span class='hs-varid'>isInfixOf</span><span class='hs-layout'>,</span>
<a name="line-155"></a>        <span class='hs-varid'>intercalate</span><span class='hs-layout'>,</span>
<a name="line-156"></a>        <span class='hs-varid'>lowercase</span><span class='hs-layout'>,</span>
<a name="line-157"></a>        <span class='hs-varid'>listUnion</span><span class='hs-layout'>,</span>
<a name="line-158"></a>        <span class='hs-varid'>listUnionRight</span><span class='hs-layout'>,</span>
<a name="line-159"></a>        <span class='hs-varid'>ordNub</span><span class='hs-layout'>,</span>
<a name="line-160"></a>        <span class='hs-varid'>ordNubBy</span><span class='hs-layout'>,</span>
<a name="line-161"></a>        <span class='hs-varid'>ordNubRight</span><span class='hs-layout'>,</span>
<a name="line-162"></a>        <span class='hs-varid'>safeHead</span><span class='hs-layout'>,</span>
<a name="line-163"></a>        <span class='hs-varid'>safeTail</span><span class='hs-layout'>,</span>
<a name="line-164"></a>        <span class='hs-varid'>safeLast</span><span class='hs-layout'>,</span>
<a name="line-165"></a>        <span class='hs-varid'>safeInit</span><span class='hs-layout'>,</span>
<a name="line-166"></a>        <span class='hs-varid'>unintersperse</span><span class='hs-layout'>,</span>
<a name="line-167"></a>        <span class='hs-varid'>wrapText</span><span class='hs-layout'>,</span>
<a name="line-168"></a>        <span class='hs-varid'>wrapLine</span><span class='hs-layout'>,</span>
<a name="line-169"></a>
<a name="line-170"></a>        <span class='hs-comment'>-- * FilePath stuff</span>
<a name="line-171"></a>        <span class='hs-varid'>isAbsoluteOnAnyPlatform</span><span class='hs-layout'>,</span>
<a name="line-172"></a>        <span class='hs-varid'>isRelativeOnAnyPlatform</span><span class='hs-layout'>,</span>
<a name="line-173"></a>
<a name="line-174"></a>        <span class='hs-comment'>-- * Deprecated functions</span>
<a name="line-175"></a>        <span class='hs-varid'>findFile</span><span class='hs-layout'>,</span>
<a name="line-176"></a>        <span class='hs-varid'>findModuleFile</span><span class='hs-layout'>,</span>
<a name="line-177"></a>        <span class='hs-varid'>findModuleFiles</span><span class='hs-layout'>,</span>
<a name="line-178"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-179"></a>
<a name="line-180"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Prelude</span> <span class='hs-conid'>()</span>
<a name="line-181"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Prelude</span>
<a name="line-182"></a>
<a name="line-183"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Utils.Generic</span>
<a name="line-184"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Utils.IOData</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOData</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>IODataMode</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>KnownIODataMode</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-185"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Distribution.Utils.IOData</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>IOData</span>
<a name="line-186"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.ModuleName</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>ModuleName</span>
<a name="line-187"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.System</span>
<a name="line-188"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Version</span>
<a name="line-189"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Async</span>
<a name="line-190"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.CopyFile</span>
<a name="line-191"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Internal.TempFile</span>
<a name="line-192"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.FilePath</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FilePath</span>
<a name="line-193"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Stack</span>
<a name="line-194"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Verbosity</span>
<a name="line-195"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Types.PackageId</span>
<a name="line-196"></a>
<a name="line-197"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &lt; 711</span>
<a name="line-198"></a><span class='hs-cpp'>#ifdef VERSION_base</span>
<a name="line-199"></a><span class='hs-cpp'>#define BOOTSTRAPPED_CABAL 1</span>
<a name="line-200"></a><span class='hs-cpp'>#endif</span>
<a name="line-201"></a><span class='hs-cpp'>#else</span>
<a name="line-202"></a><span class='hs-cpp'>#ifdef CURRENT_PACKAGE_KEY</span>
<a name="line-203"></a><span class='hs-cpp'>#define BOOTSTRAPPED_CABAL 1</span>
<a name="line-204"></a><span class='hs-cpp'>#endif</span>
<a name="line-205"></a><span class='hs-cpp'>#endif</span>
<a name="line-206"></a>
<a name="line-207"></a><span class='hs-cpp'>#ifdef BOOTSTRAPPED_CABAL</span>
<a name="line-208"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Paths_Cabal</span> <span class='hs-layout'>(</span><span class='hs-varid'>version</span><span class='hs-layout'>)</span>
<a name="line-209"></a><span class='hs-cpp'>#endif</span>
<a name="line-210"></a>
<a name="line-211"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Pretty</span>
<a name="line-212"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Parsec</span>
<a name="line-213"></a>
<a name="line-214"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Typeable</span>
<a name="line-215"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>cast</span> <span class='hs-layout'>)</span>
<a name="line-216"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.ByteString.Lazy</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>BS</span>
<a name="line-217"></a>
<a name="line-218"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Directory</span>
<a name="line-219"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>Permissions</span><span class='hs-layout'>(</span><span class='hs-varid'>executable</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>getDirectoryContents</span><span class='hs-layout'>,</span> <span class='hs-varid'>getPermissions</span>
<a name="line-220"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>doesDirectoryExist</span><span class='hs-layout'>,</span> <span class='hs-varid'>doesFileExist</span><span class='hs-layout'>,</span> <span class='hs-varid'>removeFile</span>
<a name="line-221"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>getModificationTime</span><span class='hs-layout'>,</span> <span class='hs-varid'>createDirectory</span><span class='hs-layout'>,</span> <span class='hs-varid'>removeDirectoryRecursive</span> <span class='hs-layout'>)</span>
<a name="line-222"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Environment</span>
<a name="line-223"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>getProgName</span> <span class='hs-layout'>)</span>
<a name="line-224"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.FilePath</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FilePath</span>
<a name="line-225"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>normalise</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;.&gt;</span><span class='hs-layout'>)</span>
<a name="line-226"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>getSearchPath</span><span class='hs-layout'>,</span> <span class='hs-varid'>joinPath</span><span class='hs-layout'>,</span> <span class='hs-varid'>takeDirectory</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitExtension</span>
<a name="line-227"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>splitDirectories</span><span class='hs-layout'>,</span> <span class='hs-varid'>searchPathSeparator</span> <span class='hs-layout'>)</span>
<a name="line-228"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span>
<a name="line-229"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>Handle</span><span class='hs-layout'>,</span> <span class='hs-varid'>hSetBinaryMode</span><span class='hs-layout'>,</span> <span class='hs-varid'>hGetContents</span><span class='hs-layout'>,</span> <span class='hs-varid'>stderr</span><span class='hs-layout'>,</span> <span class='hs-varid'>stdout</span><span class='hs-layout'>,</span> <span class='hs-varid'>hPutStr</span><span class='hs-layout'>,</span> <span class='hs-varid'>hFlush</span>
<a name="line-230"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hClose</span><span class='hs-layout'>,</span> <span class='hs-varid'>hSetBuffering</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>hPutStrLn</span> <span class='hs-layout'>)</span>
<a name="line-231"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO.Error</span>
<a name="line-232"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO.Unsafe</span>
<a name="line-233"></a>    <span class='hs-layout'>(</span> <span class='hs-varid'>unsafeInterleaveIO</span> <span class='hs-layout'>)</span>
<a name="line-234"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Control.Exception</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Exception</span>
<a name="line-235"></a>
<a name="line-236"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C.Error</span> <span class='hs-layout'>(</span><span class='hs-conid'>Errno</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ePIPE</span><span class='hs-layout'>)</span>
<a name="line-237"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Time.Clock.POSIX</span> <span class='hs-layout'>(</span><span class='hs-varid'>getPOSIXTime</span><span class='hs-layout'>,</span> <span class='hs-conid'>POSIXTime</span><span class='hs-layout'>)</span>
<a name="line-238"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Numeric</span> <span class='hs-layout'>(</span><span class='hs-varid'>showFFloat</span><span class='hs-layout'>)</span>
<a name="line-239"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Distribution.Compat.Process</span>  <span class='hs-layout'>(</span><span class='hs-varid'>createProcess</span><span class='hs-layout'>,</span> <span class='hs-varid'>rawSystem</span><span class='hs-layout'>,</span> <span class='hs-varid'>runInteractiveProcess</span><span class='hs-layout'>)</span>
<a name="line-240"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Process</span>
<a name="line-241"></a>         <span class='hs-layout'>(</span> <span class='hs-conid'>ProcessHandle</span>
<a name="line-242"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>showCommandForUser</span><span class='hs-layout'>,</span> <span class='hs-varid'>waitForProcess</span><span class='hs-layout'>)</span>
<a name="line-243"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System.Process</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Process</span>
<a name="line-244"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.IO.Exception</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>GHC</span>
<a name="line-245"></a>
<a name="line-246"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Text.PrettyPrint</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Disp</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="cabalVersion"></a><span class='hs-comment'>-- We only get our own version number when we're building with ourselves</span>
<a name="line-249"></a><span class='hs-definition'>cabalVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Version</span>
<a name="line-250"></a><span class='hs-cpp'>#if defined(BOOTSTRAPPED_CABAL)</span>
<a name="line-251"></a><span class='hs-definition'>cabalVersion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVersion'</span> <span class='hs-conid'>Paths_Cabal.version</span>
<a name="line-252"></a><span class='hs-cpp'>#elif defined(CABAL_VERSION)</span>
<a name="line-253"></a><span class='hs-definition'>cabalVersion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVersion</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CABAL_VERSION</span><span class='hs-keyglyph'>]</span>
<a name="line-254"></a><span class='hs-cpp'>#else</span>
<a name="line-255"></a><span class='hs-definition'>cabalVersion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVersion</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>3</span><span class='hs-layout'>,</span><span class='hs-num'>0</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>--used when bootstrapping</span>
<a name="line-256"></a><span class='hs-cpp'>#endif</span>
<a name="line-257"></a>
<a name="line-258"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-259"></a><span class='hs-comment'>-- Exception and logging utils</span>
<a name="line-260"></a>
<a name="line-261"></a><span class='hs-comment'>-- Cabal's logging infrastructure has a few constraints:</span>
<a name="line-262"></a><span class='hs-comment'>--</span>
<a name="line-263"></a><span class='hs-comment'>--  * We must make all logging formatting and emissions decisions based</span>
<a name="line-264"></a><span class='hs-comment'>--    on the 'Verbosity' parameter, which is the only parameter that is</span>
<a name="line-265"></a><span class='hs-comment'>--    plumbed to enough call-sites to actually be used for this matter.</span>
<a name="line-266"></a><span class='hs-comment'>--    (One of Cabal's "big mistakes" is to have never have defined a</span>
<a name="line-267"></a><span class='hs-comment'>--    monad of its own.)</span>
<a name="line-268"></a><span class='hs-comment'>--</span>
<a name="line-269"></a><span class='hs-comment'>--  * When we 'die', we must raise an IOError.  This a backwards</span>
<a name="line-270"></a><span class='hs-comment'>--    compatibility consideration, because that's what we've raised</span>
<a name="line-271"></a><span class='hs-comment'>--    previously, and if we change to any other exception type,</span>
<a name="line-272"></a><span class='hs-comment'>--    exception handlers which match on IOError will no longer work.</span>
<a name="line-273"></a><span class='hs-comment'>--    One case where it is known we rely on IOError being catchable</span>
<a name="line-274"></a><span class='hs-comment'>--    is 'readPkgConfigDb' in cabal-install; there may be other</span>
<a name="line-275"></a><span class='hs-comment'>--    user code that also assumes this.</span>
<a name="line-276"></a><span class='hs-comment'>--</span>
<a name="line-277"></a><span class='hs-comment'>--  * The 'topHandler' does not know what 'Verbosity' is, because</span>
<a name="line-278"></a><span class='hs-comment'>--    it gets called before we've done command line parsing (where</span>
<a name="line-279"></a><span class='hs-comment'>--    the 'Verbosity' parameter would come from).</span>
<a name="line-280"></a><span class='hs-comment'>--</span>
<a name="line-281"></a><span class='hs-comment'>-- This leads to two big architectural choices:</span>
<a name="line-282"></a><span class='hs-comment'>--</span>
<a name="line-283"></a><span class='hs-comment'>--  * Although naively we might imagine 'Verbosity' to be a simple</span>
<a name="line-284"></a><span class='hs-comment'>--    enumeration type, actually it is a full-on abstract data type</span>
<a name="line-285"></a><span class='hs-comment'>--    that may contain arbitrarily complex information.  At the</span>
<a name="line-286"></a><span class='hs-comment'>--    moment, it is fully representable as a string, but we might</span>
<a name="line-287"></a><span class='hs-comment'>--    eventually also use verbosity to let users register their</span>
<a name="line-288"></a><span class='hs-comment'>--    own logging handler.</span>
<a name="line-289"></a><span class='hs-comment'>--</span>
<a name="line-290"></a><span class='hs-comment'>--  * When we call 'die', we perform all the formatting and addition</span>
<a name="line-291"></a><span class='hs-comment'>--    of extra information we need, and then ship this in the IOError</span>
<a name="line-292"></a><span class='hs-comment'>--    to the top-level handler.  Here are alternate designs that</span>
<a name="line-293"></a><span class='hs-comment'>--    don't work:</span>
<a name="line-294"></a><span class='hs-comment'>--</span>
<a name="line-295"></a><span class='hs-comment'>--      a) Ship the unformatted info to the handler.  This doesn't</span>
<a name="line-296"></a><span class='hs-comment'>--      work because at the point the handler gets the message,</span>
<a name="line-297"></a><span class='hs-comment'>--      we've lost call stacks, and even if we did, we don't have access</span>
<a name="line-298"></a><span class='hs-comment'>--      to 'Verbosity' to decide whether or not to render it.</span>
<a name="line-299"></a><span class='hs-comment'>--</span>
<a name="line-300"></a><span class='hs-comment'>--      b) Print the information at the 'die' site, then raise an</span>
<a name="line-301"></a><span class='hs-comment'>--      error.  This means that if the exception is subsequently</span>
<a name="line-302"></a><span class='hs-comment'>--      caught by a handler, we will still have emitted the output,</span>
<a name="line-303"></a><span class='hs-comment'>--      which is not the correct behavior.</span>
<a name="line-304"></a><span class='hs-comment'>--</span>
<a name="line-305"></a><span class='hs-comment'>--    For the top-level handler to "know" that an error message</span>
<a name="line-306"></a><span class='hs-comment'>--    contains one of these fully formatted packets, we set a sentinel</span>
<a name="line-307"></a><span class='hs-comment'>--    in one of IOError's extra fields.  This is handled by</span>
<a name="line-308"></a><span class='hs-comment'>--    'ioeSetVerbatim' and 'ioeGetVerbatim'.</span>
<a name="line-309"></a><span class='hs-comment'>--</span>
<a name="line-310"></a>
<a name="line-311"></a><a name="dieNoVerbosity"></a><span class='hs-definition'>dieNoVerbosity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-312"></a><span class='hs-definition'>dieNoVerbosity</span> <span class='hs-varid'>msg</span>
<a name="line-313"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioError</span> <span class='hs-layout'>(</span><span class='hs-varid'>userError</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-314"></a>  <span class='hs-keyword'>where</span>
<a name="line-315"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callStack</span> <span class='hs-comment'>-- TODO: Attach CallStack to exception</span>
<a name="line-316"></a>
<a name="line-317"></a><a name="ioeSetVerbatim"></a><span class='hs-comment'>-- | Tag an 'IOError' whose error string should be output to the screen</span>
<a name="line-318"></a><span class='hs-comment'>-- verbatim.</span>
<a name="line-319"></a><span class='hs-definition'>ioeSetVerbatim</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IOError</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOError</span>
<a name="line-320"></a><span class='hs-definition'>ioeSetVerbatim</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioeSetLocation</span> <span class='hs-varid'>e</span> <span class='hs-str'>"dieVerbatim"</span>
<a name="line-321"></a>
<a name="line-322"></a><a name="ioeGetVerbatim"></a><span class='hs-comment'>-- | Check if an 'IOError' should be output verbatim to screen.</span>
<a name="line-323"></a><span class='hs-definition'>ioeGetVerbatim</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IOError</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-324"></a><span class='hs-definition'>ioeGetVerbatim</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioeGetLocation</span> <span class='hs-varid'>e</span> <span class='hs-varop'>==</span> <span class='hs-str'>"dieVerbatim"</span>
<a name="line-325"></a>
<a name="line-326"></a><a name="verbatimUserError"></a><span class='hs-comment'>-- | Create a 'userError' whose error text will be output verbatim</span>
<a name="line-327"></a><span class='hs-definition'>verbatimUserError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOError</span>
<a name="line-328"></a><span class='hs-definition'>verbatimUserError</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioeSetVerbatim</span> <span class='hs-varop'>.</span> <span class='hs-varid'>userError</span>
<a name="line-329"></a>
<a name="line-330"></a><a name="dieWithLocation'"></a><span class='hs-definition'>dieWithLocation'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-331"></a><span class='hs-definition'>dieWithLocation'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>filename</span> <span class='hs-varid'>mb_lineno</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-332"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-333"></a>    <span class='hs-varid'>pname</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProgName</span>
<a name="line-334"></a>    <span class='hs-varid'>ioError</span> <span class='hs-varop'>.</span> <span class='hs-varid'>verbatimUserError</span>
<a name="line-335"></a>            <span class='hs-varop'>.</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>AlwaysMark</span> <span class='hs-conid'>VerboseTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-336"></a>            <span class='hs-varop'>.</span> <span class='hs-varid'>wrapTextVerbosity</span> <span class='hs-varid'>verbosity</span>
<a name="line-337"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>pname</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span> <span class='hs-varop'>++</span>
<a name="line-338"></a>              <span class='hs-varid'>filename</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>mb_lineno</span> <span class='hs-keyword'>of</span>
<a name="line-339"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>lineno</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>":"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>lineno</span>
<a name="line-340"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-341"></a>              <span class='hs-str'>": "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>msg</span>
<a name="line-342"></a>
<a name="line-343"></a><a name="die'"></a><span class='hs-definition'>die'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-344"></a><span class='hs-definition'>die'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-345"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-346"></a>    <span class='hs-varid'>pname</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProgName</span>
<a name="line-347"></a>    <span class='hs-varid'>ioError</span> <span class='hs-varop'>.</span> <span class='hs-varid'>verbatimUserError</span>
<a name="line-348"></a>            <span class='hs-varop'>.</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>AlwaysMark</span> <span class='hs-conid'>VerboseTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-349"></a>            <span class='hs-varop'>.</span> <span class='hs-varid'>wrapTextVerbosity</span> <span class='hs-varid'>verbosity</span>
<a name="line-350"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>pname</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>msg</span>
<a name="line-351"></a>
<a name="line-352"></a><a name="dieNoWrap"></a><span class='hs-definition'>dieNoWrap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-353"></a><span class='hs-definition'>dieNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-354"></a>    <span class='hs-comment'>-- TODO: should this have program name or not?</span>
<a name="line-355"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-356"></a>    <span class='hs-varid'>ioError</span> <span class='hs-varop'>.</span> <span class='hs-varid'>verbatimUserError</span>
<a name="line-357"></a>            <span class='hs-varop'>.</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>AlwaysMark</span> <span class='hs-conid'>VerboseTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-358"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-359"></a>
<a name="line-360"></a><a name="annotateIO"></a><span class='hs-comment'>-- | Given a block of IO code that may raise an exception, annotate</span>
<a name="line-361"></a><span class='hs-comment'>-- it with the metadata from the current scope.  Use this as close</span>
<a name="line-362"></a><span class='hs-comment'>-- to external code that raises IO exceptions as possible, since</span>
<a name="line-363"></a><span class='hs-comment'>-- this function unconditionally wraps the error message with a trace</span>
<a name="line-364"></a><span class='hs-comment'>-- (so it is NOT idempotent.)</span>
<a name="line-365"></a><span class='hs-definition'>annotateIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-366"></a><span class='hs-definition'>annotateIO</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-367"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-368"></a>    <span class='hs-varid'>modifyIOError</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>ts</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span>
<a name="line-369"></a>  <span class='hs-keyword'>where</span>
<a name="line-370"></a>    <span class='hs-varid'>f</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioeSetErrorString</span> <span class='hs-varid'>ioe</span>
<a name="line-371"></a>             <span class='hs-varop'>.</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NeverMark</span> <span class='hs-conid'>VerboseTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-372"></a>             <span class='hs-varop'>$</span> <span class='hs-varid'>ioeGetErrorString</span> <span class='hs-varid'>ioe</span>
<a name="line-373"></a>
<a name="line-374"></a>
<a name="line-375"></a><a name="topHandlerWith"></a><span class='hs-comment'>{-# NOINLINE topHandlerWith #-}</span>
<a name="line-376"></a><span class='hs-definition'>topHandlerWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exception.SomeException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-377"></a><span class='hs-definition'>topHandlerWith</span> <span class='hs-varid'>cont</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-378"></a>    <span class='hs-comment'>-- By default, stderr to a terminal device is NoBuffering. But this</span>
<a name="line-379"></a>    <span class='hs-comment'>-- is *really slow*</span>
<a name="line-380"></a>    <span class='hs-varid'>hSetBuffering</span> <span class='hs-varid'>stderr</span> <span class='hs-conid'>LineBuffering</span>
<a name="line-381"></a>    <span class='hs-conid'>Exception.catches</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>[</span>
<a name="line-382"></a>        <span class='hs-conid'>Exception.Handler</span> <span class='hs-varid'>rethrowAsyncExceptions</span>
<a name="line-383"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Exception.Handler</span> <span class='hs-varid'>rethrowExitStatus</span>
<a name="line-384"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Exception.Handler</span> <span class='hs-varid'>handle</span>
<a name="line-385"></a>      <span class='hs-keyglyph'>]</span>
<a name="line-386"></a>  <span class='hs-keyword'>where</span>
<a name="line-387"></a>    <span class='hs-comment'>-- Let async exceptions rise to the top for the default top-handler</span>
<a name="line-388"></a>    <span class='hs-varid'>rethrowAsyncExceptions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exception.AsyncException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-389"></a>    <span class='hs-varid'>rethrowAsyncExceptions</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwIO</span> <span class='hs-varid'>a</span>
<a name="line-390"></a>
<a name="line-391"></a>    <span class='hs-comment'>-- ExitCode gets thrown asynchronously too, and we don't want to print it</span>
<a name="line-392"></a>    <span class='hs-varid'>rethrowExitStatus</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExitCode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-393"></a>    <span class='hs-varid'>rethrowExitStatus</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwIO</span>
<a name="line-394"></a>
<a name="line-395"></a>    <span class='hs-comment'>-- Print all other exceptions</span>
<a name="line-396"></a>    <span class='hs-varid'>handle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exception.SomeException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-397"></a>    <span class='hs-varid'>handle</span> <span class='hs-varid'>se</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-398"></a>      <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-399"></a>      <span class='hs-varid'>pname</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getProgName</span>
<a name="line-400"></a>      <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>stderr</span> <span class='hs-layout'>(</span><span class='hs-varid'>message</span> <span class='hs-varid'>pname</span> <span class='hs-varid'>se</span><span class='hs-layout'>)</span>
<a name="line-401"></a>      <span class='hs-varid'>cont</span> <span class='hs-varid'>se</span>
<a name="line-402"></a>
<a name="line-403"></a>    <span class='hs-varid'>message</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Exception.SomeException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-404"></a>    <span class='hs-varid'>message</span> <span class='hs-varid'>pname</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exception.SomeException</span> <span class='hs-varid'>se</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-405"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>cast</span> <span class='hs-varid'>se</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Exception.IOException</span> <span class='hs-keyword'>of</span>
<a name="line-406"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>ioe</span>
<a name="line-407"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ioeGetVerbatim</span> <span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-408"></a>            <span class='hs-comment'>-- Use the message verbatim</span>
<a name="line-409"></a>            <span class='hs-varid'>ioeGetErrorString</span> <span class='hs-varid'>ioe</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n"</span>
<a name="line-410"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isUserError</span> <span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-411"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>file</span>         <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ioeGetFileName</span> <span class='hs-varid'>ioe</span> <span class='hs-keyword'>of</span>
<a name="line-412"></a>                               <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<a name="line-413"></a>                               <span class='hs-conid'>Just</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-varid'>location</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span>
<a name="line-414"></a>              <span class='hs-varid'>location</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ioeGetLocation</span> <span class='hs-varid'>ioe</span> <span class='hs-keyword'>of</span>
<a name="line-415"></a>                               <span class='hs-varid'>l</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDigit</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-chr'>':'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>l</span>
<a name="line-416"></a>                               <span class='hs-keyword'>_</span>                        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<a name="line-417"></a>              <span class='hs-varid'>detail</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioeGetErrorString</span> <span class='hs-varid'>ioe</span>
<a name="line-418"></a>          <span class='hs-keyword'>in</span> <span class='hs-varid'>wrapText</span> <span class='hs-layout'>(</span><span class='hs-varid'>pname</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>file</span> <span class='hs-varop'>++</span> <span class='hs-varid'>detail</span><span class='hs-layout'>)</span>
<a name="line-419"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-420"></a>          <span class='hs-varid'>displaySomeException</span> <span class='hs-varid'>se</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n"</span>
<a name="line-421"></a>
<a name="line-422"></a><a name="displaySomeException"></a><span class='hs-comment'>-- | BC wrapper around 'Exception.displayException'.</span>
<a name="line-423"></a><span class='hs-definition'>displaySomeException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exception.Exception</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-424"></a><span class='hs-definition'>displaySomeException</span> <span class='hs-varid'>se</span> <span class='hs-keyglyph'>=</span>
<a name="line-425"></a><span class='hs-cpp'>#if __GLASGOW_HASKELL__ &lt; 710</span>
<a name="line-426"></a>    <span class='hs-varid'>show</span> <span class='hs-varid'>se</span>
<a name="line-427"></a><span class='hs-cpp'>#else</span>
<a name="line-428"></a>    <span class='hs-conid'>Exception.displayException</span> <span class='hs-varid'>se</span>
<a name="line-429"></a><span class='hs-cpp'>#endif</span>
<a name="line-430"></a>
<a name="line-431"></a><a name="topHandler"></a><span class='hs-definition'>topHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-432"></a><span class='hs-definition'>topHandler</span> <span class='hs-varid'>prog</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topHandlerWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>exitWith</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitFailure</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>prog</span>
<a name="line-433"></a>
<a name="line-434"></a><a name="verbosityHandle"></a><span class='hs-definition'>verbosityHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span>
<a name="line-435"></a><span class='hs-definition'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-436"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVerboseStderr</span> <span class='hs-varid'>verbosity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stderr</span>
<a name="line-437"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stdout</span>
<a name="line-438"></a>
<a name="line-439"></a><a name="warn"></a><span class='hs-comment'>-- | Non fatal conditions that may be indicative of an error or problem.</span>
<a name="line-440"></a><span class='hs-comment'>--</span>
<a name="line-441"></a><span class='hs-comment'>-- We display these at the 'normal' verbosity level.</span>
<a name="line-442"></a><span class='hs-comment'>--</span>
<a name="line-443"></a><span class='hs-definition'>warn</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-444"></a><span class='hs-definition'>warn</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-445"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>normal</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-446"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-447"></a>    <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-448"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>stderr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NormalMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-449"></a>                   <span class='hs-varop'>.</span> <span class='hs-varid'>wrapTextVerbosity</span> <span class='hs-varid'>verbosity</span>
<a name="line-450"></a>                   <span class='hs-varop'>$</span> <span class='hs-str'>"Warning: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>msg</span>
<a name="line-451"></a>
<a name="line-452"></a><a name="notice"></a><span class='hs-comment'>-- | Useful status messages.</span>
<a name="line-453"></a><span class='hs-comment'>--</span>
<a name="line-454"></a><span class='hs-comment'>-- We display these at the 'normal' verbosity level.</span>
<a name="line-455"></a><span class='hs-comment'>--</span>
<a name="line-456"></a><span class='hs-comment'>-- This is for the ordinary helpful status messages that users see. Just</span>
<a name="line-457"></a><span class='hs-comment'>-- enough information to know that things are working but not floods of detail.</span>
<a name="line-458"></a><span class='hs-comment'>--</span>
<a name="line-459"></a><span class='hs-definition'>notice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-460"></a><span class='hs-definition'>notice</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-461"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>normal</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-462"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-463"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-464"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span>
<a name="line-465"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NormalMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-466"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>wrapTextVerbosity</span> <span class='hs-varid'>verbosity</span>
<a name="line-467"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-468"></a>
<a name="line-469"></a><a name="noticeNoWrap"></a><span class='hs-comment'>-- | Display a message at 'normal' verbosity level, but without</span>
<a name="line-470"></a><span class='hs-comment'>-- wrapping.</span>
<a name="line-471"></a><span class='hs-comment'>--</span>
<a name="line-472"></a><span class='hs-definition'>noticeNoWrap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-473"></a><span class='hs-definition'>noticeNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-474"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>normal</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-475"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-476"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-477"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span> <span class='hs-varop'>.</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NormalMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-478"></a>
<a name="line-479"></a><a name="noticeDoc"></a><span class='hs-comment'>-- | Pretty-print a 'Disp.Doc' status message at 'normal' verbosity</span>
<a name="line-480"></a><span class='hs-comment'>-- level.  Use this if you need fancy formatting.</span>
<a name="line-481"></a><span class='hs-comment'>--</span>
<a name="line-482"></a><span class='hs-definition'>noticeDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Disp.Doc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-483"></a><span class='hs-definition'>noticeDoc</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-484"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>normal</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-485"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-486"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-487"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span>
<a name="line-488"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NormalMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-489"></a>        <span class='hs-varop'>$</span> <span class='hs-conid'>Disp.renderStyle</span> <span class='hs-varid'>defaultStyle</span>
<a name="line-490"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-491"></a>
<a name="line-492"></a><a name="setupMessage"></a><span class='hs-comment'>-- | Display a "setup status message".  Prefer using setupMessage'</span>
<a name="line-493"></a><span class='hs-comment'>-- if possible.</span>
<a name="line-494"></a><span class='hs-comment'>--</span>
<a name="line-495"></a><span class='hs-definition'>setupMessage</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PackageIdentifier</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-496"></a><span class='hs-definition'>setupMessage</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>pkgid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-497"></a>    <span class='hs-varid'>noticeNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>++</span> <span class='hs-chr'>' '</span><span class='hs-conop'>:</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>pkgid</span> <span class='hs-varop'>++</span> <span class='hs-str'>"..."</span><span class='hs-layout'>)</span>
<a name="line-498"></a>
<a name="line-499"></a><a name="info"></a><span class='hs-comment'>-- | More detail on the operation of some action.</span>
<a name="line-500"></a><span class='hs-comment'>--</span>
<a name="line-501"></a><span class='hs-comment'>-- We display these messages when the verbosity level is 'verbose'</span>
<a name="line-502"></a><span class='hs-comment'>--</span>
<a name="line-503"></a><span class='hs-definition'>info</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-504"></a><span class='hs-definition'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-505"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>verbose</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-506"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-507"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-508"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span>
<a name="line-509"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NeverMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-510"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>wrapTextVerbosity</span> <span class='hs-varid'>verbosity</span>
<a name="line-511"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-512"></a>
<a name="line-513"></a><a name="infoNoWrap"></a><span class='hs-definition'>infoNoWrap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-514"></a><span class='hs-definition'>infoNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-515"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>verbose</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-516"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-517"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-518"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span>
<a name="line-519"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NeverMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-520"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-521"></a>
<a name="line-522"></a><a name="debug"></a><span class='hs-comment'>-- | Detailed internal debugging information</span>
<a name="line-523"></a><span class='hs-comment'>--</span>
<a name="line-524"></a><span class='hs-comment'>-- We display these messages when the verbosity level is 'deafening'</span>
<a name="line-525"></a><span class='hs-comment'>--</span>
<a name="line-526"></a><span class='hs-definition'>debug</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-527"></a><span class='hs-definition'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-528"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>deafening</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-529"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-530"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-531"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span> <span class='hs-varop'>$</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NeverMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-532"></a>              <span class='hs-varop'>$</span> <span class='hs-varid'>wrapTextVerbosity</span> <span class='hs-varid'>verbosity</span>
<a name="line-533"></a>              <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-534"></a>    <span class='hs-comment'>-- ensure that we don't lose output if we segfault/infinite loop</span>
<a name="line-535"></a>    <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-536"></a>
<a name="line-537"></a><a name="debugNoWrap"></a><span class='hs-comment'>-- | A variant of 'debug' that doesn't perform the automatic line</span>
<a name="line-538"></a><span class='hs-comment'>-- wrapping. Produces better output in some cases.</span>
<a name="line-539"></a><span class='hs-definition'>debugNoWrap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-540"></a><span class='hs-definition'>debugNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-541"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbosity</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>deafening</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-542"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbosityHandle</span> <span class='hs-varid'>verbosity</span>
<a name="line-543"></a>    <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPOSIXTime</span>
<a name="line-544"></a>    <span class='hs-varid'>hPutStr</span> <span class='hs-varid'>h</span>
<a name="line-545"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-conid'>NeverMark</span> <span class='hs-conid'>FlagTrace</span> <span class='hs-varid'>verbosity</span>
<a name="line-546"></a>        <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span>
<a name="line-547"></a>    <span class='hs-comment'>-- ensure that we don't lose output if we segfault/infinite loop</span>
<a name="line-548"></a>    <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="chattyTry"></a><span class='hs-comment'>-- | Perform an IO action, catching any IO exceptions and printing an error</span>
<a name="line-551"></a><span class='hs-comment'>--   if one occurs.</span>
<a name="line-552"></a><span class='hs-definition'>chattyTry</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>  <span class='hs-comment'>-- ^ a description of the action we were attempting</span>
<a name="line-553"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>   <span class='hs-comment'>-- ^ the action itself</span>
<a name="line-554"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-555"></a><span class='hs-definition'>chattyTry</span> <span class='hs-varid'>desc</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span>
<a name="line-556"></a>  <span class='hs-varid'>catchIO</span> <span class='hs-varid'>action</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>exception</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-557"></a>    <span class='hs-varid'>hPutStrLn</span> <span class='hs-varid'>stderr</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Error while "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>desc</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>exception</span>
<a name="line-558"></a>
<a name="line-559"></a><a name="handleDoesNotExist"></a><span class='hs-comment'>-- | Run an IO computation, returning @e@ if it raises a "file</span>
<a name="line-560"></a><span class='hs-comment'>-- does not exist" error.</span>
<a name="line-561"></a><span class='hs-definition'>handleDoesNotExist</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-562"></a><span class='hs-definition'>handleDoesNotExist</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span>
<a name="line-563"></a>    <span class='hs-conid'>Exception.handleJust</span>
<a name="line-564"></a>      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>ioe</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ioe</span> <span class='hs-keyword'>else</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-565"></a>      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-566"></a>
<a name="line-567"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-568"></a><span class='hs-comment'>-- Helper functions</span>
<a name="line-569"></a>
<a name="line-570"></a><a name="wrapTextVerbosity"></a><span class='hs-comment'>-- | Wraps text unless the @+nowrap@ verbosity flag is active</span>
<a name="line-571"></a><span class='hs-definition'>wrapTextVerbosity</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-572"></a><span class='hs-definition'>wrapTextVerbosity</span> <span class='hs-varid'>verb</span>
<a name="line-573"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVerboseNoWrap</span> <span class='hs-varid'>verb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withTrailingNewline</span>
<a name="line-574"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withTrailingNewline</span> <span class='hs-varop'>.</span> <span class='hs-varid'>wrapText</span>
<a name="line-575"></a>
<a name="line-576"></a>
<a name="line-577"></a><a name="withTimestamp"></a><span class='hs-comment'>-- | Prepends a timestamp if @+timestamp@ verbosity flag is set</span>
<a name="line-578"></a><span class='hs-comment'>--</span>
<a name="line-579"></a><span class='hs-comment'>-- This is used by 'withMetadata'</span>
<a name="line-580"></a><span class='hs-comment'>--</span>
<a name="line-581"></a><span class='hs-definition'>withTimestamp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>POSIXTime</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-582"></a><span class='hs-definition'>withTimestamp</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>msg</span>
<a name="line-583"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVerboseTimestamp</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg'</span>
<a name="line-584"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-comment'>-- no-op</span>
<a name="line-585"></a>  <span class='hs-keyword'>where</span>
<a name="line-586"></a>    <span class='hs-varid'>msg'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lines</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-587"></a>      <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tsstr</span> <span class='hs-str'>"\n"</span>
<a name="line-588"></a>      <span class='hs-varid'>l1</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unlines</span> <span class='hs-layout'>(</span><span class='hs-varid'>tsstr</span> <span class='hs-layout'>(</span><span class='hs-chr'>' '</span><span class='hs-conop'>:</span><span class='hs-varid'>l1</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>contpfx</span><span class='hs-varop'>++</span><span class='hs-layout'>)</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-589"></a>
<a name="line-590"></a>    <span class='hs-comment'>-- format timestamp to be prepended to first line with msec precision</span>
<a name="line-591"></a>    <span class='hs-varid'>tsstr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showFFloat</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-num'>3</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>realToFrac</span> <span class='hs-varid'>ts</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Double</span><span class='hs-layout'>)</span>
<a name="line-592"></a>
<a name="line-593"></a>    <span class='hs-comment'>-- continuation prefix for subsequent lines of msg</span>
<a name="line-594"></a>    <span class='hs-varid'>contpfx</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-layout'>(</span><span class='hs-varid'>tsstr</span> <span class='hs-str'>" "</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-chr'>' '</span>
<a name="line-595"></a>
<a name="line-596"></a><a name="withOutputMarker"></a><span class='hs-comment'>-- | Wrap output with a marker if @+markoutput@ verbosity flag is set.</span>
<a name="line-597"></a><span class='hs-comment'>--</span>
<a name="line-598"></a><span class='hs-comment'>-- NB: Why is markoutput done with start/end markers, and not prefixes?</span>
<a name="line-599"></a><span class='hs-comment'>-- Markers are more convenient to add (if we want to add prefixes,</span>
<a name="line-600"></a><span class='hs-comment'>-- we have to 'lines' and then 'map'; here's it's just some</span>
<a name="line-601"></a><span class='hs-comment'>-- concatenates).  Note that even in the prefix case, we can't</span>
<a name="line-602"></a><span class='hs-comment'>-- guarantee that the markers are unambiguous, because some of</span>
<a name="line-603"></a><span class='hs-comment'>-- Cabal's output comes straight from external programs, where</span>
<a name="line-604"></a><span class='hs-comment'>-- we don't have the ability to interpose on the output.</span>
<a name="line-605"></a><span class='hs-comment'>--</span>
<a name="line-606"></a><span class='hs-comment'>-- This is used by 'withMetadata'</span>
<a name="line-607"></a><span class='hs-comment'>--</span>
<a name="line-608"></a><span class='hs-definition'>withOutputMarker</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-609"></a><span class='hs-definition'>withOutputMarker</span> <span class='hs-varid'>v</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isVerboseMarkOutput</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xs</span>
<a name="line-610"></a><span class='hs-definition'>withOutputMarker</span> <span class='hs-keyword'>_</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>""</span> <span class='hs-comment'>-- Minor optimization, don't mark uselessly</span>
<a name="line-611"></a><span class='hs-definition'>withOutputMarker</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span>
<a name="line-612"></a>    <span class='hs-str'>"-----BEGIN CABAL OUTPUT-----\n"</span> <span class='hs-varop'>++</span>
<a name="line-613"></a>    <span class='hs-varid'>withTrailingNewline</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>++</span>
<a name="line-614"></a>    <span class='hs-str'>"-----END CABAL OUTPUT-----\n"</span>
<a name="line-615"></a>
<a name="line-616"></a><a name="withTrailingNewline"></a><span class='hs-comment'>-- | Append a trailing newline to a string if it does not</span>
<a name="line-617"></a><span class='hs-comment'>-- already have a trailing newline.</span>
<a name="line-618"></a><span class='hs-comment'>--</span>
<a name="line-619"></a><span class='hs-definition'>withTrailingNewline</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-620"></a><span class='hs-definition'>withTrailingNewline</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>""</span>
<a name="line-621"></a><span class='hs-definition'>withTrailingNewline</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>x</span> <span class='hs-varid'>xs</span>
<a name="line-622"></a>  <span class='hs-keyword'>where</span>
<a name="line-623"></a>    <span class='hs-varid'>go</span>   <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-conop'>:</span><span class='hs-varid'>cs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>c</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>c</span> <span class='hs-varid'>cs</span>
<a name="line-624"></a>    <span class='hs-varid'>go</span> <span class='hs-chr'>'\n'</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>""</span>
<a name="line-625"></a>    <span class='hs-varid'>go</span>   <span class='hs-keyword'>_</span>  <span class='hs-str'>""</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"\n"</span>
<a name="line-626"></a>
<a name="line-627"></a><a name="withCallStackPrefix"></a><span class='hs-comment'>-- | Prepend a call-site and/or call-stack based on Verbosity</span>
<a name="line-628"></a><span class='hs-comment'>--</span>
<a name="line-629"></a><span class='hs-definition'>withCallStackPrefix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WithCallStack</span> <span class='hs-layout'>(</span><span class='hs-conid'>TraceWhen</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-630"></a><span class='hs-definition'>withCallStackPrefix</span> <span class='hs-varid'>tracer</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-631"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isVerboseCallSite</span> <span class='hs-varid'>verbosity</span>
<a name="line-632"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>parentSrcLocPrefix</span> <span class='hs-varop'>++</span>
<a name="line-633"></a>             <span class='hs-comment'>-- Hack: need a newline before starting output marker :(</span>
<a name="line-634"></a>             <span class='hs-keyword'>if</span> <span class='hs-varid'>isVerboseMarkOutput</span> <span class='hs-varid'>verbosity</span>
<a name="line-635"></a>                <span class='hs-keyword'>then</span> <span class='hs-str'>"\n"</span>
<a name="line-636"></a>                <span class='hs-keyword'>else</span> <span class='hs-str'>""</span>
<a name="line-637"></a>        <span class='hs-keyword'>else</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-638"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>traceWhen</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>tracer</span> <span class='hs-keyword'>of</span>
<a name="line-639"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>pre</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pre</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prettyCallStack</span> <span class='hs-varid'>callStack</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n"</span>
<a name="line-640"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-641"></a>    <span class='hs-varid'>s</span>
<a name="line-642"></a>
<a name="line-643"></a><a name="TraceWhen"></a><span class='hs-comment'>-- | When should we emit the call stack?  We always emit</span>
<a name="line-644"></a><a name="TraceWhen"></a><span class='hs-comment'>-- for internal errors, emit the trace for errors when we</span>
<a name="line-645"></a><a name="TraceWhen"></a><span class='hs-comment'>-- are in verbose mode, and otherwise only emit it if</span>
<a name="line-646"></a><a name="TraceWhen"></a><span class='hs-comment'>-- explicitly asked for using the @+callstack@ verbosity</span>
<a name="line-647"></a><a name="TraceWhen"></a><span class='hs-comment'>-- flag.  (At the moment, 'AlwaysTrace' is not used.</span>
<a name="line-648"></a><a name="TraceWhen"></a><span class='hs-comment'>--</span>
<a name="line-649"></a><a name="TraceWhen"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TraceWhen</span>
<a name="line-650"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AlwaysTrace</span>
<a name="line-651"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>VerboseTrace</span>
<a name="line-652"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-conid'>FlagTrace</span>
<a name="line-653"></a>    <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-654"></a>
<a name="line-655"></a><a name="traceWhen"></a><span class='hs-comment'>-- | Determine if we should emit a call stack.</span>
<a name="line-656"></a><span class='hs-comment'>-- If we trace, it also emits any prefix we should append.</span>
<a name="line-657"></a><span class='hs-definition'>traceWhen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TraceWhen</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>String</span>
<a name="line-658"></a><span class='hs-definition'>traceWhen</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>AlwaysTrace</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-str'>""</span>
<a name="line-659"></a><span class='hs-definition'>traceWhen</span> <span class='hs-varid'>v</span> <span class='hs-conid'>VerboseTrace</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>verbose</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-str'>""</span>
<a name="line-660"></a><span class='hs-definition'>traceWhen</span> <span class='hs-varid'>v</span> <span class='hs-conid'>FlagTrace</span>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isVerboseCallStack</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-str'>"----\n"</span>
<a name="line-661"></a><span class='hs-definition'>traceWhen</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-662"></a>
<a name="line-663"></a><a name="MarkWhen"></a><span class='hs-comment'>-- | When should we output the marker?  Things like 'die'</span>
<a name="line-664"></a><a name="MarkWhen"></a><span class='hs-comment'>-- always get marked, but a 'NormalMark' will only be</span>
<a name="line-665"></a><a name="MarkWhen"></a><span class='hs-comment'>-- output if we're not a quiet verbosity.</span>
<a name="line-666"></a><a name="MarkWhen"></a><span class='hs-comment'>--</span>
<a name="line-667"></a><a name="MarkWhen"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MarkWhen</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AlwaysMark</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NormalMark</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NeverMark</span>
<a name="line-668"></a>
<a name="line-669"></a><a name="withMetadata"></a><span class='hs-comment'>-- | Add all necessary metadata to a logging message</span>
<a name="line-670"></a><span class='hs-comment'>--</span>
<a name="line-671"></a><span class='hs-definition'>withMetadata</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WithCallStack</span> <span class='hs-layout'>(</span><span class='hs-conid'>POSIXTime</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MarkWhen</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TraceWhen</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-672"></a><span class='hs-definition'>withMetadata</span> <span class='hs-varid'>ts</span> <span class='hs-varid'>marker</span> <span class='hs-varid'>tracer</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-673"></a>    <span class='hs-comment'>-- NB: order matters.  Output marker first because we</span>
<a name="line-674"></a>    <span class='hs-comment'>-- don't want to capture call stacks.</span>
<a name="line-675"></a>      <span class='hs-varid'>withTrailingNewline</span>
<a name="line-676"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withCallStackPrefix</span> <span class='hs-varid'>tracer</span> <span class='hs-varid'>verbosity</span>
<a name="line-677"></a>    <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>marker</span> <span class='hs-keyword'>of</span>
<a name="line-678"></a>        <span class='hs-conid'>AlwaysMark</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withOutputMarker</span> <span class='hs-varid'>verbosity</span>
<a name="line-679"></a>        <span class='hs-conid'>NormalMark</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isVerboseQuiet</span> <span class='hs-varid'>verbosity</span><span class='hs-layout'>)</span>
<a name="line-680"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withOutputMarker</span> <span class='hs-varid'>verbosity</span>
<a name="line-681"></a>                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-682"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span>
<a name="line-683"></a>        <span class='hs-conid'>NeverMark</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-684"></a>    <span class='hs-comment'>-- Clear out any existing markers</span>
<a name="line-685"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>clearMarkers</span>
<a name="line-686"></a>    <span class='hs-varop'>.</span> <span class='hs-varid'>withTimestamp</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>ts</span>
<a name="line-687"></a>    <span class='hs-varop'>$</span> <span class='hs-varid'>x</span>
<a name="line-688"></a>
<a name="line-689"></a><a name="clearMarkers"></a><span class='hs-definition'>clearMarkers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-690"></a><span class='hs-definition'>clearMarkers</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unlines</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isMarker</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lines</span> <span class='hs-varid'>s</span>
<a name="line-691"></a>  <span class='hs-keyword'>where</span>
<a name="line-692"></a>    <span class='hs-varid'>isMarker</span> <span class='hs-str'>"-----BEGIN CABAL OUTPUT-----"</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-693"></a>    <span class='hs-varid'>isMarker</span> <span class='hs-str'>"-----END CABAL OUTPUT-----"</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-694"></a>    <span class='hs-varid'>isMarker</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-695"></a>
<a name="line-696"></a><a name="maybeExit"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-697"></a><span class='hs-comment'>-- rawSystem variants</span>
<a name="line-698"></a><span class='hs-definition'>maybeExit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExitCode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-699"></a><span class='hs-definition'>maybeExit</span> <span class='hs-varid'>cmd</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-700"></a>  <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cmd</span>
<a name="line-701"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>res</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>exitWith</span> <span class='hs-varid'>res</span>
<a name="line-702"></a>
<a name="line-703"></a>
<a name="line-704"></a>
<a name="line-705"></a><a name="printRawCommandAndArgs"></a><span class='hs-definition'>printRawCommandAndArgs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-706"></a><span class='hs-definition'>printRawCommandAndArgs</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-707"></a>    <span class='hs-varid'>printRawCommandAndArgsAndEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span>
<a name="line-708"></a>
<a name="line-709"></a><a name="printRawCommandAndArgsAndEnv"></a><span class='hs-definition'>printRawCommandAndArgsAndEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-710"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-711"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-712"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>
<a name="line-713"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-714"></a>                             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-715"></a><span class='hs-definition'>printRawCommandAndArgsAndEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-716"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>menv</span> <span class='hs-keyword'>of</span>
<a name="line-717"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>debugNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"Environment: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-718"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-719"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mcwd</span> <span class='hs-keyword'>of</span>
<a name="line-720"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>cwd</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>debugNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"Working directory: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>cwd</span><span class='hs-layout'>)</span>
<a name="line-721"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-722"></a>    <span class='hs-varid'>infoNoWrap</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-varid'>showCommandForUser</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="rawSystemExit"></a><span class='hs-comment'>-- Exit with the same exit code if the subcommand fails</span>
<a name="line-725"></a><span class='hs-definition'>rawSystemExit</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-726"></a><span class='hs-definition'>rawSystemExit</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-727"></a>  <span class='hs-varid'>printRawCommandAndArgs</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span>
<a name="line-728"></a>  <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-729"></a>  <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rawSystem</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span>
<a name="line-730"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitcode</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-731"></a>    <span class='hs-varid'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>" returned "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>exitcode</span>
<a name="line-732"></a>    <span class='hs-varid'>exitWith</span> <span class='hs-varid'>exitcode</span>
<a name="line-733"></a>
<a name="line-734"></a><a name="rawSystemExitCode"></a><span class='hs-definition'>rawSystemExitCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExitCode</span>
<a name="line-735"></a><span class='hs-definition'>rawSystemExitCode</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-736"></a>  <span class='hs-varid'>printRawCommandAndArgs</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span>
<a name="line-737"></a>  <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-738"></a>  <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rawSystem</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span>
<a name="line-739"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitcode</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-740"></a>    <span class='hs-varid'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>" returned "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>exitcode</span>
<a name="line-741"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>exitcode</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="rawSystemExitWithEnv"></a><span class='hs-definition'>rawSystemExitWithEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-744"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-745"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-746"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-747"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-748"></a><span class='hs-definition'>rawSystemExitWithEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-749"></a>    <span class='hs-varid'>printRawCommandAndArgsAndEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-750"></a>    <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-751"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createProcess</span> <span class='hs-varop'>$</span>
<a name="line-752"></a>                  <span class='hs-layout'>(</span><span class='hs-conid'>Process.proc</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-conid'>Process.env</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-753"></a><span class='hs-cpp'>#ifdef MIN_VERSION_process</span>
<a name="line-754"></a><span class='hs-cpp'>#if MIN_VERSION_process(1,2,0)</span>
<a name="line-755"></a><span class='hs-comment'>-- delegate_ctlc has been added in process 1.2, and we still want to be able to</span>
<a name="line-756"></a><span class='hs-comment'>-- bootstrap GHC on systems not having that version</span>
<a name="line-757"></a>                                           <span class='hs-layout'>,</span> <span class='hs-conid'>Process.delegate_ctlc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-758"></a><span class='hs-cpp'>#endif</span>
<a name="line-759"></a><span class='hs-cpp'>#endif</span>
<a name="line-760"></a>                                           <span class='hs-layout'>}</span>
<a name="line-761"></a>    <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitForProcess</span> <span class='hs-varid'>ph</span>
<a name="line-762"></a>    <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitcode</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-763"></a>        <span class='hs-varid'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>" returned "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>exitcode</span>
<a name="line-764"></a>        <span class='hs-varid'>exitWith</span> <span class='hs-varid'>exitcode</span>
<a name="line-765"></a>
<a name="line-766"></a><a name="rawSystemIOWithEnv"></a><span class='hs-comment'>-- Closes the passed in handles before returning.</span>
<a name="line-767"></a><span class='hs-definition'>rawSystemIOWithEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-768"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-769"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-770"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^ New working dir or inherit</span>
<a name="line-771"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ New environment or inherit</span>
<a name="line-772"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span>  <span class='hs-comment'>-- ^ stdin</span>
<a name="line-773"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span>  <span class='hs-comment'>-- ^ stdout</span>
<a name="line-774"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span>  <span class='hs-comment'>-- ^ stderr</span>
<a name="line-775"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExitCode</span>
<a name="line-776"></a><span class='hs-definition'>rawSystemIOWithEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>inp</span> <span class='hs-varid'>out</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-777"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createProcessWithEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span>
<a name="line-778"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>mbToStd</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mbToStd</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mbToStd</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-779"></a>    <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitForProcess</span> <span class='hs-varid'>ph</span>
<a name="line-780"></a>    <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitcode</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-781"></a>      <span class='hs-varid'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>" returned "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>exitcode</span>
<a name="line-782"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>exitcode</span>
<a name="line-783"></a>  <span class='hs-keyword'>where</span>
<a name="line-784"></a>    <span class='hs-varid'>mbToStd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Process.StdStream</span>
<a name="line-785"></a>    <span class='hs-varid'>mbToStd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>Process.Inherit</span> <span class='hs-conid'>Process.UseHandle</span>
<a name="line-786"></a>
<a name="line-787"></a><a name="rawSystemIOWithEnvAndAction"></a><span class='hs-definition'>rawSystemIOWithEnvAndAction</span>
<a name="line-788"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-789"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-790"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-791"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^ New working dir or inherit</span>
<a name="line-792"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ New environment or inherit</span>
<a name="line-793"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>          <span class='hs-comment'>-- ^ action to perform after process is created, but before 'waitForProcess'.</span>
<a name="line-794"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span>  <span class='hs-comment'>-- ^ stdin</span>
<a name="line-795"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span>  <span class='hs-comment'>-- ^ stdout</span>
<a name="line-796"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span>  <span class='hs-comment'>-- ^ stderr</span>
<a name="line-797"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExitCode</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-798"></a><span class='hs-definition'>rawSystemIOWithEnvAndAction</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>action</span> <span class='hs-varid'>inp</span> <span class='hs-varid'>out</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-799"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>ph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createProcessWithEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span>
<a name="line-800"></a>                                       <span class='hs-layout'>(</span><span class='hs-varid'>mbToStd</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mbToStd</span> <span class='hs-varid'>out</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mbToStd</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-801"></a>    <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>action</span>
<a name="line-802"></a>    <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitForProcess</span> <span class='hs-varid'>ph</span>
<a name="line-803"></a>    <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitcode</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-804"></a>      <span class='hs-varid'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>" returned "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>exitcode</span>
<a name="line-805"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitcode</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-806"></a>  <span class='hs-keyword'>where</span>
<a name="line-807"></a>    <span class='hs-varid'>mbToStd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Process.StdStream</span>
<a name="line-808"></a>    <span class='hs-varid'>mbToStd</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>Process.Inherit</span> <span class='hs-conid'>Process.UseHandle</span>
<a name="line-809"></a>
<a name="line-810"></a><a name="createProcessWithEnv"></a><span class='hs-definition'>createProcessWithEnv</span> <span class='hs-keyglyph'>::</span>
<a name="line-811"></a>     <span class='hs-conid'>Verbosity</span>
<a name="line-812"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-813"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-814"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^ New working dir or inherit</span>
<a name="line-815"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ New environment or inherit</span>
<a name="line-816"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Process.StdStream</span>  <span class='hs-comment'>-- ^ stdin</span>
<a name="line-817"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Process.StdStream</span>  <span class='hs-comment'>-- ^ stdout</span>
<a name="line-818"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Process.StdStream</span>  <span class='hs-comment'>-- ^ stderr</span>
<a name="line-819"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Handle</span><span class='hs-layout'>,</span><span class='hs-conid'>ProcessHandle</span><span class='hs-layout'>)</span>
<a name="line-820"></a>  <span class='hs-comment'>-- ^ Any handles created for stdin, stdout, or stderr</span>
<a name="line-821"></a>  <span class='hs-comment'>-- with 'CreateProcess', and a handle to the process.</span>
<a name="line-822"></a><span class='hs-definition'>createProcessWithEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>inp</span> <span class='hs-varid'>out</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-823"></a>    <span class='hs-varid'>printRawCommandAndArgsAndEnv</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span>
<a name="line-824"></a>    <span class='hs-varid'>hFlush</span> <span class='hs-varid'>stdout</span>
<a name="line-825"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>inp'</span><span class='hs-layout'>,</span> <span class='hs-varid'>out'</span><span class='hs-layout'>,</span> <span class='hs-varid'>err'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ph</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createProcess</span> <span class='hs-varop'>$</span>
<a name="line-826"></a>                                <span class='hs-layout'>(</span><span class='hs-conid'>Process.proc</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span>
<a name="line-827"></a>                                    <span class='hs-conid'>Process.cwd</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mcwd</span>
<a name="line-828"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>Process.env</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>menv</span>
<a name="line-829"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>Process.std_in</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inp</span>
<a name="line-830"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>Process.std_out</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>out</span>
<a name="line-831"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>Process.std_err</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>err</span>
<a name="line-832"></a><span class='hs-cpp'>#ifdef MIN_VERSION_process</span>
<a name="line-833"></a><span class='hs-cpp'>#if MIN_VERSION_process(1,2,0)</span>
<a name="line-834"></a><span class='hs-comment'>-- delegate_ctlc has been added in process 1.2, and we still want to be able to</span>
<a name="line-835"></a><span class='hs-comment'>-- bootstrap GHC on systems not having that version</span>
<a name="line-836"></a>                                  <span class='hs-layout'>,</span> <span class='hs-conid'>Process.delegate_ctlc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-837"></a><span class='hs-cpp'>#endif</span>
<a name="line-838"></a><span class='hs-cpp'>#endif</span>
<a name="line-839"></a>                                  <span class='hs-layout'>}</span>
<a name="line-840"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>inp'</span><span class='hs-layout'>,</span> <span class='hs-varid'>out'</span><span class='hs-layout'>,</span> <span class='hs-varid'>err'</span><span class='hs-layout'>,</span> <span class='hs-varid'>ph</span><span class='hs-layout'>)</span>
<a name="line-841"></a>
<a name="line-842"></a><a name="rawSystemStdout"></a><span class='hs-comment'>-- | Run a command and return its output.</span>
<a name="line-843"></a><span class='hs-comment'>--</span>
<a name="line-844"></a><span class='hs-comment'>-- The output is assumed to be text in the locale encoding.</span>
<a name="line-845"></a><span class='hs-comment'>--</span>
<a name="line-846"></a><span class='hs-definition'>rawSystemStdout</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>mode</span><span class='hs-varop'>.</span> <span class='hs-conid'>KnownIODataMode</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>mode</span>
<a name="line-847"></a><span class='hs-definition'>rawSystemStdout</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-848"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>output</span><span class='hs-layout'>,</span> <span class='hs-varid'>errors</span><span class='hs-layout'>,</span> <span class='hs-varid'>exitCode</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rawSystemStdInOut</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span>
<a name="line-849"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOData.iodataMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IODataMode</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span>
<a name="line-850"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitCode</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-851"></a>    <span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>errors</span>
<a name="line-852"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>output</span>
<a name="line-853"></a>
<a name="line-854"></a><a name="rawSystemStdInOut"></a><span class='hs-comment'>-- | Run a command and return its output, errors and exit status. Optionally</span>
<a name="line-855"></a><span class='hs-comment'>-- also supply some input. Also provides control over whether the binary/text</span>
<a name="line-856"></a><span class='hs-comment'>-- mode of the input and output.</span>
<a name="line-857"></a><span class='hs-comment'>--</span>
<a name="line-858"></a><span class='hs-definition'>rawSystemStdInOut</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>KnownIODataMode</span> <span class='hs-varid'>mode</span>
<a name="line-859"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Verbosity</span>
<a name="line-860"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>                 <span class='hs-comment'>-- ^ Program location</span>
<a name="line-861"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>                 <span class='hs-comment'>-- ^ Arguments</span>
<a name="line-862"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^ New working dir or inherit</span>
<a name="line-863"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ New environment or inherit</span>
<a name="line-864"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>IOData</span>             <span class='hs-comment'>-- ^ input text and binary mode</span>
<a name="line-865"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IODataMode</span> <span class='hs-varid'>mode</span>          <span class='hs-comment'>-- ^ iodata mode, acts as proxy</span>
<a name="line-866"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>ExitCode</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ output, errors, exit</span>
<a name="line-867"></a><span class='hs-definition'>rawSystemStdInOut</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span> <span class='hs-varid'>input</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-868"></a>  <span class='hs-varid'>printRawCommandAndArgs</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span>
<a name="line-869"></a>
<a name="line-870"></a>  <span class='hs-conid'>Exception.bracket</span>
<a name="line-871"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>runInteractiveProcess</span> <span class='hs-varid'>path</span> <span class='hs-varid'>args</span> <span class='hs-varid'>mcwd</span> <span class='hs-varid'>menv</span><span class='hs-layout'>)</span>
<a name="line-872"></a>     <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>inh</span><span class='hs-layout'>,</span><span class='hs-varid'>outh</span><span class='hs-layout'>,</span><span class='hs-varid'>errh</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hClose</span> <span class='hs-varid'>inh</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>hClose</span> <span class='hs-varid'>outh</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>hClose</span> <span class='hs-varid'>errh</span><span class='hs-layout'>)</span>
<a name="line-873"></a>    <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>inh</span><span class='hs-layout'>,</span><span class='hs-varid'>outh</span><span class='hs-layout'>,</span><span class='hs-varid'>errh</span><span class='hs-layout'>,</span><span class='hs-varid'>pid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-874"></a>
<a name="line-875"></a>      <span class='hs-comment'>-- output mode depends on what the caller wants</span>
<a name="line-876"></a>      <span class='hs-comment'>-- but the errors are always assumed to be text (in the current locale)</span>
<a name="line-877"></a>      <span class='hs-varid'>hSetBinaryMode</span> <span class='hs-varid'>errh</span> <span class='hs-conid'>False</span>
<a name="line-878"></a>
<a name="line-879"></a>      <span class='hs-comment'>-- fork off a couple threads to pull on the stderr and stdout</span>
<a name="line-880"></a>      <span class='hs-comment'>-- so if the process writes to stderr we do not block.</span>
<a name="line-881"></a>
<a name="line-882"></a>      <span class='hs-varid'>withAsyncNF</span> <span class='hs-layout'>(</span><span class='hs-varid'>hGetContents</span> <span class='hs-varid'>errh</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>errA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>withAsyncNF</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOData.hGetIODataContents</span> <span class='hs-varid'>outh</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>outA</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-883"></a>        <span class='hs-comment'>-- push all the input, if any</span>
<a name="line-884"></a>        <span class='hs-varid'>ignoreSigPipe</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>input</span> <span class='hs-keyword'>of</span>
<a name="line-885"></a>          <span class='hs-conid'>Nothing</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hClose</span> <span class='hs-varid'>inh</span>
<a name="line-886"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>inputData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOData.hPutContents</span> <span class='hs-varid'>inh</span> <span class='hs-varid'>inputData</span>
<a name="line-887"></a>
<a name="line-888"></a>        <span class='hs-comment'>-- wait for both to finish</span>
<a name="line-889"></a>        <span class='hs-varid'>mberr1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitCatch</span> <span class='hs-varid'>outA</span>
<a name="line-890"></a>        <span class='hs-varid'>mberr2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitCatch</span> <span class='hs-varid'>errA</span>
<a name="line-891"></a>
<a name="line-892"></a>        <span class='hs-comment'>-- wait for the program to terminate</span>
<a name="line-893"></a>        <span class='hs-varid'>exitcode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>waitForProcess</span> <span class='hs-varid'>pid</span>
<a name="line-894"></a>
<a name="line-895"></a>        <span class='hs-comment'>-- get the stderr, so it can be added to error message</span>
<a name="line-896"></a>        <span class='hs-varid'>err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reportOutputIOError</span> <span class='hs-varid'>mberr2</span>
<a name="line-897"></a>
<a name="line-898"></a>        <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>exitcode</span> <span class='hs-varop'>==</span> <span class='hs-conid'>ExitSuccess</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-899"></a>          <span class='hs-varid'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>" returned "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>exitcode</span>
<a name="line-900"></a>                         <span class='hs-varop'>++</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>then</span> <span class='hs-str'>""</span> <span class='hs-keyword'>else</span>
<a name="line-901"></a>                            <span class='hs-str'>" with error message:\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>err</span>
<a name="line-902"></a>                         <span class='hs-varop'>++</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>input</span> <span class='hs-keyword'>of</span>
<a name="line-903"></a>                              <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<a name="line-904"></a>                              <span class='hs-conid'>Just</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>IOData.null</span> <span class='hs-varid'>d</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>""</span>
<a name="line-905"></a>                              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>IODataText</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"\nstdin input:\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>inp</span>
<a name="line-906"></a>                              <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>IODataBinary</span> <span class='hs-varid'>inp</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"\nstdin input (binary):\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>inp</span>
<a name="line-907"></a>
<a name="line-908"></a>        <span class='hs-comment'>-- Check if we hit an exception while consuming the output</span>
<a name="line-909"></a>        <span class='hs-comment'>-- (e.g. a text decoding error)</span>
<a name="line-910"></a>        <span class='hs-varid'>out</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reportOutputIOError</span> <span class='hs-varid'>mberr1</span>
<a name="line-911"></a>
<a name="line-912"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>out</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>,</span> <span class='hs-varid'>exitcode</span><span class='hs-layout'>)</span>
<a name="line-913"></a>  <span class='hs-keyword'>where</span>
<a name="line-914"></a>    <span class='hs-varid'>reportOutputIOError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>Exception.SomeException</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-915"></a>    <span class='hs-varid'>reportOutputIOError</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>
<a name="line-916"></a>    <span class='hs-varid'>reportOutputIOError</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>exc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>exc</span> <span class='hs-keyword'>of</span>
<a name="line-917"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>ioeSetFileName</span> <span class='hs-varid'>ioe</span> <span class='hs-layout'>(</span><span class='hs-str'>"output of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-918"></a>        <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwIO</span> <span class='hs-varid'>exc</span>
<a name="line-919"></a>
<a name="line-920"></a>    <span class='hs-varid'>ignoreSigPipe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-921"></a>    <span class='hs-varid'>ignoreSigPipe</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Exception.handle</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-922"></a>        <span class='hs-conid'>GHC.IOError</span> <span class='hs-layout'>{</span> <span class='hs-conid'>GHC.ioe_type</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GHC.ResourceVanished</span><span class='hs-layout'>,</span> <span class='hs-conid'>GHC.ioe_errno</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ioe</span> <span class='hs-layout'>}</span>
<a name="line-923"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Errno</span> <span class='hs-varid'>ioe</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ePIPE</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-924"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwIO</span> <span class='hs-varid'>e</span>
<a name="line-925"></a>
<a name="line-926"></a><a name="findProgramVersion"></a><span class='hs-comment'>-- | Look for a program and try to find it's version number. It can accept</span>
<a name="line-927"></a><span class='hs-comment'>-- either an absolute path or the name of a program binary, in which case we</span>
<a name="line-928"></a><span class='hs-comment'>-- will look for the program on the path.</span>
<a name="line-929"></a><span class='hs-comment'>--</span>
<a name="line-930"></a><span class='hs-definition'>findProgramVersion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>             <span class='hs-comment'>-- ^ version args</span>
<a name="line-931"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ function to select version</span>
<a name="line-932"></a>                                         <span class='hs-comment'>--   number from program output</span>
<a name="line-933"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Verbosity</span>
<a name="line-934"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>           <span class='hs-comment'>-- ^ location</span>
<a name="line-935"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Version</span><span class='hs-layout'>)</span>
<a name="line-936"></a><span class='hs-definition'>findProgramVersion</span> <span class='hs-varid'>versionArg</span> <span class='hs-varid'>selectVersion</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-937"></a>  <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>rawSystemStdout</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>versionArg</span><span class='hs-keyglyph'>]</span>
<a name="line-938"></a>         <span class='hs-varop'>`catchIO`</span>   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-939"></a>         <span class='hs-varop'>`catchExit`</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-str'>""</span><span class='hs-layout'>)</span>
<a name="line-940"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>version</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Version</span>
<a name="line-941"></a>      <span class='hs-varid'>version</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>simpleParsec</span> <span class='hs-layout'>(</span><span class='hs-varid'>selectVersion</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span>
<a name="line-942"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>version</span> <span class='hs-keyword'>of</span>
<a name="line-943"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>warn</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"cannot determine version of "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>path</span>
<a name="line-944"></a>                               <span class='hs-varop'>++</span> <span class='hs-str'>" :\n"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>str</span>
<a name="line-945"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>debug</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>path</span> <span class='hs-varop'>++</span> <span class='hs-str'>" is version "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>v</span>
<a name="line-946"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>version</span>
<a name="line-947"></a>
<a name="line-948"></a>
<a name="line-949"></a><a name="xargs"></a><span class='hs-comment'>-- | Like the Unix xargs program. Useful for when we've got very long command</span>
<a name="line-950"></a><span class='hs-comment'>-- lines that might overflow an OS limit on command line length and so you</span>
<a name="line-951"></a><span class='hs-comment'>-- need to invoke a command multiple times to get all the args in.</span>
<a name="line-952"></a><span class='hs-comment'>--</span>
<a name="line-953"></a><span class='hs-comment'>-- Use it with either of the rawSystem variants above. For example:</span>
<a name="line-954"></a><span class='hs-comment'>--</span>
<a name="line-955"></a><span class='hs-comment'>-- &gt; xargs (32*1024) (rawSystemExit verbosity) prog fixedArgs bigArgs</span>
<a name="line-956"></a><span class='hs-comment'>--</span>
<a name="line-957"></a><span class='hs-definition'>xargs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-958"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-959"></a><span class='hs-definition'>xargs</span> <span class='hs-varid'>maxSize</span> <span class='hs-varid'>rawSystemFun</span> <span class='hs-varid'>fixedArgs</span> <span class='hs-varid'>bigArgs</span> <span class='hs-keyglyph'>=</span>
<a name="line-960"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>fixedArgSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sum</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>length</span> <span class='hs-varid'>fixedArgs</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-varid'>length</span> <span class='hs-varid'>fixedArgs</span>
<a name="line-961"></a>      <span class='hs-varid'>chunkSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maxSize</span> <span class='hs-comment'>-</span> <span class='hs-varid'>fixedArgSize</span>
<a name="line-962"></a>   <span class='hs-keyword'>in</span> <span class='hs-varid'>traverse_</span> <span class='hs-layout'>(</span><span class='hs-varid'>rawSystemFun</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixedArgs</span> <span class='hs-varop'>++</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>chunks</span> <span class='hs-varid'>chunkSize</span> <span class='hs-varid'>bigArgs</span><span class='hs-layout'>)</span>
<a name="line-963"></a>
<a name="line-964"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>chunks</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unfoldr</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>s</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-965"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>s</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Nothing</span>
<a name="line-966"></a>                    <span class='hs-keyword'>else</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>chunk</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>len</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-967"></a>
<a name="line-968"></a>        <span class='hs-varid'>chunk</span> <span class='hs-varid'>acc</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-969"></a>        <span class='hs-varid'>chunk</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>len</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-970"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>len'</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>len</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chunk</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span><span class='hs-comment'>-</span><span class='hs-varid'>len'</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ss</span>
<a name="line-971"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>s</span><span class='hs-conop'>:</span><span class='hs-varid'>ss</span><span class='hs-layout'>)</span>
<a name="line-972"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>len'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>s</span>
<a name="line-973"></a>
<a name="line-974"></a><span class='hs-comment'>-- ------------------------------------------------------------</span>
<a name="line-975"></a><span class='hs-comment'>-- * File Utilities</span>
<a name="line-976"></a><span class='hs-comment'>-- ------------------------------------------------------------</span>
<a name="line-977"></a>
<a name="line-978"></a><span class='hs-comment'>----------------</span>
<a name="line-979"></a><span class='hs-comment'>-- Finding files</span>
<a name="line-980"></a>
<a name="line-981"></a>
<a name="line-982"></a><a name="findFile"></a><span class='hs-comment'>{-# DEPRECATED findFile "Use findFileEx instead. This symbol will be removed in Cabal 3.2 (est. December 2019)" #-}</span>
<a name="line-983"></a><span class='hs-definition'>findFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^search locations</span>
<a name="line-984"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>      <span class='hs-comment'>-- ^File Name</span>
<a name="line-985"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-986"></a><span class='hs-definition'>findFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findFileEx</span> <span class='hs-varid'>normal</span>
<a name="line-987"></a>
<a name="line-988"></a><a name="findFileCwd"></a><span class='hs-comment'>-- | Find a file by looking in a search path. The file path must match exactly.</span>
<a name="line-989"></a><span class='hs-comment'>--</span>
<a name="line-990"></a><span class='hs-comment'>-- @since 3.4.0.0</span>
<a name="line-991"></a><span class='hs-definition'>findFileCwd</span>
<a name="line-992"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-993"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>      <span class='hs-comment'>-- ^ cwd</span>
<a name="line-994"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ relative search location</span>
<a name="line-995"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>      <span class='hs-comment'>-- ^ File Name</span>
<a name="line-996"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-997"></a><span class='hs-definition'>findFileCwd</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>fileName</span> <span class='hs-keyglyph'>=</span>
<a name="line-998"></a>  <span class='hs-varid'>findFirstFile</span> <span class='hs-layout'>(</span><span class='hs-varid'>cwd</span> <span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span>
<a name="line-999"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>path</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>fileName</span>
<a name="line-1000"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>searchPath</span><span class='hs-keyglyph'>]</span>
<a name="line-1001"></a>  <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fileName</span> <span class='hs-varop'>++</span> <span class='hs-str'>" doesn't exist"</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span>
<a name="line-1002"></a>
<a name="line-1003"></a><a name="findFileEx"></a><span class='hs-comment'>-- | Find a file by looking in a search path. The file path must match exactly.</span>
<a name="line-1004"></a><span class='hs-comment'>--</span>
<a name="line-1005"></a><span class='hs-definition'>findFileEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-1006"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^search locations</span>
<a name="line-1007"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>      <span class='hs-comment'>-- ^File Name</span>
<a name="line-1008"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1009"></a><span class='hs-definition'>findFileEx</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>fileName</span> <span class='hs-keyglyph'>=</span>
<a name="line-1010"></a>  <span class='hs-varid'>findFirstFile</span> <span class='hs-varid'>id</span>
<a name="line-1011"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>path</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>fileName</span>
<a name="line-1012"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>searchPath</span><span class='hs-keyglyph'>]</span>
<a name="line-1013"></a>  <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fileName</span> <span class='hs-varop'>++</span> <span class='hs-str'>" doesn't exist"</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span>
<a name="line-1014"></a>
<a name="line-1015"></a><a name="findFileWithExtension"></a><span class='hs-comment'>-- | Find a file by looking in a search path with one of a list of possible</span>
<a name="line-1016"></a><span class='hs-comment'>-- file extensions. The file base name should be given and it will be tried</span>
<a name="line-1017"></a><span class='hs-comment'>-- with each of the extensions in each element of the search path.</span>
<a name="line-1018"></a><span class='hs-comment'>--</span>
<a name="line-1019"></a><span class='hs-definition'>findFileWithExtension</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1020"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1021"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1022"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-1023"></a><span class='hs-definition'>findFileWithExtension</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>baseName</span> <span class='hs-keyglyph'>=</span>
<a name="line-1024"></a>  <span class='hs-varid'>findFirstFile</span> <span class='hs-varid'>id</span>
<a name="line-1025"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>path</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>baseName</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>ext</span>
<a name="line-1026"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>searchPath</span>
<a name="line-1027"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>extensions</span> <span class='hs-keyglyph'>]</span>
<a name="line-1028"></a>
<a name="line-1029"></a><a name="findFileCwdWithExtension"></a><span class='hs-comment'>-- | @since 3.4.0.0</span>
<a name="line-1030"></a><span class='hs-definition'>findFileCwdWithExtension</span>
<a name="line-1031"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>
<a name="line-1032"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1033"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1034"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1035"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-1036"></a><span class='hs-definition'>findFileCwdWithExtension</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>baseName</span> <span class='hs-keyglyph'>=</span>
<a name="line-1037"></a>  <span class='hs-varid'>findFirstFile</span> <span class='hs-layout'>(</span><span class='hs-varid'>cwd</span> <span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span>
<a name="line-1038"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>path</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>baseName</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>ext</span>
<a name="line-1039"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>searchPath</span>
<a name="line-1040"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>extensions</span> <span class='hs-keyglyph'>]</span>
<a name="line-1041"></a>
<a name="line-1042"></a><a name="findAllFilesCwdWithExtension"></a><span class='hs-comment'>-- | @since 3.4.0.0</span>
<a name="line-1043"></a><span class='hs-definition'>findAllFilesCwdWithExtension</span>
<a name="line-1044"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>       <span class='hs-comment'>-- ^ cwd</span>
<a name="line-1045"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- ^ extensions</span>
<a name="line-1046"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- ^ relative search locations</span>
<a name="line-1047"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>       <span class='hs-comment'>-- ^ basename</span>
<a name="line-1048"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1049"></a><span class='hs-definition'>findAllFilesCwdWithExtension</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>basename</span> <span class='hs-keyglyph'>=</span>
<a name="line-1050"></a>  <span class='hs-varid'>findAllFiles</span> <span class='hs-layout'>(</span><span class='hs-varid'>cwd</span> <span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span>
<a name="line-1051"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>path</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>basename</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>ext</span>
<a name="line-1052"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>searchPath</span>
<a name="line-1053"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>extensions</span> <span class='hs-keyglyph'>]</span>
<a name="line-1054"></a>
<a name="line-1055"></a><a name="findAllFilesWithExtension"></a><span class='hs-definition'>findAllFilesWithExtension</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1056"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1057"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1058"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1059"></a><span class='hs-definition'>findAllFilesWithExtension</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>basename</span> <span class='hs-keyglyph'>=</span>
<a name="line-1060"></a>  <span class='hs-varid'>findAllFiles</span> <span class='hs-varid'>id</span>
<a name="line-1061"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>path</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>basename</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>ext</span>
<a name="line-1062"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>searchPath</span>
<a name="line-1063"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>extensions</span> <span class='hs-keyglyph'>]</span>
<a name="line-1064"></a>
<a name="line-1065"></a><a name="findFileWithExtension'"></a><span class='hs-comment'>-- | Like 'findFileWithExtension' but returns which element of the search path</span>
<a name="line-1066"></a><span class='hs-comment'>-- the file was found in, and the file path relative to that base directory.</span>
<a name="line-1067"></a><span class='hs-comment'>--</span>
<a name="line-1068"></a><span class='hs-definition'>findFileWithExtension'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1069"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1070"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1071"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1072"></a><span class='hs-definition'>findFileWithExtension'</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>baseName</span> <span class='hs-keyglyph'>=</span>
<a name="line-1073"></a>  <span class='hs-varid'>findFirstFile</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1074"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>path</span><span class='hs-layout'>,</span> <span class='hs-varid'>baseName</span> <span class='hs-varop'>&lt;.&gt;</span> <span class='hs-varid'>ext</span><span class='hs-layout'>)</span>
<a name="line-1075"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>searchPath</span>
<a name="line-1076"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nub</span> <span class='hs-varid'>extensions</span> <span class='hs-keyglyph'>]</span>
<a name="line-1077"></a>
<a name="line-1078"></a><a name="findFirstFile"></a><span class='hs-definition'>findFirstFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1079"></a><span class='hs-definition'>findFirstFile</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findFirst</span>
<a name="line-1080"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>findFirst</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1081"></a>        <span class='hs-varid'>findFirst</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-layout'>(</span><span class='hs-varid'>file</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1082"></a>                              <span class='hs-keyword'>if</span> <span class='hs-varid'>exists</span>
<a name="line-1083"></a>                                <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-1084"></a>                                <span class='hs-keyword'>else</span> <span class='hs-varid'>findFirst</span> <span class='hs-varid'>xs</span>
<a name="line-1085"></a>
<a name="line-1086"></a><a name="findAllFiles"></a><span class='hs-definition'>findAllFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-1087"></a><span class='hs-definition'>findAllFiles</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterM</span> <span class='hs-layout'>(</span><span class='hs-varid'>doesFileExist</span> <span class='hs-varop'>.</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-1088"></a>
<a name="line-1089"></a>
<a name="line-1090"></a><a name="findModuleFiles"></a><span class='hs-comment'>{-# DEPRECATED findModuleFiles "Use findModuleFilesEx instead. This symbol will be removed in Cabal 3.2 (est. December 2019)" #-}</span>
<a name="line-1091"></a><span class='hs-definition'>findModuleFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ build prefix (location of objects)</span>
<a name="line-1092"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- ^ search suffixes</span>
<a name="line-1093"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ modules</span>
<a name="line-1094"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1095"></a><span class='hs-definition'>findModuleFiles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findModuleFilesEx</span> <span class='hs-varid'>normal</span>
<a name="line-1096"></a>
<a name="line-1097"></a><a name="findModuleFilesEx"></a><span class='hs-comment'>-- | Finds the files corresponding to a list of Haskell module names.</span>
<a name="line-1098"></a><span class='hs-comment'>--</span>
<a name="line-1099"></a><span class='hs-comment'>-- As 'findModuleFile' but for a list of module names.</span>
<a name="line-1100"></a><span class='hs-comment'>--</span>
<a name="line-1101"></a><span class='hs-definition'>findModuleFilesEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-1102"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ build prefix (location of objects)</span>
<a name="line-1103"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- ^ search suffixes</span>
<a name="line-1104"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ModuleName</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- ^ modules</span>
<a name="line-1105"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1106"></a><span class='hs-definition'>findModuleFilesEx</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>moduleNames</span> <span class='hs-keyglyph'>=</span>
<a name="line-1107"></a>  <span class='hs-varid'>traverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>findModuleFileEx</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>extensions</span><span class='hs-layout'>)</span> <span class='hs-varid'>moduleNames</span>
<a name="line-1108"></a>
<a name="line-1109"></a><a name="findModuleFile"></a><span class='hs-comment'>{-# DEPRECATED findModuleFile "Use findModuleFileEx instead. This symbol will be removed in Cabal 3.2 (est. December 2019)" #-}</span>
<a name="line-1110"></a><span class='hs-definition'>findModuleFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ build prefix (location of objects)</span>
<a name="line-1111"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ search suffixes</span>
<a name="line-1112"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span>  <span class='hs-comment'>-- ^ module</span>
<a name="line-1113"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-1114"></a><span class='hs-definition'>findModuleFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findModuleFileEx</span> <span class='hs-varid'>normal</span>
<a name="line-1115"></a>
<a name="line-1116"></a><a name="findModuleFileEx"></a><span class='hs-comment'>-- | Find the file corresponding to a Haskell module name.</span>
<a name="line-1117"></a><span class='hs-comment'>--</span>
<a name="line-1118"></a><span class='hs-comment'>-- This is similar to 'findFileWithExtension'' but specialised to a module</span>
<a name="line-1119"></a><span class='hs-comment'>-- name. The function fails if the file corresponding to the module is missing.</span>
<a name="line-1120"></a><span class='hs-comment'>--</span>
<a name="line-1121"></a><span class='hs-definition'>findModuleFileEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-1122"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ build prefix (location of objects)</span>
<a name="line-1123"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ search suffixes</span>
<a name="line-1124"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleName</span>  <span class='hs-comment'>-- ^ module</span>
<a name="line-1125"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-1126"></a><span class='hs-definition'>findModuleFileEx</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>searchPath</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>=</span>
<a name="line-1127"></a>      <span class='hs-varid'>maybe</span> <span class='hs-varid'>notFound</span> <span class='hs-varid'>return</span>
<a name="line-1128"></a>  <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>findFileWithExtension'</span> <span class='hs-varid'>extensions</span> <span class='hs-varid'>searchPath</span>
<a name="line-1129"></a>                             <span class='hs-layout'>(</span><span class='hs-conid'>ModuleName.toFilePath</span> <span class='hs-varid'>mod_name</span><span class='hs-layout'>)</span>
<a name="line-1130"></a>  <span class='hs-keyword'>where</span>
<a name="line-1131"></a>    <span class='hs-varid'>notFound</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span>
<a name="line-1132"></a>      <span class='hs-str'>"Error: Could not find module: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>prettyShow</span> <span class='hs-varid'>mod_name</span>
<a name="line-1133"></a>      <span class='hs-varop'>++</span> <span class='hs-str'>" with any suffix: "</span>          <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>extensions</span>
<a name="line-1134"></a>      <span class='hs-varop'>++</span> <span class='hs-str'>" in the search path: "</span>       <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>searchPath</span>
<a name="line-1135"></a>
<a name="line-1136"></a><a name="getDirectoryContentsRecursive"></a><span class='hs-comment'>-- | List all the files in a directory and all subdirectories.</span>
<a name="line-1137"></a><span class='hs-comment'>--</span>
<a name="line-1138"></a><span class='hs-comment'>-- The order places files in sub-directories after all the files in their</span>
<a name="line-1139"></a><span class='hs-comment'>-- parent directories. The list is generated lazily so is not well defined if</span>
<a name="line-1140"></a><span class='hs-comment'>-- the source directory structure changes before the list is used.</span>
<a name="line-1141"></a><span class='hs-comment'>--</span>
<a name="line-1142"></a><span class='hs-definition'>getDirectoryContentsRecursive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1143"></a><span class='hs-definition'>getDirectoryContentsRecursive</span> <span class='hs-varid'>topdir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>recurseDirectories</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-1144"></a>  <span class='hs-keyword'>where</span>
<a name="line-1145"></a>    <span class='hs-varid'>recurseDirectories</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1146"></a>    <span class='hs-varid'>recurseDirectories</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-1147"></a>    <span class='hs-varid'>recurseDirectories</span> <span class='hs-layout'>(</span><span class='hs-varid'>dir</span><span class='hs-conop'>:</span><span class='hs-varid'>dirs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafeInterleaveIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1148"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>files</span><span class='hs-layout'>,</span> <span class='hs-varid'>dirs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>collect</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>getDirectoryContents</span> <span class='hs-layout'>(</span><span class='hs-varid'>topdir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>dir</span><span class='hs-layout'>)</span>
<a name="line-1149"></a>      <span class='hs-varid'>files'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>recurseDirectories</span> <span class='hs-layout'>(</span><span class='hs-varid'>dirs'</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dirs</span><span class='hs-layout'>)</span>
<a name="line-1150"></a>      <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>files</span> <span class='hs-varop'>++</span> <span class='hs-varid'>files'</span><span class='hs-layout'>)</span>
<a name="line-1151"></a>
<a name="line-1152"></a>      <span class='hs-keyword'>where</span>
<a name="line-1153"></a>        <span class='hs-varid'>collect</span> <span class='hs-varid'>files</span> <span class='hs-varid'>dirs'</span> <span class='hs-conid'>[]</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>files</span>
<a name="line-1154"></a>                                                     <span class='hs-layout'>,</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>dirs'</span><span class='hs-layout'>)</span>
<a name="line-1155"></a>        <span class='hs-varid'>collect</span> <span class='hs-varid'>files</span> <span class='hs-varid'>dirs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>entry</span><span class='hs-conop'>:</span><span class='hs-varid'>entries</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ignore</span> <span class='hs-varid'>entry</span>
<a name="line-1156"></a>                                            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>files</span> <span class='hs-varid'>dirs'</span> <span class='hs-varid'>entries</span>
<a name="line-1157"></a>        <span class='hs-varid'>collect</span> <span class='hs-varid'>files</span> <span class='hs-varid'>dirs'</span> <span class='hs-layout'>(</span><span class='hs-varid'>entry</span><span class='hs-conop'>:</span><span class='hs-varid'>entries</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1158"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>dirEntry</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>entry</span>
<a name="line-1159"></a>          <span class='hs-varid'>isDirectory</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesDirectoryExist</span> <span class='hs-layout'>(</span><span class='hs-varid'>topdir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>dirEntry</span><span class='hs-layout'>)</span>
<a name="line-1160"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>isDirectory</span>
<a name="line-1161"></a>            <span class='hs-keyword'>then</span> <span class='hs-varid'>collect</span> <span class='hs-varid'>files</span> <span class='hs-layout'>(</span><span class='hs-varid'>dirEntry</span><span class='hs-conop'>:</span><span class='hs-varid'>dirs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>entries</span>
<a name="line-1162"></a>            <span class='hs-keyword'>else</span> <span class='hs-varid'>collect</span> <span class='hs-layout'>(</span><span class='hs-varid'>dirEntry</span><span class='hs-conop'>:</span><span class='hs-varid'>files</span><span class='hs-layout'>)</span> <span class='hs-varid'>dirs'</span> <span class='hs-varid'>entries</span>
<a name="line-1163"></a>
<a name="line-1164"></a>        <span class='hs-varid'>ignore</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'.'</span><span class='hs-keyglyph'>]</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1165"></a>        <span class='hs-varid'>ignore</span> <span class='hs-keyglyph'>[</span><span class='hs-chr'>'.'</span><span class='hs-layout'>,</span> <span class='hs-chr'>'.'</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1166"></a>        <span class='hs-varid'>ignore</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1167"></a>
<a name="line-1168"></a><span class='hs-comment'>------------------------</span>
<a name="line-1169"></a><span class='hs-comment'>-- Environment variables</span>
<a name="line-1170"></a>
<a name="line-1171"></a><a name="isInSearchPath"></a><span class='hs-comment'>-- | Is this directory in the system search path?</span>
<a name="line-1172"></a><span class='hs-definition'>isInSearchPath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-1173"></a><span class='hs-definition'>isInSearchPath</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>elem</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span> <span class='hs-varid'>getSearchPath</span>
<a name="line-1174"></a>
<a name="line-1175"></a><a name="addLibraryPath"></a><span class='hs-definition'>addLibraryPath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OS</span>
<a name="line-1176"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FilePath</span><span class='hs-keyglyph'>]</span>
<a name="line-1177"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1178"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span><span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1179"></a><span class='hs-definition'>addLibraryPath</span> <span class='hs-varid'>os</span> <span class='hs-varid'>paths</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addEnv</span>
<a name="line-1180"></a>  <span class='hs-keyword'>where</span>
<a name="line-1181"></a>    <span class='hs-varid'>pathsString</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>intercalate</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>searchPathSeparator</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>paths</span>
<a name="line-1182"></a>    <span class='hs-varid'>ldPath</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>os</span> <span class='hs-keyword'>of</span>
<a name="line-1183"></a>               <span class='hs-conid'>OSX</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"DYLD_LIBRARY_PATH"</span>
<a name="line-1184"></a>               <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"LD_LIBRARY_PATH"</span>
<a name="line-1185"></a>
<a name="line-1186"></a>    <span class='hs-varid'>addEnv</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>ldPath</span><span class='hs-layout'>,</span><span class='hs-varid'>pathsString</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1187"></a>    <span class='hs-varid'>addEnv</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span><span class='hs-varid'>value</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span>
<a name="line-1188"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>key</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ldPath</span> <span class='hs-keyglyph'>=</span>
<a name="line-1189"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>value</span>
<a name="line-1190"></a>             <span class='hs-keyword'>then</span> <span class='hs-layout'>(</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span><span class='hs-varid'>pathsString</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span>
<a name="line-1191"></a>             <span class='hs-keyword'>else</span> <span class='hs-layout'>(</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span><span class='hs-varid'>value</span> <span class='hs-varop'>++</span> <span class='hs-layout'>(</span><span class='hs-varid'>searchPathSeparator</span><span class='hs-conop'>:</span><span class='hs-varid'>pathsString</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span>
<a name="line-1192"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span><span class='hs-varid'>value</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>addEnv</span> <span class='hs-varid'>xs</span>
<a name="line-1193"></a>
<a name="line-1194"></a><span class='hs-comment'>--------------------</span>
<a name="line-1195"></a><span class='hs-comment'>-- Modification time</span>
<a name="line-1196"></a>
<a name="line-1197"></a><a name="moreRecentFile"></a><span class='hs-comment'>-- | Compare the modification times of two files to see if the first is newer</span>
<a name="line-1198"></a><span class='hs-comment'>-- than the second. The first file must exist but the second need not.</span>
<a name="line-1199"></a><span class='hs-comment'>-- The expected use case is when the second file is generated using the first.</span>
<a name="line-1200"></a><span class='hs-comment'>-- In this use case, if the result is True then the second file is out of date.</span>
<a name="line-1201"></a><span class='hs-comment'>--</span>
<a name="line-1202"></a><span class='hs-definition'>moreRecentFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-1203"></a><span class='hs-definition'>moreRecentFile</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1204"></a>  <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>b</span>
<a name="line-1205"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>exists</span>
<a name="line-1206"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>True</span>
<a name="line-1207"></a>    <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>tb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModificationTime</span> <span class='hs-varid'>b</span>
<a name="line-1208"></a>            <span class='hs-varid'>ta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getModificationTime</span> <span class='hs-varid'>a</span>
<a name="line-1209"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ta</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>tb</span><span class='hs-layout'>)</span>
<a name="line-1210"></a>
<a name="line-1211"></a><a name="existsAndIsMoreRecentThan"></a><span class='hs-comment'>-- | Like 'moreRecentFile', but also checks that the first file exists.</span>
<a name="line-1212"></a><span class='hs-definition'>existsAndIsMoreRecentThan</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-1213"></a><span class='hs-definition'>existsAndIsMoreRecentThan</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1214"></a>  <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>a</span>
<a name="line-1215"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-varid'>exists</span>
<a name="line-1216"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-1217"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`moreRecentFile`</span> <span class='hs-varid'>b</span>
<a name="line-1218"></a>
<a name="line-1219"></a><span class='hs-comment'>----------------------------------------</span>
<a name="line-1220"></a><span class='hs-comment'>-- Copying and installing files and dirs</span>
<a name="line-1221"></a>
<a name="line-1222"></a><a name="createDirectoryIfMissingVerbose"></a><span class='hs-comment'>-- | Same as 'createDirectoryIfMissing' but logs at higher verbosity levels.</span>
<a name="line-1223"></a><span class='hs-comment'>--</span>
<a name="line-1224"></a><span class='hs-definition'>createDirectoryIfMissingVerbose</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-1225"></a>                                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- ^ Create its parents too?</span>
<a name="line-1226"></a>                                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1227"></a>                                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1228"></a><span class='hs-definition'>createDirectoryIfMissingVerbose</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>create_parents</span> <span class='hs-varid'>path0</span>
<a name="line-1229"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>create_parents</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>createDirs</span> <span class='hs-layout'>(</span><span class='hs-varid'>parents</span> <span class='hs-varid'>path0</span><span class='hs-layout'>)</span>
<a name="line-1230"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-varid'>createDirs</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>parents</span> <span class='hs-varid'>path0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1231"></a>  <span class='hs-keyword'>where</span>
<a name="line-1232"></a>    <span class='hs-varid'>parents</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>.</span> <span class='hs-varid'>scanl1</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>splitDirectories</span> <span class='hs-varop'>.</span> <span class='hs-varid'>normalise</span>
<a name="line-1233"></a>
<a name="line-1234"></a>    <span class='hs-varid'>createDirs</span> <span class='hs-conid'>[]</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1235"></a>    <span class='hs-varid'>createDirs</span> <span class='hs-layout'>(</span><span class='hs-varid'>dir</span><span class='hs-conop'>:</span><span class='hs-conid'>[]</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>createDir</span> <span class='hs-varid'>dir</span> <span class='hs-varid'>throwIO</span>
<a name="line-1236"></a>    <span class='hs-varid'>createDirs</span> <span class='hs-layout'>(</span><span class='hs-varid'>dir</span><span class='hs-conop'>:</span><span class='hs-varid'>dirs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1237"></a>      <span class='hs-varid'>createDir</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1238"></a>        <span class='hs-varid'>createDirs</span> <span class='hs-varid'>dirs</span>
<a name="line-1239"></a>        <span class='hs-varid'>createDir</span> <span class='hs-varid'>dir</span> <span class='hs-varid'>throwIO</span>
<a name="line-1240"></a>
<a name="line-1241"></a>    <span class='hs-varid'>createDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1242"></a>    <span class='hs-varid'>createDir</span> <span class='hs-varid'>dir</span> <span class='hs-varid'>notExistHandler</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1243"></a>      <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>createDirectoryVerbose</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dir</span>
<a name="line-1244"></a>      <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>IOException</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1245"></a>        <span class='hs-conid'>Right</span> <span class='hs-conid'>()</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1246"></a>        <span class='hs-conid'>Left</span>  <span class='hs-varid'>e</span>
<a name="line-1247"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDoesNotExistError</span>  <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>notExistHandler</span> <span class='hs-varid'>e</span>
<a name="line-1248"></a>          <span class='hs-comment'>-- createDirectory (and indeed POSIX mkdir) does not distinguish</span>
<a name="line-1249"></a>          <span class='hs-comment'>-- between a dir already existing and a file already existing. So we</span>
<a name="line-1250"></a>          <span class='hs-comment'>-- check for it here. Unfortunately there is a slight race condition</span>
<a name="line-1251"></a>          <span class='hs-comment'>-- here, but we think it is benign. It could report an exception in</span>
<a name="line-1252"></a>          <span class='hs-comment'>-- the case that the dir did exist but another process deletes the</span>
<a name="line-1253"></a>          <span class='hs-comment'>-- directory and creates a file in its place before we can check</span>
<a name="line-1254"></a>          <span class='hs-comment'>-- that the directory did indeed exist.</span>
<a name="line-1255"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAlreadyExistsError</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span>
<a name="line-1256"></a>              <span class='hs-varid'>isDir</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesDirectoryExist</span> <span class='hs-varid'>dir</span>
<a name="line-1257"></a>              <span class='hs-varid'>unless</span> <span class='hs-varid'>isDir</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwIO</span> <span class='hs-varid'>e</span>
<a name="line-1258"></a>              <span class='hs-layout'>)</span> <span class='hs-varop'>`catchIO`</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IOException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1259"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwIO</span> <span class='hs-varid'>e</span>
<a name="line-1260"></a>
<a name="line-1261"></a><a name="createDirectoryVerbose"></a><span class='hs-definition'>createDirectoryVerbose</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1262"></a><span class='hs-definition'>createDirectoryVerbose</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1263"></a>  <span class='hs-varid'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-str'>"creating "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dir</span>
<a name="line-1264"></a>  <span class='hs-varid'>createDirectory</span> <span class='hs-varid'>dir</span>
<a name="line-1265"></a>  <span class='hs-varid'>setDirOrdinary</span> <span class='hs-varid'>dir</span>
<a name="line-1266"></a>
<a name="line-1267"></a><a name="copyFileVerbose"></a><span class='hs-comment'>-- | Copies a file without copying file permissions. The target file is created</span>
<a name="line-1268"></a><span class='hs-comment'>-- with default permissions. Any existing target file is replaced.</span>
<a name="line-1269"></a><span class='hs-comment'>--</span>
<a name="line-1270"></a><span class='hs-comment'>-- At higher verbosity levels it logs an info message.</span>
<a name="line-1271"></a><span class='hs-comment'>--</span>
<a name="line-1272"></a><span class='hs-definition'>copyFileVerbose</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1273"></a><span class='hs-definition'>copyFileVerbose</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1274"></a>  <span class='hs-varid'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"copy "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>src</span> <span class='hs-varop'>++</span> <span class='hs-str'>" to "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dest</span><span class='hs-layout'>)</span>
<a name="line-1275"></a>  <span class='hs-varid'>copyFile</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span>
<a name="line-1276"></a>
<a name="line-1277"></a><a name="installOrdinaryFile"></a><span class='hs-comment'>-- | Install an ordinary file. This is like a file copy but the permissions</span>
<a name="line-1278"></a><span class='hs-comment'>-- are set appropriately for an installed file. On Unix it is \"-rw-r--r--\"</span>
<a name="line-1279"></a><span class='hs-comment'>-- while on Windows it uses the default permissions for the target directory.</span>
<a name="line-1280"></a><span class='hs-comment'>--</span>
<a name="line-1281"></a><span class='hs-definition'>installOrdinaryFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1282"></a><span class='hs-definition'>installOrdinaryFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1283"></a>  <span class='hs-varid'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"Installing "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>src</span> <span class='hs-varop'>++</span> <span class='hs-str'>" to "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dest</span><span class='hs-layout'>)</span>
<a name="line-1284"></a>  <span class='hs-varid'>copyOrdinaryFile</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span>
<a name="line-1285"></a>
<a name="line-1286"></a><a name="installExecutableFile"></a><span class='hs-comment'>-- | Install an executable file. This is like a file copy but the permissions</span>
<a name="line-1287"></a><span class='hs-comment'>-- are set appropriately for an installed file. On Unix it is \"-rwxr-xr-x\"</span>
<a name="line-1288"></a><span class='hs-comment'>-- while on Windows it uses the default permissions for the target directory.</span>
<a name="line-1289"></a><span class='hs-comment'>--</span>
<a name="line-1290"></a><span class='hs-definition'>installExecutableFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1291"></a><span class='hs-definition'>installExecutableFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1292"></a>  <span class='hs-varid'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"Installing executable "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>src</span> <span class='hs-varop'>++</span> <span class='hs-str'>" to "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>dest</span><span class='hs-layout'>)</span>
<a name="line-1293"></a>  <span class='hs-varid'>copyExecutableFile</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span>
<a name="line-1294"></a>
<a name="line-1295"></a><a name="installMaybeExecutableFile"></a><span class='hs-comment'>-- | Install a file that may or not be executable, preserving permissions.</span>
<a name="line-1296"></a><span class='hs-definition'>installMaybeExecutableFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1297"></a><span class='hs-definition'>installMaybeExecutableFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1298"></a>  <span class='hs-varid'>perms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPermissions</span> <span class='hs-varid'>src</span>
<a name="line-1299"></a>  <span class='hs-keyword'>if</span> <span class='hs-layout'>(</span><span class='hs-varid'>executable</span> <span class='hs-varid'>perms</span><span class='hs-layout'>)</span> <span class='hs-comment'>--only checks user x bit</span>
<a name="line-1300"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>installExecutableFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span>
<a name="line-1301"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>installOrdinaryFile</span>   <span class='hs-varid'>verbosity</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span>
<a name="line-1302"></a>
<a name="line-1303"></a><a name="copyFileTo"></a><span class='hs-comment'>-- | Given a relative path to a file, copy it to the given directory, preserving</span>
<a name="line-1304"></a><span class='hs-comment'>-- the relative path and creating the parent directories if needed.</span>
<a name="line-1305"></a><span class='hs-definition'>copyFileTo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1306"></a><span class='hs-definition'>copyFileTo</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dir</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1307"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>targetFile</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>file</span>
<a name="line-1308"></a>  <span class='hs-varid'>createDirectoryIfMissingVerbose</span> <span class='hs-varid'>verbosity</span> <span class='hs-conid'>True</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeDirectory</span> <span class='hs-varid'>targetFile</span><span class='hs-layout'>)</span>
<a name="line-1309"></a>  <span class='hs-varid'>installOrdinaryFile</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>file</span> <span class='hs-varid'>targetFile</span>
<a name="line-1310"></a>
<a name="line-1311"></a><a name="copyFilesWith"></a><span class='hs-comment'>-- | Common implementation of 'copyFiles', 'installOrdinaryFiles',</span>
<a name="line-1312"></a><span class='hs-comment'>-- 'installExecutableFiles' and 'installMaybeExecutableFiles'.</span>
<a name="line-1313"></a><span class='hs-definition'>copyFilesWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1314"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1315"></a><span class='hs-definition'>copyFilesWith</span> <span class='hs-varid'>doCopy</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>srcFiles</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1316"></a>
<a name="line-1317"></a>  <span class='hs-comment'>-- Create parent directories for everything</span>
<a name="line-1318"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>dirs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>targetDir</span> <span class='hs-varop'>&lt;/&gt;</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nub</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>takeDirectory</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>srcFiles</span>
<a name="line-1319"></a>  <span class='hs-varid'>traverse_</span> <span class='hs-layout'>(</span><span class='hs-varid'>createDirectoryIfMissingVerbose</span> <span class='hs-varid'>verbosity</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-varid'>dirs</span>
<a name="line-1320"></a>
<a name="line-1321"></a>  <span class='hs-comment'>-- Copy all the files</span>
<a name="line-1322"></a>  <span class='hs-varid'>sequence_</span> <span class='hs-keyglyph'>[</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>src</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcBase</span>   <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>srcFile</span>
<a name="line-1323"></a>                  <span class='hs-varid'>dest</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetDir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>srcFile</span>
<a name="line-1324"></a>               <span class='hs-keyword'>in</span> <span class='hs-varid'>doCopy</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>src</span> <span class='hs-varid'>dest</span>
<a name="line-1325"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcBase</span><span class='hs-layout'>,</span> <span class='hs-varid'>srcFile</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>srcFiles</span> <span class='hs-keyglyph'>]</span>
<a name="line-1326"></a>
<a name="line-1327"></a><a name="copyFiles"></a><span class='hs-comment'>-- | Copies a bunch of files to a target directory, preserving the directory</span>
<a name="line-1328"></a><span class='hs-comment'>-- structure in the target location. The target directories are created if they</span>
<a name="line-1329"></a><span class='hs-comment'>-- do not exist.</span>
<a name="line-1330"></a><span class='hs-comment'>--</span>
<a name="line-1331"></a><span class='hs-comment'>-- The files are identified by a pair of base directory and a path relative to</span>
<a name="line-1332"></a><span class='hs-comment'>-- that base. It is only the relative part that is preserved in the</span>
<a name="line-1333"></a><span class='hs-comment'>-- destination.</span>
<a name="line-1334"></a><span class='hs-comment'>--</span>
<a name="line-1335"></a><span class='hs-comment'>-- For example:</span>
<a name="line-1336"></a><span class='hs-comment'>--</span>
<a name="line-1337"></a><span class='hs-comment'>-- &gt; copyFiles normal "dist/src"</span>
<a name="line-1338"></a><span class='hs-comment'>-- &gt;    [("", "src/Foo.hs"), ("dist/build/", "src/Bar.hs")]</span>
<a name="line-1339"></a><span class='hs-comment'>--</span>
<a name="line-1340"></a><span class='hs-comment'>-- This would copy \"src\/Foo.hs\" to \"dist\/src\/src\/Foo.hs\" and</span>
<a name="line-1341"></a><span class='hs-comment'>-- copy \"dist\/build\/src\/Bar.hs\" to \"dist\/src\/src\/Bar.hs\".</span>
<a name="line-1342"></a><span class='hs-comment'>--</span>
<a name="line-1343"></a><span class='hs-comment'>-- This operation is not atomic. Any IO failure during the copy (including any</span>
<a name="line-1344"></a><span class='hs-comment'>-- missing source files) leaves the target in an unknown state so it is best to</span>
<a name="line-1345"></a><span class='hs-comment'>-- use it with a freshly created directory so that it can be simply deleted if</span>
<a name="line-1346"></a><span class='hs-comment'>-- anything goes wrong.</span>
<a name="line-1347"></a><span class='hs-comment'>--</span>
<a name="line-1348"></a><span class='hs-definition'>copyFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1349"></a><span class='hs-definition'>copyFiles</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-layout'>(</span><span class='hs-varid'>copyFilesWith</span> <span class='hs-varid'>copyFileVerbose</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-1350"></a>
<a name="line-1351"></a><a name="installOrdinaryFiles"></a><span class='hs-comment'>-- | This is like 'copyFiles' but uses 'installOrdinaryFile'.</span>
<a name="line-1352"></a><span class='hs-comment'>--</span>
<a name="line-1353"></a><span class='hs-definition'>installOrdinaryFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1354"></a><span class='hs-definition'>installOrdinaryFiles</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-layout'>(</span><span class='hs-varid'>copyFilesWith</span> <span class='hs-varid'>installOrdinaryFile</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-1355"></a>
<a name="line-1356"></a><a name="installExecutableFiles"></a><span class='hs-comment'>-- | This is like 'copyFiles' but uses 'installExecutableFile'.</span>
<a name="line-1357"></a><span class='hs-comment'>--</span>
<a name="line-1358"></a><span class='hs-definition'>installExecutableFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1359"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1360"></a><span class='hs-definition'>installExecutableFiles</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-layout'>(</span><span class='hs-varid'>copyFilesWith</span> <span class='hs-varid'>installExecutableFile</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-1361"></a>
<a name="line-1362"></a><a name="installMaybeExecutableFiles"></a><span class='hs-comment'>-- | This is like 'copyFiles' but uses 'installMaybeExecutableFile'.</span>
<a name="line-1363"></a><span class='hs-comment'>--</span>
<a name="line-1364"></a><span class='hs-definition'>installMaybeExecutableFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1365"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1366"></a><span class='hs-definition'>installMaybeExecutableFiles</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-layout'>(</span><span class='hs-varid'>copyFilesWith</span> <span class='hs-varid'>installMaybeExecutableFile</span> <span class='hs-varid'>v</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span>
<a name="line-1367"></a>
<a name="line-1368"></a><a name="installDirectoryContents"></a><span class='hs-comment'>-- | This installs all the files in a directory to a target location,</span>
<a name="line-1369"></a><span class='hs-comment'>-- preserving the directory layout. All the files are assumed to be ordinary</span>
<a name="line-1370"></a><span class='hs-comment'>-- rather than executable files.</span>
<a name="line-1371"></a><span class='hs-comment'>--</span>
<a name="line-1372"></a><span class='hs-definition'>installDirectoryContents</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1373"></a><span class='hs-definition'>installDirectoryContents</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>srcDir</span> <span class='hs-varid'>destDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1374"></a>  <span class='hs-varid'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"copy directory '"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>srcDir</span> <span class='hs-varop'>++</span> <span class='hs-str'>"' to '"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>destDir</span> <span class='hs-varop'>++</span> <span class='hs-str'>"'."</span><span class='hs-layout'>)</span>
<a name="line-1375"></a>  <span class='hs-varid'>srcFiles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDirectoryContentsRecursive</span> <span class='hs-varid'>srcDir</span>
<a name="line-1376"></a>  <span class='hs-varid'>installOrdinaryFiles</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>destDir</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcDir</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>srcFiles</span> <span class='hs-keyglyph'>]</span>
<a name="line-1377"></a>
<a name="line-1378"></a><a name="copyDirectoryRecursive"></a><span class='hs-comment'>-- | Recursively copy the contents of one directory to another path.</span>
<a name="line-1379"></a><span class='hs-definition'>copyDirectoryRecursive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1380"></a><span class='hs-definition'>copyDirectoryRecursive</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>srcDir</span> <span class='hs-varid'>destDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1381"></a>  <span class='hs-varid'>info</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"copy directory '"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>srcDir</span> <span class='hs-varop'>++</span> <span class='hs-str'>"' to '"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>destDir</span> <span class='hs-varop'>++</span> <span class='hs-str'>"'."</span><span class='hs-layout'>)</span>
<a name="line-1382"></a>  <span class='hs-varid'>srcFiles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDirectoryContentsRecursive</span> <span class='hs-varid'>srcDir</span>
<a name="line-1383"></a>  <span class='hs-varid'>copyFilesWith</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>copyFile</span><span class='hs-layout'>)</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>destDir</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcDir</span><span class='hs-layout'>,</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-1384"></a>                                                   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>srcFiles</span> <span class='hs-keyglyph'>]</span>
<a name="line-1385"></a>
<a name="line-1386"></a><span class='hs-comment'>-------------------</span>
<a name="line-1387"></a><span class='hs-comment'>-- File permissions</span>
<a name="line-1388"></a>
<a name="line-1389"></a><a name="doesExecutableExist"></a><span class='hs-comment'>-- | Like 'doesFileExist', but also checks that the file is executable.</span>
<a name="line-1390"></a><span class='hs-definition'>doesExecutableExist</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-1391"></a><span class='hs-definition'>doesExecutableExist</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1392"></a>  <span class='hs-varid'>exists</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>f</span>
<a name="line-1393"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>exists</span>
<a name="line-1394"></a>    <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>perms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getPermissions</span> <span class='hs-varid'>f</span>
<a name="line-1395"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>executable</span> <span class='hs-varid'>perms</span><span class='hs-layout'>)</span>
<a name="line-1396"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-1397"></a>
<a name="line-1398"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1399"></a><span class='hs-comment'>-- Temporary files and dirs</span>
<a name="line-1400"></a>
<a name="line-1401"></a><a name="TempFileOptions"></a><span class='hs-comment'>-- | Advanced options for 'withTempFile' and 'withTempDirectory'.</span>
<a name="line-1402"></a><a name="TempFileOptions"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TempFileOptions</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TempFileOptions</span> <span class='hs-layout'>{</span>
<a name="line-1403"></a>  <span class='hs-varid'>optKeepTempFiles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>  <span class='hs-comment'>-- ^ Keep temporary files?</span>
<a name="line-1404"></a>  <span class='hs-layout'>}</span>
<a name="line-1405"></a>
<a name="line-1406"></a><a name="defaultTempFileOptions"></a><span class='hs-definition'>defaultTempFileOptions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TempFileOptions</span>
<a name="line-1407"></a><span class='hs-definition'>defaultTempFileOptions</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TempFileOptions</span> <span class='hs-layout'>{</span> <span class='hs-varid'>optKeepTempFiles</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span>
<a name="line-1408"></a>
<a name="line-1409"></a><a name="withTempFile"></a><span class='hs-comment'>-- | Use a temporary filename that doesn't already exist.</span>
<a name="line-1410"></a><span class='hs-comment'>--</span>
<a name="line-1411"></a><span class='hs-definition'>withTempFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>    <span class='hs-comment'>-- ^ Temp dir to create the file in</span>
<a name="line-1412"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>   <span class='hs-comment'>-- ^ File name template. See 'openTempFile'.</span>
<a name="line-1413"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1414"></a><span class='hs-definition'>withTempFile</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>template</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span>
<a name="line-1415"></a>  <span class='hs-varid'>withTempFileEx</span> <span class='hs-varid'>defaultTempFileOptions</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>template</span> <span class='hs-varid'>action</span>
<a name="line-1416"></a>
<a name="line-1417"></a><a name="withTempFileEx"></a><span class='hs-comment'>-- | A version of 'withTempFile' that additionally takes a 'TempFileOptions'</span>
<a name="line-1418"></a><span class='hs-comment'>-- argument.</span>
<a name="line-1419"></a><span class='hs-definition'>withTempFileEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TempFileOptions</span>
<a name="line-1420"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-comment'>-- ^ Temp dir to create the file in</span>
<a name="line-1421"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>   <span class='hs-comment'>-- ^ File name template. See 'openTempFile'.</span>
<a name="line-1422"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1423"></a><span class='hs-definition'>withTempFileEx</span> <span class='hs-varid'>opts</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>template</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span>
<a name="line-1424"></a>  <span class='hs-conid'>Exception.bracket</span>
<a name="line-1425"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>openTempFile</span> <span class='hs-varid'>tmpDir</span> <span class='hs-varid'>template</span><span class='hs-layout'>)</span>
<a name="line-1426"></a>    <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>handle</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>hClose</span> <span class='hs-varid'>handle</span>
<a name="line-1427"></a>                           <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>optKeepTempFiles</span> <span class='hs-varid'>opts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1428"></a>                             <span class='hs-varid'>handleDoesNotExist</span> <span class='hs-conid'>()</span> <span class='hs-varop'>.</span> <span class='hs-varid'>removeFile</span> <span class='hs-varop'>$</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1429"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>withLexicalCallStack</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>uncurry</span> <span class='hs-varid'>action</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1430"></a>
<a name="line-1431"></a><a name="withTempDirectory"></a><span class='hs-comment'>-- | Create and use a temporary directory.</span>
<a name="line-1432"></a><span class='hs-comment'>--</span>
<a name="line-1433"></a><span class='hs-comment'>-- Creates a new temporary directory inside the given directory, making use</span>
<a name="line-1434"></a><span class='hs-comment'>-- of the template. The temp directory is deleted after use. For example:</span>
<a name="line-1435"></a><span class='hs-comment'>--</span>
<a name="line-1436"></a><span class='hs-comment'>-- &gt; withTempDirectory verbosity "src" "sdist." $ \tmpDir -&gt; do ...</span>
<a name="line-1437"></a><span class='hs-comment'>--</span>
<a name="line-1438"></a><span class='hs-comment'>-- The @tmpDir@ will be a new subdirectory of the given directory, e.g.</span>
<a name="line-1439"></a><span class='hs-comment'>-- @src/sdist.342@.</span>
<a name="line-1440"></a><span class='hs-comment'>--</span>
<a name="line-1441"></a><span class='hs-definition'>withTempDirectory</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1442"></a><span class='hs-definition'>withTempDirectory</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>template</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-1443"></a>  <span class='hs-varid'>withTempDirectoryEx</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>defaultTempFileOptions</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>template</span>
<a name="line-1444"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>withLexicalCallStack</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1445"></a>
<a name="line-1446"></a><a name="withTempDirectoryEx"></a><span class='hs-comment'>-- | A version of 'withTempDirectory' that additionally takes a</span>
<a name="line-1447"></a><span class='hs-comment'>-- 'TempFileOptions' argument.</span>
<a name="line-1448"></a><span class='hs-definition'>withTempDirectoryEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TempFileOptions</span>
<a name="line-1449"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-1450"></a><span class='hs-definition'>withTempDirectoryEx</span> <span class='hs-sel'>_verbosity</span> <span class='hs-varid'>opts</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>template</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withFrozenCallStack</span> <span class='hs-varop'>$</span>
<a name="line-1451"></a>  <span class='hs-conid'>Exception.bracket</span>
<a name="line-1452"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>createTempDirectory</span> <span class='hs-varid'>targetDir</span> <span class='hs-varid'>template</span><span class='hs-layout'>)</span>
<a name="line-1453"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>optKeepTempFiles</span> <span class='hs-varid'>opts</span><span class='hs-layout'>)</span>
<a name="line-1454"></a>     <span class='hs-varop'>.</span> <span class='hs-varid'>handleDoesNotExist</span> <span class='hs-conid'>()</span> <span class='hs-varop'>.</span> <span class='hs-varid'>removeDirectoryRecursive</span><span class='hs-layout'>)</span>
<a name="line-1455"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>withLexicalCallStack</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>f</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1456"></a>
<a name="line-1457"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-1458"></a><span class='hs-comment'>-- Safely reading and writing files</span>
<a name="line-1459"></a>
<a name="line-1460"></a><a name="rewriteFileEx"></a><span class='hs-comment'>-- | Write a file but only if it would have new content. If we would be writing</span>
<a name="line-1461"></a><span class='hs-comment'>-- the same as the existing content then leave the file as is so that we do not</span>
<a name="line-1462"></a><span class='hs-comment'>-- update the file's modification time.</span>
<a name="line-1463"></a><span class='hs-comment'>--</span>
<a name="line-1464"></a><span class='hs-comment'>-- NB: Before Cabal-3.0 the file content was assumed to be</span>
<a name="line-1465"></a><span class='hs-comment'>--     ASCII-representable. Since Cabal-3.0 the file is assumed to be</span>
<a name="line-1466"></a><span class='hs-comment'>--     UTF-8 encoded.</span>
<a name="line-1467"></a><span class='hs-definition'>rewriteFileEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1468"></a><span class='hs-definition'>rewriteFileEx</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span>
<a name="line-1469"></a>  <span class='hs-varid'>rewriteFileLBS</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varop'>.</span> <span class='hs-varid'>toUTF8LBS</span>
<a name="line-1470"></a>
<a name="line-1471"></a><a name="rewriteFileLBS"></a><span class='hs-comment'>-- | Same as `rewriteFileEx` but for 'ByteString's.</span>
<a name="line-1472"></a><span class='hs-definition'>rewriteFileLBS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BS.ByteString</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1473"></a><span class='hs-definition'>rewriteFileLBS</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>path</span> <span class='hs-varid'>newContent</span> <span class='hs-keyglyph'>=</span>
<a name="line-1474"></a>  <span class='hs-varid'>flip</span> <span class='hs-varid'>catchIO</span> <span class='hs-varid'>mightNotExist</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1475"></a>    <span class='hs-varid'>existingContent</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>annotateIO</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-conid'>BS.readFile</span> <span class='hs-varid'>path</span>
<a name="line-1476"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>evaluate</span> <span class='hs-layout'>(</span><span class='hs-conid'>BS.length</span> <span class='hs-varid'>existingContent</span><span class='hs-layout'>)</span>
<a name="line-1477"></a>    <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>existingContent</span> <span class='hs-varop'>==</span> <span class='hs-varid'>newContent</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1478"></a>      <span class='hs-varid'>annotateIO</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span>
<a name="line-1479"></a>        <span class='hs-varid'>writeFileAtomic</span> <span class='hs-varid'>path</span> <span class='hs-varid'>newContent</span>
<a name="line-1480"></a>  <span class='hs-keyword'>where</span>
<a name="line-1481"></a>    <span class='hs-varid'>mightNotExist</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDoesNotExistError</span> <span class='hs-varid'>e</span>
<a name="line-1482"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annotateIO</span> <span class='hs-varid'>verbosity</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeFileAtomic</span> <span class='hs-varid'>path</span> <span class='hs-varid'>newContent</span>
<a name="line-1483"></a>                    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1484"></a>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioError</span> <span class='hs-varid'>e</span>
<a name="line-1485"></a>
<a name="line-1486"></a>
<a name="line-1487"></a><a name="currentDir"></a><span class='hs-comment'>-- | The path name that represents the current directory.</span>
<a name="line-1488"></a><span class='hs-comment'>-- In Unix, it's @\".\"@, but this is system-specific.</span>
<a name="line-1489"></a><span class='hs-comment'>-- (E.g. AmigaOS uses the empty string @\"\"@ for the current directory.)</span>
<a name="line-1490"></a><span class='hs-definition'>currentDir</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>
<a name="line-1491"></a><span class='hs-definition'>currentDir</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"."</span>
<a name="line-1492"></a>
<a name="line-1493"></a><a name="shortRelativePath"></a><span class='hs-definition'>shortRelativePath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1494"></a><span class='hs-definition'>shortRelativePath</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span>
<a name="line-1495"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>dropCommonPrefix</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitDirectories</span> <span class='hs-varid'>from</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitDirectories</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1496"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>stuff</span><span class='hs-layout'>,</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>joinPath</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-str'>".."</span><span class='hs-layout'>)</span> <span class='hs-varid'>stuff</span> <span class='hs-varop'>++</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span>
<a name="line-1497"></a>  <span class='hs-keyword'>where</span>
<a name="line-1498"></a>    <span class='hs-varid'>dropCommonPrefix</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Eq</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1499"></a>    <span class='hs-varid'>dropCommonPrefix</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>y</span><span class='hs-conop'>:</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-1500"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>y</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dropCommonPrefix</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span>
<a name="line-1501"></a>    <span class='hs-varid'>dropCommonPrefix</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>ys</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>xs</span><span class='hs-layout'>,</span><span class='hs-varid'>ys</span><span class='hs-layout'>)</span>
<a name="line-1502"></a>
<a name="line-1503"></a><a name="dropExeExtension"></a><span class='hs-comment'>-- | Drop the extension if it's one of 'exeExtensions', or return the path</span>
<a name="line-1504"></a><span class='hs-comment'>-- unchanged.</span>
<a name="line-1505"></a><span class='hs-definition'>dropExeExtension</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1506"></a><span class='hs-definition'>dropExeExtension</span> <span class='hs-varid'>filepath</span> <span class='hs-keyglyph'>=</span>
<a name="line-1507"></a>  <span class='hs-comment'>-- System.FilePath's extension handling functions are horribly</span>
<a name="line-1508"></a>  <span class='hs-comment'>-- inconsistent, consider:</span>
<a name="line-1509"></a>  <span class='hs-comment'>--</span>
<a name="line-1510"></a>  <span class='hs-comment'>--     isExtensionOf "" "foo"  == False but</span>
<a name="line-1511"></a>  <span class='hs-comment'>--     isExtensionOf "" "foo." == True.</span>
<a name="line-1512"></a>  <span class='hs-comment'>--</span>
<a name="line-1513"></a>  <span class='hs-comment'>-- On the other hand stripExtension doesn't remove the empty extension:</span>
<a name="line-1514"></a>  <span class='hs-comment'>--</span>
<a name="line-1515"></a>  <span class='hs-comment'>--    stripExtension "" "foo." == Just "foo."</span>
<a name="line-1516"></a>  <span class='hs-comment'>--</span>
<a name="line-1517"></a>  <span class='hs-comment'>-- Since by "" in exeExtensions we mean 'no extension' anyways we can</span>
<a name="line-1518"></a>  <span class='hs-comment'>-- just always ignore it here.</span>
<a name="line-1519"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>exts</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>exeExtensions</span><span class='hs-layout'>,</span> <span class='hs-varid'>ext</span> <span class='hs-varop'>/=</span> <span class='hs-str'>""</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>in</span>
<a name="line-1520"></a>  <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>filepath</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1521"></a>    <span class='hs-varid'>ext</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-varop'>`FilePath.isExtensionOf`</span> <span class='hs-varid'>filepath</span><span class='hs-layout'>)</span> <span class='hs-varid'>exts</span>
<a name="line-1522"></a>    <span class='hs-varid'>ext</span> <span class='hs-varop'>`FilePath.stripExtension`</span> <span class='hs-varid'>filepath</span>
<a name="line-1523"></a>
<a name="line-1524"></a><a name="exeExtensions"></a><span class='hs-comment'>-- | List of possible executable file extensions on the current build</span>
<a name="line-1525"></a><span class='hs-comment'>-- platform.</span>
<a name="line-1526"></a><span class='hs-definition'>exeExtensions</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span>
<a name="line-1527"></a><span class='hs-definition'>exeExtensions</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>buildOS</span> <span class='hs-keyword'>of</span>
<a name="line-1528"></a>  <span class='hs-comment'>-- Possible improvement: on Windows, read the list of extensions from the</span>
<a name="line-1529"></a>  <span class='hs-comment'>-- PATHEXT environment variable. By default PATHEXT is ".com; .exe; .bat;</span>
<a name="line-1530"></a>  <span class='hs-comment'>-- .cmd".</span>
<a name="line-1531"></a>  <span class='hs-conid'>Windows</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>""</span><span class='hs-layout'>,</span> <span class='hs-str'>"exe"</span><span class='hs-keyglyph'>]</span>
<a name="line-1532"></a>  <span class='hs-conid'>Ghcjs</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>""</span><span class='hs-layout'>,</span> <span class='hs-str'>"exe"</span><span class='hs-keyglyph'>]</span>
<a name="line-1533"></a>  <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-str'>""</span><span class='hs-keyglyph'>]</span>
<a name="line-1534"></a>
<a name="line-1535"></a><span class='hs-comment'>-- ------------------------------------------------------------</span>
<a name="line-1536"></a><span class='hs-comment'>-- * Finding the description file</span>
<a name="line-1537"></a><span class='hs-comment'>-- ------------------------------------------------------------</span>
<a name="line-1538"></a>
<a name="line-1539"></a><a name="defaultPackageDesc"></a><span class='hs-comment'>-- | Package description file (/pkgname/@.cabal@)</span>
<a name="line-1540"></a><span class='hs-definition'>defaultPackageDesc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1541"></a><span class='hs-definition'>defaultPackageDesc</span> <span class='hs-varid'>verbosity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryFindPackageDesc</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>currentDir</span>
<a name="line-1542"></a>
<a name="line-1543"></a><a name="findPackageDesc"></a><span class='hs-comment'>-- |Find a package description file in the given directory.  Looks for</span>
<a name="line-1544"></a><span class='hs-comment'>-- @.cabal@ files.</span>
<a name="line-1545"></a><span class='hs-definition'>findPackageDesc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>                    <span class='hs-comment'>-- ^Where to look</span>
<a name="line-1546"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>String</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^&lt;pkgname&gt;.cabal</span>
<a name="line-1547"></a><span class='hs-definition'>findPackageDesc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findPackageDescCwd</span> <span class='hs-str'>"."</span>
<a name="line-1548"></a>
<a name="line-1549"></a><a name="findPackageDescCwd"></a><span class='hs-comment'>-- | @since 3.4.0.0</span>
<a name="line-1550"></a><span class='hs-definition'>findPackageDescCwd</span>
<a name="line-1551"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>                    <span class='hs-comment'>-- ^ project root</span>
<a name="line-1552"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>                    <span class='hs-comment'>-- ^ relative directory</span>
<a name="line-1553"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>String</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ &lt;pkgname&gt;.cabal relative to the project root</span>
<a name="line-1554"></a><span class='hs-definition'>findPackageDescCwd</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>dir</span>
<a name="line-1555"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDirectoryContents</span> <span class='hs-layout'>(</span><span class='hs-varid'>cwd</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>dir</span><span class='hs-layout'>)</span>
<a name="line-1556"></a>      <span class='hs-comment'>-- to make sure we do not mistake a ~/.cabal/ dir for a &lt;pkgname&gt;.cabal</span>
<a name="line-1557"></a>      <span class='hs-comment'>-- file we filter to exclude dirs and null base file names:</span>
<a name="line-1558"></a>      <span class='hs-varid'>cabalFiles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterM</span> <span class='hs-layout'>(</span><span class='hs-varid'>doesFileExist</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span>
<a name="line-1559"></a>                       <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>file</span><span class='hs-layout'>,</span> <span class='hs-varid'>cwd</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>file</span><span class='hs-layout'>)</span>
<a name="line-1560"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>files</span>
<a name="line-1561"></a>                       <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ext</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitExtension</span> <span class='hs-varid'>file</span>
<a name="line-1562"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ext</span> <span class='hs-varop'>==</span> <span class='hs-str'>".cabal"</span> <span class='hs-keyglyph'>]</span>
<a name="line-1563"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>cabalFiles</span> <span class='hs-keyword'>of</span>
<a name="line-1564"></a>        <span class='hs-conid'>[]</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span>  <span class='hs-varid'>noDesc</span><span class='hs-layout'>)</span>
<a name="line-1565"></a>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>cabalFile</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>cabalFile</span><span class='hs-layout'>)</span>
<a name="line-1566"></a>        <span class='hs-varid'>multiple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span>  <span class='hs-varop'>$</span> <span class='hs-varid'>multiDesc</span> <span class='hs-varid'>multiple</span><span class='hs-layout'>)</span>
<a name="line-1567"></a>
<a name="line-1568"></a>  <span class='hs-keyword'>where</span>
<a name="line-1569"></a>    <span class='hs-varid'>noDesc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>
<a name="line-1570"></a>    <span class='hs-varid'>noDesc</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"No cabal file found.\n"</span>
<a name="line-1571"></a>             <span class='hs-varop'>++</span> <span class='hs-str'>"Please create a package description file &lt;pkgname&gt;.cabal"</span>
<a name="line-1572"></a>
<a name="line-1573"></a>    <span class='hs-varid'>multiDesc</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-1574"></a>    <span class='hs-varid'>multiDesc</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Multiple cabal files found.\n"</span>
<a name="line-1575"></a>                  <span class='hs-varop'>++</span> <span class='hs-str'>"Please use only one of: "</span>
<a name="line-1576"></a>                  <span class='hs-varop'>++</span> <span class='hs-varid'>intercalate</span> <span class='hs-str'>", "</span> <span class='hs-varid'>l</span>
<a name="line-1577"></a>
<a name="line-1578"></a><a name="tryFindPackageDesc"></a><span class='hs-comment'>-- |Like 'findPackageDesc', but calls 'die' in case of error.</span>
<a name="line-1579"></a><span class='hs-definition'>tryFindPackageDesc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1580"></a><span class='hs-definition'>tryFindPackageDesc</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span>
<a name="line-1581"></a>  <span class='hs-varid'>either</span> <span class='hs-layout'>(</span><span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>findPackageDesc</span> <span class='hs-varid'>dir</span>
<a name="line-1582"></a>
<a name="line-1583"></a><a name="tryFindPackageDescCwd"></a><span class='hs-comment'>-- | Like 'findPackageDescCwd', but calls 'die' in case of error.</span>
<a name="line-1584"></a><span class='hs-comment'>--</span>
<a name="line-1585"></a><span class='hs-comment'>-- @since 3.4.0.0</span>
<a name="line-1586"></a><span class='hs-definition'>tryFindPackageDescCwd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>FilePath</span>
<a name="line-1587"></a><span class='hs-definition'>tryFindPackageDescCwd</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span>
<a name="line-1588"></a>  <span class='hs-varid'>either</span> <span class='hs-layout'>(</span><span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>findPackageDescCwd</span> <span class='hs-varid'>cwd</span> <span class='hs-varid'>dir</span>
<a name="line-1589"></a>
<a name="line-1590"></a><a name="findHookedPackageDesc"></a><span class='hs-comment'>-- |Find auxiliary package information in the given directory.</span>
<a name="line-1591"></a><span class='hs-comment'>-- Looks for @.buildinfo@ files.</span>
<a name="line-1592"></a><span class='hs-definition'>findHookedPackageDesc</span>
<a name="line-1593"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verbosity</span>
<a name="line-1594"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>                 <span class='hs-comment'>-- ^Directory to search</span>
<a name="line-1595"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>      <span class='hs-comment'>-- ^/dir/@\/@/pkgname/@.buildinfo@, if present</span>
<a name="line-1596"></a><span class='hs-definition'>findHookedPackageDesc</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dir</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1597"></a>    <span class='hs-varid'>files</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDirectoryContents</span> <span class='hs-varid'>dir</span>
<a name="line-1598"></a>    <span class='hs-varid'>buildInfoFiles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterM</span> <span class='hs-varid'>doesFileExist</span>
<a name="line-1599"></a>                        <span class='hs-keyglyph'>[</span> <span class='hs-varid'>dir</span> <span class='hs-varop'>&lt;/&gt;</span> <span class='hs-varid'>file</span>
<a name="line-1600"></a>                        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>file</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>files</span>
<a name="line-1601"></a>                        <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ext</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitExtension</span> <span class='hs-varid'>file</span>
<a name="line-1602"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>ext</span> <span class='hs-varop'>==</span> <span class='hs-varid'>buildInfoExt</span> <span class='hs-keyglyph'>]</span>
<a name="line-1603"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>buildInfoFiles</span> <span class='hs-keyword'>of</span>
<a name="line-1604"></a>        <span class='hs-conid'>[]</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1605"></a>        <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span>
<a name="line-1606"></a>        <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>die'</span> <span class='hs-varid'>verbosity</span> <span class='hs-layout'>(</span><span class='hs-str'>"Multiple files with extension "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>buildInfoExt</span><span class='hs-layout'>)</span>
<a name="line-1607"></a>
<a name="line-1608"></a><a name="buildInfoExt"></a><span class='hs-definition'>buildInfoExt</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>
<a name="line-1609"></a><span class='hs-definition'>buildInfoExt</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>".buildinfo"</span>
</pre></body>
</html>

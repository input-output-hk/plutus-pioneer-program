<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/IO/Handle/Internals.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE Trustworthy #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE NoImplicitPrelude
<a name="line-3"></a>           , RecordWildCards
<a name="line-4"></a>           , BangPatterns
<a name="line-5"></a>           , NondecreasingIndentation
<a name="line-6"></a>           , RankNTypes
<a name="line-7"></a>  #-}</span>
<a name="line-8"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-unused-matches #-}</span>
<a name="line-9"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-name-shadowing #-}</span>
<a name="line-10"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span>
<a name="line-11"></a><span class='hs-comment'>{-# OPTIONS_HADDOCK not-home #-}</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-14"></a><span class='hs-comment'>-- |</span>
<a name="line-15"></a><span class='hs-comment'>-- Module      :  GHC.IO.Handle.Internals</span>
<a name="line-16"></a><span class='hs-comment'>-- Copyright   :  (c) The University of Glasgow, 1994-2001</span>
<a name="line-17"></a><span class='hs-comment'>-- License     :  see libraries/base/LICENSE</span>
<a name="line-18"></a><span class='hs-comment'>--</span>
<a name="line-19"></a><span class='hs-comment'>-- Maintainer  :  libraries@haskell.org</span>
<a name="line-20"></a><span class='hs-comment'>-- Stability   :  internal</span>
<a name="line-21"></a><span class='hs-comment'>-- Portability :  non-portable</span>
<a name="line-22"></a><span class='hs-comment'>--</span>
<a name="line-23"></a><span class='hs-comment'>-- This module defines the basic operations on I\/O \"handles\".  All</span>
<a name="line-24"></a><span class='hs-comment'>-- of the operations defined here are independent of the underlying</span>
<a name="line-25"></a><span class='hs-comment'>-- device.</span>
<a name="line-26"></a><span class='hs-comment'>--</span>
<a name="line-27"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-28"></a>
<a name="line-29"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.IO.Handle.Internals</span> <span class='hs-layout'>(</span>
<a name="line-30"></a>  <span class='hs-varid'>withHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>withHandle'</span><span class='hs-layout'>,</span> <span class='hs-varid'>withHandle_</span><span class='hs-layout'>,</span>
<a name="line-31"></a>  <span class='hs-varid'>withHandle__'</span><span class='hs-layout'>,</span> <span class='hs-varid'>withHandle_'</span><span class='hs-layout'>,</span> <span class='hs-varid'>withAllHandles__</span><span class='hs-layout'>,</span>
<a name="line-32"></a>  <span class='hs-varid'>wantWritableHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>wantReadableHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>wantReadableHandle_</span><span class='hs-layout'>,</span>
<a name="line-33"></a>  <span class='hs-varid'>wantSeekableHandle</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>  <span class='hs-varid'>mkHandle</span><span class='hs-layout'>,</span>
<a name="line-36"></a>  <span class='hs-varid'>mkFileHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFileHandleNoFinalizer</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDuplexHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkDuplexHandleNoFinalizer</span><span class='hs-layout'>,</span>
<a name="line-37"></a>  <span class='hs-varid'>addHandleFinalizer</span><span class='hs-layout'>,</span>
<a name="line-38"></a>  <span class='hs-varid'>openTextEncoding</span><span class='hs-layout'>,</span> <span class='hs-varid'>closeTextCodecs</span><span class='hs-layout'>,</span> <span class='hs-varid'>initBufferState</span><span class='hs-layout'>,</span>
<a name="line-39"></a>  <span class='hs-varid'>dEFAULT_CHAR_BUFFER_SIZE</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>  <span class='hs-varid'>flushBuffer</span><span class='hs-layout'>,</span> <span class='hs-varid'>flushWriteBuffer</span><span class='hs-layout'>,</span> <span class='hs-varid'>flushCharReadBuffer</span><span class='hs-layout'>,</span>
<a name="line-42"></a>  <span class='hs-varid'>flushCharBuffer</span><span class='hs-layout'>,</span> <span class='hs-varid'>flushByteReadBuffer</span><span class='hs-layout'>,</span> <span class='hs-varid'>flushByteWriteBuffer</span><span class='hs-layout'>,</span>
<a name="line-43"></a>
<a name="line-44"></a>  <span class='hs-varid'>readTextDevice</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeCharBuffer</span><span class='hs-layout'>,</span> <span class='hs-varid'>readTextDeviceNonBlocking</span><span class='hs-layout'>,</span>
<a name="line-45"></a>  <span class='hs-varid'>decodeByteBuf</span><span class='hs-layout'>,</span>
<a name="line-46"></a>
<a name="line-47"></a>  <span class='hs-varid'>augmentIOError</span><span class='hs-layout'>,</span>
<a name="line-48"></a>  <span class='hs-varid'>ioe_closedHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_semiclosedHandle</span><span class='hs-layout'>,</span>
<a name="line-49"></a>  <span class='hs-varid'>ioe_EOF</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_notReadable</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_notWritable</span><span class='hs-layout'>,</span>
<a name="line-50"></a>  <span class='hs-varid'>ioe_finalizedHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_bufsiz</span><span class='hs-layout'>,</span>
<a name="line-51"></a>
<a name="line-52"></a>  <span class='hs-varid'>hClose_impl</span><span class='hs-layout'>,</span> <span class='hs-varid'>hClose_help</span><span class='hs-layout'>,</span> <span class='hs-varid'>hLookAhead_</span><span class='hs-layout'>,</span>
<a name="line-53"></a>
<a name="line-54"></a>  <span class='hs-conid'>HandleFinalizer</span><span class='hs-layout'>,</span> <span class='hs-varid'>handleFinalizer</span><span class='hs-layout'>,</span>
<a name="line-55"></a>
<a name="line-56"></a>  <span class='hs-varid'>debugIO</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceIO</span>
<a name="line-57"></a> <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-58"></a>
<a name="line-59"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO</span>
<a name="line-60"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.IOMode</span>
<a name="line-61"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Encoding</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Encoding</span>
<a name="line-62"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Encoding.Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>CodeBuffer</span><span class='hs-layout'>)</span>
<a name="line-63"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Handle.Types</span>
<a name="line-64"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Buffer</span>
<a name="line-65"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.BufferedIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>BufferedIO</span><span class='hs-layout'>)</span>
<a name="line-66"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Exception</span>
<a name="line-67"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Device</span> <span class='hs-layout'>(</span><span class='hs-conid'>IODevice</span><span class='hs-layout'>,</span> <span class='hs-conid'>RawIO</span><span class='hs-layout'>,</span> <span class='hs-conid'>SeekMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-68"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.SubSystem</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&lt;!&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>isWindowsNativeIO</span><span class='hs-layout'>)</span>
<a name="line-69"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.IO.Device</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>IODevice</span>
<a name="line-70"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.IO.BufferedIO</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Buffered</span>
<a name="line-71"></a>
<a name="line-72"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Conc.Sync</span>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Real</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Base</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Exception</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Num</span>          <span class='hs-layout'>(</span> <span class='hs-conid'>Num</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Show</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IORef</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.MVar</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Typeable</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Maybe</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Posix.Internals</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-conid'>FD</span><span class='hs-layout'>)</span>
<a name="line-84"></a>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C</span>
<a name="line-86"></a>
<a name="line-87"></a><a name="c_DEBUG_DUMP"></a><span class='hs-definition'>c_DEBUG_DUMP</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-88"></a><span class='hs-definition'>c_DEBUG_DUMP</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-91"></a><span class='hs-comment'>-- Creating a new handle</span>
<a name="line-92"></a>
<a name="line-93"></a><a name="HandleFinalizer"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>HandleFinalizer</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-94"></a>
<a name="line-95"></a><a name="addHandleFinalizer"></a><span class='hs-comment'>-- | Add a finalizer to a 'Handle'. Specifically, the finalizer</span>
<a name="line-96"></a><span class='hs-comment'>-- will be added to the 'MVar' of a file handle or the write-side</span>
<a name="line-97"></a><span class='hs-comment'>-- 'MVar' of a duplex handle. See Handle Finalizers for details.</span>
<a name="line-98"></a><span class='hs-definition'>addHandleFinalizer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandleFinalizer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-99"></a><span class='hs-definition'>addHandleFinalizer</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>finalizer</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-100"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Registering finalizer: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>filepath</span>
<a name="line-101"></a>  <span class='hs-varid'>addMVarFinalizer</span> <span class='hs-varid'>mv</span> <span class='hs-layout'>(</span><span class='hs-varid'>finalizer</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>mv</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyword'>where</span>
<a name="line-103"></a>    <span class='hs-varop'>!</span><span class='hs-layout'>(</span><span class='hs-varid'>filepath</span><span class='hs-layout'>,</span> <span class='hs-varop'>!</span><span class='hs-varid'>mv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>handle</span> <span class='hs-keyword'>of</span>
<a name="line-104"></a>      <span class='hs-conid'>FileHandle</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fp</span><span class='hs-layout'>,</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-105"></a>      <span class='hs-conid'>DuplexHandle</span> <span class='hs-varid'>fp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>write_m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fp</span><span class='hs-layout'>,</span> <span class='hs-varid'>write_m</span><span class='hs-layout'>)</span>
<a name="line-106"></a>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-109"></a><span class='hs-comment'>-- Working with Handles</span>
<a name="line-110"></a>
<a name="line-111"></a><span class='hs-comment'>{-
<a name="line-112"></a>In the concurrent world, handles are locked during use.  This is done
<a name="line-113"></a>by wrapping an MVar around the handle which acts as a mutex over
<a name="line-114"></a>operations on the handle.
<a name="line-115"></a>
<a name="line-116"></a>To avoid races, we use the following bracketing operations.  The idea
<a name="line-117"></a>is to obtain the lock, do some operation and replace the lock again,
<a name="line-118"></a>whether the operation succeeded or failed.  We also want to handle the
<a name="line-119"></a>case where the thread receives an exception while processing the IO
<a name="line-120"></a>operation: in these cases we also want to relinquish the lock.
<a name="line-121"></a>
<a name="line-122"></a>There are three versions of @withHandle@: corresponding to the three
<a name="line-123"></a>possible combinations of:
<a name="line-124"></a>
<a name="line-125"></a>        - the operation may side-effect the handle
<a name="line-126"></a>        - the operation may return a result
<a name="line-127"></a>
<a name="line-128"></a>If the operation generates an error or an exception is raised, the
<a name="line-129"></a>original handle is always replaced.
<a name="line-130"></a>-}</span>
<a name="line-131"></a>
<a name="line-132"></a><a name="withHandle"></a><span class='hs-comment'>{-# INLINE withHandle #-}</span>
<a name="line-133"></a><span class='hs-definition'>withHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-134"></a><span class='hs-definition'>withHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>     <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-135"></a><span class='hs-definition'>withHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-136"></a>
<a name="line-137"></a><a name="withHandle'"></a><span class='hs-definition'>withHandle'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span>
<a name="line-138"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-139"></a><span class='hs-definition'>withHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span>
<a name="line-140"></a> <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-141"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>h'</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_operation</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>act</span> <span class='hs-varid'>m</span>
<a name="line-142"></a>   <span class='hs-varid'>checkHandleInvariants</span> <span class='hs-varid'>h'</span>
<a name="line-143"></a>   <span class='hs-varid'>putMVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>h'</span>
<a name="line-144"></a>   <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-145"></a>
<a name="line-146"></a><a name="withHandle_"></a><span class='hs-comment'>{-# INLINE withHandle_ #-}</span>
<a name="line-147"></a><span class='hs-definition'>withHandle_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-148"></a><span class='hs-definition'>withHandle_</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>     <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle_'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-149"></a><span class='hs-definition'>withHandle_</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle_'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="withHandle_'"></a><span class='hs-definition'>withHandle_'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-152"></a><span class='hs-definition'>withHandle_'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>h_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-153"></a>                              <span class='hs-varid'>a</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span>
<a name="line-154"></a>                              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>h_</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-155"></a>
<a name="line-156"></a><a name="withAllHandles__"></a><span class='hs-definition'>withAllHandles__</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle__</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-157"></a><span class='hs-definition'>withAllHandles__</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>     <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle__'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-158"></a><span class='hs-definition'>withAllHandles__</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-159"></a>  <span class='hs-varid'>withHandle__'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>r</span> <span class='hs-varid'>act</span>
<a name="line-160"></a>  <span class='hs-varid'>withHandle__'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>w</span> <span class='hs-varid'>act</span>
<a name="line-161"></a>
<a name="line-162"></a><a name="withHandle__'"></a><span class='hs-definition'>withHandle__'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle__</span><span class='hs-layout'>)</span>
<a name="line-163"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-164"></a><span class='hs-definition'>withHandle__'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span>
<a name="line-165"></a> <span class='hs-varid'>mask_</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-166"></a>   <span class='hs-varid'>h'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>do_operation</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>act</span> <span class='hs-varid'>m</span>
<a name="line-167"></a>   <span class='hs-varid'>checkHandleInvariants</span> <span class='hs-varid'>h'</span>
<a name="line-168"></a>   <span class='hs-varid'>putMVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>h'</span>
<a name="line-169"></a>   <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-170"></a>
<a name="line-171"></a><a name="do_operation"></a><span class='hs-definition'>do_operation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-172"></a><span class='hs-definition'>do_operation</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>act</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-173"></a>  <span class='hs-varid'>h_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>m</span>
<a name="line-174"></a>  <span class='hs-varid'>checkHandleInvariants</span> <span class='hs-varid'>h_</span>
<a name="line-175"></a>  <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span> <span class='hs-varop'>`catchException`</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>h_</span>
<a name="line-176"></a>  <span class='hs-keyword'>where</span>
<a name="line-177"></a>    <span class='hs-varid'>handler</span> <span class='hs-varid'>h_</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-178"></a>      <span class='hs-varid'>putMVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>h_</span>
<a name="line-179"></a>      <span class='hs-keyword'>case</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>of</span>
<a name="line-180"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-181"></a>            <span class='hs-varid'>ioError</span> <span class='hs-layout'>(</span><span class='hs-varid'>augmentIOError</span> <span class='hs-varid'>ioe</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-182"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>async_ex</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- see Note [async]</span>
<a name="line-183"></a>            <span class='hs-keyword'>let</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>async_ex</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeAsyncException</span>
<a name="line-184"></a>            <span class='hs-varid'>t</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>myThreadId</span>
<a name="line-185"></a>            <span class='hs-varid'>throwTo</span> <span class='hs-varid'>t</span> <span class='hs-varid'>e</span>
<a name="line-186"></a>            <span class='hs-varid'>do_operation</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>act</span> <span class='hs-varid'>m</span>
<a name="line-187"></a>        <span class='hs-sel'>_otherwise</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-188"></a>            <span class='hs-varid'>throwIO</span> <span class='hs-varid'>e</span>
<a name="line-189"></a>
<a name="line-190"></a><span class='hs-comment'>-- Note [async]</span>
<a name="line-191"></a><span class='hs-comment'>--</span>
<a name="line-192"></a><span class='hs-comment'>-- If an asynchronous exception is raised during an I/O operation,</span>
<a name="line-193"></a><span class='hs-comment'>-- normally it is fine to just re-throw the exception synchronously.</span>
<a name="line-194"></a><span class='hs-comment'>-- However, if we are inside an unsafePerformIO or an</span>
<a name="line-195"></a><span class='hs-comment'>-- unsafeInterleaveIO, this would replace the enclosing thunk with the</span>
<a name="line-196"></a><span class='hs-comment'>-- exception raised, which is wrong (#3997).  We have to release the</span>
<a name="line-197"></a><span class='hs-comment'>-- lock on the Handle, but what do we replace the thunk with?  What</span>
<a name="line-198"></a><span class='hs-comment'>-- should happen when the thunk is subsequently demanded again?</span>
<a name="line-199"></a><span class='hs-comment'>--</span>
<a name="line-200"></a><span class='hs-comment'>-- The only sensible choice we have is to re-do the IO operation on</span>
<a name="line-201"></a><span class='hs-comment'>-- resumption, but then we have to be careful in the IO library that</span>
<a name="line-202"></a><span class='hs-comment'>-- this is always safe to do.  In particular we should</span>
<a name="line-203"></a><span class='hs-comment'>--</span>
<a name="line-204"></a><span class='hs-comment'>--    never perform any side-effects before an interruptible operation</span>
<a name="line-205"></a><span class='hs-comment'>--</span>
<a name="line-206"></a><span class='hs-comment'>-- because the interruptible operation may raise an asynchronous</span>
<a name="line-207"></a><span class='hs-comment'>-- exception, which may cause the operation and its side effects to be</span>
<a name="line-208"></a><span class='hs-comment'>-- subsequently performed again.</span>
<a name="line-209"></a><span class='hs-comment'>--</span>
<a name="line-210"></a><span class='hs-comment'>-- Re-doing the IO operation is achieved by:</span>
<a name="line-211"></a><span class='hs-comment'>--   - using throwTo to re-throw the asynchronous exception asynchronously</span>
<a name="line-212"></a><span class='hs-comment'>--     in the current thread</span>
<a name="line-213"></a><span class='hs-comment'>--   - on resumption, it will be as if throwTo returns.  In that case, we</span>
<a name="line-214"></a><span class='hs-comment'>--     recursively invoke the original operation (see do_operation above).</span>
<a name="line-215"></a><span class='hs-comment'>--</span>
<a name="line-216"></a><span class='hs-comment'>-- Interruptible operations in the I/O library are:</span>
<a name="line-217"></a><span class='hs-comment'>--    - threadWaitRead/threadWaitWrite</span>
<a name="line-218"></a><span class='hs-comment'>--    - fillReadBuffer/flushWriteBuffer</span>
<a name="line-219"></a><span class='hs-comment'>--    - readTextDevice/writeTextDevice</span>
<a name="line-220"></a>
<a name="line-221"></a><a name="augmentIOError"></a><span class='hs-definition'>augmentIOError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IOException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOException</span>
<a name="line-222"></a><span class='hs-definition'>augmentIOError</span> <span class='hs-varid'>ioe</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>IOError</span><span class='hs-layout'>{</span> <span class='hs-varid'>ioe_filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fp</span> <span class='hs-layout'>}</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span>
<a name="line-223"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioe</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ioe_handle</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filepath</span> <span class='hs-layout'>}</span>
<a name="line-224"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>filepath</span>
<a name="line-225"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fp</span>
<a name="line-226"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>h</span> <span class='hs-keyword'>of</span>
<a name="line-227"></a>                          <span class='hs-conid'>FileHandle</span> <span class='hs-varid'>path</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>path</span>
<a name="line-228"></a>                          <span class='hs-conid'>DuplexHandle</span> <span class='hs-varid'>path</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>path</span>
<a name="line-229"></a>
<a name="line-230"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-231"></a><span class='hs-comment'>-- Wrapper for write operations.</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="wantWritableHandle"></a><span class='hs-comment'>-- If we already have a writeable handle just run the action.</span>
<a name="line-234"></a><span class='hs-comment'>-- If we have a read only handle we throw an exception.</span>
<a name="line-235"></a><span class='hs-comment'>-- If we have a read/write handle in read mode we:</span>
<a name="line-236"></a><span class='hs-comment'>-- * Seek to the unread (from the users PoV) position and</span>
<a name="line-237"></a><span class='hs-comment'>--   change the handles buffer to a write buffer.</span>
<a name="line-238"></a><span class='hs-definition'>wantWritableHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-239"></a><span class='hs-definition'>wantWritableHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span>
<a name="line-240"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wantWritableHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-241"></a><span class='hs-definition'>wantWritableHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span>
<a name="line-242"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wantWritableHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-243"></a>    <span class='hs-comment'>-- we know it's not a ReadHandle or ReadWriteHandle, but we have to</span>
<a name="line-244"></a>    <span class='hs-comment'>-- check for ClosedHandle/SemiClosedHandle. (#4808)</span>
<a name="line-245"></a>
<a name="line-246"></a><a name="wantWritableHandle'"></a><span class='hs-definition'>wantWritableHandle'</span>
<a name="line-247"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span>
<a name="line-248"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-249"></a><span class='hs-definition'>wantWritableHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-250"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle_'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkWritableHandle</span> <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-251"></a>
<a name="line-252"></a><a name="checkWritableHandle"></a><span class='hs-definition'>checkWritableHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-253"></a><span class='hs-definition'>checkWritableHandle</span> <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span>
<a name="line-254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>haType</span> <span class='hs-keyword'>of</span>
<a name="line-255"></a>      <span class='hs-conid'>ClosedHandle</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_closedHandle</span>
<a name="line-256"></a>      <span class='hs-conid'>SemiClosedHandle</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_semiclosedHandle</span>
<a name="line-257"></a>      <span class='hs-conid'>ReadHandle</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_notWritable</span>
<a name="line-258"></a>      <span class='hs-conid'>ReadWriteHandle</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-259"></a>        <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-260"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWriteBuffer</span> <span class='hs-varid'>buf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-261"></a>           <span class='hs-varid'>flushCharReadBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-262"></a>           <span class='hs-varid'>flushByteReadBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-263"></a>           <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-264"></a>           <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haCharBuffer</span> <span class='hs-varid'>buf</span><span class='hs-layout'>{</span> <span class='hs-varid'>bufState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WriteBuffer</span> <span class='hs-layout'>}</span>
<a name="line-265"></a>           <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-266"></a>           <span class='hs-varid'>buf'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Buffered.emptyWriteBuffer</span> <span class='hs-varid'>haDevice</span> <span class='hs-varid'>buf</span>
<a name="line-267"></a>           <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>buf'</span>
<a name="line-268"></a>        <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span>
<a name="line-269"></a>      <span class='hs-conid'>AppendHandle</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span>
<a name="line-270"></a>      <span class='hs-conid'>WriteHandle</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span>
<a name="line-271"></a>
<a name="line-272"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-273"></a><span class='hs-comment'>-- Wrapper for read operations.</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="wantReadableHandle"></a><span class='hs-definition'>wantReadableHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>,</span><span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-276"></a><span class='hs-definition'>wantReadableHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span>
<a name="line-277"></a>  <span class='hs-varid'>withHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkReadableHandle</span> <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-278"></a>
<a name="line-279"></a><a name="wantReadableHandle_"></a><span class='hs-definition'>wantReadableHandle_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-280"></a><span class='hs-definition'>wantReadableHandle_</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span>  <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>   <span class='hs-varid'>act</span>
<a name="line-281"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wantReadableHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-282"></a><span class='hs-definition'>wantReadableHandle_</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span>
<a name="line-283"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wantReadableHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-284"></a>    <span class='hs-comment'>-- we know it's not a WriteHandle or ReadWriteHandle, but we have to</span>
<a name="line-285"></a>    <span class='hs-comment'>-- check for ClosedHandle/SemiClosedHandle. (#4808)</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="wantReadableHandle'"></a><span class='hs-definition'>wantReadableHandle'</span>
<a name="line-288"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span>
<a name="line-289"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-290"></a><span class='hs-definition'>wantReadableHandle'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varid'>act</span>
<a name="line-291"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle_'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkReadableHandle</span> <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-292"></a>
<a name="line-293"></a><a name="checkReadableHandle"></a><span class='hs-definition'>checkReadableHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-294"></a><span class='hs-definition'>checkReadableHandle</span> <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-295"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>haType</span> <span class='hs-keyword'>of</span>
<a name="line-296"></a>      <span class='hs-conid'>ClosedHandle</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_closedHandle</span>
<a name="line-297"></a>      <span class='hs-conid'>SemiClosedHandle</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_semiclosedHandle</span>
<a name="line-298"></a>      <span class='hs-conid'>AppendHandle</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_notReadable</span>
<a name="line-299"></a>      <span class='hs-conid'>WriteHandle</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_notReadable</span>
<a name="line-300"></a>      <span class='hs-conid'>ReadWriteHandle</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-301"></a>          <span class='hs-comment'>-- a read/write handle and we want to read from it.  We must</span>
<a name="line-302"></a>          <span class='hs-comment'>-- flush all buffered write data first.</span>
<a name="line-303"></a>          <span class='hs-varid'>bbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-304"></a>          <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWriteBuffer</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-305"></a>             <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>flushByteWriteBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-306"></a>             <span class='hs-varid'>cbuf'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-307"></a>             <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haCharBuffer</span> <span class='hs-varid'>cbuf'</span><span class='hs-layout'>{</span> <span class='hs-varid'>bufState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadBuffer</span> <span class='hs-layout'>}</span>
<a name="line-308"></a>             <span class='hs-varid'>bbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-309"></a>             <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>{</span> <span class='hs-varid'>bufState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadBuffer</span> <span class='hs-layout'>}</span>
<a name="line-310"></a>          <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span>
<a name="line-311"></a>      <span class='hs-sel'>_other</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>act</span> <span class='hs-varid'>h_</span>
<a name="line-312"></a>
<a name="line-313"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-314"></a><span class='hs-comment'>-- Wrapper for seek operations.</span>
<a name="line-315"></a>
<a name="line-316"></a><a name="wantSeekableHandle"></a><span class='hs-definition'>wantSeekableHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-317"></a><span class='hs-definition'>wantSeekableHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-sel'>_act</span> <span class='hs-keyglyph'>=</span>
<a name="line-318"></a>  <span class='hs-varid'>ioException</span> <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-varid'>fun</span>
<a name="line-319"></a>                   <span class='hs-str'>"handle is not seekable"</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-320"></a><span class='hs-definition'>wantSeekableHandle</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span>
<a name="line-321"></a>  <span class='hs-varid'>withHandle_'</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>checkSeekableHandle</span> <span class='hs-varid'>act</span><span class='hs-layout'>)</span>
<a name="line-322"></a>
<a name="line-323"></a><a name="checkSeekableHandle"></a><span class='hs-definition'>checkSeekableHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-324"></a><span class='hs-definition'>checkSeekableHandle</span> <span class='hs-varid'>act</span> <span class='hs-varid'>handle_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-varid'>haDevice</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>dev</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-325"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>haType</span> <span class='hs-varid'>handle_</span> <span class='hs-keyword'>of</span>
<a name="line-326"></a>      <span class='hs-conid'>ClosedHandle</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_closedHandle</span>
<a name="line-327"></a>      <span class='hs-conid'>SemiClosedHandle</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_semiclosedHandle</span>
<a name="line-328"></a>      <span class='hs-conid'>AppendHandle</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioe_notSeekable</span>
<a name="line-329"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>IODevice.isSeekable</span> <span class='hs-varid'>dev</span>
<a name="line-330"></a>              <span class='hs-keyword'>if</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>act</span> <span class='hs-varid'>handle_</span>
<a name="line-331"></a>                   <span class='hs-keyword'>else</span> <span class='hs-varid'>ioe_notSeekable</span>
<a name="line-332"></a>
<a name="line-333"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-334"></a><span class='hs-comment'>-- Handy IOErrors</span>
<a name="line-335"></a>
<a name="line-336"></a><a name="ioe_closedHandle"></a><span class='hs-definition'>ioe_closedHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_semiclosedHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_EOF</span><span class='hs-layout'>,</span>
<a name="line-337"></a>  <span class='hs-varid'>ioe_notReadable</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_notWritable</span><span class='hs-layout'>,</span> <span class='hs-varid'>ioe_cannotFlushNotSeekable</span><span class='hs-layout'>,</span>
<a name="line-338"></a>  <span class='hs-varid'>ioe_notSeekable</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-339"></a>
<a name="line-340"></a><span class='hs-definition'>ioe_closedHandle</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-341"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-str'>""</span>
<a name="line-342"></a>        <span class='hs-str'>"handle is closed"</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-343"></a><a name="ioe_semiclosedHandle"></a><span class='hs-definition'>ioe_semiclosedHandle</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-344"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-str'>""</span>
<a name="line-345"></a>        <span class='hs-str'>"handle is semi-closed"</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-346"></a><a name="ioe_EOF"></a><span class='hs-definition'>ioe_EOF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-347"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>EOF</span> <span class='hs-str'>""</span> <span class='hs-str'>""</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-348"></a><a name="ioe_notReadable"></a><span class='hs-definition'>ioe_notReadable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-349"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-str'>""</span>
<a name="line-350"></a>        <span class='hs-str'>"handle is not open for reading"</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-351"></a><a name="ioe_notWritable"></a><span class='hs-definition'>ioe_notWritable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-352"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-str'>""</span>
<a name="line-353"></a>        <span class='hs-str'>"handle is not open for writing"</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-354"></a><a name="ioe_notSeekable"></a><span class='hs-definition'>ioe_notSeekable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-355"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-str'>""</span>
<a name="line-356"></a>        <span class='hs-str'>"handle is not seekable"</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-357"></a><a name="ioe_cannotFlushNotSeekable"></a><span class='hs-definition'>ioe_cannotFlushNotSeekable</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-358"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-str'>""</span>
<a name="line-359"></a>      <span class='hs-str'>"cannot flush the read buffer: underlying device is not seekable"</span>
<a name="line-360"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-361"></a>
<a name="line-362"></a><a name="ioe_finalizedHandle"></a><span class='hs-definition'>ioe_finalizedHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle__</span>
<a name="line-363"></a><span class='hs-definition'>ioe_finalizedHandle</span> <span class='hs-varid'>fp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throw</span>
<a name="line-364"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>IllegalOperation</span> <span class='hs-str'>""</span>
<a name="line-365"></a>        <span class='hs-str'>"handle is finalized"</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>fp</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="ioe_bufsiz"></a><span class='hs-definition'>ioe_bufsiz</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-368"></a><span class='hs-definition'>ioe_bufsiz</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ioException</span>
<a name="line-369"></a>   <span class='hs-layout'>(</span><span class='hs-conid'>IOError</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>InvalidArgument</span> <span class='hs-str'>"hSetBuffering"</span>
<a name="line-370"></a>        <span class='hs-layout'>(</span><span class='hs-str'>"illegal buffer size "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showsPrec</span> <span class='hs-num'>9</span> <span class='hs-varid'>n</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-371"></a>                                <span class='hs-comment'>-- 9 =&gt; should be parens'ified.</span>
<a name="line-372"></a>
<a name="line-373"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-374"></a><span class='hs-comment'>-- Wrapper for Handle encoding/decoding.</span>
<a name="line-375"></a>
<a name="line-376"></a><span class='hs-comment'>-- The interface for TextEncoding changed so that a TextEncoding doesn't raise</span>
<a name="line-377"></a><span class='hs-comment'>-- an exception if it encounters an invalid sequence. Furthermore, encoding</span>
<a name="line-378"></a><span class='hs-comment'>-- returns a reason as to why encoding stopped, letting us know if it was due</span>
<a name="line-379"></a><span class='hs-comment'>-- to input/output underflow or an invalid sequence.</span>
<a name="line-380"></a><span class='hs-comment'>--</span>
<a name="line-381"></a><span class='hs-comment'>-- This code adapts this elaborated interface back to the original TextEncoding</span>
<a name="line-382"></a><span class='hs-comment'>-- interface.</span>
<a name="line-383"></a><span class='hs-comment'>--</span>
<a name="line-384"></a><span class='hs-comment'>-- FIXME: it is possible that Handle code using the haDecoder/haEncoder fields</span>
<a name="line-385"></a><span class='hs-comment'>-- could be made clearer by using the 'encode' interface directly. I have not</span>
<a name="line-386"></a><span class='hs-comment'>-- looked into this.</span>
<a name="line-387"></a>
<a name="line-388"></a><a name="streamEncode"></a><span class='hs-definition'>streamEncode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BufferCodec</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-varid'>state</span>
<a name="line-389"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Buffer</span> <span class='hs-varid'>from</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Buffer</span> <span class='hs-varid'>to</span>
<a name="line-390"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Buffer</span> <span class='hs-varid'>from</span><span class='hs-layout'>,</span> <span class='hs-conid'>Buffer</span> <span class='hs-varid'>to</span><span class='hs-layout'>)</span>
<a name="line-391"></a><span class='hs-definition'>streamEncode</span> <span class='hs-varid'>codec</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>from'</span><span class='hs-layout'>,</span> <span class='hs-varid'>to'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>from'</span><span class='hs-layout'>,</span> <span class='hs-varid'>to'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>recoveringEncode</span> <span class='hs-varid'>codec</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span>
<a name="line-392"></a>
<a name="line-393"></a><a name="recoveringEncode"></a><span class='hs-comment'>-- | Just like 'encode', but interleaves calls to 'encode' with calls to 'recover' in order to make as much progress as possible</span>
<a name="line-394"></a><span class='hs-definition'>recoveringEncode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BufferCodec</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CodeBuffer</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span>
<a name="line-395"></a><span class='hs-definition'>recoveringEncode</span> <span class='hs-varid'>codec</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span>
<a name="line-396"></a>  <span class='hs-keyword'>where</span>
<a name="line-397"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-398"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>why</span><span class='hs-layout'>,</span> <span class='hs-varid'>from'</span><span class='hs-layout'>,</span> <span class='hs-varid'>to'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>encode</span> <span class='hs-varid'>codec</span> <span class='hs-varid'>from</span> <span class='hs-varid'>to</span>
<a name="line-399"></a>      <span class='hs-comment'>-- When we are dealing with Handles, we don't care about input/output</span>
<a name="line-400"></a>      <span class='hs-comment'>-- underflow particularly, and we want to delay errors about invalid</span>
<a name="line-401"></a>      <span class='hs-comment'>-- sequences as far as possible.</span>
<a name="line-402"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>why</span> <span class='hs-keyword'>of</span>
<a name="line-403"></a>        <span class='hs-conid'>InvalidSequence</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>from</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>from'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-404"></a>          <span class='hs-comment'>-- NB: it is OK to call recover here. Because we saw InvalidSequence, by the invariants</span>
<a name="line-405"></a>          <span class='hs-comment'>-- on "encode" it must be the case that there is at least one elements available in the output</span>
<a name="line-406"></a>          <span class='hs-comment'>-- buffer. Furthermore, clearly there is at least one element in the input buffer since we found</span>
<a name="line-407"></a>          <span class='hs-comment'>-- something invalid there!</span>
<a name="line-408"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>from'</span><span class='hs-layout'>,</span> <span class='hs-varid'>to'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>recover</span> <span class='hs-varid'>codec</span> <span class='hs-varid'>from'</span> <span class='hs-varid'>to'</span>
<a name="line-409"></a>          <span class='hs-varid'>go</span> <span class='hs-varid'>from'</span> <span class='hs-varid'>to'</span>
<a name="line-410"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>why</span><span class='hs-layout'>,</span> <span class='hs-varid'>from'</span><span class='hs-layout'>,</span> <span class='hs-varid'>to'</span><span class='hs-layout'>)</span>
<a name="line-411"></a>
<a name="line-412"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-413"></a><span class='hs-comment'>-- Handle Finalizers</span>
<a name="line-414"></a>
<a name="line-415"></a><span class='hs-comment'>-- For a duplex handle, we arrange that the read side points to the write side</span>
<a name="line-416"></a><span class='hs-comment'>-- (and hence keeps it alive if the read side is alive).  This is done by</span>
<a name="line-417"></a><span class='hs-comment'>-- having the haOtherSide field of the read side point to the read side.</span>
<a name="line-418"></a><span class='hs-comment'>-- The finalizer is then placed on the write side, and the handle only gets</span>
<a name="line-419"></a><span class='hs-comment'>-- finalized once, when both sides are no longer required.</span>
<a name="line-420"></a>
<a name="line-421"></a><span class='hs-comment'>-- NOTE about finalized handles: It's possible that a handle can be</span>
<a name="line-422"></a><span class='hs-comment'>-- finalized and then we try to use it later, for example if the</span>
<a name="line-423"></a><span class='hs-comment'>-- handle is referenced from another finalizer, or from a thread that</span>
<a name="line-424"></a><span class='hs-comment'>-- has become unreferenced and then resurrected (arguably in the</span>
<a name="line-425"></a><span class='hs-comment'>-- latter case we shouldn't finalize the Handle...).  Anyway,</span>
<a name="line-426"></a><span class='hs-comment'>-- we try to emit a helpful message which is better than nothing.</span>
<a name="line-427"></a><span class='hs-comment'>--</span>
<a name="line-428"></a><span class='hs-comment'>-- [later; 8/2010] However, a program like this can yield a strange</span>
<a name="line-429"></a><span class='hs-comment'>-- error message:</span>
<a name="line-430"></a><span class='hs-comment'>--</span>
<a name="line-431"></a><span class='hs-comment'>--   main = writeFile "out" loop</span>
<a name="line-432"></a><span class='hs-comment'>--   loop = let x = x in x</span>
<a name="line-433"></a><span class='hs-comment'>--</span>
<a name="line-434"></a><span class='hs-comment'>-- because the main thread and the Handle are both unreachable at the</span>
<a name="line-435"></a><span class='hs-comment'>-- same time, the Handle may get finalized before the main thread</span>
<a name="line-436"></a><span class='hs-comment'>-- receives the NonTermination exception, and the exception handler</span>
<a name="line-437"></a><span class='hs-comment'>-- will then report an error.  We'd rather this was not an error and</span>
<a name="line-438"></a><span class='hs-comment'>-- the program just prints "&lt;&lt;loop&gt;&gt;".</span>
<a name="line-439"></a>
<a name="line-440"></a><a name="handleFinalizer"></a><span class='hs-definition'>handleFinalizer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-441"></a><span class='hs-definition'>handleFinalizer</span> <span class='hs-varid'>fp</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-442"></a>  <span class='hs-varid'>handle_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>m</span>
<a name="line-443"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>handle_'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hClose_help</span> <span class='hs-varid'>handle_</span>
<a name="line-444"></a>  <span class='hs-varid'>putMVar</span> <span class='hs-varid'>m</span> <span class='hs-varid'>handle_'</span>
<a name="line-445"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-446"></a>
<a name="line-447"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-448"></a><span class='hs-comment'>-- Allocating buffers</span>
<a name="line-449"></a>
<a name="line-450"></a><a name="dEFAULT_CHAR_BUFFER_SIZE"></a><span class='hs-comment'>-- using an 8k char buffer instead of 32k improved performance for a</span>
<a name="line-451"></a><span class='hs-comment'>-- basic "cat" program by ~30% for me.  --SDM</span>
<a name="line-452"></a><span class='hs-definition'>dEFAULT_CHAR_BUFFER_SIZE</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-453"></a><span class='hs-definition'>dEFAULT_CHAR_BUFFER_SIZE</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2048</span> <span class='hs-comment'>-- 8k/sizeof(HsChar)</span>
<a name="line-454"></a>
<a name="line-455"></a><a name="getCharBuffer"></a><span class='hs-definition'>getCharBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IODevice</span> <span class='hs-varid'>dev</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>dev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BufferState</span>
<a name="line-456"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>CharBuffer</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferMode</span><span class='hs-layout'>)</span>
<a name="line-457"></a><span class='hs-definition'>getCharBuffer</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-458"></a>  <span class='hs-varid'>buffer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newCharBuffer</span> <span class='hs-varid'>dEFAULT_CHAR_BUFFER_SIZE</span> <span class='hs-varid'>state</span>
<a name="line-459"></a>  <span class='hs-varid'>ioref</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>buffer</span>
<a name="line-460"></a>  <span class='hs-varid'>is_tty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>IODevice.isTerminal</span> <span class='hs-varid'>dev</span>
<a name="line-461"></a>
<a name="line-462"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>buffer_mode</span>
<a name="line-463"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_tty</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LineBuffering</span>
<a name="line-464"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>BlockBuffering</span> <span class='hs-conid'>Nothing</span>
<a name="line-465"></a>
<a name="line-466"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ioref</span><span class='hs-layout'>,</span> <span class='hs-varid'>buffer_mode</span><span class='hs-layout'>)</span>
<a name="line-467"></a>
<a name="line-468"></a><a name="mkUnBuffer"></a><span class='hs-definition'>mkUnBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>BufferState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-conid'>CharBuffer</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferMode</span><span class='hs-layout'>)</span>
<a name="line-469"></a><span class='hs-definition'>mkUnBuffer</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-470"></a>  <span class='hs-varid'>buffer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newCharBuffer</span> <span class='hs-varid'>dEFAULT_CHAR_BUFFER_SIZE</span> <span class='hs-varid'>state</span>
<a name="line-471"></a>              <span class='hs-comment'>--  See [note Buffer Sizing], GHC.IO.Handle.Types</span>
<a name="line-472"></a>  <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>buffer</span>
<a name="line-473"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ref</span><span class='hs-layout'>,</span> <span class='hs-conid'>NoBuffering</span><span class='hs-layout'>)</span>
<a name="line-474"></a>
<a name="line-475"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-476"></a><span class='hs-comment'>-- Flushing buffers</span>
<a name="line-477"></a>
<a name="line-478"></a><a name="flushBuffer"></a><span class='hs-comment'>-- | syncs the file with the buffer, including moving the</span>
<a name="line-479"></a><span class='hs-comment'>-- file pointer backwards in the case of a read buffer.  This can fail</span>
<a name="line-480"></a><span class='hs-comment'>-- on a non-seekable read Handle.</span>
<a name="line-481"></a><span class='hs-definition'>flushBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-482"></a><span class='hs-definition'>flushBuffer</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-483"></a>  <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-484"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>bufState</span> <span class='hs-varid'>buf</span> <span class='hs-keyword'>of</span>
<a name="line-485"></a>    <span class='hs-conid'>ReadBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-486"></a>        <span class='hs-varid'>flushCharReadBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-487"></a>        <span class='hs-varid'>flushByteReadBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-488"></a>    <span class='hs-conid'>WriteBuffer</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-489"></a>        <span class='hs-varid'>flushByteWriteBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-490"></a>
<a name="line-491"></a><a name="flushCharBuffer"></a><span class='hs-comment'>-- | flushes the Char buffer only.  Works on all Handles.</span>
<a name="line-492"></a><span class='hs-definition'>flushCharBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-493"></a><span class='hs-definition'>flushCharBuffer</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-494"></a>  <span class='hs-varid'>cbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-495"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>bufState</span> <span class='hs-varid'>cbuf</span> <span class='hs-keyword'>of</span>
<a name="line-496"></a>    <span class='hs-conid'>ReadBuffer</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-497"></a>        <span class='hs-varid'>flushCharReadBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-498"></a>    <span class='hs-conid'>WriteBuffer</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-499"></a>        <span class='hs-comment'>-- Nothing to do here. Char buffer on a write Handle is always empty</span>
<a name="line-500"></a>        <span class='hs-comment'>-- between Handle operations.</span>
<a name="line-501"></a>        <span class='hs-comment'>-- See [note Buffer Flushing], GHC.IO.Handle.Types.</span>
<a name="line-502"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>cbuf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-503"></a>           <span class='hs-varid'>error</span> <span class='hs-str'>"internal IO library error: Char buffer non-empty"</span>
<a name="line-504"></a>
<a name="line-505"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-506"></a><span class='hs-comment'>-- Writing data (flushing write buffers)</span>
<a name="line-507"></a>
<a name="line-508"></a><a name="flushWriteBuffer"></a><span class='hs-comment'>-- flushWriteBuffer flushes the byte buffer iff it contains pending write</span>
<a name="line-509"></a><span class='hs-comment'>-- data. Because the Char buffer on a write Handle is always empty between</span>
<a name="line-510"></a><span class='hs-comment'>-- Handle operations (see [note Buffer Flushing], GHC.IO.Handle.Types),</span>
<a name="line-511"></a><span class='hs-comment'>-- both buffers are empty after this.</span>
<a name="line-512"></a><span class='hs-definition'>flushWriteBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-513"></a><span class='hs-definition'>flushWriteBuffer</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-514"></a>  <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-515"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isWriteBuffer</span> <span class='hs-varid'>buf</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>flushByteWriteBuffer</span> <span class='hs-varid'>h_</span>
<a name="line-516"></a>
<a name="line-517"></a><a name="flushByteWriteBuffer"></a><span class='hs-definition'>flushByteWriteBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-518"></a><span class='hs-definition'>flushByteWriteBuffer</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-519"></a>  <span class='hs-varid'>bbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-520"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-521"></a>    <span class='hs-varid'>bbuf'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Buffered.flushWriteBuffer</span> <span class='hs-varid'>haDevice</span> <span class='hs-varid'>bbuf</span>
<a name="line-522"></a>    <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"flushByteWriteBuffer: bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf'</span><span class='hs-layout'>)</span>
<a name="line-523"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf'</span>
<a name="line-524"></a>
<a name="line-525"></a><a name="writeCharBuffer"></a><span class='hs-comment'>-- write the contents of the CharBuffer to the Handle__.</span>
<a name="line-526"></a><span class='hs-comment'>-- The data will be encoded and pushed to the byte buffer,</span>
<a name="line-527"></a><span class='hs-comment'>-- flushing if the buffer becomes full.</span>
<a name="line-528"></a><span class='hs-comment'>-- Data is written to the handles current buffer offset.</span>
<a name="line-529"></a><span class='hs-definition'>writeCharBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CharBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-530"></a><span class='hs-definition'>writeCharBuffer</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-varop'>!</span><span class='hs-varid'>cbuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-531"></a>  <span class='hs-comment'>--</span>
<a name="line-532"></a>  <span class='hs-varid'>bbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-533"></a>
<a name="line-534"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"writeCharBuffer: cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>cbuf</span> <span class='hs-varop'>++</span>
<a name="line-535"></a>        <span class='hs-str'>" bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span>
<a name="line-536"></a>
<a name="line-537"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>cbuf'</span><span class='hs-layout'>,</span><span class='hs-varid'>bbuf'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>haEncoder</span> <span class='hs-keyword'>of</span>
<a name="line-538"></a>    <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>latin1_encode</span> <span class='hs-varid'>cbuf</span> <span class='hs-varid'>bbuf</span>
<a name="line-539"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>encoder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>streamEncode</span> <span class='hs-varid'>encoder</span><span class='hs-layout'>)</span> <span class='hs-varid'>cbuf</span> <span class='hs-varid'>bbuf</span>
<a name="line-540"></a>
<a name="line-541"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"writeCharBuffer after encoding: cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>cbuf'</span> <span class='hs-varop'>++</span>
<a name="line-542"></a>        <span class='hs-str'>" bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf'</span><span class='hs-layout'>)</span>
<a name="line-543"></a>
<a name="line-544"></a>          <span class='hs-comment'>-- flush the byte buffer if it is full</span>
<a name="line-545"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>isFullBuffer</span> <span class='hs-varid'>bbuf'</span>
<a name="line-546"></a>          <span class='hs-comment'>--  or we made no progress</span>
<a name="line-547"></a>     <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>cbuf'</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>cbuf'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>cbuf</span>
<a name="line-548"></a>          <span class='hs-comment'>-- or the byte buffer has more elements than the user wanted buffered</span>
<a name="line-549"></a>     <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>haBufferMode</span> <span class='hs-keyword'>of</span>
<a name="line-550"></a>          <span class='hs-conid'>BlockBuffering</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bufferElems</span> <span class='hs-varid'>bbuf'</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>s</span>
<a name="line-551"></a>          <span class='hs-conid'>NoBuffering</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-552"></a>          <span class='hs-sel'>_other</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-553"></a>    <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-554"></a>      <span class='hs-varid'>bbuf''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Buffered.flushWriteBuffer</span> <span class='hs-varid'>haDevice</span> <span class='hs-varid'>bbuf'</span>
<a name="line-555"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf''</span>
<a name="line-556"></a>      <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"writeCharBuffer after flushing: cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf''</span><span class='hs-layout'>)</span>
<a name="line-557"></a>    <span class='hs-keyword'>else</span>
<a name="line-558"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf'</span>
<a name="line-559"></a>
<a name="line-560"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>cbuf'</span><span class='hs-layout'>)</span>
<a name="line-561"></a>     <span class='hs-keyword'>then</span> <span class='hs-varid'>writeCharBuffer</span> <span class='hs-varid'>h_</span> <span class='hs-varid'>cbuf'</span>
<a name="line-562"></a>     <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-563"></a>
<a name="line-564"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-565"></a><span class='hs-comment'>-- Flushing read buffers</span>
<a name="line-566"></a>
<a name="line-567"></a><a name="flushCharReadBuffer"></a><span class='hs-comment'>-- It is always possible to flush the Char buffer back to the byte buffer.</span>
<a name="line-568"></a><span class='hs-definition'>flushCharReadBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-569"></a><span class='hs-definition'>flushCharReadBuffer</span> <span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-570"></a>  <span class='hs-varid'>cbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-571"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>isWriteBuffer</span> <span class='hs-varid'>cbuf</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>cbuf</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-572"></a>
<a name="line-573"></a>  <span class='hs-comment'>-- haLastDecode is the byte buffer just before we did our last batch of</span>
<a name="line-574"></a>  <span class='hs-comment'>-- decoding.  We're going to re-decode the bytes up to the current char,</span>
<a name="line-575"></a>  <span class='hs-comment'>-- to find out where we should revert the byte buffer to.</span>
<a name="line-576"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>codec_state</span><span class='hs-layout'>,</span> <span class='hs-varid'>bbuf0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haLastDecode</span>
<a name="line-577"></a>
<a name="line-578"></a>  <span class='hs-varid'>cbuf0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-579"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haCharBuffer</span> <span class='hs-varid'>cbuf0</span><span class='hs-layout'>{</span> <span class='hs-varid'>bufL</span><span class='hs-keyglyph'>=</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>bufR</span><span class='hs-keyglyph'>=</span><span class='hs-num'>0</span> <span class='hs-layout'>}</span>
<a name="line-580"></a>
<a name="line-581"></a>  <span class='hs-comment'>-- if we haven't used any characters from the char buffer, then just</span>
<a name="line-582"></a>  <span class='hs-comment'>-- re-install the old byte buffer.</span>
<a name="line-583"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>cbuf0</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-584"></a>     <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf0</span>
<a name="line-585"></a>             <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-586"></a>     <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-587"></a>
<a name="line-588"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>haDecoder</span> <span class='hs-keyword'>of</span>
<a name="line-589"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-590"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf0</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bufL</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>bbuf0</span> <span class='hs-varop'>+</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>cbuf0</span> <span class='hs-layout'>}</span>
<a name="line-591"></a>      <span class='hs-comment'>-- no decoder: the number of bytes to decode is the same as the</span>
<a name="line-592"></a>      <span class='hs-comment'>-- number of chars we have used up.</span>
<a name="line-593"></a>
<a name="line-594"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>decoder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-595"></a>      <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"flushCharReadBuffer re-decode, bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf0</span> <span class='hs-varop'>++</span>
<a name="line-596"></a>               <span class='hs-str'>" cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>cbuf0</span><span class='hs-layout'>)</span>
<a name="line-597"></a>
<a name="line-598"></a>      <span class='hs-comment'>-- restore the codec state</span>
<a name="line-599"></a>      <span class='hs-varid'>setState</span> <span class='hs-varid'>decoder</span> <span class='hs-varid'>codec_state</span>
<a name="line-600"></a>
<a name="line-601"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>bbuf1</span><span class='hs-layout'>,</span><span class='hs-varid'>cbuf1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-varid'>streamEncode</span> <span class='hs-varid'>decoder</span><span class='hs-layout'>)</span> <span class='hs-varid'>bbuf0</span>
<a name="line-602"></a>                               <span class='hs-varid'>cbuf0</span><span class='hs-layout'>{</span> <span class='hs-varid'>bufL</span><span class='hs-keyglyph'>=</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>bufR</span><span class='hs-keyglyph'>=</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>bufSize</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>cbuf0</span> <span class='hs-layout'>}</span>
<a name="line-603"></a>
<a name="line-604"></a>      <span class='hs-comment'>-- We should not need to update the offset here. The bytebuffer contains the</span>
<a name="line-605"></a>      <span class='hs-comment'>-- offset for the next read after it's used up. But this function only flushes</span>
<a name="line-606"></a>      <span class='hs-comment'>-- the char buffer.</span>
<a name="line-607"></a>      <span class='hs-comment'>-- let bbuf2 = bbuf1 -- {bufOffset = bufOffset bbuf1 - fromIntegral (bufL bbuf1)}</span>
<a name="line-608"></a>      <span class='hs-comment'>-- debugIO ("finished, bbuf=" ++ summaryBuffer bbuf2 ++</span>
<a name="line-609"></a>      <span class='hs-comment'>--          " cbuf=" ++ summaryBuffer cbuf1)</span>
<a name="line-610"></a>
<a name="line-611"></a>      <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf1</span>
<a name="line-612"></a>
<a name="line-613"></a>
<a name="line-614"></a><span class='hs-comment'>-- When flushing the byte read buffer, we seek backwards by the number</span>
<a name="line-615"></a><span class='hs-comment'>-- of characters in the buffer.  The file descriptor must therefore be</span>
<a name="line-616"></a><span class='hs-comment'>-- seekable: attempting to flush the read buffer on an unseekable</span>
<a name="line-617"></a><span class='hs-comment'>-- handle is not allowed.</span>
<a name="line-618"></a>
<a name="line-619"></a><a name="flushByteReadBuffer"></a><span class='hs-definition'>flushByteReadBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-620"></a><span class='hs-definition'>flushByteReadBuffer</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-621"></a>  <span class='hs-varid'>bbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-622"></a>
<a name="line-623"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>bbuf</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-624"></a>
<a name="line-625"></a>  <span class='hs-varid'>seekable</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>IODevice.isSeekable</span> <span class='hs-varid'>haDevice</span>
<a name="line-626"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>seekable</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ioe_cannotFlushNotSeekable</span>
<a name="line-627"></a>
<a name="line-628"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>seek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>negate</span> <span class='hs-layout'>(</span><span class='hs-varid'>bufR</span> <span class='hs-varid'>bbuf</span> <span class='hs-comment'>-</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span>
<a name="line-629"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>offset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bufOffset</span> <span class='hs-varid'>bbuf</span> <span class='hs-comment'>-</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>bufR</span> <span class='hs-varid'>bbuf</span> <span class='hs-comment'>-</span> <span class='hs-varid'>bufL</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span>
<a name="line-630"></a>
<a name="line-631"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"flushByteReadBuffer: new file offset = "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>seek</span><span class='hs-layout'>)</span>
<a name="line-632"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"flushByteReadBuffer: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span>
<a name="line-633"></a>
<a name="line-634"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>mIOSeek</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IODevice.seek</span> <span class='hs-varid'>haDevice</span> <span class='hs-conid'>RelativeSeek</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>seek</span><span class='hs-layout'>)</span>
<a name="line-635"></a>  <span class='hs-comment'>-- win-io doesn't need this, but it allows us to error out on invalid offsets</span>
<a name="line-636"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>winIOSeek</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>IODevice.seek</span> <span class='hs-varid'>haDevice</span> <span class='hs-conid'>AbsoluteSeek</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>offset</span><span class='hs-layout'>)</span>
<a name="line-637"></a>
<a name="line-638"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mIOSeek</span> <span class='hs-varop'>&lt;!&gt;</span> <span class='hs-varid'>winIOSeek</span>  <span class='hs-comment'>-- execute one of these two seek functions</span>
<a name="line-639"></a>
<a name="line-640"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>{</span> <span class='hs-varid'>bufL</span><span class='hs-keyglyph'>=</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>bufR</span><span class='hs-keyglyph'>=</span><span class='hs-num'>0</span><span class='hs-layout'>,</span> <span class='hs-varid'>bufOffset</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>offset</span> <span class='hs-layout'>}</span>
<a name="line-641"></a>
<a name="line-642"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-643"></a><span class='hs-comment'>-- Making Handles</span>
<a name="line-644"></a>
<a name="line-645"></a><span class='hs-comment'>{- Note [Making offsets for append]
<a name="line-646"></a>   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-647"></a>
<a name="line-648"></a>  The WINIO subysstem keeps track of offsets for handles
<a name="line-649"></a>  on the Haskell side of things instead of letting the OS
<a name="line-650"></a>  handle it. This requires us to establish the correct offset
<a name="line-651"></a>  for a handle on creation. This is usually zero but slightly
<a name="line-652"></a>  more tedious for append modes. There we fall back on IODevice
<a name="line-653"></a>  functionality to establish the size of the file and then set
<a name="line-654"></a>  the offset accordingly. This is only required for WINIO.
<a name="line-655"></a>-}</span>
<a name="line-656"></a>
<a name="line-657"></a><a name="mkHandleMVar"></a><span class='hs-comment'>-- | Make an @'MVar' 'Handle__'@ for use in a 'Handle'. This function</span>
<a name="line-658"></a><span class='hs-comment'>-- does not install a finalizer; that must be done by the caller.</span>
<a name="line-659"></a><span class='hs-definition'>mkHandleMVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RawIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>IODevice</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferedIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>dev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>dev</span>
<a name="line-660"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-661"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandleType</span>
<a name="line-662"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                     <span class='hs-comment'>-- buffered?</span>
<a name="line-663"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span>
<a name="line-664"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewlineMode</span>
<a name="line-665"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span><span class='hs-layout'>)</span>
<a name="line-666"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span><span class='hs-layout'>)</span>
<a name="line-667"></a><span class='hs-definition'>mkHandleMVar</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>ha_type</span> <span class='hs-varid'>buffered</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>nl</span> <span class='hs-varid'>other_side</span> <span class='hs-keyglyph'>=</span>
<a name="line-668"></a>   <span class='hs-varid'>openTextEncoding</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>ha_type</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>mb_encoder</span> <span class='hs-varid'>mb_decoder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-669"></a>
<a name="line-670"></a>   <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>buf_state</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initBufferState</span> <span class='hs-varid'>ha_type</span>
<a name="line-671"></a>   <span class='hs-varop'>!</span><span class='hs-varid'>bbuf_no_offset</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-conid'>Buffered.newBuffer</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>buf_state</span><span class='hs-layout'>)</span>
<a name="line-672"></a>   <span class='hs-varop'>!</span><span class='hs-varid'>buf_offset</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initHandleOffset</span>
<a name="line-673"></a>   <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>bbuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bbuf_no_offset</span> <span class='hs-layout'>{</span> <span class='hs-varid'>bufOffset</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buf_offset</span><span class='hs-layout'>}</span>
<a name="line-674"></a>
<a name="line-675"></a>   <span class='hs-varid'>bbufref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>bbuf</span>
<a name="line-676"></a>   <span class='hs-varid'>last_decode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>errorWithoutStackTrace</span> <span class='hs-str'>"codec_state"</span><span class='hs-layout'>,</span> <span class='hs-varid'>bbuf</span><span class='hs-layout'>)</span>
<a name="line-677"></a>
<a name="line-678"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>cbufref</span><span class='hs-layout'>,</span><span class='hs-varid'>bmode</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-679"></a>         <span class='hs-keyword'>if</span> <span class='hs-varid'>buffered</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>getCharBuffer</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>buf_state</span>
<a name="line-680"></a>                     <span class='hs-keyword'>else</span> <span class='hs-varid'>mkUnBuffer</span> <span class='hs-varid'>buf_state</span>
<a name="line-681"></a>
<a name="line-682"></a>   <span class='hs-varid'>spares</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>BufferListNil</span>
<a name="line-683"></a>   <span class='hs-varid'>debugIO</span> <span class='hs-varop'>$</span> <span class='hs-str'>"making handle for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>filepath</span>
<a name="line-684"></a>   <span class='hs-varid'>newMVar</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Handle__</span> <span class='hs-layout'>{</span> <span class='hs-varid'>haDevice</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span>
<a name="line-685"></a>                        <span class='hs-varid'>haType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ha_type</span><span class='hs-layout'>,</span>
<a name="line-686"></a>                        <span class='hs-varid'>haBufferMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bmode</span><span class='hs-layout'>,</span>
<a name="line-687"></a>                        <span class='hs-varid'>haByteBuffer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bbufref</span><span class='hs-layout'>,</span>
<a name="line-688"></a>                        <span class='hs-varid'>haLastDecode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>last_decode</span><span class='hs-layout'>,</span>
<a name="line-689"></a>                        <span class='hs-varid'>haCharBuffer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cbufref</span><span class='hs-layout'>,</span>
<a name="line-690"></a>                        <span class='hs-varid'>haBuffers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spares</span><span class='hs-layout'>,</span>
<a name="line-691"></a>                        <span class='hs-varid'>haEncoder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_encoder</span><span class='hs-layout'>,</span>
<a name="line-692"></a>                        <span class='hs-varid'>haDecoder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_decoder</span><span class='hs-layout'>,</span>
<a name="line-693"></a>                        <span class='hs-varid'>haCodec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_codec</span><span class='hs-layout'>,</span>
<a name="line-694"></a>                        <span class='hs-varid'>haInputNL</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>inputNL</span> <span class='hs-varid'>nl</span><span class='hs-layout'>,</span>
<a name="line-695"></a>                        <span class='hs-varid'>haOutputNL</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outputNL</span> <span class='hs-varid'>nl</span><span class='hs-layout'>,</span>
<a name="line-696"></a>                        <span class='hs-varid'>haOtherSide</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>other_side</span>
<a name="line-697"></a>                      <span class='hs-layout'>}</span>
<a name="line-698"></a>  <span class='hs-keyword'>where</span>
<a name="line-699"></a>    <span class='hs-comment'>-- See Note [Making offsets for append]</span>
<a name="line-700"></a>    <span class='hs-varid'>initHandleOffset</span>
<a name="line-701"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isAppendHandleType</span> <span class='hs-varid'>ha_type</span>
<a name="line-702"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>isWindowsNativeIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-703"></a>          <span class='hs-varid'>size</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>IODevice.getSize</span> <span class='hs-varid'>dev</span>
<a name="line-704"></a>          <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>size</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word64</span><span class='hs-layout'>)</span>
<a name="line-705"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-num'>0</span>
<a name="line-706"></a>
<a name="line-707"></a><a name="mkHandle"></a><span class='hs-definition'>mkHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RawIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>IODevice</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferedIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>dev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>dev</span>
<a name="line-708"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-709"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandleType</span>
<a name="line-710"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>                     <span class='hs-comment'>-- buffered?</span>
<a name="line-711"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span>
<a name="line-712"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewlineMode</span>
<a name="line-713"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>HandleFinalizer</span>
<a name="line-714"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span><span class='hs-layout'>)</span>
<a name="line-715"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-716"></a><span class='hs-definition'>mkHandle</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>ha_type</span> <span class='hs-varid'>buffered</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>nl</span> <span class='hs-varid'>mb_finalizer</span> <span class='hs-varid'>other_side</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-717"></a>  <span class='hs-varid'>mv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHandleMVar</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>ha_type</span> <span class='hs-varid'>buffered</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>nl</span> <span class='hs-varid'>other_side</span>
<a name="line-718"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>handle</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FileHandle</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>mv</span>
<a name="line-719"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_finalizer</span> <span class='hs-keyword'>of</span>
<a name="line-720"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-721"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>finalizer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>addHandleFinalizer</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>finalizer</span>
<a name="line-722"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>handle</span>
<a name="line-723"></a>
<a name="line-724"></a><a name="mkFileHandleNoFinalizer"></a><span class='hs-comment'>-- | makes a new 'Handle' without a finalizer.</span>
<a name="line-725"></a><span class='hs-definition'>mkFileHandleNoFinalizer</span>
<a name="line-726"></a>             <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RawIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>IODevice</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferedIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>dev</span><span class='hs-layout'>)</span>
<a name="line-727"></a>             <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>dev</span> <span class='hs-comment'>-- ^ the underlying IO device, which must support</span>
<a name="line-728"></a>                    <span class='hs-comment'>-- 'IODevice', 'BufferedIO' and 'Typeable'</span>
<a name="line-729"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-730"></a>                    <span class='hs-comment'>-- ^ a string describing the 'Handle', e.g. the file</span>
<a name="line-731"></a>                    <span class='hs-comment'>-- path for a file.  Used in error messages.</span>
<a name="line-732"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOMode</span>
<a name="line-733"></a>                    <span class='hs-comment'>-- The mode in which the 'Handle' is to be used</span>
<a name="line-734"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span>
<a name="line-735"></a>                    <span class='hs-comment'>-- Create the 'Handle' with no text encoding?</span>
<a name="line-736"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewlineMode</span>
<a name="line-737"></a>                    <span class='hs-comment'>-- Translate newlines?</span>
<a name="line-738"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-739"></a><span class='hs-definition'>mkFileHandleNoFinalizer</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>iomode</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>tr_newlines</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-740"></a>   <span class='hs-varid'>mv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHandleMVar</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-layout'>(</span><span class='hs-varid'>ioModeToHandleType</span> <span class='hs-varid'>iomode</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span><span class='hs-comment'>{-buffered-}</span>
<a name="line-741"></a>                      <span class='hs-varid'>mb_codec</span>
<a name="line-742"></a>                      <span class='hs-varid'>tr_newlines</span>
<a name="line-743"></a>                      <span class='hs-conid'>Nothing</span><span class='hs-comment'>{-other_side-}</span>
<a name="line-744"></a>   <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>mv</span><span class='hs-layout'>)</span>
<a name="line-745"></a>
<a name="line-746"></a><a name="mkFileHandle"></a><span class='hs-comment'>-- | makes a new 'Handle'</span>
<a name="line-747"></a><span class='hs-definition'>mkFileHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RawIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>IODevice</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferedIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>dev</span><span class='hs-layout'>)</span>
<a name="line-748"></a>             <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>dev</span> <span class='hs-comment'>-- ^ the underlying IO device, which must support</span>
<a name="line-749"></a>                    <span class='hs-comment'>-- 'IODevice', 'BufferedIO' and 'Typeable'</span>
<a name="line-750"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-751"></a>                    <span class='hs-comment'>-- ^ a string describing the 'Handle', e.g. the file</span>
<a name="line-752"></a>                    <span class='hs-comment'>-- path for a file.  Used in error messages.</span>
<a name="line-753"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOMode</span>
<a name="line-754"></a>                    <span class='hs-comment'>-- The mode in which the 'Handle' is to be used</span>
<a name="line-755"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span>
<a name="line-756"></a>                    <span class='hs-comment'>-- Create the 'Handle' with no text encoding?</span>
<a name="line-757"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewlineMode</span>
<a name="line-758"></a>                    <span class='hs-comment'>-- Translate newlines?</span>
<a name="line-759"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-760"></a>
<a name="line-761"></a><span class='hs-definition'>mkFileHandle</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>iomode</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>tr_newlines</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-762"></a>   <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkFileHandleNoFinalizer</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>iomode</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>tr_newlines</span>
<a name="line-763"></a>   <span class='hs-varid'>addHandleFinalizer</span> <span class='hs-varid'>h</span> <span class='hs-varid'>handleFinalizer</span>
<a name="line-764"></a>   <span class='hs-varid'>pure</span> <span class='hs-varid'>h</span>
<a name="line-765"></a>
<a name="line-766"></a><a name="mkDuplexHandleNoFinalizer"></a><span class='hs-comment'>-- | like 'mkFileHandle', except that a 'Handle' is created with two</span>
<a name="line-767"></a><span class='hs-comment'>-- independent buffers, one for reading and one for writing.  Used for</span>
<a name="line-768"></a><span class='hs-comment'>-- full-duplex streams, such as network sockets.</span>
<a name="line-769"></a><span class='hs-definition'>mkDuplexHandleNoFinalizer</span> <span class='hs-keyglyph'>::</span>
<a name="line-770"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>RawIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>IODevice</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferedIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>dev</span><span class='hs-layout'>)</span>
<a name="line-771"></a>     <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>dev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewlineMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-772"></a><span class='hs-definition'>mkDuplexHandleNoFinalizer</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>tr_newlines</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-773"></a>
<a name="line-774"></a>  <span class='hs-varid'>write_m</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-775"></a>       <span class='hs-varid'>mkHandleMVar</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-conid'>WriteHandle</span> <span class='hs-conid'>True</span> <span class='hs-varid'>mb_codec</span>
<a name="line-776"></a>                        <span class='hs-varid'>tr_newlines</span>
<a name="line-777"></a>                        <span class='hs-conid'>Nothing</span> <span class='hs-comment'>-- no other side</span>
<a name="line-778"></a>
<a name="line-779"></a>  <span class='hs-varid'>read_m</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-780"></a>      <span class='hs-varid'>mkHandleMVar</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-conid'>ReadHandle</span> <span class='hs-conid'>True</span> <span class='hs-varid'>mb_codec</span>
<a name="line-781"></a>                        <span class='hs-varid'>tr_newlines</span>
<a name="line-782"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>write_m</span><span class='hs-layout'>)</span>
<a name="line-783"></a>
<a name="line-784"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>read_m</span> <span class='hs-varid'>write_m</span><span class='hs-layout'>)</span>
<a name="line-785"></a>
<a name="line-786"></a><a name="mkDuplexHandle"></a><span class='hs-comment'>-- | like 'mkFileHandle', except that a 'Handle' is created with two</span>
<a name="line-787"></a><span class='hs-comment'>-- independent buffers, one for reading and one for writing.  Used for</span>
<a name="line-788"></a><span class='hs-comment'>-- full-duplex streams, such as network sockets.</span>
<a name="line-789"></a><span class='hs-definition'>mkDuplexHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>RawIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>IODevice</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>BufferedIO</span> <span class='hs-varid'>dev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span> <span class='hs-varid'>dev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>dev</span>
<a name="line-790"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NewlineMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-791"></a><span class='hs-definition'>mkDuplexHandle</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>tr_newlines</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-792"></a>  <span class='hs-varid'>handle</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkDuplexHandleNoFinalizer</span> <span class='hs-varid'>dev</span> <span class='hs-varid'>filepath</span> <span class='hs-varid'>mb_codec</span> <span class='hs-varid'>tr_newlines</span>
<a name="line-793"></a>  <span class='hs-varid'>addHandleFinalizer</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>handleFinalizer</span>
<a name="line-794"></a>  <span class='hs-varid'>pure</span> <span class='hs-varid'>handle</span>
<a name="line-795"></a>
<a name="line-796"></a><a name="ioModeToHandleType"></a><span class='hs-definition'>ioModeToHandleType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IOMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandleType</span>
<a name="line-797"></a><span class='hs-definition'>ioModeToHandleType</span> <span class='hs-conid'>ReadMode</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadHandle</span>
<a name="line-798"></a><span class='hs-definition'>ioModeToHandleType</span> <span class='hs-conid'>WriteMode</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WriteHandle</span>
<a name="line-799"></a><span class='hs-definition'>ioModeToHandleType</span> <span class='hs-conid'>ReadWriteMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadWriteHandle</span>
<a name="line-800"></a><span class='hs-definition'>ioModeToHandleType</span> <span class='hs-conid'>AppendMode</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppendHandle</span>
<a name="line-801"></a>
<a name="line-802"></a><a name="initBufferState"></a><span class='hs-definition'>initBufferState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HandleType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BufferState</span>
<a name="line-803"></a><span class='hs-definition'>initBufferState</span> <span class='hs-conid'>ReadHandle</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReadBuffer</span>
<a name="line-804"></a><span class='hs-definition'>initBufferState</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WriteBuffer</span>
<a name="line-805"></a>
<a name="line-806"></a><a name="openTextEncoding"></a><span class='hs-definition'>openTextEncoding</span>
<a name="line-807"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span>
<a name="line-808"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandleType</span>
<a name="line-809"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>es</span> <span class='hs-varid'>ds</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TextEncoder</span> <span class='hs-varid'>es</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TextDecoder</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-810"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-811"></a>
<a name="line-812"></a><span class='hs-definition'>openTextEncoding</span> <span class='hs-conid'>Nothing</span>   <span class='hs-varid'>ha_type</span> <span class='hs-varid'>cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cont</span> <span class='hs-conid'>Nothing</span> <span class='hs-conid'>Nothing</span>
<a name="line-813"></a><span class='hs-definition'>openTextEncoding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-conid'>TextEncoding</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>ha_type</span> <span class='hs-varid'>cont</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-814"></a>    <span class='hs-varid'>mb_decoder</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isReadableHandleType</span> <span class='hs-varid'>ha_type</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-815"></a>                     <span class='hs-varid'>decoder</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkTextDecoder</span>
<a name="line-816"></a>                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>decoder</span><span class='hs-layout'>)</span>
<a name="line-817"></a>                  <span class='hs-keyword'>else</span>
<a name="line-818"></a>                     <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-819"></a>    <span class='hs-varid'>mb_encoder</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isWritableHandleType</span> <span class='hs-varid'>ha_type</span> <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-820"></a>                     <span class='hs-varid'>encoder</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkTextEncoder</span>
<a name="line-821"></a>                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>encoder</span><span class='hs-layout'>)</span>
<a name="line-822"></a>                  <span class='hs-keyword'>else</span>
<a name="line-823"></a>                     <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-824"></a>    <span class='hs-varid'>cont</span> <span class='hs-varid'>mb_encoder</span> <span class='hs-varid'>mb_decoder</span>
<a name="line-825"></a>
<a name="line-826"></a><a name="closeTextCodecs"></a><span class='hs-definition'>closeTextCodecs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-827"></a><span class='hs-definition'>closeTextCodecs</span> <span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-828"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>haDecoder</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Encoding.close</span> <span class='hs-varid'>d</span>
<a name="line-829"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>haEncoder</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span><span class='hs-layout'>;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>d</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Encoding.close</span> <span class='hs-varid'>d</span>
<a name="line-830"></a>
<a name="line-831"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-832"></a><span class='hs-comment'>-- Closing a handle</span>
<a name="line-833"></a>
<a name="line-834"></a><a name="hClose_impl"></a><span class='hs-comment'>-- | This function exists temporarily to avoid an unused import warning in</span>
<a name="line-835"></a><span class='hs-comment'>-- `bytestring`.</span>
<a name="line-836"></a><span class='hs-definition'>hClose_impl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-837"></a><span class='hs-definition'>hClose_impl</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>FileHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-838"></a>  <span class='hs-varid'>mb_exc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hClose'</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span>
<a name="line-839"></a>  <span class='hs-varid'>hClose_maybethrow</span> <span class='hs-varid'>mb_exc</span> <span class='hs-varid'>h</span>
<a name="line-840"></a><span class='hs-definition'>hClose_impl</span> <span class='hs-varid'>h</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>DuplexHandle</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-841"></a>  <span class='hs-varid'>excs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>hClose'</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>w</span><span class='hs-keyglyph'>]</span>
<a name="line-842"></a>  <span class='hs-varid'>hClose_maybethrow</span> <span class='hs-layout'>(</span><span class='hs-varid'>listToMaybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>catMaybes</span> <span class='hs-varid'>excs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>h</span>
<a name="line-843"></a>
<a name="line-844"></a><a name="hClose_maybethrow"></a><span class='hs-definition'>hClose_maybethrow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SomeException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-845"></a><span class='hs-definition'>hClose_maybethrow</span> <span class='hs-conid'>Nothing</span>  <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-846"></a><span class='hs-definition'>hClose_maybethrow</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hClose_rethrow</span> <span class='hs-varid'>e</span> <span class='hs-varid'>h</span>
<a name="line-847"></a>
<a name="line-848"></a><a name="hClose_rethrow"></a><span class='hs-definition'>hClose_rethrow</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeException</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-849"></a><span class='hs-definition'>hClose_rethrow</span> <span class='hs-varid'>e</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span>
<a name="line-850"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>fromException</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-851"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>ioe</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ioError</span> <span class='hs-layout'>(</span><span class='hs-varid'>augmentIOError</span> <span class='hs-varid'>ioe</span> <span class='hs-str'>"hClose"</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-852"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwIO</span> <span class='hs-varid'>e</span>
<a name="line-853"></a>
<a name="line-854"></a><a name="hClose'"></a><span class='hs-definition'>hClose'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span>
<a name="line-855"></a><span class='hs-definition'>hClose'</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withHandle'</span> <span class='hs-str'>"hClose"</span> <span class='hs-varid'>h</span> <span class='hs-varid'>m</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hClose_help</span>
<a name="line-856"></a>
<a name="line-857"></a><a name="hClose_help"></a><span class='hs-comment'>-- hClose_help is also called by lazyRead (in GHC.IO.Handle.Text) when</span>
<a name="line-858"></a><span class='hs-comment'>-- EOF is read or an IO error occurs on a lazy stream.  The</span>
<a name="line-859"></a><span class='hs-comment'>-- semi-closed Handle is then closed immediately.  We have to be</span>
<a name="line-860"></a><span class='hs-comment'>-- careful with DuplexHandles though: we have to leave the closing to</span>
<a name="line-861"></a><span class='hs-comment'>-- the finalizer in that case, because the write side may still be in</span>
<a name="line-862"></a><span class='hs-comment'>-- use.</span>
<a name="line-863"></a><span class='hs-definition'>hClose_help</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span>
<a name="line-864"></a><span class='hs-definition'>hClose_help</span> <span class='hs-varid'>handle_</span> <span class='hs-keyglyph'>=</span>
<a name="line-865"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>haType</span> <span class='hs-varid'>handle_</span> <span class='hs-keyword'>of</span>
<a name="line-866"></a>      <span class='hs-conid'>ClosedHandle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>handle_</span><span class='hs-layout'>,</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-867"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>mb_exc1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>trymaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>flushWriteBuffer</span> <span class='hs-varid'>handle_</span> <span class='hs-comment'>-- interruptible</span>
<a name="line-868"></a>                    <span class='hs-comment'>-- it is important that hClose doesn't fail and</span>
<a name="line-869"></a>                    <span class='hs-comment'>-- leave the Handle open (#3128), so we catch</span>
<a name="line-870"></a>                    <span class='hs-comment'>-- exceptions when flushing the buffer.</span>
<a name="line-871"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>h_</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_exc2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hClose_handle_</span> <span class='hs-varid'>handle_</span>
<a name="line-872"></a>              <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>h_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_exc1</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>mb_exc1</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>mb_exc2</span><span class='hs-layout'>)</span>
<a name="line-873"></a>
<a name="line-874"></a>
<a name="line-875"></a><a name="trymaybe"></a><span class='hs-definition'>trymaybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span>
<a name="line-876"></a><span class='hs-definition'>trymaybe</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyword'>do</span> <span class='hs-varid'>io</span><span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varop'>`catchException`</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-877"></a>
<a name="line-878"></a><a name="hClose_handle_"></a><span class='hs-definition'>hClose_handle_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span>
<a name="line-879"></a><span class='hs-definition'>hClose_handle_</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-880"></a>
<a name="line-881"></a>    <span class='hs-comment'>-- close the file descriptor, but not when this is the read</span>
<a name="line-882"></a>    <span class='hs-comment'>-- side of a duplex handle.</span>
<a name="line-883"></a>    <span class='hs-comment'>-- If an exception is raised by the close(), we want to continue</span>
<a name="line-884"></a>    <span class='hs-comment'>-- to close the handle and release the lock if it has one, then</span>
<a name="line-885"></a>    <span class='hs-comment'>-- we return the exception to the caller of hClose_help which can</span>
<a name="line-886"></a>    <span class='hs-comment'>-- raise it if necessary.</span>
<a name="line-887"></a>    <span class='hs-varid'>maybe_exception</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-888"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>haOtherSide</span> <span class='hs-keyword'>of</span>
<a name="line-889"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>trymaybe</span> <span class='hs-varop'>$</span> <span class='hs-conid'>IODevice.close</span> <span class='hs-varid'>haDevice</span>
<a name="line-890"></a>        <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-891"></a>
<a name="line-892"></a>    <span class='hs-comment'>-- free the spare buffers</span>
<a name="line-893"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haBuffers</span> <span class='hs-conid'>BufferListNil</span>
<a name="line-894"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haCharBuffer</span> <span class='hs-varid'>noCharBuffer</span>
<a name="line-895"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>noByteBuffer</span>
<a name="line-896"></a>
<a name="line-897"></a>    <span class='hs-comment'>-- release our encoder/decoder</span>
<a name="line-898"></a>    <span class='hs-varid'>closeTextCodecs</span> <span class='hs-varid'>h_</span>
<a name="line-899"></a>
<a name="line-900"></a>    <span class='hs-comment'>-- we must set the fd to -1, because the finalizer is going</span>
<a name="line-901"></a>    <span class='hs-comment'>-- to run eventually and try to close/unlock it.</span>
<a name="line-902"></a>    <span class='hs-comment'>-- ToDo: necessary?  the handle will be marked ClosedHandle</span>
<a name="line-903"></a>    <span class='hs-comment'>-- XXX GHC won't let us use record update here, hence wildcards</span>
<a name="line-904"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span> <span class='hs-varid'>haType</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ClosedHandle</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>..</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_exception</span><span class='hs-layout'>)</span>
<a name="line-905"></a>
<a name="line-906"></a><a name="noCharBuffer"></a><span class='hs-comment'>{-# NOINLINE noCharBuffer #-}</span>
<a name="line-907"></a><span class='hs-definition'>noCharBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CharBuffer</span>
<a name="line-908"></a><span class='hs-definition'>noCharBuffer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newCharBuffer</span> <span class='hs-num'>1</span> <span class='hs-conid'>ReadBuffer</span>
<a name="line-909"></a>
<a name="line-910"></a><a name="noByteBuffer"></a><span class='hs-comment'>{-# NOINLINE noByteBuffer #-}</span>
<a name="line-911"></a><span class='hs-definition'>noByteBuffer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Buffer</span> <span class='hs-conid'>Word8</span>
<a name="line-912"></a><span class='hs-definition'>noByteBuffer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>newByteBuffer</span> <span class='hs-num'>1</span> <span class='hs-conid'>ReadBuffer</span>
<a name="line-913"></a>
<a name="line-914"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-915"></a><span class='hs-comment'>-- Looking ahead</span>
<a name="line-916"></a>
<a name="line-917"></a><a name="hLookAhead_"></a><span class='hs-definition'>hLookAhead_</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Char</span>
<a name="line-918"></a><span class='hs-definition'>hLookAhead_</span> <span class='hs-varid'>handle_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-919"></a>    <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haCharBuffer</span>
<a name="line-920"></a>
<a name="line-921"></a>    <span class='hs-comment'>-- fill up the read buffer if necessary</span>
<a name="line-922"></a>    <span class='hs-varid'>new_buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>buf</span>
<a name="line-923"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>readTextDevice</span> <span class='hs-varid'>handle_</span> <span class='hs-varid'>buf</span>
<a name="line-924"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>buf</span>
<a name="line-925"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haCharBuffer</span> <span class='hs-varid'>new_buf</span>
<a name="line-926"></a>
<a name="line-927"></a>    <span class='hs-varid'>peekCharBuf</span> <span class='hs-layout'>(</span><span class='hs-varid'>bufRaw</span> <span class='hs-varid'>buf</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>bufL</span> <span class='hs-varid'>buf</span><span class='hs-layout'>)</span>
<a name="line-928"></a>
<a name="line-929"></a><span class='hs-comment'>-- ---------------------------------------------------------------------------</span>
<a name="line-930"></a><span class='hs-comment'>-- debugging</span>
<a name="line-931"></a>
<a name="line-932"></a><a name="debugIO"></a><span class='hs-definition'>debugIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-933"></a><span class='hs-comment'>-- debugIO s = traceEventIO s</span>
<a name="line-934"></a><span class='hs-definition'>debugIO</span> <span class='hs-varid'>s</span>
<a name="line-935"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>c_DEBUG_DUMP</span>
<a name="line-936"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withCStringLen</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-937"></a>                  <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c_write</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>castPtr</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span>
<a name="line-938"></a>         <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-939"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-940"></a>
<a name="line-941"></a><a name="traceIO"></a><span class='hs-comment'>-- For development, like debugIO but always on.</span>
<a name="line-942"></a><span class='hs-definition'>traceIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-943"></a><span class='hs-definition'>traceIO</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-944"></a>         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withCStringLen</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n"</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-945"></a>                  <span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>p</span><span class='hs-layout'>,</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c_write</span> <span class='hs-num'>1</span> <span class='hs-layout'>(</span><span class='hs-varid'>castPtr</span> <span class='hs-varid'>p</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>len</span><span class='hs-layout'>)</span>
<a name="line-946"></a>         <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-947"></a>
<a name="line-948"></a><span class='hs-comment'>-- ----------------------------------------------------------------------------</span>
<a name="line-949"></a><span class='hs-comment'>-- Text input/output</span>
<a name="line-950"></a>
<a name="line-951"></a><a name="readTextDevice"></a><span class='hs-comment'>-- Read characters into the provided buffer.  Return when any</span>
<a name="line-952"></a><span class='hs-comment'>-- characters are available; raise an exception if the end of</span>
<a name="line-953"></a><span class='hs-comment'>-- file is reached.</span>
<a name="line-954"></a><span class='hs-comment'>--</span>
<a name="line-955"></a><span class='hs-comment'>-- In uses of readTextDevice within base, the input buffer is either:</span>
<a name="line-956"></a><span class='hs-comment'>--   * empty</span>
<a name="line-957"></a><span class='hs-comment'>--   * or contains a single \r (when doing newline translation)</span>
<a name="line-958"></a><span class='hs-comment'>--</span>
<a name="line-959"></a><span class='hs-comment'>-- The input character buffer must have a capacity at least 1 greater</span>
<a name="line-960"></a><span class='hs-comment'>-- than the number of elements it currently contains.</span>
<a name="line-961"></a><span class='hs-comment'>--</span>
<a name="line-962"></a><span class='hs-comment'>-- Users of this function expect that the buffer returned contains</span>
<a name="line-963"></a><span class='hs-comment'>-- at least 1 more character than the input buffer.</span>
<a name="line-964"></a><span class='hs-definition'>readTextDevice</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CharBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CharBuffer</span>
<a name="line-965"></a><span class='hs-definition'>readTextDevice</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-varid'>cbuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-966"></a>  <span class='hs-comment'>--</span>
<a name="line-967"></a>  <span class='hs-varid'>bbuf0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-968"></a>
<a name="line-969"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"readTextDevice: cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>cbuf</span> <span class='hs-varop'>++</span>
<a name="line-970"></a>        <span class='hs-str'>" bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf0</span><span class='hs-layout'>)</span>
<a name="line-971"></a>
<a name="line-972"></a>  <span class='hs-varid'>bbuf1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>bbuf0</span><span class='hs-layout'>)</span>
<a name="line-973"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>bbuf0</span>
<a name="line-974"></a>              <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-975"></a>                   <span class='hs-varid'>debugIO</span> <span class='hs-varop'>$</span> <span class='hs-str'>"readBuf at "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>bufferOffset</span> <span class='hs-varid'>bbuf0</span><span class='hs-layout'>)</span>
<a name="line-976"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>bbuf1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Buffered.fillReadBuffer</span> <span class='hs-varid'>haDevice</span> <span class='hs-varid'>bbuf0</span>
<a name="line-977"></a>                   <span class='hs-varid'>debugIO</span> <span class='hs-varop'>$</span> <span class='hs-str'>"readBuf after "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>bufferOffset</span> <span class='hs-varid'>bbuf1</span><span class='hs-layout'>)</span>
<a name="line-978"></a>                   <span class='hs-keyword'>if</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ioe_EOF</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>  <span class='hs-comment'>-- raise EOF</span>
<a name="line-979"></a>                   <span class='hs-varid'>return</span> <span class='hs-varid'>bbuf1</span>
<a name="line-980"></a>
<a name="line-981"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"readTextDevice after reading: bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf1</span><span class='hs-layout'>)</span>
<a name="line-982"></a>
<a name="line-983"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>bbuf2</span><span class='hs-layout'>,</span><span class='hs-varid'>cbuf'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-984"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>haDecoder</span> <span class='hs-keyword'>of</span>
<a name="line-985"></a>          <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-986"></a>               <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haLastDecode</span> <span class='hs-layout'>(</span><span class='hs-varid'>errorWithoutStackTrace</span> <span class='hs-str'>"codec_state"</span><span class='hs-layout'>,</span> <span class='hs-varid'>bbuf1</span><span class='hs-layout'>)</span>
<a name="line-987"></a>               <span class='hs-varid'>latin1_decode</span> <span class='hs-varid'>bbuf1</span> <span class='hs-varid'>cbuf</span>
<a name="line-988"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>decoder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-989"></a>               <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span> <span class='hs-varid'>decoder</span>
<a name="line-990"></a>               <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haLastDecode</span> <span class='hs-layout'>(</span><span class='hs-varid'>state</span><span class='hs-layout'>,</span> <span class='hs-varid'>bbuf1</span><span class='hs-layout'>)</span>
<a name="line-991"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>streamEncode</span> <span class='hs-varid'>decoder</span><span class='hs-layout'>)</span> <span class='hs-varid'>bbuf1</span> <span class='hs-varid'>cbuf</span>
<a name="line-992"></a>
<a name="line-993"></a>  <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"readTextDevice after decoding: cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>cbuf'</span> <span class='hs-varop'>++</span>
<a name="line-994"></a>        <span class='hs-str'>" bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf2</span><span class='hs-layout'>)</span>
<a name="line-995"></a>
<a name="line-996"></a>  <span class='hs-comment'>-- We can't return from readTextDevice without reading at least a single extra character,</span>
<a name="line-997"></a>  <span class='hs-comment'>-- so check that we have managed to achieve that</span>
<a name="line-998"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf2</span>
<a name="line-999"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>bufR</span> <span class='hs-varid'>cbuf'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bufR</span> <span class='hs-varid'>cbuf</span>
<a name="line-1000"></a>     <span class='hs-comment'>-- we need more bytes to make a Char. NB: bbuf2 may be empty (even though bbuf1 wasn't) when we</span>
<a name="line-1001"></a>     <span class='hs-comment'>-- are using an encoding that can skip bytes without outputting characters, such as UTF8//IGNORE</span>
<a name="line-1002"></a>     <span class='hs-keyword'>then</span> <span class='hs-varid'>readTextDevice'</span> <span class='hs-varid'>h_</span> <span class='hs-varid'>bbuf2</span> <span class='hs-varid'>cbuf</span>
<a name="line-1003"></a>     <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>cbuf'</span>
<a name="line-1004"></a>
<a name="line-1005"></a><a name="readTextDevice'"></a><span class='hs-comment'>-- we have an incomplete byte sequence at the end of the buffer: try to</span>
<a name="line-1006"></a><span class='hs-comment'>-- read more bytes.</span>
<a name="line-1007"></a><span class='hs-definition'>readTextDevice'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Buffer</span> <span class='hs-conid'>Word8</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CharBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CharBuffer</span>
<a name="line-1008"></a><span class='hs-definition'>readTextDevice'</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-varid'>bbuf0</span> <span class='hs-varid'>cbuf0</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1009"></a>  <span class='hs-comment'>--</span>
<a name="line-1010"></a>  <span class='hs-comment'>-- copy the partial sequence to the beginning of the buffer, so we have</span>
<a name="line-1011"></a>  <span class='hs-comment'>-- room to read more bytes.</span>
<a name="line-1012"></a>  <span class='hs-varid'>bbuf1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>slideContents</span> <span class='hs-varid'>bbuf0</span>
<a name="line-1013"></a>
<a name="line-1014"></a>  <span class='hs-comment'>-- readTextDevice only calls us if we got some bytes but not some characters.</span>
<a name="line-1015"></a>  <span class='hs-comment'>-- This can't occur if haDecoder is Nothing because latin1_decode accepts all bytes.</span>
<a name="line-1016"></a>  <span class='hs-keyword'>let</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>decoder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>haDecoder</span>
<a name="line-1017"></a>
<a name="line-1018"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>bbuf2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Buffered.fillReadBuffer</span> <span class='hs-varid'>haDevice</span> <span class='hs-varid'>bbuf1</span>
<a name="line-1019"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1020"></a>   <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-1021"></a>     <span class='hs-comment'>-- bbuf2 can be empty here when we encounter an invalid byte sequence at the end of the input</span>
<a name="line-1022"></a>     <span class='hs-comment'>-- with a //IGNORE codec which consumes bytes without outputting characters</span>
<a name="line-1023"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>bbuf2</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ioe_EOF</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-1024"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>bbuf3</span><span class='hs-layout'>,</span> <span class='hs-varid'>cbuf1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>recover</span> <span class='hs-varid'>decoder</span> <span class='hs-varid'>bbuf2</span> <span class='hs-varid'>cbuf0</span>
<a name="line-1025"></a>     <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"readTextDevice' after recovery: bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf3</span> <span class='hs-varop'>++</span> <span class='hs-str'>", cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>cbuf1</span><span class='hs-layout'>)</span>
<a name="line-1026"></a>     <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf3</span>
<a name="line-1027"></a>     <span class='hs-comment'>-- We should recursively invoke readTextDevice after recovery,</span>
<a name="line-1028"></a>     <span class='hs-comment'>-- if recovery did not add at least one new character to the buffer:</span>
<a name="line-1029"></a>     <span class='hs-comment'>--  1. If we were using IgnoreCodingFailure it might be the case that</span>
<a name="line-1030"></a>     <span class='hs-comment'>--     cbuf1 is the same length as cbuf0 and we need to raise ioe_EOF</span>
<a name="line-1031"></a>     <span class='hs-comment'>--  2. If we were using TransliterateCodingFailure we might have *mutated*</span>
<a name="line-1032"></a>     <span class='hs-comment'>--     the byte buffer without changing the pointers into either buffer.</span>
<a name="line-1033"></a>     <span class='hs-comment'>--     We need to try and decode it again - it might just go through this time.</span>
<a name="line-1034"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>bufR</span> <span class='hs-varid'>cbuf1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bufR</span> <span class='hs-varid'>cbuf0</span>
<a name="line-1035"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>readTextDevice</span> <span class='hs-varid'>h_</span> <span class='hs-varid'>cbuf1</span>
<a name="line-1036"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>cbuf1</span>
<a name="line-1037"></a>   <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-1038"></a>    <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"readTextDevice' after reading: bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf2</span><span class='hs-layout'>)</span>
<a name="line-1039"></a>
<a name="line-1040"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>bbuf3</span><span class='hs-layout'>,</span><span class='hs-varid'>cbuf1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>do</span>
<a name="line-1041"></a>       <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span> <span class='hs-varid'>decoder</span>
<a name="line-1042"></a>       <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haLastDecode</span> <span class='hs-layout'>(</span><span class='hs-varid'>state</span><span class='hs-layout'>,</span> <span class='hs-varid'>bbuf2</span><span class='hs-layout'>)</span>
<a name="line-1043"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>streamEncode</span> <span class='hs-varid'>decoder</span><span class='hs-layout'>)</span> <span class='hs-varid'>bbuf2</span> <span class='hs-varid'>cbuf0</span>
<a name="line-1044"></a>
<a name="line-1045"></a>    <span class='hs-varid'>debugIO</span> <span class='hs-layout'>(</span><span class='hs-str'>"readTextDevice' after decoding: cbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>cbuf1</span> <span class='hs-varop'>++</span>
<a name="line-1046"></a>          <span class='hs-str'>" bbuf="</span> <span class='hs-varop'>++</span> <span class='hs-varid'>summaryBuffer</span> <span class='hs-varid'>bbuf3</span><span class='hs-layout'>)</span>
<a name="line-1047"></a>
<a name="line-1048"></a>    <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf3</span>
<a name="line-1049"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>bufR</span> <span class='hs-varid'>cbuf0</span> <span class='hs-varop'>==</span> <span class='hs-varid'>bufR</span> <span class='hs-varid'>cbuf1</span>
<a name="line-1050"></a>       <span class='hs-keyword'>then</span> <span class='hs-varid'>readTextDevice'</span> <span class='hs-varid'>h_</span> <span class='hs-varid'>bbuf3</span> <span class='hs-varid'>cbuf1</span>
<a name="line-1051"></a>       <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>cbuf1</span>
<a name="line-1052"></a>
<a name="line-1053"></a><a name="readTextDeviceNonBlocking"></a><span class='hs-comment'>-- Read characters into the provided buffer.  Do not block;</span>
<a name="line-1054"></a><span class='hs-comment'>-- return zero characters instead.  Raises an exception on end-of-file.</span>
<a name="line-1055"></a><span class='hs-definition'>readTextDeviceNonBlocking</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CharBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CharBuffer</span>
<a name="line-1056"></a><span class='hs-definition'>readTextDeviceNonBlocking</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-varid'>cbuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1057"></a>  <span class='hs-comment'>--</span>
<a name="line-1058"></a>  <span class='hs-varid'>bbuf0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-1059"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBuffer</span> <span class='hs-varid'>bbuf0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1060"></a>     <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span><span class='hs-varid'>bbuf1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Buffered.fillReadBuffer0</span> <span class='hs-varid'>haDevice</span> <span class='hs-varid'>bbuf0</span>
<a name="line-1061"></a>     <span class='hs-keyword'>if</span> <span class='hs-varid'>isNothing</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ioe_EOF</span> <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>  <span class='hs-comment'>-- raise EOF</span>
<a name="line-1062"></a>     <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf1</span>
<a name="line-1063"></a>
<a name="line-1064"></a>  <span class='hs-varid'>decodeByteBuf</span> <span class='hs-varid'>h_</span> <span class='hs-varid'>cbuf</span>
<a name="line-1065"></a>
<a name="line-1066"></a><a name="decodeByteBuf"></a><span class='hs-comment'>-- Decode bytes from the byte buffer into the supplied CharBuffer.</span>
<a name="line-1067"></a><span class='hs-definition'>decodeByteBuf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle__</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CharBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CharBuffer</span>
<a name="line-1068"></a><span class='hs-definition'>decodeByteBuf</span> <span class='hs-varid'>h_</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Handle__</span><span class='hs-layout'>{</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>}</span> <span class='hs-varid'>cbuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1069"></a>  <span class='hs-comment'>--</span>
<a name="line-1070"></a>  <span class='hs-varid'>bbuf0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varid'>haByteBuffer</span>
<a name="line-1071"></a>
<a name="line-1072"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>bbuf2</span><span class='hs-layout'>,</span><span class='hs-varid'>cbuf'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1073"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>haDecoder</span> <span class='hs-keyword'>of</span>
<a name="line-1074"></a>          <span class='hs-conid'>Nothing</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1075"></a>               <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haLastDecode</span> <span class='hs-layout'>(</span><span class='hs-varid'>errorWithoutStackTrace</span> <span class='hs-str'>"codec_state"</span><span class='hs-layout'>,</span> <span class='hs-varid'>bbuf0</span><span class='hs-layout'>)</span>
<a name="line-1076"></a>               <span class='hs-varid'>latin1_decode</span> <span class='hs-varid'>bbuf0</span> <span class='hs-varid'>cbuf</span>
<a name="line-1077"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>decoder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1078"></a>               <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getState</span> <span class='hs-varid'>decoder</span>
<a name="line-1079"></a>               <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haLastDecode</span> <span class='hs-layout'>(</span><span class='hs-varid'>state</span><span class='hs-layout'>,</span> <span class='hs-varid'>bbuf0</span><span class='hs-layout'>)</span>
<a name="line-1080"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>streamEncode</span> <span class='hs-varid'>decoder</span><span class='hs-layout'>)</span> <span class='hs-varid'>bbuf0</span> <span class='hs-varid'>cbuf</span>
<a name="line-1081"></a>
<a name="line-1082"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-varid'>haByteBuffer</span> <span class='hs-varid'>bbuf2</span>
<a name="line-1083"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>cbuf'</span>
<a name="line-1084"></a>
</pre></body>
</html>

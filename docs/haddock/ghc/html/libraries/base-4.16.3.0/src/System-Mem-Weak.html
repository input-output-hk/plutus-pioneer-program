<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>System/Mem/Weak.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE Trustworthy #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-4"></a><span class='hs-comment'>-- |</span>
<a name="line-5"></a><span class='hs-comment'>-- Module      :  System.Mem.Weak</span>
<a name="line-6"></a><span class='hs-comment'>-- Copyright   :  (c) The University of Glasgow 2001</span>
<a name="line-7"></a><span class='hs-comment'>-- License     :  BSD-style (see the file libraries/base/LICENSE)</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-- Maintainer  :  libraries@haskell.org</span>
<a name="line-10"></a><span class='hs-comment'>-- Stability   :  experimental</span>
<a name="line-11"></a><span class='hs-comment'>-- Portability :  non-portable</span>
<a name="line-12"></a><span class='hs-comment'>--</span>
<a name="line-13"></a><span class='hs-comment'>-- In general terms, a weak pointer is a reference to an object that is</span>
<a name="line-14"></a><span class='hs-comment'>-- not followed by the garbage collector - that is, the existence of a</span>
<a name="line-15"></a><span class='hs-comment'>-- weak pointer to an object has no effect on the lifetime of that</span>
<a name="line-16"></a><span class='hs-comment'>-- object.  A weak pointer can be de-referenced to find out</span>
<a name="line-17"></a><span class='hs-comment'>-- whether the object it refers to is still alive or not, and if so</span>
<a name="line-18"></a><span class='hs-comment'>-- to return the object itself.</span>
<a name="line-19"></a><span class='hs-comment'>--</span>
<a name="line-20"></a><span class='hs-comment'>-- Weak pointers are particularly useful for caches and memo tables.</span>
<a name="line-21"></a><span class='hs-comment'>-- To build a memo table, you build a data structure</span>
<a name="line-22"></a><span class='hs-comment'>-- mapping from the function argument (the key) to its result (the</span>
<a name="line-23"></a><span class='hs-comment'>-- value).  When you apply the function to a new argument you first</span>
<a name="line-24"></a><span class='hs-comment'>-- check whether the key\/value pair is already in the memo table.</span>
<a name="line-25"></a><span class='hs-comment'>-- The key point is that the memo table itself should not keep the</span>
<a name="line-26"></a><span class='hs-comment'>-- key and value alive.  So the table should contain a weak pointer</span>
<a name="line-27"></a><span class='hs-comment'>-- to the key, not an ordinary pointer.  The pointer to the value must</span>
<a name="line-28"></a><span class='hs-comment'>-- not be weak, because the only reference to the value might indeed be</span>
<a name="line-29"></a><span class='hs-comment'>-- from the memo table.</span>
<a name="line-30"></a><span class='hs-comment'>--</span>
<a name="line-31"></a><span class='hs-comment'>-- So it looks as if the memo table will keep all its values</span>
<a name="line-32"></a><span class='hs-comment'>-- alive for ever.  One way to solve this is to purge the table</span>
<a name="line-33"></a><span class='hs-comment'>-- occasionally, by deleting entries whose keys have died.</span>
<a name="line-34"></a><span class='hs-comment'>--</span>
<a name="line-35"></a><span class='hs-comment'>-- The weak pointers in this library</span>
<a name="line-36"></a><span class='hs-comment'>-- support another approach, called /finalization/.</span>
<a name="line-37"></a><span class='hs-comment'>-- When the key referred to by a weak pointer dies, the storage manager</span>
<a name="line-38"></a><span class='hs-comment'>-- arranges to run a programmer-specified finalizer.  In the case of memo</span>
<a name="line-39"></a><span class='hs-comment'>-- tables, for example, the finalizer could remove the key\/value pair</span>
<a name="line-40"></a><span class='hs-comment'>-- from the memo table.</span>
<a name="line-41"></a><span class='hs-comment'>--</span>
<a name="line-42"></a><span class='hs-comment'>-- Another difficulty with the memo table is that the value of a</span>
<a name="line-43"></a><span class='hs-comment'>-- key\/value pair might itself contain a pointer to the key.</span>
<a name="line-44"></a><span class='hs-comment'>-- So the memo table keeps the value alive, which keeps the key alive,</span>
<a name="line-45"></a><span class='hs-comment'>-- even though there may be no other references to the key so both should</span>
<a name="line-46"></a><span class='hs-comment'>-- die.  The weak pointers in this library provide a slight</span>
<a name="line-47"></a><span class='hs-comment'>-- generalisation of the basic weak-pointer idea, in which each</span>
<a name="line-48"></a><span class='hs-comment'>-- weak pointer actually contains both a key and a value.</span>
<a name="line-49"></a><span class='hs-comment'>--</span>
<a name="line-50"></a><span class='hs-comment'>-----------------------------------------------------------------------------</span>
<a name="line-51"></a>
<a name="line-52"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>System.Mem.Weak</span> <span class='hs-layout'>(</span>
<a name="line-53"></a>        <span class='hs-comment'>-- * The @Weak@ type</span>
<a name="line-54"></a>        <span class='hs-conid'>Weak</span><span class='hs-layout'>,</span>                   <span class='hs-comment'>-- abstract</span>
<a name="line-55"></a>
<a name="line-56"></a>        <span class='hs-comment'>-- * The general interface</span>
<a name="line-57"></a>        <span class='hs-varid'>mkWeak</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>deRefWeak</span><span class='hs-layout'>,</span>
<a name="line-59"></a>        <span class='hs-varid'>finalize</span><span class='hs-layout'>,</span>
<a name="line-60"></a>
<a name="line-61"></a>        <span class='hs-comment'>-- * Specialised versions</span>
<a name="line-62"></a>        <span class='hs-varid'>mkWeakPtr</span><span class='hs-layout'>,</span>
<a name="line-63"></a>        <span class='hs-varid'>addFinalizer</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-varid'>mkWeakPair</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-comment'>-- replaceFinaliser</span>
<a name="line-66"></a>
<a name="line-67"></a>        <span class='hs-comment'>-- * A precise semantics</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-comment'>-- $precise</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-comment'>-- * Implementation notes</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-comment'>-- $notes</span>
<a name="line-74"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-75"></a>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Weak</span>
<a name="line-77"></a>
<a name="line-78"></a><a name="mkWeakPtr"></a><span class='hs-comment'>-- | A specialised version of 'mkWeak', where the key and the value are</span>
<a name="line-79"></a><span class='hs-comment'>-- the same object:</span>
<a name="line-80"></a><span class='hs-comment'>--</span>
<a name="line-81"></a><span class='hs-comment'>-- &gt; mkWeakPtr key finalizer = mkWeak key key finalizer</span>
<a name="line-82"></a><span class='hs-comment'>--</span>
<a name="line-83"></a><span class='hs-definition'>mkWeakPtr</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Weak</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-definition'>mkWeakPtr</span> <span class='hs-varid'>key</span> <span class='hs-varid'>finalizer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak</span> <span class='hs-varid'>key</span> <span class='hs-varid'>key</span> <span class='hs-varid'>finalizer</span>
<a name="line-85"></a>
<a name="line-86"></a><a name="addFinalizer"></a><span class='hs-comment'>{-|
<a name="line-87"></a>  A specialised version of 'mkWeakPtr', where the 'Weak' object
<a name="line-88"></a>  returned is simply thrown away (however the finalizer will be
<a name="line-89"></a>  remembered by the garbage collector, and will still be run
<a name="line-90"></a>  when the key becomes unreachable).
<a name="line-91"></a>
<a name="line-92"></a>  Note: adding a finalizer to a 'Foreign.ForeignPtr.ForeignPtr' using
<a name="line-93"></a>  'addFinalizer' won't work; use the specialised version
<a name="line-94"></a>  'Foreign.ForeignPtr.addForeignPtrFinalizer' instead.  For discussion
<a name="line-95"></a>  see the 'Weak' type.
<a name="line-96"></a>.
<a name="line-97"></a>-}</span>
<a name="line-98"></a><span class='hs-definition'>addFinalizer</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>key</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-99"></a><span class='hs-definition'>addFinalizer</span> <span class='hs-varid'>key</span> <span class='hs-varid'>finalizer</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-100"></a>   <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkWeakPtr</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>finalizer</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- throw it away</span>
<a name="line-101"></a>   <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-102"></a>
<a name="line-103"></a><a name="mkWeakPair"></a><span class='hs-comment'>-- | A specialised version of 'mkWeak' where the value is actually a pair</span>
<a name="line-104"></a><span class='hs-comment'>-- of the key and value passed to 'mkWeakPair':</span>
<a name="line-105"></a><span class='hs-comment'>--</span>
<a name="line-106"></a><span class='hs-comment'>-- &gt; mkWeakPair key val finalizer = mkWeak key (key,val) finalizer</span>
<a name="line-107"></a><span class='hs-comment'>--</span>
<a name="line-108"></a><span class='hs-comment'>-- The advantage of this is that the key can be retrieved by 'deRefWeak'</span>
<a name="line-109"></a><span class='hs-comment'>-- in addition to the value.</span>
<a name="line-110"></a><span class='hs-definition'>mkWeakPair</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Weak</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-111"></a><span class='hs-definition'>mkWeakPair</span> <span class='hs-varid'>key</span> <span class='hs-varid'>val</span> <span class='hs-varid'>finalizer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkWeak</span> <span class='hs-varid'>key</span> <span class='hs-layout'>(</span><span class='hs-varid'>key</span><span class='hs-layout'>,</span><span class='hs-varid'>val</span><span class='hs-layout'>)</span> <span class='hs-varid'>finalizer</span>
<a name="line-112"></a>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-comment'>{- $precise
<a name="line-115"></a>
<a name="line-116"></a>The above informal specification is fine for simple situations, but
<a name="line-117"></a>matters can get complicated.  In particular, it needs to be clear
<a name="line-118"></a>exactly when a key dies, so that any weak pointers that refer to it
<a name="line-119"></a>can be finalized.  Suppose, for example, the value of one weak pointer
<a name="line-120"></a>refers to the key of another...does that keep the key alive?
<a name="line-121"></a>
<a name="line-122"></a>The behaviour is simply this:
<a name="line-123"></a>
<a name="line-124"></a> *  If a weak pointer (object) refers to an /unreachable/
<a name="line-125"></a>    key, it may be finalized.
<a name="line-126"></a>
<a name="line-127"></a> *  Finalization means (a) arrange that subsequent calls
<a name="line-128"></a>    to 'deRefWeak' return 'Nothing'; and (b) run the finalizer.
<a name="line-129"></a>
<a name="line-130"></a>This behaviour depends on what it means for a key to be reachable.
<a name="line-131"></a>Informally, something is reachable if it can be reached by following
<a name="line-132"></a>ordinary pointers from the root set, but not following weak pointers.
<a name="line-133"></a>We define reachability more precisely as follows.
<a name="line-134"></a>
<a name="line-135"></a>A heap object is /reachable/ if:
<a name="line-136"></a>
<a name="line-137"></a> * It is a member of the /root set/.
<a name="line-138"></a>
<a name="line-139"></a> * It is directly pointed to by a reachable object, other than
<a name="line-140"></a>   a weak pointer object.
<a name="line-141"></a>
<a name="line-142"></a> * It is a weak pointer object whose key is reachable.
<a name="line-143"></a>
<a name="line-144"></a> * It is the value or finalizer of a weak pointer object whose key is reachable.
<a name="line-145"></a>-}</span>
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-comment'>{- $notes
<a name="line-148"></a>
<a name="line-149"></a>A finalizer is not always called after its weak pointer\'s object becomes
<a name="line-150"></a>unreachable. If the object becomes unreachable right before the program exits,
<a name="line-151"></a>then GC may not be performed. Finalizers run during GC, so finalizers associated
<a name="line-152"></a>with the object do not run if GC does not happen.
<a name="line-153"></a>
<a name="line-154"></a>Other than the above caveat, users can always expect that a finalizer will be
<a name="line-155"></a>run after its weak pointer\'s object becomes unreachable.
<a name="line-156"></a>
<a name="line-157"></a>If a finalizer throws an exception, the exception is silently caught without
<a name="line-158"></a>notice. See the commit of issue
<a name="line-159"></a>&lt;https://gitlab.haskell.org/ghc/ghc/-/issues/13167 13167&gt; for details. Writing a
<a name="line-160"></a>finalizer that throws exceptions is discouraged.
<a name="line-161"></a>
<a name="line-162"></a>-}</span>
</pre></body>
</html>

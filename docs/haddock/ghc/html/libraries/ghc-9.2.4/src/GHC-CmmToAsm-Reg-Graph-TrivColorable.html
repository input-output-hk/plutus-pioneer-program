<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/CmmToAsm/Reg/Graph/TrivColorable.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.CmmToAsm.Reg.Graph.TrivColorable</span> <span class='hs-layout'>(</span>
<a name="line-4"></a>        <span class='hs-varid'>trivColorable</span><span class='hs-layout'>,</span>
<a name="line-5"></a><span class='hs-layout'>)</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>where</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-12"></a>
<a name="line-13"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Reg.Class</span>
<a name="line-14"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform.Reg</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Graph.Base</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Platform</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-comment'>-- trivColorable ---------------------------------------------------------------</span>
<a name="line-23"></a>
<a name="line-24"></a><span class='hs-comment'>-- trivColorable function for the graph coloring allocator</span>
<a name="line-25"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><span class='hs-comment'>--      This gets hammered by scanGraph during register allocation,</span>
<a name="line-27"></a><span class='hs-comment'>--      so needs to be fairly efficient.</span>
<a name="line-28"></a><span class='hs-comment'>--</span>
<a name="line-29"></a><span class='hs-comment'>--      NOTE:   This only works for architectures with just RcInteger and RcDouble</span>
<a name="line-30"></a><span class='hs-comment'>--              (which are disjoint) ie. x86, x86_64 and ppc</span>
<a name="line-31"></a><span class='hs-comment'>--</span>
<a name="line-32"></a><span class='hs-comment'>--      The number of allocatable regs is hard coded in here so we can do</span>
<a name="line-33"></a><span class='hs-comment'>--              a fast comparison in trivColorable.</span>
<a name="line-34"></a><span class='hs-comment'>--</span>
<a name="line-35"></a><span class='hs-comment'>--      It's ok if these numbers are _less_ than the actual number of free</span>
<a name="line-36"></a><span class='hs-comment'>--              regs, but they can't be more or the register conflict</span>
<a name="line-37"></a><span class='hs-comment'>--              graph won't color.</span>
<a name="line-38"></a><span class='hs-comment'>--</span>
<a name="line-39"></a><span class='hs-comment'>--      If the graph doesn't color then the allocator will panic, but it won't</span>
<a name="line-40"></a><span class='hs-comment'>--              generate bad object code or anything nasty like that.</span>
<a name="line-41"></a><span class='hs-comment'>--</span>
<a name="line-42"></a><span class='hs-comment'>--      There is an allocatableRegsInClass :: RegClass -&gt; Int, but doing</span>
<a name="line-43"></a><span class='hs-comment'>--      the unboxing is too slow for us here.</span>
<a name="line-44"></a><span class='hs-comment'>--      TODO: Is that still true? Could we use allocatableRegsInClass</span>
<a name="line-45"></a><span class='hs-comment'>--      without losing performance now?</span>
<a name="line-46"></a><span class='hs-comment'>--</span>
<a name="line-47"></a><span class='hs-comment'>--      Look at includes/stg/MachRegs.h to get the numbers.</span>
<a name="line-48"></a><span class='hs-comment'>--</span>
<a name="line-49"></a>
<a name="line-50"></a>
<a name="line-51"></a><a name="accSqueeze"></a><span class='hs-comment'>-- Disjoint registers ----------------------------------------------------------</span>
<a name="line-52"></a><span class='hs-comment'>--</span>
<a name="line-53"></a><span class='hs-comment'>--      The definition has been unfolded into individual cases for speed.</span>
<a name="line-54"></a><span class='hs-comment'>--      Each architecture has a different register setup, so we use a</span>
<a name="line-55"></a><span class='hs-comment'>--      different regSqueeze function for each.</span>
<a name="line-56"></a><span class='hs-comment'>--</span>
<a name="line-57"></a><span class='hs-definition'>accSqueeze</span>
<a name="line-58"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-59"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-60"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>reg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-61"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-varid'>reg</span>
<a name="line-62"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-63"></a>
<a name="line-64"></a><span class='hs-definition'>accSqueeze</span> <span class='hs-varid'>count</span> <span class='hs-varid'>maxCount</span> <span class='hs-varid'>squeeze</span> <span class='hs-varid'>us</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>count</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span>
<a name="line-65"></a>  <span class='hs-comment'>-- See Note [Unique Determinism and code generation]</span>
<a name="line-66"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>count</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-67"></a>        <span class='hs-varid'>acc</span> <span class='hs-varid'>count</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>count</span> <span class='hs-varop'>&gt;=</span> <span class='hs-varid'>maxCount</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count</span>
<a name="line-68"></a>        <span class='hs-varid'>acc</span> <span class='hs-varid'>count</span> <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-varid'>count</span> <span class='hs-varop'>+</span> <span class='hs-varid'>squeeze</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>rs</span>
<a name="line-69"></a>
<a name="line-70"></a><span class='hs-comment'>{- Note [accSqueeze]
<a name="line-71"></a>~~~~~~~~~~~~~~~~~~~~
<a name="line-72"></a>BL 2007/09
<a name="line-73"></a>Doing a nice fold over the UniqSet makes trivColorable use
<a name="line-74"></a>32% of total compile time and 42% of total alloc when compiling SHA1.hs from darcs.
<a name="line-75"></a>Therefore the UniqFM is made non-abstract and we use custom fold.
<a name="line-76"></a>
<a name="line-77"></a>MS 2010/04
<a name="line-78"></a>When converting UniqFM to use Data.IntMap, the fold cannot use UniqFM internal
<a name="line-79"></a>representation any more. But it is imperative that the accSqueeze stops
<a name="line-80"></a>the folding if the count gets greater or equal to maxCount. We thus convert
<a name="line-81"></a>UniqFM to a (lazy) list, do the fold and stops if necessary, which was
<a name="line-82"></a>the most efficient variant tried. Benchmark compiling 10-times SHA1.hs follows.
<a name="line-83"></a>(original = previous implementation, folding = fold of the whole UFM,
<a name="line-84"></a> lazyFold = the current implementation,
<a name="line-85"></a> hackFold = using internal representation of Data.IntMap)
<a name="line-86"></a>
<a name="line-87"></a>                                 original  folding   hackFold  lazyFold
<a name="line-88"></a> -O -fasm (used everywhere)      31.509s   30.387s   30.791s   30.603s
<a name="line-89"></a>                                 100.00%   96.44%    97.72%    97.12%
<a name="line-90"></a> -fregs-graph                    67.938s   74.875s   62.673s   64.679s
<a name="line-91"></a>                                 100.00%   110.21%   92.25%    95.20%
<a name="line-92"></a> -fregs-iterative                89.761s   143.913s  81.075s   86.912s
<a name="line-93"></a>                                 100.00%   160.33%   90.32%    96.83%
<a name="line-94"></a> -fnew-codegen                   38.225s   37.142s   37.551s   37.119s
<a name="line-95"></a>                                 100.00%   97.17%    98.24%    97.11%
<a name="line-96"></a> -fnew-codegen -fregs-graph      91.786s   91.51s    87.368s   86.88s
<a name="line-97"></a>                                 100.00%   99.70%    95.19%    94.65%
<a name="line-98"></a> -fnew-codegen -fregs-iterative  206.72s   343.632s  194.694s  208.677s
<a name="line-99"></a>                                 100.00%   166.23%   94.18%    100.95%
<a name="line-100"></a>-}</span>
<a name="line-101"></a>
<a name="line-102"></a><a name="trivColorable"></a><span class='hs-definition'>trivColorable</span>
<a name="line-103"></a>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Platform</span>
<a name="line-104"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>RegClass</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>VirtualReg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-105"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>RegClass</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RealReg</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-106"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Triv</span> <span class='hs-conid'>VirtualReg</span> <span class='hs-conid'>RegClass</span> <span class='hs-conid'>RealReg</span>
<a name="line-107"></a>
<a name="line-108"></a><span class='hs-definition'>trivColorable</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>virtualRegSqueeze</span> <span class='hs-varid'>realRegSqueeze</span> <span class='hs-conid'>RcInteger</span> <span class='hs-varid'>conflicts</span> <span class='hs-varid'>exclusions</span>
<a name="line-109"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cALLOCATABLE_REGS_INTEGER</span>
<a name="line-110"></a>                  <span class='hs-keyglyph'>=</span>        <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-111"></a>                            <span class='hs-conid'>ArchX86</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>3</span>
<a name="line-112"></a>                            <span class='hs-conid'>ArchX86_64</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>5</span>
<a name="line-113"></a>                            <span class='hs-conid'>ArchPPC</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>16</span>
<a name="line-114"></a>                            <span class='hs-conid'>ArchSPARC</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>14</span>
<a name="line-115"></a>                            <span class='hs-conid'>ArchSPARC64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchSPARC64"</span>
<a name="line-116"></a>                            <span class='hs-conid'>ArchPPC_64</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>15</span>
<a name="line-117"></a>                            <span class='hs-conid'>ArchARM</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchARM"</span>
<a name="line-118"></a>                            <span class='hs-comment'>-- We should be able to allocate *a lot* more in princple.</span>
<a name="line-119"></a>                            <span class='hs-comment'>-- essentially all 32 - SP, so 31, we'd trash the link reg</span>
<a name="line-120"></a>                            <span class='hs-comment'>-- as well as the platform and all others though.</span>
<a name="line-121"></a>                            <span class='hs-conid'>ArchAArch64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>18</span>
<a name="line-122"></a>                            <span class='hs-conid'>ArchAlpha</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchAlpha"</span>
<a name="line-123"></a>                            <span class='hs-conid'>ArchMipseb</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchMipseb"</span>
<a name="line-124"></a>                            <span class='hs-conid'>ArchMipsel</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchMipsel"</span>
<a name="line-125"></a>                            <span class='hs-conid'>ArchS390X</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchS390X"</span>
<a name="line-126"></a>                            <span class='hs-conid'>ArchRISCV64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchRISCV64"</span>
<a name="line-127"></a>                            <span class='hs-conid'>ArchJavaScript</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchJavaScript"</span>
<a name="line-128"></a>                            <span class='hs-conid'>ArchUnknown</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchUnknown"</span><span class='hs-layout'>)</span>
<a name="line-129"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>count2</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>accSqueeze</span> <span class='hs-num'>0</span> <span class='hs-varid'>cALLOCATABLE_REGS_INTEGER</span>
<a name="line-130"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>virtualRegSqueeze</span> <span class='hs-conid'>RcInteger</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                                <span class='hs-varid'>conflicts</span>
<a name="line-132"></a>
<a name="line-133"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>count3</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>accSqueeze</span>  <span class='hs-varid'>count2</span>    <span class='hs-varid'>cALLOCATABLE_REGS_INTEGER</span>
<a name="line-134"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>realRegSqueeze</span>   <span class='hs-conid'>RcInteger</span><span class='hs-layout'>)</span>
<a name="line-135"></a>                                <span class='hs-varid'>exclusions</span>
<a name="line-136"></a>
<a name="line-137"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count3</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>cALLOCATABLE_REGS_INTEGER</span>
<a name="line-138"></a>
<a name="line-139"></a><span class='hs-definition'>trivColorable</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>virtualRegSqueeze</span> <span class='hs-varid'>realRegSqueeze</span> <span class='hs-conid'>RcFloat</span> <span class='hs-varid'>conflicts</span> <span class='hs-varid'>exclusions</span>
<a name="line-140"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cALLOCATABLE_REGS_FLOAT</span>
<a name="line-141"></a>                  <span class='hs-keyglyph'>=</span>        <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-142"></a>                    <span class='hs-comment'>-- On x86_64 and x86, Float and RcDouble</span>
<a name="line-143"></a>                    <span class='hs-comment'>-- use the same registers,</span>
<a name="line-144"></a>                    <span class='hs-comment'>-- so we only use RcDouble to represent the</span>
<a name="line-145"></a>                    <span class='hs-comment'>-- register allocation problem on those types.</span>
<a name="line-146"></a>                            <span class='hs-conid'>ArchX86</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-147"></a>                            <span class='hs-conid'>ArchX86_64</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-148"></a>                            <span class='hs-conid'>ArchPPC</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-149"></a>                            <span class='hs-conid'>ArchSPARC</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>22</span>
<a name="line-150"></a>                            <span class='hs-conid'>ArchSPARC64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchSPARC64"</span>
<a name="line-151"></a>                            <span class='hs-conid'>ArchPPC_64</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-152"></a>                            <span class='hs-conid'>ArchARM</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchARM"</span>
<a name="line-153"></a>                            <span class='hs-comment'>-- we can in princple address all the float regs as</span>
<a name="line-154"></a>                            <span class='hs-comment'>-- segments. So we could have 64 Float regs. Or</span>
<a name="line-155"></a>                            <span class='hs-comment'>-- 128 Half regs, or even 256 Byte regs.</span>
<a name="line-156"></a>                            <span class='hs-conid'>ArchAArch64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>0</span>
<a name="line-157"></a>                            <span class='hs-conid'>ArchAlpha</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchAlpha"</span>
<a name="line-158"></a>                            <span class='hs-conid'>ArchMipseb</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchMipseb"</span>
<a name="line-159"></a>                            <span class='hs-conid'>ArchMipsel</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchMipsel"</span>
<a name="line-160"></a>                            <span class='hs-conid'>ArchS390X</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchS390X"</span>
<a name="line-161"></a>                            <span class='hs-conid'>ArchRISCV64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchRISCV64"</span>
<a name="line-162"></a>                            <span class='hs-conid'>ArchJavaScript</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchJavaScript"</span>
<a name="line-163"></a>                            <span class='hs-conid'>ArchUnknown</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchUnknown"</span><span class='hs-layout'>)</span>
<a name="line-164"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>count2</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>accSqueeze</span> <span class='hs-num'>0</span> <span class='hs-varid'>cALLOCATABLE_REGS_FLOAT</span>
<a name="line-165"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>virtualRegSqueeze</span> <span class='hs-conid'>RcFloat</span><span class='hs-layout'>)</span>
<a name="line-166"></a>                                <span class='hs-varid'>conflicts</span>
<a name="line-167"></a>
<a name="line-168"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>count3</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>accSqueeze</span>  <span class='hs-varid'>count2</span>    <span class='hs-varid'>cALLOCATABLE_REGS_FLOAT</span>
<a name="line-169"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>realRegSqueeze</span>   <span class='hs-conid'>RcFloat</span><span class='hs-layout'>)</span>
<a name="line-170"></a>                                <span class='hs-varid'>exclusions</span>
<a name="line-171"></a>
<a name="line-172"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count3</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>cALLOCATABLE_REGS_FLOAT</span>
<a name="line-173"></a>
<a name="line-174"></a><span class='hs-definition'>trivColorable</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>virtualRegSqueeze</span> <span class='hs-varid'>realRegSqueeze</span> <span class='hs-conid'>RcDouble</span> <span class='hs-varid'>conflicts</span> <span class='hs-varid'>exclusions</span>
<a name="line-175"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>cALLOCATABLE_REGS_DOUBLE</span>
<a name="line-176"></a>                  <span class='hs-keyglyph'>=</span>        <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>platformArch</span> <span class='hs-varid'>platform</span> <span class='hs-keyword'>of</span>
<a name="line-177"></a>                            <span class='hs-conid'>ArchX86</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>8</span>
<a name="line-178"></a>                            <span class='hs-comment'>-- in x86 32bit mode sse2 there are only</span>
<a name="line-179"></a>                            <span class='hs-comment'>-- 8 XMM registers xmm0 ... xmm7</span>
<a name="line-180"></a>                            <span class='hs-conid'>ArchX86_64</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>10</span>
<a name="line-181"></a>                            <span class='hs-comment'>-- in x86_64 there are 16 XMM registers</span>
<a name="line-182"></a>                            <span class='hs-comment'>-- xmm0 .. xmm15, here 10 is a</span>
<a name="line-183"></a>                            <span class='hs-comment'>-- "dont need to solve conflicts" count that</span>
<a name="line-184"></a>                            <span class='hs-comment'>-- was chosen at some point in the past.</span>
<a name="line-185"></a>                            <span class='hs-conid'>ArchPPC</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>26</span>
<a name="line-186"></a>                            <span class='hs-conid'>ArchSPARC</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>11</span>
<a name="line-187"></a>                            <span class='hs-conid'>ArchSPARC64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchSPARC64"</span>
<a name="line-188"></a>                            <span class='hs-conid'>ArchPPC_64</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>20</span>
<a name="line-189"></a>                            <span class='hs-conid'>ArchARM</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchARM"</span>
<a name="line-190"></a>                            <span class='hs-conid'>ArchAArch64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-num'>32</span>
<a name="line-191"></a>                            <span class='hs-conid'>ArchAlpha</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchAlpha"</span>
<a name="line-192"></a>                            <span class='hs-conid'>ArchMipseb</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchMipseb"</span>
<a name="line-193"></a>                            <span class='hs-conid'>ArchMipsel</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchMipsel"</span>
<a name="line-194"></a>                            <span class='hs-conid'>ArchS390X</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchS390X"</span>
<a name="line-195"></a>                            <span class='hs-conid'>ArchRISCV64</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchRISCV64"</span>
<a name="line-196"></a>                            <span class='hs-conid'>ArchJavaScript</span><span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchJavaScript"</span>
<a name="line-197"></a>                            <span class='hs-conid'>ArchUnknown</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"trivColorable ArchUnknown"</span><span class='hs-layout'>)</span>
<a name="line-198"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>count2</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>accSqueeze</span> <span class='hs-num'>0</span> <span class='hs-varid'>cALLOCATABLE_REGS_DOUBLE</span>
<a name="line-199"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>virtualRegSqueeze</span> <span class='hs-conid'>RcDouble</span><span class='hs-layout'>)</span>
<a name="line-200"></a>                                <span class='hs-varid'>conflicts</span>
<a name="line-201"></a>
<a name="line-202"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>count3</span>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>accSqueeze</span>  <span class='hs-varid'>count2</span>    <span class='hs-varid'>cALLOCATABLE_REGS_DOUBLE</span>
<a name="line-203"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>realRegSqueeze</span>   <span class='hs-conid'>RcDouble</span><span class='hs-layout'>)</span>
<a name="line-204"></a>                                <span class='hs-varid'>exclusions</span>
<a name="line-205"></a>
<a name="line-206"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>count3</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>cALLOCATABLE_REGS_DOUBLE</span>
<a name="line-207"></a>
<a name="line-208"></a>
<a name="line-209"></a>
<a name="line-210"></a>
<a name="line-211"></a><span class='hs-comment'>-- Specification Code ----------------------------------------------------------</span>
<a name="line-212"></a><span class='hs-comment'>--</span>
<a name="line-213"></a><span class='hs-comment'>--      The trivColorable function for each particular architecture should</span>
<a name="line-214"></a><span class='hs-comment'>--      implement the following function, but faster.</span>
<a name="line-215"></a><span class='hs-comment'>--</span>
<a name="line-216"></a>
<a name="line-217"></a><span class='hs-comment'>{-
<a name="line-218"></a>trivColorable :: RegClass -&gt; UniqSet Reg -&gt; UniqSet Reg -&gt; Bool
<a name="line-219"></a>trivColorable classN conflicts exclusions
<a name="line-220"></a> = let
<a name="line-221"></a>
<a name="line-222"></a>        acc :: Reg -&gt; (Int, Int) -&gt; (Int, Int)
<a name="line-223"></a>        acc r (cd, cf)
<a name="line-224"></a>         = case regClass r of
<a name="line-225"></a>                RcInteger       -&gt; (cd+1, cf)
<a name="line-226"></a>                RcFloat         -&gt; (cd,   cf+1)
<a name="line-227"></a>                _               -&gt; panic "Regs.trivColorable: reg class not handled"
<a name="line-228"></a>
<a name="line-229"></a>        tmp                     = nonDetFoldUFM acc (0, 0) conflicts
<a name="line-230"></a>        (countInt,  countFloat) = nonDetFoldUFM acc tmp    exclusions
<a name="line-231"></a>
<a name="line-232"></a>        squeese         = worst countInt   classN RcInteger
<a name="line-233"></a>                        + worst countFloat classN RcFloat
<a name="line-234"></a>
<a name="line-235"></a>   in   squeese &lt; allocatableRegsInClass classN
<a name="line-236"></a>
<a name="line-237"></a>-- | Worst case displacement
<a name="line-238"></a>--      node N of classN has n neighbors of class C.
<a name="line-239"></a>--
<a name="line-240"></a>--      We currently only have RcInteger and RcDouble, which don't conflict at all.
<a name="line-241"></a>--      This is a bit boring compared to what's in RegArchX86.
<a name="line-242"></a>--
<a name="line-243"></a>worst :: Int -&gt; RegClass -&gt; RegClass -&gt; Int
<a name="line-244"></a>worst n classN classC
<a name="line-245"></a> = case classN of
<a name="line-246"></a>        RcInteger
<a name="line-247"></a>         -&gt; case classC of
<a name="line-248"></a>                RcInteger       -&gt; min n (allocatableRegsInClass RcInteger)
<a name="line-249"></a>                RcFloat         -&gt; 0
<a name="line-250"></a>
<a name="line-251"></a>        RcDouble
<a name="line-252"></a>         -&gt; case classC of
<a name="line-253"></a>                RcFloat         -&gt; min n (allocatableRegsInClass RcFloat)
<a name="line-254"></a>                RcInteger       -&gt; 0
<a name="line-255"></a>
<a name="line-256"></a>-- allocatableRegs is allMachRegNos with the fixed-use regs removed.
<a name="line-257"></a>-- i.e., these are the regs for which we are prepared to allow the
<a name="line-258"></a>-- register allocator to attempt to map VRegs to.
<a name="line-259"></a>allocatableRegs :: [RegNo]
<a name="line-260"></a>allocatableRegs
<a name="line-261"></a>   = let isFree i = freeReg i
<a name="line-262"></a>     in  filter isFree allMachRegNos
<a name="line-263"></a>
<a name="line-264"></a>
<a name="line-265"></a>-- | The number of regs in each class.
<a name="line-266"></a>--      We go via top level CAFs to ensure that we're not recomputing
<a name="line-267"></a>--      the length of these lists each time the fn is called.
<a name="line-268"></a>allocatableRegsInClass :: RegClass -&gt; Int
<a name="line-269"></a>allocatableRegsInClass cls
<a name="line-270"></a> = case cls of
<a name="line-271"></a>        RcInteger       -&gt; allocatableRegsInteger
<a name="line-272"></a>        RcFloat         -&gt; allocatableRegsDouble
<a name="line-273"></a>
<a name="line-274"></a>allocatableRegsInteger :: Int
<a name="line-275"></a>allocatableRegsInteger
<a name="line-276"></a>        = length $ filter (\r -&gt; regClass r == RcInteger)
<a name="line-277"></a>                 $ map RealReg allocatableRegs
<a name="line-278"></a>
<a name="line-279"></a>allocatableRegsFloat :: Int
<a name="line-280"></a>allocatableRegsFloat
<a name="line-281"></a>        = length $ filter (\r -&gt; regClass r == RcFloat
<a name="line-282"></a>                 $ map RealReg allocatableRegs
<a name="line-283"></a>-}</span>
</pre></body>
</html>

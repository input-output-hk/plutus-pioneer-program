<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Core/Coercion.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP                 #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts    #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes          #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-5"></a>
<a name="line-6"></a><span class='hs-comment'>{-
<a name="line-7"></a>(c) The University of Glasgow 2006
<a name="line-8"></a>-}</span>
<a name="line-9"></a>
<a name="line-10"></a><span class='hs-comment'>-- | Module for (a) type kinds and (b) type coercions,</span>
<a name="line-11"></a><span class='hs-comment'>-- as used in System FC. See 'GHC.Core.Expr' for</span>
<a name="line-12"></a><span class='hs-comment'>-- more on System FC and how coercions fit into it.</span>
<a name="line-13"></a><span class='hs-comment'>--</span>
<a name="line-14"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Core.Coercion</span> <span class='hs-layout'>(</span>
<a name="line-15"></a>        <span class='hs-comment'>-- * Main data type</span>
<a name="line-16"></a>        <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionR</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionP</span><span class='hs-layout'>,</span> <span class='hs-conid'>MCoercion</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>MCoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>MCoercionR</span><span class='hs-layout'>,</span>
<a name="line-17"></a>        <span class='hs-conid'>UnivCoProvenance</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionHole</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-18"></a>        <span class='hs-varid'>coHoleCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoHoleCoVar</span><span class='hs-layout'>,</span>
<a name="line-19"></a>        <span class='hs-conid'>LeftOrRight</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-20"></a>        <span class='hs-conid'>Var</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-conid'>Role</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>ltRole</span><span class='hs-layout'>,</span>
<a name="line-22"></a>
<a name="line-23"></a>        <span class='hs-comment'>-- ** Functions over coercions</span>
<a name="line-24"></a>        <span class='hs-varid'>coVarTypes</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarKindsTypesRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarRole</span><span class='hs-layout'>,</span>
<a name="line-25"></a>        <span class='hs-varid'>coercionType</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoercionType</span><span class='hs-layout'>,</span>
<a name="line-26"></a>        <span class='hs-varid'>coercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionLKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionRKind</span><span class='hs-layout'>,</span><span class='hs-varid'>coercionKinds</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>coercionRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionKindRole</span><span class='hs-layout'>,</span>
<a name="line-28"></a>
<a name="line-29"></a>        <span class='hs-comment'>-- ** Constructing coercions</span>
<a name="line-30"></a>        <span class='hs-varid'>mkGReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRepReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNomReflCo</span><span class='hs-layout'>,</span>
<a name="line-31"></a>        <span class='hs-varid'>mkCoVarCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoVarCos</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>mkAxInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span><span class='hs-layout'>,</span>
<a name="line-33"></a>        <span class='hs-varid'>mkAxInstRHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstRHS</span><span class='hs-layout'>,</span>
<a name="line-34"></a>        <span class='hs-varid'>mkAxInstLHS</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstLHS</span><span class='hs-layout'>,</span>
<a name="line-35"></a>        <span class='hs-varid'>mkPiCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoCast</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>mkSymCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransCo</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>mkNthCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCoFunCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>nthCoRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkLRCo</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>mkInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConAppCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunResCo</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>mkForAllCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkForAllCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHomoForAllCos</span><span class='hs-layout'>,</span>
<a name="line-40"></a>        <span class='hs-varid'>mkPhantomCo</span><span class='hs-layout'>,</span>
<a name="line-41"></a>        <span class='hs-varid'>mkHoleCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnivCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSubCo</span><span class='hs-layout'>,</span>
<a name="line-42"></a>        <span class='hs-varid'>mkAxiomInstCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkProofIrrelCo</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>downgradeRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAxiomRuleCo</span><span class='hs-layout'>,</span>
<a name="line-44"></a>        <span class='hs-varid'>mkGReflRightCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGReflLeftCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoherenceLeftCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCoherenceRightCo</span><span class='hs-layout'>,</span>
<a name="line-45"></a>        <span class='hs-varid'>mkKindCo</span><span class='hs-layout'>,</span>
<a name="line-46"></a>        <span class='hs-varid'>castCoercionKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>castCoercionKind1</span><span class='hs-layout'>,</span> <span class='hs-varid'>castCoercionKind2</span><span class='hs-layout'>,</span>
<a name="line-47"></a>        <span class='hs-varid'>mkFamilyTyConAppCo</span><span class='hs-layout'>,</span>
<a name="line-48"></a>
<a name="line-49"></a>        <span class='hs-varid'>mkHeteroCoercionType</span><span class='hs-layout'>,</span>
<a name="line-50"></a>        <span class='hs-varid'>mkPrimEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkReprPrimEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPrimEqPredRole</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-varid'>mkHeteroPrimEqPred</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkHeteroReprPrimEqPred</span><span class='hs-layout'>,</span>
<a name="line-52"></a>
<a name="line-53"></a>        <span class='hs-comment'>-- ** Decomposition</span>
<a name="line-54"></a>        <span class='hs-varid'>instNewTyCon_maybe</span><span class='hs-layout'>,</span>
<a name="line-55"></a>
<a name="line-56"></a>        <span class='hs-conid'>NormaliseStepper</span><span class='hs-layout'>,</span> <span class='hs-conid'>NormaliseStepResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>composeSteppers</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>mapStepResult</span><span class='hs-layout'>,</span> <span class='hs-varid'>unwrapNewTypeStepper</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>topNormaliseNewType_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>topNormaliseTypeX</span><span class='hs-layout'>,</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-varid'>decomposeCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>decomposeFunCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>decomposePiCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-61"></a>        <span class='hs-varid'>splitTyConAppCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-62"></a>        <span class='hs-varid'>splitAppCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-63"></a>        <span class='hs-varid'>splitFunCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-varid'>splitForAllCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-65"></a>        <span class='hs-varid'>splitForAllCo_ty_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>splitForAllCo_co_maybe</span><span class='hs-layout'>,</span>
<a name="line-66"></a>
<a name="line-67"></a>        <span class='hs-varid'>nthRole</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConRolesX</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConRolesRepresentational</span><span class='hs-layout'>,</span> <span class='hs-varid'>setNominalRole_maybe</span><span class='hs-layout'>,</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-varid'>pickLR</span><span class='hs-layout'>,</span>
<a name="line-70"></a>
<a name="line-71"></a>        <span class='hs-varid'>isGReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflCo_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGReflCo_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflexiveCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>isReflexiveCo_maybe</span><span class='hs-layout'>,</span>
<a name="line-72"></a>        <span class='hs-varid'>isReflCoVar_maybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>isGReflMCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGReflLeftMCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkGReflRightMCo</span><span class='hs-layout'>,</span>
<a name="line-73"></a>        <span class='hs-varid'>mkCoherenceRightMCo</span><span class='hs-layout'>,</span>
<a name="line-74"></a>
<a name="line-75"></a>        <span class='hs-varid'>coToMCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransMCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransMCoL</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTransMCoR</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkCastTyMCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkSymMCo</span><span class='hs-layout'>,</span>
<a name="line-76"></a>        <span class='hs-varid'>mkHomoForAllMCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkFunResMCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkPiMCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkReflexiveMCo</span><span class='hs-layout'>,</span>
<a name="line-77"></a>        <span class='hs-varid'>isReflMCo</span><span class='hs-layout'>,</span>
<a name="line-78"></a>
<a name="line-79"></a>        <span class='hs-comment'>-- ** Coercion variables</span>
<a name="line-80"></a>        <span class='hs-varid'>mkCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarName</span><span class='hs-layout'>,</span> <span class='hs-varid'>setCoVarUnique</span><span class='hs-layout'>,</span>
<a name="line-81"></a>        <span class='hs-varid'>isCoVar_maybe</span><span class='hs-layout'>,</span>
<a name="line-82"></a>
<a name="line-83"></a>        <span class='hs-comment'>-- ** Free variables</span>
<a name="line-84"></a>        <span class='hs-varid'>tyCoVarsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarsOfCo</span><span class='hs-layout'>,</span>
<a name="line-85"></a>        <span class='hs-varid'>tyCoFVsOfCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoFVsOfCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyCoVarsOfCoDSet</span><span class='hs-layout'>,</span>
<a name="line-86"></a>        <span class='hs-varid'>coercionSize</span><span class='hs-layout'>,</span> <span class='hs-varid'>anyFreeVarsOfCo</span><span class='hs-layout'>,</span>
<a name="line-87"></a>
<a name="line-88"></a>        <span class='hs-comment'>-- ** Substitution</span>
<a name="line-89"></a>        <span class='hs-conid'>CvSubstEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyCvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-90"></a>        <span class='hs-varid'>lookupCoVar</span><span class='hs-layout'>,</span>
<a name="line-91"></a>        <span class='hs-varid'>substCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCos</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>substCoWith</span><span class='hs-layout'>,</span>
<a name="line-92"></a>        <span class='hs-varid'>substCoVarBndr</span><span class='hs-layout'>,</span>
<a name="line-93"></a>        <span class='hs-varid'>extendTvSubstAndInScope</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCvSubstEnv</span><span class='hs-layout'>,</span>
<a name="line-94"></a>
<a name="line-95"></a>        <span class='hs-comment'>-- ** Lifting</span>
<a name="line-96"></a>        <span class='hs-varid'>liftCoSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstTyVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstWith</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftCoSubstWithEx</span><span class='hs-layout'>,</span>
<a name="line-97"></a>        <span class='hs-varid'>emptyLiftingContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendLiftingContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendLiftingContextAndInScope</span><span class='hs-layout'>,</span>
<a name="line-98"></a>        <span class='hs-varid'>liftCoSubstVarBndrUsing</span><span class='hs-layout'>,</span> <span class='hs-varid'>isMappedByLC</span><span class='hs-layout'>,</span>
<a name="line-99"></a>
<a name="line-100"></a>        <span class='hs-varid'>mkSubstLiftingContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>zapLiftingContext</span><span class='hs-layout'>,</span>
<a name="line-101"></a>        <span class='hs-varid'>substForAllCoBndrUsingLC</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcTCvSubst</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcInScopeSet</span><span class='hs-layout'>,</span>
<a name="line-102"></a>
<a name="line-103"></a>        <span class='hs-conid'>LiftCoEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>LiftingContext</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftEnvSubstLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftEnvSubstRight</span><span class='hs-layout'>,</span>
<a name="line-104"></a>        <span class='hs-varid'>substRightCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>substLeftCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>swapLiftCoEnv</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcSubstLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>lcSubstRight</span><span class='hs-layout'>,</span>
<a name="line-105"></a>
<a name="line-106"></a>        <span class='hs-comment'>-- ** Comparison</span>
<a name="line-107"></a>        <span class='hs-varid'>eqCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqCoercionX</span><span class='hs-layout'>,</span>
<a name="line-108"></a>
<a name="line-109"></a>        <span class='hs-comment'>-- ** Forcing evaluation of coercions</span>
<a name="line-110"></a>        <span class='hs-varid'>seqCo</span><span class='hs-layout'>,</span>
<a name="line-111"></a>
<a name="line-112"></a>        <span class='hs-comment'>-- * Pretty-printing</span>
<a name="line-113"></a>        <span class='hs-varid'>pprCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprParendCo</span><span class='hs-layout'>,</span>
<a name="line-114"></a>        <span class='hs-varid'>pprCoAxiom</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranch</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprCoAxBranchLHS</span><span class='hs-layout'>,</span>
<a name="line-115"></a>        <span class='hs-varid'>pprCoAxBranchUser</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCoAxBndrsForUser</span><span class='hs-layout'>,</span>
<a name="line-116"></a>        <span class='hs-varid'>etaExpandCoAxBranch</span><span class='hs-layout'>,</span>
<a name="line-117"></a>
<a name="line-118"></a>        <span class='hs-comment'>-- * Tidying</span>
<a name="line-119"></a>        <span class='hs-varid'>tidyCo</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyCos</span><span class='hs-layout'>,</span>
<a name="line-120"></a>
<a name="line-121"></a>        <span class='hs-comment'>-- * Other</span>
<a name="line-122"></a>        <span class='hs-varid'>promoteCoercion</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildCoercion</span><span class='hs-layout'>,</span>
<a name="line-123"></a>
<a name="line-124"></a>        <span class='hs-varid'>multToCo</span><span class='hs-layout'>,</span>
<a name="line-125"></a>
<a name="line-126"></a>        <span class='hs-varid'>simplifyArgsWorker</span><span class='hs-layout'>,</span>
<a name="line-127"></a>
<a name="line-128"></a>        <span class='hs-varid'>hasCoercionHoleTy</span><span class='hs-layout'>,</span> <span class='hs-varid'>hasCoercionHoleCo</span><span class='hs-layout'>,</span>
<a name="line-129"></a>        <span class='hs-conid'>HoleSet</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionHolesOfType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionHolesOfCo</span>
<a name="line-130"></a>       <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-131"></a>
<a name="line-132"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-133"></a>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.CoreToIface</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidyToIfaceTcArgs</span><span class='hs-layout'>)</span>
<a name="line-135"></a>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-137"></a>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Type</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.FVs</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Ppr</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Subst</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Tidy</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon.RecWalk</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Coercion.Axiom</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>GHC.Core.Utils</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkFunctionType</span> <span class='hs-layout'>)</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>varName</span> <span class='hs-layout'>)</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Pair</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types.Prim</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.List.SetOps</span>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-163"></a>
<a name="line-164"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-167"></a>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldM</span><span class='hs-layout'>,</span> <span class='hs-varid'>zipWithM</span><span class='hs-layout'>)</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Function</span> <span class='hs-layout'>(</span> <span class='hs-varid'>on</span> <span class='hs-layout'>)</span>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Char</span><span class='hs-layout'>(</span> <span class='hs-varid'>isDigit</span> <span class='hs-layout'>)</span>
<a name="line-171"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Monoid</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Monoid</span>
<a name="line-172"></a>
<a name="line-173"></a><span class='hs-comment'>{-
<a name="line-174"></a>%************************************************************************
<a name="line-175"></a>%*                                                                      *
<a name="line-176"></a>     -- The coercion arguments always *precisely* saturate
<a name="line-177"></a>     -- arity of (that branch of) the CoAxiom.  If there are
<a name="line-178"></a>     -- any left over, we use AppCo.  See
<a name="line-179"></a>     -- See [Coercion axioms applied to coercions] in GHC.Core.TyCo.Rep
<a name="line-180"></a>
<a name="line-181"></a>\subsection{Coercion variables}
<a name="line-182"></a>%*                                                                      *
<a name="line-183"></a>%************************************************************************
<a name="line-184"></a>-}</span>
<a name="line-185"></a>
<a name="line-186"></a><a name="coVarName"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-187"></a><span class='hs-definition'>coVarName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varName</span>
<a name="line-188"></a>
<a name="line-189"></a><a name="setCoVarUnique"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Unique</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-190"></a><span class='hs-definition'>setCoVarUnique</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarUnique</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="setCoVarName"></a><span class='hs-definition'>setCoVarName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-193"></a><span class='hs-definition'>setCoVarName</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarName</span>
<a name="line-194"></a>
<a name="line-195"></a><span class='hs-comment'>{-
<a name="line-196"></a>%************************************************************************
<a name="line-197"></a>%*                                                                      *
<a name="line-198"></a>                   Pretty-printing CoAxioms
<a name="line-199"></a>%*                                                                      *
<a name="line-200"></a>%************************************************************************
<a name="line-201"></a>
<a name="line-202"></a>Defined here to avoid module loops. CoAxiom is loaded very early on.
<a name="line-203"></a>
<a name="line-204"></a>-}</span>
<a name="line-205"></a>
<a name="line-206"></a><a name="etaExpandCoAxBranch"></a><span class='hs-definition'>etaExpandCoAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-207"></a><span class='hs-comment'>-- Return the (tvs,lhs,rhs) after eta-expanding,</span>
<a name="line-208"></a><span class='hs-comment'>-- to the way in which the axiom was originally written</span>
<a name="line-209"></a><span class='hs-comment'>-- See Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom</span>
<a name="line-210"></a><span class='hs-definition'>etaExpandCoAxBranch</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-211"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>cab_eta_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eta_tvs</span>
<a name="line-212"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span>
<a name="line-213"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-214"></a>  <span class='hs-comment'>-- ToDo: what about eta_cvs?</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>eta_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>lhs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>eta_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>rhs</span> <span class='hs-varid'>eta_tys</span><span class='hs-layout'>)</span>
<a name="line-216"></a> <span class='hs-keyword'>where</span>
<a name="line-217"></a>    <span class='hs-varid'>eta_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTys</span> <span class='hs-varid'>eta_tvs</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="pprCoAxiom"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-220"></a><span class='hs-comment'>-- Used in debug-printing only</span>
<a name="line-221"></a><span class='hs-definition'>pprCoAxiom</span> <span class='hs-varid'>ax</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>CoAxiom</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_ax_tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_ax_branches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>branches</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"axiom"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ax</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span><span class='hs-layout'>)</span>
<a name="line-223"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprCoAxBranchUser</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromBranches</span> <span class='hs-varid'>branches</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-224"></a>
<a name="line-225"></a><a name="pprCoAxBranchUser"></a><span class='hs-definition'>pprCoAxBranchUser</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-226"></a><span class='hs-comment'>-- Used when printing injectivity errors (FamInst.reportInjectivityErrors)</span>
<a name="line-227"></a><span class='hs-comment'>-- and inaccessible branches (GHC.Tc.Validity.inaccessibleCoAxBranch)</span>
<a name="line-228"></a><span class='hs-comment'>-- This happens in error messages: don't print the RHS of a data</span>
<a name="line-229"></a><span class='hs-comment'>--   family axiom, which is meaningless to a user</span>
<a name="line-230"></a><span class='hs-definition'>pprCoAxBranchUser</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>br</span>
<a name="line-231"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isDataFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCoAxBranchLHS</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>br</span>
<a name="line-232"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprCoAxBranch</span>    <span class='hs-varid'>tc</span> <span class='hs-varid'>br</span>
<a name="line-233"></a>
<a name="line-234"></a><a name="pprCoAxBranchLHS"></a><span class='hs-definition'>pprCoAxBranchLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-235"></a><span class='hs-comment'>-- Print the family-instance equation when reporting</span>
<a name="line-236"></a><span class='hs-comment'>--   a conflict between equations (FamInst.conflictInstErr)</span>
<a name="line-237"></a><span class='hs-comment'>-- For type families the RHS is important; for data families not so.</span>
<a name="line-238"></a><span class='hs-comment'>--   Indeed for data families the RHS is a mysterious internal</span>
<a name="line-239"></a><span class='hs-comment'>--   type constructor, so we suppress it (#14179)</span>
<a name="line-240"></a><span class='hs-comment'>-- See FamInstEnv Note [Family instance overlap conflicts]</span>
<a name="line-241"></a><span class='hs-definition'>pprCoAxBranchLHS</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co_ax_branch</span> <span class='hs-varid'>pp_rhs</span>
<a name="line-242"></a>  <span class='hs-keyword'>where</span>
<a name="line-243"></a>    <span class='hs-varid'>pp_rhs</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="pprCoAxBranch"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-246"></a><span class='hs-definition'>pprCoAxBranch</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr_co_ax_branch</span> <span class='hs-varid'>ppr_rhs</span>
<a name="line-247"></a>  <span class='hs-keyword'>where</span>
<a name="line-248"></a>    <span class='hs-varid'>ppr_rhs</span> <span class='hs-varid'>env</span> <span class='hs-varid'>rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprPrecTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varid'>topPrec</span> <span class='hs-varid'>rhs</span>
<a name="line-249"></a>
<a name="line-250"></a><a name="ppr_co_ax_branch"></a><span class='hs-definition'>ppr_co_ax_branch</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-251"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-252"></a><span class='hs-definition'>ppr_co_ax_branch</span> <span class='hs-varid'>ppr_rhs</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>branch</span>
<a name="line-253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr1</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varid'>hangNotEmpty</span> <span class='hs-num'>2</span><span class='hs-layout'>)</span>
<a name="line-254"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprUserForAll</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyCoVarBinders</span> <span class='hs-conid'>Inferred</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span>
<a name="line-255"></a>         <span class='hs-comment'>-- See Note [Printing foralls in type family instances] in GHC.Iface.Type</span>
<a name="line-256"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>pp_lhs</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_rhs</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ee_rhs</span>
<a name="line-257"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"-- Defined"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pp_loc</span> <span class='hs-keyglyph'>]</span>
<a name="line-258"></a>  <span class='hs-keyword'>where</span>
<a name="line-259"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchSpan</span> <span class='hs-varid'>branch</span>
<a name="line-260"></a>    <span class='hs-varid'>pp_loc</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGoodSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"at"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>srcSpanStart</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-261"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"in"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>loc</span>
<a name="line-262"></a>
<a name="line-263"></a>    <span class='hs-comment'>-- Eta-expand LHS and RHS types, because sometimes data family</span>
<a name="line-264"></a>    <span class='hs-comment'>-- instances are eta-reduced.</span>
<a name="line-265"></a>    <span class='hs-comment'>-- See Note [Eta reduction for data families] in GHC.Core.Coercion.Axiom.</span>
<a name="line-266"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ee_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ee_lhs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ee_rhs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>etaExpandCoAxBranch</span> <span class='hs-varid'>branch</span>
<a name="line-267"></a>
<a name="line-268"></a>    <span class='hs-varid'>pp_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprIfaceTypeApp</span> <span class='hs-varid'>topPrec</span> <span class='hs-layout'>(</span><span class='hs-varid'>toIfaceTyCon</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>)</span>
<a name="line-269"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>tidyToIfaceTcArgs</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>ee_lhs</span><span class='hs-layout'>)</span>
<a name="line-270"></a>
<a name="line-271"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndrs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyCoAxBndrsForUser</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>ee_tvs</span>
<a name="line-272"></a>
<a name="line-273"></a><a name="tidyCoAxBndrsForUser"></a><span class='hs-definition'>tidyCoAxBndrsForUser</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-274"></a><span class='hs-comment'>-- Tidy wildcards "_1", "_2" to "_", and do not return them</span>
<a name="line-275"></a><span class='hs-comment'>-- in the list of binders to be printed</span>
<a name="line-276"></a><span class='hs-comment'>-- This is so that in error messages we see</span>
<a name="line-277"></a><span class='hs-comment'>--     forall a. F _ [a] _ = ...</span>
<a name="line-278"></a><span class='hs-comment'>-- rather than</span>
<a name="line-279"></a><span class='hs-comment'>--     forall a _1 _2. F _1 [a] _2 = ...</span>
<a name="line-280"></a><span class='hs-comment'>--</span>
<a name="line-281"></a><span class='hs-comment'>-- This is a rather disgusting function</span>
<a name="line-282"></a><span class='hs-comment'>-- See Note [Wildcard names] in GHC.Tc.Gen.HsType</span>
<a name="line-283"></a><span class='hs-definition'>tidyCoAxBndrsForUser</span> <span class='hs-varid'>init_env</span> <span class='hs-varid'>tcvs</span>
<a name="line-284"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>tidy_bndrs</span><span class='hs-layout'>)</span>
<a name="line-285"></a>  <span class='hs-keyword'>where</span>
<a name="line-286"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl</span> <span class='hs-varid'>tidy_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>init_env</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-varid'>tcvs</span>
<a name="line-287"></a>
<a name="line-288"></a>    <span class='hs-varid'>tidy_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>rev_bndrs'</span><span class='hs-layout'>)</span> <span class='hs-varid'>bndr</span>
<a name="line-289"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_wildcard</span> <span class='hs-varid'>bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env_wild</span><span class='hs-layout'>,</span> <span class='hs-varid'>rev_bndrs'</span><span class='hs-layout'>)</span>
<a name="line-290"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span>     <span class='hs-varid'>bndr'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rev_bndrs'</span><span class='hs-layout'>)</span>
<a name="line-291"></a>      <span class='hs-keyword'>where</span>
<a name="line-292"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>bndr'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyVarBndr</span> <span class='hs-varid'>env</span> <span class='hs-varid'>bndr</span>
<a name="line-293"></a>        <span class='hs-varid'>env_wild</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>bndr</span> <span class='hs-varid'>wild_bndr</span><span class='hs-layout'>)</span>
<a name="line-294"></a>        <span class='hs-varid'>wild_bndr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarName</span> <span class='hs-varid'>bndr</span> <span class='hs-varop'>$</span>
<a name="line-295"></a>                    <span class='hs-varid'>tidyNameOcc</span> <span class='hs-layout'>(</span><span class='hs-varid'>varName</span> <span class='hs-varid'>bndr</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarOcc</span> <span class='hs-str'>"_"</span><span class='hs-layout'>)</span>
<a name="line-296"></a>                    <span class='hs-comment'>-- Tidy the binder to "_"</span>
<a name="line-297"></a>
<a name="line-298"></a>    <span class='hs-varid'>is_wildcard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-299"></a>    <span class='hs-varid'>is_wildcard</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>occNameString</span> <span class='hs-layout'>(</span><span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-300"></a>                       <span class='hs-layout'>(</span><span class='hs-chr'>'_'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isDigit</span> <span class='hs-varid'>rest</span>
<a name="line-301"></a>                       <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-302"></a>
<a name="line-303"></a>
<a name="line-304"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-305"></a>*                                                                      *
<a name="line-306"></a>              MCoercion
<a name="line-307"></a>*                                                                      *
<a name="line-308"></a>********************************************************************* -}</span>
<a name="line-309"></a>
<a name="line-310"></a><a name="coToMCo"></a><span class='hs-definition'>coToMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-311"></a><span class='hs-comment'>-- Convert a coercion to a MCoercion,</span>
<a name="line-312"></a><span class='hs-comment'>-- It's not clear whether or not isReflexiveCo would be better here</span>
<a name="line-313"></a><span class='hs-definition'>coToMCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-314"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span>
<a name="line-315"></a>
<a name="line-316"></a><a name="checkReflexiveMCo"></a><span class='hs-definition'>checkReflexiveMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-317"></a><span class='hs-definition'>checkReflexiveMCo</span> <span class='hs-conid'>MRefl</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-318"></a><span class='hs-definition'>checkReflexiveMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflexiveCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-319"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span>
<a name="line-320"></a>
<a name="line-321"></a><a name="isGReflMCo"></a><span class='hs-comment'>-- | Tests if this MCoercion is obviously generalized reflexive</span>
<a name="line-322"></a><span class='hs-comment'>-- Guaranteed to work very quickly.</span>
<a name="line-323"></a><span class='hs-definition'>isGReflMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-324"></a><span class='hs-definition'>isGReflMCo</span> <span class='hs-conid'>MRefl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-325"></a><span class='hs-definition'>isGReflMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-326"></a><span class='hs-definition'>isGReflMCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-327"></a>
<a name="line-328"></a><a name="mkGReflCo"></a><span class='hs-comment'>-- | Make a generalized reflexive coercion</span>
<a name="line-329"></a><span class='hs-definition'>mkGReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-330"></a><span class='hs-definition'>mkGReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span>
<a name="line-331"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflMCo</span> <span class='hs-varid'>mco</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyword'>then</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span>
<a name="line-332"></a>                     <span class='hs-keyword'>else</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span>
<a name="line-333"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span>
<a name="line-334"></a>
<a name="line-335"></a><a name="mkTransMCo"></a><span class='hs-comment'>-- | Compose two MCoercions via transitivity</span>
<a name="line-336"></a><span class='hs-definition'>mkTransMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-337"></a><span class='hs-definition'>mkTransMCo</span> <span class='hs-conid'>MRefl</span>     <span class='hs-varid'>co2</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span>
<a name="line-338"></a><span class='hs-definition'>mkTransMCo</span> <span class='hs-varid'>co1</span>       <span class='hs-conid'>MRefl</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co1</span>
<a name="line-339"></a><span class='hs-definition'>mkTransMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-340"></a>
<a name="line-341"></a><a name="mkTransMCoL"></a><span class='hs-definition'>mkTransMCoL</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-342"></a><span class='hs-definition'>mkTransMCoL</span> <span class='hs-conid'>MRefl</span>     <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coToMCo</span> <span class='hs-varid'>co2</span>
<a name="line-343"></a><span class='hs-definition'>mkTransMCoL</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="mkTransMCoR"></a><span class='hs-definition'>mkTransMCoR</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-346"></a><span class='hs-definition'>mkTransMCoR</span> <span class='hs-varid'>co1</span> <span class='hs-conid'>MRefl</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coToMCo</span> <span class='hs-varid'>co1</span>
<a name="line-347"></a><span class='hs-definition'>mkTransMCoR</span> <span class='hs-varid'>co1</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-348"></a>
<a name="line-349"></a><a name="mkSymMCo"></a><span class='hs-comment'>-- | Get the reverse of an 'MCoercion'</span>
<a name="line-350"></a><span class='hs-definition'>mkSymMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-351"></a><span class='hs-definition'>mkSymMCo</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-352"></a><span class='hs-definition'>mkSymMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-353"></a>
<a name="line-354"></a><a name="mkCastTyMCo"></a><span class='hs-comment'>-- | Cast a type by an 'MCoercion'</span>
<a name="line-355"></a><span class='hs-definition'>mkCastTyMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-356"></a><span class='hs-definition'>mkCastTyMCo</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-357"></a><span class='hs-definition'>mkCastTyMCo</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>co</span>
<a name="line-358"></a>
<a name="line-359"></a><a name="mkHomoForAllMCo"></a><span class='hs-definition'>mkHomoForAllMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-360"></a><span class='hs-definition'>mkHomoForAllMCo</span> <span class='hs-keyword'>_</span>   <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-361"></a><span class='hs-definition'>mkHomoForAllMCo</span> <span class='hs-varid'>tcv</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHomoForAllCos</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tcv</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-362"></a>
<a name="line-363"></a><a name="mkPiMCos"></a><span class='hs-definition'>mkPiMCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercion</span>
<a name="line-364"></a><span class='hs-definition'>mkPiMCos</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>MRefl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-365"></a><span class='hs-definition'>mkPiMCos</span> <span class='hs-varid'>vs</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiCos</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="mkFunResMCo"></a><span class='hs-definition'>mkFunResMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercionR</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercionR</span>
<a name="line-368"></a><span class='hs-definition'>mkFunResMCo</span> <span class='hs-keyword'>_</span>      <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-369"></a><span class='hs-definition'>mkFunResMCo</span> <span class='hs-varid'>arg_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFunResCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>arg_ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-370"></a>
<a name="line-371"></a><a name="mkGReflLeftMCo"></a><span class='hs-definition'>mkGReflLeftMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-372"></a><span class='hs-definition'>mkGReflLeftMCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-373"></a><span class='hs-definition'>mkGReflLeftMCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGReflLeftCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-374"></a>
<a name="line-375"></a><a name="mkGReflRightMCo"></a><span class='hs-definition'>mkGReflRightMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-376"></a><span class='hs-definition'>mkGReflRightMCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-377"></a><span class='hs-definition'>mkGReflRightMCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGReflRightCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-378"></a>
<a name="line-379"></a><a name="mkCoherenceRightMCo"></a><span class='hs-comment'>-- | Like 'mkCoherenceRightCo', but with an 'MCoercion'</span>
<a name="line-380"></a><span class='hs-definition'>mkCoherenceRightMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MCoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-381"></a><span class='hs-definition'>mkCoherenceRightMCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>  <span class='hs-conid'>MRefl</span>    <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span>
<a name="line-382"></a><span class='hs-definition'>mkCoherenceRightMCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoherenceRightCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-varid'>co2</span>
<a name="line-383"></a>
<a name="line-384"></a><a name="isReflMCo"></a><span class='hs-definition'>isReflMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-385"></a><span class='hs-definition'>isReflMCo</span> <span class='hs-conid'>MRefl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-386"></a><span class='hs-definition'>isReflMCo</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-387"></a>
<a name="line-388"></a><span class='hs-comment'>{-
<a name="line-389"></a>%************************************************************************
<a name="line-390"></a>%*                                                                      *
<a name="line-391"></a>        Destructing coercions
<a name="line-392"></a>%*                                                                      *
<a name="line-393"></a>%************************************************************************
<a name="line-394"></a>
<a name="line-395"></a>Note [Function coercions]
<a name="line-396"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-397"></a>Remember that
<a name="line-398"></a>  (-&gt;) :: forall {r1} {r2}. TYPE r1 -&gt; TYPE r2 -&gt; TYPE LiftedRep
<a name="line-399"></a>whose `RuntimeRep' arguments are intentionally marked inferred to
<a name="line-400"></a>avoid type application.
<a name="line-401"></a>
<a name="line-402"></a>Hence
<a name="line-403"></a>  FunCo r mult co1 co2 :: (s1-&gt;t1) ~r (s2-&gt;t2)
<a name="line-404"></a>is short for
<a name="line-405"></a>  TyConAppCo (-&gt;) mult co_rep1 co_rep2 co1 co2
<a name="line-406"></a>where co_rep1, co_rep2 are the coercions on the representations.
<a name="line-407"></a>-}</span>
<a name="line-408"></a>
<a name="line-409"></a>
<a name="line-410"></a><a name="decomposeCo"></a><span class='hs-comment'>-- | This breaks a 'Coercion' with type @T A B C ~ T D E F@ into</span>
<a name="line-411"></a><span class='hs-comment'>-- a list of 'Coercion's of kinds @A ~ D@, @B ~ E@ and @E ~ F@. Hence:</span>
<a name="line-412"></a><span class='hs-comment'>--</span>
<a name="line-413"></a><span class='hs-comment'>-- &gt; decomposeCo 3 c [r1, r2, r3] = [nth r1 0 c, nth r2 1 c, nth r3 2 c]</span>
<a name="line-414"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Arity</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-415"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- the roles of the output coercions</span>
<a name="line-416"></a>                       <span class='hs-comment'>-- this must have at least as many</span>
<a name="line-417"></a>                       <span class='hs-comment'>-- entries as the Arity provided</span>
<a name="line-418"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-419"></a><span class='hs-definition'>decomposeCo</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>co</span> <span class='hs-varid'>rs</span>
<a name="line-420"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span><span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-num'>0</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>(</span><span class='hs-varid'>arity</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>]</span>
<a name="line-421"></a>           <span class='hs-comment'>-- Remember, Nth is zero-indexed</span>
<a name="line-422"></a>
<a name="line-423"></a><a name="decomposeFunCo"></a><span class='hs-definition'>decomposeFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-424"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Role</span>      <span class='hs-comment'>-- Role of the input coercion</span>
<a name="line-425"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>  <span class='hs-comment'>-- Input coercion</span>
<a name="line-426"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-427"></a><span class='hs-comment'>-- Expects co :: (s1 -&gt; t1) ~ (s2 -&gt; t2)</span>
<a name="line-428"></a><span class='hs-comment'>-- Returns (co1 :: s1~s2, co2 :: t1~t2)</span>
<a name="line-429"></a><span class='hs-comment'>-- See Note [Function coercions] for the "3" and "4"</span>
<a name="line-430"></a><span class='hs-definition'>decomposeFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>all_ok</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-layout'>)</span>
<a name="line-431"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>mkNthCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-num'>0</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-num'>3</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-num'>4</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-432"></a>  <span class='hs-keyword'>where</span>
<a name="line-433"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>s1t1</span> <span class='hs-varid'>s2t2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-434"></a>    <span class='hs-varid'>all_ok</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>s1t1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>s2t2</span>
<a name="line-435"></a>
<a name="line-436"></a><span class='hs-comment'>{- Note [Pushing a coercion into a pi-type]
<a name="line-437"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-438"></a>Suppose we have this:
<a name="line-439"></a>    (f |&gt; co) t1 .. tn
<a name="line-440"></a>Then we want to push the coercion into the arguments, so as to make
<a name="line-441"></a>progress. For example of why you might want to do so, see Note
<a name="line-442"></a>[Respecting definitional equality] in GHC.Core.TyCo.Rep.
<a name="line-443"></a>
<a name="line-444"></a>This is done by decomposePiCos.  Specifically, if
<a name="line-445"></a>    decomposePiCos co [t1,..,tn] = ([co1,...,cok], cor)
<a name="line-446"></a>then
<a name="line-447"></a>    (f |&gt; co) t1 .. tn   =   (f (t1 |&gt; co1) ... (tk |&gt; cok)) |&gt; cor) t(k+1) ... tn
<a name="line-448"></a>
<a name="line-449"></a>Notes:
<a name="line-450"></a>
<a name="line-451"></a>* k can be smaller than n! That is decomposePiCos can return *fewer*
<a name="line-452"></a>  coercions than there are arguments (ie k &lt; n), if the kind provided
<a name="line-453"></a>  doesn't have enough binders.
<a name="line-454"></a>
<a name="line-455"></a>* If there is a type error, we might see
<a name="line-456"></a>       (f |&gt; co) t1
<a name="line-457"></a>  where co :: (forall a. ty) ~ (ty1 -&gt; ty2)
<a name="line-458"></a>  Here 'co' is insoluble, but we don't want to crash in decoposePiCos.
<a name="line-459"></a>  So decomposePiCos carefully tests both sides of the coercion to check
<a name="line-460"></a>  they are both foralls or both arrows.  Not doing this caused #15343.
<a name="line-461"></a>-}</span>
<a name="line-462"></a>
<a name="line-463"></a><a name="decomposePiCos"></a><span class='hs-definition'>decomposePiCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-464"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>  <span class='hs-comment'>-- Coercion and its kind</span>
<a name="line-465"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-466"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>CoercionN</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>)</span>
<a name="line-467"></a><span class='hs-comment'>-- See Note [Pushing a coercion into a pi-type]</span>
<a name="line-468"></a><span class='hs-definition'>decomposePiCos</span> <span class='hs-varid'>orig_co</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>orig_k1</span> <span class='hs-varid'>orig_k2</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_args</span>
<a name="line-469"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>orig_subst</span><span class='hs-layout'>,</span><span class='hs-varid'>orig_k1</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>orig_subst</span><span class='hs-layout'>,</span><span class='hs-varid'>orig_k2</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_args</span>
<a name="line-470"></a>  <span class='hs-keyword'>where</span>
<a name="line-471"></a>    <span class='hs-varid'>orig_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span>
<a name="line-472"></a>                 <span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>orig_args</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>orig_co</span>
<a name="line-473"></a>
<a name="line-474"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoercionN</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- accumulator for argument coercions, reversed</span>
<a name="line-475"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span><span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Lhs kind of coercion</span>
<a name="line-476"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span>        <span class='hs-comment'>-- coercion originally applied to the function</span>
<a name="line-477"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span><span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Rhs kind of coercion</span>
<a name="line-478"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>           <span class='hs-comment'>-- Arguments to that function</span>
<a name="line-479"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>CoercionN</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-480"></a>    <span class='hs-comment'>-- Invariant:  co :: subst1(k1) ~ subst2(k2)</span>
<a name="line-481"></a>
<a name="line-482"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_cos</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst1</span><span class='hs-layout'>,</span><span class='hs-varid'>k1</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst2</span><span class='hs-layout'>,</span><span class='hs-varid'>k2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-483"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>k1</span>
<a name="line-484"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>k2</span>
<a name="line-485"></a>        <span class='hs-comment'>-- know     co :: (forall a:s1.t1) ~ (forall b:s2.t2)</span>
<a name="line-486"></a>        <span class='hs-comment'>--    function :: forall a:s1.t1   (the function is not passed to decomposePiCos)</span>
<a name="line-487"></a>        <span class='hs-comment'>--           a :: s1</span>
<a name="line-488"></a>        <span class='hs-comment'>--           b :: s2</span>
<a name="line-489"></a>        <span class='hs-comment'>--          ty :: s2</span>
<a name="line-490"></a>        <span class='hs-comment'>-- need arg_co :: s2 ~ s1</span>
<a name="line-491"></a>        <span class='hs-comment'>--      res_co :: t1[ty |&gt; arg_co / a] ~ t2[ty / b]</span>
<a name="line-492"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-493"></a>            <span class='hs-varid'>res_co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkGReflLeftCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>arg_co</span><span class='hs-layout'>)</span>
<a name="line-494"></a>            <span class='hs-varid'>subst1'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>a</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-varop'>`CastTy`</span> <span class='hs-varid'>arg_co</span><span class='hs-layout'>)</span>
<a name="line-495"></a>            <span class='hs-varid'>subst2'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst2</span> <span class='hs-varid'>b</span> <span class='hs-varid'>ty</span>
<a name="line-496"></a>        <span class='hs-keyword'>in</span>
<a name="line-497"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_arg_cos</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst1'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst2'</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-498"></a>
<a name="line-499"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-sel'>_w1</span><span class='hs-layout'>,</span> <span class='hs-sel'>_s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>k1</span>
<a name="line-500"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-sel'>_w1</span><span class='hs-layout'>,</span> <span class='hs-sel'>_s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitFunTy_maybe</span> <span class='hs-varid'>k2</span>
<a name="line-501"></a>        <span class='hs-comment'>-- know     co :: (s1 -&gt; t1) ~ (s2 -&gt; t2)</span>
<a name="line-502"></a>        <span class='hs-comment'>--    function :: s1 -&gt; t1</span>
<a name="line-503"></a>        <span class='hs-comment'>--          ty :: s2</span>
<a name="line-504"></a>        <span class='hs-comment'>-- need arg_co :: s2 ~ s1</span>
<a name="line-505"></a>        <span class='hs-comment'>--      res_co :: t1 ~ t2</span>
<a name="line-506"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>sym_arg_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposeFunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co</span>
<a name="line-507"></a>            <span class='hs-comment'>-- It should be fine to ignore the multiplicity bit of the coercion</span>
<a name="line-508"></a>            <span class='hs-comment'>-- for a Nominal coercion.</span>
<a name="line-509"></a>            <span class='hs-varid'>arg_co</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>sym_arg_co</span>
<a name="line-510"></a>        <span class='hs-keyword'>in</span>
<a name="line-511"></a>        <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_arg_cos</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst1</span><span class='hs-layout'>,</span><span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst2</span><span class='hs-layout'>,</span><span class='hs-varid'>t2</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-512"></a>
<a name="line-513"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst2</span><span class='hs-layout'>)</span>
<a name="line-514"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_cos</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapTCvSubst</span> <span class='hs-varid'>subst1</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>
<a name="line-515"></a>                       <span class='hs-varid'>co</span>
<a name="line-516"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>zapTCvSubst</span> <span class='hs-varid'>subst2</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst1</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-517"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-518"></a>
<a name="line-519"></a>      <span class='hs-comment'>-- tys might not be empty, if the left-hand type of the original coercion</span>
<a name="line-520"></a>      <span class='hs-comment'>-- didn't have enough binders</span>
<a name="line-521"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_arg_cos</span> <span class='hs-sel'>_ki1</span> <span class='hs-varid'>co</span> <span class='hs-sel'>_ki2</span> <span class='hs-sel'>_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_arg_cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-522"></a>
<a name="line-523"></a><a name="getCoVar_maybe"></a><span class='hs-comment'>-- | Attempts to obtain the type variable underlying a 'Coercion'</span>
<a name="line-524"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-525"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv</span>
<a name="line-526"></a><span class='hs-definition'>getCoVar_maybe</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-527"></a>
<a name="line-528"></a><a name="splitTyConAppCo_maybe"></a><span class='hs-comment'>-- | Attempts to tease a coercion apart into a type constructor and the application</span>
<a name="line-529"></a><span class='hs-comment'>-- of a number of coercion arguments to that constructor</span>
<a name="line-530"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCon</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-531"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-532"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-533"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-534"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-535"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-536"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-537"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>funTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-538"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>res</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-keyglyph'>]</span>
<a name="line-539"></a><span class='hs-definition'>splitTyConAppCo_maybe</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-540"></a>
<a name="line-541"></a><a name="multToCo"></a><span class='hs-definition'>multToCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Mult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-542"></a><span class='hs-definition'>multToCo</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>r</span>
<a name="line-543"></a>
<a name="line-544"></a><a name="splitAppCo_maybe"></a><span class='hs-comment'>-- first result has role equal to input; third result is Nominal</span>
<a name="line-545"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-546"></a><span class='hs-comment'>-- ^ Attempt to take a coercion application apart.</span>
<a name="line-547"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-548"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-549"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span>
<a name="line-550"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>args</span>
<a name="line-551"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span> <span class='hs-layout'>)</span>
<a name="line-552"></a>
<a name="line-553"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-554"></a>    <span class='hs-comment'>-- Never create unsaturated type family apps!</span>
<a name="line-555"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>args</span>
<a name="line-556"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>arg''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg'</span>
<a name="line-557"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg''</span> <span class='hs-layout'>)</span>
<a name="line-558"></a>       <span class='hs-comment'>-- Use mkTyConAppCo to preserve the invariant</span>
<a name="line-559"></a>       <span class='hs-comment'>--  that identity coercions are always represented by Refl</span>
<a name="line-560"></a>
<a name="line-561"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-562"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-563"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppTy_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-564"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-565"></a><span class='hs-definition'>splitAppCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-566"></a>
<a name="line-567"></a><a name="splitFunCo_maybe"></a><span class='hs-comment'>-- Only used in specialise/Rules</span>
<a name="line-568"></a><span class='hs-definition'>splitFunCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-569"></a><span class='hs-definition'>splitFunCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-570"></a><span class='hs-definition'>splitFunCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-571"></a>
<a name="line-572"></a><a name="splitForAllCo_maybe"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-573"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>k_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-574"></a><span class='hs-definition'>splitForAllCo_maybe</span> <span class='hs-keyword'>_</span>                     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-575"></a>
<a name="line-576"></a><a name="splitForAllCo_ty_maybe"></a><span class='hs-comment'>-- | Like 'splitForAllCo_maybe', but only returns Just for tyvar binder</span>
<a name="line-577"></a><span class='hs-definition'>splitForAllCo_ty_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-578"></a><span class='hs-definition'>splitForAllCo_ty_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-579"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>k_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-580"></a><span class='hs-definition'>splitForAllCo_ty_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-581"></a>
<a name="line-582"></a><a name="splitForAllCo_co_maybe"></a><span class='hs-comment'>-- | Like 'splitForAllCo_maybe', but only returns Just for covar binder</span>
<a name="line-583"></a><span class='hs-definition'>splitForAllCo_co_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-584"></a><span class='hs-definition'>splitForAllCo_co_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>cv</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-585"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cv</span><span class='hs-layout'>,</span> <span class='hs-varid'>k_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-586"></a><span class='hs-definition'>splitForAllCo_co_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-587"></a>
<a name="line-588"></a><span class='hs-comment'>-------------------------------------------------------</span>
<a name="line-589"></a><span class='hs-comment'>-- and some coercion kind stuff</span>
<a name="line-590"></a>
<a name="line-591"></a><a name="coVarLType"></a><span class='hs-definition'>coVarLType</span><span class='hs-layout'>,</span> <span class='hs-varid'>coVarRType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-592"></a><span class='hs-definition'>coVarLType</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-593"></a><a name="coVarRType"></a><span class='hs-definition'>coVarRType</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span>
<a name="line-594"></a>
<a name="line-595"></a><a name="coVarTypes"></a><span class='hs-definition'>coVarTypes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-596"></a><span class='hs-definition'>coVarTypes</span> <span class='hs-varid'>cv</span>
<a name="line-597"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>cv</span>
<a name="line-598"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-599"></a>
<a name="line-600"></a><a name="coVarKindsTypesRole"></a><span class='hs-definition'>coVarKindsTypesRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span><span class='hs-conid'>Kind</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span><span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-601"></a><span class='hs-definition'>coVarKindsTypesRole</span> <span class='hs-varid'>cv</span>
<a name="line-602"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span><span class='hs-varid'>k2</span><span class='hs-layout'>,</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span><span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>
<a name="line-603"></a> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>eqTyConRole</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-604"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-605"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarKindsTypesRole, non coercion variable"</span>
<a name="line-606"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-607"></a>
<a name="line-608"></a><a name="coVarKind"></a><span class='hs-definition'>coVarKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-609"></a><span class='hs-definition'>coVarKind</span> <span class='hs-varid'>cv</span>
<a name="line-610"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span> <span class='hs-layout'>)</span>
<a name="line-611"></a>    <span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span>
<a name="line-612"></a>
<a name="line-613"></a><a name="coVarRole"></a><span class='hs-definition'>coVarRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-614"></a><span class='hs-definition'>coVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-615"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqTyConRole</span> <span class='hs-layout'>(</span><span class='hs-keyword'>case</span> <span class='hs-varid'>tyConAppTyCon_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-616"></a>                   <span class='hs-conid'>Just</span> <span class='hs-varid'>tc0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc0</span>
<a name="line-617"></a>                   <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coVarRole: not tyconapp"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-618"></a>
<a name="line-619"></a><a name="eqTyConRole"></a><span class='hs-definition'>eqTyConRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-620"></a><span class='hs-comment'>-- Given (~#) or (~R#) return the Nominal or Representational respectively</span>
<a name="line-621"></a><span class='hs-definition'>eqTyConRole</span> <span class='hs-varid'>tc</span>
<a name="line-622"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqPrimTyConKey</span>
<a name="line-623"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-624"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>eqReprPrimTyConKey</span>
<a name="line-625"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-626"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-627"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"eqTyConRole: unknown tycon"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-628"></a>
<a name="line-629"></a><a name="mkRuntimeRepCo"></a><span class='hs-comment'>-- | Given a coercion @co1 :: (a :: TYPE r1) ~ (b :: TYPE r2)@,</span>
<a name="line-630"></a><span class='hs-comment'>-- produce a coercion @rep_co :: r1 ~ r2@.</span>
<a name="line-631"></a><span class='hs-definition'>mkRuntimeRepCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-632"></a><span class='hs-definition'>mkRuntimeRepCo</span> <span class='hs-varid'>co</span>
<a name="line-633"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-num'>0</span> <span class='hs-varid'>kind_co</span>
<a name="line-634"></a>  <span class='hs-keyword'>where</span>
<a name="line-635"></a>    <span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>  <span class='hs-comment'>-- kind_co :: TYPE r1 ~ TYPE r2</span>
<a name="line-636"></a>                           <span class='hs-comment'>-- (up to silliness with Constraint)</span>
<a name="line-637"></a>
<a name="line-638"></a><a name="isReflCoVar_maybe"></a><span class='hs-definition'>isReflCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-639"></a><span class='hs-comment'>-- If cv :: t~t then isReflCoVar_maybe cv = Just (Refl t)</span>
<a name="line-640"></a><span class='hs-comment'>-- Works on all kinds of Vars, not just CoVars</span>
<a name="line-641"></a><span class='hs-definition'>isReflCoVar_maybe</span> <span class='hs-varid'>cv</span>
<a name="line-642"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv</span>
<a name="line-643"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coVarTypes</span> <span class='hs-varid'>cv</span>
<a name="line-644"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span>
<a name="line-645"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-646"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-647"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-648"></a>
<a name="line-649"></a><a name="isGReflCo"></a><span class='hs-comment'>-- | Tests if this coercion is obviously a generalized reflexive coercion.</span>
<a name="line-650"></a><span class='hs-comment'>-- Guaranteed to work very quickly.</span>
<a name="line-651"></a><span class='hs-definition'>isGReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-652"></a><span class='hs-definition'>isGReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-653"></a><span class='hs-definition'>isGReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-comment'>-- Refl ty == GRefl N ty MRefl</span>
<a name="line-654"></a><span class='hs-definition'>isGReflCo</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-655"></a>
<a name="line-656"></a><a name="isReflCo"></a><span class='hs-comment'>-- | Tests if this coercion is obviously reflexive. Guaranteed to work</span>
<a name="line-657"></a><span class='hs-comment'>-- very quickly. Sometimes a coercion can be reflexive, but not obviously</span>
<a name="line-658"></a><span class='hs-comment'>-- so. c.f. 'isReflexiveCo'</span>
<a name="line-659"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-660"></a><span class='hs-definition'>isReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-661"></a><span class='hs-definition'>isReflCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflMCo</span> <span class='hs-varid'>mco</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-662"></a><span class='hs-definition'>isReflCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-663"></a>
<a name="line-664"></a><a name="isGReflCo_maybe"></a><span class='hs-comment'>-- | Returns the type coerced if this coercion is a generalized reflexive</span>
<a name="line-665"></a><span class='hs-comment'>-- coercion. Guaranteed to work very quickly.</span>
<a name="line-666"></a><span class='hs-definition'>isGReflCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-667"></a><span class='hs-definition'>isGReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-668"></a><span class='hs-definition'>isGReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-669"></a><span class='hs-definition'>isGReflCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-670"></a>
<a name="line-671"></a><a name="isReflCo_maybe"></a><span class='hs-comment'>-- | Returns the type coerced if this coercion is reflexive. Guaranteed</span>
<a name="line-672"></a><span class='hs-comment'>-- to work very quickly. Sometimes a coercion can be reflexive, but not</span>
<a name="line-673"></a><span class='hs-comment'>-- obviously so. c.f. 'isReflexiveCo_maybe'</span>
<a name="line-674"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-675"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-676"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflMCo</span> <span class='hs-varid'>mco</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-677"></a><span class='hs-definition'>isReflCo_maybe</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-678"></a>
<a name="line-679"></a><a name="isReflexiveCo"></a><span class='hs-comment'>-- | Slowly checks if the coercion is reflexive. Don't call this in a loop,</span>
<a name="line-680"></a><span class='hs-comment'>-- as it walks over the entire coercion.</span>
<a name="line-681"></a><span class='hs-definition'>isReflexiveCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-682"></a><span class='hs-definition'>isReflexiveCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isReflexiveCo_maybe</span>
<a name="line-683"></a>
<a name="line-684"></a><a name="isReflexiveCo_maybe"></a><span class='hs-comment'>-- | Extracts the coerced type from a reflexive coercion. This potentially</span>
<a name="line-685"></a><span class='hs-comment'>-- walks over the entire coercion, so avoid doing this in a loop.</span>
<a name="line-686"></a><span class='hs-definition'>isReflexiveCo_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-687"></a><span class='hs-definition'>isReflexiveCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span>
<a name="line-688"></a><span class='hs-definition'>isReflexiveCo_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflMCo</span> <span class='hs-varid'>mco</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-689"></a><span class='hs-definition'>isReflexiveCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-690"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span>
<a name="line-691"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-692"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-693"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-694"></a>  <span class='hs-keyword'>where</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKindRole</span> <span class='hs-varid'>co</span>
<a name="line-695"></a>
<a name="line-696"></a>
<a name="line-697"></a><span class='hs-comment'>{-
<a name="line-698"></a>%************************************************************************
<a name="line-699"></a>%*                                                                      *
<a name="line-700"></a>            Building coercions
<a name="line-701"></a>%*                                                                      *
<a name="line-702"></a>%************************************************************************
<a name="line-703"></a>
<a name="line-704"></a>These "smart constructors" maintain the invariants listed in the definition
<a name="line-705"></a>of Coercion, and they perform very basic optimizations.
<a name="line-706"></a>
<a name="line-707"></a>Note [Role twiddling functions]
<a name="line-708"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-709"></a>
<a name="line-710"></a>There are a plethora of functions for twiddling roles:
<a name="line-711"></a>
<a name="line-712"></a>mkSubCo: Requires a nominal input coercion and always produces a
<a name="line-713"></a>representational output. This is used when you (the programmer) are sure you
<a name="line-714"></a>know exactly that role you have and what you want.
<a name="line-715"></a>
<a name="line-716"></a>downgradeRole_maybe: This function takes both the input role and the output role
<a name="line-717"></a>as parameters. (The *output* role comes first!) It can only *downgrade* a
<a name="line-718"></a>role -- that is, change it from N to R or P, or from R to P. This one-way
<a name="line-719"></a>behavior is why there is the "_maybe". If an upgrade is requested, this
<a name="line-720"></a>function produces Nothing. This is used when you need to change the role of a
<a name="line-721"></a>coercion, but you're not sure (as you're writing the code) of which roles are
<a name="line-722"></a>involved.
<a name="line-723"></a>
<a name="line-724"></a>This function could have been written using coercionRole to ascertain the role
<a name="line-725"></a>of the input. But, that function is recursive, and the caller of downgradeRole_maybe
<a name="line-726"></a>often knows the input role. So, this is more efficient.
<a name="line-727"></a>
<a name="line-728"></a>downgradeRole: This is just like downgradeRole_maybe, but it panics if the
<a name="line-729"></a>conversion isn't a downgrade.
<a name="line-730"></a>
<a name="line-731"></a>setNominalRole_maybe: This is the only function that can *upgrade* a coercion.
<a name="line-732"></a>The result (if it exists) is always Nominal. The input can be at any role. It
<a name="line-733"></a>works on a "best effort" basis, as it should never be strictly necessary to
<a name="line-734"></a>upgrade a coercion during compilation. It is currently only used within GHC in
<a name="line-735"></a>splitAppCo_maybe. In order to be a proper inverse of mkAppCo, the second
<a name="line-736"></a>coercion that splitAppCo_maybe returns must be nominal. But, it's conceivable
<a name="line-737"></a>that splitAppCo_maybe is operating over a TyConAppCo that uses a
<a name="line-738"></a>representational coercion. Hence the need for setNominalRole_maybe.
<a name="line-739"></a>splitAppCo_maybe, in turn, is used only within coercion optimization -- thus,
<a name="line-740"></a>it is not absolutely critical that setNominalRole_maybe be complete.
<a name="line-741"></a>
<a name="line-742"></a>Note that setNominalRole_maybe will never upgrade a phantom UnivCo. Phantom
<a name="line-743"></a>UnivCos are perfectly type-safe, whereas representational and nominal ones are
<a name="line-744"></a>not. (Nominal ones are no worse than representational ones, so this function *will*
<a name="line-745"></a>change a UnivCo Representational to a UnivCo Nominal.)
<a name="line-746"></a>
<a name="line-747"></a>Conal Elliott also came across a need for this function while working with the
<a name="line-748"></a>GHC API, as he was decomposing Core casts. The Core casts use representational
<a name="line-749"></a>coercions, as they must, but his use case required nominal coercions (he was
<a name="line-750"></a>building a GADT). So, that's why this function is exported from this module.
<a name="line-751"></a>
<a name="line-752"></a>One might ask: shouldn't downgradeRole_maybe just use setNominalRole_maybe as
<a name="line-753"></a>appropriate? I (Richard E.) have decided not to do this, because upgrading a
<a name="line-754"></a>role is bizarre and a caller should have to ask for this behavior explicitly.
<a name="line-755"></a>
<a name="line-756"></a>-}</span>
<a name="line-757"></a>
<a name="line-758"></a><a name="mkReflCo"></a><span class='hs-comment'>-- | Make a reflexive coercion</span>
<a name="line-759"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-760"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span>
<a name="line-761"></a><span class='hs-definition'>mkReflCo</span> <span class='hs-varid'>r</span>       <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span>
<a name="line-762"></a>
<a name="line-763"></a><a name="mkRepReflCo"></a><span class='hs-comment'>-- | Make a representational reflexive coercion</span>
<a name="line-764"></a><span class='hs-definition'>mkRepReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-765"></a><span class='hs-definition'>mkRepReflCo</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span>
<a name="line-766"></a>
<a name="line-767"></a><a name="mkNomReflCo"></a><span class='hs-comment'>-- | Make a nominal reflexive coercion</span>
<a name="line-768"></a><span class='hs-definition'>mkNomReflCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-769"></a><span class='hs-definition'>mkNomReflCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span>
<a name="line-770"></a>
<a name="line-771"></a><a name="mkTyConAppCo"></a><span class='hs-comment'>-- | Apply a type constructor to a list of coercions. It is the</span>
<a name="line-772"></a><span class='hs-comment'>-- caller's responsibility to get the roles correct on argument coercions.</span>
<a name="line-773"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-774"></a><span class='hs-definition'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-775"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-sel'>_rep1</span><span class='hs-layout'>,</span> <span class='hs-sel'>_rep2</span><span class='hs-layout'>,</span> <span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>co2</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cos</span>   <span class='hs-comment'>-- See Note [Function coercions]</span>
<a name="line-776"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isFunTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-777"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- (a :: TYPE ra) -&gt; (b :: TYPE rb)  ~  (c :: TYPE rc) -&gt; (d :: TYPE rd)</span>
<a name="line-778"></a>    <span class='hs-comment'>-- rep1 :: ra  ~  rc        rep2 :: rb  ~  rd</span>
<a name="line-779"></a>    <span class='hs-comment'>-- co1  :: a   ~  c         co2  :: b   ~  d</span>
<a name="line-780"></a>    <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-781"></a>
<a name="line-782"></a>               <span class='hs-comment'>-- Expand type synonyms</span>
<a name="line-783"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_co_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftover_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>expandSynTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-784"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLiftingContext</span> <span class='hs-varid'>tv_co_prs</span><span class='hs-layout'>)</span> <span class='hs-varid'>rhs_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>leftover_cos</span>
<a name="line-785"></a>
<a name="line-786"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tys_roles</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>traverse</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>cos</span>
<a name="line-787"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>tys_roles</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-788"></a>  <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-789"></a>
<a name="line-790"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-791"></a>
<a name="line-792"></a><a name="mkFunCo"></a><span class='hs-comment'>-- | Build a function 'Coercion' from two other 'Coercion's. That is,</span>
<a name="line-793"></a><span class='hs-comment'>-- given @co1 :: a ~ b@ and @co2 :: x ~ y@ produce @co :: (a -&gt; x) ~ (b -&gt; y)@.</span>
<a name="line-794"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-795"></a><span class='hs-definition'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-796"></a>    <span class='hs-comment'>-- See Note [Refl invariant]</span>
<a name="line-797"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-798"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co2</span>
<a name="line-799"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>w</span>
<a name="line-800"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVisFunTy</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-801"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-802"></a>
<a name="line-803"></a><a name="mkAppCo"></a><span class='hs-comment'>-- | Apply a 'Coercion' to another 'Coercion'.</span>
<a name="line-804"></a><span class='hs-comment'>-- The second coercion must be Nominal, unless the first is Phantom.</span>
<a name="line-805"></a><span class='hs-comment'>-- If the first is Phantom, then the second can be either Phantom or Nominal.</span>
<a name="line-806"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ :: t1 ~r t2</span>
<a name="line-807"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ :: s1 ~N s2, where s1 :: k1, s2 :: k2</span>
<a name="line-808"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>     <span class='hs-comment'>-- ^ :: t1 s1 ~r t2 s2</span>
<a name="line-809"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span>
<a name="line-810"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-811"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>arg</span>
<a name="line-812"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-813"></a>
<a name="line-814"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-815"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-816"></a>    <span class='hs-comment'>-- Expand type synonyms; a TyConAppCo can't have a type synonym (#9102)</span>
<a name="line-817"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-818"></a>  <span class='hs-keyword'>where</span>
<a name="line-819"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-conid'>[]</span>            <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r1</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-820"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-conop'>:</span><span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-conop'>:</span><span class='hs-varid'>tys</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>ty1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>zip_roles</span> <span class='hs-varid'>rs</span> <span class='hs-varid'>tys</span>
<a name="line-821"></a>    <span class='hs-varid'>zip_roles</span> <span class='hs-keyword'>_</span>       <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"zip_roles"</span> <span class='hs-comment'>-- but the roles are infinite...</span>
<a name="line-822"></a>
<a name="line-823"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span>
<a name="line-824"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>of</span>
<a name="line-825"></a>      <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-826"></a>      <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-827"></a>        <span class='hs-keyword'>where</span> <span class='hs-varid'>new_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>!!</span> <span class='hs-layout'>(</span><span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-828"></a>              <span class='hs-varid'>arg'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>new_role</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>arg</span>
<a name="line-829"></a>      <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>toPhantomCo</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-830"></a><span class='hs-definition'>mkAppCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppCo</span> <span class='hs-varid'>co</span>  <span class='hs-varid'>arg</span>
<a name="line-831"></a><span class='hs-comment'>-- Note, mkAppCo is careful to maintain invariants regarding</span>
<a name="line-832"></a><span class='hs-comment'>-- where Refl constructors appear; see the comments in the definition</span>
<a name="line-833"></a><span class='hs-comment'>-- of Coercion and the Note [Refl invariant] in GHC.Core.TyCo.Rep.</span>
<a name="line-834"></a>
<a name="line-835"></a><a name="mkAppCos"></a><span class='hs-comment'>-- | Applies multiple 'Coercion's to another 'Coercion', from left to right.</span>
<a name="line-836"></a><span class='hs-comment'>-- See also 'mkAppCo'.</span>
<a name="line-837"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span>
<a name="line-838"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-839"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-840"></a><span class='hs-definition'>mkAppCos</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldl'</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>cos</span>
<a name="line-841"></a>
<a name="line-842"></a><span class='hs-comment'>{- Note [Unused coercion variable in ForAllCo]
<a name="line-843"></a>
<a name="line-844"></a>See Note [Unused coercion variable in ForAllTy] in GHC.Core.TyCo.Rep for the
<a name="line-845"></a>motivation for checking coercion variable in types.
<a name="line-846"></a>To lift the design choice to (ForAllCo cv kind_co body_co), we have two options:
<a name="line-847"></a>
<a name="line-848"></a>(1) In mkForAllCo, we check whether cv is a coercion variable
<a name="line-849"></a>    and whether it is not used in body_co. If so we construct a FunCo.
<a name="line-850"></a>(2) We don't do this check in mkForAllCo.
<a name="line-851"></a>    In coercionKind, we use mkTyCoForAllTy to perform the check and construct
<a name="line-852"></a>    a FunTy when necessary.
<a name="line-853"></a>
<a name="line-854"></a>We chose (2) for two reasons:
<a name="line-855"></a>
<a name="line-856"></a>* for a coercion, all that matters is its kind, So ForAllCo or FunCo does not
<a name="line-857"></a>  make a difference.
<a name="line-858"></a>* even if cv occurs in body_co, it is possible that cv does not occur in the kind
<a name="line-859"></a>  of body_co. Therefore the check in coercionKind is inevitable.
<a name="line-860"></a>
<a name="line-861"></a>The last wrinkle is that there are restrictions around the use of the cv in the
<a name="line-862"></a>coercion, as described in Section 5.8.5.2 of Richard's thesis. The idea is that
<a name="line-863"></a>we cannot prove that the type system is consistent with unrestricted use of this
<a name="line-864"></a>cv; the consistency proof uses an untyped rewrite relation that works over types
<a name="line-865"></a>with all coercions and casts removed. So, we can allow the cv to appear only in
<a name="line-866"></a>positions that are erased. As an approximation of this (and keeping close to the
<a name="line-867"></a>published theory), we currently allow the cv only within the type in a Refl node
<a name="line-868"></a>and under a GRefl node (including in the Coercion stored in a GRefl). It's
<a name="line-869"></a>possible other places are OK, too, but this is a safe approximation.
<a name="line-870"></a>
<a name="line-871"></a>Sadly, with heterogeneous equality, this restriction might be able to be violated;
<a name="line-872"></a>Richard's thesis is unable to prove that it isn't. Specifically, the liftCoSubst
<a name="line-873"></a>function might create an invalid coercion. Because a violation of the
<a name="line-874"></a>restriction might lead to a program that "goes wrong", it is checked all the time,
<a name="line-875"></a>even in a production compiler and without -dcore-list. We *have* proved that the
<a name="line-876"></a>problem does not occur with homogeneous equality, so this check can be dropped
<a name="line-877"></a>once ~# is made to be homogeneous.
<a name="line-878"></a>-}</span>
<a name="line-879"></a>
<a name="line-880"></a>
<a name="line-881"></a><a name="mkForAllCo"></a><span class='hs-comment'>-- | Make a Coercion from a tycovar, a kind coercion, and a body coercion.</span>
<a name="line-882"></a><span class='hs-comment'>-- The kind of the tycovar should be the left-hand kind of the kind coercion.</span>
<a name="line-883"></a><span class='hs-comment'>-- See Note [Unused coercion variable in ForAllCo]</span>
<a name="line-884"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-885"></a><span class='hs-definition'>mkForAllCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-886"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`eqType`</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-887"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-varop'>||</span> <span class='hs-varid'>almostDevoidCoVarOfCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-888"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-889"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>kind_co</span>
<a name="line-890"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyCoInvForAllTy</span> <span class='hs-varid'>v</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-891"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-892"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-893"></a>
<a name="line-894"></a><a name="mkForAllCo_NoRefl"></a><span class='hs-comment'>-- | Like 'mkForAllCo', but the inner coercion shouldn't be an obvious</span>
<a name="line-895"></a><span class='hs-comment'>-- reflexive coercion. For example, it is guaranteed in 'mkForAllCos'.</span>
<a name="line-896"></a><span class='hs-comment'>-- The kind of the tycovar should be the left-hand kind of the kind coercion.</span>
<a name="line-897"></a><span class='hs-definition'>mkForAllCo_NoRefl</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-898"></a><span class='hs-definition'>mkForAllCo_NoRefl</span> <span class='hs-varid'>v</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-899"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>v</span> <span class='hs-varop'>`eqType`</span> <span class='hs-layout'>(</span><span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-900"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-varop'>||</span> <span class='hs-varid'>almostDevoidCoVarOfCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-901"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>True</span>
<a name="line-902"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>v</span>
<a name="line-903"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-904"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>multToCo</span> <span class='hs-conid'>Many</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-905"></a>      <span class='hs-comment'>-- Functions from coercions are always unrestricted</span>
<a name="line-906"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-907"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>v</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-908"></a>
<a name="line-909"></a><a name="mkForAllCos"></a><span class='hs-comment'>-- | Make nested ForAllCos</span>
<a name="line-910"></a><span class='hs-definition'>mkForAllCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-911"></a><span class='hs-definition'>mkForAllCos</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>co</span>
<a name="line-912"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-913"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>refls_rev'd</span><span class='hs-layout'>,</span> <span class='hs-varid'>non_refls_rev'd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>in</span>
<a name="line-914"></a>    <span class='hs-varid'>foldl'</span> <span class='hs-layout'>(</span><span class='hs-varid'>flip</span> <span class='hs-varop'>$</span> <span class='hs-varid'>uncurry</span> <span class='hs-varid'>mkForAllCo_NoRefl</span><span class='hs-layout'>)</span>
<a name="line-915"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyCoInvForAllTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varid'>refls_rev'd</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-916"></a>           <span class='hs-varid'>non_refls_rev'd</span>
<a name="line-917"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-918"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-varid'>mkForAllCo_NoRefl</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-varid'>bndrs</span>
<a name="line-919"></a>
<a name="line-920"></a><a name="mkHomoForAllCos"></a><span class='hs-comment'>-- | Make a Coercion quantified over a type/coercion variable;</span>
<a name="line-921"></a><span class='hs-comment'>-- the variable has the same type in both sides of the coercion</span>
<a name="line-922"></a><span class='hs-definition'>mkHomoForAllCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-923"></a><span class='hs-definition'>mkHomoForAllCos</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>co</span>
<a name="line-924"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-925"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyCoInvForAllTys</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-926"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-927"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomoForAllCos_NoRefl</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>co</span>
<a name="line-928"></a>
<a name="line-929"></a><a name="mkHomoForAllCos_NoRefl"></a><span class='hs-comment'>-- | Like 'mkHomoForAllCos', but the inner coercion shouldn't be an obvious</span>
<a name="line-930"></a><span class='hs-comment'>-- reflexive coercion. For example, it is guaranteed in 'mkHomoForAllCos'.</span>
<a name="line-931"></a><span class='hs-definition'>mkHomoForAllCos_NoRefl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-932"></a><span class='hs-definition'>mkHomoForAllCos_NoRefl</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>orig_co</span>
<a name="line-933"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isReflCo</span> <span class='hs-varid'>orig_co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-934"></a>    <span class='hs-varid'>foldr</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_co</span> <span class='hs-varid'>vs</span>
<a name="line-935"></a>  <span class='hs-keyword'>where</span>
<a name="line-936"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkForAllCo_NoRefl</span> <span class='hs-varid'>v</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-937"></a>
<a name="line-938"></a><a name="mkCoVarCo"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-939"></a><span class='hs-comment'>-- cv :: s ~# t</span>
<a name="line-940"></a><span class='hs-comment'>-- See Note [mkCoVarCo]</span>
<a name="line-941"></a><span class='hs-definition'>mkCoVarCo</span> <span class='hs-varid'>cv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span>
<a name="line-942"></a>
<a name="line-943"></a><a name="mkCoVarCos"></a><span class='hs-definition'>mkCoVarCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-944"></a><span class='hs-definition'>mkCoVarCos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkCoVarCo</span>
<a name="line-945"></a>
<a name="line-946"></a><span class='hs-comment'>{- Note [mkCoVarCo]
<a name="line-947"></a>~~~~~~~~~~~~~~~~~~~
<a name="line-948"></a>In the past, mkCoVarCo optimised (c :: t~t) to (Refl t).  That is
<a name="line-949"></a>valid (although see Note [Unbound RULE binders] in GHC.Core.Rules), but
<a name="line-950"></a>it's a relatively expensive test and perhaps better done in
<a name="line-951"></a>optCoercion.  Not a big deal either way.
<a name="line-952"></a>-}</span>
<a name="line-953"></a>
<a name="line-954"></a><a name="isCoVar_maybe"></a><span class='hs-comment'>-- | Extract a covar, if possible. This check is dirty. Be ashamed</span>
<a name="line-955"></a><span class='hs-comment'>-- of yourself. (It's dirty because it cares about the structure of</span>
<a name="line-956"></a><span class='hs-comment'>-- a coercion, which is morally reprehensible.)</span>
<a name="line-957"></a><span class='hs-definition'>isCoVar_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoVar</span>
<a name="line-958"></a><span class='hs-definition'>isCoVar_maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>cv</span>
<a name="line-959"></a><span class='hs-definition'>isCoVar_maybe</span> <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-960"></a>
<a name="line-961"></a><a name="mkAxInstCo"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-962"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-963"></a><span class='hs-comment'>-- mkAxInstCo can legitimately be called over-staturated;</span>
<a name="line-964"></a><span class='hs-comment'>-- i.e. with more type arguments than the coercion requires</span>
<a name="line-965"></a><span class='hs-definition'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-966"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n_tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-967"></a>                     <span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>rtys</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-968"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>arity</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>n_tys</span> <span class='hs-layout'>)</span>
<a name="line-969"></a>                     <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax_role</span> <span class='hs-varop'>$</span>
<a name="line-970"></a>                     <span class='hs-varid'>mkAppCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAxiomInstCo</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span>
<a name="line-971"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>ax_args</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-972"></a>                              <span class='hs-varid'>leftover_args</span>
<a name="line-973"></a>  <span class='hs-keyword'>where</span>
<a name="line-974"></a>    <span class='hs-varid'>n_tys</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-975"></a>    <span class='hs-varid'>ax_br</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toBranchedAxiom</span> <span class='hs-varid'>ax</span>
<a name="line-976"></a>    <span class='hs-varid'>branch</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax_br</span> <span class='hs-varid'>index</span>
<a name="line-977"></a>    <span class='hs-varid'>tvs</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-978"></a>    <span class='hs-varid'>arity</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tvs</span>
<a name="line-979"></a>    <span class='hs-varid'>arg_roles</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchRoles</span> <span class='hs-varid'>branch</span>
<a name="line-980"></a>    <span class='hs-varid'>rtys</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_roles</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-981"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ax_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>leftover_args</span><span class='hs-layout'>)</span>
<a name="line-982"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>rtys</span>
<a name="line-983"></a>    <span class='hs-varid'>ax_role</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-984"></a>
<a name="line-985"></a><a name="mkAxiomInstCo"></a><span class='hs-comment'>-- worker function</span>
<a name="line-986"></a><span class='hs-definition'>mkAxiomInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Branched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-987"></a><span class='hs-definition'>mkAxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>args</span>
<a name="line-988"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-varid'>coAxiomArity</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-layout'>)</span>
<a name="line-989"></a>    <span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>args</span>
<a name="line-990"></a>
<a name="line-991"></a><a name="mkUnbranchedAxInstCo"></a><span class='hs-comment'>-- to be used only with unbranched axioms</span>
<a name="line-992"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span>
<a name="line-993"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-994"></a><span class='hs-definition'>mkUnbranchedAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-995"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-996"></a>
<a name="line-997"></a><a name="mkAxInstRHS"></a><span class='hs-definition'>mkAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-998"></a><span class='hs-comment'>-- Instantiate the axiom with specified types,</span>
<a name="line-999"></a><span class='hs-comment'>-- returning the instantiated RHS</span>
<a name="line-1000"></a><span class='hs-comment'>-- A companion to mkAxInstCo:</span>
<a name="line-1001"></a><span class='hs-comment'>--    mkAxInstRhs ax index tys = snd (coercionKind (mkAxInstCo ax index tys))</span>
<a name="line-1002"></a><span class='hs-definition'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-1003"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-1004"></a>    <span class='hs-varid'>mkAppTys</span> <span class='hs-varid'>rhs'</span> <span class='hs-varid'>tys2</span>
<a name="line-1005"></a>  <span class='hs-keyword'>where</span>
<a name="line-1006"></a>    <span class='hs-varid'>branch</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-1007"></a>    <span class='hs-varid'>tvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-1008"></a>    <span class='hs-varid'>cvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchCoVars</span> <span class='hs-varid'>branch</span>
<a name="line-1009"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1010"></a>    <span class='hs-varid'>rhs'</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>$</span>
<a name="line-1011"></a>                   <span class='hs-varid'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$</span>
<a name="line-1012"></a>                   <span class='hs-varid'>coAxBranchRHS</span> <span class='hs-varid'>branch</span>
<a name="line-1013"></a>
<a name="line-1014"></a><a name="mkUnbranchedAxInstRHS"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1015"></a><span class='hs-definition'>mkUnbranchedAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstRHS</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span>
<a name="line-1016"></a>
<a name="line-1017"></a><a name="mkAxInstLHS"></a><span class='hs-comment'>-- | Return the left-hand type of the axiom, when the axiom is instantiated</span>
<a name="line-1018"></a><span class='hs-comment'>-- at the types given.</span>
<a name="line-1019"></a><span class='hs-definition'>mkAxInstLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-varid'>br</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>BranchIndex</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1020"></a><span class='hs-definition'>mkAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>cos</span>
<a name="line-1021"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>tys1</span> <span class='hs-layout'>)</span>
<a name="line-1022"></a>    <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>lhs_tys</span> <span class='hs-varop'>`chkAppend`</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span>
<a name="line-1023"></a>  <span class='hs-keyword'>where</span>
<a name="line-1024"></a>    <span class='hs-varid'>branch</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>index</span>
<a name="line-1025"></a>    <span class='hs-varid'>tvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchTyVars</span> <span class='hs-varid'>branch</span>
<a name="line-1026"></a>    <span class='hs-varid'>cvs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxBranchCoVars</span> <span class='hs-varid'>branch</span>
<a name="line-1027"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-1028"></a>    <span class='hs-varid'>lhs_tys</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTysWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span> <span class='hs-varop'>$</span>
<a name="line-1029"></a>                   <span class='hs-varid'>substTysWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos</span> <span class='hs-varop'>$</span>
<a name="line-1030"></a>                   <span class='hs-varid'>coAxBranchLHS</span> <span class='hs-varid'>branch</span>
<a name="line-1031"></a>    <span class='hs-varid'>fam_tc</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span>
<a name="line-1032"></a>
<a name="line-1033"></a><a name="mkUnbranchedAxInstLHS"></a><span class='hs-comment'>-- | Instantiate the left-hand side of an unbranched axiom</span>
<a name="line-1034"></a><span class='hs-definition'>mkUnbranchedAxInstLHS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiom</span> <span class='hs-conid'>Unbranched</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1035"></a><span class='hs-definition'>mkUnbranchedAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAxInstLHS</span> <span class='hs-varid'>ax</span> <span class='hs-num'>0</span>
<a name="line-1036"></a>
<a name="line-1037"></a><a name="mkHoleCo"></a><span class='hs-comment'>-- | Make a coercion from a coercion hole</span>
<a name="line-1038"></a><span class='hs-definition'>mkHoleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionHole</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1039"></a><span class='hs-definition'>mkHoleCo</span> <span class='hs-varid'>h</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span>
<a name="line-1040"></a>
<a name="line-1041"></a><a name="mkUnivCo"></a><span class='hs-comment'>-- | Make a universal coercion between two arbitrary types.</span>
<a name="line-1042"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span>
<a name="line-1043"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>       <span class='hs-comment'>-- ^ role of the built coercion, "r"</span>
<a name="line-1044"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- ^ t1 :: k1</span>
<a name="line-1045"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>       <span class='hs-comment'>-- ^ t2 :: k2</span>
<a name="line-1046"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ :: t1 ~r t2</span>
<a name="line-1047"></a><span class='hs-definition'>mkUnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1048"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span>
<a name="line-1049"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1050"></a>
<a name="line-1051"></a><a name="mkSymCo"></a><span class='hs-comment'>-- | Create a symmetric version of the given 'Coercion' that asserts</span>
<a name="line-1052"></a><span class='hs-comment'>--   equality between the same types but in the other "direction", so</span>
<a name="line-1053"></a><span class='hs-comment'>--   a kind of @t1 ~ t2@ becomes the kind @t2 ~ t1@.</span>
<a name="line-1054"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1055"></a>
<a name="line-1056"></a><span class='hs-comment'>-- Do a few simple optimizations, but don't bother pushing occurrences</span>
<a name="line-1057"></a><span class='hs-comment'>-- of symmetry to the leaves; the optimizer will take care of that.</span>
<a name="line-1058"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1059"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1060"></a><span class='hs-definition'>mkSymCo</span>    <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span>
<a name="line-1061"></a><span class='hs-definition'>mkSymCo</span> <span class='hs-varid'>co</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span>
<a name="line-1062"></a>
<a name="line-1063"></a><a name="mkTransCo"></a><span class='hs-comment'>-- | Create a new 'Coercion' by composing the two given 'Coercion's transitively.</span>
<a name="line-1064"></a><span class='hs-comment'>--   (co1 ; co2)</span>
<a name="line-1065"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1066"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span>
<a name="line-1067"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co1</span>
<a name="line-1068"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1069"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1070"></a><span class='hs-definition'>mkTransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1071"></a>
<a name="line-1072"></a><a name="mkNthCo"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-1073"></a>        <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- The role of the coercion you're creating</span>
<a name="line-1074"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>   <span class='hs-comment'>-- Zero-indexed</span>
<a name="line-1075"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1076"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1077"></a><span class='hs-definition'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1078"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>good_call</span><span class='hs-layout'>,</span> <span class='hs-varid'>bad_call_msg</span> <span class='hs-layout'>)</span>
<a name="line-1079"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1080"></a>  <span class='hs-keyword'>where</span>
<a name="line-1081"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1082"></a>
<a name="line-1083"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-varid'>co</span>
<a name="line-1084"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1085"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1086"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- works for both tyvar and covar</span>
<a name="line-1087"></a>        <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-1088"></a>        <span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1089"></a>
<a name="line-1090"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1091"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>r0</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1092"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConAppTyCon</span> <span class='hs-varid'>ty</span>
<a name="line-1093"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>)</span>
<a name="line-1094"></a>        <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r0</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>r</span> <span class='hs-layout'>)</span>
<a name="line-1095"></a>        <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConAppArgN</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1096"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>ok_tc_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1097"></a>            <span class='hs-varid'>ok_tc_app</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span>
<a name="line-1098"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1099"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n</span>
<a name="line-1100"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForAllTy</span> <span class='hs-varid'>ty</span>  <span class='hs-comment'>-- nth:0 pulls out a kind coercion from a hetero forall</span>
<a name="line-1101"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1102"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1103"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1104"></a>
<a name="line-1105"></a>    <span class='hs-varid'>go</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>kind_co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1106"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-1107"></a>        <span class='hs-varid'>kind_co</span>
<a name="line-1108"></a>      <span class='hs-comment'>-- If co :: (forall a1:k1. t1) ~ (forall a2:k2. t2)</span>
<a name="line-1109"></a>      <span class='hs-comment'>-- then (nth 0 co :: k1 ~N k2)</span>
<a name="line-1110"></a>      <span class='hs-comment'>-- If co :: (forall a1:t1 ~ t2. t1) ~ (forall a2:t3 ~ t4. t2)</span>
<a name="line-1111"></a>      <span class='hs-comment'>-- then (nth 0 co :: (t1 ~ t2) ~N (t3 ~ t4))</span>
<a name="line-1112"></a>
<a name="line-1113"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1114"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCoFunCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span>
<a name="line-1115"></a>
<a name="line-1116"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r0</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>arg_cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r0</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-1117"></a>                                                    <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span>
<a name="line-1118"></a>                                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_cos</span>
<a name="line-1119"></a>                                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r0</span>
<a name="line-1120"></a>                                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span>
<a name="line-1121"></a>                                                            <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1122"></a>                                             <span class='hs-varid'>arg_cos</span> <span class='hs-varop'>`getNth`</span> <span class='hs-varid'>n</span>
<a name="line-1123"></a>
<a name="line-1124"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Recurse, hoping to get to a TyConAppCo or FunCo</span>
<a name="line-1125"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1126"></a>
<a name="line-1127"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1128"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1129"></a>
<a name="line-1130"></a>    <span class='hs-comment'>-- Assertion checking</span>
<a name="line-1131"></a>    <span class='hs-varid'>bad_call_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Coercion ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-1132"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"LHS ty ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span>
<a name="line-1133"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"RHS ty ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span>
<a name="line-1134"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"n ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"r ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>r</span>
<a name="line-1135"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"coercion role ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-1136"></a>    <span class='hs-varid'>good_call</span>
<a name="line-1137"></a>      <span class='hs-comment'>-- If the Coercion passed in is between forall-types, then the Int must</span>
<a name="line-1138"></a>      <span class='hs-comment'>-- be 0 and the role must be Nominal.</span>
<a name="line-1139"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-sel'>_tv1</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-1140"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-sel'>_tv2</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-1141"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span>
<a name="line-1142"></a>
<a name="line-1143"></a>      <span class='hs-comment'>-- If the Coercion passed in is between T tys and T tys', then the Int</span>
<a name="line-1144"></a>      <span class='hs-comment'>-- must be less than the length of tys/tys' (which must be the same</span>
<a name="line-1145"></a>      <span class='hs-comment'>-- lengths).</span>
<a name="line-1146"></a>      <span class='hs-comment'>--</span>
<a name="line-1147"></a>      <span class='hs-comment'>-- If the role of the Coercion is nominal, then the role passed in must</span>
<a name="line-1148"></a>      <span class='hs-comment'>-- be nominal. If the role of the Coercion is representational, then the</span>
<a name="line-1149"></a>      <span class='hs-comment'>-- role passed in must be tyConRolesRepresentational T !! n. If the role</span>
<a name="line-1150"></a>      <span class='hs-comment'>-- of the Coercion is Phantom, then the role passed in must be Phantom.</span>
<a name="line-1151"></a>      <span class='hs-comment'>--</span>
<a name="line-1152"></a>      <span class='hs-comment'>-- See also Note [NthCo Cached Roles] if you're wondering why it's</span>
<a name="line-1153"></a>      <span class='hs-comment'>-- blaringly obvious that we should be *computing* this role instead of</span>
<a name="line-1154"></a>      <span class='hs-comment'>-- passing it in.</span>
<a name="line-1155"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-1156"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc2</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-1157"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span>
<a name="line-1158"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>len1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys1</span>
<a name="line-1159"></a>            <span class='hs-varid'>len2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys2</span>
<a name="line-1160"></a>            <span class='hs-varid'>good_role</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1161"></a>                          <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span>
<a name="line-1162"></a>                          <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1163"></a>                          <span class='hs-conid'>Phantom</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Phantom</span>
<a name="line-1164"></a>        <span class='hs-keyword'>in</span> <span class='hs-varid'>len1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>len2</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>len1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>good_role</span>
<a name="line-1165"></a>
<a name="line-1166"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1167"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1168"></a>
<a name="line-1169"></a><a name="mkNthCoFunCo"></a><span class='hs-comment'>-- | Extract the nth field of a FunCo</span>
<a name="line-1170"></a><span class='hs-definition'>mkNthCoFunCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>         <span class='hs-comment'>-- ^ "n"</span>
<a name="line-1171"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span>   <span class='hs-comment'>-- ^ multiplicity coercion</span>
<a name="line-1172"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>    <span class='hs-comment'>-- ^ argument coercion</span>
<a name="line-1173"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>    <span class='hs-comment'>-- ^ result coercion</span>
<a name="line-1174"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>    <span class='hs-comment'>-- ^ nth coercion from a FunCo</span>
<a name="line-1175"></a><span class='hs-comment'>-- See Note [Function coercions]</span>
<a name="line-1176"></a><span class='hs-comment'>-- If FunCo _ mult arg_co res_co ::   (s1:TYPE sk1 :mult-&gt; s2:TYPE sk2)</span>
<a name="line-1177"></a><span class='hs-comment'>--                                  ~ (t1:TYPE tk1 :mult-&gt; t2:TYPE tk2)</span>
<a name="line-1178"></a><span class='hs-comment'>-- Then we want to behave as if co was</span>
<a name="line-1179"></a><span class='hs-comment'>--    TyConAppCo mult argk_co resk_co arg_co res_co</span>
<a name="line-1180"></a><span class='hs-comment'>-- where</span>
<a name="line-1181"></a><span class='hs-comment'>--    argk_co :: sk1 ~ tk1  =  mkNthCo 0 (mkKindCo arg_co)</span>
<a name="line-1182"></a><span class='hs-comment'>--    resk_co :: sk2 ~ tk2  =  mkNthCo 0 (mkKindCo res_co)</span>
<a name="line-1183"></a><span class='hs-comment'>--                             i.e. mkRuntimeRepCo</span>
<a name="line-1184"></a><span class='hs-definition'>mkNthCoFunCo</span> <span class='hs-varid'>n</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>n</span> <span class='hs-keyword'>of</span>
<a name="line-1185"></a>  <span class='hs-num'>0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>w</span>
<a name="line-1186"></a>  <span class='hs-num'>1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>co1</span>
<a name="line-1187"></a>  <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkRuntimeRepCo</span> <span class='hs-varid'>co2</span>
<a name="line-1188"></a>  <span class='hs-num'>3</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co1</span>
<a name="line-1189"></a>  <span class='hs-num'>4</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co2</span>
<a name="line-1190"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkNthCo(FunCo)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>n</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>w</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>
<a name="line-1192"></a><a name="nthCoRole"></a><span class='hs-comment'>-- | If you're about to call @mkNthCo r n co@, then @r@ should be</span>
<a name="line-1193"></a><span class='hs-comment'>-- whatever @nthCoRole n co@ returns.</span>
<a name="line-1194"></a><span class='hs-definition'>nthCoRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-1195"></a><span class='hs-definition'>nthCoRole</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span>
<a name="line-1196"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>lty</span>
<a name="line-1197"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nthRole</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-1198"></a>
<a name="line-1199"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>lty</span>
<a name="line-1200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-1201"></a>
<a name="line-1202"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1203"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"nthCoRole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1204"></a>
<a name="line-1205"></a>  <span class='hs-keyword'>where</span>
<a name="line-1206"></a>    <span class='hs-varid'>lty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionLKind</span> <span class='hs-varid'>co</span>
<a name="line-1207"></a>    <span class='hs-varid'>r</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span>
<a name="line-1208"></a>
<a name="line-1209"></a><a name="mkLRCo"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LeftOrRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1210"></a><span class='hs-definition'>mkLRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>
<a name="line-1211"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>eq</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1212"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>eq</span> <span class='hs-layout'>(</span><span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitAppTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1213"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1214"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span>
<a name="line-1215"></a>
<a name="line-1216"></a><a name="mkInstCo"></a><span class='hs-comment'>-- | Instantiates a 'Coercion'.</span>
<a name="line-1217"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1218"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tcv</span> <span class='hs-sel'>_kind_co</span> <span class='hs-varid'>body_co</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1219"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1220"></a>      <span class='hs-comment'>-- works for both tyvar and covar</span>
<a name="line-1221"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCoUnchecked</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipTCvSubst</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tcv</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>body_co</span>
<a name="line-1222"></a><span class='hs-definition'>mkInstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span>
<a name="line-1223"></a>
<a name="line-1224"></a><a name="mkGReflRightCo"></a><span class='hs-comment'>-- | Given @ty :: k1@, @co :: k1 ~ k2@,</span>
<a name="line-1225"></a><span class='hs-comment'>-- produces @co' :: ty ~r (ty |&gt; co)@</span>
<a name="line-1226"></a><span class='hs-definition'>mkGReflRightCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1227"></a><span class='hs-definition'>mkGReflRightCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1228"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1229"></a>    <span class='hs-comment'>-- the kinds of @k1@ and @k2@ are the same, thus @isGReflCo@</span>
<a name="line-1230"></a>    <span class='hs-comment'>-- instead of @isReflCo@</span>
<a name="line-1231"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1232"></a>
<a name="line-1233"></a><a name="mkGReflLeftCo"></a><span class='hs-comment'>-- | Given @ty :: k1@, @co :: k1 ~ k2@,</span>
<a name="line-1234"></a><span class='hs-comment'>-- produces @co' :: (ty |&gt; co) ~r ty@</span>
<a name="line-1235"></a><span class='hs-definition'>mkGReflLeftCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1236"></a><span class='hs-definition'>mkGReflLeftCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1237"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1238"></a>    <span class='hs-comment'>-- the kinds of @k1@ and @k2@ are the same, thus @isGReflCo@</span>
<a name="line-1239"></a>    <span class='hs-comment'>-- instead of @isReflCo@</span>
<a name="line-1240"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1241"></a>
<a name="line-1242"></a><a name="mkCoherenceLeftCo"></a><span class='hs-comment'>-- | Given @ty :: k1@, @co :: k1 ~ k2@, @co2:: ty ~r ty'@,</span>
<a name="line-1243"></a><span class='hs-comment'>-- produces @co' :: (ty |&gt; co) ~r ty'</span>
<a name="line-1244"></a><span class='hs-comment'>-- It is not only a utility function, but it saves allocation when co</span>
<a name="line-1245"></a><span class='hs-comment'>-- is a GRefl coercion.</span>
<a name="line-1246"></a><span class='hs-definition'>mkCoherenceLeftCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1247"></a><span class='hs-definition'>mkCoherenceLeftCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-varid'>co2</span>
<a name="line-1248"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span>
<a name="line-1249"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co2</span>
<a name="line-1250"></a>
<a name="line-1251"></a><a name="mkCoherenceRightCo"></a><span class='hs-comment'>-- | Given @ty :: k1@, @co :: k1 ~ k2@, @co2:: ty' ~r ty@,</span>
<a name="line-1252"></a><span class='hs-comment'>-- produces @co' :: ty' ~r (ty |&gt; co)</span>
<a name="line-1253"></a><span class='hs-comment'>-- It is not only a utility function, but it saves allocation when co</span>
<a name="line-1254"></a><span class='hs-comment'>-- is a GRefl coercion.</span>
<a name="line-1255"></a><span class='hs-definition'>mkCoherenceRightCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1256"></a><span class='hs-definition'>mkCoherenceRightCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span> <span class='hs-varid'>co2</span>
<a name="line-1257"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span>
<a name="line-1258"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co2</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1259"></a>
<a name="line-1260"></a><a name="mkKindCo"></a><span class='hs-comment'>-- | Given @co :: (a :: k) ~ (b :: k')@ produce @co' :: k ~ k'@.</span>
<a name="line-1261"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1262"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1263"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co</span>
<a name="line-1264"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span>
<a name="line-1265"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>h</span>
<a name="line-1266"></a><span class='hs-definition'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1267"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1268"></a>       <span class='hs-comment'>-- generally, calling coercionKind during coercion creation is a bad idea,</span>
<a name="line-1269"></a>       <span class='hs-comment'>-- as it can lead to exponential behavior. But, we don't have nested mkKindCos,</span>
<a name="line-1270"></a>       <span class='hs-comment'>-- so it's OK here.</span>
<a name="line-1271"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tk1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-1272"></a>        <span class='hs-varid'>tk2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-1273"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tk1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>tk2</span>
<a name="line-1274"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Refl</span> <span class='hs-varid'>tk1</span>
<a name="line-1275"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1276"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span>
<a name="line-1277"></a>
<a name="line-1278"></a><a name="mkSubCo"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1279"></a><span class='hs-comment'>-- Input coercion is Nominal, result is Representational</span>
<a name="line-1280"></a><span class='hs-comment'>-- see also Note [Role twiddling functions]</span>
<a name="line-1281"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span>
<a name="line-1282"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GRefl</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1283"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1284"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1285"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>w</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1286"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>w</span>
<a name="line-1287"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>downgradeRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1288"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>downgradeRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span>
<a name="line-1289"></a><span class='hs-definition'>mkSubCo</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1290"></a>             <span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span>
<a name="line-1291"></a>
<a name="line-1292"></a><a name="downgradeRole_maybe"></a><span class='hs-comment'>-- | Changes a role, but only a downgrade. See Note [Role twiddling functions]</span>
<a name="line-1293"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- ^ desired role</span>
<a name="line-1294"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>   <span class='hs-comment'>-- ^ current role</span>
<a name="line-1295"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1296"></a><span class='hs-comment'>-- In (downgradeRole_maybe dr cr co) it's a precondition that</span>
<a name="line-1297"></a><span class='hs-comment'>--                                   cr = coercionRole co</span>
<a name="line-1298"></a>
<a name="line-1299"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Nominal</span>          <span class='hs-conid'>Nominal</span>          <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1300"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyword'>_</span>                <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1301"></a>
<a name="line-1302"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Nominal</span>          <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1303"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1304"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1305"></a>
<a name="line-1306"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Phantom</span>          <span class='hs-conid'>Phantom</span>          <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1307"></a><span class='hs-definition'>downgradeRole_maybe</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyword'>_</span>                <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>toPhantomCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1308"></a>
<a name="line-1309"></a><a name="downgradeRole"></a><span class='hs-comment'>-- | Like 'downgradeRole_maybe', but panics if the change isn't a downgrade.</span>
<a name="line-1310"></a><span class='hs-comment'>-- See Note [Role twiddling functions]</span>
<a name="line-1311"></a><span class='hs-definition'>downgradeRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- desired role</span>
<a name="line-1312"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>  <span class='hs-comment'>-- current role</span>
<a name="line-1313"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1314"></a><span class='hs-definition'>downgradeRole</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span>
<a name="line-1315"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>downgradeRole_maybe</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1316"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-1317"></a>      <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"downgradeRole"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1318"></a>
<a name="line-1319"></a><a name="mkAxiomRuleCo"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoAxiomRule</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1320"></a><span class='hs-definition'>mkAxiomRuleCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AxiomRuleCo</span>
<a name="line-1321"></a>
<a name="line-1322"></a><a name="mkProofIrrelCo"></a><span class='hs-comment'>-- | Make a "coercion between coercions".</span>
<a name="line-1323"></a><span class='hs-definition'>mkProofIrrelCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>       <span class='hs-comment'>-- ^ role of the created coercion, "r"</span>
<a name="line-1324"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ :: phi1 ~N phi2</span>
<a name="line-1325"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ g1 :: phi1</span>
<a name="line-1326"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ g2 :: phi2</span>
<a name="line-1327"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>   <span class='hs-comment'>-- ^ :: g1 ~r g2</span>
<a name="line-1328"></a>
<a name="line-1329"></a><span class='hs-comment'>-- if the two coercion prove the same fact, I just don't care what</span>
<a name="line-1330"></a><span class='hs-comment'>-- the individual coercions are.</span>
<a name="line-1331"></a><span class='hs-definition'>mkProofIrrelCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co</span> <span class='hs-varid'>g</span>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionTy</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1332"></a>  <span class='hs-comment'>-- kco is a kind coercion, thus @isGReflCo@ rather than @isReflCo@</span>
<a name="line-1333"></a><span class='hs-definition'>mkProofIrrelCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>kco</span>        <span class='hs-varid'>g1</span> <span class='hs-varid'>g2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span>
<a name="line-1334"></a>                                             <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionTy</span> <span class='hs-varid'>g1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoercionTy</span> <span class='hs-varid'>g2</span><span class='hs-layout'>)</span>
<a name="line-1335"></a>
<a name="line-1336"></a><span class='hs-comment'>{-
<a name="line-1337"></a>%************************************************************************
<a name="line-1338"></a>%*                                                                      *
<a name="line-1339"></a>   Roles
<a name="line-1340"></a>%*                                                                      *
<a name="line-1341"></a>%************************************************************************
<a name="line-1342"></a>-}</span>
<a name="line-1343"></a>
<a name="line-1344"></a><a name="setNominalRole_maybe"></a><span class='hs-comment'>-- | Converts a coercion to be nominal, if possible.</span>
<a name="line-1345"></a><span class='hs-comment'>-- See Note [Role twiddling functions]</span>
<a name="line-1346"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-comment'>-- of input coercion</span>
<a name="line-1347"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-1348"></a><span class='hs-definition'>setNominalRole_maybe</span> <span class='hs-varid'>r</span> <span class='hs-varid'>co</span>
<a name="line-1349"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1350"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co</span>
<a name="line-1351"></a>  <span class='hs-keyword'>where</span>
<a name="line-1352"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1353"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co</span>
<a name="line-1354"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GRefl</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span>
<a name="line-1355"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-1356"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cos'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-1357"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>TyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos'</span> <span class='hs-layout'>}</span>
<a name="line-1358"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1359"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co1</span>
<a name="line-1360"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>co2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co2</span>
<a name="line-1361"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>FunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1'</span> <span class='hs-varid'>co2'</span>
<a name="line-1362"></a>           <span class='hs-layout'>}</span>
<a name="line-1363"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1364"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SymCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co</span>
<a name="line-1365"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1366"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TransCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co2</span>
<a name="line-1367"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1368"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AppCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>co2</span>
<a name="line-1369"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1370"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>kind_co</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co</span>
<a name="line-1371"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-sel'>_r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1372"></a>      <span class='hs-comment'>-- NB, this case recurses via setNominalRole_maybe, not</span>
<a name="line-1373"></a>      <span class='hs-comment'>-- setNominalRole_maybe_helper!</span>
<a name="line-1374"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NthCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-1375"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1376"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InstCo</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-varid'>co</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-varid'>arg</span>
<a name="line-1377"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1378"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>prov</span> <span class='hs-keyword'>of</span> <span class='hs-conid'>PhantomProv</span> <span class='hs-keyword'>_</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- should always be phantom</span>
<a name="line-1379"></a>                     <span class='hs-conid'>ProofIrrelProv</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>   <span class='hs-comment'>-- it's always safe</span>
<a name="line-1380"></a>                     <span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>  <span class='hs-comment'>-- who knows? This choice is conservative.</span>
<a name="line-1381"></a>                     <span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1382"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UnivCo</span> <span class='hs-varid'>prov</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1383"></a>    <span class='hs-varid'>setNominalRole_maybe_helper</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1384"></a>
<a name="line-1385"></a><a name="mkPhantomCo"></a><span class='hs-comment'>-- | Make a phantom coercion between two types. The coercion passed</span>
<a name="line-1386"></a><span class='hs-comment'>-- in must be a nominal coercion between the kinds of the</span>
<a name="line-1387"></a><span class='hs-comment'>-- types.</span>
<a name="line-1388"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1389"></a><span class='hs-definition'>mkPhantomCo</span> <span class='hs-varid'>h</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1390"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span>
<a name="line-1391"></a>
<a name="line-1392"></a><a name="toPhantomCo"></a><span class='hs-comment'>-- takes any coercion and turns it into a Phantom coercion</span>
<a name="line-1393"></a><span class='hs-definition'>toPhantomCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1394"></a><span class='hs-definition'>toPhantomCo</span> <span class='hs-varid'>co</span>
<a name="line-1395"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPhantomCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-1396"></a>  <span class='hs-keyword'>where</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1397"></a>
<a name="line-1398"></a><a name="applyRoles"></a><span class='hs-comment'>-- Convert args to a TyConAppCo Nominal to the same TyConAppCo Representational</span>
<a name="line-1399"></a><span class='hs-definition'>applyRoles</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>
<a name="line-1400"></a><span class='hs-definition'>applyRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1401"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipWith</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r</span> <span class='hs-conid'>Nominal</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>cos</span>
<a name="line-1402"></a>
<a name="line-1403"></a><a name="tyConRolesX"></a><span class='hs-comment'>-- the Role parameter is the Role of the TyConAppCo</span>
<a name="line-1404"></a><span class='hs-comment'>-- defined here because this is intimately concerned with the implementation</span>
<a name="line-1405"></a><span class='hs-comment'>-- of TyConAppCo</span>
<a name="line-1406"></a><span class='hs-comment'>-- Always returns an infinite list (with a infinite tail of Nominal)</span>
<a name="line-1407"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-1408"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span>
<a name="line-1409"></a><span class='hs-definition'>tyConRolesX</span> <span class='hs-varid'>role</span>             <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>repeat</span> <span class='hs-varid'>role</span>
<a name="line-1410"></a>
<a name="line-1411"></a><a name="tyConRolesRepresentational"></a><span class='hs-comment'>-- Returns the roles of the parameters of a tycon, with an infinite tail</span>
<a name="line-1412"></a><span class='hs-comment'>-- of Nominal</span>
<a name="line-1413"></a><span class='hs-definition'>tyConRolesRepresentational</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>
<a name="line-1414"></a><span class='hs-definition'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConRoles</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>++</span> <span class='hs-varid'>repeat</span> <span class='hs-conid'>Nominal</span>
<a name="line-1415"></a>
<a name="line-1416"></a><a name="nthRole"></a><span class='hs-definition'>nthRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-1417"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Nominal</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-1418"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Phantom</span>
<a name="line-1419"></a><span class='hs-definition'>nthRole</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span>
<a name="line-1420"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>`getNth`</span> <span class='hs-varid'>n</span>
<a name="line-1421"></a>
<a name="line-1422"></a><a name="ltRole"></a><span class='hs-definition'>ltRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1423"></a><span class='hs-comment'>-- Is one role "less" than another?</span>
<a name="line-1424"></a><span class='hs-comment'>--     Nominal &lt; Representational &lt; Phantom</span>
<a name="line-1425"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1426"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-conid'>Phantom</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1427"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1428"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-conid'>Nominal</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1429"></a><span class='hs-definition'>ltRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1430"></a>
<a name="line-1431"></a><span class='hs-comment'>-------------------------------</span>
<a name="line-1432"></a>
<a name="line-1433"></a><a name="promoteCoercion"></a><span class='hs-comment'>-- | like mkKindCo, but aggressively &amp; recursively optimizes to avoid using</span>
<a name="line-1434"></a><span class='hs-comment'>-- a KindCo constructor. The output role is nominal.</span>
<a name="line-1435"></a><span class='hs-definition'>promoteCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1436"></a>
<a name="line-1437"></a><span class='hs-comment'>-- First cases handles anything that should yield refl.</span>
<a name="line-1438"></a><span class='hs-definition'>promoteCoercion</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-1439"></a>
<a name="line-1440"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>ki1</span> <span class='hs-varop'>`eqType`</span> <span class='hs-varid'>ki2</span>
<a name="line-1441"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-1442"></a>     <span class='hs-comment'>-- no later branch should return refl</span>
<a name="line-1443"></a>     <span class='hs-comment'>--    The ASSERT( False )s throughout</span>
<a name="line-1444"></a>     <span class='hs-comment'>-- are these cases explicitly, but they should never fire.</span>
<a name="line-1445"></a>
<a name="line-1446"></a>    <span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-1447"></a>              <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ki1</span>
<a name="line-1448"></a>
<a name="line-1449"></a>    <span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>MRefl</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-1450"></a>                       <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ki1</span>
<a name="line-1451"></a>
<a name="line-1452"></a>    <span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co</span>
<a name="line-1453"></a>
<a name="line-1454"></a>    <span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span>
<a name="line-1455"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCoercions</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1456"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-1457"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1458"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1459"></a>
<a name="line-1460"></a>    <span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>arg</span>
<a name="line-1461"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1462"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span>
<a name="line-1463"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>co'</span>
<a name="line-1464"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1465"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1466"></a>
<a name="line-1467"></a>    <span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>g</span>
<a name="line-1468"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-1469"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span>
<a name="line-1470"></a>
<a name="line-1471"></a>    <span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1472"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-1473"></a>         <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1474"></a>      <span class='hs-comment'>-- See Note [Weird typing rule for ForAllTy] in GHC.Core.TyCo.Rep</span>
<a name="line-1475"></a>
<a name="line-1476"></a>    <span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>
<a name="line-1477"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-1478"></a>         <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1479"></a>
<a name="line-1480"></a>    <span class='hs-conid'>CoVarCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1481"></a>    <span class='hs-conid'>HoleCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1482"></a>    <span class='hs-conid'>AxiomInstCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1483"></a>    <span class='hs-conid'>AxiomRuleCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1484"></a>
<a name="line-1485"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span>    <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kco</span>
<a name="line-1486"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>kco</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>kco</span>
<a name="line-1487"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1488"></a>    <span class='hs-conid'>UnivCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>     <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1489"></a>
<a name="line-1490"></a>    <span class='hs-conid'>SymCo</span> <span class='hs-varid'>g</span>
<a name="line-1491"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1492"></a>
<a name="line-1493"></a>    <span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-1494"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-1495"></a>
<a name="line-1496"></a>    <span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co1</span>
<a name="line-1497"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConAppCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-1498"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>n</span>
<a name="line-1499"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>!!</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-1500"></a>
<a name="line-1501"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllCo_maybe</span> <span class='hs-varid'>co</span>
<a name="line-1502"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-1503"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span> <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1504"></a>
<a name="line-1505"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1506"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1507"></a>
<a name="line-1508"></a>    <span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co1</span>
<a name="line-1509"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lco</span><span class='hs-layout'>,</span> <span class='hs-varid'>rco</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitAppCo_maybe</span> <span class='hs-varid'>co1</span>
<a name="line-1510"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lr</span> <span class='hs-keyword'>of</span>
<a name="line-1511"></a>           <span class='hs-conid'>CLeft</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>lco</span>
<a name="line-1512"></a>           <span class='hs-conid'>CRight</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>rco</span>
<a name="line-1513"></a>
<a name="line-1514"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1515"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co</span>
<a name="line-1516"></a>
<a name="line-1517"></a>    <span class='hs-conid'>InstCo</span> <span class='hs-varid'>g</span> <span class='hs-keyword'>_</span>
<a name="line-1518"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForAllTy_ty</span> <span class='hs-varid'>ty1</span>
<a name="line-1519"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isForAllTy_ty</span> <span class='hs-varid'>ty2</span> <span class='hs-layout'>)</span>
<a name="line-1520"></a>         <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span>
<a name="line-1521"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1522"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1523"></a>         <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1524"></a>           <span class='hs-comment'>-- See Note [Weird typing rule for ForAllTy] in GHC.Core.TyCo.Rep</span>
<a name="line-1525"></a>
<a name="line-1526"></a>    <span class='hs-conid'>KindCo</span> <span class='hs-keyword'>_</span>
<a name="line-1527"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-conid'>False</span> <span class='hs-layout'>)</span>
<a name="line-1528"></a>         <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1529"></a>
<a name="line-1530"></a>    <span class='hs-conid'>SubCo</span> <span class='hs-varid'>g</span>
<a name="line-1531"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promoteCoercion</span> <span class='hs-varid'>g</span>
<a name="line-1532"></a>
<a name="line-1533"></a>  <span class='hs-keyword'>where</span>
<a name="line-1534"></a>    <span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span>
<a name="line-1535"></a>    <span class='hs-varid'>ki1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-1536"></a>    <span class='hs-varid'>ki2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-1537"></a>
<a name="line-1538"></a><a name="instCoercion"></a><span class='hs-comment'>-- | say @g = promoteCoercion h@. Then, @instCoercion g w@ yields @Just g'@,</span>
<a name="line-1539"></a><span class='hs-comment'>-- where @g' = promoteCoercion (h w)@.</span>
<a name="line-1540"></a><span class='hs-comment'>-- fails if this is not possible, if @g@ coerces between a forall and an -&gt;</span>
<a name="line-1541"></a><span class='hs-comment'>-- or if second parameter has a representational role and can't be used</span>
<a name="line-1542"></a><span class='hs-comment'>-- with an InstCo.</span>
<a name="line-1543"></a><span class='hs-definition'>instCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span> <span class='hs-comment'>-- g :: lty ~ rty</span>
<a name="line-1544"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span>  <span class='hs-comment'>-- ^  must be nominal</span>
<a name="line-1545"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1546"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1547"></a><span class='hs-definition'>instCoercion</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>lty</span> <span class='hs-varid'>rty</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span> <span class='hs-varid'>w</span>
<a name="line-1548"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>isForAllTy_ty</span> <span class='hs-varid'>lty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isForAllTy_ty</span> <span class='hs-varid'>rty</span><span class='hs-layout'>)</span>
<a name="line-1549"></a>  <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>isForAllTy_co</span> <span class='hs-varid'>lty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isForAllTy_co</span> <span class='hs-varid'>rty</span><span class='hs-layout'>)</span>
<a name="line-1550"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>w'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setNominalRole_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-varid'>w</span>
<a name="line-1551"></a>    <span class='hs-comment'>-- g :: (forall t1. t2) ~ (forall t1. t3)</span>
<a name="line-1552"></a>    <span class='hs-comment'>-- w :: s1 ~ s2</span>
<a name="line-1553"></a>    <span class='hs-comment'>-- returns mkInstCo g w' :: t2 [t1 |-&gt; s1 ] ~ t3 [t1 |-&gt; s2]</span>
<a name="line-1554"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInstCo</span> <span class='hs-varid'>g</span> <span class='hs-varid'>w'</span>
<a name="line-1555"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>lty</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isFunTy</span> <span class='hs-varid'>rty</span>
<a name="line-1556"></a>    <span class='hs-comment'>-- g :: (t1 -&gt; t2) ~ (t3 -&gt; t4)</span>
<a name="line-1557"></a>    <span class='hs-comment'>-- returns t2 ~ t4</span>
<a name="line-1558"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-num'>4</span> <span class='hs-varid'>g</span> <span class='hs-comment'>-- extract result type, which is the 5th argument to (-&gt;)</span>
<a name="line-1559"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-comment'>-- one forall, one funty...</span>
<a name="line-1560"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1561"></a>
<a name="line-1562"></a><a name="instCoercions"></a><span class='hs-comment'>-- | Repeated use of 'instCoercion'</span>
<a name="line-1563"></a><span class='hs-definition'>instCoercions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1564"></a><span class='hs-definition'>instCoercions</span> <span class='hs-varid'>g</span> <span class='hs-varid'>ws</span>
<a name="line-1565"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_ty_pairs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>ws</span> <span class='hs-keyword'>in</span>
<a name="line-1566"></a>    <span class='hs-varid'>snd</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>foldM</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>g</span><span class='hs-layout'>,</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>zip</span> <span class='hs-varid'>arg_ty_pairs</span> <span class='hs-varid'>ws</span><span class='hs-layout'>)</span>
<a name="line-1567"></a>  <span class='hs-keyword'>where</span>
<a name="line-1568"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1569"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1570"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>g_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>w_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-1571"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>g'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instCoercion</span> <span class='hs-varid'>g_tys</span> <span class='hs-varid'>g</span> <span class='hs-varid'>w</span>
<a name="line-1572"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>piResultTy</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>g_tys</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>w_tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>g'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1573"></a>
<a name="line-1574"></a><a name="castCoercionKind2"></a><span class='hs-comment'>-- | Creates a new coercion with both of its types casted by different casts</span>
<a name="line-1575"></a><span class='hs-comment'>-- @castCoercionKind2 g r t1 t2 h1 h2@, where @g :: t1 ~r t2@,</span>
<a name="line-1576"></a><span class='hs-comment'>-- has type @(t1 |&gt; h1) ~r (t2 |&gt; h2)@.</span>
<a name="line-1577"></a><span class='hs-comment'>-- @h1@ and @h2@ must be nominal.</span>
<a name="line-1578"></a><span class='hs-definition'>castCoercionKind2</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1579"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1580"></a><span class='hs-definition'>castCoercionKind2</span> <span class='hs-varid'>g</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>h1</span> <span class='hs-varid'>h2</span>
<a name="line-1581"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoherenceRightCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>h2</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoherenceLeftCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>h1</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1582"></a>
<a name="line-1583"></a><a name="castCoercionKind1"></a><span class='hs-comment'>-- | @castCoercionKind1 g r t1 t2 h@ = @coercionKind g r t1 t2 h h@</span>
<a name="line-1584"></a><span class='hs-comment'>-- That is, it's a specialised form of castCoercionKind, where the two</span>
<a name="line-1585"></a><span class='hs-comment'>--          kind coercions are identical</span>
<a name="line-1586"></a><span class='hs-comment'>-- @castCoercionKind1 g r t1 t2 h@, where @g :: t1 ~r t2@,</span>
<a name="line-1587"></a><span class='hs-comment'>-- has type @(t1 |&gt; h) ~r (t2 |&gt; h)@.</span>
<a name="line-1588"></a><span class='hs-comment'>-- @h@ must be nominal.</span>
<a name="line-1589"></a><span class='hs-comment'>-- See Note [castCoercionKind1]</span>
<a name="line-1590"></a><span class='hs-definition'>castCoercionKind1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-1591"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1592"></a><span class='hs-definition'>castCoercionKind1</span> <span class='hs-varid'>g</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>h</span>
<a name="line-1593"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>g</span> <span class='hs-keyword'>of</span>
<a name="line-1594"></a>      <span class='hs-conid'>Refl</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span> <span class='hs-comment'>-- Refl is always Nominal</span>
<a name="line-1595"></a>                 <span class='hs-varid'>mkNomReflCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-1596"></a>      <span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mco</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mco</span> <span class='hs-keyword'>of</span>
<a name="line-1597"></a>           <span class='hs-conid'>MRefl</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-1598"></a>           <span class='hs-conid'>MCo</span> <span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1599"></a>                          <span class='hs-conid'>MCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>h</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>kind_co</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-1600"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>castCoercionKind2</span> <span class='hs-varid'>g</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>h</span> <span class='hs-varid'>h</span>
<a name="line-1601"></a>
<a name="line-1602"></a><a name="castCoercionKind"></a><span class='hs-comment'>-- | Creates a new coercion with both of its types casted by different casts</span>
<a name="line-1603"></a><span class='hs-comment'>-- @castCoercionKind g h1 h2@, where @g :: t1 ~r t2@,</span>
<a name="line-1604"></a><span class='hs-comment'>-- has type @(t1 |&gt; h1) ~r (t2 |&gt; h2)@.</span>
<a name="line-1605"></a><span class='hs-comment'>-- @h1@ and @h2@ must be nominal.</span>
<a name="line-1606"></a><span class='hs-comment'>-- It calls @coercionKindRole@, so it's quite inefficient (which 'I' stands for)</span>
<a name="line-1607"></a><span class='hs-comment'>-- Use @castCoercionKind2@ instead if @t1@, @t2@, and @r@ are known beforehand.</span>
<a name="line-1608"></a><span class='hs-definition'>castCoercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1609"></a><span class='hs-definition'>castCoercionKind</span> <span class='hs-varid'>g</span> <span class='hs-varid'>h1</span> <span class='hs-varid'>h2</span>
<a name="line-1610"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>castCoercionKind2</span> <span class='hs-varid'>g</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span> <span class='hs-varid'>h1</span> <span class='hs-varid'>h2</span>
<a name="line-1611"></a>  <span class='hs-keyword'>where</span>
<a name="line-1612"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKindRole</span> <span class='hs-varid'>g</span>
<a name="line-1613"></a>
<a name="line-1614"></a><a name="mkFamilyTyConAppCo"></a><span class='hs-definition'>mkFamilyTyConAppCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>CoercionN</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span>
<a name="line-1615"></a><span class='hs-comment'>-- ^ Given a family instance 'TyCon' and its arg 'Coercion's, return the</span>
<a name="line-1616"></a><span class='hs-comment'>-- corresponding family 'Coercion'.  E.g:</span>
<a name="line-1617"></a><span class='hs-comment'>--</span>
<a name="line-1618"></a><span class='hs-comment'>-- &gt; data family T a</span>
<a name="line-1619"></a><span class='hs-comment'>-- &gt; data instance T (Maybe b) = MkT b</span>
<a name="line-1620"></a><span class='hs-comment'>--</span>
<a name="line-1621"></a><span class='hs-comment'>-- Where the instance 'TyCon' is :RTL, so:</span>
<a name="line-1622"></a><span class='hs-comment'>--</span>
<a name="line-1623"></a><span class='hs-comment'>-- &gt; mkFamilyTyConAppCo :RTL (co :: a ~# Int) = T (Maybe a) ~# T (Maybe Int)</span>
<a name="line-1624"></a><span class='hs-comment'>--</span>
<a name="line-1625"></a><span class='hs-comment'>-- cf. 'mkFamilyTyConApp'</span>
<a name="line-1626"></a><span class='hs-definition'>mkFamilyTyConAppCo</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1627"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>fam_tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConFamInst_maybe</span> <span class='hs-varid'>tc</span>
<a name="line-1628"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span>
<a name="line-1629"></a>        <span class='hs-varid'>fam_cos</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-varid'>cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>cos</span> <span class='hs-layout'>)</span>
<a name="line-1630"></a>                  <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftCoSubstWith</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>fam_tys</span>
<a name="line-1631"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>fam_cos</span>
<a name="line-1632"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1633"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span>
<a name="line-1634"></a>
<a name="line-1635"></a><span class='hs-comment'>-- See note [Newtype coercions] in GHC.Core.TyCon</span>
<a name="line-1636"></a>
<a name="line-1637"></a><a name="mkPiCos"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Var</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1638"></a><span class='hs-definition'>mkPiCos</span> <span class='hs-varid'>r</span> <span class='hs-varid'>vs</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPiCo</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span> <span class='hs-varid'>vs</span>
<a name="line-1639"></a>
<a name="line-1640"></a><a name="mkPiCo"></a><span class='hs-comment'>-- | Make a forall 'Coercion', where both types related by the coercion</span>
<a name="line-1641"></a><span class='hs-comment'>-- are quantified over the same variable.</span>
<a name="line-1642"></a><span class='hs-definition'>mkPiCo</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Var</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1643"></a><span class='hs-definition'>mkPiCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>v</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomoForAllCos</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>]</span> <span class='hs-varid'>co</span>
<a name="line-1644"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>v</span> <span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1645"></a>                  <span class='hs-comment'>-- We didn't call mkForAllCo here because if v does not appear</span>
<a name="line-1646"></a>                  <span class='hs-comment'>-- in co, the argement coercion will be nominal. But here we</span>
<a name="line-1647"></a>                  <span class='hs-comment'>-- want it to be r. It is only called in 'mkPiCos', which is</span>
<a name="line-1648"></a>                  <span class='hs-comment'>-- only used in GHC.Core.Opt.Simplify.Utils, where we are sure for</span>
<a name="line-1649"></a>                  <span class='hs-comment'>-- now (Aug 2018) v won't occur in co.</span>
<a name="line-1650"></a>                            <span class='hs-varid'>mkFunResCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>scaled_ty</span> <span class='hs-varid'>co</span>
<a name="line-1651"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunResCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>scaled_ty</span> <span class='hs-varid'>co</span>
<a name="line-1652"></a>              <span class='hs-keyword'>where</span>
<a name="line-1653"></a>                <span class='hs-varid'>scaled_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Scaled</span> <span class='hs-layout'>(</span><span class='hs-varid'>varMult</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-1654"></a>
<a name="line-1655"></a><a name="mkFunResCo"></a><span class='hs-definition'>mkFunResCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Scaled</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1656"></a><span class='hs-comment'>-- Given res_co :: res1 -&gt; res2,</span>
<a name="line-1657"></a><span class='hs-comment'>--   mkFunResCo r m arg res_co :: (arg -&gt; res1) ~r (arg -&gt; res2)</span>
<a name="line-1658"></a><span class='hs-comment'>-- Reflexive in the multiplicity argument</span>
<a name="line-1659"></a><span class='hs-definition'>mkFunResCo</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-conid'>Scaled</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_co</span>
<a name="line-1660"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>role</span> <span class='hs-layout'>(</span><span class='hs-varid'>multToCo</span> <span class='hs-varid'>mult</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>arg_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_co</span>
<a name="line-1661"></a>
<a name="line-1662"></a><a name="mkCoCast"></a><span class='hs-comment'>-- mkCoCast (c :: s1 ~?r t1) (g :: (s1 ~?r t1) ~#R (s2 ~?r t2)) :: s2 ~?r t2</span>
<a name="line-1663"></a><span class='hs-comment'>-- The first coercion might be lifted or unlifted; thus the ~? above</span>
<a name="line-1664"></a><span class='hs-comment'>-- Lifted and unlifted equalities take different numbers of arguments,</span>
<a name="line-1665"></a><span class='hs-comment'>-- so we have to make sure to supply the right parameter to decomposeCo.</span>
<a name="line-1666"></a><span class='hs-comment'>-- Also, note that the role of the first coercion is the same as the role of</span>
<a name="line-1667"></a><span class='hs-comment'>-- the equalities related by the second coercion. The second coercion is</span>
<a name="line-1668"></a><span class='hs-comment'>-- itself always representational.</span>
<a name="line-1669"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionR</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1670"></a><span class='hs-definition'>mkCoCast</span> <span class='hs-varid'>c</span> <span class='hs-varid'>g</span>
<a name="line-1671"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>g2</span><span class='hs-conop'>:</span><span class='hs-varid'>g1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>co_list</span>
<a name="line-1672"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>g1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>g2</span>
<a name="line-1673"></a>
<a name="line-1674"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1675"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"mkCoCast"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>g</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1676"></a>  <span class='hs-keyword'>where</span>
<a name="line-1677"></a>    <span class='hs-comment'>-- g  :: (s1 ~# t1) ~# (s2 ~# t2)</span>
<a name="line-1678"></a>    <span class='hs-comment'>-- g1 :: s1 ~# s2</span>
<a name="line-1679"></a>    <span class='hs-comment'>-- g2 :: t1 ~# t2</span>
<a name="line-1680"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionLKind</span> <span class='hs-varid'>g</span><span class='hs-layout'>)</span>
<a name="line-1681"></a>    <span class='hs-varid'>co_list</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposeCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesRepresentational</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1682"></a>
<a name="line-1683"></a><span class='hs-comment'>{- Note [castCoercionKind1]
<a name="line-1684"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1685"></a>castCoercionKind1 deals with the very important special case of castCoercionKind2
<a name="line-1686"></a>where the two kind coercions are identical.  In that case we can exploit the
<a name="line-1687"></a>situation where the main coercion is reflexive, via the special cases for Refl
<a name="line-1688"></a>and GRefl.
<a name="line-1689"></a>
<a name="line-1690"></a>This is important when rewriting  (ty |&gt; co). We rewrite ty, yielding
<a name="line-1691"></a>   fco :: ty ~ ty'
<a name="line-1692"></a>and now we want a coercion xco between
<a name="line-1693"></a>   xco :: (ty |&gt; co) ~ (ty' |&gt; co)
<a name="line-1694"></a>That's exactly what castCoercionKind1 does.  And it's very very common for
<a name="line-1695"></a>fco to be Refl.  In that case we do NOT want to get some terrible composition
<a name="line-1696"></a>of mkLeftCoherenceCo and mkRightCoherenceCo, which is what castCoercionKind2
<a name="line-1697"></a>has to do in its full generality.  See #18413.
<a name="line-1698"></a>-}</span>
<a name="line-1699"></a>
<a name="line-1700"></a><span class='hs-comment'>{-
<a name="line-1701"></a>%************************************************************************
<a name="line-1702"></a>%*                                                                      *
<a name="line-1703"></a>            Newtypes
<a name="line-1704"></a>%*                                                                      *
<a name="line-1705"></a>%************************************************************************
<a name="line-1706"></a>-}</span>
<a name="line-1707"></a>
<a name="line-1708"></a><a name="instNewTyCon_maybe"></a><span class='hs-comment'>-- | If @co :: T ts ~ rep_ty@ then:</span>
<a name="line-1709"></a><span class='hs-comment'>--</span>
<a name="line-1710"></a><span class='hs-comment'>-- &gt; instNewTyCon_maybe T ts = Just (rep_ty, co)</span>
<a name="line-1711"></a><span class='hs-comment'>--</span>
<a name="line-1712"></a><span class='hs-comment'>-- Checks for a newtype, and for being saturated</span>
<a name="line-1713"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-1714"></a><span class='hs-definition'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1715"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>co_tc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwrapNewTyConEtad_maybe</span> <span class='hs-varid'>tc</span>  <span class='hs-comment'>-- Check for newtype</span>
<a name="line-1716"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`leLength`</span> <span class='hs-varid'>tys</span>                                    <span class='hs-comment'>-- Check saturated enough</span>
<a name="line-1717"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>applyTysX</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkUnbranchedAxInstCo</span> <span class='hs-conid'>Representational</span> <span class='hs-varid'>co_tc</span> <span class='hs-varid'>tys</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1718"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1719"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1720"></a>
<a name="line-1721"></a><span class='hs-comment'>{-
<a name="line-1722"></a>************************************************************************
<a name="line-1723"></a>*                                                                      *
<a name="line-1724"></a>         Type normalisation
<a name="line-1725"></a>*                                                                      *
<a name="line-1726"></a>************************************************************************
<a name="line-1727"></a>-}</span>
<a name="line-1728"></a>
<a name="line-1729"></a><a name="NormaliseStepper"></a><span class='hs-comment'>-- | A function to check if we can reduce a type by one step. Used</span>
<a name="line-1730"></a><a name="NormaliseStepper"></a><span class='hs-comment'>-- with 'topNormaliseTypeX'.</span>
<a name="line-1731"></a><a name="NormaliseStepper"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecTcChecker</span>
<a name="line-1732"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCon</span>     <span class='hs-comment'>-- tc</span>
<a name="line-1733"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- tys</span>
<a name="line-1734"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev</span>
<a name="line-1735"></a>
<a name="line-1736"></a><a name="NormaliseStepResult"></a><span class='hs-comment'>-- | The result of stepping in a normalisation function.</span>
<a name="line-1737"></a><a name="NormaliseStepResult"></a><span class='hs-comment'>-- See 'topNormaliseTypeX'.</span>
<a name="line-1738"></a><a name="NormaliseStepResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev</span>
<a name="line-1739"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>   <span class='hs-comment'>-- ^ Nothing more to do</span>
<a name="line-1740"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NS_Abort</span>  <span class='hs-comment'>-- ^ Utter failure. The outer function should fail too.</span>
<a name="line-1741"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>NS_Step</span> <span class='hs-conid'>RecTcChecker</span> <span class='hs-conid'>Type</span> <span class='hs-varid'>ev</span>    <span class='hs-comment'>-- ^ We stepped, yielding new bits;</span>
<a name="line-1742"></a>                                    <span class='hs-comment'>-- ^ ev is evidence;</span>
<a name="line-1743"></a>                                    <span class='hs-comment'>-- Usually a co :: old type ~ new type</span>
<a name="line-1744"></a>
<a name="line-1745"></a><a name="instance%20Outputable%20(NormaliseStepResult%20ev)"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Outputable</span> <span class='hs-layout'>(</span><span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-1746"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NS_Done</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NS_Done"</span>
<a name="line-1747"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>NS_Abort</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"NS_Abort"</span>
<a name="line-1748"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>NS_Step</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>text</span> <span class='hs-str'>"NS_Step"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ev</span><span class='hs-keyglyph'>]</span>
<a name="line-1749"></a>
<a name="line-1750"></a><a name="mapStepResult"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ev2</span><span class='hs-layout'>)</span>
<a name="line-1751"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev1</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepResult</span> <span class='hs-varid'>ev2</span>
<a name="line-1752"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1753"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NS_Done</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>
<a name="line-1754"></a><span class='hs-definition'>mapStepResult</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NS_Abort</span>                <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1755"></a>
<a name="line-1756"></a><a name="composeSteppers"></a><span class='hs-comment'>-- | Try one stepper and then try the next, if the first doesn't make</span>
<a name="line-1757"></a><span class='hs-comment'>-- progress.</span>
<a name="line-1758"></a><span class='hs-comment'>-- So if it returns NS_Done, it means that both steppers are satisfied</span>
<a name="line-1759"></a><span class='hs-definition'>composeSteppers</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span>
<a name="line-1760"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span>
<a name="line-1761"></a><span class='hs-definition'>composeSteppers</span> <span class='hs-varid'>step1</span> <span class='hs-varid'>step2</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1762"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>step1</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-1763"></a>      <span class='hs-varid'>success</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>NS_Step</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>success</span>
<a name="line-1764"></a>      <span class='hs-conid'>NS_Done</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>step2</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1765"></a>      <span class='hs-conid'>NS_Abort</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1766"></a>
<a name="line-1767"></a><a name="unwrapNewTypeStepper"></a><span class='hs-comment'>-- | A 'NormaliseStepper' that unwraps newtypes, careful not to fall into</span>
<a name="line-1768"></a><span class='hs-comment'>-- a loop. If it would fall into a loop, it produces 'NS_Abort'.</span>
<a name="line-1769"></a><span class='hs-definition'>unwrapNewTypeStepper</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-conid'>Coercion</span>
<a name="line-1770"></a><span class='hs-definition'>unwrapNewTypeStepper</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1771"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>instNewTyCon_maybe</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1772"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>checkRecTc</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-keyword'>of</span>
<a name="line-1773"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>co</span>
<a name="line-1774"></a>      <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NS_Abort</span>
<a name="line-1775"></a>
<a name="line-1776"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1777"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>NS_Done</span>
<a name="line-1778"></a>
<a name="line-1779"></a><a name="topNormaliseTypeX"></a><span class='hs-comment'>-- | A general function for normalising the top-level of a type. It continues</span>
<a name="line-1780"></a><span class='hs-comment'>-- to use the provided 'NormaliseStepper' until that function fails, and then</span>
<a name="line-1781"></a><span class='hs-comment'>-- this function returns. The roles of the coercions produced by the</span>
<a name="line-1782"></a><span class='hs-comment'>-- 'NormaliseStepper' must all be the same, which is the role returned from</span>
<a name="line-1783"></a><span class='hs-comment'>-- the call to 'topNormaliseTypeX'.</span>
<a name="line-1784"></a><span class='hs-comment'>--</span>
<a name="line-1785"></a><span class='hs-comment'>-- Typically ev is Coercion.</span>
<a name="line-1786"></a><span class='hs-comment'>--</span>
<a name="line-1787"></a><span class='hs-comment'>-- If topNormaliseTypeX step plus ty = Just (ev, ty')</span>
<a name="line-1788"></a><span class='hs-comment'>-- then ty ~ev1~ t1 ~ev2~ t2 ... ~evn~ ty'</span>
<a name="line-1789"></a><span class='hs-comment'>-- and ev = ev1 `plus` ev2 `plus` ... `plus` evn</span>
<a name="line-1790"></a><span class='hs-comment'>-- If it returns Nothing then no newtype unwrapping could happen</span>
<a name="line-1791"></a><span class='hs-definition'>topNormaliseTypeX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>NormaliseStepper</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span>
<a name="line-1792"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1793"></a><span class='hs-definition'>topNormaliseTypeX</span> <span class='hs-varid'>stepper</span> <span class='hs-varid'>plus</span> <span class='hs-varid'>ty</span>
<a name="line-1794"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1795"></a> <span class='hs-layout'>,</span> <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepper</span> <span class='hs-varid'>initRecTc</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span>
<a name="line-1796"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>ty'</span>
<a name="line-1797"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1798"></a> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1799"></a> <span class='hs-keyword'>where</span>
<a name="line-1800"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>ev</span> <span class='hs-varid'>ty</span>
<a name="line-1801"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1802"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stepper</span> <span class='hs-varid'>rec_nts</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span> <span class='hs-keyword'>of</span>
<a name="line-1803"></a>          <span class='hs-conid'>NS_Step</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-varid'>ty'</span> <span class='hs-varid'>ev'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>rec_nts'</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span> <span class='hs-varop'>`plus`</span> <span class='hs-varid'>ev'</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty'</span>
<a name="line-1804"></a>          <span class='hs-conid'>NS_Done</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1805"></a>          <span class='hs-conid'>NS_Abort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-1806"></a>
<a name="line-1807"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1808"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ev</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1809"></a>
<a name="line-1810"></a><a name="topNormaliseNewType_maybe"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span>
<a name="line-1811"></a><span class='hs-comment'>-- ^ Sometimes we want to look through a @newtype@ and get its associated coercion.</span>
<a name="line-1812"></a><span class='hs-comment'>-- This function strips off @newtype@ layers enough to reveal something that isn't</span>
<a name="line-1813"></a><span class='hs-comment'>-- a @newtype@.  Specifically, here's the invariant:</span>
<a name="line-1814"></a><span class='hs-comment'>--</span>
<a name="line-1815"></a><span class='hs-comment'>-- &gt; topNormaliseNewType_maybe rec_nts ty = Just (co, ty')</span>
<a name="line-1816"></a><span class='hs-comment'>--</span>
<a name="line-1817"></a><span class='hs-comment'>-- then (a)  @co : ty ~ ty'@.</span>
<a name="line-1818"></a><span class='hs-comment'>--      (b)  ty' is not a newtype.</span>
<a name="line-1819"></a><span class='hs-comment'>--</span>
<a name="line-1820"></a><span class='hs-comment'>-- The function returns @Nothing@ for non-@newtypes@,</span>
<a name="line-1821"></a><span class='hs-comment'>-- or unsaturated applications</span>
<a name="line-1822"></a><span class='hs-comment'>--</span>
<a name="line-1823"></a><span class='hs-comment'>-- This function does *not* look through type families, because it has no access to</span>
<a name="line-1824"></a><span class='hs-comment'>-- the type family environment. If you do have that at hand, consider to use</span>
<a name="line-1825"></a><span class='hs-comment'>-- topNormaliseType_maybe, which should be a drop-in replacement for</span>
<a name="line-1826"></a><span class='hs-comment'>-- topNormaliseNewType_maybe</span>
<a name="line-1827"></a><span class='hs-comment'>-- If topNormliseNewType_maybe ty = Just (co, ty'), then co : ty ~R ty'</span>
<a name="line-1828"></a><span class='hs-definition'>topNormaliseNewType_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1829"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>topNormaliseTypeX</span> <span class='hs-varid'>unwrapNewTypeStepper</span> <span class='hs-varid'>mkTransCo</span> <span class='hs-varid'>ty</span>
<a name="line-1830"></a>
<a name="line-1831"></a><span class='hs-comment'>{-
<a name="line-1832"></a>%************************************************************************
<a name="line-1833"></a>%*                                                                      *
<a name="line-1834"></a>                   Comparison of coercions
<a name="line-1835"></a>%*                                                                      *
<a name="line-1836"></a>%************************************************************************
<a name="line-1837"></a>-}</span>
<a name="line-1838"></a>
<a name="line-1839"></a><a name="eqCoercion"></a><span class='hs-comment'>-- | Syntactic equality of coercions</span>
<a name="line-1840"></a><span class='hs-definition'>eqCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1841"></a><span class='hs-definition'>eqCoercion</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqType</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>coercionType</span>
<a name="line-1842"></a>
<a name="line-1843"></a><a name="eqCoercionX"></a><span class='hs-comment'>-- | Compare two 'Coercion's, with respect to an RnEnv2</span>
<a name="line-1844"></a><span class='hs-definition'>eqCoercionX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RnEnv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1845"></a><span class='hs-definition'>eqCoercionX</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eqTypeX</span> <span class='hs-varid'>env</span> <span class='hs-varop'>`on`</span> <span class='hs-varid'>coercionType</span>
<a name="line-1846"></a>
<a name="line-1847"></a><span class='hs-comment'>{-
<a name="line-1848"></a>%************************************************************************
<a name="line-1849"></a>%*                                                                      *
<a name="line-1850"></a>                   "Lifting" substitution
<a name="line-1851"></a>           [(TyCoVar,Coercion)] -&gt; Type -&gt; Coercion
<a name="line-1852"></a>%*                                                                      *
<a name="line-1853"></a>%************************************************************************
<a name="line-1854"></a>
<a name="line-1855"></a>Note [Lifting coercions over types: liftCoSubst]
<a name="line-1856"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1857"></a>The KPUSH rule deals with this situation
<a name="line-1858"></a>   data T a = K (a -&gt; Maybe a)
<a name="line-1859"></a>   g :: T t1 ~ T t2
<a name="line-1860"></a>   x :: t1 -&gt; Maybe t1
<a name="line-1861"></a>
<a name="line-1862"></a>   case (K @t1 x) |&gt; g of
<a name="line-1863"></a>     K (y:t2 -&gt; Maybe t2) -&gt; rhs
<a name="line-1864"></a>
<a name="line-1865"></a>We want to push the coercion inside the constructor application.
<a name="line-1866"></a>So we do this
<a name="line-1867"></a>
<a name="line-1868"></a>   g' :: t1~t2  =  Nth 0 g
<a name="line-1869"></a>
<a name="line-1870"></a>   case K @t2 (x |&gt; g' -&gt; Maybe g') of
<a name="line-1871"></a>     K (y:t2 -&gt; Maybe t2) -&gt; rhs
<a name="line-1872"></a>
<a name="line-1873"></a>The crucial operation is that we
<a name="line-1874"></a>  * take the type of K's argument: a -&gt; Maybe a
<a name="line-1875"></a>  * and substitute g' for a
<a name="line-1876"></a>thus giving *coercion*.  This is what liftCoSubst does.
<a name="line-1877"></a>
<a name="line-1878"></a>In the presence of kind coercions, this is a bit
<a name="line-1879"></a>of a hairy operation. So, we refer you to the paper introducing kind coercions,
<a name="line-1880"></a>available at www.cis.upenn.edu/~sweirich/papers/fckinds-extended.pdf
<a name="line-1881"></a>
<a name="line-1882"></a>Note [extendLiftingContextEx]
<a name="line-1883"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1884"></a>Consider we have datatype
<a name="line-1885"></a>  K :: \/k. \/a::k. P -&gt; T k  -- P be some type
<a name="line-1886"></a>  g :: T k1 ~ T k2
<a name="line-1887"></a>
<a name="line-1888"></a>  case (K @k1 @t1 x) |&gt; g of
<a name="line-1889"></a>    K y -&gt; rhs
<a name="line-1890"></a>
<a name="line-1891"></a>We want to push the coercion inside the constructor application.
<a name="line-1892"></a>We first get the coercion mapped by the universal type variable k:
<a name="line-1893"></a>   lc = k |-&gt; Nth 0 g :: k1~k2
<a name="line-1894"></a>
<a name="line-1895"></a>Here, the important point is that the kind of a is coerced, and P might be
<a name="line-1896"></a>dependent on the existential type variable a.
<a name="line-1897"></a>Thus we first get the coercion of a's kind
<a name="line-1898"></a>   g2 = liftCoSubst lc k :: k1 ~ k2
<a name="line-1899"></a>
<a name="line-1900"></a>Then we store a new mapping into the lifting context
<a name="line-1901"></a>   lc2 = a |-&gt; (t1 ~ t1 |&gt; g2), lc
<a name="line-1902"></a>
<a name="line-1903"></a>So later when we can correctly deal with the argument type P
<a name="line-1904"></a>   liftCoSubst lc2 P :: P [k|-&gt;k1][a|-&gt;t1] ~ P[k|-&gt;k2][a |-&gt; (t1|&gt;g2)]
<a name="line-1905"></a>
<a name="line-1906"></a>This is exactly what extendLiftingContextEx does.
<a name="line-1907"></a>* For each (tyvar:k, ty) pair, we product the mapping
<a name="line-1908"></a>    tyvar |-&gt; (ty ~ ty |&gt; (liftCoSubst lc k))
<a name="line-1909"></a>* For each (covar:s1~s2, ty) pair, we produce the mapping
<a name="line-1910"></a>    covar |-&gt; (co ~ co')
<a name="line-1911"></a>    co' = Sym (liftCoSubst lc s1) ;; covar ;; liftCoSubst lc s2 :: s1'~s2'
<a name="line-1912"></a>
<a name="line-1913"></a>This follows the lifting context extension definition in the
<a name="line-1914"></a>"FC with Explicit Kind Equality" paper.
<a name="line-1915"></a>-}</span>
<a name="line-1916"></a>
<a name="line-1917"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-1918"></a><span class='hs-comment'>-- See Note [Lifting coercions over types: liftCoSubst]</span>
<a name="line-1919"></a><span class='hs-comment'>-- ----------------------------------------------------</span>
<a name="line-1920"></a>
<a name="line-1921"></a><a name="LiftingContext"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-1922"></a>  <span class='hs-comment'>-- in optCoercion, we need to lift when optimizing InstCo.</span>
<a name="line-1923"></a>  <span class='hs-comment'>-- See Note [Optimising InstCo] in GHC.Core.Coercion.Opt</span>
<a name="line-1924"></a>  <span class='hs-comment'>-- We thus propagate the substitution from GHC.Core.Coercion.Opt here.</span>
<a name="line-1925"></a>
<a name="line-1926"></a><a name="instance%20Outputable%20LiftingContext"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyword'>where</span>
<a name="line-1927"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"LiftingContext:"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span>
<a name="line-1928"></a>
<a name="line-1929"></a><a name="LiftCoEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-conid'>Coercion</span>
<a name="line-1930"></a>     <span class='hs-comment'>-- Maps *type variables* to *coercions*.</span>
<a name="line-1931"></a>     <span class='hs-comment'>-- That's the whole point of this function!</span>
<a name="line-1932"></a>     <span class='hs-comment'>-- Also maps coercion variables to ProofIrrelCos.</span>
<a name="line-1933"></a>
<a name="line-1934"></a><a name="liftCoSubstWithEx"></a><span class='hs-comment'>-- like liftCoSubstWith, but allows for existentially-bound types as well</span>
<a name="line-1935"></a><span class='hs-definition'>liftCoSubstWithEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span>          <span class='hs-comment'>-- desired role for output coercion</span>
<a name="line-1936"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span>       <span class='hs-comment'>-- universally quantified tyvars</span>
<a name="line-1937"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- coercions to substitute for those</span>
<a name="line-1938"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- existentially quantified tycovars</span>
<a name="line-1939"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>        <span class='hs-comment'>-- types and coercions to be bound to ex vars</span>
<a name="line-1940"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- (lifting function, converted ex args)</span>
<a name="line-1941"></a><span class='hs-definition'>liftCoSubstWithEx</span> <span class='hs-varid'>role</span> <span class='hs-varid'>univs</span> <span class='hs-varid'>omegas</span> <span class='hs-varid'>exs</span> <span class='hs-varid'>rhos</span>
<a name="line-1942"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkLiftingContext</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWithExU"</span> <span class='hs-varid'>univs</span> <span class='hs-varid'>omegas</span><span class='hs-layout'>)</span>
<a name="line-1943"></a>        <span class='hs-varid'>psi</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendLiftingContextEx</span> <span class='hs-varid'>theta</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWithExX"</span> <span class='hs-varid'>exs</span> <span class='hs-varid'>rhos</span><span class='hs-layout'>)</span>
<a name="line-1944"></a>    <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>psi</span> <span class='hs-varid'>role</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstRight</span> <span class='hs-varid'>psi</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyCoVarTys</span> <span class='hs-varid'>exs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1945"></a>
<a name="line-1946"></a><a name="liftCoSubstWith"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1947"></a><span class='hs-definition'>liftCoSubstWith</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span> <span class='hs-varid'>ty</span>
<a name="line-1948"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkLiftingContext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zipEqual</span> <span class='hs-str'>"liftCoSubstWith"</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1949"></a>
<a name="line-1950"></a><a name="liftCoSubst"></a><span class='hs-comment'>-- | @liftCoSubst role lc ty@ produces a coercion (at role @role@)</span>
<a name="line-1951"></a><span class='hs-comment'>-- that coerces between @lc_left(ty)@ and @lc_right(ty)@, where</span>
<a name="line-1952"></a><span class='hs-comment'>-- @lc_left@ is a substitution mapping type variables to the left-hand</span>
<a name="line-1953"></a><span class='hs-comment'>-- types of the mapped coercions in @lc@, and similar for @lc_right@.</span>
<a name="line-1954"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-1955"></a><span class='hs-comment'>{-# INLINE liftCoSubst #-}</span>
<a name="line-1956"></a><span class='hs-comment'>-- Inlining this function is worth 2% of allocation in T9872d,</span>
<a name="line-1957"></a><span class='hs-definition'>liftCoSubst</span> <span class='hs-varid'>r</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span>
<a name="line-1958"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1959"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>
<a name="line-1960"></a>
<a name="line-1961"></a><a name="emptyLiftingContext"></a><span class='hs-definition'>emptyLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InScopeSet</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1962"></a><span class='hs-definition'>emptyLiftingContext</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varid'>in_scope</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1963"></a>
<a name="line-1964"></a><a name="mkLiftingContext"></a><span class='hs-definition'>mkLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1965"></a><span class='hs-definition'>mkLiftingContext</span> <span class='hs-varid'>pairs</span>
<a name="line-1966"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1967"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>mkVarEnv</span> <span class='hs-varid'>pairs</span><span class='hs-layout'>)</span>
<a name="line-1968"></a>
<a name="line-1969"></a><a name="mkSubstLiftingContext"></a><span class='hs-definition'>mkSubstLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1970"></a><span class='hs-definition'>mkSubstLiftingContext</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-1971"></a>
<a name="line-1972"></a><a name="extendLiftingContext"></a><span class='hs-comment'>-- | Extend a lifting context with a new mapping.</span>
<a name="line-1973"></a><span class='hs-definition'>extendLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span>  <span class='hs-comment'>-- ^ original LC</span>
<a name="line-1974"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span>         <span class='hs-comment'>-- ^ new variable to map...</span>
<a name="line-1975"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>        <span class='hs-comment'>-- ^ ...to this lifted version</span>
<a name="line-1976"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1977"></a>    <span class='hs-comment'>-- mappings to reflexive coercions are just substitutions</span>
<a name="line-1978"></a><span class='hs-definition'>extendLiftingContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span>
<a name="line-1979"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isReflCo_maybe</span> <span class='hs-varid'>arg</span>
<a name="line-1980"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span>
<a name="line-1981"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1982"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1983"></a>
<a name="line-1984"></a><a name="extendLiftingContextAndInScope"></a><span class='hs-comment'>-- | Extend a lifting context with a new mapping, and extend the in-scope set</span>
<a name="line-1985"></a><span class='hs-definition'>extendLiftingContextAndInScope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span>  <span class='hs-comment'>-- ^ Original LC</span>
<a name="line-1986"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span>         <span class='hs-comment'>-- ^ new variable to map...</span>
<a name="line-1987"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>        <span class='hs-comment'>-- ^ to this coercion</span>
<a name="line-1988"></a>                               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1989"></a><span class='hs-definition'>extendLiftingContextAndInScope</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-1990"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendLiftingContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvInScopeSet</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-1991"></a>
<a name="line-1992"></a><a name="extendLiftingContextEx"></a><span class='hs-comment'>-- | Extend a lifting context with existential-variable bindings.</span>
<a name="line-1993"></a><span class='hs-comment'>-- See Note [extendLiftingContextEx]</span>
<a name="line-1994"></a><span class='hs-definition'>extendLiftingContextEx</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span>    <span class='hs-comment'>-- ^ original lifting context</span>
<a name="line-1995"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span><span class='hs-conid'>Type</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- ^ ex. var / value pairs</span>
<a name="line-1996"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-1997"></a><span class='hs-comment'>-- Note that this is more involved than extendLiftingContext. That function</span>
<a name="line-1998"></a><span class='hs-comment'>-- takes a coercion to extend with, so it's assumed that the caller has taken</span>
<a name="line-1999"></a><span class='hs-comment'>-- into account any of the kind-changing stuff worried about here.</span>
<a name="line-2000"></a><span class='hs-definition'>extendLiftingContextEx</span> <span class='hs-varid'>lc</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lc</span>
<a name="line-2001"></a><span class='hs-definition'>extendLiftingContextEx</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>v</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-2002"></a><span class='hs-comment'>-- This function adds bindings for *Nominal* coercions. Why? Because it</span>
<a name="line-2003"></a><span class='hs-comment'>-- works with existentially bound variables, which are considered to have</span>
<a name="line-2004"></a><span class='hs-comment'>-- nominal roles.</span>
<a name="line-2005"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v</span>
<a name="line-2006"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>lc'</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varop'>`extendTCvInScopeSet`</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2007"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span> <span class='hs-varop'>$</span>
<a name="line-2008"></a>                  <span class='hs-varid'>mkGReflRightCo</span> <span class='hs-conid'>Nominal</span>
<a name="line-2009"></a>                                 <span class='hs-varid'>ty</span>
<a name="line-2010"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2011"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>extendLiftingContextEx</span> <span class='hs-varid'>lc'</span> <span class='hs-varid'>rest</span>
<a name="line-2012"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ty</span>
<a name="line-2013"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- co      :: s1 ~r s2</span>
<a name="line-2014"></a>    <span class='hs-comment'>-- lift_s1 :: s1 ~r s1'</span>
<a name="line-2015"></a>    <span class='hs-comment'>-- lift_s2 :: s2 ~r s2'</span>
<a name="line-2016"></a>    <span class='hs-comment'>-- kco     :: (s1 ~r s2) ~N (s1' ~r s2')</span>
<a name="line-2017"></a>    <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>v</span> <span class='hs-layout'>)</span>
<a name="line-2018"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>s2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarKindsTypesRole</span> <span class='hs-varid'>v</span>
<a name="line-2019"></a>        <span class='hs-varid'>lift_s1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>r</span> <span class='hs-varid'>s1</span>
<a name="line-2020"></a>        <span class='hs-varid'>lift_s2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>r</span> <span class='hs-varid'>s2</span>
<a name="line-2021"></a>        <span class='hs-varid'>kco</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>equalityTyCon</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span>
<a name="line-2022"></a>                               <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>lift_s1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>lift_s2</span>
<a name="line-2023"></a>                               <span class='hs-layout'>,</span> <span class='hs-varid'>lift_s1</span>         <span class='hs-layout'>,</span> <span class='hs-varid'>lift_s2</span>          <span class='hs-keyglyph'>]</span>
<a name="line-2024"></a>        <span class='hs-varid'>lc'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varop'>`extendTCvInScopeSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2025"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-2026"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>mkProofIrrelCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>kco</span> <span class='hs-varid'>co</span> <span class='hs-varop'>$</span>
<a name="line-2027"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>lift_s1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>lift_s2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2028"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>extendLiftingContextEx</span> <span class='hs-varid'>lc'</span> <span class='hs-varid'>rest</span>
<a name="line-2029"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2030"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"extendLiftingContextEx"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"|-&gt;"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2031"></a>
<a name="line-2032"></a>
<a name="line-2033"></a><a name="zapLiftingContext"></a><span class='hs-comment'>-- | Erase the environments in a lifting context</span>
<a name="line-2034"></a><span class='hs-definition'>zapLiftingContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>
<a name="line-2035"></a><span class='hs-definition'>zapLiftingContext</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>zapTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarEnv</span>
<a name="line-2036"></a>
<a name="line-2037"></a><a name="substForAllCoBndrUsingLC"></a><span class='hs-comment'>-- | Like 'substForAllCoBndr', but works on a lifting context</span>
<a name="line-2038"></a><span class='hs-definition'>substForAllCoBndrUsingLC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-2039"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2040"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2041"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2042"></a><span class='hs-definition'>substForAllCoBndrUsingLC</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-2043"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span>
<a name="line-2044"></a>  <span class='hs-keyword'>where</span>
<a name="line-2045"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>co'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substForAllCoBndrUsing</span> <span class='hs-varid'>sym</span> <span class='hs-varid'>sco</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>co</span>
<a name="line-2046"></a>
<a name="line-2047"></a><a name="ty_co_subst"></a><span class='hs-comment'>-- | The \"lifting\" operation which substitutes coercions for type</span>
<a name="line-2048"></a><span class='hs-comment'>--   variables in a type to produce a coercion.</span>
<a name="line-2049"></a><span class='hs-comment'>--</span>
<a name="line-2050"></a><span class='hs-comment'>--   For the inverse operation, see 'liftCoMatch'</span>
<a name="line-2051"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2052"></a><a name="!"></a><span class='hs-definition'>ty_co_subst</span> <span class='hs-varop'>!</span><span class='hs-varid'>lc</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-2053"></a>    <span class='hs-comment'>-- !lc: making this function strict in lc allows callers to</span>
<a name="line-2054"></a>    <span class='hs-comment'>-- pass its two components separately, rather than boxing them</span>
<a name="line-2055"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>role</span> <span class='hs-varid'>ty</span>
<a name="line-2056"></a>  <span class='hs-keyword'>where</span>
<a name="line-2057"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2058"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty</span>
<a name="line-2059"></a>                           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty'</span>
<a name="line-2060"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>Phantom</span> <span class='hs-varid'>ty</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span>
<a name="line-2061"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"ty_co_subst bad roles"</span> <span class='hs-varop'>$</span>
<a name="line-2062"></a>                             <span class='hs-varid'>liftCoSubstTyVar</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tv</span>
<a name="line-2063"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2064"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConRolesX</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-2065"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2066"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2067"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>lc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>v'</span><span class='hs-layout'>,</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstVarBndr</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>v</span>
<a name="line-2068"></a>             <span class='hs-varid'>body_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc'</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>in</span>
<a name="line-2069"></a>         <span class='hs-keyword'>if</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>v'</span> <span class='hs-varop'>||</span> <span class='hs-varid'>almostDevoidCoVarOfCo</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>body_co</span>
<a name="line-2070"></a>           <span class='hs-comment'>-- Lifting a ForAllTy over a coercion variable could fail as ForAllCo</span>
<a name="line-2071"></a>           <span class='hs-comment'>-- imposes an extra restriction on where a covar can appear. See last</span>
<a name="line-2072"></a>           <span class='hs-comment'>-- wrinkle in Note [Unused coercion variable in ForAllCo].</span>
<a name="line-2073"></a>           <span class='hs-comment'>-- We specifically check for this and panic because we know that</span>
<a name="line-2074"></a>           <span class='hs-comment'>-- there's a hole in the type system here, and we'd rather panic than</span>
<a name="line-2075"></a>           <span class='hs-comment'>-- fall into it.</span>
<a name="line-2076"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>v'</span> <span class='hs-varid'>h</span> <span class='hs-varid'>body_co</span>
<a name="line-2077"></a>         <span class='hs-keyword'>else</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"ty_co_subst: covar is not almost devoid"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-2078"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>r</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>)</span>
<a name="line-2079"></a>                             <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty</span>
<a name="line-2080"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>castCoercionKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>substLeftCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2081"></a>                                                        <span class='hs-layout'>(</span><span class='hs-varid'>substRightCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2082"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkProofIrrelCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>kco</span> <span class='hs-layout'>(</span><span class='hs-varid'>substLeftCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2083"></a>                                                  <span class='hs-layout'>(</span><span class='hs-varid'>substRightCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2084"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>kco</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionType</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2085"></a>
<a name="line-2086"></a>    <span class='hs-varid'>lift_phantom</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPhantomCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2087"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstLeft</span>  <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2088"></a>                                  <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstRight</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2089"></a>
<a name="line-2090"></a><span class='hs-comment'>{-
<a name="line-2091"></a>Note [liftCoSubstTyVar]
<a name="line-2092"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2093"></a>This function can fail if a coercion in the environment is of too low a role.
<a name="line-2094"></a>
<a name="line-2095"></a>liftCoSubstTyVar is called from two places: in liftCoSubst (naturally), and
<a name="line-2096"></a>also in matchAxiom in GHC.Core.Coercion.Opt. From liftCoSubst, the so-called lifting
<a name="line-2097"></a>lemma guarantees that the roles work out. If we fail in this
<a name="line-2098"></a>case, we really should panic -- something is deeply wrong. But, in matchAxiom,
<a name="line-2099"></a>failing is fine. matchAxiom is trying to find a set of coercions
<a name="line-2100"></a>that match, but it may fail, and this is healthy behavior.
<a name="line-2101"></a>-}</span>
<a name="line-2102"></a>
<a name="line-2103"></a><a name="liftCoSubstTyVar"></a><span class='hs-comment'>-- See Note [liftCoSubstTyVar]</span>
<a name="line-2104"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Coercion</span>
<a name="line-2105"></a><span class='hs-definition'>liftCoSubstTyVar</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span> <span class='hs-varid'>v</span>
<a name="line-2106"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>co_arg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupVarEnv</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span>
<a name="line-2107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole_maybe</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co_arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>co_arg</span>
<a name="line-2108"></a>
<a name="line-2109"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2110"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkReflCo</span> <span class='hs-varid'>r</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTyVar</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-2111"></a>
<a name="line-2112"></a><span class='hs-comment'>{- Note [liftCoSubstVarBndr]
<a name="line-2113"></a>
<a name="line-2114"></a>callback:
<a name="line-2115"></a>  We want 'liftCoSubstVarBndrUsing' to be general enough to be reused in
<a name="line-2116"></a>  FamInstEnv, therefore the input arg 'fun' returns a pair with polymorphic type
<a name="line-2117"></a>  in snd.
<a name="line-2118"></a>  However in 'liftCoSubstVarBndr', we don't need the snd, so we use unit and
<a name="line-2119"></a>  ignore the fourth component of the return value.
<a name="line-2120"></a>
<a name="line-2121"></a>liftCoSubstTyVarBndrUsing:
<a name="line-2122"></a>  Given
<a name="line-2123"></a>    forall tv:k. t
<a name="line-2124"></a>  We want to get
<a name="line-2125"></a>    forall (tv:k1) (kind_co :: k1 ~ k2) body_co
<a name="line-2126"></a>
<a name="line-2127"></a>  We lift the kind k to get the kind_co
<a name="line-2128"></a>    kind_co = ty_co_subst k :: k1 ~ k2
<a name="line-2129"></a>
<a name="line-2130"></a>  Now in the LiftingContext, we add the new mapping
<a name="line-2131"></a>    tv |-&gt; (tv :: k1) ~ ((tv |&gt; kind_co) :: k2)
<a name="line-2132"></a>
<a name="line-2133"></a>liftCoSubstCoVarBndrUsing:
<a name="line-2134"></a>  Given
<a name="line-2135"></a>    forall cv:(s1 ~ s2). t
<a name="line-2136"></a>  We want to get
<a name="line-2137"></a>    forall (cv:s1'~s2') (kind_co :: (s1'~s2') ~ (t1 ~ t2)) body_co
<a name="line-2138"></a>
<a name="line-2139"></a>  We lift s1 and s2 respectively to get
<a name="line-2140"></a>    eta1 :: s1' ~ t1
<a name="line-2141"></a>    eta2 :: s2' ~ t2
<a name="line-2142"></a>  And
<a name="line-2143"></a>    kind_co = TyConAppCo Nominal (~#) eta1 eta2
<a name="line-2144"></a>
<a name="line-2145"></a>  Now in the liftingContext, we add the new mapping
<a name="line-2146"></a>    cv |-&gt; (cv :: s1' ~ s2') ~ ((sym eta1;cv;eta2) :: t1 ~ t2)
<a name="line-2147"></a>-}</span>
<a name="line-2148"></a>
<a name="line-2149"></a><a name="liftCoSubstVarBndr"></a><span class='hs-comment'>-- See Note [liftCoSubstVarBndr]</span>
<a name="line-2150"></a><span class='hs-definition'>liftCoSubstVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span>
<a name="line-2151"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2152"></a><span class='hs-definition'>liftCoSubstVarBndr</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>tv</span>
<a name="line-2153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>lc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstVarBndrUsing</span> <span class='hs-varid'>callback</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>in</span>
<a name="line-2154"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>lc'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>,</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-2155"></a>  <span class='hs-keyword'>where</span>
<a name="line-2156"></a>    <span class='hs-varid'>callback</span> <span class='hs-varid'>lc'</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty_co_subst</span> <span class='hs-varid'>lc'</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-2157"></a>
<a name="line-2158"></a><a name="liftCoSubstVarBndrUsing"></a><span class='hs-comment'>-- the callback must produce a nominal coercion</span>
<a name="line-2159"></a><span class='hs-definition'>liftCoSubstVarBndrUsing</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2160"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVar</span>
<a name="line-2161"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2162"></a><span class='hs-definition'>liftCoSubstVarBndrUsing</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>old_var</span>
<a name="line-2163"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_var</span>
<a name="line-2164"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstTyVarBndrUsing</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>old_var</span>
<a name="line-2165"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2166"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubstCoVarBndrUsing</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>old_var</span>
<a name="line-2167"></a>
<a name="line-2168"></a><a name="liftCoSubstTyVarBndrUsing"></a><span class='hs-comment'>-- Works for tyvar binder</span>
<a name="line-2169"></a><span class='hs-definition'>liftCoSubstTyVarBndrUsing</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2170"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyVar</span>
<a name="line-2171"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2172"></a><span class='hs-definition'>liftCoSubstTyVarBndrUsing</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-2173"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-2174"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varop'>`extendTCvInScope`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_cenv</span>
<a name="line-2175"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>eta</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>)</span>
<a name="line-2176"></a>  <span class='hs-keyword'>where</span>
<a name="line-2177"></a>    <span class='hs-varid'>old_kind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-2178"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>eta</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>old_kind</span>
<a name="line-2179"></a>    <span class='hs-varid'>k1</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionLKind</span> <span class='hs-varid'>eta</span>
<a name="line-2180"></a>    <span class='hs-varid'>new_var</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>
<a name="line-2181"></a>
<a name="line-2182"></a>    <span class='hs-varid'>lifted</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkGReflRightCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>eta</span>
<a name="line-2183"></a>               <span class='hs-comment'>-- :: new_var ~ new_var |&gt; eta</span>
<a name="line-2184"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>lifted</span>
<a name="line-2185"></a>
<a name="line-2186"></a><a name="liftCoSubstCoVarBndrUsing"></a><span class='hs-comment'>-- Works for covar binder</span>
<a name="line-2187"></a><span class='hs-definition'>liftCoSubstCoVarBndrUsing</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2188"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoVar</span>
<a name="line-2189"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LiftingContext</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>CoercionN</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2190"></a><span class='hs-definition'>liftCoSubstCoVarBndrUsing</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>old_var</span>
<a name="line-2191"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>old_var</span> <span class='hs-layout'>)</span>
<a name="line-2192"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>LC</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span> <span class='hs-varop'>`extendTCvInScope`</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>)</span> <span class='hs-varid'>new_cenv</span>
<a name="line-2193"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>new_var</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span> <span class='hs-layout'>)</span>
<a name="line-2194"></a>  <span class='hs-keyword'>where</span>
<a name="line-2195"></a>    <span class='hs-varid'>old_kind</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarKind</span> <span class='hs-varid'>old_var</span>
<a name="line-2196"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>eta</span><span class='hs-layout'>,</span> <span class='hs-varid'>stuff</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>old_kind</span>
<a name="line-2197"></a>    <span class='hs-varid'>k1</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionLKind</span> <span class='hs-varid'>eta</span>
<a name="line-2198"></a>    <span class='hs-varid'>new_var</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqAway</span> <span class='hs-layout'>(</span><span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>setVarType</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>
<a name="line-2199"></a>
<a name="line-2200"></a>    <span class='hs-comment'>-- old_var :: s1  ~r s2</span>
<a name="line-2201"></a>    <span class='hs-comment'>-- eta     :: (s1' ~r s2') ~N (t1 ~r t2)</span>
<a name="line-2202"></a>    <span class='hs-comment'>-- eta1    :: s1' ~r t1</span>
<a name="line-2203"></a>    <span class='hs-comment'>-- eta2    :: s2' ~r t2</span>
<a name="line-2204"></a>    <span class='hs-comment'>-- co1     :: s1' ~r s2'</span>
<a name="line-2205"></a>    <span class='hs-comment'>-- co2     :: t1  ~r t2</span>
<a name="line-2206"></a>    <span class='hs-comment'>-- kind_co :: (s1' ~r s2') ~N (t1 ~r t2)</span>
<a name="line-2207"></a>    <span class='hs-comment'>-- lifted  :: co1 ~N co2</span>
<a name="line-2208"></a>
<a name="line-2209"></a>    <span class='hs-varid'>role</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>old_var</span>
<a name="line-2210"></a>    <span class='hs-varid'>eta'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>role</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>eta</span>
<a name="line-2211"></a>    <span class='hs-varid'>eta1</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>role</span> <span class='hs-num'>2</span> <span class='hs-varid'>eta'</span>
<a name="line-2212"></a>    <span class='hs-varid'>eta2</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>role</span> <span class='hs-num'>3</span> <span class='hs-varid'>eta'</span>
<a name="line-2213"></a>
<a name="line-2214"></a>    <span class='hs-varid'>co1</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>new_var</span>
<a name="line-2215"></a>    <span class='hs-varid'>co2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>eta1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-varid'>eta2</span>
<a name="line-2216"></a>    <span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>equalityTyCon</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span>
<a name="line-2217"></a>                           <span class='hs-keyglyph'>[</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkKindCo</span> <span class='hs-varid'>co2</span>
<a name="line-2218"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>co1</span>         <span class='hs-layout'>,</span> <span class='hs-varid'>co2</span>          <span class='hs-keyglyph'>]</span>
<a name="line-2219"></a>    <span class='hs-varid'>lifted</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkProofIrrelCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-2220"></a>
<a name="line-2221"></a>    <span class='hs-varid'>new_cenv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendVarEnv</span> <span class='hs-varid'>cenv</span> <span class='hs-varid'>old_var</span> <span class='hs-varid'>lifted</span>
<a name="line-2222"></a>
<a name="line-2223"></a><a name="isMappedByLC"></a><span class='hs-comment'>-- | Is a var in the domain of a lifting context?</span>
<a name="line-2224"></a><span class='hs-definition'>isMappedByLC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-2225"></a><span class='hs-definition'>isMappedByLC</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elemVarEnv`</span> <span class='hs-varid'>env</span>
<a name="line-2226"></a>
<a name="line-2227"></a><a name="substLeftCo"></a><span class='hs-comment'>-- If [a |-&gt; g] is in the substitution and g :: t1 ~ t2, substitute a for t1</span>
<a name="line-2228"></a><span class='hs-comment'>-- If [a |-&gt; (g1, g2)] is in the substitution, substitute a for g1</span>
<a name="line-2229"></a><span class='hs-definition'>substLeftCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2230"></a><span class='hs-definition'>substLeftCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span>
<a name="line-2231"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstLeft</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-2232"></a>
<a name="line-2233"></a><a name="substRightCo"></a><span class='hs-comment'>-- Ditto, but for t2 and g2</span>
<a name="line-2234"></a><span class='hs-definition'>substRightCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Coercion</span>
<a name="line-2235"></a><span class='hs-definition'>substRightCo</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>co</span>
<a name="line-2236"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>lcSubstRight</span> <span class='hs-varid'>lc</span><span class='hs-layout'>)</span> <span class='hs-varid'>co</span>
<a name="line-2237"></a>
<a name="line-2238"></a><a name="swapLiftCoEnv"></a><span class='hs-comment'>-- | Apply "sym" to all coercions in a 'LiftCoEnv'</span>
<a name="line-2239"></a><span class='hs-definition'>swapLiftCoEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span>
<a name="line-2240"></a><span class='hs-definition'>swapLiftCoEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapVarEnv</span> <span class='hs-varid'>mkSymCo</span>
<a name="line-2241"></a>
<a name="line-2242"></a><a name="lcSubstLeft"></a><span class='hs-definition'>lcSubstLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2243"></a><span class='hs-definition'>lcSubstLeft</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubstLeft</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span>
<a name="line-2244"></a>
<a name="line-2245"></a><a name="lcSubstRight"></a><span class='hs-definition'>lcSubstRight</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2246"></a><span class='hs-definition'>lcSubstRight</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubstRight</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span>
<a name="line-2247"></a>
<a name="line-2248"></a><a name="liftEnvSubstLeft"></a><span class='hs-definition'>liftEnvSubstLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2249"></a><span class='hs-definition'>liftEnvSubstLeft</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubst</span> <span class='hs-varid'>pFst</span>
<a name="line-2250"></a>
<a name="line-2251"></a><a name="liftEnvSubstRight"></a><span class='hs-definition'>liftEnvSubstRight</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2252"></a><span class='hs-definition'>liftEnvSubstRight</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftEnvSubst</span> <span class='hs-varid'>pSnd</span>
<a name="line-2253"></a>
<a name="line-2254"></a><a name="liftEnvSubst"></a><span class='hs-definition'>liftEnvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>Pair</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftCoEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2255"></a><span class='hs-definition'>liftEnvSubst</span> <span class='hs-varid'>selector</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>lc_env</span>
<a name="line-2256"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>composeTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span> <span class='hs-varid'>emptyInScopeSet</span> <span class='hs-varid'>tenv</span> <span class='hs-varid'>cenv</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst</span>
<a name="line-2257"></a>  <span class='hs-keyword'>where</span>
<a name="line-2258"></a>    <span class='hs-varid'>pairs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nonDetUFMToList</span> <span class='hs-varid'>lc_env</span>
<a name="line-2259"></a>                       <span class='hs-comment'>-- It's OK to use nonDetUFMToList here because we</span>
<a name="line-2260"></a>                       <span class='hs-comment'>-- immediately forget the ordering by creating</span>
<a name="line-2261"></a>                       <span class='hs-comment'>-- a VarEnv</span>
<a name="line-2262"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tpairs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cpairs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionWith</span> <span class='hs-varid'>ty_or_co</span> <span class='hs-varid'>pairs</span>
<a name="line-2263"></a>    <span class='hs-varid'>tenv</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv_Directly</span> <span class='hs-varid'>tpairs</span>
<a name="line-2264"></a>    <span class='hs-varid'>cenv</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVarEnv_Directly</span> <span class='hs-varid'>cpairs</span>
<a name="line-2265"></a>
<a name="line-2266"></a>    <span class='hs-varid'>ty_or_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Either</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Type</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span>
<a name="line-2267"></a>    <span class='hs-varid'>ty_or_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2268"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>equality_co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isCoercionTy_maybe</span> <span class='hs-varid'>equality_ty</span>
<a name="line-2269"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>equality_co</span><span class='hs-layout'>)</span>
<a name="line-2270"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2271"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>u</span><span class='hs-layout'>,</span> <span class='hs-varid'>equality_ty</span><span class='hs-layout'>)</span>
<a name="line-2272"></a>      <span class='hs-keyword'>where</span>
<a name="line-2273"></a>        <span class='hs-varid'>equality_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>selector</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2274"></a>
<a name="line-2275"></a><a name="lcTCvSubst"></a><span class='hs-comment'>-- | Extract the underlying substitution from the LiftingContext</span>
<a name="line-2276"></a><span class='hs-definition'>lcTCvSubst</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-2277"></a><span class='hs-definition'>lcTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>subst</span>
<a name="line-2278"></a>
<a name="line-2279"></a><a name="lcInScopeSet"></a><span class='hs-comment'>-- | Get the 'InScopeSet' from a 'LiftingContext'</span>
<a name="line-2280"></a><span class='hs-definition'>lcInScopeSet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LiftingContext</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InScopeSet</span>
<a name="line-2281"></a><span class='hs-definition'>lcInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-conid'>LC</span> <span class='hs-varid'>subst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getTCvInScope</span> <span class='hs-varid'>subst</span>
<a name="line-2282"></a>
<a name="line-2283"></a><span class='hs-comment'>{-
<a name="line-2284"></a>%************************************************************************
<a name="line-2285"></a>%*                                                                      *
<a name="line-2286"></a>            Sequencing on coercions
<a name="line-2287"></a>%*                                                                      *
<a name="line-2288"></a>%************************************************************************
<a name="line-2289"></a>-}</span>
<a name="line-2290"></a>
<a name="line-2291"></a><a name="seqMCo"></a><span class='hs-definition'>seqMCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MCoercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2292"></a><span class='hs-definition'>seqMCo</span> <span class='hs-conid'>MRefl</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-2293"></a><span class='hs-definition'>seqMCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2294"></a>
<a name="line-2295"></a><a name="seqCo"></a><span class='hs-definition'>seqCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2296"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span>
<a name="line-2297"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>mco</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqMCo</span> <span class='hs-varid'>mco</span>
<a name="line-2298"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-2299"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-2300"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>k</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqType</span> <span class='hs-layout'>(</span><span class='hs-varid'>varType</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>k</span>
<a name="line-2301"></a>                                                       <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2302"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>w</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-2303"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cv</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-2304"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-2305"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>con</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>con</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>ind</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-2306"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-varid'>p</span> <span class='hs-varid'>r</span> <span class='hs-varid'>t1</span> <span class='hs-varid'>t2</span><span class='hs-layout'>)</span>
<a name="line-2307"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqProv</span> <span class='hs-varid'>p</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqType</span> <span class='hs-varid'>t2</span>
<a name="line-2308"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2309"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co1</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co2</span>
<a name="line-2310"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>n</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2311"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lr</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2312"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>arg</span>
<a name="line-2313"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2314"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2315"></a><span class='hs-definition'>seqCo</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>cs</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cs</span>
<a name="line-2316"></a>
<a name="line-2317"></a><a name="seqProv"></a><span class='hs-definition'>seqProv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UnivCoProvenance</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2318"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PhantomProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2319"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>ProofIrrelProv</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span>
<a name="line-2320"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>PluginProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-2321"></a><span class='hs-definition'>seqProv</span> <span class='hs-layout'>(</span><span class='hs-conid'>CorePrepProv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-2322"></a>
<a name="line-2323"></a><a name="seqCos"></a><span class='hs-definition'>seqCos</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-2324"></a><span class='hs-definition'>seqCos</span> <span class='hs-conid'>[]</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>()</span>
<a name="line-2325"></a><span class='hs-definition'>seqCos</span> <span class='hs-layout'>(</span><span class='hs-varid'>co</span><span class='hs-conop'>:</span><span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>seqCo</span> <span class='hs-varid'>co</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>seqCos</span> <span class='hs-varid'>cos</span>
<a name="line-2326"></a>
<a name="line-2327"></a><span class='hs-comment'>{-
<a name="line-2328"></a>%************************************************************************
<a name="line-2329"></a>%*                                                                      *
<a name="line-2330"></a>             The kind of a type, and of a coercion
<a name="line-2331"></a>%*                                                                      *
<a name="line-2332"></a>%************************************************************************
<a name="line-2333"></a>-}</span>
<a name="line-2334"></a>
<a name="line-2335"></a><a name="coercionKinds"></a><span class='hs-comment'>-- | Apply 'coercionKind' to multiple 'Coercion's</span>
<a name="line-2336"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>
<a name="line-2337"></a><span class='hs-definition'>coercionKinds</span> <span class='hs-varid'>tys</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sequenceA</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>tys</span>
<a name="line-2338"></a>
<a name="line-2339"></a><a name="coercionKindRole"></a><span class='hs-comment'>-- | Get a coercion's kind and role.</span>
<a name="line-2340"></a><span class='hs-definition'>coercionKindRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Role</span><span class='hs-layout'>)</span>
<a name="line-2341"></a><span class='hs-definition'>coercionKindRole</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2342"></a>
<a name="line-2343"></a><a name="coercionType"></a><span class='hs-definition'>coercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2344"></a><span class='hs-definition'>coercionType</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>coercionKindRole</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>of</span>
<a name="line-2345"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>Pair</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>,</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkCoercionType</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2346"></a>
<a name="line-2347"></a><span class='hs-comment'>------------------</span>
<a name="line-2348"></a><span class='hs-comment'>-- | If it is the case that</span>
<a name="line-2349"></a><span class='hs-comment'>--</span>
<a name="line-2350"></a><span class='hs-comment'>-- &gt; c :: (t1 ~ t2)</span>
<a name="line-2351"></a><span class='hs-comment'>--</span>
<a name="line-2352"></a><span class='hs-comment'>-- i.e. the kind of @c@ relates @t1@ and @t2@, then @coercionKind c = Pair t1 t2@.</span>
<a name="line-2353"></a>
<a name="line-2354"></a><a name="coercionKind"></a><span class='hs-definition'>coercionKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Pair</span> <span class='hs-conid'>Type</span>
<a name="line-2355"></a><span class='hs-definition'>coercionKind</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pair</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionLKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRKind</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2356"></a>
<a name="line-2357"></a><a name="coercionLKind"></a><span class='hs-definition'>coercionLKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2358"></a><span class='hs-definition'>coercionLKind</span> <span class='hs-varid'>co</span>
<a name="line-2359"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2360"></a>  <span class='hs-keyword'>where</span>
<a name="line-2361"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2362"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2363"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2364"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2365"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyCoInvForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span>
<a name="line-2366"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunctionType</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2367"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarLType</span> <span class='hs-varid'>cv</span>
<a name="line-2368"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarLType</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-2369"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty1</span>
<a name="line-2370"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRKind</span> <span class='hs-varid'>co</span>
<a name="line-2371"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span>
<a name="line-2372"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2373"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>aco</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>aco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-2374"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2375"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2376"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_nth</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2377"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_ax_inst</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2378"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pFst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"coercionKind"</span> <span class='hs-varop'>$</span>
<a name="line-2379"></a>                                  <span class='hs-varid'>coaxrProves</span> <span class='hs-varid'>ax</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>cos</span>
<a name="line-2380"></a>
<a name="line-2381"></a>    <span class='hs-varid'>go_ax_inst</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>tys</span>
<a name="line-2382"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvs</span>
<a name="line-2383"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>cab_lhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span>
<a name="line-2384"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys1</span><span class='hs-layout'>,</span> <span class='hs-varid'>cotys1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2385"></a>            <span class='hs-varid'>cos1</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>stripCoercionTy</span> <span class='hs-varid'>cotys1</span>
<a name="line-2386"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-2387"></a>                  <span class='hs-comment'>-- Invariant of AxiomInstCo: cos should</span>
<a name="line-2388"></a>                  <span class='hs-comment'>-- exactly saturate the axiom branch</span>
<a name="line-2389"></a>        <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys1</span>       <span class='hs-varop'>$</span>
<a name="line-2390"></a>        <span class='hs-varid'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos1</span> <span class='hs-varop'>$</span>
<a name="line-2391"></a>        <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>coAxiomTyCon</span> <span class='hs-varid'>ax</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs</span>
<a name="line-2392"></a>
<a name="line-2393"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2394"></a>    <span class='hs-comment'>-- Collect up all the arguments and apply all at once</span>
<a name="line-2395"></a>    <span class='hs-comment'>-- See Note [Nested InstCos]</span>
<a name="line-2396"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2397"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span>              <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-2398"></a>
<a name="line-2399"></a><a name="go_nth"></a><span class='hs-definition'>go_nth</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2400"></a><span class='hs-definition'>go_nth</span> <span class='hs-varid'>d</span> <span class='hs-varid'>ty</span>
<a name="line-2401"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyConAppArgs_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-2402"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthExceeds`</span> <span class='hs-varid'>d</span> <span class='hs-layout'>)</span>
<a name="line-2403"></a>    <span class='hs-varid'>args</span> <span class='hs-varop'>`getNth`</span> <span class='hs-varid'>d</span>
<a name="line-2404"></a>
<a name="line-2405"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>d</span> <span class='hs-varop'>==</span> <span class='hs-num'>0</span>
<a name="line-2406"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitForAllTyCoVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-2407"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span>
<a name="line-2408"></a>
<a name="line-2409"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2410"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"coercionLKind:nth"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>d</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2411"></a>
<a name="line-2412"></a><a name="coercionRKind"></a><span class='hs-definition'>coercionRKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2413"></a><span class='hs-definition'>coercionRKind</span> <span class='hs-varid'>co</span>
<a name="line-2414"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2415"></a>  <span class='hs-keyword'>where</span>
<a name="line-2416"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2417"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-conid'>MRefl</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span>
<a name="line-2418"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>MCo</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCastTy</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>co1</span>
<a name="line-2419"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2420"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2421"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRType</span> <span class='hs-varid'>cv</span>
<a name="line-2422"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRType</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-2423"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunctionType</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2424"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty2</span>
<a name="line-2425"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionLKind</span> <span class='hs-varid'>co</span>
<a name="line-2426"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co2</span>
<a name="line-2427"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-varid'>lr</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pickLR</span> <span class='hs-varid'>lr</span> <span class='hs-layout'>(</span><span class='hs-varid'>splitAppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2428"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>aco</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>aco</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-keyglyph'>]</span>
<a name="line-2429"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2430"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2431"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>d</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_nth</span> <span class='hs-varid'>d</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2432"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_ax_inst</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>
<a name="line-2433"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>cos</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pSnd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>expectJust</span> <span class='hs-str'>"coercionKind"</span> <span class='hs-varop'>$</span>
<a name="line-2434"></a>                                  <span class='hs-varid'>coaxrProves</span> <span class='hs-varid'>ax</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>cos</span>
<a name="line-2435"></a>
<a name="line-2436"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- works for both tyvar and covar</span>
<a name="line-2437"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>k_co</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyCoInvForAllTy</span> <span class='hs-varid'>tv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span>
<a name="line-2438"></a>         <span class='hs-comment'>-- kind_co always has kind @Type@, thus @isGReflCo@</span>
<a name="line-2439"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_forall</span> <span class='hs-varid'>empty_subst</span> <span class='hs-varid'>co</span>
<a name="line-2440"></a>       <span class='hs-keyword'>where</span>
<a name="line-2441"></a>         <span class='hs-varid'>empty_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2442"></a>
<a name="line-2443"></a>    <span class='hs-varid'>go_ax_inst</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span> <span class='hs-varid'>tys</span>
<a name="line-2444"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CoAxBranch</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cab_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cab_cvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cvs</span>
<a name="line-2445"></a>                   <span class='hs-layout'>,</span> <span class='hs-varid'>cab_rhs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rhs</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coAxiomNthBranch</span> <span class='hs-varid'>ax</span> <span class='hs-varid'>ind</span>
<a name="line-2446"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys2</span><span class='hs-layout'>,</span> <span class='hs-varid'>cotys2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAtList</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys</span>
<a name="line-2447"></a>            <span class='hs-varid'>cos2</span>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>stripCoercionTy</span> <span class='hs-varid'>cotys2</span>
<a name="line-2448"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tys</span> <span class='hs-varop'>`equalLength`</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>cvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-2449"></a>                  <span class='hs-comment'>-- Invariant of AxiomInstCo: cos should</span>
<a name="line-2450"></a>                  <span class='hs-comment'>-- exactly saturate the axiom branch</span>
<a name="line-2451"></a>        <span class='hs-varid'>substTyWith</span> <span class='hs-varid'>tvs</span> <span class='hs-varid'>tys2</span> <span class='hs-varop'>$</span>
<a name="line-2452"></a>        <span class='hs-varid'>substTyWithCoVars</span> <span class='hs-varid'>cvs</span> <span class='hs-varid'>cos2</span> <span class='hs-varid'>rhs</span>
<a name="line-2453"></a>
<a name="line-2454"></a>    <span class='hs-varid'>go_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2455"></a>    <span class='hs-comment'>-- Collect up all the arguments and apply all at once</span>
<a name="line-2456"></a>    <span class='hs-comment'>-- See Note [Nested InstCos]</span>
<a name="line-2457"></a>    <span class='hs-varid'>go_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-2458"></a>    <span class='hs-varid'>go_app</span> <span class='hs-varid'>co</span>              <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>piResultTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-2459"></a>
<a name="line-2460"></a>    <span class='hs-varid'>go_forall</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2461"></a>      <span class='hs-comment'>-- See Note [Nested ForAllCos]</span>
<a name="line-2462"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-2463"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInfForAllTy</span> <span class='hs-varid'>tv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_forall</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2464"></a>      <span class='hs-keyword'>where</span>
<a name="line-2465"></a>        <span class='hs-varid'>k2</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRKind</span> <span class='hs-varid'>k_co</span>
<a name="line-2466"></a>        <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setTyVarKind</span> <span class='hs-varid'>tv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-2467"></a>        <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isGReflCo</span> <span class='hs-varid'>k_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv1</span>
<a name="line-2468"></a>                 <span class='hs-comment'>-- kind_co always has kind @Type@, thus @isGReflCo@</span>
<a name="line-2469"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>$</span>
<a name="line-2470"></a>                                  <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>k_co</span>
<a name="line-2471"></a>
<a name="line-2472"></a>    <span class='hs-varid'>go_forall</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-varid'>cv1</span> <span class='hs-varid'>k_co</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2473"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv1</span>
<a name="line-2474"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyCoInvForAllTy</span> <span class='hs-varid'>cv2</span> <span class='hs-layout'>(</span><span class='hs-varid'>go_forall</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2475"></a>      <span class='hs-keyword'>where</span>
<a name="line-2476"></a>        <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRKind</span> <span class='hs-varid'>k_co</span>
<a name="line-2477"></a>        <span class='hs-varid'>r</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv1</span>
<a name="line-2478"></a>        <span class='hs-varid'>eta1</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>k_co</span><span class='hs-layout'>)</span>
<a name="line-2479"></a>        <span class='hs-varid'>eta2</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-num'>3</span> <span class='hs-layout'>(</span><span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>k_co</span><span class='hs-layout'>)</span>
<a name="line-2480"></a>
<a name="line-2481"></a>        <span class='hs-comment'>-- k_co :: (t1 ~r t2) ~N (s1 ~r s2)</span>
<a name="line-2482"></a>        <span class='hs-comment'>-- k1    = t1 ~r t2</span>
<a name="line-2483"></a>        <span class='hs-comment'>-- k2    = s1 ~r s2</span>
<a name="line-2484"></a>        <span class='hs-comment'>-- cv1  :: t1 ~r t2</span>
<a name="line-2485"></a>        <span class='hs-comment'>-- cv2  :: s1 ~r s2</span>
<a name="line-2486"></a>        <span class='hs-comment'>-- eta1 :: t1 ~r s1</span>
<a name="line-2487"></a>        <span class='hs-comment'>-- eta2 :: t2 ~r s2</span>
<a name="line-2488"></a>        <span class='hs-comment'>-- n_subst  = (eta1 ; cv2 ; sym eta2) :: t1 ~r t2</span>
<a name="line-2489"></a>
<a name="line-2490"></a>        <span class='hs-varid'>cv2</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setVarType</span> <span class='hs-varid'>cv1</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>k2</span><span class='hs-layout'>)</span>
<a name="line-2491"></a>        <span class='hs-varid'>n_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eta1</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>cv2</span><span class='hs-layout'>)</span> <span class='hs-varop'>`mkTransCo`</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>eta2</span><span class='hs-layout'>)</span>
<a name="line-2492"></a>        <span class='hs-varid'>subst'</span>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isReflCo</span> <span class='hs-varid'>k_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv1</span>
<a name="line-2493"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendTCvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv2</span><span class='hs-layout'>)</span>
<a name="line-2494"></a>                                                <span class='hs-varid'>cv1</span> <span class='hs-varid'>n_subst</span>
<a name="line-2495"></a>
<a name="line-2496"></a>    <span class='hs-varid'>go_forall</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>other_co</span>
<a name="line-2497"></a>      <span class='hs-comment'>-- when other_co is not a ForAllCo</span>
<a name="line-2498"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>other_co</span><span class='hs-layout'>)</span>
<a name="line-2499"></a>
<a name="line-2500"></a><span class='hs-comment'>{-
<a name="line-2501"></a>
<a name="line-2502"></a>Note [Nested ForAllCos]
<a name="line-2503"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2504"></a>
<a name="line-2505"></a>Suppose we need `coercionKind (ForAllCo a1 (ForAllCo a2 ... (ForAllCo an
<a name="line-2506"></a>co)...) )`.   We do not want to perform `n` single-type-variable
<a name="line-2507"></a>substitutions over the kind of `co`; rather we want to do one substitution
<a name="line-2508"></a>which substitutes for all of `a1`, `a2` ... simultaneously.  If we do one
<a name="line-2509"></a>at a time we get the performance hole reported in #11735.
<a name="line-2510"></a>
<a name="line-2511"></a>Solution: gather up the type variables for nested `ForAllCos`, and
<a name="line-2512"></a>substitute for them all at once.  Remarkably, for #11735 this single
<a name="line-2513"></a>change reduces /total/ compile time by a factor of more than ten.
<a name="line-2514"></a>
<a name="line-2515"></a>-}</span>
<a name="line-2516"></a>
<a name="line-2517"></a><a name="coercionRole"></a><span class='hs-comment'>-- | Retrieve the role from a coercion.</span>
<a name="line-2518"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Role</span>
<a name="line-2519"></a><span class='hs-definition'>coercionRole</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span>
<a name="line-2520"></a>  <span class='hs-keyword'>where</span>
<a name="line-2521"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>Refl</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-2522"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>GRefl</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-2523"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConAppCo</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-2524"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppCo</span> <span class='hs-varid'>co1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span>
<a name="line-2525"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllCo</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2526"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunCo</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-2527"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoVarCo</span> <span class='hs-varid'>cv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv</span>
<a name="line-2528"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>HoleCo</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-layout'>(</span><span class='hs-varid'>coHoleCoVar</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-2529"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomInstCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coAxiomRole</span> <span class='hs-varid'>ax</span>
<a name="line-2530"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnivCo</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>r</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-2531"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SymCo</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2532"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TransCo</span> <span class='hs-varid'>co1</span> <span class='hs-sel'>_co2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co1</span>
<a name="line-2533"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>NthCo</span> <span class='hs-varid'>r</span> <span class='hs-sel'>_d</span> <span class='hs-sel'>_co</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>r</span>
<a name="line-2534"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>LRCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-2535"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstCo</span> <span class='hs-varid'>co</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>co</span>
<a name="line-2536"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindCo</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nominal</span>
<a name="line-2537"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>SubCo</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Representational</span>
<a name="line-2538"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AxiomRuleCo</span> <span class='hs-varid'>ax</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coaxrRole</span> <span class='hs-varid'>ax</span>
<a name="line-2539"></a>
<a name="line-2540"></a><span class='hs-comment'>{-
<a name="line-2541"></a>Note [Nested InstCos]
<a name="line-2542"></a>~~~~~~~~~~~~~~~~~~~~~
<a name="line-2543"></a>In #5631 we found that 70% of the entire compilation time was
<a name="line-2544"></a>being spent in coercionKind!  The reason was that we had
<a name="line-2545"></a>   (g @ ty1 @ ty2 .. @ ty100)    -- The "@s" are InstCos
<a name="line-2546"></a>where
<a name="line-2547"></a>   g :: forall a1 a2 .. a100. phi
<a name="line-2548"></a>If we deal with the InstCos one at a time, we'll do this:
<a name="line-2549"></a>   1.  Find the kind of (g @ ty1 .. @ ty99) : forall a100. phi'
<a name="line-2550"></a>   2.  Substitute phi'[ ty100/a100 ], a single tyvar-&gt;type subst
<a name="line-2551"></a>But this is a *quadratic* algorithm, and the blew up #5631.
<a name="line-2552"></a>So it's very important to do the substitution simultaneously;
<a name="line-2553"></a>cf Type.piResultTys (which in fact we call here).
<a name="line-2554"></a>
<a name="line-2555"></a>-}</span>
<a name="line-2556"></a>
<a name="line-2557"></a><a name="mkCoercionType"></a><span class='hs-comment'>-- | Makes a coercion type from two types: the types whose equality</span>
<a name="line-2558"></a><span class='hs-comment'>-- is proven by the relevant 'Coercion'</span>
<a name="line-2559"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2560"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span>
<a name="line-2561"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReprPrimEqPred</span>
<a name="line-2562"></a><span class='hs-definition'>mkCoercionType</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2563"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ki1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-2564"></a>      <span class='hs-varid'>ki2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-2565"></a>  <span class='hs-keyword'>in</span>
<a name="line-2566"></a>  <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>eqPhantPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ki1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-2567"></a>
<a name="line-2568"></a><a name="mkHeteroCoercionType"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2569"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHeteroPrimEqPred</span>
<a name="line-2570"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHeteroReprPrimEqPred</span>
<a name="line-2571"></a><span class='hs-definition'>mkHeteroCoercionType</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkHeteroCoercionType"</span>
<a name="line-2572"></a>
<a name="line-2573"></a><a name="mkPrimEqPred"></a><span class='hs-comment'>-- | Creates a primitive type equality predicate.</span>
<a name="line-2574"></a><span class='hs-comment'>-- Invariant: the types are not Coercions</span>
<a name="line-2575"></a><span class='hs-definition'>mkPrimEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2576"></a><span class='hs-definition'>mkPrimEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2577"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>eqPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-2578"></a>  <span class='hs-keyword'>where</span>
<a name="line-2579"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-2580"></a>    <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-2581"></a>
<a name="line-2582"></a><a name="mkPrimEqPredRole"></a><span class='hs-comment'>-- | Makes a lifted equality predicate at the given role</span>
<a name="line-2583"></a><span class='hs-definition'>mkPrimEqPredRole</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Role</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredType</span>
<a name="line-2584"></a><span class='hs-definition'>mkPrimEqPredRole</span> <span class='hs-conid'>Nominal</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPrimEqPred</span>
<a name="line-2585"></a><span class='hs-definition'>mkPrimEqPredRole</span> <span class='hs-conid'>Representational</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkReprPrimEqPred</span>
<a name="line-2586"></a><span class='hs-definition'>mkPrimEqPredRole</span> <span class='hs-conid'>Phantom</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkPrimEqPredRole phantom"</span>
<a name="line-2587"></a>
<a name="line-2588"></a><a name="mkHeteroPrimEqPred"></a><span class='hs-comment'>-- | Creates a primitive type equality predicate with explicit kinds</span>
<a name="line-2589"></a><span class='hs-definition'>mkHeteroPrimEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2590"></a><span class='hs-definition'>mkHeteroPrimEqPred</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>eqPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-2591"></a>
<a name="line-2592"></a><a name="mkHeteroReprPrimEqPred"></a><span class='hs-comment'>-- | Creates a primitive representational type equality predicate</span>
<a name="line-2593"></a><span class='hs-comment'>-- with explicit kinds</span>
<a name="line-2594"></a><span class='hs-definition'>mkHeteroReprPrimEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2595"></a><span class='hs-definition'>mkHeteroReprPrimEqPred</span> <span class='hs-varid'>k1</span> <span class='hs-varid'>k2</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2596"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>eqReprPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-2597"></a>
<a name="line-2598"></a><a name="mkReprPrimEqPred"></a><span class='hs-definition'>mkReprPrimEqPred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span>
<a name="line-2599"></a><span class='hs-definition'>mkReprPrimEqPred</span> <span class='hs-varid'>ty1</span>  <span class='hs-varid'>ty2</span>
<a name="line-2600"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>eqReprPrimTyCon</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k1</span><span class='hs-layout'>,</span> <span class='hs-varid'>k2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span>
<a name="line-2601"></a>  <span class='hs-keyword'>where</span>
<a name="line-2602"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-2603"></a>    <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-2604"></a>
<a name="line-2605"></a><a name="buildCoercion"></a><span class='hs-comment'>-- | Assuming that two types are the same, ignoring coercions, find</span>
<a name="line-2606"></a><span class='hs-comment'>-- a nominal coercion between the types. This is useful when optimizing</span>
<a name="line-2607"></a><span class='hs-comment'>-- transitivity over coercion applications, where splitting two</span>
<a name="line-2608"></a><span class='hs-comment'>-- AppCos might yield different kinds. See Note [EtaAppCo] in</span>
<a name="line-2609"></a><span class='hs-comment'>-- "GHC.Core.Coercion.Opt".</span>
<a name="line-2610"></a><span class='hs-definition'>buildCoercion</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoercionN</span>
<a name="line-2611"></a><span class='hs-definition'>buildCoercion</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>orig_ty1</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-2612"></a>  <span class='hs-keyword'>where</span>
<a name="line-2613"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2</span>
<a name="line-2614"></a>               <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>coreView</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span>
<a name="line-2615"></a>
<a name="line-2616"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-2617"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2618"></a>            <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co'</span>
<a name="line-2619"></a>        <span class='hs-keyword'>in</span>  <span class='hs-varid'>mkCoherenceLeftCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>co</span> <span class='hs-varid'>co'</span>
<a name="line-2620"></a>
<a name="line-2621"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>CastTy</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-2622"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2623"></a>            <span class='hs-varid'>r</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionRole</span> <span class='hs-varid'>co'</span>
<a name="line-2624"></a>        <span class='hs-keyword'>in</span>  <span class='hs-varid'>mkCoherenceRightCo</span> <span class='hs-varid'>r</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>co</span> <span class='hs-varid'>co'</span>
<a name="line-2625"></a>
<a name="line-2626"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-sel'>_tyvarty</span>
<a name="line-2627"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-sel'>_tyvarty</span> <span class='hs-keyword'>of</span>
<a name="line-2628"></a>                  <span class='hs-layout'>{</span> <span class='hs-conid'>TyVarTy</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tv2</span>
<a name="line-2629"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>      <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-2630"></a>        <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty1</span>
<a name="line-2631"></a>
<a name="line-2632"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res1</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2633"></a>       <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ft_mult</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>w2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_arg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>,</span> <span class='hs-varid'>ft_res</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res2</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2634"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFunCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>w1</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>arg1</span> <span class='hs-varid'>arg2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>res1</span> <span class='hs-varid'>res2</span><span class='hs-layout'>)</span>
<a name="line-2635"></a>
<a name="line-2636"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc1</span> <span class='hs-varid'>args1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc2</span> <span class='hs-varid'>args2</span><span class='hs-layout'>)</span>
<a name="line-2637"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> <span class='hs-layout'>)</span>
<a name="line-2638"></a>        <span class='hs-varid'>mkTyConAppCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>tc1</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipWith</span> <span class='hs-varid'>go</span> <span class='hs-varid'>args1</span> <span class='hs-varid'>args2</span><span class='hs-layout'>)</span>
<a name="line-2639"></a>
<a name="line-2640"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-2641"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty2a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-2642"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span>
<a name="line-2643"></a>
<a name="line-2644"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty2a</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span>
<a name="line-2645"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty1a</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty1b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>repSplitAppTy_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-2646"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAppCo</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1a</span> <span class='hs-varid'>ty2a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1b</span> <span class='hs-varid'>ty2b</span><span class='hs-layout'>)</span>
<a name="line-2647"></a>
<a name="line-2648"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv1</span> <span class='hs-sel'>_flag1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv2</span> <span class='hs-sel'>_flag2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2649"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv1</span>
<a name="line-2650"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTyVar</span> <span class='hs-varid'>tv2</span> <span class='hs-layout'>)</span>
<a name="line-2651"></a>        <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>kind_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-2652"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>kind_co</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv2</span><span class='hs-layout'>)</span>
<a name="line-2653"></a>            <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>kind_co</span>
<a name="line-2654"></a>            <span class='hs-varid'>ty2'</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyWithInScope</span> <span class='hs-varid'>in_scope</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tv2</span><span class='hs-keyglyph'>]</span>
<a name="line-2655"></a>                         <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>kind_co</span><span class='hs-keyglyph'>]</span>
<a name="line-2656"></a>                         <span class='hs-varid'>ty2</span>
<a name="line-2657"></a>
<a name="line-2658"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>cv1</span> <span class='hs-sel'>_flag1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>cv2</span> <span class='hs-sel'>_flag2</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-2659"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isCoVar</span> <span class='hs-varid'>cv2</span> <span class='hs-layout'>)</span>
<a name="line-2660"></a>        <span class='hs-varid'>mkForAllCo</span> <span class='hs-varid'>cv1</span> <span class='hs-varid'>kind_co</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-2661"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>s1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>cv1</span>
<a name="line-2662"></a>            <span class='hs-varid'>s2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varType</span> <span class='hs-varid'>cv2</span>
<a name="line-2663"></a>            <span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>s1</span> <span class='hs-varid'>s2</span>
<a name="line-2664"></a>
<a name="line-2665"></a>            <span class='hs-comment'>-- s1 = t1 ~r t2</span>
<a name="line-2666"></a>            <span class='hs-comment'>-- s2 = t3 ~r t4</span>
<a name="line-2667"></a>            <span class='hs-comment'>-- kind_co :: (t1 ~r t2) ~N (t3 ~r t4)</span>
<a name="line-2668"></a>            <span class='hs-comment'>-- eta1 :: t1 ~r t3</span>
<a name="line-2669"></a>            <span class='hs-comment'>-- eta2 :: t2 ~r t4</span>
<a name="line-2670"></a>
<a name="line-2671"></a>            <span class='hs-varid'>r</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coVarRole</span> <span class='hs-varid'>cv1</span>
<a name="line-2672"></a>            <span class='hs-varid'>kind_co'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>downgradeRole</span> <span class='hs-varid'>r</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>kind_co</span>
<a name="line-2673"></a>            <span class='hs-varid'>eta1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-num'>2</span> <span class='hs-varid'>kind_co'</span>
<a name="line-2674"></a>            <span class='hs-varid'>eta2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNthCo</span> <span class='hs-varid'>r</span> <span class='hs-num'>3</span> <span class='hs-varid'>kind_co'</span>
<a name="line-2675"></a>
<a name="line-2676"></a>            <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span>
<a name="line-2677"></a>                      <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>`unionVarSet`</span> <span class='hs-varid'>tyCoVarsOfCo</span> <span class='hs-varid'>kind_co</span>
<a name="line-2678"></a>            <span class='hs-varid'>ty2'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>cv2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varid'>eta1</span> <span class='hs-varop'>`mkTransCo`</span>
<a name="line-2679"></a>                                                       <span class='hs-varid'>mkCoVarCo</span> <span class='hs-varid'>cv1</span> <span class='hs-varop'>`mkTransCo`</span>
<a name="line-2680"></a>                                                       <span class='hs-varid'>eta2</span><span class='hs-layout'>)</span>
<a name="line-2681"></a>                            <span class='hs-varid'>ty2</span>
<a name="line-2682"></a>
<a name="line-2683"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-varid'>lit1</span><span class='hs-layout'>)</span> <span class='hs-sel'>_lit2</span>
<a name="line-2684"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-keyword'>case</span> <span class='hs-sel'>_lit2</span> <span class='hs-keyword'>of</span>
<a name="line-2685"></a>                  <span class='hs-layout'>{</span> <span class='hs-conid'>LitTy</span> <span class='hs-varid'>lit2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>lit1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>lit2</span>
<a name="line-2686"></a>                  <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>        <span class='hs-layout'>}</span> <span class='hs-layout'>)</span>
<a name="line-2687"></a>        <span class='hs-varid'>mkNomReflCo</span> <span class='hs-varid'>ty1</span>
<a name="line-2688"></a>
<a name="line-2689"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CoercionTy</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2690"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkProofIrrelCo</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co2</span>
<a name="line-2691"></a>      <span class='hs-keyword'>where</span>
<a name="line-2692"></a>        <span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionType</span> <span class='hs-varid'>co1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionType</span> <span class='hs-varid'>co2</span><span class='hs-layout'>)</span>
<a name="line-2693"></a>
<a name="line-2694"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-2695"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"buildKindCoercion"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_ty2</span>
<a name="line-2696"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2697"></a>
<a name="line-2698"></a><span class='hs-comment'>{-
<a name="line-2699"></a>%************************************************************************
<a name="line-2700"></a>%*                                                                      *
<a name="line-2701"></a>       Simplifying types
<a name="line-2702"></a>%*                                                                      *
<a name="line-2703"></a>%************************************************************************
<a name="line-2704"></a>
<a name="line-2705"></a>The function below morally belongs in GHC.Tc.Solver.Rewrite, but it is used also in
<a name="line-2706"></a>FamInstEnv, and so lives here.
<a name="line-2707"></a>
<a name="line-2708"></a>Note [simplifyArgsWorker]
<a name="line-2709"></a>~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2710"></a>Invariant (F2) of Note [Rewriting] in GHC.Tc.Solver.Rewrite says that
<a name="line-2711"></a>rewriting is homogeneous.
<a name="line-2712"></a>This causes some trouble when rewriting a function applied to a telescope
<a name="line-2713"></a>of arguments, perhaps with dependency. For example, suppose
<a name="line-2714"></a>
<a name="line-2715"></a>  type family F :: forall (j :: Type) (k :: Type). Maybe j -&gt; Either j k -&gt; Bool -&gt; [k]
<a name="line-2716"></a>
<a name="line-2717"></a>and we wish to rewrite the args of (with kind applications explicit)
<a name="line-2718"></a>
<a name="line-2719"></a>  F a b (Just a c) (Right a b d) False
<a name="line-2720"></a>
<a name="line-2721"></a>where all variables are skolems and
<a name="line-2722"></a>
<a name="line-2723"></a>  a :: Type
<a name="line-2724"></a>  b :: Type
<a name="line-2725"></a>  c :: a
<a name="line-2726"></a>  d :: k
<a name="line-2727"></a>
<a name="line-2728"></a>  [G] aco :: a ~ fa
<a name="line-2729"></a>  [G] bco :: b ~ fb
<a name="line-2730"></a>  [G] cco :: c ~ fc
<a name="line-2731"></a>  [G] dco :: d ~ fd
<a name="line-2732"></a>
<a name="line-2733"></a>The first step is to rewrite all the arguments. This is done before calling
<a name="line-2734"></a>simplifyArgsWorker. We start from
<a name="line-2735"></a>
<a name="line-2736"></a>  a
<a name="line-2737"></a>  b
<a name="line-2738"></a>  Just a c
<a name="line-2739"></a>  Right a b d
<a name="line-2740"></a>  False
<a name="line-2741"></a>
<a name="line-2742"></a>and get
<a name="line-2743"></a>
<a name="line-2744"></a>  (fa,                             co1 :: fa ~ a)
<a name="line-2745"></a>  (fb,                             co2 :: fb ~ b)
<a name="line-2746"></a>  (Just fa (fc |&gt; aco) |&gt; co6,     co3 :: (Just fa (fc |&gt; aco) |&gt; co6) ~ (Just a c))
<a name="line-2747"></a>  (Right fa fb (fd |&gt; bco) |&gt; co7, co4 :: (Right fa fb (fd |&gt; bco) |&gt; co7) ~ (Right a b d))
<a name="line-2748"></a>  (False,                          co5 :: False ~ False)
<a name="line-2749"></a>
<a name="line-2750"></a>where
<a name="line-2751"></a>  co6 :: Maybe fa ~ Maybe a
<a name="line-2752"></a>  co7 :: Either fa fb ~ Either a b
<a name="line-2753"></a>
<a name="line-2754"></a>We now process the rewritten args in left-to-right order. The first two args
<a name="line-2755"></a>need no further processing. But now consider the third argument. Let f3 = the rewritten
<a name="line-2756"></a>result, Just fa (fc |&gt; aco) |&gt; co6.
<a name="line-2757"></a>This f3 rewritten argument has kind (Maybe a), due to
<a name="line-2758"></a>(F2). And yet, when we build the application (F fa fb ...), we need this
<a name="line-2759"></a>argument to have kind (Maybe fa), not (Maybe a). We must cast this argument.
<a name="line-2760"></a>The coercion to use is
<a name="line-2761"></a>determined by the kind of F: we see in F's kind that the third argument has
<a name="line-2762"></a>kind Maybe j. Critically, we also know that the argument corresponding to j
<a name="line-2763"></a>(in our example, a) rewrote with a coercion co1. We can thus know the
<a name="line-2764"></a>coercion needed for the 3rd argument is (Maybe (sym co1)), thus building
<a name="line-2765"></a>(f3 |&gt; Maybe (sym co1))
<a name="line-2766"></a>
<a name="line-2767"></a>More generally, we must use the Lifting Lemma, as implemented in
<a name="line-2768"></a>Coercion.liftCoSubst. As we work left-to-right, any variable that is a
<a name="line-2769"></a>dependent parameter (j and k, in our example) gets mapped in a lifting context
<a name="line-2770"></a>to the coercion that is output from rewriting the corresponding argument (co1
<a name="line-2771"></a>and co2, in our example). Then, after rewriting later arguments, we lift the
<a name="line-2772"></a>kind of these arguments in the lifting context that we've be building up.
<a name="line-2773"></a>This coercion is then used to keep the result of rewriting well-kinded.
<a name="line-2774"></a>
<a name="line-2775"></a>Working through our example, this is what happens:
<a name="line-2776"></a>
<a name="line-2777"></a>  1. Extend the (empty) LC with [j |-&gt; co1]. No new casting must be done,
<a name="line-2778"></a>     because the binder associated with the first argument has a closed type (no
<a name="line-2779"></a>     variables).
<a name="line-2780"></a>
<a name="line-2781"></a>  2. Extend the LC with [k |-&gt; co2]. No casting to do.
<a name="line-2782"></a>
<a name="line-2783"></a>  3. Lifting the kind (Maybe j) with our LC
<a name="line-2784"></a>     yields co8 :: Maybe fa ~ Maybe a. Use (f3 |&gt; sym co8) as the argument to
<a name="line-2785"></a>     F.
<a name="line-2786"></a>
<a name="line-2787"></a>  4. Lifting the kind (Either j k) with our LC
<a name="line-2788"></a>     yields co9 :: Either fa fb ~ Either a b. Use (f4 |&gt; sym co9) as the 4th
<a name="line-2789"></a>     argument to F, where f4 is the rewritten form of argument 4, written above.
<a name="line-2790"></a>
<a name="line-2791"></a>  5. We lift Bool with our LC, getting &lt;Bool&gt;;
<a name="line-2792"></a>     casting has no effect.
<a name="line-2793"></a>
<a name="line-2794"></a>We're now almost done, but the new application (F fa fb (f3 |&gt; sym co8) (f4 &gt; sym co9) False)
<a name="line-2795"></a>has the wrong kind. Its kind is [fb], instead of the original [b].
<a name="line-2796"></a>So we must use our LC one last time to lift the result kind [k],
<a name="line-2797"></a>getting res_co :: [fb] ~ [b], and we cast our result.
<a name="line-2798"></a>
<a name="line-2799"></a>Accordingly, the final result is
<a name="line-2800"></a>
<a name="line-2801"></a>  F fa fb (Just fa (fc |&gt; aco) |&gt; Maybe (sym aco) |&gt; sym (Maybe (sym aco)))
<a name="line-2802"></a>          (Right fa fb (fd |&gt; bco) |&gt; Either (sym aco) (sym bco) |&gt; sym (Either (sym aco) (sym bco)))
<a name="line-2803"></a>          False
<a name="line-2804"></a>            |&gt; [sym bco]
<a name="line-2805"></a>
<a name="line-2806"></a>The res_co (in this case, [sym bco])
<a name="line-2807"></a>is returned as the third return value from simplifyArgsWorker.
<a name="line-2808"></a>
<a name="line-2809"></a>Note [Last case in simplifyArgsWorker]
<a name="line-2810"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2811"></a>In writing simplifyArgsWorker's `go`, we know here that args cannot be empty,
<a name="line-2812"></a>because that case is first. We've run out of
<a name="line-2813"></a>binders. But perhaps inner_ki is a tyvar that has been instantiated with a
<a name="line-2814"></a>-type.
<a name="line-2815"></a>
<a name="line-2816"></a>Here is an example.
<a name="line-2817"></a>
<a name="line-2818"></a>  a :: forall (k :: Type). k -&gt; k
<a name="line-2819"></a>  type family Star
<a name="line-2820"></a>  Proxy :: forall j. j -&gt; Type
<a name="line-2821"></a>  axStar :: Star ~ Type
<a name="line-2822"></a>  type family NoWay :: Bool
<a name="line-2823"></a>  axNoWay :: NoWay ~ False
<a name="line-2824"></a>  bo :: Type
<a name="line-2825"></a>  [G] bc :: bo ~ Bool   (in inert set)
<a name="line-2826"></a>
<a name="line-2827"></a>  co :: (forall j. j -&gt; Type) ~ (forall (j :: Star). (j |&gt; axStar) -&gt; Star)
<a name="line-2828"></a>  co = forall (j :: sym axStar). (&lt;j&gt; -&gt; sym axStar)
<a name="line-2829"></a>
<a name="line-2830"></a>  We are rewriting:
<a name="line-2831"></a>  a (forall (j :: Star). (j |&gt; axStar) -&gt; Star)   -- 1
<a name="line-2832"></a>    (Proxy |&gt; co)                                 -- 2
<a name="line-2833"></a>    (bo |&gt; sym axStar)                            -- 3
<a name="line-2834"></a>    (NoWay |&gt; sym bc)                             -- 4
<a name="line-2835"></a>      :: Star
<a name="line-2836"></a>
<a name="line-2837"></a>First, we rewrite all the arguments (before simplifyArgsWorker), like so:
<a name="line-2838"></a>
<a name="line-2839"></a>    (forall j. j -&gt; Type, co1 :: (forall j. j -&gt; Type) ~
<a name="line-2840"></a>                                 (forall (j :: Star). (j |&gt; axStar) -&gt; Star))  -- 1
<a name="line-2841"></a>    (Proxy |&gt; co,         co2 :: (Proxy |&gt; co) ~ (Proxy |&gt; co))                -- 2
<a name="line-2842"></a>    (Bool |&gt; sym axStar,  co3 :: (Bool |&gt; sym axStar) ~ (bo |&gt; sym axStar))    -- 3
<a name="line-2843"></a>    (False |&gt; sym bc,     co4 :: (False |&gt; sym bc) ~ (NoWay |&gt; sym bc))        -- 4
<a name="line-2844"></a>
<a name="line-2845"></a>Then we do the process described in Note [simplifyArgsWorker].
<a name="line-2846"></a>
<a name="line-2847"></a>1. Lifting Type (the kind of the first arg) gives us a reflexive coercion, so we
<a name="line-2848"></a>   don't use it. But we do build a lifting context [k -&gt; co1] (where co1 is a
<a name="line-2849"></a>   result of rewriting an argument, written above).
<a name="line-2850"></a>
<a name="line-2851"></a>2. Lifting k gives us co1, so the second argument becomes (Proxy |&gt; co |&gt; sym co1).
<a name="line-2852"></a>   This is not a dependent argument, so we don't extend the lifting context.
<a name="line-2853"></a>
<a name="line-2854"></a>Now we need to deal with argument (3).
<a name="line-2855"></a>The way we normally proceed is to lift the kind of the binder, to see whether
<a name="line-2856"></a>it's dependent.
<a name="line-2857"></a>But here, the remainder of the kind of `a` that we're left with
<a name="line-2858"></a>after processing two arguments is just `k`.
<a name="line-2859"></a>
<a name="line-2860"></a>The way forward is look up k in the lifting context, getting co1. If we're at
<a name="line-2861"></a>all well-typed, co1 will be a coercion between -types, with at least one binder.
<a name="line-2862"></a>So, let's
<a name="line-2863"></a>decompose co1 with decomposePiCos. This decomposition needs arguments to use
<a name="line-2864"></a>to instantiate any kind parameters. Look at the type of co1. If we just
<a name="line-2865"></a>decomposed it, we would end up with coercions whose types include j, which is
<a name="line-2866"></a>out of scope here. Accordingly, decomposePiCos takes a list of types whose
<a name="line-2867"></a>kinds are the *right-hand* types in the decomposed coercion. (See comments on
<a name="line-2868"></a>decomposePiCos.) Because the rewritten types have unrewritten kinds (because
<a name="line-2869"></a>rewriting is homogeneous), passing the list of rewritten types to decomposePiCos
<a name="line-2870"></a>just won't do: later arguments' kinds won't be as expected. So we need to get
<a name="line-2871"></a>the *unrewritten* types to pass to decomposePiCos. We can do this easily enough
<a name="line-2872"></a>by taking the kind of the argument coercions, passed in originally.
<a name="line-2873"></a>
<a name="line-2874"></a>(Alternative 1: We could re-engineer decomposePiCos to deal with this situation.
<a name="line-2875"></a>But that function is already gnarly, and taking the right-hand types is correct
<a name="line-2876"></a>at its other call sites, which are much more common than this one.)
<a name="line-2877"></a>
<a name="line-2878"></a>(Alternative 2: We could avoid calling decomposePiCos entirely, integrating its
<a name="line-2879"></a>behavior into simplifyArgsWorker. This would work, I think, but then all of the
<a name="line-2880"></a>complication of decomposePiCos would end up layered on top of all the complication
<a name="line-2881"></a>here. Please, no.)
<a name="line-2882"></a>
<a name="line-2883"></a>(Alternative 3: We could pass the unrewritten arguments into simplifyArgsWorker
<a name="line-2884"></a>so that we don't have to recreate them. But that would complicate the interface
<a name="line-2885"></a>of this function to handle a very dark, dark corner case. Better to keep our
<a name="line-2886"></a>demons to ourselves here instead of exposing them to callers. This decision is
<a name="line-2887"></a>easily reversed if there is ever any performance trouble due to the call of
<a name="line-2888"></a>coercionKind.)
<a name="line-2889"></a>
<a name="line-2890"></a>So we now call
<a name="line-2891"></a>
<a name="line-2892"></a>  decomposePiCos co1
<a name="line-2893"></a>                 (Pair (forall j. j -&gt; Type) (forall (j :: Star). (j |&gt; axStar) -&gt; Star))
<a name="line-2894"></a>                 [bo |&gt; sym axStar, NoWay |&gt; sym bc]
<a name="line-2895"></a>
<a name="line-2896"></a>to get
<a name="line-2897"></a>
<a name="line-2898"></a>  co5 :: Star ~ Type
<a name="line-2899"></a>  co6 :: (j |&gt; axStar) ~ (j |&gt; co5), substituted to
<a name="line-2900"></a>                              (bo |&gt; sym axStar |&gt; axStar) ~ (bo |&gt; sym axStar |&gt; co5)
<a name="line-2901"></a>                           == bo ~ bo
<a name="line-2902"></a>  res_co :: Type ~ Star
<a name="line-2903"></a>
<a name="line-2904"></a>We then use these casts on (the rewritten) (3) and (4) to get
<a name="line-2905"></a>
<a name="line-2906"></a>  (Bool |&gt; sym axStar |&gt; co5 :: Type)   -- (C3)
<a name="line-2907"></a>  (False |&gt; sym bc |&gt; co6    :: bo)     -- (C4)
<a name="line-2908"></a>
<a name="line-2909"></a>We can simplify to
<a name="line-2910"></a>
<a name="line-2911"></a>  Bool                        -- (C3)
<a name="line-2912"></a>  (False |&gt; sym bc :: bo)     -- (C4)
<a name="line-2913"></a>
<a name="line-2914"></a>Of course, we still must do the processing in Note [simplifyArgsWorker] to finish
<a name="line-2915"></a>the job. We thus want to recur. Our new function kind is the left-hand type of
<a name="line-2916"></a>co1 (gotten, recall, by lifting the variable k that was the return kind of the
<a name="line-2917"></a>original function). Why the left-hand type (as opposed to the right-hand type)?
<a name="line-2918"></a>Because we have casted all the arguments according to decomposePiCos, which gets
<a name="line-2919"></a>us from the right-hand type to the left-hand one. We thus recur with that new
<a name="line-2920"></a>function kind, zapping our lifting context, because we have essentially applied
<a name="line-2921"></a>it.
<a name="line-2922"></a>
<a name="line-2923"></a>This recursive call returns ([Bool, False], [...], Refl). The Bool and False
<a name="line-2924"></a>are the correct arguments we wish to return. But we must be careful about the
<a name="line-2925"></a>result coercion: our new, rewritten application will have kind Type, but we
<a name="line-2926"></a>want to make sure that the result coercion casts this back to Star. (Why?
<a name="line-2927"></a>Because we started with an application of kind Star, and rewriting is homogeneous.)
<a name="line-2928"></a>
<a name="line-2929"></a>So, we have to twiddle the result coercion appropriately.
<a name="line-2930"></a>
<a name="line-2931"></a>Let's check whether this is well-typed. We know
<a name="line-2932"></a>
<a name="line-2933"></a>  a :: forall (k :: Type). k -&gt; k
<a name="line-2934"></a>
<a name="line-2935"></a>  a (forall j. j -&gt; Type) :: (forall j. j -&gt; Type) -&gt; forall j. j -&gt; Type
<a name="line-2936"></a>
<a name="line-2937"></a>  a (forall j. j -&gt; Type)
<a name="line-2938"></a>    Proxy
<a name="line-2939"></a>      :: forall j. j -&gt; Type
<a name="line-2940"></a>
<a name="line-2941"></a>  a (forall j. j -&gt; Type)
<a name="line-2942"></a>    Proxy
<a name="line-2943"></a>    Bool
<a name="line-2944"></a>      :: Bool -&gt; Type
<a name="line-2945"></a>
<a name="line-2946"></a>  a (forall j. j -&gt; Type)
<a name="line-2947"></a>    Proxy
<a name="line-2948"></a>    Bool
<a name="line-2949"></a>    False
<a name="line-2950"></a>      :: Type
<a name="line-2951"></a>
<a name="line-2952"></a>  a (forall j. j -&gt; Type)
<a name="line-2953"></a>    Proxy
<a name="line-2954"></a>    Bool
<a name="line-2955"></a>    False
<a name="line-2956"></a>     |&gt; res_co
<a name="line-2957"></a>     :: Star
<a name="line-2958"></a>
<a name="line-2959"></a>as desired.
<a name="line-2960"></a>
<a name="line-2961"></a>Whew.
<a name="line-2962"></a>
<a name="line-2963"></a>Historical note: I (Richard E) once thought that the final part of the kind
<a name="line-2964"></a>had to be a variable k (as in the example above). But it might not be: it could
<a name="line-2965"></a>be an application of a variable. Here is the example:
<a name="line-2966"></a>
<a name="line-2967"></a>  let f :: forall (a :: Type) (b :: a -&gt; Type). b (Any @a)
<a name="line-2968"></a>      k :: Type
<a name="line-2969"></a>      x :: k
<a name="line-2970"></a>
<a name="line-2971"></a>  rewrite (f @Type @((-&gt;) k) x)
<a name="line-2972"></a>
<a name="line-2973"></a>After instantiating [a |-&gt; Type, b |-&gt; ((-&gt;) k)], we see that `b (Any @a)`
<a name="line-2974"></a>is `k -&gt; Any @a`, and thus the third argument of `x :: k` is well-kinded.
<a name="line-2975"></a>
<a name="line-2976"></a>-}</span>
<a name="line-2977"></a>
<a name="line-2978"></a>
<a name="line-2979"></a><a name="simplifyArgsWorker"></a><span class='hs-comment'>-- This is shared between the rewriter and the normaliser in GHC.Core.FamInstEnv.</span>
<a name="line-2980"></a><span class='hs-comment'>-- See Note [simplifyArgsWorker]</span>
<a name="line-2981"></a><span class='hs-comment'>{-# INLINE simplifyArgsWorker #-}</span>
<a name="line-2982"></a><span class='hs-definition'>simplifyArgsWorker</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>
<a name="line-2983"></a>                       <span class='hs-comment'>-- the binders &amp; result kind (not a -type) of the function applied to the args</span>
<a name="line-2984"></a>                       <span class='hs-comment'>-- list of binders can be shorter or longer than the list of args</span>
<a name="line-2985"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoVarSet</span>   <span class='hs-comment'>-- free vars of the args</span>
<a name="line-2986"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- list of roles, r</span>
<a name="line-2987"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- rewritten type arguments, arg</span>
<a name="line-2988"></a>                                         <span class='hs-comment'>-- each comes with the coercion used to rewrite it,</span>
<a name="line-2989"></a>                                         <span class='hs-comment'>-- with co :: rewritten_type ~ original_type</span>
<a name="line-2990"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>MCoercionN</span><span class='hs-layout'>)</span>
<a name="line-2991"></a><span class='hs-comment'>-- Returns (xis, cos, res_co), where each co :: xi ~ arg,</span>
<a name="line-2992"></a><span class='hs-comment'>-- and res_co :: kind (f xis) ~ kind (f tys), where f is the function applied to the args</span>
<a name="line-2993"></a><span class='hs-comment'>-- Precondition: if f :: forall bndrs. inner_ki (where bndrs and inner_ki are passed in),</span>
<a name="line-2994"></a><span class='hs-comment'>-- then (f orig_tys) is well kinded. Note that (f rewritten_tys) might *not* be well-kinded.</span>
<a name="line-2995"></a><span class='hs-comment'>-- Massaging the rewritten_tys in order to make (f rewritten_tys) well-kinded is what this</span>
<a name="line-2996"></a><span class='hs-comment'>-- function is all about. That is, (f xis), where xis are the returned arguments, *is*</span>
<a name="line-2997"></a><span class='hs-comment'>-- well kinded.</span>
<a name="line-2998"></a><span class='hs-definition'>simplifyArgsWorker</span> <span class='hs-varid'>orig_ki_binders</span> <span class='hs-varid'>orig_inner_ki</span> <span class='hs-varid'>orig_fvs</span>
<a name="line-2999"></a>                   <span class='hs-varid'>orig_roles</span> <span class='hs-varid'>orig_simplified_args</span>
<a name="line-3000"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>orig_lc</span> <span class='hs-varid'>orig_ki_binders</span> <span class='hs-varid'>orig_inner_ki</span> <span class='hs-varid'>orig_roles</span> <span class='hs-varid'>orig_simplified_args</span>
<a name="line-3001"></a>  <span class='hs-keyword'>where</span>
<a name="line-3002"></a>    <span class='hs-varid'>orig_lc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyLiftingContext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>orig_fvs</span>
<a name="line-3003"></a>
<a name="line-3004"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Xis accumulator, in reverse order</span>
<a name="line-3005"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Coercions accumulator, in reverse order</span>
<a name="line-3006"></a>                      <span class='hs-comment'>-- These are in 1-to-1 correspondence</span>
<a name="line-3007"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LiftingContext</span>  <span class='hs-comment'>-- mapping from tyvars to rewriting coercions</span>
<a name="line-3008"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Unsubsted binders of function's kind</span>
<a name="line-3009"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>        <span class='hs-comment'>-- Unsubsted result kind of function (not a Pi-type)</span>
<a name="line-3010"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Role</span><span class='hs-keyglyph'>]</span>      <span class='hs-comment'>-- Roles at which to rewrite these ...</span>
<a name="line-3011"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Coercion</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- rewritten arguments, with their rewriting coercions</span>
<a name="line-3012"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Coercion</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>MCoercionN</span><span class='hs-layout'>)</span>
<a name="line-3013"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_xis</span> <span class='hs-varid'>acc_cos</span> <span class='hs-varop'>!</span><span class='hs-varid'>lc</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>inner_ki</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-3014"></a>        <span class='hs-comment'>-- The !lc makes the function strict in the lifting context</span>
<a name="line-3015"></a>        <span class='hs-comment'>-- which means GHC can unbox that pair.  A modest win.</span>
<a name="line-3016"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_xis</span><span class='hs-layout'>,</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>acc_cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind_co</span><span class='hs-layout'>)</span>
<a name="line-3017"></a>      <span class='hs-keyword'>where</span>
<a name="line-3018"></a>        <span class='hs-varid'>final_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkPiTys</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>inner_ki</span>
<a name="line-3019"></a>        <span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>noFreeVarsOfType</span> <span class='hs-varid'>final_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MRefl</span>
<a name="line-3020"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MCo</span> <span class='hs-varop'>$</span> <span class='hs-varid'>liftCoSubst</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>final_kind</span>
<a name="line-3021"></a>
<a name="line-3022"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_xis</span> <span class='hs-varid'>acc_cos</span> <span class='hs-varid'>lc</span> <span class='hs-layout'>(</span><span class='hs-varid'>binder</span><span class='hs-conop'>:</span><span class='hs-varid'>binders</span><span class='hs-layout'>)</span> <span class='hs-varid'>inner_ki</span> <span class='hs-layout'>(</span><span class='hs-varid'>role</span><span class='hs-conop'>:</span><span class='hs-varid'>roles</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span><span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-3023"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- By Note [Rewriting] in GHC.Tc.Solver.Rewrite invariant (F2),</span>
<a name="line-3024"></a>         <span class='hs-comment'>-- tcTypeKind(xi) = tcTypeKind(ty). But, it's possible that xi will be</span>
<a name="line-3025"></a>         <span class='hs-comment'>-- used as an argument to a function whose kind is different, if</span>
<a name="line-3026"></a>         <span class='hs-comment'>-- earlier arguments have been rewritten to new types. We thus</span>
<a name="line-3027"></a>         <span class='hs-comment'>-- need a coercion (kind_co :: old_kind ~ new_kind).</span>
<a name="line-3028"></a>         <span class='hs-comment'>--</span>
<a name="line-3029"></a>         <span class='hs-comment'>-- The bangs here have been observed to improve performance</span>
<a name="line-3030"></a>         <span class='hs-comment'>-- significantly in optimized builds; see #18502</span>
<a name="line-3031"></a>         <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>kind_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSymCo</span> <span class='hs-varop'>$</span>
<a name="line-3032"></a>                        <span class='hs-varid'>liftCoSubst</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>lc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoBinderType</span> <span class='hs-varid'>binder</span><span class='hs-layout'>)</span>
<a name="line-3033"></a>             <span class='hs-varop'>!</span><span class='hs-varid'>casted_xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>kind_co</span>
<a name="line-3034"></a>             <span class='hs-varid'>casted_co</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mkCoherenceLeftCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>xi</span> <span class='hs-varid'>kind_co</span> <span class='hs-varid'>co</span>
<a name="line-3035"></a>
<a name="line-3036"></a>         <span class='hs-comment'>-- now, extend the lifting context with the new binding</span>
<a name="line-3037"></a>             <span class='hs-varop'>!</span><span class='hs-varid'>new_lc</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tyCoBinderVar_maybe</span> <span class='hs-varid'>binder</span>
<a name="line-3038"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendLiftingContextAndInScope</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>casted_co</span>
<a name="line-3039"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3040"></a>                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lc</span>
<a name="line-3041"></a>         <span class='hs-keyword'>in</span>
<a name="line-3042"></a>         <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>casted_xi</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_xis</span><span class='hs-layout'>)</span>
<a name="line-3043"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>casted_co</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc_cos</span><span class='hs-layout'>)</span>
<a name="line-3044"></a>            <span class='hs-varid'>new_lc</span>
<a name="line-3045"></a>            <span class='hs-varid'>binders</span>
<a name="line-3046"></a>            <span class='hs-varid'>inner_ki</span>
<a name="line-3047"></a>            <span class='hs-varid'>roles</span>
<a name="line-3048"></a>            <span class='hs-varid'>args</span>
<a name="line-3049"></a>
<a name="line-3050"></a>
<a name="line-3051"></a>      <span class='hs-comment'>-- See Note [Last case in simplifyArgsWorker]</span>
<a name="line-3052"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>acc_xis</span> <span class='hs-varid'>acc_cos</span> <span class='hs-varid'>lc</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>args</span>
<a name="line-3053"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>co1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftCoSubst</span> <span class='hs-conid'>Nominal</span> <span class='hs-varid'>lc</span> <span class='hs-varid'>inner_ki</span>
<a name="line-3054"></a>            <span class='hs-varid'>co1_kind</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>coercionKind</span> <span class='hs-varid'>co1</span>
<a name="line-3055"></a>            <span class='hs-varid'>unrewritten_tys</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>coercionRKind</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-3056"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>arg_cos</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_co</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decomposePiCos</span> <span class='hs-varid'>co1</span> <span class='hs-varid'>co1_kind</span> <span class='hs-varid'>unrewritten_tys</span>
<a name="line-3057"></a>            <span class='hs-varid'>casted_args</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>equalLength</span> <span class='hs-varid'>args</span> <span class='hs-varid'>arg_cos</span>
<a name="line-3058"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>args</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg_cos</span> <span class='hs-layout'>)</span>
<a name="line-3059"></a>                                    <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>casted_xi</span><span class='hs-layout'>,</span> <span class='hs-varid'>casted_co</span><span class='hs-layout'>)</span>
<a name="line-3060"></a>                                    <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>xi</span><span class='hs-layout'>,</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg_co</span><span class='hs-layout'>,</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>args</span> <span class='hs-varid'>arg_cos</span> <span class='hs-varid'>roles</span>
<a name="line-3061"></a>                                    <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>casted_xi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>xi</span> <span class='hs-varop'>`mkCastTy`</span> <span class='hs-varid'>arg_co</span>
<a name="line-3062"></a>                                          <span class='hs-varid'>casted_co</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkCoherenceLeftCo</span> <span class='hs-varid'>role</span> <span class='hs-varid'>xi</span> <span class='hs-varid'>arg_co</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>]</span>
<a name="line-3063"></a>               <span class='hs-comment'>-- In general decomposePiCos can return fewer cos than tys,</span>
<a name="line-3064"></a>               <span class='hs-comment'>-- but not here; because we're well typed, there will be enough</span>
<a name="line-3065"></a>               <span class='hs-comment'>-- binders. Note that decomposePiCos does substitutions, so even</span>
<a name="line-3066"></a>               <span class='hs-comment'>-- if the original substitution results in something ending with</span>
<a name="line-3067"></a>               <span class='hs-comment'>-- ... -&gt; k, that k will be substituted to perhaps reveal more</span>
<a name="line-3068"></a>               <span class='hs-comment'>-- binders.</span>
<a name="line-3069"></a>            <span class='hs-varid'>zapped_lc</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapLiftingContext</span> <span class='hs-varid'>lc</span>
<a name="line-3070"></a>            <span class='hs-conid'>Pair</span> <span class='hs-varid'>rewritten_kind</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>co1_kind</span>
<a name="line-3071"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_inner</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitPiTys</span> <span class='hs-varid'>rewritten_kind</span>
<a name="line-3072"></a>
<a name="line-3073"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>xis_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_co_out</span><span class='hs-layout'>)</span>
<a name="line-3074"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>acc_xis</span> <span class='hs-varid'>acc_cos</span> <span class='hs-varid'>zapped_lc</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>new_inner</span> <span class='hs-varid'>roles</span> <span class='hs-varid'>casted_args</span>
<a name="line-3075"></a>        <span class='hs-keyword'>in</span>
<a name="line-3076"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>xis_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>cos_out</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_co_out</span> <span class='hs-varop'>`mkTransMCoL`</span> <span class='hs-varid'>res_co</span><span class='hs-layout'>)</span>
<a name="line-3077"></a>
<a name="line-3078"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span>
<a name="line-3079"></a>        <span class='hs-str'>"simplifyArgsWorker wandered into deeper water than usual"</span>
<a name="line-3080"></a>           <span class='hs-comment'>-- This debug information is commented out because leaving it in</span>
<a name="line-3081"></a>           <span class='hs-comment'>-- causes a ~2% increase in allocations in T9872d.</span>
<a name="line-3082"></a>           <span class='hs-comment'>-- That's independent of the analogous case in rewrite_args_fast</span>
<a name="line-3083"></a>           <span class='hs-comment'>-- in GHC.Tc.Solver.Rewrite:</span>
<a name="line-3084"></a>           <span class='hs-comment'>-- each of these causes a 2% increase on its own, so commenting them</span>
<a name="line-3085"></a>           <span class='hs-comment'>-- both out gives a 4% decrease in T9872d.</span>
<a name="line-3086"></a>           <span class='hs-comment'>{-
<a name="line-3087"></a>
<a name="line-3088"></a>             (vcat [ppr orig_binders,
<a name="line-3089"></a>                    ppr orig_inner_ki,
<a name="line-3090"></a>                    ppr (take 10 orig_roles), -- often infinite!
<a name="line-3091"></a>                    ppr orig_tys])
<a name="line-3092"></a>           -}</span>
<a name="line-3093"></a>
<a name="line-3094"></a><span class='hs-comment'>{-
<a name="line-3095"></a>%************************************************************************
<a name="line-3096"></a>%*                                                                      *
<a name="line-3097"></a>       Coercion holes
<a name="line-3098"></a>%*                                                                      *
<a name="line-3099"></a>%************************************************************************
<a name="line-3100"></a>-}</span>
<a name="line-3101"></a>
<a name="line-3102"></a><a name="has_co_hole_ty"></a><span class='hs-definition'>has_co_hole_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Monoid.Any</span>
<a name="line-3103"></a><a name="has_co_hole_co"></a><span class='hs-definition'>has_co_hole_co</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Monoid.Any</span>
<a name="line-3104"></a><span class='hs-layout'>(</span><span class='hs-varid'>has_co_hole_ty</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>has_co_hole_co</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-3105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-varid'>folder</span> <span class='hs-conid'>()</span>
<a name="line-3106"></a>  <span class='hs-keyword'>where</span>
<a name="line-3107"></a>    <span class='hs-varid'>folder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcf_view</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>
<a name="line-3108"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const2</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monoid.Any</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-3109"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_covar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const2</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monoid.Any</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-3110"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_hole</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const2</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monoid.Any</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span>
<a name="line-3111"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const2</span>
<a name="line-3112"></a>                        <span class='hs-layout'>}</span>
<a name="line-3113"></a>
<a name="line-3114"></a>    <span class='hs-varid'>const2</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>c</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span>
<a name="line-3115"></a>    <span class='hs-varid'>const2</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-3116"></a>
<a name="line-3117"></a><a name="hasCoercionHoleTy"></a><span class='hs-comment'>-- | Is there a coercion hole in this type?</span>
<a name="line-3118"></a><span class='hs-definition'>hasCoercionHoleTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3119"></a><span class='hs-definition'>hasCoercionHoleTy</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Monoid.getAny</span> <span class='hs-varop'>.</span> <span class='hs-varid'>has_co_hole_ty</span>
<a name="line-3120"></a>
<a name="line-3121"></a><a name="hasCoercionHoleCo"></a><span class='hs-comment'>-- | Is there a coercion hole in this coercion?</span>
<a name="line-3122"></a><span class='hs-definition'>hasCoercionHoleCo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3123"></a><span class='hs-definition'>hasCoercionHoleCo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Monoid.getAny</span> <span class='hs-varop'>.</span> <span class='hs-varid'>has_co_hole_co</span>
<a name="line-3124"></a>
<a name="line-3125"></a><a name="HoleSet"></a><span class='hs-comment'>-- | A set of 'CoercionHole's</span>
<a name="line-3126"></a><a name="HoleSet"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>HoleSet</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>CoercionHole</span>
<a name="line-3127"></a>
<a name="line-3128"></a><a name="coercionHolesOfType"></a><span class='hs-comment'>-- | Extract out all the coercion holes from a given type</span>
<a name="line-3129"></a><span class='hs-definition'>coercionHolesOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>CoercionHole</span>
<a name="line-3130"></a><a name="coercionHolesOfCo"></a><span class='hs-definition'>coercionHolesOfCo</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Coercion</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UniqSet</span> <span class='hs-conid'>CoercionHole</span>
<a name="line-3131"></a><span class='hs-layout'>(</span><span class='hs-varid'>coercionHolesOfType</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>coercionHolesOfCo</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldTyCo</span> <span class='hs-varid'>folder</span> <span class='hs-conid'>()</span>
<a name="line-3132"></a>  <span class='hs-keyword'>where</span>
<a name="line-3133"></a>    <span class='hs-varid'>folder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyCoFolder</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcf_view</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-conid'>Nothing</span>  <span class='hs-comment'>-- don't look through synonyms</span>
<a name="line-3134"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mempty</span>
<a name="line-3135"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_covar</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mempty</span>
<a name="line-3136"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_hole</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-varid'>unitUniqSet</span>
<a name="line-3137"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>tcf_tycobinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span>
<a name="line-3138"></a>                        <span class='hs-layout'>}</span>
</pre></body>
</html>

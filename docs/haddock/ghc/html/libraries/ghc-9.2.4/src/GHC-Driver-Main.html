<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Driver/Main.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE BangPatterns #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE CPP #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE NondecreasingIndentation #-}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>{-# OPTIONS_GHC -fprof-auto-top #-}</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-comment'>-------------------------------------------------------------------------------</span>
<a name="line-8"></a><span class='hs-comment'>--</span>
<a name="line-9"></a><span class='hs-comment'>-- | Main API for compiling plain Haskell source code.</span>
<a name="line-10"></a><span class='hs-comment'>--</span>
<a name="line-11"></a><span class='hs-comment'>-- This module implements compilation of a Haskell source. It is</span>
<a name="line-12"></a><span class='hs-comment'>-- /not/ concerned with preprocessing of source files; this is handled</span>
<a name="line-13"></a><span class='hs-comment'>-- in "GHC.Driver.Pipeline"</span>
<a name="line-14"></a><span class='hs-comment'>--</span>
<a name="line-15"></a><span class='hs-comment'>-- There are various entry points depending on what mode we're in:</span>
<a name="line-16"></a><span class='hs-comment'>-- "batch" mode (@--make@), "one-shot" mode (@-c@, @-S@ etc.), and</span>
<a name="line-17"></a><span class='hs-comment'>-- "interactive" mode (GHCi). There are also entry points for</span>
<a name="line-18"></a><span class='hs-comment'>-- individual passes: parsing, typechecking/renaming, desugaring, and</span>
<a name="line-19"></a><span class='hs-comment'>-- simplification.</span>
<a name="line-20"></a><span class='hs-comment'>--</span>
<a name="line-21"></a><span class='hs-comment'>-- All the functions here take an 'HscEnv' as a parameter, but none of</span>
<a name="line-22"></a><span class='hs-comment'>-- them return a new one: 'HscEnv' is treated as an immutable value</span>
<a name="line-23"></a><span class='hs-comment'>-- from here on in (although it has mutable components, for the</span>
<a name="line-24"></a><span class='hs-comment'>-- caches).</span>
<a name="line-25"></a><span class='hs-comment'>--</span>
<a name="line-26"></a><span class='hs-comment'>-- We use the Hsc monad to deal with warning messages consistently:</span>
<a name="line-27"></a><span class='hs-comment'>-- specifically, while executing within an Hsc monad, warnings are</span>
<a name="line-28"></a><span class='hs-comment'>-- collected. When a Hsc monad returns to an IO monad, the</span>
<a name="line-29"></a><span class='hs-comment'>-- warnings are printed, or compilation aborts if the @-Werror@</span>
<a name="line-30"></a><span class='hs-comment'>-- flag is enabled.</span>
<a name="line-31"></a><span class='hs-comment'>--</span>
<a name="line-32"></a><span class='hs-comment'>-- (c) The GRASP/AQUA Project, Glasgow University, 1993-2000</span>
<a name="line-33"></a><span class='hs-comment'>--</span>
<a name="line-34"></a><span class='hs-comment'>-------------------------------------------------------------------------------</span>
<a name="line-35"></a>
<a name="line-36"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Driver.Main</span>
<a name="line-37"></a>    <span class='hs-layout'>(</span>
<a name="line-38"></a>    <span class='hs-comment'>-- * Making an HscEnv</span>
<a name="line-39"></a>      <span class='hs-varid'>newHscEnv</span>
<a name="line-40"></a>
<a name="line-41"></a>    <span class='hs-comment'>-- * Compiling complete source files</span>
<a name="line-42"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>Messager</span><span class='hs-layout'>,</span> <span class='hs-varid'>batchMsg</span>
<a name="line-43"></a>    <span class='hs-layout'>,</span> <span class='hs-conid'>HscStatus</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-44"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscIncrementalCompile</span>
<a name="line-45"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>initModDetails</span>
<a name="line-46"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscMaybeWriteIface</span>
<a name="line-47"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscCompileCmmFile</span>
<a name="line-48"></a>
<a name="line-49"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscGenHardCode</span>
<a name="line-50"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscInteractive</span>
<a name="line-51"></a>
<a name="line-52"></a>    <span class='hs-comment'>-- * Running passes separately</span>
<a name="line-53"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscParse</span>
<a name="line-54"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscTypecheckRename</span>
<a name="line-55"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscDesugar</span>
<a name="line-56"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>makeSimpleDetails</span>
<a name="line-57"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscSimplify</span> <span class='hs-comment'>-- ToDo, shouldn't really export this</span>
<a name="line-58"></a>
<a name="line-59"></a>    <span class='hs-comment'>-- * Safe Haskell</span>
<a name="line-60"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscCheckSafe</span>
<a name="line-61"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscGetSafe</span>
<a name="line-62"></a>
<a name="line-63"></a>    <span class='hs-comment'>-- * Support for interactive evaluation</span>
<a name="line-64"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscParseIdentifier</span>
<a name="line-65"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscTcRcLookupName</span>
<a name="line-66"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscTcRnGetInfo</span>
<a name="line-67"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscIsGHCiMonad</span>
<a name="line-68"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscGetModuleInterface</span>
<a name="line-69"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscRnImportDecls</span>
<a name="line-70"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscTcRnLookupRdrName</span>
<a name="line-71"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscStmt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscParseStmtWithLocation</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscStmtWithLocation</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscParsedStmt</span>
<a name="line-72"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscDecls</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscParseDeclsWithLocation</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscDeclsWithLocation</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscParsedDecls</span>
<a name="line-73"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscTcExpr</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcRnExprMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscImport</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscKcType</span>
<a name="line-74"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscParseExpr</span>
<a name="line-75"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscParseType</span>
<a name="line-76"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscCompileCoreExpr</span>
<a name="line-77"></a>    <span class='hs-comment'>-- * Low-level exports for hooks</span>
<a name="line-78"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscCompileCoreExpr'</span>
<a name="line-79"></a>      <span class='hs-comment'>-- We want to make sure that we export enough to be able to redefine</span>
<a name="line-80"></a>      <span class='hs-comment'>-- hsc_typecheck in client code</span>
<a name="line-81"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscParse'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscSimplify'</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscDesugar'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcRnModule'</span><span class='hs-layout'>,</span> <span class='hs-varid'>doCodeGen</span>
<a name="line-82"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-83"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscSimpleIface'</span>
<a name="line-84"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>oneShotMsg</span>
<a name="line-85"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>dumpIfaceStats</span>
<a name="line-86"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>ioMsgMaybe</span>
<a name="line-87"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>showModuleIndex</span>
<a name="line-88"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>hscAddSptEntries</span>
<a name="line-89"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-90"></a>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-92"></a>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Plugins</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Backend</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Env</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Errors</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.CodeOutput</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Config</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Hooks</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser.Errors</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Context</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Interpreter</span> <span class='hs-layout'>(</span> <span class='hs-varid'>addSptEntry</span><span class='hs-layout'>,</span> <span class='hs-varid'>hscInterp</span> <span class='hs-layout'>)</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Runtime.Loader</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>initializePlugins</span> <span class='hs-layout'>)</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHCi.RemoteTypes</span>        <span class='hs-layout'>(</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-layout'>)</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.ByteCode.Types</span>
<a name="line-108"></a>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Linker.Loader</span>
<a name="line-110"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Linker.Types</span>
<a name="line-111"></a>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs.Dump</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs.Stats</span>         <span class='hs-layout'>(</span> <span class='hs-varid'>ppSourceStats</span> <span class='hs-layout'>)</span>
<a name="line-115"></a>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.HsToCore</span>
<a name="line-117"></a>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToByteCode</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>byteCodeGen</span> <span class='hs-layout'>)</span>
<a name="line-119"></a>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IfaceToCore</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>typecheckIface</span> <span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Load</span>   <span class='hs-layout'>(</span> <span class='hs-varid'>ifaceStats</span><span class='hs-layout'>,</span> <span class='hs-varid'>initExternalPackageState</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeIface</span> <span class='hs-layout'>)</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Make</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Recomp</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Tidy</span>
<a name="line-126"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Ext.Ast</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>mkHieFile</span> <span class='hs-layout'>)</span>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Ext.Types</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>getAsts</span><span class='hs-layout'>,</span> <span class='hs-varid'>hie_asts</span><span class='hs-layout'>,</span> <span class='hs-varid'>hie_module</span> <span class='hs-layout'>)</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Ext.Binary</span> <span class='hs-layout'>(</span> <span class='hs-varid'>readHieFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeHieFile</span> <span class='hs-layout'>,</span> <span class='hs-varid'>hie_file_result</span><span class='hs-layout'>,</span> <span class='hs-conid'>NameCacheUpdater</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Ext.Debug</span>  <span class='hs-layout'>(</span> <span class='hs-varid'>diffFile</span><span class='hs-layout'>,</span> <span class='hs-varid'>validateScopes</span> <span class='hs-layout'>)</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Iface.Env</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>updNameCache</span> <span class='hs-layout'>)</span>
<a name="line-131"></a>
<a name="line-132"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core</span>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Tidy</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-layout'>)</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>           <span class='hs-layout'>(</span> <span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span> <span class='hs-layout'>)</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Lint</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>lintInteractiveExpr</span> <span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Multiplicity</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Utils</span>          <span class='hs-layout'>(</span> <span class='hs-varid'>exprType</span> <span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.ConLike</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Opt.Pipeline</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.InstEnv</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.FamInstEnv</span>
<a name="line-143"></a>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CoreToStg.Prep</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.CoreToStg</span>    <span class='hs-layout'>(</span> <span class='hs-varid'>coreToStg</span> <span class='hs-layout'>)</span>
<a name="line-146"></a>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser.Errors.Ppr</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Parser.Lexer</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Lexer</span>
<a name="line-150"></a>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Module</span>
<a name="line-152"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-153"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Zonk</span>    <span class='hs-layout'>(</span> <span class='hs-conid'>ZonkFlexi</span> <span class='hs-layout'>(</span><span class='hs-conid'>DefaultFlexi</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-154"></a>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Stg.Syntax</span>
<a name="line-156"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Stg.FVs</span>      <span class='hs-layout'>(</span> <span class='hs-varid'>annTopBindingsFreeVars</span> <span class='hs-layout'>)</span>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Stg.Pipeline</span> <span class='hs-layout'>(</span> <span class='hs-varid'>stg2stg</span> <span class='hs-layout'>)</span>
<a name="line-158"></a>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Utils</span>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Uniques</span> <span class='hs-layout'>(</span> <span class='hs-varid'>mkPseudoUniqueE</span> <span class='hs-layout'>)</span>
<a name="line-162"></a>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.StgToCmm</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>StgToCmm</span> <span class='hs-layout'>(</span> <span class='hs-varid'>codeGen</span> <span class='hs-layout'>)</span>
<a name="line-164"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.StgToCmm.Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>CgInfos</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleLFInfos</span><span class='hs-layout'>)</span>
<a name="line-165"></a>
<a name="line-166"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm</span>
<a name="line-167"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Parser</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>parseCmmFile</span> <span class='hs-layout'>)</span>
<a name="line-168"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Info.Build</span>
<a name="line-169"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Pipeline</span>
<a name="line-170"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Cmm.Info</span>
<a name="line-171"></a>
<a name="line-172"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit</span>
<a name="line-173"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.External</span>
<a name="line-174"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.State</span>
<a name="line-175"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModDetails</span>
<a name="line-176"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModGuts</span>
<a name="line-177"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModIface</span>
<a name="line-178"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.ModSummary</span>
<a name="line-179"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Graph</span>
<a name="line-180"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Imported</span>
<a name="line-181"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Deps</span>
<a name="line-182"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Module.Status</span>
<a name="line-183"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Unit.Home.ModInfo</span>
<a name="line-184"></a>
<a name="line-185"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Id</span>
<a name="line-186"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceError</span>
<a name="line-187"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SafeHaskell</span>
<a name="line-188"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.ForeignStubs</span>
<a name="line-189"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>       <span class='hs-layout'>(</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-layout'>)</span>
<a name="line-190"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Error</span>
<a name="line-191"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Fixity.Env</span>
<a name="line-192"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.CostCentre</span>
<a name="line-193"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.IPE</span>
<a name="line-194"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span>
<a name="line-195"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SourceFile</span>
<a name="line-196"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-197"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-198"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-199"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Cache</span> <span class='hs-layout'>(</span> <span class='hs-varid'>initNameCache</span> <span class='hs-layout'>)</span>
<a name="line-200"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Reader</span>
<a name="line-201"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Ppr</span>
<a name="line-202"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.TyThing</span>
<a name="line-203"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.HpcInfo</span>
<a name="line-204"></a>
<a name="line-205"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Fingerprint</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-layout'>)</span>
<a name="line-206"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-207"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Error</span>
<a name="line-208"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-209"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Exception</span>
<a name="line-210"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-211"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Logger</span>
<a name="line-212"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.TmpFs</span>
<a name="line-213"></a>
<a name="line-214"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-215"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span>
<a name="line-216"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.StringBuffer</span>
<a name="line-217"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.Data.Stream</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Stream</span>
<a name="line-218"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Stream</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stream</span><span class='hs-layout'>)</span>
<a name="line-219"></a>
<a name="line-220"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Data</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fixity</span><span class='hs-layout'>,</span> <span class='hs-conid'>TyCon</span><span class='hs-layout'>)</span>
<a name="line-221"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>nub</span><span class='hs-layout'>,</span> <span class='hs-varid'>isPrefixOf</span><span class='hs-layout'>,</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>)</span>
<a name="line-222"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-223"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.IORef</span>
<a name="line-224"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.FilePath</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>FilePath</span>
<a name="line-225"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Directory</span>
<a name="line-226"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span> <span class='hs-layout'>(</span><span class='hs-varid'>fixIO</span><span class='hs-layout'>)</span>
<a name="line-227"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data.Set</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-228"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Set</span> <span class='hs-layout'>(</span><span class='hs-conid'>Set</span><span class='hs-layout'>)</span>
<a name="line-229"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Functor</span>
<a name="line-230"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.DeepSeq</span> <span class='hs-layout'>(</span><span class='hs-varid'>force</span><span class='hs-layout'>)</span>
<a name="line-231"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Bifunctor</span> <span class='hs-layout'>(</span><span class='hs-varid'>first</span><span class='hs-layout'>,</span> <span class='hs-varid'>bimap</span><span class='hs-layout'>)</span>
<a name="line-232"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-233"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List.NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conop'>:|</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-234"></a>
<a name="line-235"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-236"></a>
<a name="line-237"></a>
<a name="line-238"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-239"></a>%*                                                                      *
<a name="line-240"></a>                Initialisation
<a name="line-241"></a>%*                                                                      *
<a name="line-242"></a>%********************************************************************* -}</span>
<a name="line-243"></a>
<a name="line-244"></a><a name="newHscEnv"></a><span class='hs-definition'>newHscEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HscEnv</span>
<a name="line-245"></a><span class='hs-definition'>newHscEnv</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-246"></a>    <span class='hs-comment'>-- we don't store the unit databases and the unit state to still</span>
<a name="line-247"></a>    <span class='hs-comment'>-- allow `setSessionDynFlags` to be used to set unit db flags.</span>
<a name="line-248"></a>    <span class='hs-varid'>eps_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>initExternalPackageState</span>
<a name="line-249"></a>    <span class='hs-varid'>us</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkSplitUniqSupply</span> <span class='hs-chr'>'r'</span>
<a name="line-250"></a>    <span class='hs-varid'>nc_var</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>initNameCache</span> <span class='hs-varid'>us</span> <span class='hs-varid'>knownKeyNames</span><span class='hs-layout'>)</span>
<a name="line-251"></a>    <span class='hs-varid'>fc_var</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>emptyInstalledModuleEnv</span>
<a name="line-252"></a>    <span class='hs-varid'>logger</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initLogger</span>
<a name="line-253"></a>    <span class='hs-varid'>tmpfs</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initTmpFs</span>
<a name="line-254"></a>    <span class='hs-comment'>-- FIXME: it's sad that we have so many "unitialized" fields filled with</span>
<a name="line-255"></a>    <span class='hs-comment'>-- empty stuff or lazy panics. We should have two kinds of HscEnv</span>
<a name="line-256"></a>    <span class='hs-comment'>-- (initialized or not) instead and less fields that are mutable over time.</span>
<a name="line-257"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>HscEnv</span> <span class='hs-layout'>{</span>  <span class='hs-varid'>hsc_dflags</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dflags</span>
<a name="line-258"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_logger</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>logger</span>
<a name="line-259"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_targets</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-260"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_mod_graph</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyMG</span>
<a name="line-261"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_IC</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyInteractiveContext</span> <span class='hs-varid'>dflags</span>
<a name="line-262"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_HPT</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyHomePackageTable</span>
<a name="line-263"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_EPS</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eps_var</span>
<a name="line-264"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_NC</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nc_var</span>
<a name="line-265"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_FC</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fc_var</span>
<a name="line-266"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_type_env_var</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-267"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_interp</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-268"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_unit_env</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hsc_unit_env not initialized"</span>
<a name="line-269"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_plugins</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-270"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_static_plugins</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-271"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_unit_dbs</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-272"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_hooks</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyHooks</span>
<a name="line-273"></a>                  <span class='hs-layout'>,</span>  <span class='hs-varid'>hsc_tmpfs</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tmpfs</span>
<a name="line-274"></a>                  <span class='hs-layout'>}</span>
<a name="line-275"></a>
<a name="line-276"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-277"></a>
<a name="line-278"></a><a name="getWarnings"></a><span class='hs-definition'>getWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>WarningMessages</span>
<a name="line-279"></a><span class='hs-definition'>getWarnings</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Hsc</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>w</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-280"></a>
<a name="line-281"></a><a name="clearWarnings"></a><span class='hs-definition'>clearWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>()</span>
<a name="line-282"></a><span class='hs-definition'>clearWarnings</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Hsc</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyBag</span><span class='hs-layout'>)</span>
<a name="line-283"></a>
<a name="line-284"></a><a name="logWarnings"></a><span class='hs-definition'>logWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WarningMessages</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>()</span>
<a name="line-285"></a><span class='hs-definition'>logWarnings</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Hsc</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-varid'>w0</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span><span class='hs-layout'>,</span> <span class='hs-varid'>w0</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-286"></a>
<a name="line-287"></a><a name="getHscEnv"></a><span class='hs-definition'>getHscEnv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>HscEnv</span>
<a name="line-288"></a><span class='hs-definition'>getHscEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Hsc</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-289"></a>
<a name="line-290"></a><a name="handleWarnings"></a><span class='hs-definition'>handleWarnings</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>()</span>
<a name="line-291"></a><span class='hs-definition'>handleWarnings</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-292"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-293"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-294"></a>    <span class='hs-varid'>w</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWarnings</span>
<a name="line-295"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printOrThrowWarnings</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>w</span>
<a name="line-296"></a>    <span class='hs-varid'>clearWarnings</span>
<a name="line-297"></a>
<a name="line-298"></a><a name="logWarningsReportErrors"></a><span class='hs-comment'>-- | log warning in the monad, and if there are errors then</span>
<a name="line-299"></a><span class='hs-comment'>-- throw a SourceError exception.</span>
<a name="line-300"></a><span class='hs-definition'>logWarningsReportErrors</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>PsWarning</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>PsError</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>()</span>
<a name="line-301"></a><span class='hs-definition'>logWarningsReportErrors</span> <span class='hs-layout'>(</span><span class='hs-varid'>warnings</span><span class='hs-layout'>,</span><span class='hs-varid'>errors</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-302"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprWarning</span> <span class='hs-varid'>warnings</span>
<a name="line-303"></a>        <span class='hs-varid'>errs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprError</span>   <span class='hs-varid'>errors</span>
<a name="line-304"></a>    <span class='hs-varid'>logWarnings</span> <span class='hs-varid'>warns</span>
<a name="line-305"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwErrors</span> <span class='hs-varid'>errs</span>
<a name="line-306"></a>
<a name="line-307"></a><a name="handleWarningsThrowErrors"></a><span class='hs-comment'>-- | Log warnings and throw errors, assuming the messages</span>
<a name="line-308"></a><span class='hs-comment'>-- contain at least one error (e.g. coming from PFailed)</span>
<a name="line-309"></a><span class='hs-definition'>handleWarningsThrowErrors</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>PsWarning</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>PsError</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-varid'>a</span>
<a name="line-310"></a><span class='hs-definition'>handleWarningsThrowErrors</span> <span class='hs-layout'>(</span><span class='hs-varid'>warnings</span><span class='hs-layout'>,</span> <span class='hs-varid'>errors</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-311"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprWarning</span> <span class='hs-varid'>warnings</span>
<a name="line-312"></a>        <span class='hs-varid'>errs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprError</span>   <span class='hs-varid'>errors</span>
<a name="line-313"></a>    <span class='hs-varid'>logWarnings</span> <span class='hs-varid'>warns</span>
<a name="line-314"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-315"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-316"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>wWarns</span><span class='hs-layout'>,</span> <span class='hs-varid'>wErrs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>warningsToMessages</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getWarnings</span>
<a name="line-317"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>printBagOfErrors</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>wWarns</span>
<a name="line-318"></a>    <span class='hs-varid'>throwErrors</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionBags</span> <span class='hs-varid'>errs</span> <span class='hs-varid'>wErrs</span><span class='hs-layout'>)</span>
<a name="line-319"></a>
<a name="line-320"></a><a name="ioMsgMaybe"></a><span class='hs-comment'>-- | Deal with errors and warnings returned by a compilation step</span>
<a name="line-321"></a><span class='hs-comment'>--</span>
<a name="line-322"></a><span class='hs-comment'>-- In order to reduce dependencies to other parts of the compiler, functions</span>
<a name="line-323"></a><span class='hs-comment'>-- outside the "main" parts of GHC return warnings and errors as a parameter</span>
<a name="line-324"></a><span class='hs-comment'>-- and signal success via by wrapping the result in a 'Maybe' type. This</span>
<a name="line-325"></a><span class='hs-comment'>-- function logs the returned warnings and propagates errors as exceptions</span>
<a name="line-326"></a><span class='hs-comment'>-- (of type 'SourceError').</span>
<a name="line-327"></a><span class='hs-comment'>--</span>
<a name="line-328"></a><span class='hs-comment'>-- This function assumes the following invariants:</span>
<a name="line-329"></a><span class='hs-comment'>--</span>
<a name="line-330"></a><span class='hs-comment'>--  1. If the second result indicates success (is of the form 'Just x'),</span>
<a name="line-331"></a><span class='hs-comment'>--     there must be no error messages in the first result.</span>
<a name="line-332"></a><span class='hs-comment'>--</span>
<a name="line-333"></a><span class='hs-comment'>--  2. If there are no error messages, but the second result indicates failure</span>
<a name="line-334"></a><span class='hs-comment'>--     there should be warnings in the first result. That is, if the action</span>
<a name="line-335"></a><span class='hs-comment'>--     failed, it must have been due to the warnings (i.e., @-Werror@).</span>
<a name="line-336"></a><span class='hs-definition'>ioMsgMaybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span> <span class='hs-conid'>DecoratedSDoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-varid'>a</span>
<a name="line-337"></a><span class='hs-definition'>ioMsgMaybe</span> <span class='hs-varid'>ioA</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-338"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varid'>ioA</span>
<a name="line-339"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionMessages</span> <span class='hs-varid'>msgs</span>
<a name="line-340"></a>    <span class='hs-varid'>logWarnings</span> <span class='hs-varid'>warns</span>
<a name="line-341"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_r</span> <span class='hs-keyword'>of</span>
<a name="line-342"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwErrors</span> <span class='hs-varid'>errs</span>
<a name="line-343"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span> <span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="ioMsgMaybe'"></a><span class='hs-comment'>-- | like ioMsgMaybe, except that we ignore error messages and return</span>
<a name="line-346"></a><span class='hs-comment'>-- 'Nothing' instead.</span>
<a name="line-347"></a><span class='hs-definition'>ioMsgMaybe'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Messages</span> <span class='hs-conid'>DecoratedSDoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-348"></a><span class='hs-definition'>ioMsgMaybe'</span> <span class='hs-varid'>ioA</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-349"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>msgs</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_r</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ioA</span>
<a name="line-350"></a>    <span class='hs-varid'>logWarnings</span> <span class='hs-layout'>(</span><span class='hs-varid'>getWarningMessages</span> <span class='hs-varid'>msgs</span><span class='hs-layout'>)</span>
<a name="line-351"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>mb_r</span>
<a name="line-352"></a>
<a name="line-353"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-354"></a><span class='hs-comment'>-- | Lookup things in the compiler's environment</span>
<a name="line-355"></a>
<a name="line-356"></a><a name="hscTcRnLookupRdrName"></a><span class='hs-definition'>hscTcRnLookupRdrName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-357"></a><span class='hs-definition'>hscTcRnLookupRdrName</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>rdr_name</span>
<a name="line-358"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span>
<a name="line-359"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-360"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnLookupRdrName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>rdr_name</span> <span class='hs-layout'>}</span>
<a name="line-361"></a>
<a name="line-362"></a><a name="hscTcRcLookupName"></a><span class='hs-definition'>hscTcRcLookupName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyThing</span><span class='hs-layout'>)</span>
<a name="line-363"></a><span class='hs-definition'>hscTcRcLookupName</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-364"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-365"></a>  <span class='hs-varid'>ioMsgMaybe'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnLookupName</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-366"></a>      <span class='hs-comment'>-- ignore errors: the only error we're likely to get is</span>
<a name="line-367"></a>      <span class='hs-comment'>-- "name not found", and the Maybe in the return type</span>
<a name="line-368"></a>      <span class='hs-comment'>-- is used to indicate that.</span>
<a name="line-369"></a>
<a name="line-370"></a><a name="hscTcRnGetInfo"></a><span class='hs-definition'>hscTcRnGetInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>
<a name="line-371"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyThing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fixity</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>FamInst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-372"></a><span class='hs-definition'>hscTcRnGetInfo</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>name</span>
<a name="line-373"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span>
<a name="line-374"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-375"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ioMsgMaybe'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnGetInfo</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-376"></a>
<a name="line-377"></a><a name="hscIsGHCiMonad"></a><span class='hs-definition'>hscIsGHCiMonad</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Name</span>
<a name="line-378"></a><span class='hs-definition'>hscIsGHCiMonad</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-379"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isGHCiMonad</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>name</span>
<a name="line-380"></a>
<a name="line-381"></a><a name="hscGetModuleInterface"></a><span class='hs-definition'>hscGetModuleInterface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModIface</span>
<a name="line-382"></a><span class='hs-definition'>hscGetModuleInterface</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-383"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-384"></a>  <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getModuleInterface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod</span>
<a name="line-385"></a>
<a name="line-386"></a><a name="hscRnImportDecls"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-387"></a><span class='hs-comment'>-- | Rename some import declarations</span>
<a name="line-388"></a><span class='hs-definition'>hscRnImportDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LImportDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>GlobalRdrEnv</span>
<a name="line-389"></a><span class='hs-definition'>hscRnImportDecls</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>import_decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-390"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-391"></a>  <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnImportDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>import_decls</span>
<a name="line-392"></a>
<a name="line-393"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-394"></a><span class='hs-comment'>-- | parse a file, returning the abstract syntax</span>
<a name="line-395"></a>
<a name="line-396"></a><a name="hscParse"></a><span class='hs-definition'>hscParse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>HsParsedModule</span>
<a name="line-397"></a><span class='hs-definition'>hscParse</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscParse'</span> <span class='hs-varid'>mod_summary</span>
<a name="line-398"></a>
<a name="line-399"></a><a name="hscParse'"></a><span class='hs-comment'>-- internal version, that doesn't fail due to -Werror</span>
<a name="line-400"></a><span class='hs-definition'>hscParse'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>HsParsedModule</span>
<a name="line-401"></a><span class='hs-definition'>hscParse'</span> <span class='hs-varid'>mod_summary</span>
<a name="line-402"></a> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ms_parsed_mod</span> <span class='hs-varid'>mod_summary</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-403"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-404"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-405"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-406"></a>    <span class='hs-comment'>{-# SCC "Parser" #-}</span> <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-407"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Parser"</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-408"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-409"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>src_filename</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hspp_file</span> <span class='hs-varid'>mod_summary</span>
<a name="line-410"></a>        <span class='hs-varid'>maybe_src_buf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hspp_buf</span>  <span class='hs-varid'>mod_summary</span>
<a name="line-411"></a>
<a name="line-412"></a>    <span class='hs-comment'>--------------------------  Parser  ----------------</span>
<a name="line-413"></a>    <span class='hs-comment'>-- sometimes we already have the buffer in memory, perhaps</span>
<a name="line-414"></a>    <span class='hs-comment'>-- because we needed to parse the imports out of it, or get the</span>
<a name="line-415"></a>    <span class='hs-comment'>-- module name.</span>
<a name="line-416"></a>    <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_src_buf</span> <span class='hs-keyword'>of</span>
<a name="line-417"></a>               <span class='hs-conid'>Just</span> <span class='hs-varid'>b</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>b</span>
<a name="line-418"></a>               <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hGetStringBuffer</span> <span class='hs-varid'>src_filename</span>
<a name="line-419"></a>
<a name="line-420"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>src_filename</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span>
<a name="line-421"></a>
<a name="line-422"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnUnicodeBidirectionalFormatCharacters</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-423"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>checkBidirectionFormatChars</span> <span class='hs-layout'>(</span><span class='hs-conid'>PsLoc</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>BufPos</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>buf</span> <span class='hs-keyword'>of</span>
<a name="line-424"></a>        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-425"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>chars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-426"></a>          <span class='hs-varid'>logWarnings</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprWarning</span> <span class='hs-varop'>$</span>
<a name="line-427"></a>               <span class='hs-conid'>PsWarnBidirectionalFormatChars</span> <span class='hs-varid'>chars</span>
<a name="line-428"></a>
<a name="line-429"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>parseMod</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsigFile</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ms_hsc_src</span> <span class='hs-varid'>mod_summary</span>
<a name="line-430"></a>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseSignature</span>
<a name="line-431"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parseModule</span>
<a name="line-432"></a>
<a name="line-433"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>unP</span> <span class='hs-varid'>parseMod</span> <span class='hs-layout'>(</span><span class='hs-varid'>initParserState</span> <span class='hs-layout'>(</span><span class='hs-varid'>initParserOpts</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-434"></a>        <span class='hs-conid'>PFailed</span> <span class='hs-varid'>pst</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-435"></a>            <span class='hs-varid'>handleWarningsThrowErrors</span> <span class='hs-layout'>(</span><span class='hs-varid'>getMessages</span> <span class='hs-varid'>pst</span><span class='hs-layout'>)</span>
<a name="line-436"></a>        <span class='hs-conid'>POk</span> <span class='hs-varid'>pst</span> <span class='hs-varid'>rdr_module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-437"></a>            <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bimap</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>pprWarning</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>pprError</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getMessages</span> <span class='hs-varid'>pst</span><span class='hs-layout'>)</span>
<a name="line-438"></a>            <span class='hs-varid'>logWarnings</span> <span class='hs-varid'>warns</span>
<a name="line-439"></a>            <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_parsed</span> <span class='hs-str'>"Parser"</span>
<a name="line-440"></a>                        <span class='hs-conid'>FormatHaskell</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>rdr_module</span><span class='hs-layout'>)</span>
<a name="line-441"></a>            <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_parsed_ast</span> <span class='hs-str'>"Parser AST"</span>
<a name="line-442"></a>                        <span class='hs-conid'>FormatHaskell</span> <span class='hs-layout'>(</span><span class='hs-varid'>showAstData</span> <span class='hs-conid'>NoBlankSrcSpan</span>
<a name="line-443"></a>                                                   <span class='hs-conid'>NoBlankEpAnnotations</span>
<a name="line-444"></a>                                                   <span class='hs-varid'>rdr_module</span><span class='hs-layout'>)</span>
<a name="line-445"></a>            <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_source_stats</span> <span class='hs-str'>"Source Statistics"</span>
<a name="line-446"></a>                        <span class='hs-conid'>FormatText</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppSourceStats</span> <span class='hs-conid'>False</span> <span class='hs-varid'>rdr_module</span><span class='hs-layout'>)</span>
<a name="line-447"></a>            <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwErrors</span> <span class='hs-varid'>errs</span>
<a name="line-448"></a>
<a name="line-449"></a>            <span class='hs-comment'>-- To get the list of extra source files, we take the list</span>
<a name="line-450"></a>            <span class='hs-comment'>-- that the parser gave us,</span>
<a name="line-451"></a>            <span class='hs-comment'>--   - eliminate files beginning with '&lt;'.  gcc likes to use</span>
<a name="line-452"></a>            <span class='hs-comment'>--     pseudo-filenames like "&lt;built-in&gt;" and "&lt;command-line&gt;"</span>
<a name="line-453"></a>            <span class='hs-comment'>--   - normalise them (eliminate differences between ./f and f)</span>
<a name="line-454"></a>            <span class='hs-comment'>--   - filter out the preprocessed source file</span>
<a name="line-455"></a>            <span class='hs-comment'>--   - filter out anything beginning with tmpdir</span>
<a name="line-456"></a>            <span class='hs-comment'>--   - remove duplicates</span>
<a name="line-457"></a>            <span class='hs-comment'>--   - filter out the .hs/.lhs source filename if we have one</span>
<a name="line-458"></a>            <span class='hs-comment'>--</span>
<a name="line-459"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>n_hspp</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FilePath.normalise</span> <span class='hs-varid'>src_filename</span>
<a name="line-460"></a>                <span class='hs-varid'>srcs0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nub</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varid'>tmpDir</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>`isPrefixOf`</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-461"></a>                            <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>==</span> <span class='hs-varid'>n_hspp</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-462"></a>                            <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-conid'>FilePath.normalise</span>
<a name="line-463"></a>                            <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isPrefixOf</span> <span class='hs-str'>"&lt;"</span><span class='hs-layout'>)</span>
<a name="line-464"></a>                            <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>unpackFS</span>
<a name="line-465"></a>                            <span class='hs-varop'>$</span> <span class='hs-varid'>srcfiles</span> <span class='hs-varid'>pst</span>
<a name="line-466"></a>                <span class='hs-varid'>srcs1</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ml_hs_file</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_location</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-467"></a>                          <span class='hs-conid'>Just</span> <span class='hs-varid'>f</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>/=</span> <span class='hs-conid'>FilePath.normalise</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span> <span class='hs-varid'>srcs0</span>
<a name="line-468"></a>                          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>srcs0</span>
<a name="line-469"></a>
<a name="line-470"></a>            <span class='hs-comment'>-- sometimes we see source files from earlier</span>
<a name="line-471"></a>            <span class='hs-comment'>-- preprocessing stages that cannot be found, so just</span>
<a name="line-472"></a>            <span class='hs-comment'>-- filter them out:</span>
<a name="line-473"></a>            <span class='hs-varid'>srcs2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filterM</span> <span class='hs-varid'>doesFileExist</span> <span class='hs-varid'>srcs1</span>
<a name="line-474"></a>
<a name="line-475"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsParsedModule</span> <span class='hs-layout'>{</span>
<a name="line-476"></a>                      <span class='hs-varid'>hpm_module</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rdr_module</span><span class='hs-layout'>,</span>
<a name="line-477"></a>                      <span class='hs-varid'>hpm_src_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcs2</span>
<a name="line-478"></a>                   <span class='hs-layout'>}</span>
<a name="line-479"></a>
<a name="line-480"></a>            <span class='hs-comment'>-- apply parse transformation of plugins</span>
<a name="line-481"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>applyPluginAction</span> <span class='hs-varid'>p</span> <span class='hs-varid'>opts</span>
<a name="line-482"></a>                  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parsedResultAction</span> <span class='hs-varid'>p</span> <span class='hs-varid'>opts</span> <span class='hs-varid'>mod_summary</span>
<a name="line-483"></a>            <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-484"></a>            <span class='hs-varid'>withPlugins</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>applyPluginAction</span> <span class='hs-varid'>res</span>
<a name="line-485"></a>
<a name="line-486"></a><a name="checkBidirectionFormatChars"></a><span class='hs-definition'>checkBidirectionFormatChars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PsLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StringBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>PsLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Char</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-487"></a><span class='hs-definition'>checkBidirectionFormatChars</span> <span class='hs-varid'>start_loc</span> <span class='hs-varid'>sb</span>
<a name="line-488"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>containsBidirectionalFormatChar</span> <span class='hs-varid'>sb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>go</span> <span class='hs-varid'>start_loc</span> <span class='hs-varid'>sb</span>
<a name="line-489"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-490"></a>  <span class='hs-keyword'>where</span>
<a name="line-491"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PsLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StringBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NonEmpty</span> <span class='hs-layout'>(</span><span class='hs-conid'>PsLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Char</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-492"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sb</span>
<a name="line-493"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>atEnd</span> <span class='hs-varid'>sb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"checkBidirectionFormatChars: no char found"</span>
<a name="line-494"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nextChar</span> <span class='hs-varid'>sb</span> <span class='hs-keyword'>of</span>
<a name="line-495"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>chr</span><span class='hs-layout'>,</span> <span class='hs-varid'>sb</span><span class='hs-layout'>)</span>
<a name="line-496"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>desc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>chr</span> <span class='hs-varid'>bidirectionalFormatChars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-497"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>chr</span><span class='hs-layout'>,</span> <span class='hs-varid'>desc</span><span class='hs-layout'>)</span> <span class='hs-conop'>:|</span> <span class='hs-varid'>go1</span> <span class='hs-layout'>(</span><span class='hs-varid'>advancePsLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>chr</span><span class='hs-layout'>)</span> <span class='hs-varid'>sb</span>
<a name="line-498"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>advancePsLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>chr</span><span class='hs-layout'>)</span> <span class='hs-varid'>sb</span>
<a name="line-499"></a>
<a name="line-500"></a>    <span class='hs-varid'>go1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>PsLoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StringBuffer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>PsLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>Char</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-501"></a>    <span class='hs-varid'>go1</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sb</span>
<a name="line-502"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>atEnd</span> <span class='hs-varid'>sb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-503"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>nextChar</span> <span class='hs-varid'>sb</span> <span class='hs-keyword'>of</span>
<a name="line-504"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>chr</span><span class='hs-layout'>,</span> <span class='hs-varid'>sb</span><span class='hs-layout'>)</span>
<a name="line-505"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>desc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup</span> <span class='hs-varid'>chr</span> <span class='hs-varid'>bidirectionalFormatChars</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-506"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>chr</span><span class='hs-layout'>,</span> <span class='hs-varid'>desc</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go1</span> <span class='hs-layout'>(</span><span class='hs-varid'>advancePsLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>chr</span><span class='hs-layout'>)</span> <span class='hs-varid'>sb</span>
<a name="line-507"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go1</span> <span class='hs-layout'>(</span><span class='hs-varid'>advancePsLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>chr</span><span class='hs-layout'>)</span> <span class='hs-varid'>sb</span>
<a name="line-508"></a>
<a name="line-509"></a>
<a name="line-510"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-511"></a><span class='hs-comment'>-- | If the renamed source has been kept, extract it. Dump it if requested.</span>
<a name="line-512"></a>
<a name="line-513"></a>
<a name="line-514"></a><a name="extract_renamed_stuff"></a><span class='hs-definition'>extract_renamed_stuff</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>RenamedStuff</span>
<a name="line-515"></a><span class='hs-definition'>extract_renamed_stuff</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>tc_result</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-516"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>rn_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getRenamedStuff</span> <span class='hs-varid'>tc_result</span>
<a name="line-517"></a>
<a name="line-518"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-519"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-520"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_rn_ast</span> <span class='hs-str'>"Renamer"</span>
<a name="line-521"></a>                <span class='hs-conid'>FormatHaskell</span> <span class='hs-layout'>(</span><span class='hs-varid'>showAstData</span> <span class='hs-conid'>NoBlankSrcSpan</span> <span class='hs-conid'>NoBlankEpAnnotations</span> <span class='hs-varid'>rn_info</span><span class='hs-layout'>)</span>
<a name="line-522"></a>
<a name="line-523"></a>    <span class='hs-comment'>-- Create HIE files</span>
<a name="line-524"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WriteHie</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-525"></a>        <span class='hs-comment'>-- I assume this fromJust is safe because `-fwrite-hie-file`</span>
<a name="line-526"></a>        <span class='hs-comment'>-- enables the option which keeps the renamed source.</span>
<a name="line-527"></a>        <span class='hs-varid'>hieFile</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHieFile</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>tc_result</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromJust</span> <span class='hs-varid'>rn_info</span><span class='hs-layout'>)</span>
<a name="line-528"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>out_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ml_hie_file</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ms_location</span> <span class='hs-varid'>mod_summary</span>
<a name="line-529"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeHieFile</span> <span class='hs-varid'>out_file</span> <span class='hs-varid'>hieFile</span>
<a name="line-530"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_hie</span> <span class='hs-str'>"HIE AST"</span> <span class='hs-conid'>FormatHaskell</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hie_asts</span> <span class='hs-varid'>hieFile</span><span class='hs-layout'>)</span>
<a name="line-531"></a>
<a name="line-532"></a>        <span class='hs-comment'>-- Validate HIE files</span>
<a name="line-533"></a>        <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_ValidateHie</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-534"></a>            <span class='hs-varid'>hs_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Hsc</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-varid'>w</span><span class='hs-layout'>)</span>
<a name="line-535"></a>            <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-536"></a>              <span class='hs-comment'>-- Validate Scopes</span>
<a name="line-537"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>validateScopes</span> <span class='hs-layout'>(</span><span class='hs-varid'>hie_module</span> <span class='hs-varid'>hieFile</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getAsts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hie_asts</span> <span class='hs-varid'>hieFile</span> <span class='hs-keyword'>of</span>
<a name="line-538"></a>                  <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>putMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Got valid scopes"</span>
<a name="line-539"></a>                  <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-540"></a>                    <span class='hs-varid'>putMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Got invalid scopes"</span>
<a name="line-541"></a>                    <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>putMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-542"></a>              <span class='hs-comment'>-- Roundtrip testing</span>
<a name="line-543"></a>              <span class='hs-varid'>file'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readHieFile</span> <span class='hs-layout'>(</span><span class='hs-conid'>NCU</span> <span class='hs-varop'>$</span> <span class='hs-varid'>updNameCache</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_NC</span> <span class='hs-varid'>hs_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>out_file</span>
<a name="line-544"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>diffFile</span> <span class='hs-varid'>hieFile</span> <span class='hs-layout'>(</span><span class='hs-varid'>hie_file_result</span> <span class='hs-varid'>file'</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-545"></a>                <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-546"></a>                  <span class='hs-varid'>putMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Got no roundtrip errors"</span>
<a name="line-547"></a>                <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-548"></a>                  <span class='hs-varid'>putMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Got roundtrip errors"</span>
<a name="line-549"></a>                  <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>putMsg</span> <span class='hs-varid'>logger</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt_set</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_ppr_debug</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span>
<a name="line-550"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>rn_info</span>
<a name="line-551"></a>
<a name="line-552"></a>
<a name="line-553"></a><a name="hscTypecheckRename"></a><span class='hs-comment'>-- -----------------------------------------------------------------------------</span>
<a name="line-554"></a><span class='hs-comment'>-- | Rename and typecheck a module, additionally returning the renamed syntax</span>
<a name="line-555"></a><span class='hs-definition'>hscTypecheckRename</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsParsedModule</span>
<a name="line-556"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>RenamedStuff</span><span class='hs-layout'>)</span>
<a name="line-557"></a><span class='hs-definition'>hscTypecheckRename</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>rdr_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-558"></a>    <span class='hs-varid'>hsc_typecheck</span> <span class='hs-conid'>True</span> <span class='hs-varid'>mod_summary</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>rdr_module</span><span class='hs-layout'>)</span>
<a name="line-559"></a>
<a name="line-560"></a>
<a name="line-561"></a><a name="hsc_typecheck"></a><span class='hs-comment'>-- | A bunch of logic piled around @tcRnModule'@, concerning a) backpack</span>
<a name="line-562"></a><span class='hs-comment'>-- b) concerning dumping rename info and hie files. It would be nice to further</span>
<a name="line-563"></a><span class='hs-comment'>-- separate this stuff out, probably in conjunction better separating renaming</span>
<a name="line-564"></a><span class='hs-comment'>-- and type checking (#17781).</span>
<a name="line-565"></a><span class='hs-definition'>hsc_typecheck</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- ^ Keep renamed source?</span>
<a name="line-566"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>HsParsedModule</span>
<a name="line-567"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcGblEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>RenamedStuff</span><span class='hs-layout'>)</span>
<a name="line-568"></a><span class='hs-definition'>hsc_typecheck</span> <span class='hs-varid'>keep_rn</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>mb_rdr_module</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-569"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-570"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hsc_src</span> <span class='hs-varid'>mod_summary</span>
<a name="line-571"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-572"></a>        <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-573"></a>        <span class='hs-varid'>outer_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod_summary</span>
<a name="line-574"></a>        <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleName</span> <span class='hs-varid'>outer_mod</span>
<a name="line-575"></a>        <span class='hs-varid'>outer_mod'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomeModule</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>mod_name</span>
<a name="line-576"></a>        <span class='hs-varid'>inner_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>homeModuleNameInstantiation</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>mod_name</span>
<a name="line-577"></a>        <span class='hs-varid'>src_filename</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hspp_file</span> <span class='hs-varid'>mod_summary</span>
<a name="line-578"></a>        <span class='hs-varid'>real_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>realSrcLocSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFastString</span> <span class='hs-varid'>src_filename</span><span class='hs-layout'>)</span> <span class='hs-num'>1</span> <span class='hs-num'>1</span>
<a name="line-579"></a>        <span class='hs-varid'>keep_rn'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WriteHie</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span> <span class='hs-varid'>keep_rn</span>
<a name="line-580"></a>    <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isHomeModule</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>outer_mod</span> <span class='hs-layout'>)</span>
<a name="line-581"></a>    <span class='hs-varid'>tc_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HsigFile</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isHoleModule</span> <span class='hs-varid'>inner_mod</span><span class='hs-layout'>)</span>
<a name="line-582"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnInstantiateSignature</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>outer_mod'</span> <span class='hs-varid'>real_loc</span>
<a name="line-583"></a>        <span class='hs-keyword'>else</span>
<a name="line-584"></a>         <span class='hs-keyword'>do</span> <span class='hs-varid'>hpm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_rdr_module</span> <span class='hs-keyword'>of</span>
<a name="line-585"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>hpm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>hpm</span>
<a name="line-586"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hscParse'</span> <span class='hs-varid'>mod_summary</span>
<a name="line-587"></a>            <span class='hs-varid'>tc_result0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcRnModule'</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>keep_rn'</span> <span class='hs-varid'>hpm</span>
<a name="line-588"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HsigFile</span>
<a name="line-589"></a>                <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>(</span><span class='hs-varid'>iface</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscSimpleIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tc_result0</span> <span class='hs-conid'>Nothing</span>
<a name="line-590"></a>                        <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span>
<a name="line-591"></a>                            <span class='hs-varid'>tcRnMergeSignatures</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>hpm</span> <span class='hs-varid'>tc_result0</span> <span class='hs-varid'>iface</span>
<a name="line-592"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc_result0</span>
<a name="line-593"></a>    <span class='hs-comment'>-- TODO are we extracting anything when we merely instantiate a signature?</span>
<a name="line-594"></a>    <span class='hs-comment'>-- If not, try to move this into the "else" case above.</span>
<a name="line-595"></a>    <span class='hs-varid'>rn_info</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>extract_renamed_stuff</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>tc_result</span>
<a name="line-596"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_result</span><span class='hs-layout'>,</span> <span class='hs-varid'>rn_info</span><span class='hs-layout'>)</span>
<a name="line-597"></a>
<a name="line-598"></a><a name="tcRnModule'"></a><span class='hs-comment'>-- wrapper around tcRnModule to handle safe haskell extras</span>
<a name="line-599"></a><span class='hs-definition'>tcRnModule'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsParsedModule</span>
<a name="line-600"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-601"></a><span class='hs-definition'>tcRnModule'</span> <span class='hs-varid'>sum</span> <span class='hs-varid'>save_rn_syntax</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-602"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-603"></a>    <span class='hs-varid'>dflags</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-604"></a>
<a name="line-605"></a>    <span class='hs-comment'>-- -Wmissing-safe-haskell-mode</span>
<a name="line-606"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeHaskellModeEnabled</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-607"></a>          <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnMissingSafeHaskellMode</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-608"></a>        <span class='hs-varid'>logWarnings</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span>
<a name="line-609"></a>        <span class='hs-varid'>makeIntoWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnMissingSafeHaskellMode</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-610"></a>        <span class='hs-varid'>mkPlainWarnMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hpm_module</span> <span class='hs-varid'>mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-611"></a>        <span class='hs-varid'>warnMissingSafeHaskellMode</span>
<a name="line-612"></a>
<a name="line-613"></a>    <span class='hs-varid'>tcg_res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "Typecheck-Rename" #-}</span>
<a name="line-614"></a>               <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span>
<a name="line-615"></a>                   <span class='hs-varid'>tcRnModule</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>sum</span>
<a name="line-616"></a>                     <span class='hs-varid'>save_rn_syntax</span> <span class='hs-varid'>mod</span>
<a name="line-617"></a>
<a name="line-618"></a>    <span class='hs-comment'>-- See Note [Safe Haskell Overlapping Instances Implementation]</span>
<a name="line-619"></a>    <span class='hs-comment'>-- although this is used for more than just that failure case.</span>
<a name="line-620"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tcSafeOK</span><span class='hs-layout'>,</span> <span class='hs-varid'>whyUnsafe</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_safeInfer</span> <span class='hs-varid'>tcg_res</span><span class='hs-layout'>)</span>
<a name="line-621"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>allSafeOK</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>safeInferred</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>tcSafeOK</span>
<a name="line-622"></a>
<a name="line-623"></a>    <span class='hs-comment'>-- end of the safe haskell line, how to respond to user?</span>
<a name="line-624"></a>    <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeHaskellOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-625"></a>         <span class='hs-varop'>||</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeInferOn</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>allSafeOK</span><span class='hs-layout'>)</span>
<a name="line-626"></a>      <span class='hs-comment'>-- if safe Haskell off or safe infer failed, mark unsafe</span>
<a name="line-627"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>markUnsafeInfer</span> <span class='hs-varid'>tcg_res</span> <span class='hs-varid'>whyUnsafe</span>
<a name="line-628"></a>
<a name="line-629"></a>      <span class='hs-comment'>-- module (could be) safe, throw warning if needed</span>
<a name="line-630"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-631"></a>          <span class='hs-varid'>tcg_res'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscCheckSafeImports</span> <span class='hs-varid'>tcg_res</span>
<a name="line-632"></a>          <span class='hs-keyword'>safe</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_safeInfer</span> <span class='hs-varid'>tcg_res'</span><span class='hs-layout'>)</span>
<a name="line-633"></a>          <span class='hs-varid'>when</span> <span class='hs-keyword'>safe</span> <span class='hs-varop'>$</span>
<a name="line-634"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnSafe</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-635"></a>              <span class='hs-conid'>True</span>
<a name="line-636"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>safeHaskell</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Sf_Safe</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-637"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>logWarnings</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span>
<a name="line-638"></a>                       <span class='hs-varid'>makeIntoWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnSafe</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-639"></a>                       <span class='hs-varid'>mkPlainWarnMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>warnSafeOnLoc</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-640"></a>                       <span class='hs-varid'>errSafe</span> <span class='hs-varid'>tcg_res'</span><span class='hs-layout'>)</span>
<a name="line-641"></a>              <span class='hs-conid'>False</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>safeHaskell</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Sf_Trustworthy</span> <span class='hs-varop'>&amp;&amp;</span>
<a name="line-642"></a>                      <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnTrustworthySafe</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-643"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>logWarnings</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span>
<a name="line-644"></a>                       <span class='hs-varid'>makeIntoWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnTrustworthySafe</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-645"></a>                       <span class='hs-varid'>mkPlainWarnMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>trustworthyOnLoc</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-646"></a>                       <span class='hs-varid'>errTwthySafe</span> <span class='hs-varid'>tcg_res'</span><span class='hs-layout'>)</span>
<a name="line-647"></a>              <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-648"></a>          <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_res'</span>
<a name="line-649"></a>  <span class='hs-keyword'>where</span>
<a name="line-650"></a>    <span class='hs-varid'>pprMod</span> <span class='hs-varid'>t</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>t</span>
<a name="line-651"></a>    <span class='hs-varid'>errSafe</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprMod</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"has been inferred as safe!"</span>
<a name="line-652"></a>    <span class='hs-varid'>errTwthySafe</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprMod</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-653"></a>      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is marked as Trustworthy but has been inferred as safe!"</span>
<a name="line-654"></a>    <span class='hs-varid'>warnMissingSafeHaskellMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod</span> <span class='hs-varid'>sum</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-655"></a>      <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is missing Safe Haskell mode"</span>
<a name="line-656"></a>
<a name="line-657"></a><a name="hscDesugar"></a><span class='hs-comment'>-- | Convert a typechecked module to Core</span>
<a name="line-658"></a><span class='hs-definition'>hscDesugar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModGuts</span>
<a name="line-659"></a><span class='hs-definition'>hscDesugar</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>tc_result</span> <span class='hs-keyglyph'>=</span>
<a name="line-660"></a>    <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscDesugar'</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_location</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_result</span>
<a name="line-661"></a>
<a name="line-662"></a><a name="hscDesugar'"></a><span class='hs-definition'>hscDesugar'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>ModGuts</span>
<a name="line-663"></a><span class='hs-definition'>hscDesugar'</span> <span class='hs-varid'>mod_location</span> <span class='hs-varid'>tc_result</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-664"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-665"></a>    <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span>
<a name="line-666"></a>      <span class='hs-comment'>{-# SCC "deSugar" #-}</span>
<a name="line-667"></a>      <span class='hs-varid'>deSugar</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_location</span> <span class='hs-varid'>tc_result</span>
<a name="line-668"></a>
<a name="line-669"></a>    <span class='hs-comment'>-- always check -Werror after desugaring, this is the last opportunity for</span>
<a name="line-670"></a>    <span class='hs-comment'>-- warnings to arise before the backend.</span>
<a name="line-671"></a>    <span class='hs-varid'>handleWarnings</span>
<a name="line-672"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-673"></a>
<a name="line-674"></a><a name="makeSimpleDetails"></a><span class='hs-comment'>-- | Make a 'ModDetails' from the results of typechecking. Used when</span>
<a name="line-675"></a><span class='hs-comment'>-- typechecking only, as opposed to full compilation.</span>
<a name="line-676"></a><span class='hs-definition'>makeSimpleDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModDetails</span>
<a name="line-677"></a><span class='hs-definition'>makeSimpleDetails</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tc_result</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkBootModDetailsTc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tc_result</span>
<a name="line-678"></a>
<a name="line-679"></a>
<a name="line-680"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-681"></a>%*                                                                      *
<a name="line-682"></a>                The main compiler pipeline
<a name="line-683"></a>%*                                                                      *
<a name="line-684"></a>%********************************************************************* -}</span>
<a name="line-685"></a>
<a name="line-686"></a><span class='hs-comment'>{-
<a name="line-687"></a>                   --------------------------------
<a name="line-688"></a>                        The compilation proper
<a name="line-689"></a>                   --------------------------------
<a name="line-690"></a>
<a name="line-691"></a>It's the task of the compilation proper to compile Haskell, hs-boot and core
<a name="line-692"></a>files to either byte-code, hard-code (C, asm, LLVM, etc.) or to nothing at all
<a name="line-693"></a>(the module is still parsed and type-checked. This feature is mostly used by
<a name="line-694"></a>IDE's and the likes). Compilation can happen in either 'one-shot', 'batch',
<a name="line-695"></a>'nothing', or 'interactive' mode. 'One-shot' mode targets hard-code, 'batch'
<a name="line-696"></a>mode targets hard-code, 'nothing' mode targets nothing and 'interactive' mode
<a name="line-697"></a>targets byte-code.
<a name="line-698"></a>
<a name="line-699"></a>The modes are kept separate because of their different types and meanings:
<a name="line-700"></a>
<a name="line-701"></a> * In 'one-shot' mode, we're only compiling a single file and can therefore
<a name="line-702"></a> discard the new ModIface and ModDetails. This is also the reason it only
<a name="line-703"></a> targets hard-code; compiling to byte-code or nothing doesn't make sense when
<a name="line-704"></a> we discard the result.
<a name="line-705"></a>
<a name="line-706"></a> * 'Batch' mode is like 'one-shot' except that we keep the resulting ModIface
<a name="line-707"></a> and ModDetails. 'Batch' mode doesn't target byte-code since that require us to
<a name="line-708"></a> return the newly compiled byte-code.
<a name="line-709"></a>
<a name="line-710"></a> * 'Nothing' mode has exactly the same type as 'batch' mode but they're still
<a name="line-711"></a> kept separate. This is because compiling to nothing is fairly special: We
<a name="line-712"></a> don't output any interface files, we don't run the simplifier and we don't
<a name="line-713"></a> generate any code.
<a name="line-714"></a>
<a name="line-715"></a> * 'Interactive' mode is similar to 'batch' mode except that we return the
<a name="line-716"></a> compiled byte-code together with the ModIface and ModDetails.
<a name="line-717"></a>
<a name="line-718"></a>Trying to compile a hs-boot file to byte-code will result in a run-time error.
<a name="line-719"></a>This is the only thing that isn't caught by the type-system.
<a name="line-720"></a>-}</span>
<a name="line-721"></a>
<a name="line-722"></a>
<a name="line-723"></a><a name="Messager"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Messager</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecompileRequired</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModuleGraphNode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-724"></a>
<a name="line-725"></a><a name="hscIncrementalFrontend"></a><span class='hs-comment'>-- | This function runs GHC's frontend with recompilation</span>
<a name="line-726"></a><span class='hs-comment'>-- avoidance. Specifically, it checks if recompilation is needed,</span>
<a name="line-727"></a><span class='hs-comment'>-- and if it is, it parses and typechecks the input module.</span>
<a name="line-728"></a><span class='hs-comment'>-- It does not write out the results of typechecking (See</span>
<a name="line-729"></a><span class='hs-comment'>-- compileOne and hscIncrementalCompile).</span>
<a name="line-730"></a><span class='hs-definition'>hscIncrementalFrontend</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-comment'>-- always do basic recompilation check?</span>
<a name="line-731"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-732"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span>
<a name="line-733"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span>
<a name="line-734"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SourceModified</span>
<a name="line-735"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span>  <span class='hs-comment'>-- Old interface, if available</span>
<a name="line-736"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- (i,n) = module i of n (for msgs)</span>
<a name="line-737"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Either</span> <span class='hs-conid'>ModIface</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrontendResult</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-738"></a>
<a name="line-739"></a><span class='hs-definition'>hscIncrementalFrontend</span>
<a name="line-740"></a>  <span class='hs-varid'>always_do_basic_recompilation_check</span> <span class='hs-varid'>m_tc_result</span>
<a name="line-741"></a>  <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>source_modified</span> <span class='hs-varid'>mb_old_iface</span> <span class='hs-varid'>mod_index</span>
<a name="line-742"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-743"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-744"></a>
<a name="line-745"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>what</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mHscMessage</span> <span class='hs-keyword'>of</span>
<a name="line-746"></a>          <span class='hs-comment'>-- We use extendModSummaryNoDeps because extra backpack deps are only needed for batch mode</span>
<a name="line-747"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>hscMessage</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hscMessage</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>what</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModuleNode</span> <span class='hs-layout'>(</span><span class='hs-varid'>extendModSummaryNoDeps</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-748"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-749"></a>
<a name="line-750"></a>        <span class='hs-varid'>skip</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-751"></a>            <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span> <span class='hs-conid'>UpToDate</span>
<a name="line-752"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-varid'>iface</span>
<a name="line-753"></a>
<a name="line-754"></a>        <span class='hs-varid'>compile</span> <span class='hs-varid'>mb_old_hash</span> <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-755"></a>            <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>reason</span>
<a name="line-756"></a>            <span class='hs-varid'>tc_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hscFrontendHook</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_hooks</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-757"></a>              <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FrontendTypecheck</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>hsc_typecheck</span> <span class='hs-conid'>False</span> <span class='hs-varid'>mod_summary</span> <span class='hs-conid'>Nothing</span>
<a name="line-758"></a>              <span class='hs-conid'>Just</span> <span class='hs-varid'>h</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span> <span class='hs-varid'>mod_summary</span>
<a name="line-759"></a>            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_result</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_old_hash</span><span class='hs-layout'>)</span>
<a name="line-760"></a>
<a name="line-761"></a>        <span class='hs-varid'>stable</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>source_modified</span> <span class='hs-keyword'>of</span>
<a name="line-762"></a>                     <span class='hs-conid'>SourceUnmodifiedAndStable</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-763"></a>                     <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-764"></a>
<a name="line-765"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>m_tc_result</span> <span class='hs-keyword'>of</span>
<a name="line-766"></a>         <span class='hs-conid'>Just</span> <span class='hs-varid'>tc_result</span>
<a name="line-767"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>always_do_basic_recompilation_check</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-768"></a>             <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrontendTypecheck</span> <span class='hs-varid'>tc_result</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-769"></a>         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-770"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>recomp_reqd</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_checked_iface</span><span class='hs-layout'>)</span>
<a name="line-771"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "checkOldIface" #-}</span>
<a name="line-772"></a>                   <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkOldIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span>
<a name="line-773"></a>                                <span class='hs-varid'>source_modified</span> <span class='hs-varid'>mb_old_iface</span>
<a name="line-774"></a>            <span class='hs-comment'>-- save the interface that comes back from checkOldIface.</span>
<a name="line-775"></a>            <span class='hs-comment'>-- In one-shot mode we don't have the old iface until this</span>
<a name="line-776"></a>            <span class='hs-comment'>-- point, when checkOldIface reads it from the disk.</span>
<a name="line-777"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>mb_old_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_iface_hash</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mi_final_exts</span><span class='hs-layout'>)</span> <span class='hs-varid'>mb_checked_iface</span>
<a name="line-778"></a>
<a name="line-779"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_checked_iface</span> <span class='hs-keyword'>of</span>
<a name="line-780"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>recompileRequired</span> <span class='hs-varid'>recomp_reqd</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-781"></a>                    <span class='hs-comment'>-- If the module used TH splices when it was last</span>
<a name="line-782"></a>                    <span class='hs-comment'>-- compiled, then the recompilation check is not</span>
<a name="line-783"></a>                    <span class='hs-comment'>-- accurate enough (#481) and we must ignore</span>
<a name="line-784"></a>                    <span class='hs-comment'>-- it.  However, if the module is stable (none of</span>
<a name="line-785"></a>                    <span class='hs-comment'>-- the modules it depends on, directly or</span>
<a name="line-786"></a>                    <span class='hs-comment'>-- indirectly, changed), then we *can* skip</span>
<a name="line-787"></a>                    <span class='hs-comment'>-- recompilation. This is why the SourceModified</span>
<a name="line-788"></a>                    <span class='hs-comment'>-- type contains SourceUnmodifiedAndStable, and</span>
<a name="line-789"></a>                    <span class='hs-comment'>-- it's pretty important: otherwise ghc --make</span>
<a name="line-790"></a>                    <span class='hs-comment'>-- would always recompile TH modules, even if</span>
<a name="line-791"></a>                    <span class='hs-comment'>-- nothing at all has changed. Stability is just</span>
<a name="line-792"></a>                    <span class='hs-comment'>-- the same check that make is doing for us in</span>
<a name="line-793"></a>                    <span class='hs-comment'>-- one-shot mode.</span>
<a name="line-794"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>m_tc_result</span> <span class='hs-keyword'>of</span>
<a name="line-795"></a>                    <span class='hs-conid'>Nothing</span>
<a name="line-796"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>mi_used_th</span> <span class='hs-varid'>iface</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-varid'>stable</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-797"></a>                        <span class='hs-varid'>compile</span> <span class='hs-varid'>mb_old_hash</span> <span class='hs-layout'>(</span><span class='hs-conid'>RecompBecause</span> <span class='hs-str'>"TH"</span><span class='hs-layout'>)</span>
<a name="line-798"></a>                    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-799"></a>                        <span class='hs-varid'>skip</span> <span class='hs-varid'>iface</span>
<a name="line-800"></a>                <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-801"></a>                    <span class='hs-keyword'>case</span> <span class='hs-varid'>m_tc_result</span> <span class='hs-keyword'>of</span>
<a name="line-802"></a>                    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>compile</span> <span class='hs-varid'>mb_old_hash</span> <span class='hs-varid'>recomp_reqd</span>
<a name="line-803"></a>                    <span class='hs-conid'>Just</span> <span class='hs-varid'>tc_result</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-804"></a>                        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrontendTypecheck</span> <span class='hs-varid'>tc_result</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_old_hash</span><span class='hs-layout'>)</span>
<a name="line-805"></a>
<a name="line-806"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-807"></a><span class='hs-comment'>-- Compilers</span>
<a name="line-808"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-809"></a>
<a name="line-810"></a><a name="hscIncrementalCompile"></a><span class='hs-comment'>-- | Used by both OneShot and batch mode. Runs the pipeline HsSyn and Core parts</span>
<a name="line-811"></a><span class='hs-comment'>-- of the pipeline.</span>
<a name="line-812"></a><span class='hs-comment'>-- We return a interface if we already had an old one around and recompilation</span>
<a name="line-813"></a><span class='hs-comment'>-- was not needed. Otherwise it will be created during later passes when we</span>
<a name="line-814"></a><span class='hs-comment'>-- run the compilation pipeline.</span>
<a name="line-815"></a><span class='hs-definition'>hscIncrementalCompile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-816"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-817"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Messager</span>
<a name="line-818"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscEnv</span>
<a name="line-819"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span>
<a name="line-820"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SourceModified</span>
<a name="line-821"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span>
<a name="line-822"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span><span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-823"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>HscStatus</span><span class='hs-layout'>,</span> <span class='hs-conid'>HscEnv</span><span class='hs-layout'>)</span>
<a name="line-824"></a><span class='hs-definition'>hscIncrementalCompile</span> <span class='hs-varid'>always_do_basic_recompilation_check</span> <span class='hs-varid'>m_tc_result</span>
<a name="line-825"></a>    <span class='hs-varid'>mHscMessage</span> <span class='hs-varid'>hsc_env'</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>source_modified</span> <span class='hs-varid'>mb_old_iface</span> <span class='hs-varid'>mod_index</span>
<a name="line-826"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-827"></a>    <span class='hs-varid'>hsc_env''</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>initializePlugins</span> <span class='hs-varid'>hsc_env'</span>
<a name="line-828"></a>
<a name="line-829"></a>    <span class='hs-comment'>-- One-shot mode needs a knot-tying mutable variable for interface</span>
<a name="line-830"></a>    <span class='hs-comment'>-- files. See GHC.Tc.Utils.TcGblEnv.tcg_type_env_var.</span>
<a name="line-831"></a>    <span class='hs-comment'>-- See also Note [hsc_type_env_var hack]</span>
<a name="line-832"></a>    <span class='hs-varid'>type_env_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-varid'>emptyNameEnv</span>
<a name="line-833"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>mod_summary</span>
<a name="line-834"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isOneShot</span> <span class='hs-layout'>(</span><span class='hs-varid'>ghcMode</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env''</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-835"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env''</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_type_env_var</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mod</span><span class='hs-layout'>,</span> <span class='hs-varid'>type_env_var</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-836"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-837"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_env''</span>
<a name="line-838"></a>
<a name="line-839"></a>    <span class='hs-comment'>-- NB: enter Hsc monad here so that we don't bail out early with</span>
<a name="line-840"></a>    <span class='hs-comment'>-- -Werror on typechecker warnings; we also want to run the desugarer</span>
<a name="line-841"></a>    <span class='hs-comment'>-- to get those warnings too. (But we'll always exit at that point</span>
<a name="line-842"></a>    <span class='hs-comment'>-- because the desugarer runs ioMsgMaybe.)</span>
<a name="line-843"></a>    <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-844"></a>    <span class='hs-varid'>e</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscIncrementalFrontend</span> <span class='hs-varid'>always_do_basic_recompilation_check</span> <span class='hs-varid'>m_tc_result</span> <span class='hs-varid'>mHscMessage</span>
<a name="line-845"></a>            <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>source_modified</span> <span class='hs-varid'>mb_old_iface</span> <span class='hs-varid'>mod_index</span>
<a name="line-846"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>of</span>
<a name="line-847"></a>        <span class='hs-comment'>-- We didn't need to do any typechecking; the old interface</span>
<a name="line-848"></a>        <span class='hs-comment'>-- file on disk was good enough.</span>
<a name="line-849"></a>        <span class='hs-conid'>Left</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-850"></a>            <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initModDetails</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>iface</span>
<a name="line-851"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>HscUpToDate</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>details</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsc_env'</span><span class='hs-layout'>)</span>
<a name="line-852"></a>        <span class='hs-comment'>-- We finished type checking.  (mb_old_hash is the hash of</span>
<a name="line-853"></a>        <span class='hs-comment'>-- the interface that existed on disk; it's possible we had</span>
<a name="line-854"></a>        <span class='hs-comment'>-- to retypecheck but the resulting interface is exactly</span>
<a name="line-855"></a>        <span class='hs-comment'>-- the same.)</span>
<a name="line-856"></a>        <span class='hs-conid'>Right</span> <span class='hs-layout'>(</span><span class='hs-conid'>FrontendTypecheck</span> <span class='hs-varid'>tc_result</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_old_hash</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-857"></a>            <span class='hs-varid'>status</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>finish</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>tc_result</span> <span class='hs-varid'>mb_old_hash</span>
<a name="line-858"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>status</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-859"></a>
<a name="line-860"></a><a name="initModDetails"></a><span class='hs-comment'>-- Knot tying!  See Note [Knot-tying typecheckIface]</span>
<a name="line-861"></a><span class='hs-comment'>-- See Note [ModDetails and --make mode]</span>
<a name="line-862"></a><span class='hs-definition'>initModDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModSummary</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModDetails</span>
<a name="line-863"></a><span class='hs-definition'>initModDetails</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_summary</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span>
<a name="line-864"></a>  <span class='hs-varid'>fixIO</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>details'</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-865"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>hsc_env'</span> <span class='hs-keyglyph'>=</span>
<a name="line-866"></a>          <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>{</span>
<a name="line-867"></a>              <span class='hs-varid'>hsc_HPT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addToHpt</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-868"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>ms_mod_name</span> <span class='hs-varid'>mod_summary</span><span class='hs-layout'>)</span>
<a name="line-869"></a>                          <span class='hs-layout'>(</span><span class='hs-conid'>HomeModInfo</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>details'</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-870"></a>                  <span class='hs-layout'>}</span>
<a name="line-871"></a>    <span class='hs-comment'>-- NB: This result is actually not that useful</span>
<a name="line-872"></a>    <span class='hs-comment'>-- in one-shot mode, since we're not going to do</span>
<a name="line-873"></a>    <span class='hs-comment'>-- any further typechecking.  It's much more useful</span>
<a name="line-874"></a>    <span class='hs-comment'>-- in make mode, since this HMI will go into the HPT.</span>
<a name="line-875"></a>    <span class='hs-varid'>genModDetails</span> <span class='hs-varid'>hsc_env'</span> <span class='hs-varid'>iface</span>
<a name="line-876"></a>
<a name="line-877"></a>
<a name="line-878"></a><span class='hs-comment'>{-
<a name="line-879"></a>Note [ModDetails and --make mode]
<a name="line-880"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-881"></a>
<a name="line-882"></a>An interface file consists of two parts
<a name="line-883"></a>
<a name="line-884"></a>* The `ModIface` which ends up getting written to disk.
<a name="line-885"></a>  The `ModIface` is a completely acyclic tree, which can be serialised
<a name="line-886"></a>  and de-serialised completely straightforwardly.  The `ModIface` is
<a name="line-887"></a>  also the structure that is finger-printed for recompilation control.
<a name="line-888"></a>
<a name="line-889"></a>* The `ModDetails` which provides a more structured view that is suitable
<a name="line-890"></a>  for usage during compilation.  The `ModDetails` is heavily cyclic:
<a name="line-891"></a>  An `Id` contains a `Type`, which mentions a `TyCon` that contains kind
<a name="line-892"></a>  that mentions other `TyCons`; the `Id` also includes an unfolding that
<a name="line-893"></a>  in turn mentions more `Id`s;  And so on.
<a name="line-894"></a>
<a name="line-895"></a>The `ModIface` can be created from the `ModDetails` and the `ModDetails` from
<a name="line-896"></a>a `ModIface`.
<a name="line-897"></a>
<a name="line-898"></a>During tidying, just before interfaces are written to disk,
<a name="line-899"></a>the ModDetails is calculated and then converted into a ModIface (see GHC.Iface.Make.mkIface_).
<a name="line-900"></a>Then when GHC needs to restart typechecking from a certain point it can read the
<a name="line-901"></a>interface file, and regenerate the ModDetails from the ModIface (see GHC.IfaceToCore.typecheckIface).
<a name="line-902"></a>The key part about the loading is that the ModDetails is regenerated lazily
<a name="line-903"></a>from the ModIface, so that there's only a detailed in-memory representation
<a name="line-904"></a>for declarations which are actually used from the interface. This mode is
<a name="line-905"></a>also used when reading interface files from external packages.
<a name="line-906"></a>
<a name="line-907"></a>In the old --make mode implementation, the interface was written after compiling a module
<a name="line-908"></a>but the in-memory ModDetails which was used to compute the ModIface was retained.
<a name="line-909"></a>The result was that --make mode used much more memory than `-c` mode, because a large amount of
<a name="line-910"></a>information about a module would be kept in the ModDetails but never used.
<a name="line-911"></a>
<a name="line-912"></a>The new idea is that even in `--make` mode, when there is an in-memory `ModDetails`
<a name="line-913"></a>at hand, we re-create the `ModDetails` from the `ModIface`. Doing this means that
<a name="line-914"></a>we only have to keep the `ModIface` decls in memory and then lazily load
<a name="line-915"></a>detailed representations if needed. It turns out this makes a really big difference
<a name="line-916"></a>to memory usage, halving maximum memory used in some cases.
<a name="line-917"></a>
<a name="line-918"></a>See !5492 and #13586
<a name="line-919"></a>-}</span>
<a name="line-920"></a>
<a name="line-921"></a><a name="finish"></a><span class='hs-comment'>-- Runs the post-typechecking frontend (desugar and simplify). We want to</span>
<a name="line-922"></a><span class='hs-comment'>-- generate most of the interface as late as possible. This gets us up-to-date</span>
<a name="line-923"></a><span class='hs-comment'>-- and good unfoldings and other info in the interface file.</span>
<a name="line-924"></a><span class='hs-comment'>--</span>
<a name="line-925"></a><span class='hs-comment'>-- We might create a interface right away, in which case we also return the</span>
<a name="line-926"></a><span class='hs-comment'>-- updated HomeModInfo. But we might also need to run the backend first. In the</span>
<a name="line-927"></a><span class='hs-comment'>-- later case Status will be HscRecomp and we return a function from ModIface -&gt;</span>
<a name="line-928"></a><span class='hs-comment'>-- HomeModInfo.</span>
<a name="line-929"></a><span class='hs-comment'>--</span>
<a name="line-930"></a><span class='hs-comment'>-- HscRecomp in turn will carry the information required to compute a interface</span>
<a name="line-931"></a><span class='hs-comment'>-- when passed the result of the code generator. So all this can and is done at</span>
<a name="line-932"></a><span class='hs-comment'>-- the call site of the backend code gen if it is run.</span>
<a name="line-933"></a><span class='hs-definition'>finish</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ModSummary</span>
<a name="line-934"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-935"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-936"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>HscStatus</span>
<a name="line-937"></a><span class='hs-definition'>finish</span> <span class='hs-varid'>summary</span> <span class='hs-varid'>tc_result</span> <span class='hs-varid'>mb_old_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-938"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-939"></a>  <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-940"></a>  <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-941"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>bcknd</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>backend</span> <span class='hs-varid'>dflags</span>
<a name="line-942"></a>      <span class='hs-varid'>hsc_src</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_hsc_src</span> <span class='hs-varid'>summary</span>
<a name="line-943"></a>
<a name="line-944"></a>  <span class='hs-comment'>-- Desugar, if appropriate</span>
<a name="line-945"></a>  <span class='hs-comment'>--</span>
<a name="line-946"></a>  <span class='hs-comment'>-- We usually desugar even when we are not generating code, otherwise we</span>
<a name="line-947"></a>  <span class='hs-comment'>-- would miss errors thrown by the desugaring (see #10600). The only</span>
<a name="line-948"></a>  <span class='hs-comment'>-- exceptions are when the Module is Ghc.Prim or when it is not a</span>
<a name="line-949"></a>  <span class='hs-comment'>-- HsSrcFile Module.</span>
<a name="line-950"></a>  <span class='hs-varid'>mb_desugar</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-951"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>ms_mod</span> <span class='hs-varid'>summary</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>gHC_PRIM</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>hsc_src</span> <span class='hs-varop'>==</span> <span class='hs-conid'>HsSrcFile</span>
<a name="line-952"></a>      <span class='hs-keyword'>then</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>hscDesugar'</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_location</span> <span class='hs-varid'>summary</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_result</span>
<a name="line-953"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>Nothing</span>
<a name="line-954"></a>
<a name="line-955"></a>  <span class='hs-comment'>-- Simplify, if appropriate, and (whether we simplified or not) generate an</span>
<a name="line-956"></a>  <span class='hs-comment'>-- interface file.</span>
<a name="line-957"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_desugar</span> <span class='hs-keyword'>of</span>
<a name="line-958"></a>      <span class='hs-comment'>-- Just cause we desugared doesn't mean we are generating code, see above.</span>
<a name="line-959"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>desugared_guts</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>bcknd</span> <span class='hs-varop'>/=</span> <span class='hs-conid'>NoBackend</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-960"></a>          <span class='hs-varid'>plugins</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_coreplugins</span> <span class='hs-varid'>tc_result</span><span class='hs-layout'>)</span>
<a name="line-961"></a>          <span class='hs-varid'>simplified_guts</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscSimplify'</span> <span class='hs-varid'>plugins</span> <span class='hs-varid'>desugared_guts</span>
<a name="line-962"></a>
<a name="line-963"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>cg_guts</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "CoreTidy" #-}</span>
<a name="line-964"></a>              <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tidyProgram</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>simplified_guts</span>
<a name="line-965"></a>
<a name="line-966"></a>          <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>partial_iface</span> <span class='hs-keyglyph'>=</span>
<a name="line-967"></a>                <span class='hs-comment'>{-# SCC "GHC.Driver.Main.mkPartialIface" #-}</span>
<a name="line-968"></a>                <span class='hs-comment'>-- This `force` saves 2M residency in test T10370</span>
<a name="line-969"></a>                <span class='hs-comment'>-- See Note [Avoiding space leaks in toIface*] for details.</span>
<a name="line-970"></a>                <span class='hs-varid'>force</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPartialIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>details</span> <span class='hs-varid'>simplified_guts</span><span class='hs-layout'>)</span>
<a name="line-971"></a>
<a name="line-972"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>HscRecomp</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hscs_guts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cg_guts</span><span class='hs-layout'>,</span>
<a name="line-973"></a>                             <span class='hs-varid'>hscs_mod_location</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ms_location</span> <span class='hs-varid'>summary</span><span class='hs-layout'>,</span>
<a name="line-974"></a>                             <span class='hs-varid'>hscs_partial_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partial_iface</span><span class='hs-layout'>,</span>
<a name="line-975"></a>                             <span class='hs-varid'>hscs_old_iface_hash</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mb_old_hash</span>
<a name="line-976"></a>                           <span class='hs-layout'>}</span>
<a name="line-977"></a>
<a name="line-978"></a>      <span class='hs-comment'>-- We are not generating code, so we can skip simplification</span>
<a name="line-979"></a>      <span class='hs-comment'>-- and generate a simple interface.</span>
<a name="line-980"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-981"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_old_iface_hash</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-982"></a>          <span class='hs-varid'>hscSimpleIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tc_result</span> <span class='hs-varid'>mb_old_hash</span>
<a name="line-983"></a>
<a name="line-984"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscMaybeWriteIface</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>True</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>mb_old_iface_hash</span> <span class='hs-layout'>(</span><span class='hs-varid'>ms_location</span> <span class='hs-varid'>summary</span><span class='hs-layout'>)</span>
<a name="line-985"></a>
<a name="line-986"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bcknd</span> <span class='hs-keyword'>of</span>
<a name="line-987"></a>          <span class='hs-conid'>NoBackend</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscNotGeneratingCode</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>details</span>
<a name="line-988"></a>          <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hsc_src</span> <span class='hs-keyword'>of</span>
<a name="line-989"></a>                        <span class='hs-conid'>HsBootFile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscUpdateBoot</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>details</span>
<a name="line-990"></a>                        <span class='hs-conid'>HsigFile</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HscUpdateSig</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>details</span>
<a name="line-991"></a>                        <span class='hs-keyword'>_</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"finish"</span>
<a name="line-992"></a>
<a name="line-993"></a><span class='hs-comment'>{-
<a name="line-994"></a>Note [Writing interface files]
<a name="line-995"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-996"></a>
<a name="line-997"></a>We write one interface file per module and per compilation, except with
<a name="line-998"></a>-dynamic-too where we write two interface files (non-dynamic and dynamic).
<a name="line-999"></a>
<a name="line-1000"></a>We can write two kinds of interfaces (see Note [Interface file stages] in
<a name="line-1001"></a>"GHC.Driver.Types"):
<a name="line-1002"></a>
<a name="line-1003"></a>   * simple interface: interface generated after the core pipeline
<a name="line-1004"></a>
<a name="line-1005"></a>   * full interface: simple interface completed with information from the
<a name="line-1006"></a>     backend
<a name="line-1007"></a>
<a name="line-1008"></a>Depending on the situation, we write one or the other (using
<a name="line-1009"></a>`hscMaybeWriteIface`). We must be careful with `-dynamic-too` because only the
<a name="line-1010"></a>backend is run twice, so if we write a simple interface we need to write both
<a name="line-1011"></a>the non-dynamic and the dynamic interfaces at the same time (with the same
<a name="line-1012"></a>contents).
<a name="line-1013"></a>
<a name="line-1014"></a>Cases for which we generate simple interfaces:
<a name="line-1015"></a>
<a name="line-1016"></a>   * GHC.Driver.Main.finish: when a compilation does NOT require (re)compilation
<a name="line-1017"></a>   of the hard code
<a name="line-1018"></a>
<a name="line-1019"></a>   * GHC.Driver.Pipeline.compileOne': when we run in One Shot mode and target
<a name="line-1020"></a>   bytecode (if interface writing is forced).
<a name="line-1021"></a>
<a name="line-1022"></a>   * GHC.Driver.Backpack uses simple interfaces for indefinite units
<a name="line-1023"></a>   (units with module holes). It writes them indirectly by forcing the
<a name="line-1024"></a>   -fwrite-interface flag while setting backend to NoBackend.
<a name="line-1025"></a>
<a name="line-1026"></a>Cases for which we generate full interfaces:
<a name="line-1027"></a>
<a name="line-1028"></a>   * GHC.Driver.Pipeline.runPhase: when we must be compiling to regular hard
<a name="line-1029"></a>   code and/or require recompilation.
<a name="line-1030"></a>
<a name="line-1031"></a>By default interface file names are derived from module file names by adding
<a name="line-1032"></a>suffixes. The interface file name can be overloaded with "-ohi", except when
<a name="line-1033"></a>`-dynamic-too` is used.
<a name="line-1034"></a>
<a name="line-1035"></a>-}</span>
<a name="line-1036"></a>
<a name="line-1037"></a><a name="hscMaybeWriteIface"></a><span class='hs-comment'>-- | Write interface files</span>
<a name="line-1038"></a><span class='hs-definition'>hscMaybeWriteIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1039"></a><span class='hs-definition'>hscMaybeWriteIface</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>is_simple</span> <span class='hs-varid'>iface</span> <span class='hs-varid'>old_iface</span> <span class='hs-varid'>mod_location</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1040"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>force_write_interface</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gopt</span> <span class='hs-conid'>Opt_WriteInterface</span> <span class='hs-varid'>dflags</span>
<a name="line-1041"></a>        <span class='hs-varid'>write_interface</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>backend</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-1042"></a>                            <span class='hs-conid'>NoBackend</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1043"></a>                            <span class='hs-conid'>Interpreter</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-1044"></a>                            <span class='hs-keyword'>_</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1045"></a>
<a name="line-1046"></a>      <span class='hs-comment'>-- mod_location only contains the base name, so we rebuild the</span>
<a name="line-1047"></a>      <span class='hs-comment'>-- correct file extension from the dynflags.</span>
<a name="line-1048"></a>        <span class='hs-varid'>baseName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ml_hi_file</span> <span class='hs-varid'>mod_location</span>
<a name="line-1049"></a>        <span class='hs-varid'>buildIfName</span> <span class='hs-varid'>suffix</span> <span class='hs-varid'>is_dynamic</span>
<a name="line-1050"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>is_dynamic</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>dynOutputHi</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>outputHi</span><span class='hs-layout'>)</span> <span class='hs-varid'>dflags</span>
<a name="line-1051"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-1052"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1053"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>with_hi</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>replaceExtension</span> <span class='hs-varid'>baseName</span> <span class='hs-varid'>suffix</span>
<a name="line-1054"></a>            <span class='hs-keyword'>in</span>  <span class='hs-varid'>addBootSuffix_maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_boot</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span> <span class='hs-varid'>with_hi</span>
<a name="line-1055"></a>
<a name="line-1056"></a>        <span class='hs-varid'>write_iface</span> <span class='hs-varid'>dflags'</span> <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>=</span>
<a name="line-1057"></a>          <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-varid'>iface_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>buildIfName</span> <span class='hs-layout'>(</span><span class='hs-varid'>hiSuf</span> <span class='hs-varid'>dflags'</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>dynamicNow</span> <span class='hs-varid'>dflags'</span><span class='hs-layout'>)</span>
<a name="line-1058"></a>          <span class='hs-keyword'>in</span>
<a name="line-1059"></a>          <span class='hs-comment'>{-# SCC "writeIface" #-}</span>
<a name="line-1060"></a>          <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags'</span>
<a name="line-1061"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"WriteIface"</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>iface_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1062"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1063"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>writeIface</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags'</span> <span class='hs-varid'>iface_name</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span>
<a name="line-1064"></a>
<a name="line-1065"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>write_interface</span> <span class='hs-varop'>||</span> <span class='hs-varid'>force_write_interface</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1066"></a>
<a name="line-1067"></a>      <span class='hs-comment'>-- FIXME: with -dynamic-too, "no_change" is only meaningful for the</span>
<a name="line-1068"></a>      <span class='hs-comment'>-- non-dynamic interface, not for the dynamic one. We should have another</span>
<a name="line-1069"></a>      <span class='hs-comment'>-- flag for the dynamic interface. In the meantime:</span>
<a name="line-1070"></a>      <span class='hs-comment'>--</span>
<a name="line-1071"></a>      <span class='hs-comment'>--    * when we write a single full interface, we check if we are</span>
<a name="line-1072"></a>      <span class='hs-comment'>--    currently writing the dynamic interface due to -dynamic-too, in</span>
<a name="line-1073"></a>      <span class='hs-comment'>--    which case we ignore "no_change".</span>
<a name="line-1074"></a>      <span class='hs-comment'>--</span>
<a name="line-1075"></a>      <span class='hs-comment'>--    * when we write two simple interfaces at once because of</span>
<a name="line-1076"></a>      <span class='hs-comment'>--    dynamic-too, we use "no_change" both for the non-dynamic and the</span>
<a name="line-1077"></a>      <span class='hs-comment'>--    dynamic interfaces. Hopefully both the dynamic and the non-dynamic</span>
<a name="line-1078"></a>      <span class='hs-comment'>--    interfaces stay in sync...</span>
<a name="line-1079"></a>      <span class='hs-comment'>--</span>
<a name="line-1080"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>no_change</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>old_iface</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_iface_hash</span> <span class='hs-layout'>(</span><span class='hs-varid'>mi_final_exts</span> <span class='hs-varid'>iface</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1081"></a>
<a name="line-1082"></a>      <span class='hs-varid'>dt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>dynamicTooState</span> <span class='hs-varid'>dflags</span>
<a name="line-1083"></a>
<a name="line-1084"></a>      <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_if_trace</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-1085"></a>        <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Writing interface(s):"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-1086"></a>         <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Kind:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>is_simple</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"simple"</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>text</span> <span class='hs-str'>"full"</span>
<a name="line-1087"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Hash change:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>no_change</span><span class='hs-layout'>)</span>
<a name="line-1088"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"DynamicToo state:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>dt</span><span class='hs-layout'>)</span>
<a name="line-1089"></a>         <span class='hs-keyglyph'>]</span>
<a name="line-1090"></a>
<a name="line-1091"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>is_simple</span>
<a name="line-1092"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>unless</span> <span class='hs-varid'>no_change</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span> <span class='hs-comment'>-- FIXME: see no_change' comment above</span>
<a name="line-1093"></a>            <span class='hs-varid'>write_iface</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>iface</span>
<a name="line-1094"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>dt</span> <span class='hs-keyword'>of</span>
<a name="line-1095"></a>               <span class='hs-conid'>DT_Dont</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1096"></a>               <span class='hs-conid'>DT_Failed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1097"></a>               <span class='hs-conid'>DT_Dyn</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"Unexpected DT_Dyn state when writing simple interface"</span>
<a name="line-1098"></a>               <span class='hs-conid'>DT_OK</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>write_iface</span> <span class='hs-layout'>(</span><span class='hs-varid'>setDynamicNow</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>iface</span>
<a name="line-1099"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dt</span> <span class='hs-keyword'>of</span>
<a name="line-1100"></a>               <span class='hs-conid'>DT_Dont</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>no_change</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>write_iface</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>iface</span>
<a name="line-1101"></a>               <span class='hs-conid'>DT_OK</span>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>no_change</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>write_iface</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>iface</span>
<a name="line-1102"></a>               <span class='hs-comment'>-- FIXME: see no_change' comment above</span>
<a name="line-1103"></a>               <span class='hs-conid'>DT_Dyn</span>                              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>write_iface</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>iface</span>
<a name="line-1104"></a>               <span class='hs-conid'>DT_Failed</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>dynamicNow</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>write_iface</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>iface</span>
<a name="line-1105"></a>               <span class='hs-keyword'>_</span>                                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1106"></a>
<a name="line-1107"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1108"></a><span class='hs-comment'>-- NoRecomp handlers</span>
<a name="line-1109"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1110"></a>
<a name="line-1111"></a><a name="genModDetails"></a><span class='hs-comment'>-- NB: this must be knot-tied appropriately, see hscIncrementalCompile</span>
<a name="line-1112"></a><span class='hs-definition'>genModDetails</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModIface</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModDetails</span>
<a name="line-1113"></a><span class='hs-definition'>genModDetails</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>old_iface</span>
<a name="line-1114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1115"></a>    <span class='hs-varid'>new_details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "tcRnIface" #-}</span>
<a name="line-1116"></a>                   <span class='hs-varid'>initIfaceLoad</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>typecheckIface</span> <span class='hs-varid'>old_iface</span><span class='hs-layout'>)</span>
<a name="line-1117"></a>    <span class='hs-varid'>dumpIfaceStats</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1118"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>new_details</span>
<a name="line-1119"></a>
<a name="line-1120"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1121"></a><span class='hs-comment'>-- Progress displayers.</span>
<a name="line-1122"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1123"></a>
<a name="line-1124"></a><a name="oneShotMsg"></a><span class='hs-definition'>oneShotMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RecompileRequired</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-1125"></a><span class='hs-definition'>oneShotMsg</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>recomp</span> <span class='hs-keyglyph'>=</span>
<a name="line-1126"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>recomp</span> <span class='hs-keyword'>of</span>
<a name="line-1127"></a>        <span class='hs-conid'>UpToDate</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1128"></a>            <span class='hs-varid'>compilationProgressMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-1129"></a>                   <span class='hs-varid'>text</span> <span class='hs-str'>"compilation IS NOT required"</span>
<a name="line-1130"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1131"></a>            <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1132"></a>    <span class='hs-keyword'>where</span>
<a name="line-1133"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1134"></a>        <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1135"></a>
<a name="line-1136"></a><a name="batchMsg"></a><span class='hs-definition'>batchMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Messager</span>
<a name="line-1137"></a><span class='hs-definition'>batchMsg</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mod_index</span> <span class='hs-varid'>recomp</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>node</span> <span class='hs-keyword'>of</span>
<a name="line-1138"></a>    <span class='hs-conid'>InstantiationNode</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1139"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>recomp</span> <span class='hs-keyword'>of</span>
<a name="line-1140"></a>            <span class='hs-conid'>MustCompile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>showMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Instantiating "</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span>
<a name="line-1141"></a>            <span class='hs-conid'>UpToDate</span>
<a name="line-1142"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>showMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Skipping  "</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span>
<a name="line-1143"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1144"></a>            <span class='hs-conid'>RecompBecause</span> <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>showMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Instantiating "</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>" ["</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>reason</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"]"</span><span class='hs-layout'>)</span>
<a name="line-1145"></a>    <span class='hs-conid'>ModuleNode</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1146"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>recomp</span> <span class='hs-keyword'>of</span>
<a name="line-1147"></a>            <span class='hs-conid'>MustCompile</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>showMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Compiling "</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span>
<a name="line-1148"></a>            <span class='hs-conid'>UpToDate</span>
<a name="line-1149"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>verbosity</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&gt;=</span> <span class='hs-num'>2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>showMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Skipping  "</span><span class='hs-layout'>)</span> <span class='hs-varid'>empty</span>
<a name="line-1150"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1151"></a>            <span class='hs-conid'>RecompBecause</span> <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>showMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Compiling "</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>" ["</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>reason</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"]"</span><span class='hs-layout'>)</span>
<a name="line-1152"></a>    <span class='hs-keyword'>where</span>
<a name="line-1153"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1154"></a>        <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1155"></a>        <span class='hs-varid'>showMsg</span> <span class='hs-varid'>msg</span> <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span>
<a name="line-1156"></a>            <span class='hs-varid'>compilationProgressMsg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-1157"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>showModuleIndex</span> <span class='hs-varid'>mod_index</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-1158"></a>            <span class='hs-varid'>msg</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>showModMsg</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>recompileRequired</span> <span class='hs-varid'>recomp</span><span class='hs-layout'>)</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span>
<a name="line-1159"></a>                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>reason</span>
<a name="line-1160"></a>
<a name="line-1161"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1162"></a><span class='hs-comment'>-- Safe Haskell</span>
<a name="line-1163"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1164"></a>
<a name="line-1165"></a><span class='hs-comment'>-- Note [Safe Haskell Trust Check]</span>
<a name="line-1166"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1167"></a><span class='hs-comment'>-- Safe Haskell checks that an import is trusted according to the following</span>
<a name="line-1168"></a><span class='hs-comment'>-- rules for an import of module M that resides in Package P:</span>
<a name="line-1169"></a><span class='hs-comment'>--</span>
<a name="line-1170"></a><span class='hs-comment'>--   * If M is recorded as Safe and all its trust dependencies are OK</span>
<a name="line-1171"></a><span class='hs-comment'>--     then M is considered safe.</span>
<a name="line-1172"></a><span class='hs-comment'>--   * If M is recorded as Trustworthy and P is considered trusted and</span>
<a name="line-1173"></a><span class='hs-comment'>--     all M's trust dependencies are OK then M is considered safe.</span>
<a name="line-1174"></a><span class='hs-comment'>--</span>
<a name="line-1175"></a><span class='hs-comment'>-- By trust dependencies we mean that the check is transitive. So if</span>
<a name="line-1176"></a><span class='hs-comment'>-- a module M that is Safe relies on a module N that is trustworthy,</span>
<a name="line-1177"></a><span class='hs-comment'>-- importing module M will first check (according to the second case)</span>
<a name="line-1178"></a><span class='hs-comment'>-- that N is trusted before checking M is trusted.</span>
<a name="line-1179"></a><span class='hs-comment'>--</span>
<a name="line-1180"></a><span class='hs-comment'>-- This is a minimal description, so please refer to the user guide</span>
<a name="line-1181"></a><span class='hs-comment'>-- for more details. The user guide is also considered the authoritative</span>
<a name="line-1182"></a><span class='hs-comment'>-- source in this matter, not the comments or code.</span>
<a name="line-1183"></a>
<a name="line-1184"></a>
<a name="line-1185"></a><span class='hs-comment'>-- Note [Safe Haskell Inference]</span>
<a name="line-1186"></a><span class='hs-comment'>-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<a name="line-1187"></a><span class='hs-comment'>-- Safe Haskell does Safe inference on modules that don't have any specific</span>
<a name="line-1188"></a><span class='hs-comment'>-- safe haskell mode flag. The basic approach to this is:</span>
<a name="line-1189"></a><span class='hs-comment'>--   * When deciding if we need to do a Safe language check, treat</span>
<a name="line-1190"></a><span class='hs-comment'>--     an unmarked module as having -XSafe mode specified.</span>
<a name="line-1191"></a><span class='hs-comment'>--   * For checks, don't throw errors but return them to the caller.</span>
<a name="line-1192"></a><span class='hs-comment'>--   * Caller checks if there are errors:</span>
<a name="line-1193"></a><span class='hs-comment'>--     * For modules explicitly marked -XSafe, we throw the errors.</span>
<a name="line-1194"></a><span class='hs-comment'>--     * For unmarked modules (inference mode), we drop the errors</span>
<a name="line-1195"></a><span class='hs-comment'>--       and mark the module as being Unsafe.</span>
<a name="line-1196"></a><span class='hs-comment'>--</span>
<a name="line-1197"></a><span class='hs-comment'>-- It used to be that we only did safe inference on modules that had no Safe</span>
<a name="line-1198"></a><span class='hs-comment'>-- Haskell flags, but now we perform safe inference on all modules as we want</span>
<a name="line-1199"></a><span class='hs-comment'>-- to allow users to set the `-Wsafe`, `-Wunsafe` and</span>
<a name="line-1200"></a><span class='hs-comment'>-- `-Wtrustworthy-safe` flags on Trustworthy and Unsafe modules so that a</span>
<a name="line-1201"></a><span class='hs-comment'>-- user can ensure their assumptions are correct and see reasons for why a</span>
<a name="line-1202"></a><span class='hs-comment'>-- module is safe or unsafe.</span>
<a name="line-1203"></a><span class='hs-comment'>--</span>
<a name="line-1204"></a><span class='hs-comment'>-- This is tricky as we must be careful when we should throw an error compared</span>
<a name="line-1205"></a><span class='hs-comment'>-- to just warnings. For checking safe imports we manage it as two steps. First</span>
<a name="line-1206"></a><span class='hs-comment'>-- we check any imports that are required to be safe, then we check all other</span>
<a name="line-1207"></a><span class='hs-comment'>-- imports to see if we can infer them to be safe.</span>
<a name="line-1208"></a>
<a name="line-1209"></a>
<a name="line-1210"></a><a name="hscCheckSafeImports"></a><span class='hs-comment'>-- | Check that the safe imports of the module being compiled are valid.</span>
<a name="line-1211"></a><span class='hs-comment'>-- If not we either issue a compilation error if the module is explicitly</span>
<a name="line-1212"></a><span class='hs-comment'>-- using Safe Haskell, or mark the module as unsafe if we're in safe</span>
<a name="line-1213"></a><span class='hs-comment'>-- inference mode.</span>
<a name="line-1214"></a><span class='hs-definition'>hscCheckSafeImports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-1215"></a><span class='hs-definition'>hscCheckSafeImports</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1216"></a>    <span class='hs-varid'>dflags</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1217"></a>    <span class='hs-varid'>tcg_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkSafeImports</span> <span class='hs-varid'>tcg_env</span>
<a name="line-1218"></a>    <span class='hs-varid'>checkRULES</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tcg_env'</span>
<a name="line-1219"></a>
<a name="line-1220"></a>  <span class='hs-keyword'>where</span>
<a name="line-1221"></a>    <span class='hs-varid'>checkRULES</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-keyglyph'>=</span>
<a name="line-1222"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>safeLanguageOn</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-1223"></a>          <span class='hs-conid'>True</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1224"></a>              <span class='hs-comment'>-- XSafe: we nuke user written RULES</span>
<a name="line-1225"></a>              <span class='hs-varid'>logWarnings</span> <span class='hs-varop'>$</span> <span class='hs-varid'>warns</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_rules</span> <span class='hs-varid'>tcg_env'</span><span class='hs-layout'>)</span>
<a name="line-1226"></a>              <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>}</span>
<a name="line-1227"></a>          <span class='hs-conid'>False</span>
<a name="line-1228"></a>                <span class='hs-comment'>-- SafeInferred: user defined RULES, so not safe</span>
<a name="line-1229"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>safeInferOn</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcg_rules</span> <span class='hs-varid'>tcg_env'</span><span class='hs-layout'>)</span>
<a name="line-1230"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>markUnsafeInfer</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>warns</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_rules</span> <span class='hs-varid'>tcg_env'</span><span class='hs-layout'>)</span>
<a name="line-1231"></a>
<a name="line-1232"></a>                <span class='hs-comment'>-- Trustworthy OR SafeInferred: with no RULES</span>
<a name="line-1233"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1234"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env'</span>
<a name="line-1235"></a>
<a name="line-1236"></a>    <span class='hs-varid'>warns</span> <span class='hs-varid'>rules</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>warnRules</span> <span class='hs-varid'>rules</span>
<a name="line-1237"></a>
<a name="line-1238"></a>    <span class='hs-varid'>warnRules</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LRuleDecl</span> <span class='hs-conid'>GhcTc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MsgEnvelope</span> <span class='hs-conid'>DecoratedSDoc</span>
<a name="line-1239"></a>    <span class='hs-varid'>warnRules</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsRule</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rd_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1240"></a>        <span class='hs-varid'>mkPlainWarnMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1241"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"Rule \""</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ftext</span> <span class='hs-layout'>(</span><span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"\" ignored"</span> <span class='hs-varop'>$+$</span>
<a name="line-1242"></a>            <span class='hs-varid'>text</span> <span class='hs-str'>"User defined rules are disabled under Safe Haskell"</span>
<a name="line-1243"></a>
<a name="line-1244"></a><a name="checkSafeImports"></a><span class='hs-comment'>-- | Validate that safe imported modules are actually safe.  For modules in the</span>
<a name="line-1245"></a><span class='hs-comment'>-- HomePackage (the package the module we are compiling in resides) this just</span>
<a name="line-1246"></a><span class='hs-comment'>-- involves checking its trust type is 'Safe' or 'Trustworthy'. For modules</span>
<a name="line-1247"></a><span class='hs-comment'>-- that reside in another package we also must check that the external package</span>
<a name="line-1248"></a><span class='hs-comment'>-- is trusted. See the Note [Safe Haskell Trust Check] above for more</span>
<a name="line-1249"></a><span class='hs-comment'>-- information.</span>
<a name="line-1250"></a><span class='hs-comment'>--</span>
<a name="line-1251"></a><span class='hs-comment'>-- The code for this is quite tricky as the whole algorithm is done in a few</span>
<a name="line-1252"></a><span class='hs-comment'>-- distinct phases in different parts of the code base. See</span>
<a name="line-1253"></a><span class='hs-comment'>-- 'GHC.Rename.Names.rnImportDecl' for where package trust dependencies for a</span>
<a name="line-1254"></a><span class='hs-comment'>-- module are collected and unioned.  Specifically see the Note [Tracking Trust</span>
<a name="line-1255"></a><span class='hs-comment'>-- Transitively] in "GHC.Rename.Names" and the Note [Trust Own Package] in</span>
<a name="line-1256"></a><span class='hs-comment'>-- "GHC.Rename.Names".</span>
<a name="line-1257"></a><span class='hs-definition'>checkSafeImports</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-1258"></a><span class='hs-definition'>checkSafeImports</span> <span class='hs-varid'>tcg_env</span>
<a name="line-1259"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1260"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1261"></a>        <span class='hs-varid'>imps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>condense</span> <span class='hs-varid'>imports'</span>
<a name="line-1262"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeImps</span><span class='hs-layout'>,</span> <span class='hs-varid'>regImps</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>imps</span>
<a name="line-1263"></a>
<a name="line-1264"></a>        <span class='hs-comment'>-- We want to use the warning state specifically for detecting if safe</span>
<a name="line-1265"></a>        <span class='hs-comment'>-- inference has failed, so store and clear any existing warnings.</span>
<a name="line-1266"></a>        <span class='hs-varid'>oldErrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWarnings</span>
<a name="line-1267"></a>        <span class='hs-varid'>clearWarnings</span>
<a name="line-1268"></a>
<a name="line-1269"></a>        <span class='hs-comment'>-- Check safe imports are correct</span>
<a name="line-1270"></a>        <span class='hs-varid'>safePkgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>S.fromList</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapMaybeM</span> <span class='hs-varid'>checkSafe</span> <span class='hs-varid'>safeImps</span>
<a name="line-1271"></a>        <span class='hs-varid'>safeErrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWarnings</span>
<a name="line-1272"></a>        <span class='hs-varid'>clearWarnings</span>
<a name="line-1273"></a>
<a name="line-1274"></a>        <span class='hs-comment'>-- Check non-safe imports are correct if inferring safety</span>
<a name="line-1275"></a>        <span class='hs-comment'>-- See the Note [Safe Haskell Inference]</span>
<a name="line-1276"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>infErrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>infPkgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeInferOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1277"></a>          <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptyBag</span><span class='hs-layout'>,</span> <span class='hs-conid'>S.empty</span><span class='hs-layout'>)</span>
<a name="line-1278"></a>          <span class='hs-conid'>True</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>infPkgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>S.fromList</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>mapMaybeM</span> <span class='hs-varid'>checkSafe</span> <span class='hs-varid'>regImps</span>
<a name="line-1279"></a>                     <span class='hs-varid'>infErrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWarnings</span>
<a name="line-1280"></a>                     <span class='hs-varid'>clearWarnings</span>
<a name="line-1281"></a>                     <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>infErrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>infPkgs</span><span class='hs-layout'>)</span>
<a name="line-1282"></a>
<a name="line-1283"></a>        <span class='hs-comment'>-- restore old errors</span>
<a name="line-1284"></a>        <span class='hs-varid'>logWarnings</span> <span class='hs-varid'>oldErrs</span>
<a name="line-1285"></a>
<a name="line-1286"></a>        <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>safeErrs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1287"></a>          <span class='hs-comment'>-- Failed safe check</span>
<a name="line-1288"></a>          <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkSrcErr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>safeErrs</span>
<a name="line-1289"></a>
<a name="line-1290"></a>          <span class='hs-comment'>-- Passed safe check</span>
<a name="line-1291"></a>          <span class='hs-conid'>True</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1292"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>infPassed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>infErrs</span>
<a name="line-1293"></a>            <span class='hs-varid'>tcg_env'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varid'>infPassed</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1294"></a>              <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>markUnsafeInfer</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varid'>infErrs</span>
<a name="line-1295"></a>              <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env</span>
<a name="line-1296"></a>            <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageTrustOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkPkgTrust</span> <span class='hs-varid'>pkgReqs</span>
<a name="line-1297"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>newTrust</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgTrustReqs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>safePkgs</span> <span class='hs-varid'>infPkgs</span> <span class='hs-varid'>infPassed</span>
<a name="line-1298"></a>            <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>impInfo</span> <span class='hs-varop'>`plusImportAvails`</span> <span class='hs-varid'>newTrust</span> <span class='hs-layout'>}</span>
<a name="line-1299"></a>
<a name="line-1300"></a>  <span class='hs-keyword'>where</span>
<a name="line-1301"></a>    <span class='hs-varid'>impInfo</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_imports</span> <span class='hs-varid'>tcg_env</span>     <span class='hs-comment'>-- ImportAvails</span>
<a name="line-1302"></a>    <span class='hs-varid'>imports</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_mods</span> <span class='hs-varid'>impInfo</span>        <span class='hs-comment'>-- ImportedMods</span>
<a name="line-1303"></a>    <span class='hs-varid'>imports1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>moduleEnvToList</span> <span class='hs-varid'>imports</span> <span class='hs-comment'>-- (Module, [ImportedBy])</span>
<a name="line-1304"></a>    <span class='hs-varid'>imports'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>importedByUser</span><span class='hs-layout'>)</span> <span class='hs-varid'>imports1</span> <span class='hs-comment'>-- (Module, [ImportedModsVal])</span>
<a name="line-1305"></a>    <span class='hs-varid'>pkgReqs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-varid'>impInfo</span>  <span class='hs-comment'>-- [Unit]</span>
<a name="line-1306"></a>
<a name="line-1307"></a>    <span class='hs-varid'>condense</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ImportedModsVal</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>,</span> <span class='hs-conid'>IsSafeImport</span><span class='hs-layout'>)</span>
<a name="line-1308"></a>    <span class='hs-varid'>condense</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"GHC.Driver.Main.condense: Pattern match failure!"</span>
<a name="line-1309"></a>    <span class='hs-varid'>condense</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>x</span><span class='hs-conop'>:</span><span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>imv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>foldlM</span> <span class='hs-varid'>cond'</span> <span class='hs-varid'>x</span> <span class='hs-varid'>xs</span>
<a name="line-1310"></a>                            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>imv_span</span> <span class='hs-varid'>imv</span><span class='hs-layout'>,</span> <span class='hs-varid'>imv_is_safe</span> <span class='hs-varid'>imv</span><span class='hs-layout'>)</span>
<a name="line-1311"></a>
<a name="line-1312"></a>    <span class='hs-comment'>-- ImportedModsVal = (ModuleName, Bool, SrcSpan, IsSafeImport)</span>
<a name="line-1313"></a>    <span class='hs-varid'>cond'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ImportedModsVal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportedModsVal</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>ImportedModsVal</span>
<a name="line-1314"></a>    <span class='hs-varid'>cond'</span> <span class='hs-varid'>v1</span> <span class='hs-varid'>v2</span>
<a name="line-1315"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>imv_is_safe</span> <span class='hs-varid'>v1</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>imv_is_safe</span> <span class='hs-varid'>v2</span>
<a name="line-1316"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-layout'>(</span><span class='hs-varid'>imv_span</span> <span class='hs-varid'>v1</span><span class='hs-layout'>)</span>
<a name="line-1317"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Module"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>imv_name</span> <span class='hs-varid'>v1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1318"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varop'>$</span> <span class='hs-str'>"is imported both as a safe and unsafe import!"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1319"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1320"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v1</span>
<a name="line-1321"></a>
<a name="line-1322"></a>    <span class='hs-comment'>-- easier interface to work with</span>
<a name="line-1323"></a>    <span class='hs-varid'>checkSafe</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Module</span><span class='hs-layout'>,</span> <span class='hs-conid'>SrcSpan</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>UnitId</span><span class='hs-layout'>)</span>
<a name="line-1324"></a>    <span class='hs-varid'>checkSafe</span> <span class='hs-layout'>(</span><span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-varid'>l</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>hscCheckSafe'</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-1325"></a>
<a name="line-1326"></a>    <span class='hs-comment'>-- what pkg's to add to our trust requirements</span>
<a name="line-1327"></a>    <span class='hs-varid'>pkgTrustReqs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1328"></a>          <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ImportAvails</span>
<a name="line-1329"></a>    <span class='hs-varid'>pkgTrustReqs</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>req</span> <span class='hs-varid'>inf</span> <span class='hs-varid'>infPassed</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>safeInferOn</span> <span class='hs-varid'>dflags</span>
<a name="line-1330"></a>                                  <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeHaskellModeEnabled</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>infPassed</span>
<a name="line-1331"></a>                                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyImportAvails</span> <span class='hs-layout'>{</span>
<a name="line-1332"></a>                                       <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req</span> <span class='hs-varop'>`S.union`</span> <span class='hs-varid'>inf</span>
<a name="line-1333"></a>                                   <span class='hs-layout'>}</span>
<a name="line-1334"></a>    <span class='hs-varid'>pkgTrustReqs</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>_</span>   <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>safeHaskell</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Sf_Unsafe</span>
<a name="line-1335"></a>                         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyImportAvails</span>
<a name="line-1336"></a>    <span class='hs-varid'>pkgTrustReqs</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>req</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>emptyImportAvails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>req</span> <span class='hs-layout'>}</span>
<a name="line-1337"></a>
<a name="line-1338"></a><a name="hscCheckSafe"></a><span class='hs-comment'>-- | Check that a module is safe to import.</span>
<a name="line-1339"></a><span class='hs-comment'>--</span>
<a name="line-1340"></a><span class='hs-comment'>-- We return True to indicate the import is safe and False otherwise</span>
<a name="line-1341"></a><span class='hs-comment'>-- although in the False case an exception may be thrown first.</span>
<a name="line-1342"></a><span class='hs-definition'>hscCheckSafe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Bool</span>
<a name="line-1343"></a><span class='hs-definition'>hscCheckSafe</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1344"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1345"></a>    <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>hscCheckSafe'</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-1346"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageTrustOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkPkgTrust</span> <span class='hs-varid'>pkgs</span>
<a name="line-1347"></a>    <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWarnings</span>
<a name="line-1348"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varid'>errs</span>
<a name="line-1349"></a>
<a name="line-1350"></a><a name="hscGetSafe"></a><span class='hs-comment'>-- | Return if a module is trusted and the pkgs it depends on to be trusted.</span>
<a name="line-1351"></a><span class='hs-definition'>hscGetSafe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span><span class='hs-layout'>)</span>
<a name="line-1352"></a><span class='hs-definition'>hscGetSafe</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1353"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>self</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscCheckSafe'</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-1354"></a>    <span class='hs-varid'>good</span>         <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isEmptyBag</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>getWarnings</span>
<a name="line-1355"></a>    <span class='hs-varid'>clearWarnings</span> <span class='hs-comment'>-- don't want them printed...</span>
<a name="line-1356"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>pkgs'</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>self</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S.insert</span> <span class='hs-varid'>p</span> <span class='hs-varid'>pkgs</span>
<a name="line-1357"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pkgs</span>
<a name="line-1358"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>good</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs'</span><span class='hs-layout'>)</span>
<a name="line-1359"></a>
<a name="line-1360"></a><a name="hscCheckSafe'"></a><span class='hs-comment'>-- | Is a module trusted? If not, throw or log errors depending on the type.</span>
<a name="line-1361"></a><span class='hs-comment'>-- Return (regardless of trusted or not) if the trust type requires the modules</span>
<a name="line-1362"></a><span class='hs-comment'>-- own package be trusted and a list of other packages required to be trusted</span>
<a name="line-1363"></a><span class='hs-comment'>-- (these later ones haven't been checked) but the own package trust has been.</span>
<a name="line-1364"></a><span class='hs-definition'>hscCheckSafe'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span>
<a name="line-1365"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>UnitId</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span><span class='hs-layout'>)</span>
<a name="line-1366"></a><span class='hs-definition'>hscCheckSafe'</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1367"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1368"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1369"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tw</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isModSafe</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span>
<a name="line-1370"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>tw</span> <span class='hs-keyword'>of</span>
<a name="line-1371"></a>        <span class='hs-conid'>False</span>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span>
<a name="line-1372"></a>        <span class='hs-conid'>True</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHomeModule</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span>
<a name="line-1373"></a>             <span class='hs-comment'>-- TODO: do we also have to check the trust of the instantiation?</span>
<a name="line-1374"></a>             <span class='hs-comment'>-- Not necessary if that is reflected in dependencies</span>
<a name="line-1375"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>toUnitId</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgs</span><span class='hs-layout'>)</span>
<a name="line-1376"></a>  <span class='hs-keyword'>where</span>
<a name="line-1377"></a>    <span class='hs-varid'>isModSafe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HomeUnit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span><span class='hs-layout'>)</span>
<a name="line-1378"></a>    <span class='hs-varid'>isModSafe</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>m</span> <span class='hs-varid'>l</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1379"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1380"></a>        <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1381"></a>        <span class='hs-varid'>iface</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookup'</span> <span class='hs-varid'>m</span>
<a name="line-1382"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>iface</span> <span class='hs-keyword'>of</span>
<a name="line-1383"></a>            <span class='hs-comment'>-- can't load iface to check trust!</span>
<a name="line-1384"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>l</span>
<a name="line-1385"></a>                         <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Can't load the interface file for"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>m</span>
<a name="line-1386"></a>                           <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>", to check that it can be safely imported"</span>
<a name="line-1387"></a>
<a name="line-1388"></a>            <span class='hs-comment'>-- got iface, check trust</span>
<a name="line-1389"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>iface'</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1390"></a>                <span class='hs-keyword'>let</span> <span class='hs-varid'>trust</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSafeMode</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mi_trust</span> <span class='hs-varid'>iface'</span>
<a name="line-1391"></a>                    <span class='hs-varid'>trust_own_pkg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mi_trust_pkg</span> <span class='hs-varid'>iface'</span>
<a name="line-1392"></a>                    <span class='hs-comment'>-- check module is trusted</span>
<a name="line-1393"></a>                    <span class='hs-varid'>safeM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trust</span> <span class='hs-varop'>`elem`</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Sf_Safe</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sf_SafeInferred</span><span class='hs-layout'>,</span> <span class='hs-conid'>Sf_Trustworthy</span><span class='hs-keyglyph'>]</span>
<a name="line-1394"></a>                    <span class='hs-comment'>-- check package is trusted</span>
<a name="line-1395"></a>                    <span class='hs-varid'>safeP</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>packageTrusted</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>trust</span> <span class='hs-varid'>trust_own_pkg</span> <span class='hs-varid'>m</span>
<a name="line-1396"></a>                    <span class='hs-comment'>-- pkg trust reqs</span>
<a name="line-1397"></a>                    <span class='hs-varid'>pkgRs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S.fromList</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dep_pkgs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mi_deps</span> <span class='hs-varid'>iface'</span>
<a name="line-1398"></a>                    <span class='hs-comment'>-- warn if Safe module imports Safe-Inferred module.</span>
<a name="line-1399"></a>                    <span class='hs-varid'>warns</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnInferredSafeImports</span> <span class='hs-varid'>dflags</span>
<a name="line-1400"></a>                                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>safeLanguageOn</span> <span class='hs-varid'>dflags</span>
<a name="line-1401"></a>                                <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>trust</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Sf_SafeInferred</span>
<a name="line-1402"></a>                                <span class='hs-keyword'>then</span> <span class='hs-varid'>inferredImportWarn</span>
<a name="line-1403"></a>                                <span class='hs-keyword'>else</span> <span class='hs-varid'>emptyBag</span>
<a name="line-1404"></a>                    <span class='hs-comment'>-- General errors we throw but Safe errors we log</span>
<a name="line-1405"></a>                    <span class='hs-varid'>errs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeM</span><span class='hs-layout'>,</span> <span class='hs-varid'>safeP</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1406"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span> <span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>emptyBag</span>
<a name="line-1407"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pkgTrustErr</span>
<a name="line-1408"></a>                        <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span>   <span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>modTrustErr</span>
<a name="line-1409"></a>                <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span>
<a name="line-1410"></a>                    <span class='hs-varid'>logWarnings</span> <span class='hs-varid'>warns</span>
<a name="line-1411"></a>                    <span class='hs-varid'>logWarnings</span> <span class='hs-varid'>errs</span>
<a name="line-1412"></a>                    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>trust</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Sf_Trustworthy</span><span class='hs-layout'>,</span> <span class='hs-varid'>pkgRs</span><span class='hs-layout'>)</span>
<a name="line-1413"></a>
<a name="line-1414"></a>                <span class='hs-keyword'>where</span>
<a name="line-1415"></a>                    <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1416"></a>                    <span class='hs-varid'>inferredImportWarn</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span>
<a name="line-1417"></a>                        <span class='hs-varop'>$</span> <span class='hs-varid'>makeIntoWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnInferredSafeImports</span><span class='hs-layout'>)</span>
<a name="line-1418"></a>                        <span class='hs-varop'>$</span> <span class='hs-varid'>mkWarnMsg</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgQual</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-1419"></a>                        <span class='hs-varop'>$</span> <span class='hs-varid'>sep</span>
<a name="line-1420"></a>                            <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Importing Safe-Inferred module "</span>
<a name="line-1421"></a>                                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1422"></a>                                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>" from explicitly Safe module"</span>
<a name="line-1423"></a>                            <span class='hs-keyglyph'>]</span>
<a name="line-1424"></a>                    <span class='hs-varid'>pkgTrustErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkMsgEnvelope</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgQual</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1425"></a>                        <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1426"></a>                                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>": Can't be safely imported!"</span>
<a name="line-1427"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The package ("</span>
<a name="line-1428"></a>                                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithUnitState</span> <span class='hs-varid'>state</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1429"></a>                                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>") the module resides in isn't trusted."</span>
<a name="line-1430"></a>                            <span class='hs-keyglyph'>]</span>
<a name="line-1431"></a>                    <span class='hs-varid'>modTrustErr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkMsgEnvelope</span> <span class='hs-varid'>l</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgQual</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1432"></a>                        <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleName</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1433"></a>                                <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>": Can't be safely imported!"</span>
<a name="line-1434"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The module itself isn't safe."</span> <span class='hs-keyglyph'>]</span>
<a name="line-1435"></a>
<a name="line-1436"></a>    <span class='hs-comment'>-- | Check the package a module resides in is trusted. Safe compiled</span>
<a name="line-1437"></a>    <span class='hs-comment'>-- modules are trusted without requiring that their package is trusted. For</span>
<a name="line-1438"></a>    <span class='hs-comment'>-- trustworthy modules, modules in the home package are trusted but</span>
<a name="line-1439"></a>    <span class='hs-comment'>-- otherwise we check the package trust flag.</span>
<a name="line-1440"></a>    <span class='hs-varid'>packageTrusted</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UnitState</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HomeUnit</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SafeHaskellMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1441"></a>    <span class='hs-varid'>packageTrusted</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>unit_state</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>trust_own_pkg</span> <span class='hs-varid'>mod</span> <span class='hs-keyglyph'>=</span>
<a name="line-1442"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>safe_mode</span> <span class='hs-keyword'>of</span>
<a name="line-1443"></a>            <span class='hs-conid'>Sf_None</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- shouldn't hit these cases</span>
<a name="line-1444"></a>            <span class='hs-conid'>Sf_Ignore</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- shouldn't hit these cases</span>
<a name="line-1445"></a>            <span class='hs-conid'>Sf_Unsafe</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span> <span class='hs-comment'>-- prefer for completeness.</span>
<a name="line-1446"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>packageTrustOn</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1447"></a>            <span class='hs-conid'>Sf_Safe</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>trust_own_pkg</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1448"></a>            <span class='hs-conid'>Sf_SafeInferred</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>trust_own_pkg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1449"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isHomeModule</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>mod</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-1450"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unitIsTrusted</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafeLookupUnit</span> <span class='hs-varid'>unit_state</span> <span class='hs-layout'>(</span><span class='hs-varid'>moduleUnit</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1451"></a>
<a name="line-1452"></a>    <span class='hs-varid'>lookup'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>ModIface</span><span class='hs-layout'>)</span>
<a name="line-1453"></a>    <span class='hs-varid'>lookup'</span> <span class='hs-varid'>m</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1454"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1455"></a>        <span class='hs-varid'>hsc_eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscEPS</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1456"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>pkgIfaceT</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>eps_PIT</span> <span class='hs-varid'>hsc_eps</span>
<a name="line-1457"></a>            <span class='hs-varid'>homePkgT</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_HPT</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1458"></a>            <span class='hs-varid'>iface</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lookupIfaceByModule</span> <span class='hs-varid'>homePkgT</span> <span class='hs-varid'>pkgIfaceT</span> <span class='hs-varid'>m</span>
<a name="line-1459"></a>        <span class='hs-comment'>-- the 'lookupIfaceByModule' method will always fail when calling from GHCi</span>
<a name="line-1460"></a>        <span class='hs-comment'>-- as the compiler hasn't filled in the various module tables</span>
<a name="line-1461"></a>        <span class='hs-comment'>-- so we need to call 'getModuleInterface' to load from disk</span>
<a name="line-1462"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>iface</span> <span class='hs-keyword'>of</span>
<a name="line-1463"></a>            <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>iface</span>
<a name="line-1464"></a>            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>`fmap`</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getModuleInterface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-1465"></a>
<a name="line-1466"></a>
<a name="line-1467"></a><a name="checkPkgTrust"></a><span class='hs-comment'>-- | Check the list of packages are trusted.</span>
<a name="line-1468"></a><span class='hs-definition'>checkPkgTrust</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Set</span> <span class='hs-conid'>UnitId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>()</span>
<a name="line-1469"></a><span class='hs-definition'>checkPkgTrust</span> <span class='hs-varid'>pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1470"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1471"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>errors</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S.foldr</span> <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>pkgs</span>
<a name="line-1472"></a>        <span class='hs-varid'>state</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1473"></a>        <span class='hs-varid'>go</span> <span class='hs-varid'>pkg</span> <span class='hs-varid'>acc</span>
<a name="line-1474"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>unitIsTrusted</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unsafeLookupUnitId</span> <span class='hs-varid'>state</span> <span class='hs-varid'>pkg</span>
<a name="line-1475"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>acc</span>
<a name="line-1476"></a>            <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1477"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>pkgQual</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-1478"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>pprWithUnitState</span> <span class='hs-varid'>state</span>
<a name="line-1479"></a>                     <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The package ("</span>
<a name="line-1480"></a>                        <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>pkg</span>
<a name="line-1481"></a>                        <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>") is required to be trusted but it isn't!"</span>
<a name="line-1482"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>errors</span> <span class='hs-keyword'>of</span>
<a name="line-1483"></a>        <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1484"></a>        <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>throwIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>mkSrcErr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>listToBag</span><span class='hs-layout'>)</span> <span class='hs-varid'>errors</span>
<a name="line-1485"></a>
<a name="line-1486"></a><a name="markUnsafeInfer"></a><span class='hs-comment'>-- | Set module to unsafe and (potentially) wipe trust information.</span>
<a name="line-1487"></a><span class='hs-comment'>--</span>
<a name="line-1488"></a><span class='hs-comment'>-- Make sure to call this method to set a module to inferred unsafe, it should</span>
<a name="line-1489"></a><span class='hs-comment'>-- be a central and single failure method. We only wipe the trust information</span>
<a name="line-1490"></a><span class='hs-comment'>-- when we aren't in a specific Safe Haskell mode.</span>
<a name="line-1491"></a><span class='hs-comment'>--</span>
<a name="line-1492"></a><span class='hs-comment'>-- While we only use this for recording that a module was inferred unsafe, we</span>
<a name="line-1493"></a><span class='hs-comment'>-- may call it on modules using Trustworthy or Unsafe flags so as to allow</span>
<a name="line-1494"></a><span class='hs-comment'>-- warning flags for safety to function correctly. See Note [Safe Haskell</span>
<a name="line-1495"></a><span class='hs-comment'>-- Inference].</span>
<a name="line-1496"></a><span class='hs-definition'>markUnsafeInfer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WarningMessages</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-1497"></a><span class='hs-definition'>markUnsafeInfer</span> <span class='hs-varid'>tcg_env</span> <span class='hs-varid'>whyUnsafe</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1498"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1499"></a>
<a name="line-1500"></a>    <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>wopt</span> <span class='hs-conid'>Opt_WarnUnsafe</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-1501"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>logWarnings</span> <span class='hs-varop'>$</span> <span class='hs-varid'>unitBag</span> <span class='hs-varop'>$</span> <span class='hs-varid'>makeIntoWarning</span> <span class='hs-layout'>(</span><span class='hs-conid'>Reason</span> <span class='hs-conid'>Opt_WarnUnsafe</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1502"></a>             <span class='hs-varid'>mkPlainWarnMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>warnUnsafeOnLoc</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>whyUnsafe'</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1503"></a>
<a name="line-1504"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_safeInfer</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>whyUnsafe</span><span class='hs-layout'>)</span>
<a name="line-1505"></a>    <span class='hs-comment'>-- NOTE: Only wipe trust when not in an explicitly safe haskell mode. Other</span>
<a name="line-1506"></a>    <span class='hs-comment'>-- times inference may be on but we are in Trustworthy mode -- so we want</span>
<a name="line-1507"></a>    <span class='hs-comment'>-- to record safe-inference failed but not wipe the trust dependencies.</span>
<a name="line-1508"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>safeHaskellModeEnabled</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1509"></a>      <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcg_env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tcg_imports</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wiped_trust</span> <span class='hs-layout'>}</span>
<a name="line-1510"></a>      <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tcg_env</span>
<a name="line-1511"></a>
<a name="line-1512"></a>  <span class='hs-keyword'>where</span>
<a name="line-1513"></a>    <span class='hs-varid'>wiped_trust</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_imports</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_trust_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>S.empty</span> <span class='hs-layout'>}</span>
<a name="line-1514"></a>    <span class='hs-varid'>pprMod</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varop'>$</span> <span class='hs-varid'>moduleName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcg_mod</span> <span class='hs-varid'>tcg_env</span>
<a name="line-1515"></a>    <span class='hs-varid'>whyUnsafe'</span> <span class='hs-varid'>df</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>quotes</span> <span class='hs-varid'>pprMod</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"has been inferred as unsafe!"</span>
<a name="line-1516"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Reason:"</span>
<a name="line-1517"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>4</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>badFlags</span> <span class='hs-varid'>df</span><span class='hs-layout'>)</span> <span class='hs-varop'>$+$</span>
<a name="line-1518"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>pprMsgEnvelopeBagWithLoc</span> <span class='hs-varid'>whyUnsafe</span><span class='hs-layout'>)</span> <span class='hs-varop'>$+$</span>
<a name="line-1519"></a>                                    <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varop'>$</span> <span class='hs-varid'>badInsts</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcg_insts</span> <span class='hs-varid'>tcg_env</span><span class='hs-layout'>)</span>
<a name="line-1520"></a>                         <span class='hs-keyglyph'>]</span>
<a name="line-1521"></a>    <span class='hs-varid'>badFlags</span> <span class='hs-varid'>df</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>badFlag</span> <span class='hs-varid'>df</span><span class='hs-layout'>)</span> <span class='hs-varid'>unsafeFlagsForInfer</span>
<a name="line-1522"></a>    <span class='hs-varid'>badFlag</span> <span class='hs-varid'>df</span> <span class='hs-layout'>(</span><span class='hs-varid'>str</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span><span class='hs-varid'>on</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-1523"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>on</span> <span class='hs-varid'>df</span>     <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkLocMessage</span> <span class='hs-conid'>SevOutput</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span> <span class='hs-varid'>df</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1524"></a>                            <span class='hs-varid'>text</span> <span class='hs-varid'>str</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is not allowed in Safe Haskell"</span><span class='hs-keyglyph'>]</span>
<a name="line-1525"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1526"></a>    <span class='hs-varid'>badInsts</span> <span class='hs-varid'>insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>concatMap</span> <span class='hs-varid'>badInst</span> <span class='hs-varid'>insts</span>
<a name="line-1527"></a>
<a name="line-1528"></a>    <span class='hs-varid'>checkOverlap</span> <span class='hs-layout'>(</span><span class='hs-conid'>NoOverlap</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1529"></a>    <span class='hs-varid'>checkOverlap</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1530"></a>
<a name="line-1531"></a>    <span class='hs-varid'>badInst</span> <span class='hs-varid'>ins</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>checkOverlap</span> <span class='hs-layout'>(</span><span class='hs-varid'>overlapMode</span> <span class='hs-layout'>(</span><span class='hs-varid'>is_flag</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1532"></a>                <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>mkLocMessage</span> <span class='hs-conid'>SevOutput</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameSrcSpan</span> <span class='hs-varop'>$</span> <span class='hs-varid'>getName</span> <span class='hs-varop'>$</span> <span class='hs-varid'>is_dfun</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1533"></a>                      <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>overlapMode</span> <span class='hs-varop'>$</span> <span class='hs-varid'>is_flag</span> <span class='hs-varid'>ins</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-1534"></a>                      <span class='hs-varid'>text</span> <span class='hs-str'>"overlap mode isn't allowed in Safe Haskell"</span><span class='hs-keyglyph'>]</span>
<a name="line-1535"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1536"></a>
<a name="line-1537"></a>
<a name="line-1538"></a><a name="hscGetSafeMode"></a><span class='hs-comment'>-- | Figure out the final correct safe haskell mode</span>
<a name="line-1539"></a><span class='hs-definition'>hscGetSafeMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>SafeHaskellMode</span>
<a name="line-1540"></a><span class='hs-definition'>hscGetSafeMode</span> <span class='hs-varid'>tcg_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1541"></a>    <span class='hs-varid'>dflags</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-1542"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>finalSafeMode</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>tcg_env</span>
<a name="line-1543"></a>
<a name="line-1544"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1545"></a><span class='hs-comment'>-- Simplifiers</span>
<a name="line-1546"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1547"></a>
<a name="line-1548"></a><a name="hscSimplify"></a><span class='hs-comment'>-- | Run Core2Core simplifier. The list of String is a list of (Core) plugin</span>
<a name="line-1549"></a><span class='hs-comment'>-- module names added via TH (cf 'addCorePlugin').</span>
<a name="line-1550"></a><span class='hs-definition'>hscSimplify</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ModGuts</span>
<a name="line-1551"></a><span class='hs-definition'>hscSimplify</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>plugins</span> <span class='hs-varid'>modguts</span> <span class='hs-keyglyph'>=</span>
<a name="line-1552"></a>    <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscSimplify'</span> <span class='hs-varid'>plugins</span> <span class='hs-varid'>modguts</span>
<a name="line-1553"></a>
<a name="line-1554"></a><a name="hscSimplify'"></a><span class='hs-comment'>-- | Run Core2Core simplifier. The list of String is a list of (Core) plugin</span>
<a name="line-1555"></a><span class='hs-comment'>-- module names added via TH (cf 'addCorePlugin').</span>
<a name="line-1556"></a><span class='hs-definition'>hscSimplify'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>String</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-conid'>ModGuts</span>
<a name="line-1557"></a><span class='hs-definition'>hscSimplify'</span> <span class='hs-varid'>plugins</span> <span class='hs-varid'>ds_result</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1558"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1559"></a>    <span class='hs-varid'>hsc_env_with_plugins</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>plugins</span> <span class='hs-comment'>-- fast path</span>
<a name="line-1560"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1561"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initializePlugins</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1562"></a>                <span class='hs-layout'>{</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-varid'>addPluginModuleName</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>plugins</span>
<a name="line-1563"></a>                <span class='hs-layout'>}</span>
<a name="line-1564"></a>    <span class='hs-comment'>{-# SCC "Core2Core" #-}</span>
<a name="line-1565"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>core2core</span> <span class='hs-varid'>hsc_env_with_plugins</span> <span class='hs-varid'>ds_result</span>
<a name="line-1566"></a>
<a name="line-1567"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1568"></a><span class='hs-comment'>-- Interface generators</span>
<a name="line-1569"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1570"></a>
<a name="line-1571"></a><a name="hscSimpleIface"></a><span class='hs-comment'>-- | Generate a striped down interface file, e.g. for boot files or when ghci</span>
<a name="line-1572"></a><span class='hs-comment'>-- generates interface files. See Note [simpleTidyPgm - mkBootModDetailsTc]</span>
<a name="line-1573"></a><span class='hs-definition'>hscSimpleIface</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1574"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-1575"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-1576"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModDetails</span><span class='hs-layout'>)</span>
<a name="line-1577"></a><span class='hs-definition'>hscSimpleIface</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tc_result</span> <span class='hs-varid'>mb_old_iface</span>
<a name="line-1578"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscSimpleIface'</span> <span class='hs-varid'>tc_result</span> <span class='hs-varid'>mb_old_iface</span>
<a name="line-1579"></a>
<a name="line-1580"></a><a name="hscSimpleIface'"></a><span class='hs-definition'>hscSimpleIface'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcGblEnv</span>
<a name="line-1581"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span>
<a name="line-1582"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>ModIface</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Fingerprint</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModDetails</span><span class='hs-layout'>)</span>
<a name="line-1583"></a><span class='hs-definition'>hscSimpleIface'</span> <span class='hs-varid'>tc_result</span> <span class='hs-varid'>mb_old_iface</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1584"></a>    <span class='hs-varid'>hsc_env</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1585"></a>    <span class='hs-varid'>details</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkBootModDetailsTc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tc_result</span>
<a name="line-1586"></a>    <span class='hs-varid'>safe_mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscGetSafeMode</span> <span class='hs-varid'>tc_result</span>
<a name="line-1587"></a>    <span class='hs-varid'>new_iface</span>
<a name="line-1588"></a>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "MkFinalIface" #-}</span>
<a name="line-1589"></a>           <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span>
<a name="line-1590"></a>               <span class='hs-varid'>mkIfaceTc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>safe_mode</span> <span class='hs-varid'>details</span> <span class='hs-varid'>tc_result</span>
<a name="line-1591"></a>    <span class='hs-comment'>-- And the answer is ...</span>
<a name="line-1592"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfaceStats</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1593"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>mb_old_iface</span><span class='hs-layout'>,</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span>
<a name="line-1594"></a>
<a name="line-1595"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1596"></a><span class='hs-comment'>-- BackEnd combinators</span>
<a name="line-1597"></a><span class='hs-comment'>--------------------------------------------------------------</span>
<a name="line-1598"></a>
<a name="line-1599"></a><a name="hscGenHardCode"></a><span class='hs-comment'>-- | Compile to hard-code.</span>
<a name="line-1600"></a><span class='hs-definition'>hscGenHardCode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgGuts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>
<a name="line-1601"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>ForeignSrcLang</span><span class='hs-layout'>,</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>CgInfos</span><span class='hs-layout'>)</span>
<a name="line-1602"></a>               <span class='hs-comment'>-- ^ @Just f@ &lt;=&gt; _stub.c is f</span>
<a name="line-1603"></a><span class='hs-definition'>hscGenHardCode</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>cgguts</span> <span class='hs-varid'>location</span> <span class='hs-varid'>output_filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1604"></a>        <span class='hs-keyword'>let</span> <span class='hs-conid'>CgGuts</span><span class='hs-layout'>{</span> <span class='hs-comment'>-- This is the last use of the ModGuts in a compilation.</span>
<a name="line-1605"></a>                    <span class='hs-comment'>-- From now on, we just use the bits we need.</span>
<a name="line-1606"></a>                    <span class='hs-varid'>cg_module</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-1607"></a>                    <span class='hs-varid'>cg_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>core_binds</span><span class='hs-layout'>,</span>
<a name="line-1608"></a>                    <span class='hs-varid'>cg_tycons</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycons</span><span class='hs-layout'>,</span>
<a name="line-1609"></a>                    <span class='hs-varid'>cg_foreign</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_stubs0</span><span class='hs-layout'>,</span>
<a name="line-1610"></a>                    <span class='hs-varid'>cg_foreign_files</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_files</span><span class='hs-layout'>,</span>
<a name="line-1611"></a>                    <span class='hs-varid'>cg_dep_pkgs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dependencies</span><span class='hs-layout'>,</span>
<a name="line-1612"></a>                    <span class='hs-varid'>cg_hpc_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hpc_info</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgguts</span>
<a name="line-1613"></a>            <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1614"></a>            <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1615"></a>            <span class='hs-varid'>hooks</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_hooks</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1616"></a>            <span class='hs-varid'>tmpfs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1617"></a>            <span class='hs-varid'>data_tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isDataTyCon</span> <span class='hs-varid'>tycons</span>
<a name="line-1618"></a>            <span class='hs-comment'>-- cg_tycons includes newtypes, for the benefit of External Core,</span>
<a name="line-1619"></a>            <span class='hs-comment'>-- but we don't generate any code for newtypes</span>
<a name="line-1620"></a>
<a name="line-1621"></a>        <span class='hs-comment'>-------------------</span>
<a name="line-1622"></a>        <span class='hs-comment'>-- PREPARE FOR CODE GENERATION</span>
<a name="line-1623"></a>        <span class='hs-comment'>-- Do saturation and convert to A-normal form</span>
<a name="line-1624"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>prepd_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>local_ccs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "CorePrep" #-}</span>
<a name="line-1625"></a>                       <span class='hs-varid'>corePrepPgm</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>location</span>
<a name="line-1626"></a>                                   <span class='hs-varid'>core_binds</span> <span class='hs-varid'>data_tycons</span>
<a name="line-1627"></a>
<a name="line-1628"></a>        <span class='hs-comment'>-----------------  Convert to STG ------------------</span>
<a name="line-1629"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>stg_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>denv</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>caf_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>caf_cc_stacks</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1630"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "CoreToStg" #-}</span>
<a name="line-1631"></a>               <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-1632"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CoreToStg"</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1633"></a>                   <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>c</span><span class='hs-layout'>,</span><span class='hs-varid'>d</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>b</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>c</span> <span class='hs-varop'>`seqList`</span> <span class='hs-varid'>d</span> <span class='hs-varop'>`seqList`</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1634"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>myCoreToStg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>location</span> <span class='hs-varid'>prepd_binds</span><span class='hs-layout'>)</span>
<a name="line-1635"></a>
<a name="line-1636"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>cost_centre_info</span> <span class='hs-keyglyph'>=</span>
<a name="line-1637"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>S.toList</span> <span class='hs-varid'>local_ccs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>caf_ccs</span><span class='hs-layout'>,</span> <span class='hs-varid'>caf_cc_stacks</span><span class='hs-layout'>)</span>
<a name="line-1638"></a>            <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-1639"></a>            <span class='hs-varid'>prof_init</span>
<a name="line-1640"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>sccProfilingEnabled</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>profilingInitCode</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>cost_centre_info</span>
<a name="line-1641"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-1642"></a>
<a name="line-1643"></a>        <span class='hs-comment'>------------------  Code generation ------------------</span>
<a name="line-1644"></a>        <span class='hs-comment'>-- The back-end is streamed: each top-level function goes</span>
<a name="line-1645"></a>        <span class='hs-comment'>-- from Stg all the way to asm before dealing with the next</span>
<a name="line-1646"></a>        <span class='hs-comment'>-- top-level function, so showPass isn't very useful here.</span>
<a name="line-1647"></a>        <span class='hs-comment'>-- Hence we have one showPass for the whole backend, the</span>
<a name="line-1648"></a>        <span class='hs-comment'>-- next showPass after this will be "Assembler".</span>
<a name="line-1649"></a>        <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-1650"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"CodeGen"</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1651"></a>                   <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1652"></a>            <span class='hs-varid'>cmms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "StgToCmm" #-}</span>
<a name="line-1653"></a>                            <span class='hs-varid'>doCodeGen</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>denv</span> <span class='hs-varid'>data_tycons</span>
<a name="line-1654"></a>                                <span class='hs-varid'>cost_centre_info</span>
<a name="line-1655"></a>                                <span class='hs-varid'>stg_binds</span> <span class='hs-varid'>hpc_info</span>
<a name="line-1656"></a>
<a name="line-1657"></a>            <span class='hs-comment'>------------------  Code output -----------------------</span>
<a name="line-1658"></a>            <span class='hs-varid'>rawcmms0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "cmmToRawCmm" #-}</span>
<a name="line-1659"></a>                        <span class='hs-keyword'>case</span> <span class='hs-varid'>cmmToRawCmmHook</span> <span class='hs-varid'>hooks</span> <span class='hs-keyword'>of</span>
<a name="line-1660"></a>                            <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmmToRawCmm</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cmms</span>
<a name="line-1661"></a>                            <span class='hs-conid'>Just</span> <span class='hs-varid'>h</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmms</span>
<a name="line-1662"></a>
<a name="line-1663"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>dump</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1664"></a>                  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1665"></a>                    <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cmm_raw</span> <span class='hs-str'>"Raw Cmm"</span> <span class='hs-conid'>FormatCMM</span> <span class='hs-layout'>(</span><span class='hs-varid'>pdoc</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1666"></a>                  <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
<a name="line-1667"></a>                <span class='hs-varid'>rawcmms1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stream.mapM</span> <span class='hs-varid'>dump</span> <span class='hs-varid'>rawcmms0</span>
<a name="line-1668"></a>
<a name="line-1669"></a>            <span class='hs-keyword'>let</span> <span class='hs-varid'>foreign_stubs</span> <span class='hs-varid'>st</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_stubs0</span> <span class='hs-varop'>`appendStubC`</span> <span class='hs-varid'>prof_init</span>
<a name="line-1670"></a>                                                  <span class='hs-varop'>`appendStubC`</span> <span class='hs-varid'>cgIPEStub</span> <span class='hs-varid'>st</span>
<a name="line-1671"></a>
<a name="line-1672"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>output_filename</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-sel'>_stub_h_exists</span><span class='hs-layout'>,</span> <span class='hs-varid'>stub_c_exists</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>foreign_fps</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_infos</span><span class='hs-layout'>)</span>
<a name="line-1673"></a>                <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "codeOutput" #-}</span>
<a name="line-1674"></a>                  <span class='hs-varid'>codeOutput</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>output_filename</span> <span class='hs-varid'>location</span>
<a name="line-1675"></a>                  <span class='hs-varid'>foreign_stubs</span> <span class='hs-varid'>foreign_files</span> <span class='hs-varid'>dependencies</span> <span class='hs-varid'>rawcmms1</span>
<a name="line-1676"></a>            <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>output_filename</span><span class='hs-layout'>,</span> <span class='hs-varid'>stub_c_exists</span><span class='hs-layout'>,</span> <span class='hs-varid'>foreign_fps</span><span class='hs-layout'>,</span> <span class='hs-varid'>cg_infos</span><span class='hs-layout'>)</span>
<a name="line-1677"></a>
<a name="line-1678"></a>
<a name="line-1679"></a><a name="hscInteractive"></a><span class='hs-definition'>hscInteractive</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1680"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CgGuts</span>
<a name="line-1681"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span>
<a name="line-1682"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>,</span> <span class='hs-conid'>CompiledByteCode</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SptEntry</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1683"></a><span class='hs-definition'>hscInteractive</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>cgguts</span> <span class='hs-varid'>location</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1684"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1685"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1686"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>tmpfs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1687"></a>    <span class='hs-keyword'>let</span> <span class='hs-conid'>CgGuts</span><span class='hs-layout'>{</span> <span class='hs-comment'>-- This is the last use of the ModGuts in a compilation.</span>
<a name="line-1688"></a>                <span class='hs-comment'>-- From now on, we just use the bits we need.</span>
<a name="line-1689"></a>               <span class='hs-varid'>cg_module</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-1690"></a>               <span class='hs-varid'>cg_binds</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>core_binds</span><span class='hs-layout'>,</span>
<a name="line-1691"></a>               <span class='hs-varid'>cg_tycons</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycons</span><span class='hs-layout'>,</span>
<a name="line-1692"></a>               <span class='hs-varid'>cg_foreign</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foreign_stubs</span><span class='hs-layout'>,</span>
<a name="line-1693"></a>               <span class='hs-varid'>cg_modBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_breaks</span><span class='hs-layout'>,</span>
<a name="line-1694"></a>               <span class='hs-varid'>cg_spt_entries</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>spt_entries</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cgguts</span>
<a name="line-1695"></a>
<a name="line-1696"></a>        <span class='hs-varid'>data_tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isDataTyCon</span> <span class='hs-varid'>tycons</span>
<a name="line-1697"></a>        <span class='hs-comment'>-- cg_tycons includes newtypes, for the benefit of External Core,</span>
<a name="line-1698"></a>        <span class='hs-comment'>-- but we don't generate any code for newtypes</span>
<a name="line-1699"></a>
<a name="line-1700"></a>    <span class='hs-comment'>-------------------</span>
<a name="line-1701"></a>    <span class='hs-comment'>-- PREPARE FOR CODE GENERATION</span>
<a name="line-1702"></a>    <span class='hs-comment'>-- Do saturation and convert to A-normal form</span>
<a name="line-1703"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>prepd_binds</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "CorePrep" #-}</span>
<a name="line-1704"></a>                   <span class='hs-varid'>corePrepPgm</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>location</span> <span class='hs-varid'>core_binds</span> <span class='hs-varid'>data_tycons</span>
<a name="line-1705"></a>
<a name="line-1706"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>stg_binds</span><span class='hs-layout'>,</span> <span class='hs-sel'>_infotable_prov</span><span class='hs-layout'>,</span> <span class='hs-sel'>_caf_ccs__caf_cc_stacks</span><span class='hs-layout'>)</span>
<a name="line-1707"></a>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "CoreToStg" #-}</span>
<a name="line-1708"></a>          <span class='hs-varid'>myCoreToStg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>location</span> <span class='hs-varid'>prepd_binds</span>
<a name="line-1709"></a>    <span class='hs-comment'>-----------------  Generate byte code ------------------</span>
<a name="line-1710"></a>    <span class='hs-varid'>comp_bc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>byteCodeGen</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>stg_binds</span> <span class='hs-varid'>data_tycons</span> <span class='hs-varid'>mod_breaks</span>
<a name="line-1711"></a>    <span class='hs-comment'>------------------ Create f-x-dynamic C-side stuff -----</span>
<a name="line-1712"></a>    <span class='hs-layout'>(</span><span class='hs-sel'>_istub_h_exists</span><span class='hs-layout'>,</span> <span class='hs-varid'>istub_c_exists</span><span class='hs-layout'>)</span>
<a name="line-1713"></a>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>outputForeignStubs</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>location</span> <span class='hs-varid'>foreign_stubs</span>
<a name="line-1714"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>istub_c_exists</span><span class='hs-layout'>,</span> <span class='hs-varid'>comp_bc</span><span class='hs-layout'>,</span> <span class='hs-varid'>spt_entries</span><span class='hs-layout'>)</span>
<a name="line-1715"></a>
<a name="line-1716"></a><span class='hs-comment'>------------------------------</span>
<a name="line-1717"></a>
<a name="line-1718"></a><a name="hscCompileCmmFile"></a><span class='hs-definition'>hscCompileCmmFile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>FilePath</span><span class='hs-layout'>)</span>
<a name="line-1719"></a><span class='hs-definition'>hscCompileCmmFile</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>filename</span> <span class='hs-varid'>output_filename</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1720"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1721"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>logger</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1722"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>hooks</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_hooks</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1723"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>tmpfs</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1724"></a>        <span class='hs-varid'>home_unit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_home_unit</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1725"></a>        <span class='hs-varid'>platform</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-1726"></a>        <span class='hs-comment'>-- Make up a module name to give the NCG. We can't pass bottom here</span>
<a name="line-1727"></a>        <span class='hs-comment'>-- lest we reproduce #11784.</span>
<a name="line-1728"></a>        <span class='hs-varid'>mod_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkModuleName</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Cmm$"</span> <span class='hs-varop'>++</span> <span class='hs-conid'>FilePath.takeFileName</span> <span class='hs-varid'>filename</span>
<a name="line-1729"></a>        <span class='hs-varid'>cmm_mod</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkHomeModule</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>mod_name</span>
<a name="line-1730"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>cmm</span><span class='hs-layout'>,</span> <span class='hs-varid'>ents</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ioMsgMaybe</span>
<a name="line-1731"></a>               <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1732"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>warns</span><span class='hs-layout'>,</span><span class='hs-varid'>errs</span><span class='hs-layout'>,</span><span class='hs-varid'>cmm</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"ParseCmm"</span><span class='hs-varop'>&lt;+&gt;</span><span class='hs-varid'>brackets</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>filename</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-1733"></a>                                       <span class='hs-varop'>$</span> <span class='hs-varid'>parseCmmFile</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cmm_mod</span> <span class='hs-varid'>home_unit</span> <span class='hs-varid'>filename</span>
<a name="line-1734"></a>                  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMessages</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>pprWarning</span> <span class='hs-varid'>warns</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>pprError</span> <span class='hs-varid'>errs</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>cmm</span><span class='hs-layout'>)</span>
<a name="line-1735"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1736"></a>        <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cmm_verbose_by_proc</span> <span class='hs-str'>"Parsed Cmm"</span> <span class='hs-conid'>FormatCMM</span> <span class='hs-layout'>(</span><span class='hs-varid'>pdoc</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cmm</span><span class='hs-layout'>)</span>
<a name="line-1737"></a>
<a name="line-1738"></a>        <span class='hs-comment'>-- Compile decls in Cmm files one decl at a time, to avoid re-ordering</span>
<a name="line-1739"></a>        <span class='hs-comment'>-- them in SRT analysis.</span>
<a name="line-1740"></a>        <span class='hs-comment'>--</span>
<a name="line-1741"></a>        <span class='hs-comment'>-- Re-ordering here causes breakage when booting with C backend because</span>
<a name="line-1742"></a>        <span class='hs-comment'>-- in C we must declare before use, but SRT algorithm is free to</span>
<a name="line-1743"></a>        <span class='hs-comment'>-- re-order [A, B] (B refers to A) when A is not CAFFY and return [B, A]</span>
<a name="line-1744"></a>        <span class='hs-varid'>cmmgroup</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1745"></a>          <span class='hs-varid'>concatMapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cmm</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>cmmPipeline</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptySRT</span> <span class='hs-varid'>cmm_mod</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>cmm</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmm</span>
<a name="line-1746"></a>
<a name="line-1747"></a>        <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>cmmgroup</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1748"></a>          <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cmm</span> <span class='hs-str'>"Output Cmm"</span>
<a name="line-1749"></a>            <span class='hs-conid'>FormatCMM</span> <span class='hs-layout'>(</span><span class='hs-varid'>pdoc</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>cmmgroup</span><span class='hs-layout'>)</span>
<a name="line-1750"></a>
<a name="line-1751"></a>        <span class='hs-varid'>rawCmms</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cmmToRawCmmHook</span> <span class='hs-varid'>hooks</span> <span class='hs-keyword'>of</span>
<a name="line-1752"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>cmmToRawCmm</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>         <span class='hs-layout'>(</span><span class='hs-conid'>Stream.yield</span> <span class='hs-varid'>cmmgroup</span><span class='hs-layout'>)</span>
<a name="line-1753"></a>          <span class='hs-conid'>Just</span> <span class='hs-varid'>h</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span>                  <span class='hs-varid'>dflags</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stream.yield</span> <span class='hs-varid'>cmmgroup</span><span class='hs-layout'>)</span>
<a name="line-1754"></a>
<a name="line-1755"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>foreign_stubs</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span>
<a name="line-1756"></a>              <span class='hs-keyword'>let</span> <span class='hs-varid'>ip_init</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ipInitCode</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>cmm_mod</span> <span class='hs-varid'>ents</span>
<a name="line-1757"></a>              <span class='hs-keyword'>in</span> <span class='hs-conid'>NoStubs</span> <span class='hs-varop'>`appendStubC`</span> <span class='hs-varid'>ip_init</span>
<a name="line-1758"></a>
<a name="line-1759"></a>        <span class='hs-layout'>(</span><span class='hs-sel'>_output_filename</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-sel'>_stub_h_exists</span><span class='hs-layout'>,</span> <span class='hs-varid'>stub_c_exists</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-sel'>_foreign_fps</span><span class='hs-layout'>,</span> <span class='hs-sel'>_caf_infos</span><span class='hs-layout'>)</span>
<a name="line-1760"></a>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>codeOutput</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_units</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>cmm_mod</span> <span class='hs-varid'>output_filename</span> <span class='hs-varid'>no_loc</span> <span class='hs-varid'>foreign_stubs</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-1761"></a>             <span class='hs-varid'>rawCmms</span>
<a name="line-1762"></a>        <span class='hs-varid'>return</span> <span class='hs-varid'>stub_c_exists</span>
<a name="line-1763"></a>  <span class='hs-keyword'>where</span>
<a name="line-1764"></a>    <span class='hs-varid'>no_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModLocation</span><span class='hs-layout'>{</span> <span class='hs-varid'>ml_hs_file</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>filename</span><span class='hs-layout'>,</span>
<a name="line-1765"></a>                          <span class='hs-varid'>ml_hi_file</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hscCompileCmmFile: no hi file"</span><span class='hs-layout'>,</span>
<a name="line-1766"></a>                          <span class='hs-varid'>ml_obj_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hscCompileCmmFile: no obj file"</span><span class='hs-layout'>,</span>
<a name="line-1767"></a>                          <span class='hs-varid'>ml_hie_file</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hscCompileCmmFile: no hie file"</span><span class='hs-layout'>}</span>
<a name="line-1768"></a>
<a name="line-1769"></a><span class='hs-comment'>-------------------- Stuff for new code gen ---------------------</span>
<a name="line-1770"></a>
<a name="line-1771"></a><span class='hs-comment'>{-
<a name="line-1772"></a>Note [Forcing of stg_binds]
<a name="line-1773"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1774"></a>
<a name="line-1775"></a>The two last steps in the STG pipeline are:
<a name="line-1776"></a>
<a name="line-1777"></a>* Sorting the bindings in dependency order.
<a name="line-1778"></a>* Annotating them with free variables.
<a name="line-1779"></a>
<a name="line-1780"></a>We want to make sure we do not keep references to unannotated STG bindings
<a name="line-1781"></a>alive, nor references to bindings which have already been compiled to Cmm.
<a name="line-1782"></a>
<a name="line-1783"></a>We explicitly force the bindings to avoid this.
<a name="line-1784"></a>
<a name="line-1785"></a>This reduces residency towards the end of the CodeGen phase significantly
<a name="line-1786"></a>(5-10%).
<a name="line-1787"></a>-}</span>
<a name="line-1788"></a>
<a name="line-1789"></a><a name="doCodeGen"></a><span class='hs-definition'>doCodeGen</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InfoTableProvMap</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCon</span><span class='hs-keyglyph'>]</span>
<a name="line-1790"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CollectedCCs</span>
<a name="line-1791"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgTopBinding</span><span class='hs-keyglyph'>]</span>
<a name="line-1792"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HpcInfo</span>
<a name="line-1793"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stream</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CmmGroupSRTs</span> <span class='hs-conid'>CgInfos</span><span class='hs-layout'>)</span>
<a name="line-1794"></a>         <span class='hs-comment'>-- Note we produce a 'Stream' of CmmGroups, so that the</span>
<a name="line-1795"></a>         <span class='hs-comment'>-- backend can be run incrementally.  Otherwise it generates all</span>
<a name="line-1796"></a>         <span class='hs-comment'>-- the C-- up front, which has a significant space cost.</span>
<a name="line-1797"></a><span class='hs-definition'>doCodeGen</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>denv</span> <span class='hs-varid'>data_tycons</span>
<a name="line-1798"></a>              <span class='hs-varid'>cost_centre_info</span> <span class='hs-varid'>stg_binds</span> <span class='hs-varid'>hpc_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1799"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1800"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1801"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>hooks</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_hooks</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1802"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>tmpfs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_tmpfs</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1803"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>platform</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>targetPlatform</span> <span class='hs-varid'>dflags</span>
<a name="line-1804"></a>
<a name="line-1805"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>stg_binds_w_fvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>annTopBindingsFreeVars</span> <span class='hs-varid'>stg_binds</span>
<a name="line-1806"></a>
<a name="line-1807"></a>    <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_stg_final</span> <span class='hs-str'>"Final STG:"</span> <span class='hs-conid'>FormatSTG</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprGenStgTopBindings</span> <span class='hs-layout'>(</span><span class='hs-varid'>initStgPprOpts</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>stg_binds_w_fvs</span><span class='hs-layout'>)</span>
<a name="line-1808"></a>
<a name="line-1809"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>stg_to_cmm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>stgToCmmHook</span> <span class='hs-varid'>hooks</span> <span class='hs-keyword'>of</span>
<a name="line-1810"></a>                        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StgToCmm.codeGen</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>tmpfs</span>
<a name="line-1811"></a>                        <span class='hs-conid'>Just</span> <span class='hs-varid'>h</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span>
<a name="line-1812"></a>
<a name="line-1813"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>cmm_stream</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stream</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CmmGroup</span> <span class='hs-layout'>(</span><span class='hs-conid'>CStub</span><span class='hs-layout'>,</span> <span class='hs-conid'>ModuleLFInfos</span><span class='hs-layout'>)</span>
<a name="line-1814"></a>        <span class='hs-comment'>-- See Note [Forcing of stg_binds]</span>
<a name="line-1815"></a>        <span class='hs-varid'>cmm_stream</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stg_binds_w_fvs</span> <span class='hs-varop'>`seqList`</span> <span class='hs-comment'>{-# SCC "StgToCmm" #-}</span>
<a name="line-1816"></a>            <span class='hs-varid'>stg_to_cmm</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>denv</span> <span class='hs-varid'>data_tycons</span> <span class='hs-varid'>cost_centre_info</span> <span class='hs-varid'>stg_binds_w_fvs</span> <span class='hs-varid'>hpc_info</span>
<a name="line-1817"></a>
<a name="line-1818"></a>        <span class='hs-comment'>-- codegen consumes a stream of CmmGroup, and produces a new</span>
<a name="line-1819"></a>        <span class='hs-comment'>-- stream of CmmGroup (not necessarily synchronised: one</span>
<a name="line-1820"></a>        <span class='hs-comment'>-- CmmGroup on input may produce many CmmGroups on output due</span>
<a name="line-1821"></a>        <span class='hs-comment'>-- to proc-point splitting).</span>
<a name="line-1822"></a>
<a name="line-1823"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>dump1</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1824"></a>          <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1825"></a>            <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cmm_from_stg</span>
<a name="line-1826"></a>              <span class='hs-str'>"Cmm produced by codegen"</span> <span class='hs-conid'>FormatCMM</span> <span class='hs-layout'>(</span><span class='hs-varid'>pdoc</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1827"></a>          <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
<a name="line-1828"></a>
<a name="line-1829"></a>        <span class='hs-varid'>ppr_stream1</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stream.mapM</span> <span class='hs-varid'>dump1</span> <span class='hs-varid'>cmm_stream</span>
<a name="line-1830"></a>
<a name="line-1831"></a>        <span class='hs-varid'>pipeline_stream</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Stream</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>CmmGroupSRTs</span> <span class='hs-conid'>CgInfos</span>
<a name="line-1832"></a>        <span class='hs-varid'>pipeline_stream</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1833"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>non_cafs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>used_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>lf_infos</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1834"></a>            <span class='hs-comment'>{-# SCC "cmmPipeline" #-}</span>
<a name="line-1835"></a>            <span class='hs-conid'>Stream.mapAccumL_</span> <span class='hs-layout'>(</span><span class='hs-varid'>cmmPipeline</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>emptySRT</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>)</span> <span class='hs-varid'>ppr_stream1</span>
<a name="line-1836"></a>              <span class='hs-varop'>&lt;&amp;&gt;</span> <span class='hs-varid'>first</span> <span class='hs-layout'>(</span><span class='hs-varid'>srtMapNonCAFs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>moduleSRTMap</span><span class='hs-layout'>)</span>
<a name="line-1837"></a>
<a name="line-1838"></a>          <span class='hs-varid'>return</span> <span class='hs-conid'>CgInfos</span><span class='hs-layout'>{</span> <span class='hs-varid'>cgNonCafs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>non_cafs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgLFInfos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lf_infos</span><span class='hs-layout'>,</span> <span class='hs-varid'>cgIPEStub</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>used_info</span> <span class='hs-layout'>}</span>
<a name="line-1839"></a>
<a name="line-1840"></a>        <span class='hs-varid'>dump2</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1841"></a>          <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1842"></a>            <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_cmm</span> <span class='hs-str'>"Output Cmm"</span> <span class='hs-conid'>FormatCMM</span> <span class='hs-layout'>(</span><span class='hs-varid'>pdoc</span> <span class='hs-varid'>platform</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1843"></a>          <span class='hs-varid'>return</span> <span class='hs-varid'>a</span>
<a name="line-1844"></a>
<a name="line-1845"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stream.mapM</span> <span class='hs-varid'>dump2</span> <span class='hs-varid'>pipeline_stream</span><span class='hs-layout'>)</span>
<a name="line-1846"></a>
<a name="line-1847"></a><a name="myCoreToStgExpr"></a><span class='hs-definition'>myCoreToStgExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InteractiveContext</span>
<a name="line-1848"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span>
<a name="line-1849"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Id</span>
<a name="line-1850"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgTopBinding</span><span class='hs-keyglyph'>]</span>
<a name="line-1851"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>InfoTableProvMap</span>
<a name="line-1852"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>CollectedCCs</span> <span class='hs-layout'>)</span>
<a name="line-1853"></a><span class='hs-definition'>myCoreToStgExpr</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ictxt</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>ml</span> <span class='hs-varid'>prepd_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1854"></a>    <span class='hs-comment'>{- Create a temporary binding (just because myCoreToStg needs a
<a name="line-1855"></a>       binding for the stg2stg step) -}</span>
<a name="line-1856"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>bco_tmp_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkSysLocal</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"BCO_toplevel"</span><span class='hs-layout'>)</span>
<a name="line-1857"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>mkPseudoUniqueE</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span>
<a name="line-1858"></a>                                <span class='hs-conid'>Many</span>
<a name="line-1859"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>exprType</span> <span class='hs-varid'>prepd_expr</span><span class='hs-layout'>)</span>
<a name="line-1860"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>stg_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov_map</span><span class='hs-layout'>,</span> <span class='hs-varid'>collected_ccs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1861"></a>       <span class='hs-varid'>myCoreToStg</span> <span class='hs-varid'>logger</span>
<a name="line-1862"></a>                   <span class='hs-varid'>dflags</span>
<a name="line-1863"></a>                   <span class='hs-varid'>ictxt</span>
<a name="line-1864"></a>                   <span class='hs-varid'>this_mod</span>
<a name="line-1865"></a>                   <span class='hs-varid'>ml</span>
<a name="line-1866"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-conid'>NonRec</span> <span class='hs-varid'>bco_tmp_id</span> <span class='hs-varid'>prepd_expr</span><span class='hs-keyglyph'>]</span>
<a name="line-1867"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>bco_tmp_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>stg_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>prov_map</span><span class='hs-layout'>,</span> <span class='hs-varid'>collected_ccs</span><span class='hs-layout'>)</span>
<a name="line-1868"></a>
<a name="line-1869"></a><a name="myCoreToStg"></a><span class='hs-definition'>myCoreToStg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Logger</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>InteractiveContext</span>
<a name="line-1870"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Module</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ModLocation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreProgram</span>
<a name="line-1871"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StgTopBinding</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- output program</span>
<a name="line-1872"></a>                  <span class='hs-layout'>,</span> <span class='hs-conid'>InfoTableProvMap</span>
<a name="line-1873"></a>                  <span class='hs-layout'>,</span> <span class='hs-conid'>CollectedCCs</span> <span class='hs-layout'>)</span>  <span class='hs-comment'>-- CAF cost centre info (declared and used)</span>
<a name="line-1874"></a><span class='hs-definition'>myCoreToStg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ictxt</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>ml</span> <span class='hs-varid'>prepd_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1875"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>stg_binds</span><span class='hs-layout'>,</span> <span class='hs-varid'>denv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cost_centre_info</span><span class='hs-layout'>)</span>
<a name="line-1876"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-comment'>{-# SCC "Core2Stg" #-}</span>
<a name="line-1877"></a>           <span class='hs-varid'>coreToStg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>ml</span> <span class='hs-varid'>prepd_binds</span>
<a name="line-1878"></a>
<a name="line-1879"></a>    <span class='hs-varid'>stg_binds2</span>
<a name="line-1880"></a>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "Stg2Stg" #-}</span>
<a name="line-1881"></a>           <span class='hs-varid'>stg2stg</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>ictxt</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>stg_binds</span>
<a name="line-1882"></a>
<a name="line-1883"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>stg_binds2</span><span class='hs-layout'>,</span> <span class='hs-varid'>denv</span><span class='hs-layout'>,</span> <span class='hs-varid'>cost_centre_info</span><span class='hs-layout'>)</span>
<a name="line-1884"></a>
<a name="line-1885"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-1886"></a>%*                                                                      *
<a name="line-1887"></a>\subsection{Compiling a do-statement}
<a name="line-1888"></a>%*                                                                      *
<a name="line-1889"></a>%********************************************************************* -}</span>
<a name="line-1890"></a>
<a name="line-1891"></a><span class='hs-comment'>{-
<a name="line-1892"></a>When the UnlinkedBCOExpr is linked you get an HValue of type *IO [HValue]* When
<a name="line-1893"></a>you run it you get a list of HValues that should be the same length as the list
<a name="line-1894"></a>of names; add them to the ClosureEnv.
<a name="line-1895"></a>
<a name="line-1896"></a>A naked expression returns a singleton Name [it]. The stmt is lifted into the
<a name="line-1897"></a>IO monad as explained in Note [Interactively-bound Ids in GHCi] in GHC.Runtime.Context
<a name="line-1898"></a>-}</span>
<a name="line-1899"></a>
<a name="line-1900"></a><a name="hscStmt"></a><span class='hs-comment'>-- | Compile a stmt all the way to an HValue, but don't run it</span>
<a name="line-1901"></a><span class='hs-comment'>--</span>
<a name="line-1902"></a><span class='hs-comment'>-- We return Nothing to indicate an empty statement (or comment only), not a</span>
<a name="line-1903"></a><span class='hs-comment'>-- parse error.</span>
<a name="line-1904"></a><span class='hs-definition'>hscStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>ForeignHValue</span><span class='hs-layout'>,</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1905"></a><span class='hs-definition'>hscStmt</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscStmtWithLocation</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stmt</span> <span class='hs-str'>"&lt;interactive&gt;"</span> <span class='hs-num'>1</span>
<a name="line-1906"></a>
<a name="line-1907"></a><a name="hscStmtWithLocation"></a><span class='hs-comment'>-- | Compile a stmt all the way to an HValue, but don't run it</span>
<a name="line-1908"></a><span class='hs-comment'>--</span>
<a name="line-1909"></a><span class='hs-comment'>-- We return Nothing to indicate an empty statement (or comment only), not a</span>
<a name="line-1910"></a><span class='hs-comment'>-- parse error.</span>
<a name="line-1911"></a><span class='hs-definition'>hscStmtWithLocation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1912"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ The statement</span>
<a name="line-1913"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ The source</span>
<a name="line-1914"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>    <span class='hs-comment'>-- ^ Starting line</span>
<a name="line-1915"></a>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-1916"></a>                          <span class='hs-layout'>,</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-comment'>{- IO [HValue] -}</span>
<a name="line-1917"></a>                          <span class='hs-layout'>,</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1918"></a><span class='hs-definition'>hscStmtWithLocation</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>stmt</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-keyglyph'>=</span>
<a name="line-1919"></a>  <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1920"></a>    <span class='hs-varid'>maybe_stmt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscParseStmtWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-varid'>stmt</span>
<a name="line-1921"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_stmt</span> <span class='hs-keyword'>of</span>
<a name="line-1922"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-1923"></a>
<a name="line-1924"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>parsed_stmt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1925"></a>        <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1926"></a>        <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscParsedStmt</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>parsed_stmt</span>
<a name="line-1927"></a>
<a name="line-1928"></a><a name="hscParsedStmt"></a><span class='hs-definition'>hscParsedStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1929"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GhciLStmt</span> <span class='hs-conid'>GhcPs</span>  <span class='hs-comment'>-- ^ The parsed statement</span>
<a name="line-1930"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Id</span><span class='hs-keyglyph'>]</span>
<a name="line-1931"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>ForeignHValue</span> <span class='hs-comment'>{- IO [HValue] -}</span>
<a name="line-1932"></a>                    <span class='hs-layout'>,</span> <span class='hs-conid'>FixityEnv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1933"></a><span class='hs-definition'>hscParsedStmt</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1934"></a>  <span class='hs-comment'>-- Rename and typecheck it</span>
<a name="line-1935"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>tc_expr</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnStmt</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>stmt</span>
<a name="line-1936"></a>
<a name="line-1937"></a>  <span class='hs-comment'>-- Desugar it</span>
<a name="line-1938"></a>  <span class='hs-varid'>ds_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>deSugarExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tc_expr</span>
<a name="line-1939"></a>  <span class='hs-varid'>liftIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>lintInteractiveExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"desugar expression"</span><span class='hs-layout'>)</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>ds_expr</span><span class='hs-layout'>)</span>
<a name="line-1940"></a>  <span class='hs-varid'>handleWarnings</span>
<a name="line-1941"></a>
<a name="line-1942"></a>  <span class='hs-comment'>-- Then code-gen, and link it</span>
<a name="line-1943"></a>  <span class='hs-comment'>-- It's important NOT to have package 'interactive' as thisUnitId</span>
<a name="line-1944"></a>  <span class='hs-comment'>-- for linking, else we try to link 'main' and can't find it.</span>
<a name="line-1945"></a>  <span class='hs-comment'>-- Whereas the linker already knows to ignore 'interactive'</span>
<a name="line-1946"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>src_span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcLocSpan</span> <span class='hs-varid'>interactiveSrcLoc</span>
<a name="line-1947"></a>  <span class='hs-varid'>hval</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscCompileCoreExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_span</span> <span class='hs-varid'>ds_expr</span>
<a name="line-1948"></a>
<a name="line-1949"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ids</span><span class='hs-layout'>,</span> <span class='hs-varid'>hval</span><span class='hs-layout'>,</span> <span class='hs-varid'>fix_env</span><span class='hs-layout'>)</span>
<a name="line-1950"></a>
<a name="line-1951"></a><a name="hscDecls"></a><span class='hs-comment'>-- | Compile a decls</span>
<a name="line-1952"></a><span class='hs-definition'>hscDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1953"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ The statement</span>
<a name="line-1954"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>InteractiveContext</span><span class='hs-layout'>)</span>
<a name="line-1955"></a><span class='hs-definition'>hscDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscDeclsWithLocation</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>str</span> <span class='hs-str'>"&lt;interactive&gt;"</span> <span class='hs-num'>1</span>
<a name="line-1956"></a>
<a name="line-1957"></a><a name="hscParseDeclsWithLocation"></a><span class='hs-definition'>hscParseDeclsWithLocation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span>
<a name="line-1958"></a><span class='hs-definition'>hscParseDeclsWithLocation</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>source</span> <span class='hs-varid'>line_num</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1959"></a>    <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsModule</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsmodDecls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1960"></a>      <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-1961"></a>        <span class='hs-varid'>hscParseThingWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>line_num</span> <span class='hs-varid'>parseModule</span> <span class='hs-varid'>str</span>
<a name="line-1962"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>decls</span>
<a name="line-1963"></a>
<a name="line-1964"></a><a name="hscDeclsWithLocation"></a><span class='hs-comment'>-- | Compile a decls</span>
<a name="line-1965"></a><span class='hs-definition'>hscDeclsWithLocation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-1966"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ The statement</span>
<a name="line-1967"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ The source</span>
<a name="line-1968"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>    <span class='hs-comment'>-- ^ Starting line</span>
<a name="line-1969"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>InteractiveContext</span><span class='hs-layout'>)</span>
<a name="line-1970"></a><span class='hs-definition'>hscDeclsWithLocation</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>str</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1971"></a>    <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsModule</span><span class='hs-layout'>{</span> <span class='hs-varid'>hsmodDecls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>decls</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-1972"></a>      <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span>
<a name="line-1973"></a>        <span class='hs-varid'>hscParseThingWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-varid'>parseModule</span> <span class='hs-varid'>str</span>
<a name="line-1974"></a>    <span class='hs-varid'>hscParsedDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>decls</span>
<a name="line-1975"></a>
<a name="line-1976"></a><a name="hscParsedDecls"></a><span class='hs-definition'>hscParsedDecls</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyThing</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>InteractiveContext</span><span class='hs-layout'>)</span>
<a name="line-1977"></a><span class='hs-definition'>hscParsedDecls</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>decls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-1978"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-1979"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscInterp</span> <span class='hs-varid'>hsc_env</span>
<a name="line-1980"></a>
<a name="line-1981"></a>    <span class='hs-comment'>{- Rename and typecheck it -}</span>
<a name="line-1982"></a>    <span class='hs-varid'>tc_gblenv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnDeclsi</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>decls</span>
<a name="line-1983"></a>
<a name="line-1984"></a>    <span class='hs-comment'>{- Grab the new instances -}</span>
<a name="line-1985"></a>    <span class='hs-comment'>-- We grab the whole environment because of the overlapping that may have</span>
<a name="line-1986"></a>    <span class='hs-comment'>-- been done. See the notes at the definition of InteractiveContext</span>
<a name="line-1987"></a>    <span class='hs-comment'>-- (ic_instances) for more details.</span>
<a name="line-1988"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>defaults</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_default</span> <span class='hs-varid'>tc_gblenv</span>
<a name="line-1989"></a>
<a name="line-1990"></a>    <span class='hs-comment'>{- Desugar it -}</span>
<a name="line-1991"></a>    <span class='hs-comment'>-- We use a basically null location for iNTERACTIVE</span>
<a name="line-1992"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>iNTERACTIVELoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModLocation</span><span class='hs-layout'>{</span> <span class='hs-varid'>ml_hs_file</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>
<a name="line-1993"></a>                                      <span class='hs-varid'>ml_hi_file</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hsDeclsWithLocation:ml_hi_file"</span><span class='hs-layout'>,</span>
<a name="line-1994"></a>                                      <span class='hs-varid'>ml_obj_file</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hsDeclsWithLocation:ml_obj_file"</span><span class='hs-layout'>,</span>
<a name="line-1995"></a>                                      <span class='hs-varid'>ml_hie_file</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hsDeclsWithLocation:ml_hie_file"</span> <span class='hs-layout'>}</span>
<a name="line-1996"></a>    <span class='hs-varid'>ds_result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscDesugar'</span> <span class='hs-varid'>iNTERACTIVELoc</span> <span class='hs-varid'>tc_gblenv</span>
<a name="line-1997"></a>
<a name="line-1998"></a>    <span class='hs-comment'>{- Simplify -}</span>
<a name="line-1999"></a>    <span class='hs-varid'>simpl_mg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-2000"></a>      <span class='hs-varid'>plugins</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcg_th_coreplugins</span> <span class='hs-varid'>tc_gblenv</span><span class='hs-layout'>)</span>
<a name="line-2001"></a>      <span class='hs-varid'>hscSimplify</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>plugins</span> <span class='hs-varid'>ds_result</span>
<a name="line-2002"></a>
<a name="line-2003"></a>    <span class='hs-comment'>{- Tidy -}</span>
<a name="line-2004"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>tidy_cg</span><span class='hs-layout'>,</span> <span class='hs-varid'>mod_details</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tidyProgram</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>simpl_mg</span>
<a name="line-2005"></a>
<a name="line-2006"></a>    <span class='hs-keyword'>let</span> <span class='hs-varop'>!</span><span class='hs-conid'>CgGuts</span><span class='hs-layout'>{</span> <span class='hs-varid'>cg_module</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this_mod</span><span class='hs-layout'>,</span>
<a name="line-2007"></a>                 <span class='hs-varid'>cg_binds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>core_binds</span><span class='hs-layout'>,</span>
<a name="line-2008"></a>                 <span class='hs-varid'>cg_tycons</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tycons</span><span class='hs-layout'>,</span>
<a name="line-2009"></a>                 <span class='hs-varid'>cg_modBreaks</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_breaks</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_cg</span>
<a name="line-2010"></a>
<a name="line-2011"></a>        <span class='hs-varop'>!</span><span class='hs-conid'>ModDetails</span> <span class='hs-layout'>{</span> <span class='hs-varid'>md_insts</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cls_insts</span>
<a name="line-2012"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>md_fam_insts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fam_insts</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mod_details</span>
<a name="line-2013"></a>            <span class='hs-comment'>-- Get the *tidied* cls_insts and fam_insts</span>
<a name="line-2014"></a>
<a name="line-2015"></a>        <span class='hs-varid'>data_tycons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>isDataTyCon</span> <span class='hs-varid'>tycons</span>
<a name="line-2016"></a>
<a name="line-2017"></a>    <span class='hs-comment'>{- Prepare For Code Generation -}</span>
<a name="line-2018"></a>    <span class='hs-comment'>-- Do saturation and convert to A-normal form</span>
<a name="line-2019"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>prepd_binds</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "CorePrep" #-}</span>
<a name="line-2020"></a>      <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>corePrepPgm</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span> <span class='hs-varid'>iNTERACTIVELoc</span> <span class='hs-varid'>core_binds</span> <span class='hs-varid'>data_tycons</span>
<a name="line-2021"></a>
<a name="line-2022"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>stg_binds</span><span class='hs-layout'>,</span> <span class='hs-sel'>_infotable_prov</span><span class='hs-layout'>,</span> <span class='hs-sel'>_caf_ccs__caf_cc_stacks</span><span class='hs-layout'>)</span>
<a name="line-2023"></a>        <span class='hs-keyglyph'>&lt;-</span> <span class='hs-comment'>{-# SCC "CoreToStg" #-}</span>
<a name="line-2024"></a>           <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>myCoreToStg</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-2025"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-2026"></a>                                <span class='hs-layout'>(</span><span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-2027"></a>                                <span class='hs-varid'>this_mod</span>
<a name="line-2028"></a>                                <span class='hs-varid'>iNTERACTIVELoc</span>
<a name="line-2029"></a>                                <span class='hs-varid'>prepd_binds</span>
<a name="line-2030"></a>
<a name="line-2031"></a>    <span class='hs-comment'>{- Generate byte code -}</span>
<a name="line-2032"></a>    <span class='hs-varid'>cbc</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>byteCodeGen</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>this_mod</span>
<a name="line-2033"></a>                                <span class='hs-varid'>stg_binds</span> <span class='hs-varid'>data_tycons</span> <span class='hs-varid'>mod_breaks</span>
<a name="line-2034"></a>
<a name="line-2035"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>src_span</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>srcLocSpan</span> <span class='hs-varid'>interactiveSrcLoc</span>
<a name="line-2036"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>loadDecls</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>src_span</span> <span class='hs-varid'>cbc</span>
<a name="line-2037"></a>
<a name="line-2038"></a>    <span class='hs-comment'>{- Load static pointer table entries -}</span>
<a name="line-2039"></a>    <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscAddSptEntries</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>cg_spt_entries</span> <span class='hs-varid'>tidy_cg</span><span class='hs-layout'>)</span>
<a name="line-2040"></a>
<a name="line-2041"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>tcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filterOut</span> <span class='hs-varid'>isImplicitTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>mg_tcs</span> <span class='hs-varid'>simpl_mg</span><span class='hs-layout'>)</span>
<a name="line-2042"></a>        <span class='hs-varid'>patsyns</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mg_patsyns</span> <span class='hs-varid'>simpl_mg</span>
<a name="line-2043"></a>
<a name="line-2044"></a>        <span class='hs-varid'>ext_ids</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>id</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindersOfBinds</span> <span class='hs-varid'>core_binds</span>
<a name="line-2045"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>isExternalName</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-2046"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isDFunId</span> <span class='hs-varid'>id</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isImplicitId</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2047"></a>            <span class='hs-comment'>-- We only need to keep around the external bindings</span>
<a name="line-2048"></a>            <span class='hs-comment'>-- (as decided by GHC.Iface.Tidy), since those are the only ones</span>
<a name="line-2049"></a>            <span class='hs-comment'>-- that might later be looked up by name.  But we can exclude</span>
<a name="line-2050"></a>            <span class='hs-comment'>--    - DFunIds, which are in 'cls_insts' (see Note [ic_tythings] in GHC.Runtime.Context</span>
<a name="line-2051"></a>            <span class='hs-comment'>--    - Implicit Ids, which are implicit in tcs</span>
<a name="line-2052"></a>            <span class='hs-comment'>-- c.f. GHC.Tc.Module.runTcInteractive, which reconstructs the TypeEnv</span>
<a name="line-2053"></a>
<a name="line-2054"></a>        <span class='hs-varid'>new_tythings</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-conid'>AnId</span> <span class='hs-varid'>ext_ids</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tcs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-varop'>.</span> <span class='hs-conid'>PatSynCon</span><span class='hs-layout'>)</span> <span class='hs-varid'>patsyns</span>
<a name="line-2055"></a>        <span class='hs-varid'>ictxt</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2056"></a>        <span class='hs-comment'>-- See Note [Fixity declarations in GHCi]</span>
<a name="line-2057"></a>        <span class='hs-varid'>fix_env</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcg_fix_env</span> <span class='hs-varid'>tc_gblenv</span>
<a name="line-2058"></a>        <span class='hs-varid'>new_ictxt</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendInteractiveContext</span> <span class='hs-varid'>ictxt</span> <span class='hs-varid'>new_tythings</span> <span class='hs-varid'>cls_insts</span>
<a name="line-2059"></a>                                                <span class='hs-varid'>fam_insts</span> <span class='hs-varid'>defaults</span> <span class='hs-varid'>fix_env</span>
<a name="line-2060"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_tythings</span><span class='hs-layout'>,</span> <span class='hs-varid'>new_ictxt</span><span class='hs-layout'>)</span>
<a name="line-2061"></a>
<a name="line-2062"></a><a name="hscAddSptEntries"></a><span class='hs-comment'>-- | Load the given static-pointer table entries into the interpreter.</span>
<a name="line-2063"></a><span class='hs-comment'>-- See Note [Grand plan for static forms] in "GHC.Iface.Tidy.StaticPtrTable".</span>
<a name="line-2064"></a><span class='hs-definition'>hscAddSptEntries</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SptEntry</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2065"></a><span class='hs-definition'>hscAddSptEntries</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>entries</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2066"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>interp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscInterp</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2067"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>add_spt_entry</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SptEntry</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2068"></a>        <span class='hs-varid'>add_spt_entry</span> <span class='hs-layout'>(</span><span class='hs-conid'>SptEntry</span> <span class='hs-varid'>i</span> <span class='hs-varid'>fpr</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2069"></a>            <span class='hs-varid'>val</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadName</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>hsc_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-2070"></a>            <span class='hs-varid'>addSptEntry</span> <span class='hs-varid'>interp</span> <span class='hs-varid'>fpr</span> <span class='hs-varid'>val</span>
<a name="line-2071"></a>    <span class='hs-varid'>mapM_</span> <span class='hs-varid'>add_spt_entry</span> <span class='hs-varid'>entries</span>
<a name="line-2072"></a>
<a name="line-2073"></a><span class='hs-comment'>{-
<a name="line-2074"></a>  Note [Fixity declarations in GHCi]
<a name="line-2075"></a>  ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2076"></a>
<a name="line-2077"></a>  To support fixity declarations on types defined within GHCi (as requested
<a name="line-2078"></a>  in #10018) we record the fixity environment in InteractiveContext.
<a name="line-2079"></a>  When we want to evaluate something GHC.Tc.Module.runTcInteractive pulls out this
<a name="line-2080"></a>  fixity environment and uses it to initialize the global typechecker environment.
<a name="line-2081"></a>  After the typechecker has finished its business, an updated fixity environment
<a name="line-2082"></a>  (reflecting whatever fixity declarations were present in the statements we
<a name="line-2083"></a>  passed it) will be returned from hscParsedStmt. This is passed to
<a name="line-2084"></a>  updateFixityEnv, which will stuff it back into InteractiveContext, to be
<a name="line-2085"></a>  used in evaluating the next statement.
<a name="line-2086"></a>
<a name="line-2087"></a>-}</span>
<a name="line-2088"></a>
<a name="line-2089"></a><a name="hscImport"></a><span class='hs-definition'>hscImport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>ImportDecl</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-2090"></a><span class='hs-definition'>hscImport</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-2091"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsModule</span><span class='hs-layout'>{</span><span class='hs-varid'>hsmodImports</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>is</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-2092"></a>       <span class='hs-varid'>hscParseThing</span> <span class='hs-varid'>parseModule</span> <span class='hs-varid'>str</span>
<a name="line-2093"></a>    <span class='hs-keyword'>case</span> <span class='hs-varid'>is</span> <span class='hs-keyword'>of</span>
<a name="line-2094"></a>        <span class='hs-keyglyph'>[</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>i</span>
<a name="line-2095"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span>
<a name="line-2096"></a>                 <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-varop'>$</span>
<a name="line-2097"></a>                     <span class='hs-varid'>text</span> <span class='hs-str'>"parse error in import declaration"</span>
<a name="line-2098"></a>
<a name="line-2099"></a><a name="hscTcExpr"></a><span class='hs-comment'>-- | Typecheck an expression (but don't run it)</span>
<a name="line-2100"></a><span class='hs-definition'>hscTcExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2101"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcRnExprMode</span>
<a name="line-2102"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ The expression</span>
<a name="line-2103"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Type</span>
<a name="line-2104"></a><span class='hs-definition'>hscTcExpr</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-2105"></a>  <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-2106"></a>  <span class='hs-varid'>parsed_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscParseExpr</span> <span class='hs-varid'>expr</span>
<a name="line-2107"></a>  <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>parsed_expr</span>
<a name="line-2108"></a>
<a name="line-2109"></a><a name="hscKcType"></a><span class='hs-comment'>-- | Find the kind of a type, after generalisation</span>
<a name="line-2110"></a><span class='hs-definition'>hscKcType</span>
<a name="line-2111"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span>
<a name="line-2112"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>            <span class='hs-comment'>-- ^ Normalise the type</span>
<a name="line-2113"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>          <span class='hs-comment'>-- ^ The type as a string</span>
<a name="line-2114"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Type</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ Resulting type (possibly normalised) and kind</span>
<a name="line-2115"></a><span class='hs-definition'>hscKcType</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env0</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-2116"></a>    <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getHscEnv</span>
<a name="line-2117"></a>    <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscParseType</span> <span class='hs-varid'>str</span>
<a name="line-2118"></a>    <span class='hs-varid'>ioMsgMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcRnType</span> <span class='hs-varid'>hsc_env</span> <span class='hs-conid'>DefaultFlexi</span> <span class='hs-varid'>normalise</span> <span class='hs-varid'>ty</span>
<a name="line-2119"></a>
<a name="line-2120"></a><a name="hscParseExpr"></a><span class='hs-definition'>hscParseExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsExpr</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-2121"></a><span class='hs-definition'>hscParseExpr</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2122"></a>  <span class='hs-varid'>maybe_stmt</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hscParseStmt</span> <span class='hs-varid'>expr</span>
<a name="line-2123"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_stmt</span> <span class='hs-keyword'>of</span>
<a name="line-2124"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>BodyStmt</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>expr</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>expr</span>
<a name="line-2125"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwOneError</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkPlainMsgEnvelope</span> <span class='hs-varid'>noSrcSpan</span>
<a name="line-2126"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"not an expression:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>expr</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2127"></a>
<a name="line-2128"></a><a name="hscParseStmt"></a><span class='hs-definition'>hscParseStmt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>GhciLStmt</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2129"></a><span class='hs-definition'>hscParseStmt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscParseThing</span> <span class='hs-varid'>parseStmt</span>
<a name="line-2130"></a>
<a name="line-2131"></a><a name="hscParseStmtWithLocation"></a><span class='hs-definition'>hscParseStmtWithLocation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-2132"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>GhciLStmt</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2133"></a><span class='hs-definition'>hscParseStmtWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-varid'>stmt</span> <span class='hs-keyglyph'>=</span>
<a name="line-2134"></a>    <span class='hs-varid'>hscParseThingWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-varid'>parseStmt</span> <span class='hs-varid'>stmt</span>
<a name="line-2135"></a>
<a name="line-2136"></a><a name="hscParseType"></a><span class='hs-definition'>hscParseType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcPs</span><span class='hs-layout'>)</span>
<a name="line-2137"></a><span class='hs-definition'>hscParseType</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscParseThing</span> <span class='hs-varid'>parseType</span>
<a name="line-2138"></a>
<a name="line-2139"></a><a name="hscParseIdentifier"></a><span class='hs-definition'>hscParseIdentifier</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>RdrName</span><span class='hs-layout'>)</span>
<a name="line-2140"></a><span class='hs-definition'>hscParseIdentifier</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span>
<a name="line-2141"></a>    <span class='hs-varid'>runInteractiveHsc</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hscParseThing</span> <span class='hs-varid'>parseIdentifier</span> <span class='hs-varid'>str</span>
<a name="line-2142"></a>
<a name="line-2143"></a><a name="hscParseThing"></a><span class='hs-definition'>hscParseThing</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-2144"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Lexer.P</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-varid'>thing</span>
<a name="line-2145"></a><span class='hs-definition'>hscParseThing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hscParseThingWithLocation</span> <span class='hs-str'>"&lt;interactive&gt;"</span> <span class='hs-num'>1</span>
<a name="line-2146"></a>
<a name="line-2147"></a><a name="hscParseThingWithLocation"></a><span class='hs-definition'>hscParseThingWithLocation</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>thing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>
<a name="line-2148"></a>                          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Lexer.P</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hsc</span> <span class='hs-varid'>thing</span>
<a name="line-2149"></a><span class='hs-definition'>hscParseThingWithLocation</span> <span class='hs-varid'>source</span> <span class='hs-varid'>linenumber</span> <span class='hs-varid'>parser</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2150"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-2151"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLogger</span>
<a name="line-2152"></a>    <span class='hs-varid'>withTiming</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span>
<a name="line-2153"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Parser [source]"</span><span class='hs-layout'>)</span>
<a name="line-2154"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-comment'>{-# SCC "Parser" #-}</span> <span class='hs-keyword'>do</span>
<a name="line-2155"></a>
<a name="line-2156"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stringToStringBuffer</span> <span class='hs-varid'>str</span>
<a name="line-2157"></a>            <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkRealSrcLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-varid'>source</span><span class='hs-layout'>)</span> <span class='hs-varid'>linenumber</span> <span class='hs-num'>1</span>
<a name="line-2158"></a>
<a name="line-2159"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>unP</span> <span class='hs-varid'>parser</span> <span class='hs-layout'>(</span><span class='hs-varid'>initParserState</span> <span class='hs-layout'>(</span><span class='hs-varid'>initParserOpts</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>buf</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-2160"></a>            <span class='hs-conid'>PFailed</span> <span class='hs-varid'>pst</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2161"></a>                <span class='hs-varid'>handleWarningsThrowErrors</span> <span class='hs-layout'>(</span><span class='hs-varid'>getMessages</span> <span class='hs-varid'>pst</span><span class='hs-layout'>)</span>
<a name="line-2162"></a>            <span class='hs-conid'>POk</span> <span class='hs-varid'>pst</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-2163"></a>                <span class='hs-varid'>logWarningsReportErrors</span> <span class='hs-layout'>(</span><span class='hs-varid'>getMessages</span> <span class='hs-varid'>pst</span><span class='hs-layout'>)</span>
<a name="line-2164"></a>                <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_parsed</span> <span class='hs-str'>"Parser"</span>
<a name="line-2165"></a>                            <span class='hs-conid'>FormatHaskell</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-2166"></a>                <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>dumpIfSet_dyn</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-conid'>Opt_D_dump_parsed_ast</span> <span class='hs-str'>"Parser AST"</span>
<a name="line-2167"></a>                            <span class='hs-conid'>FormatHaskell</span> <span class='hs-layout'>(</span><span class='hs-varid'>showAstData</span> <span class='hs-conid'>NoBlankSrcSpan</span> <span class='hs-conid'>NoBlankEpAnnotations</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-2168"></a>                <span class='hs-varid'>return</span> <span class='hs-varid'>thing</span>
<a name="line-2169"></a>
<a name="line-2170"></a>
<a name="line-2171"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-2172"></a>%*                                                                      *
<a name="line-2173"></a>        Desugar, simplify, convert to bytecode, and link an expression
<a name="line-2174"></a>%*                                                                      *
<a name="line-2175"></a>%********************************************************************* -}</span>
<a name="line-2176"></a>
<a name="line-2177"></a><a name="hscCompileCoreExpr"></a><span class='hs-definition'>hscCompileCoreExpr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ForeignHValue</span>
<a name="line-2178"></a><span class='hs-definition'>hscCompileCoreExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr</span> <span class='hs-keyglyph'>=</span>
<a name="line-2179"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>hscCompileCoreExprHook</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_hooks</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-2180"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>hscCompileCoreExpr'</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr</span>
<a name="line-2181"></a>      <span class='hs-conid'>Just</span> <span class='hs-varid'>h</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>h</span>                   <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>expr</span>
<a name="line-2182"></a>
<a name="line-2183"></a><a name="hscCompileCoreExpr'"></a><span class='hs-definition'>hscCompileCoreExpr'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SrcSpan</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CoreExpr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ForeignHValue</span>
<a name="line-2184"></a><span class='hs-definition'>hscCompileCoreExpr'</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>srcspan</span> <span class='hs-varid'>ds_expr</span>
<a name="line-2185"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>{- Simplify it -}</span>
<a name="line-2186"></a>           <span class='hs-comment'>-- Question: should we call SimpleOpt.simpleOptExpr here instead?</span>
<a name="line-2187"></a>           <span class='hs-comment'>-- It is, well, simpler, and does less inlining etc.</span>
<a name="line-2188"></a>           <span class='hs-varid'>simpl_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>simplifyExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>ds_expr</span>
<a name="line-2189"></a>
<a name="line-2190"></a>           <span class='hs-comment'>{- Tidy it (temporary, until coreSat does cloning) -}</span>
<a name="line-2191"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_expr</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyExpr</span> <span class='hs-varid'>emptyTidyEnv</span> <span class='hs-varid'>simpl_expr</span>
<a name="line-2192"></a>
<a name="line-2193"></a>           <span class='hs-comment'>{- Prepare for codegen -}</span>
<a name="line-2194"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>prepd_expr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>corePrepExpr</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>tidy_expr</span>
<a name="line-2195"></a>
<a name="line-2196"></a>           <span class='hs-comment'>{- Lint if necessary -}</span>
<a name="line-2197"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>lintInteractiveExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"hscCompileExpr"</span><span class='hs-layout'>)</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>prepd_expr</span>
<a name="line-2198"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>iNTERACTIVELoc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ModLocation</span><span class='hs-layout'>{</span> <span class='hs-varid'>ml_hs_file</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span>
<a name="line-2199"></a>                                      <span class='hs-varid'>ml_hi_file</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hscCompileCoreExpr':ml_hi_file"</span><span class='hs-layout'>,</span>
<a name="line-2200"></a>                                      <span class='hs-varid'>ml_obj_file</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hscCompileCoreExpr':ml_obj_file"</span><span class='hs-layout'>,</span>
<a name="line-2201"></a>                                      <span class='hs-varid'>ml_hie_file</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"hscCompileCoreExpr':ml_hie_file"</span> <span class='hs-layout'>}</span>
<a name="line-2202"></a>
<a name="line-2203"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ictxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_IC</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2204"></a>         <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>binding_id</span><span class='hs-layout'>,</span> <span class='hs-varid'>stg_expr</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-2205"></a>             <span class='hs-varid'>myCoreToStgExpr</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-2206"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-2207"></a>                             <span class='hs-varid'>ictxt</span>
<a name="line-2208"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>icInteractiveModule</span> <span class='hs-varid'>ictxt</span><span class='hs-layout'>)</span>
<a name="line-2209"></a>                             <span class='hs-varid'>iNTERACTIVELoc</span>
<a name="line-2210"></a>                             <span class='hs-varid'>prepd_expr</span>
<a name="line-2211"></a>
<a name="line-2212"></a>           <span class='hs-comment'>{- Convert to BCOs -}</span>
<a name="line-2213"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>bcos</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>byteCodeGen</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2214"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>icInteractiveModule</span> <span class='hs-varid'>ictxt</span><span class='hs-layout'>)</span>
<a name="line-2215"></a>                     <span class='hs-varid'>stg_expr</span>
<a name="line-2216"></a>                     <span class='hs-conid'>[]</span> <span class='hs-conid'>Nothing</span>
<a name="line-2217"></a>
<a name="line-2218"></a>           <span class='hs-comment'>{- load it -}</span>
<a name="line-2219"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>fv_hvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>loadDecls</span> <span class='hs-layout'>(</span><span class='hs-varid'>hscInterp</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>hsc_env</span> <span class='hs-varid'>srcspan</span> <span class='hs-varid'>bcos</span>
<a name="line-2220"></a>           <span class='hs-comment'>{- Get the HValue for the root -}</span>
<a name="line-2221"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectJust</span> <span class='hs-str'>"hscCompileCoreExpr'"</span>
<a name="line-2222"></a>              <span class='hs-varop'>$</span> <span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>idName</span> <span class='hs-varid'>binding_id</span><span class='hs-layout'>)</span> <span class='hs-varid'>fv_hvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2223"></a>
<a name="line-2224"></a>
<a name="line-2225"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-2226"></a>%*                                                                      *
<a name="line-2227"></a>        Statistics on reading interfaces
<a name="line-2228"></a>%*                                                                      *
<a name="line-2229"></a>%********************************************************************* -}</span>
<a name="line-2230"></a>
<a name="line-2231"></a><a name="dumpIfaceStats"></a><span class='hs-definition'>dumpIfaceStats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HscEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-2232"></a><span class='hs-definition'>dumpIfaceStats</span> <span class='hs-varid'>hsc_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2233"></a>    <span class='hs-varid'>eps</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsc_EPS</span> <span class='hs-varid'>hsc_env</span><span class='hs-layout'>)</span>
<a name="line-2234"></a>    <span class='hs-varid'>dumpIfSet</span> <span class='hs-varid'>logger</span> <span class='hs-varid'>dflags</span> <span class='hs-layout'>(</span><span class='hs-varid'>dump_if_trace</span> <span class='hs-varop'>||</span> <span class='hs-varid'>dump_rn_stats</span><span class='hs-layout'>)</span>
<a name="line-2235"></a>              <span class='hs-str'>"Interface statistics"</span>
<a name="line-2236"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>ifaceStats</span> <span class='hs-varid'>eps</span><span class='hs-layout'>)</span>
<a name="line-2237"></a>  <span class='hs-keyword'>where</span>
<a name="line-2238"></a>    <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_dflags</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2239"></a>    <span class='hs-varid'>logger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsc_logger</span> <span class='hs-varid'>hsc_env</span>
<a name="line-2240"></a>    <span class='hs-varid'>dump_rn_stats</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_rn_stats</span> <span class='hs-varid'>dflags</span>
<a name="line-2241"></a>    <span class='hs-varid'>dump_if_trace</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dopt</span> <span class='hs-conid'>Opt_D_dump_if_trace</span> <span class='hs-varid'>dflags</span>
<a name="line-2242"></a>
<a name="line-2243"></a>
<a name="line-2244"></a><span class='hs-comment'>{- **********************************************************************
<a name="line-2245"></a>%*                                                                      *
<a name="line-2246"></a>        Progress Messages: Module i of n
<a name="line-2247"></a>%*                                                                      *
<a name="line-2248"></a>%********************************************************************* -}</span>
<a name="line-2249"></a>
<a name="line-2250"></a><a name="showModuleIndex"></a><span class='hs-definition'>showModuleIndex</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2251"></a><span class='hs-definition'>showModuleIndex</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-layout'>,</span><span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"["</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>pad</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>" of "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"] "</span>
<a name="line-2252"></a>  <span class='hs-keyword'>where</span>
<a name="line-2253"></a>    <span class='hs-comment'>-- compute the length of x &gt; 0 in base 10</span>
<a name="line-2254"></a>    <span class='hs-varid'>len</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ceiling</span> <span class='hs-layout'>(</span><span class='hs-varid'>logBase</span> <span class='hs-num'>10</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>x</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Float</span><span class='hs-layout'>)</span>
<a name="line-2255"></a>    <span class='hs-varid'>pad</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-layout'>(</span><span class='hs-varid'>len</span> <span class='hs-varid'>n</span> <span class='hs-comment'>-</span> <span class='hs-varid'>len</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-chr'>' '</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- TODO: use GHC.Utils.Ppr.RStr</span>
</pre></body>
</html>

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>GHC/Tc/Gen/HsType.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE CPP                 #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE DataKinds           #-}</span>
<a name="line-3"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts    #-}</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE RankNTypes          #-}</span>
<a name="line-5"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE TypeFamilies        #-}</span>
<a name="line-7"></a><span class='hs-comment'>{-# LANGUAGE ViewPatterns        #-}</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-comment'>{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span>
<a name="line-10"></a>
<a name="line-11"></a><span class='hs-comment'>{-
<a name="line-12"></a>(c) The University of Glasgow 2006
<a name="line-13"></a>(c) The GRASP/AQUA Project, Glasgow University, 1992-1998
<a name="line-14"></a>
<a name="line-15"></a>-}</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-comment'>-- | Typechecking user-specified @MonoTypes@</span>
<a name="line-18"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>GHC.Tc.Gen.HsType</span> <span class='hs-layout'>(</span>
<a name="line-19"></a>        <span class='hs-comment'>-- Type signatures</span>
<a name="line-20"></a>        <span class='hs-varid'>kcClassSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcClassSigType</span><span class='hs-layout'>,</span>
<a name="line-21"></a>        <span class='hs-varid'>tcHsSigType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsSigWcType</span><span class='hs-layout'>,</span>
<a name="line-22"></a>        <span class='hs-varid'>tcHsPartialSigType</span><span class='hs-layout'>,</span>
<a name="line-23"></a>        <span class='hs-varid'>tcStandaloneKindSig</span><span class='hs-layout'>,</span>
<a name="line-24"></a>        <span class='hs-varid'>funsSigCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>addSigCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprSigCtxt</span><span class='hs-layout'>,</span>
<a name="line-25"></a>
<a name="line-26"></a>        <span class='hs-varid'>tcHsClsInstType</span><span class='hs-layout'>,</span>
<a name="line-27"></a>        <span class='hs-varid'>tcHsDeriv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcDerivStrategy</span><span class='hs-layout'>,</span>
<a name="line-28"></a>        <span class='hs-varid'>tcHsTypeApp</span><span class='hs-layout'>,</span>
<a name="line-29"></a>        <span class='hs-conid'>UserTypeCtxt</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-30"></a>        <span class='hs-varid'>bindImplicitTKBndrs_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Skol</span><span class='hs-layout'>,</span>
<a name="line-31"></a>            <span class='hs-varid'>bindImplicitTKBndrs_Q_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span>
<a name="line-32"></a>        <span class='hs-varid'>bindExplicitTKBndrs_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Skol</span><span class='hs-layout'>,</span>
<a name="line-33"></a>            <span class='hs-varid'>bindExplicitTKBndrs_Q_Tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span>
<a name="line-34"></a>
<a name="line-35"></a>        <span class='hs-varid'>bindOuterFamEqnTKBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindOuterFamEqnTKBndrs_Q_Tv</span><span class='hs-layout'>,</span>
<a name="line-36"></a>        <span class='hs-varid'>tcOuterTKBndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>scopedSortOuter</span><span class='hs-layout'>,</span>
<a name="line-37"></a>        <span class='hs-varid'>bindOuterSigTKBndrs_Tv</span><span class='hs-layout'>,</span>
<a name="line-38"></a>        <span class='hs-varid'>tcExplicitTKBndrs</span><span class='hs-layout'>,</span>
<a name="line-39"></a>        <span class='hs-varid'>bindNamedWildCardBinders</span><span class='hs-layout'>,</span>
<a name="line-40"></a>
<a name="line-41"></a>        <span class='hs-comment'>-- Type checking type and class decls, and instances thereof</span>
<a name="line-42"></a>        <span class='hs-varid'>bindTyClTyVars</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcFamTyPats</span><span class='hs-layout'>,</span>
<a name="line-43"></a>        <span class='hs-varid'>etaExpandAlgTyCon</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcbVisibilities</span><span class='hs-layout'>,</span>
<a name="line-44"></a>
<a name="line-45"></a>          <span class='hs-comment'>-- tyvars</span>
<a name="line-46"></a>        <span class='hs-varid'>zonkAndScopedSort</span><span class='hs-layout'>,</span>
<a name="line-47"></a>
<a name="line-48"></a>        <span class='hs-comment'>-- Kind-checking types</span>
<a name="line-49"></a>        <span class='hs-comment'>-- No kind generalisation, no checkValidType</span>
<a name="line-50"></a>        <span class='hs-conid'>InitialKindStrategy</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-51"></a>        <span class='hs-conid'>SAKS_or_CUSK</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-52"></a>        <span class='hs-conid'>ContextKind</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-53"></a>        <span class='hs-varid'>kcDeclHeader</span><span class='hs-layout'>,</span>
<a name="line-54"></a>        <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span>   <span class='hs-varid'>tcHsOpenType</span><span class='hs-layout'>,</span>
<a name="line-55"></a>        <span class='hs-varid'>tcHsLiftedTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsOpenTypeNC</span><span class='hs-layout'>,</span>
<a name="line-56"></a>        <span class='hs-varid'>tcInferLHsType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferLHsTypeKind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferLHsTypeUnsaturated</span><span class='hs-layout'>,</span>
<a name="line-57"></a>        <span class='hs-varid'>tcCheckLHsType</span><span class='hs-layout'>,</span>
<a name="line-58"></a>        <span class='hs-varid'>tcHsContext</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcLHsPredType</span><span class='hs-layout'>,</span>
<a name="line-59"></a>
<a name="line-60"></a>        <span class='hs-varid'>kindGeneralizeAll</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindGeneralizeSome</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindGeneralizeNone</span><span class='hs-layout'>,</span>
<a name="line-61"></a>
<a name="line-62"></a>        <span class='hs-comment'>-- Sort-checking kinds</span>
<a name="line-63"></a>        <span class='hs-varid'>tcLHsKindSig</span><span class='hs-layout'>,</span> <span class='hs-varid'>checkDataKindSig</span><span class='hs-layout'>,</span> <span class='hs-conid'>DataSort</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-64"></a>        <span class='hs-varid'>checkClassKindSig</span><span class='hs-layout'>,</span>
<a name="line-65"></a>
<a name="line-66"></a>        <span class='hs-comment'>-- Multiplicity</span>
<a name="line-67"></a>        <span class='hs-varid'>tcMult</span><span class='hs-layout'>,</span>
<a name="line-68"></a>
<a name="line-69"></a>        <span class='hs-comment'>-- Pattern type signatures</span>
<a name="line-70"></a>        <span class='hs-varid'>tcHsPatSigType</span><span class='hs-layout'>,</span>
<a name="line-71"></a>        <span class='hs-conid'>HoleMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-72"></a>
<a name="line-73"></a>        <span class='hs-comment'>-- Error messages</span>
<a name="line-74"></a>        <span class='hs-varid'>funAppCtxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>addTyConFlavCtxt</span>
<a name="line-75"></a>   <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-76"></a>
<a name="line-77"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-78"></a>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Prelude</span>
<a name="line-80"></a>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Hs</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Rename.Utils</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Monad</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Origin</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Predicate</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Types.Constraint</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Env</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcMType</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Validity</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Unify</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IfaceToCore</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Solver</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Zonk</span>
<a name="line-94"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Rep</span>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCo.Ppr</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.TcType</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Tc.Utils.Instantiate</span> <span class='hs-layout'>(</span> <span class='hs-varid'>tcInstInvisibleTyBinders</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInstInvisibleTyBindersN</span><span class='hs-layout'>,</span>
<a name="line-98"></a>                                  <span class='hs-varid'>tcInstInvisibleTyBinder</span> <span class='hs-layout'>)</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Type</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types.Prim</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Env</span>
<a name="line-102"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name.Reader</span><span class='hs-layout'>(</span> <span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-layout'>)</span>
<a name="line-103"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var</span>
<a name="line-104"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Set</span>
<a name="line-105"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.TyCon</span>
<a name="line-106"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.ConLike</span>
<a name="line-107"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.DataCon</span>
<a name="line-108"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Core.Class</span>
<a name="line-109"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Name</span>
<a name="line-110"></a><span class='hs-comment'>-- import GHC.Types.Name.Set</span>
<a name="line-111"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Var.Env</span>
<a name="line-112"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Types</span>
<a name="line-113"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Basic</span>
<a name="line-114"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.SrcLoc</span>
<a name="line-115"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique</span>
<a name="line-116"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.FM</span>
<a name="line-117"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Set</span>
<a name="line-118"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Misc</span>
<a name="line-119"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Types.Unique.Supply</span>
<a name="line-120"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Outputable</span>
<a name="line-121"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Utils.Panic</span>
<a name="line-122"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.FastString</span>
<a name="line-123"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Builtin.Names</span> <span class='hs-varid'>hiding</span> <span class='hs-layout'>(</span> <span class='hs-varid'>wildCardName</span> <span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Driver.Session</span>
<a name="line-125"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>GHC.LanguageExtensions</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>LangExt</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Maybe</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.Data.Bag</span><span class='hs-layout'>(</span> <span class='hs-varid'>unitBag</span> <span class='hs-layout'>)</span>
<a name="line-129"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.List</span> <span class='hs-layout'>(</span> <span class='hs-varid'>find</span> <span class='hs-layout'>)</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad</span>
<a name="line-131"></a>
<a name="line-132"></a><span class='hs-comment'>{-
<a name="line-133"></a>        ----------------------------
<a name="line-134"></a>                General notes
<a name="line-135"></a>        ----------------------------
<a name="line-136"></a>
<a name="line-137"></a>Unlike with expressions, type-checking types both does some checking and
<a name="line-138"></a>desugars at the same time. This is necessary because we often want to perform
<a name="line-139"></a>equality checks on the types right away, and it would be incredibly painful
<a name="line-140"></a>to do this on un-desugared types. Luckily, desugared types are close enough
<a name="line-141"></a>to HsTypes to make the error messages sane.
<a name="line-142"></a>
<a name="line-143"></a>During type-checking, we perform as little validity checking as possible.
<a name="line-144"></a>Generally, after type-checking, you will want to do validity checking, say
<a name="line-145"></a>with GHC.Tc.Validity.checkValidType.
<a name="line-146"></a>
<a name="line-147"></a>Validity checking
<a name="line-148"></a>~~~~~~~~~~~~~~~~~
<a name="line-149"></a>Some of the validity check could in principle be done by the kind checker,
<a name="line-150"></a>but not all:
<a name="line-151"></a>
<a name="line-152"></a>- During desugaring, we normalise by expanding type synonyms.  Only
<a name="line-153"></a>  after this step can we check things like type-synonym saturation
<a name="line-154"></a>  e.g.  type T k = k Int
<a name="line-155"></a>        type S a = a
<a name="line-156"></a>  Then (T S) is ok, because T is saturated; (T S) expands to (S Int);
<a name="line-157"></a>  and then S is saturated.  This is a GHC extension.
<a name="line-158"></a>
<a name="line-159"></a>- Similarly, also a GHC extension, we look through synonyms before complaining
<a name="line-160"></a>  about the form of a class or instance declaration
<a name="line-161"></a>
<a name="line-162"></a>- Ambiguity checks involve functional dependencies
<a name="line-163"></a>
<a name="line-164"></a>Also, in a mutually recursive group of types, we can't look at the TyCon until we've
<a name="line-165"></a>finished building the loop.  So to keep things simple, we postpone most validity
<a name="line-166"></a>checking until step (3).
<a name="line-167"></a>
<a name="line-168"></a>%************************************************************************
<a name="line-169"></a>%*                                                                      *
<a name="line-170"></a>              Check types AND do validity checking
<a name="line-171"></a>*                                                                      *
<a name="line-172"></a>************************************************************************
<a name="line-173"></a>
<a name="line-174"></a>Note [Keeping implicitly quantified variables in order]
<a name="line-175"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-176"></a>When the user implicitly quantifies over variables (say, in a type
<a name="line-177"></a>signature), we need to come up with some ordering on these variables.
<a name="line-178"></a>This is done by bumping the TcLevel, bringing the tyvars into scope,
<a name="line-179"></a>and then type-checking the thing_inside. The constraints are all
<a name="line-180"></a>wrapped in an implication, which is then solved. Finally, we can
<a name="line-181"></a>zonk all the binders and then order them with scopedSort.
<a name="line-182"></a>
<a name="line-183"></a>It's critical to solve before zonking and ordering in order to uncover
<a name="line-184"></a>any unifications. You might worry that this eager solving could cause
<a name="line-185"></a>trouble elsewhere. I don't think it will. Because it will solve only
<a name="line-186"></a>in an increased TcLevel, it can't unify anything that was mentioned
<a name="line-187"></a>elsewhere. Additionally, we require that the order of implicitly
<a name="line-188"></a>quantified variables is manifest by the scope of these variables, so
<a name="line-189"></a>we're not going to learn more information later that will help order
<a name="line-190"></a>these variables.
<a name="line-191"></a>
<a name="line-192"></a>Note [Recipe for checking a signature]
<a name="line-193"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-194"></a>Kind-checking a user-written signature requires several steps:
<a name="line-195"></a>
<a name="line-196"></a> 0. Bump the TcLevel
<a name="line-197"></a> 1.   Bind any lexically-scoped type variables.
<a name="line-198"></a> 2.   Generate constraints.
<a name="line-199"></a> 3. Solve constraints.
<a name="line-200"></a> 4. Sort any implicitly-bound variables into dependency order
<a name="line-201"></a> 5. Promote tyvars and/or kind-generalize.
<a name="line-202"></a> 6. Zonk.
<a name="line-203"></a> 7. Check validity.
<a name="line-204"></a>
<a name="line-205"></a>Very similar steps also apply when kind-checking a type or class
<a name="line-206"></a>declaration.
<a name="line-207"></a>
<a name="line-208"></a>The general pattern looks something like this.  (But NB every
<a name="line-209"></a>specific instance varies in one way or another!)
<a name="line-210"></a>
<a name="line-211"></a>    do { (tclvl, wanted, (spec_tkvs, ty))
<a name="line-212"></a>              &lt;- pushLevelAndSolveEqualitiesX "tc_top_lhs_type" $
<a name="line-213"></a>                 bindImplicitTKBndrs_Skol sig_vars              $
<a name="line-214"></a>                 &lt;kind-check the type&gt;
<a name="line-215"></a>
<a name="line-216"></a>       ; spec_tkvs &lt;- zonkAndScopedSort spec_tkvs
<a name="line-217"></a>
<a name="line-218"></a>       ; reportUnsolvedEqualities skol_info spec_tkvs tclvl wanted
<a name="line-219"></a>
<a name="line-220"></a>       ; let ty1 = mkSpecForAllTys spec_tkvs ty
<a name="line-221"></a>       ; kvs &lt;- kindGeneralizeAll ty1
<a name="line-222"></a>
<a name="line-223"></a>       ; final_ty &lt;- zonkTcTypeToType (mkInfForAllTys kvs ty1)
<a name="line-224"></a>
<a name="line-225"></a>       ; checkValidType final_ty
<a name="line-226"></a>
<a name="line-227"></a>This pattern is repeated many times in GHC.Tc.Gen.HsType,
<a name="line-228"></a>GHC.Tc.Gen.Sig, and GHC.Tc.TyCl, with variations.  In more detail:
<a name="line-229"></a>
<a name="line-230"></a>* pushLevelAndSolveEqualitiesX (Step 0, step 3) bumps the TcLevel,
<a name="line-231"></a>  calls the thing inside to generate constraints, solves those
<a name="line-232"></a>  constraints as much as possible, returning the residual unsolved
<a name="line-233"></a>  constraints in 'wanted'.
<a name="line-234"></a>
<a name="line-235"></a>* bindImplicitTKBndrs_Skol (Step 1) binds the user-specified type
<a name="line-236"></a>  variables E.g.  when kind-checking f :: forall a. F a -&gt; a we must
<a name="line-237"></a>  bring 'a' into scope before kind-checking (F a -&gt; a)
<a name="line-238"></a>
<a name="line-239"></a>* zonkAndScopedSort (Step 4) puts those user-specified variables in
<a name="line-240"></a>  the dependency order.  (For "implicit" variables the order is no
<a name="line-241"></a>  user-specified.  E.g.  forall (a::k1) (b::k2). blah k1 and k2 are
<a name="line-242"></a>  implicitly brought into scope.
<a name="line-243"></a>
<a name="line-244"></a>* reportUnsolvedEqualities (Step 3 continued) reports any unsolved
<a name="line-245"></a>  equalities, carefully wrapping them in an implication that binds the
<a name="line-246"></a>  skolems.  We can't do that in pushLevelAndSolveEqualitiesX because
<a name="line-247"></a>  that function doesn't have access to the skolems.
<a name="line-248"></a>
<a name="line-249"></a>* kindGeneralize (Step 5). See Note [Kind generalisation]
<a name="line-250"></a>
<a name="line-251"></a>* The final zonkTcTypeToType must happen after promoting/generalizing,
<a name="line-252"></a>  because promoting and generalizing fill in metavariables.
<a name="line-253"></a>
<a name="line-254"></a>
<a name="line-255"></a>Doing Step 3 (constraint solving) eagerly (rather than building an
<a name="line-256"></a>implication constraint and solving later) is necessary for several
<a name="line-257"></a>reasons:
<a name="line-258"></a>
<a name="line-259"></a>* Exactly as for Solver.simplifyInfer: when generalising, we solve all
<a name="line-260"></a>  the constraints we can so that we don't have to quantify over them
<a name="line-261"></a>  or, since we don't quantify over constraints in kinds, float them
<a name="line-262"></a>  and inhibit generalisation.
<a name="line-263"></a>
<a name="line-264"></a>* Most signatures also bring implicitly quantified variables into
<a name="line-265"></a>  scope, and solving is necessary to get these in the right order
<a name="line-266"></a>  (Step 4) see Note [Keeping implicitly quantified variables in
<a name="line-267"></a>  order]).
<a name="line-268"></a>
<a name="line-269"></a>Note [Kind generalisation]
<a name="line-270"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-271"></a>Step 5 of Note [Recipe for checking a signature], namely
<a name="line-272"></a>kind-generalisation, is done by
<a name="line-273"></a>    kindGeneraliseAll
<a name="line-274"></a>    kindGeneraliseSome
<a name="line-275"></a>    kindGeneraliseNone
<a name="line-276"></a>
<a name="line-277"></a>Here, we have to deal with the fact that metatyvars generated in the
<a name="line-278"></a>type will have a bumped TcLevel, because explicit foralls raise the
<a name="line-279"></a>TcLevel. To avoid these variables from ever being visible in the
<a name="line-280"></a>surrounding context, we must obey the following dictum:
<a name="line-281"></a>
<a name="line-282"></a>  Every metavariable in a type must either be
<a name="line-283"></a>    (A) generalized, or
<a name="line-284"></a>    (B) promoted, or        See Note [Promotion in signatures]
<a name="line-285"></a>    (C) a cause to error    See Note [Naughty quantification candidates]
<a name="line-286"></a>                            in GHC.Tc.Utils.TcMType
<a name="line-287"></a>
<a name="line-288"></a>There are three steps (look at kindGeneraliseSome):
<a name="line-289"></a>
<a name="line-290"></a>1. candidateQTyVarsOfType finds the free variables of the type or kind,
<a name="line-291"></a>   to generalise
<a name="line-292"></a>
<a name="line-293"></a>2. filterConstrainedCandidates filters out candidates that appear
<a name="line-294"></a>   in the unsolved 'wanteds', and promotes the ones that get filtered out
<a name="line-295"></a>   thereby.
<a name="line-296"></a>
<a name="line-297"></a>3. quantifyTyVars quantifies the remaining type variables
<a name="line-298"></a>
<a name="line-299"></a>The kindGeneralize functions do not require pre-zonking; they zonk as they
<a name="line-300"></a>go.
<a name="line-301"></a>
<a name="line-302"></a>kindGeneraliseAll specialises for the case where step (2) is vacuous.
<a name="line-303"></a>kindGeneraliseNone specialises for the case where we do no quantification,
<a name="line-304"></a>but we must still promote.
<a name="line-305"></a>
<a name="line-306"></a>If you are actually doing kind-generalization, you need to bump the
<a name="line-307"></a>level before generating constraints, as we will only generalize
<a name="line-308"></a>variables with a TcLevel higher than the ambient one.
<a name="line-309"></a>Hence the "pushLevel" in pushLevelAndSolveEqualities.
<a name="line-310"></a>
<a name="line-311"></a>Note [Promotion in signatures]
<a name="line-312"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-313"></a>If an unsolved metavariable in a signature is not generalized
<a name="line-314"></a>(because we're not generalizing the construct -- e.g., pattern
<a name="line-315"></a>sig -- or because the metavars are constrained -- see kindGeneralizeSome)
<a name="line-316"></a>we need to promote to maintain (WantedTvInv) of Note [TcLevel invariants]
<a name="line-317"></a>in GHC.Tc.Utils.TcType. Note that promotion is identical in effect to generalizing
<a name="line-318"></a>and the reinstantiating with a fresh metavariable at the current level.
<a name="line-319"></a>So in some sense, we generalize *all* variables, but then re-instantiate
<a name="line-320"></a>some of them.
<a name="line-321"></a>
<a name="line-322"></a>Here is an example of why we must promote:
<a name="line-323"></a>  foo (x :: forall a. a -&gt; Proxy b) = ...
<a name="line-324"></a>
<a name="line-325"></a>In the pattern signature, `b` is unbound, and will thus be brought into
<a name="line-326"></a>scope. We do not know its kind: it will be assigned kappa[2]. Note that
<a name="line-327"></a>kappa is at TcLevel 2, because it is invented under a forall. (A priori,
<a name="line-328"></a>the kind kappa might depend on `a`, so kappa rightly has a higher TcLevel
<a name="line-329"></a>than the surrounding context.) This kappa cannot be solved for while checking
<a name="line-330"></a>the pattern signature (which is not kind-generalized). When we are checking
<a name="line-331"></a>the *body* of foo, though, we need to unify the type of x with the argument
<a name="line-332"></a>type of bar. At this point, the ambient TcLevel is 1, and spotting a
<a name="line-333"></a>matavariable with level 2 would violate the (WantedTvInv) invariant of
<a name="line-334"></a>Note [TcLevel invariants]. So, instead of kind-generalizing,
<a name="line-335"></a>we promote the metavariable to level 1. This is all done in kindGeneralizeNone.
<a name="line-336"></a>
<a name="line-337"></a>-}</span>
<a name="line-338"></a>
<a name="line-339"></a><a name="funsSigCtxt"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-340"></a><span class='hs-comment'>-- Returns FunSigCtxt, with no redundant-context-reporting,</span>
<a name="line-341"></a><span class='hs-comment'>-- form a list of located names</span>
<a name="line-342"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name1</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>FunSigCtxt</span> <span class='hs-varid'>name1</span> <span class='hs-conid'>False</span>
<a name="line-343"></a><span class='hs-definition'>funsSigCtxt</span> <span class='hs-conid'>[]</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"funSigCtxt"</span>
<a name="line-344"></a>
<a name="line-345"></a><a name="addSigCtxt"></a><span class='hs-definition'>addSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocatedA</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-346"></a><span class='hs-definition'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>thing_inside</span>
<a name="line-347"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-348"></a>    <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-349"></a>    <span class='hs-varid'>thing_inside</span>
<a name="line-350"></a>
<a name="line-351"></a><a name="pprSigCtxt"></a><span class='hs-definition'>pprSigCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LocatedA</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-352"></a><span class='hs-comment'>-- (pprSigCtxt ctxt &lt;extra&gt; &lt;type&gt;)</span>
<a name="line-353"></a><span class='hs-comment'>-- prints    In the type signature for 'f':</span>
<a name="line-354"></a><span class='hs-comment'>--              f :: &lt;type&gt;</span>
<a name="line-355"></a><span class='hs-comment'>-- The &lt;extra&gt; is either empty or "the ambiguity check for"</span>
<a name="line-356"></a><span class='hs-definition'>pprSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-357"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isSigMaybe</span> <span class='hs-varid'>ctxt</span>
<a name="line-358"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the type signature:"</span><span class='hs-layout'>)</span>
<a name="line-359"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPrefixOcc</span> <span class='hs-varid'>n</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-360"></a>
<a name="line-361"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-362"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprUserTypeCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>colon</span><span class='hs-layout'>)</span>
<a name="line-363"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-364"></a>
<a name="line-365"></a><a name="tcHsSigWcType"></a><span class='hs-definition'>tcHsSigWcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-366"></a><span class='hs-comment'>-- This one is used when we have a LHsSigWcType, but in</span>
<a name="line-367"></a><span class='hs-comment'>-- a place where wildcards aren't allowed. The renamer has</span>
<a name="line-368"></a><span class='hs-comment'>-- already checked this, so we can simply ignore it.</span>
<a name="line-369"></a><span class='hs-definition'>tcHsSigWcType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>dropWildCards</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-370"></a>
<a name="line-371"></a><a name="kcClassSigType"></a><span class='hs-definition'>kcClassSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-372"></a><span class='hs-comment'>-- This is a special form of tcClassSigType that is used during the</span>
<a name="line-373"></a><span class='hs-comment'>-- kind-checking phase to infer the kind of class variables. Cf. tc_lhs_sig_type.</span>
<a name="line-374"></a><span class='hs-comment'>-- Importantly, this does *not* kind-generalize. Consider</span>
<a name="line-375"></a><span class='hs-comment'>--   class SC f where</span>
<a name="line-376"></a><span class='hs-comment'>--     meth :: forall a (x :: f a). Proxy x -&gt; ()</span>
<a name="line-377"></a><span class='hs-comment'>-- When instantiating Proxy with kappa, we must unify kappa := f a. But we're</span>
<a name="line-378"></a><span class='hs-comment'>-- still working out the kind of f, and thus f a will have a coercion in it.</span>
<a name="line-379"></a><span class='hs-comment'>-- Coercions block unification (Note [Equalities with incompatible kinds] in</span>
<a name="line-380"></a><span class='hs-comment'>-- TcCanonical) and so we fail to unify. If we try to kind-generalize, we'll</span>
<a name="line-381"></a><span class='hs-comment'>-- end up promoting kappa to the top level (because kind-generalization is</span>
<a name="line-382"></a><span class='hs-comment'>-- normally done right before adding a binding to the context), and then we</span>
<a name="line-383"></a><span class='hs-comment'>-- can't set kappa := f a, because a is local.</span>
<a name="line-384"></a><span class='hs-definition'>kcClassSigType</span> <span class='hs-varid'>names</span>
<a name="line-385"></a>    <span class='hs-varid'>sig_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-386"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funsSigCtxt</span> <span class='hs-varid'>names</span><span class='hs-layout'>)</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varop'>$</span>
<a name="line-387"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindOuterSigTKBndrs_Tv</span> <span class='hs-varid'>hs_outer_bndrs</span>    <span class='hs-varop'>$</span>
<a name="line-388"></a>              <span class='hs-varid'>tcLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-389"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-390"></a>
<a name="line-391"></a><a name="tcClassSigType"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LocatedN</span> <span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-392"></a><span class='hs-comment'>-- Does not do validity checking</span>
<a name="line-393"></a><span class='hs-definition'>tcClassSigType</span> <span class='hs-varid'>names</span> <span class='hs-varid'>sig_ty</span>
<a name="line-394"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>sig_ctxt</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varop'>$</span>
<a name="line-395"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_sig_type</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>sig_ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span>
<a name="line-396"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitImplication</span> <span class='hs-varid'>implic</span>
<a name="line-397"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-398"></a>       <span class='hs-comment'>-- Do not zonk-to-Type, nor perform a validity check</span>
<a name="line-399"></a>       <span class='hs-comment'>-- We are in a knot with the class and associated types</span>
<a name="line-400"></a>       <span class='hs-comment'>-- Zonking and validity checking is done by tcClassDecl</span>
<a name="line-401"></a>       <span class='hs-comment'>--</span>
<a name="line-402"></a>       <span class='hs-comment'>-- No need to fail here if the type has an error:</span>
<a name="line-403"></a>       <span class='hs-comment'>--   If we're in the kind-checking phase, the solveEqualities</span>
<a name="line-404"></a>       <span class='hs-comment'>--     in kcTyClGroup catches the error</span>
<a name="line-405"></a>       <span class='hs-comment'>--   If we're in the type-checking phase, the solveEqualities</span>
<a name="line-406"></a>       <span class='hs-comment'>--     in tcClassDecl1 gets it</span>
<a name="line-407"></a>       <span class='hs-comment'>-- Failing fast here degrades the error message in, e.g., tcfail135:</span>
<a name="line-408"></a>       <span class='hs-comment'>--   class Foo f where</span>
<a name="line-409"></a>       <span class='hs-comment'>--     baa :: f a -&gt; f</span>
<a name="line-410"></a>       <span class='hs-comment'>-- If we fail fast, we're told that f has kind `k1` when we wanted `*`.</span>
<a name="line-411"></a>       <span class='hs-comment'>-- It should be that f has kind `k2 -&gt; *`, but we never get a chance</span>
<a name="line-412"></a>       <span class='hs-comment'>-- to run the solver where the kind of f is touchable. This is</span>
<a name="line-413"></a>       <span class='hs-comment'>-- painfully delicate.</span>
<a name="line-414"></a>  <span class='hs-keyword'>where</span>
<a name="line-415"></a>    <span class='hs-varid'>sig_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>funsSigCtxt</span> <span class='hs-varid'>names</span>
<a name="line-416"></a>    <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTypeSkol</span> <span class='hs-varid'>sig_ctxt</span>
<a name="line-417"></a>
<a name="line-418"></a><a name="tcHsSigType"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-419"></a><span class='hs-comment'>-- Does validity checking</span>
<a name="line-420"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature]</span>
<a name="line-421"></a><span class='hs-definition'>tcHsSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-422"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varop'>$</span>
<a name="line-423"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsSigType {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-424"></a>
<a name="line-425"></a>          <span class='hs-comment'>-- Generalise here: see Note [Kind generalisation]</span>
<a name="line-426"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_sig_type</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>sig_ty</span>  <span class='hs-layout'>(</span><span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-427"></a>
<a name="line-428"></a>       <span class='hs-comment'>-- Float out constraints, failing fast if not possible</span>
<a name="line-429"></a>       <span class='hs-comment'>-- See Note [Failure in local type signatures] in GHC.Tc.Solver</span>
<a name="line-430"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsSigType 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-431"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>simplifyAndEmitFlatConstraints</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkImplicWC</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitBag</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-432"></a>
<a name="line-433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-434"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty</span>
<a name="line-435"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"end tcHsSigType }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-436"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-437"></a>  <span class='hs-keyword'>where</span>
<a name="line-438"></a>    <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTypeSkol</span> <span class='hs-varid'>ctxt</span>
<a name="line-439"></a>
<a name="line-440"></a><a name="tc_lhs_sig_type"></a><span class='hs-definition'>tc_lhs_sig_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-441"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Implication</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-442"></a><span class='hs-comment'>-- Kind-checks/desugars an 'LHsSigType',</span>
<a name="line-443"></a><span class='hs-comment'>--   solve equalities,</span>
<a name="line-444"></a><span class='hs-comment'>--   and then kind-generalizes.</span>
<a name="line-445"></a><span class='hs-comment'>-- This will never emit constraints, as it uses solveEqualities internally.</span>
<a name="line-446"></a><span class='hs-comment'>-- No validity checking or zonking</span>
<a name="line-447"></a><span class='hs-comment'>-- Returns also an implication for the unsolved constraints</span>
<a name="line-448"></a><span class='hs-definition'>tc_lhs_sig_type</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_outer_bndrs</span>
<a name="line-449"></a>                                       <span class='hs-layout'>,</span> <span class='hs-varid'>sig_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-450"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-451"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-452"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndSolveEqualitiesX</span> <span class='hs-str'>"tc_lhs_sig_type"</span> <span class='hs-varop'>$</span>
<a name="line-453"></a>                 <span class='hs-comment'>-- See Note [Failure in local type signatures]</span>
<a name="line-454"></a>                 <span class='hs-varid'>tcOuterTKBndrs</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>hs_outer_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-455"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-456"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>tcLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-457"></a>       <span class='hs-comment'>-- Any remaining variables (unsolved in the solveEqualities)</span>
<a name="line-458"></a>       <span class='hs-comment'>-- should be in the global tyvars, and therefore won't be quantified</span>
<a name="line-459"></a>
<a name="line-460"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_lhs_sig_type"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_outer_bndrs</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>)</span>
<a name="line-461"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>outer_tv_bndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>scopedSortOuter</span> <span class='hs-varid'>outer_bndrs</span>
<a name="line-462"></a>
<a name="line-463"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>outer_tv_bndrs</span> <span class='hs-varid'>ty</span>
<a name="line-464"></a>
<a name="line-465"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeSome</span> <span class='hs-varid'>wanted</span> <span class='hs-varid'>ty1</span>
<a name="line-466"></a>
<a name="line-467"></a>       <span class='hs-comment'>-- Build an implication for any as-yet-unsolved kind equalities</span>
<a name="line-468"></a>       <span class='hs-comment'>-- See Note [Skolem escape in type signatures]</span>
<a name="line-469"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>buildTvImplication</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>tc_lvl</span> <span class='hs-varid'>wanted</span>
<a name="line-470"></a>
<a name="line-471"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkInfForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-472"></a>
<a name="line-473"></a><span class='hs-comment'>{- Note [Skolem escape in type signatures]
<a name="line-474"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-475"></a>tcHsSigType is tricky.  Consider (T11142)
<a name="line-476"></a>  foo :: forall b. (forall k (a :: k). SameKind a b) -&gt; ()
<a name="line-477"></a>This is ill-kinded because of a nested skolem-escape.
<a name="line-478"></a>
<a name="line-479"></a>That will show up as an un-solvable constraint in the implication
<a name="line-480"></a>returned by buildTvImplication in tc_lhs_sig_type.  See Note [Skolem
<a name="line-481"></a>escape prevention] in GHC.Tc.Utils.TcType for why it is unsolvable
<a name="line-482"></a>(the unification variable for b's kind is untouchable).
<a name="line-483"></a>
<a name="line-484"></a>Then, in GHC.Tc.Solver.simplifyAndEmitFlatConstraints (called from tcHsSigType)
<a name="line-485"></a>we'll try to float out the constraint, be unable to do so, and fail.
<a name="line-486"></a>See GHC.Tc.Solver Note [Failure in local type signatures] for more
<a name="line-487"></a>detail on this.
<a name="line-488"></a>
<a name="line-489"></a>The separation between tcHsSigType and tc_lhs_sig_type is because
<a name="line-490"></a>tcClassSigType wants to use the latter, but *not* fail fast, because
<a name="line-491"></a>there are skolems from the class decl which are in scope; but it's fine
<a name="line-492"></a>not to because tcClassDecl1 has a solveEqualities wrapped around all
<a name="line-493"></a>the tcClassSigType calls.
<a name="line-494"></a>
<a name="line-495"></a>That's why tcHsSigType does simplifyAndEmitFlatConstraints (which
<a name="line-496"></a>fails fast) but tcClassSigType just does emitImplication (which does
<a name="line-497"></a>not).  Ugh.
<a name="line-498"></a>
<a name="line-499"></a>c.f. see also Note [Skolem escape and forall-types]. The difference
<a name="line-500"></a>is that we don't need to simplify at a forall type, only at the
<a name="line-501"></a>top level of a signature.
<a name="line-502"></a>-}</span>
<a name="line-503"></a>
<a name="line-504"></a><a name="tcStandaloneKindSig"></a><span class='hs-comment'>-- Does validity checking and zonking.</span>
<a name="line-505"></a><span class='hs-definition'>tcStandaloneKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LStandaloneKindSig</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-506"></a><span class='hs-definition'>tcStandaloneKindSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>StandaloneKindSig</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>ksig</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-507"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ksig</span> <span class='hs-varop'>$</span>
<a name="line-508"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_top_lhs_type</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ksig</span>
<a name="line-509"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>kind</span>
<a name="line-510"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-511"></a>  <span class='hs-keyword'>where</span>
<a name="line-512"></a>   <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StandaloneKindSigCtxt</span> <span class='hs-varid'>name</span>
<a name="line-513"></a>
<a name="line-514"></a><a name="tcTopLHsType"></a><span class='hs-definition'>tcTopLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-515"></a><span class='hs-definition'>tcTopLHsType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lsig_ty</span>
<a name="line-516"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_top_lhs_type</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>lsig_ty</span>
<a name="line-517"></a>
<a name="line-518"></a><a name="tc_top_lhs_type"></a><span class='hs-definition'>tc_top_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-519"></a><span class='hs-comment'>-- tc_top_lhs_type is used for kind-checking top-level LHsSigTypes where</span>
<a name="line-520"></a><span class='hs-comment'>--   we want to fully solve /all/ equalities, and report errors</span>
<a name="line-521"></a><span class='hs-comment'>-- Does zonking, but not validity checking because it's used</span>
<a name="line-522"></a><span class='hs-comment'>--   for things (like deriving and instances) that aren't</span>
<a name="line-523"></a><span class='hs-comment'>--   ordinary types</span>
<a name="line-524"></a><span class='hs-comment'>-- Used for both types and kinds</span>
<a name="line-525"></a><span class='hs-definition'>tc_top_lhs_type</span> <span class='hs-varid'>tyki</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>sig_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSig</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_outer_bndrs</span>
<a name="line-526"></a>                                               <span class='hs-layout'>,</span> <span class='hs-varid'>sig_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-527"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-528"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_top_lhs_type {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-529"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-530"></a>              <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndSolveEqualitiesX</span> <span class='hs-str'>"tc_top_lhs_type"</span>    <span class='hs-varop'>$</span>
<a name="line-531"></a>                 <span class='hs-varid'>tcOuterTKBndrs</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>hs_outer_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-532"></a>                 <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>expectedKindInCtxt</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-533"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkMode</span> <span class='hs-varid'>tyki</span><span class='hs-layout'>)</span> <span class='hs-varid'>body</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-534"></a>
<a name="line-535"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>outer_tv_bndrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>scopedSortOuter</span> <span class='hs-varid'>outer_bndrs</span>
<a name="line-536"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>outer_tv_bndrs</span> <span class='hs-varid'>ty</span>
<a name="line-537"></a>
<a name="line-538"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kindGeneralizeAll</span> <span class='hs-varid'>ty1</span>  <span class='hs-comment'>-- "All" because it's a top-level type</span>
<a name="line-539"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportUnsolvedEqualities</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-540"></a>
<a name="line-541"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ze</span>       <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkEmptyZonkEnv</span> <span class='hs-conid'>NoFlexi</span>
<a name="line-542"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>final_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypeToTypeX</span> <span class='hs-varid'>ze</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInfForAllTys</span> <span class='hs-varid'>kvs</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-543"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_top_lhs_type }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_ty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-544"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>final_ty</span> <span class='hs-layout'>}</span>
<a name="line-545"></a>  <span class='hs-keyword'>where</span>
<a name="line-546"></a>    <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SigTypeSkol</span> <span class='hs-varid'>ctxt</span>
<a name="line-547"></a>
<a name="line-548"></a><a name="tcHsDeriv"></a><span class='hs-comment'>-----------------</span>
<a name="line-549"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Class</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Kind</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-550"></a><span class='hs-comment'>-- Like tcHsSigType, but for the ...deriving( C t1 ty2 ) clause</span>
<a name="line-551"></a><span class='hs-comment'>-- Returns the C, [ty1, ty2, and the kinds of C's remaining arguments</span>
<a name="line-552"></a><span class='hs-comment'>-- E.g.    class C (a::*) (b::k-&gt;k)</span>
<a name="line-553"></a><span class='hs-comment'>--         data T a b = ... deriving( C Int )</span>
<a name="line-554"></a><span class='hs-comment'>--    returns ([k], C, [k, Int], [k-&gt;k])</span>
<a name="line-555"></a><span class='hs-comment'>-- Return values are fully zonked</span>
<a name="line-556"></a><span class='hs-definition'>tcHsDeriv</span> <span class='hs-varid'>hs_ty</span>
<a name="line-557"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Avoid redundant error report</span>
<a name="line-558"></a>                              <span class='hs-comment'>-- with "illegal deriving", below</span>
<a name="line-559"></a>               <span class='hs-varid'>tcTopLHsType</span> <span class='hs-conid'>DerivClauseCtxt</span> <span class='hs-varid'>hs_ty</span>
<a name="line-560"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTyCoVars</span> <span class='hs-varid'>ty</span>
<a name="line-561"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>kind_args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitFunTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-562"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-563"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>cls</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>map</span> <span class='hs-varid'>scaledThing</span> <span class='hs-varid'>kind_args</span><span class='hs-layout'>)</span>
<a name="line-564"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Illegal deriving item"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-565"></a>
<a name="line-566"></a><a name="tcDerivStrategy"></a><span class='hs-comment'>-- | Typecheck a deriving strategy. For most deriving strategies, this is a</span>
<a name="line-567"></a><span class='hs-comment'>-- no-op, but for the @via@ strategy, this requires typechecking the @via@ type.</span>
<a name="line-568"></a><span class='hs-definition'>tcDerivStrategy</span> <span class='hs-keyglyph'>::</span>
<a name="line-569"></a>     <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LDerivStrategy</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span>
<a name="line-570"></a>     <span class='hs-comment'>-- ^ The deriving strategy</span>
<a name="line-571"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LDerivStrategy</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-572"></a>     <span class='hs-comment'>-- ^ The typechecked deriving strategy and the tyvars that it binds</span>
<a name="line-573"></a>     <span class='hs-comment'>-- (if using 'ViaStrategy').</span>
<a name="line-574"></a><span class='hs-definition'>tcDerivStrategy</span> <span class='hs-varid'>mb_lds</span>
<a name="line-575"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mb_lds</span> <span class='hs-keyword'>of</span>
<a name="line-576"></a>      <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>boring_case</span> <span class='hs-conid'>Nothing</span>
<a name="line-577"></a>      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-578"></a>        <span class='hs-varid'>setSrcSpan</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-579"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>ds'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-varid'>ds</span>
<a name="line-580"></a>          <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>ds'</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>)</span>
<a name="line-581"></a>  <span class='hs-keyword'>where</span>
<a name="line-582"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DerivStrategy</span> <span class='hs-conid'>GhcRn</span>
<a name="line-583"></a>                      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DerivStrategy</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-584"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>StockStrategy</span>    <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-585"></a>                                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_case</span> <span class='hs-layout'>(</span><span class='hs-conid'>StockStrategy</span> <span class='hs-varid'>noExtField</span><span class='hs-layout'>)</span>
<a name="line-586"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnyclassStrategy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-587"></a>                                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_case</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnyclassStrategy</span> <span class='hs-varid'>noExtField</span><span class='hs-layout'>)</span>
<a name="line-588"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewtypeStrategy</span>  <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>
<a name="line-589"></a>                                     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>boring_case</span> <span class='hs-layout'>(</span><span class='hs-conid'>NewtypeStrategy</span> <span class='hs-varid'>noExtField</span><span class='hs-layout'>)</span>
<a name="line-590"></a>    <span class='hs-varid'>tc_deriv_strategy</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViaStrategy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-591"></a>      <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcTopLHsType</span> <span class='hs-conid'>DerivClauseCtxt</span> <span class='hs-varid'>ty</span>
<a name="line-592"></a>      <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>via_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>via_pred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitForAllTyCoVars</span> <span class='hs-varid'>ty'</span>
<a name="line-593"></a>      <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-conid'>ViaStrategy</span> <span class='hs-varid'>via_pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>via_tvs</span><span class='hs-layout'>)</span>
<a name="line-594"></a>
<a name="line-595"></a>    <span class='hs-varid'>boring_case</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-596"></a>    <span class='hs-varid'>boring_case</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pure</span> <span class='hs-layout'>(</span><span class='hs-varid'>ds</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-597"></a>
<a name="line-598"></a><a name="tcHsClsInstType"></a><span class='hs-definition'>tcHsClsInstType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>    <span class='hs-comment'>-- InstDeclCtxt or SpecInstCtxt</span>
<a name="line-599"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-600"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-601"></a><span class='hs-comment'>-- Like tcHsSigType, but for a class instance declaration</span>
<a name="line-602"></a><span class='hs-definition'>tcHsClsInstType</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>hs_inst_ty</span>
<a name="line-603"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpan</span> <span class='hs-layout'>(</span><span class='hs-varid'>getLocA</span> <span class='hs-varid'>hs_inst_ty</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-604"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Fail eagerly if tcTopLHsType fails.  We are at top level so</span>
<a name="line-605"></a>         <span class='hs-comment'>-- these constraints will never be solved later. And failing</span>
<a name="line-606"></a>         <span class='hs-comment'>-- eagerly avoids follow-on errors when checkValidInstance</span>
<a name="line-607"></a>         <span class='hs-comment'>-- sees an unsolved coercion hole</span>
<a name="line-608"></a>         <span class='hs-varid'>inst_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>checkNoErrs</span> <span class='hs-varop'>$</span>
<a name="line-609"></a>                    <span class='hs-varid'>tcTopLHsType</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>hs_inst_ty</span>
<a name="line-610"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidInstance</span> <span class='hs-varid'>user_ctxt</span> <span class='hs-varid'>hs_inst_ty</span> <span class='hs-varid'>inst_ty</span>
<a name="line-611"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>inst_ty</span> <span class='hs-layout'>}</span>
<a name="line-612"></a>
<a name="line-613"></a><a name="tcHsTypeApp"></a><span class='hs-comment'>----------------------------------------------</span>
<a name="line-614"></a><span class='hs-comment'>-- | Type-check a visible type application</span>
<a name="line-615"></a><span class='hs-definition'>tcHsTypeApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsWcType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Type</span>
<a name="line-616"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature] in GHC.Tc.Gen.HsType</span>
<a name="line-617"></a><span class='hs-definition'>tcHsTypeApp</span> <span class='hs-varid'>wc_ty</span> <span class='hs-varid'>kind</span>
<a name="line-618"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>wc_ty</span>
<a name="line-619"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHoleMode</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-conid'>HM_VTA</span>
<a name="line-620"></a>                 <span class='hs-comment'>-- HM_VTA: See Note [Wildcards in visible type application]</span>
<a name="line-621"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span>                  <span class='hs-varop'>$</span>
<a name="line-622"></a>               <span class='hs-varid'>solveEqualities</span> <span class='hs-str'>"tcHsTypeApp"</span> <span class='hs-varop'>$</span>
<a name="line-623"></a>               <span class='hs-comment'>-- We are looking at a user-written type, very like a</span>
<a name="line-624"></a>               <span class='hs-comment'>-- signature so we want to solve its equalities right now</span>
<a name="line-625"></a>               <span class='hs-varid'>bindNamedWildCardBinders</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-626"></a>               <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>kind</span>
<a name="line-627"></a>
<a name="line-628"></a>       <span class='hs-comment'>-- We do not kind-generalize type applications: we just</span>
<a name="line-629"></a>       <span class='hs-comment'>-- instantiate with exactly what the user says.</span>
<a name="line-630"></a>       <span class='hs-comment'>-- See Note [No generalization in type application]</span>
<a name="line-631"></a>       <span class='hs-comment'>-- We still must call kindGeneralizeNone, though, according</span>
<a name="line-632"></a>       <span class='hs-comment'>-- to Note [Recipe for checking a signature]</span>
<a name="line-633"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kindGeneralizeNone</span> <span class='hs-varid'>ty</span>
<a name="line-634"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-635"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-conid'>TypeAppCtxt</span> <span class='hs-varid'>ty</span>
<a name="line-636"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-637"></a>
<a name="line-638"></a><span class='hs-comment'>{- Note [Wildcards in visible type application]
<a name="line-639"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-640"></a>A HsWildCardBndrs's hswc_ext now only includes /named/ wildcards, so
<a name="line-641"></a>any unnamed wildcards stay unchanged in hswc_body.  When called in
<a name="line-642"></a>tcHsTypeApp, tcCheckLHsType will call emitAnonTypeHole
<a name="line-643"></a>on these anonymous wildcards. However, this would trigger
<a name="line-644"></a>error/warning when an anonymous wildcard is passed in as a visible type
<a name="line-645"></a>argument, which we do not want because users should be able to write
<a name="line-646"></a>@_ to skip a instantiating a type variable variable without fuss. The
<a name="line-647"></a>solution is to switch the PartialTypeSignatures flags here to let the
<a name="line-648"></a>typechecker know that it's checking a '@_' and do not emit hole
<a name="line-649"></a>constraints on it.  See related Note [Wildcards in visible kind
<a name="line-650"></a>application] and Note [The wildcard story for types] in GHC.Hs.Type
<a name="line-651"></a>
<a name="line-652"></a>Ugh!
<a name="line-653"></a>
<a name="line-654"></a>Note [No generalization in type application]
<a name="line-655"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-656"></a>We do not kind-generalize type applications. Imagine
<a name="line-657"></a>
<a name="line-658"></a>  id @(Proxy Nothing)
<a name="line-659"></a>
<a name="line-660"></a>If we kind-generalized, we would get
<a name="line-661"></a>
<a name="line-662"></a>  id @(forall {k}. Proxy @(Maybe k) (Nothing @k))
<a name="line-663"></a>
<a name="line-664"></a>which is very sneakily impredicative instantiation.
<a name="line-665"></a>
<a name="line-666"></a>There is also the possibility of mentioning a wildcard
<a name="line-667"></a>(`id @(Proxy _)`), which definitely should not be kind-generalized.
<a name="line-668"></a>
<a name="line-669"></a>-}</span>
<a name="line-670"></a>
<a name="line-671"></a><a name="tcFamTyPats"></a><span class='hs-definition'>tcFamTyPats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span>
<a name="line-672"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsTyPats</span> <span class='hs-conid'>GhcRn</span>                <span class='hs-comment'>-- Patterns</span>
<a name="line-673"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>          <span class='hs-comment'>-- (lhs_type, lhs_kind)</span>
<a name="line-674"></a><span class='hs-comment'>-- Check the LHS of a type/data family instance</span>
<a name="line-675"></a><span class='hs-comment'>-- e.g.   type instance F ty1 .. tyn = ...</span>
<a name="line-676"></a><span class='hs-comment'>-- Used for both type and data families</span>
<a name="line-677"></a><span class='hs-definition'>tcFamTyPats</span> <span class='hs-varid'>fam_tc</span> <span class='hs-varid'>hs_pats</span>
<a name="line-678"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcFamTyPats {"</span> <span class='hs-varop'>$</span>
<a name="line-679"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"arity:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_arity</span> <span class='hs-keyglyph'>]</span>
<a name="line-680"></a>
<a name="line-681"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHoleMode</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-conid'>HM_FamPat</span>
<a name="line-682"></a>                 <span class='hs-comment'>-- HM_FamPat: See Note [Wildcards in family instances] in</span>
<a name="line-683"></a>                 <span class='hs-comment'>-- GHC.Rename.Module</span>
<a name="line-684"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>fun_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>fam_tc</span> <span class='hs-conid'>[]</span>
<a name="line-685"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_app</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>lhs_fun</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>hs_pats</span>
<a name="line-686"></a>
<a name="line-687"></a>       <span class='hs-comment'>-- Hack alert: see Note [tcFamTyPats: zonking the result kind]</span>
<a name="line-688"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>res_kind</span>
<a name="line-689"></a>
<a name="line-690"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"End tcFamTyPats }"</span> <span class='hs-varop'>$</span>
<a name="line-691"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fam_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"res_kind:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>]</span>
<a name="line-692"></a>
<a name="line-693"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fam_app</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-694"></a>  <span class='hs-keyword'>where</span>
<a name="line-695"></a>    <span class='hs-varid'>fam_name</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConName</span> <span class='hs-varid'>fam_tc</span>
<a name="line-696"></a>    <span class='hs-varid'>fam_arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>fam_tc</span>
<a name="line-697"></a>    <span class='hs-varid'>lhs_fun</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>noLocA</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>noAnn</span> <span class='hs-conid'>NotPromoted</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLocA</span> <span class='hs-varid'>fam_name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-698"></a>
<a name="line-699"></a><span class='hs-comment'>{- Note [tcFamTyPats: zonking the result kind]
<a name="line-700"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-701"></a>Consider (#19250)
<a name="line-702"></a>    F :: forall k. k -&gt; k
<a name="line-703"></a>    type instance F (x :: Constraint) = ()
<a name="line-704"></a>
<a name="line-705"></a>The tricky point is this:
<a name="line-706"></a>  is that () an empty type tuple (() :: Type), or
<a name="line-707"></a>  an empty constraint tuple (() :: Constraint)?
<a name="line-708"></a>We work this out in a hacky way, by looking at the expected kind:
<a name="line-709"></a>see Note [Inferring tuple kinds].
<a name="line-710"></a>
<a name="line-711"></a>In this case, we kind-check the RHS using the kind gotten from the LHS:
<a name="line-712"></a>see the call to tcCheckLHsType in tcTyFamInstEqnGuts in GHC.Tc.Tycl.
<a name="line-713"></a>
<a name="line-714"></a>But we want the kind from the LHS to be /zonked/, so that when
<a name="line-715"></a>kind-checking the RHS (tcCheckLHsType) we can "see" what we learned
<a name="line-716"></a>from kind-checking the LHS (tcFamTyPats).  In our example above, the
<a name="line-717"></a>type of the LHS is just `kappa` (by instantiating the forall k), but
<a name="line-718"></a>then we learn (from x::Constraint) that kappa ~ Constraint.  We want
<a name="line-719"></a>that info when kind-checking the RHS.
<a name="line-720"></a>
<a name="line-721"></a>Easy solution: just zonk that return kind.  Of course this won't help
<a name="line-722"></a>if there is lots of type-family reduction to do, but it works fine in
<a name="line-723"></a>common cases.
<a name="line-724"></a>-}</span>
<a name="line-725"></a>
<a name="line-726"></a>
<a name="line-727"></a><span class='hs-comment'>{-
<a name="line-728"></a>************************************************************************
<a name="line-729"></a>*                                                                      *
<a name="line-730"></a>            The main kind checker: no validity checks here
<a name="line-731"></a>*                                                                      *
<a name="line-732"></a>************************************************************************
<a name="line-733"></a>-}</span>
<a name="line-734"></a>
<a name="line-735"></a><a name="tcHsOpenType"></a><span class='hs-comment'>---------------------------</span>
<a name="line-736"></a><span class='hs-definition'>tcHsOpenType</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedType</span><span class='hs-layout'>,</span>
<a name="line-737"></a>  <span class='hs-varid'>tcHsOpenTypeNC</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcHsLiftedTypeNC</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-738"></a><span class='hs-comment'>-- Used for type signatures</span>
<a name="line-739"></a><span class='hs-comment'>-- Do not do validity checking</span>
<a name="line-740"></a><span class='hs-definition'>tcHsOpenType</span>   <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcHsOpenTypeNC</span> <span class='hs-varid'>hs_ty</span>
<a name="line-741"></a><a name="tcHsLiftedType"></a><span class='hs-definition'>tcHsLiftedType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tcHsLiftedTypeNC</span> <span class='hs-varid'>hs_ty</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="tcHsOpenTypeNC"></a><span class='hs-definition'>tcHsOpenTypeNC</span>   <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span><span class='hs-layout'>;</span> <span class='hs-varid'>tcLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ek</span> <span class='hs-layout'>}</span>
<a name="line-744"></a><a name="tcHsLiftedTypeNC"></a><span class='hs-definition'>tcHsLiftedTypeNC</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-745"></a>
<a name="line-746"></a><a name="tcCheckLHsType"></a><span class='hs-comment'>-- Like tcHsType, but takes an expected kind</span>
<a name="line-747"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-748"></a><span class='hs-definition'>tcCheckLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-749"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-750"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-751"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ek</span> <span class='hs-layout'>}</span>
<a name="line-752"></a>
<a name="line-753"></a><a name="tcInferLHsType"></a><span class='hs-definition'>tcInferLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-754"></a><span class='hs-definition'>tcInferLHsType</span> <span class='hs-varid'>hs_ty</span>
<a name="line-755"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-sel'>_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferLHsTypeKind</span> <span class='hs-varid'>hs_ty</span>
<a name="line-756"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span>
<a name="line-757"></a>
<a name="line-758"></a><a name="tcInferLHsTypeKind"></a><span class='hs-definition'>tcInferLHsTypeKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-759"></a><span class='hs-comment'>-- Called from outside: set the context</span>
<a name="line-760"></a><span class='hs-comment'>-- Eagerly instantiate any trailing invisible binders</span>
<a name="line-761"></a><span class='hs-definition'>tcInferLHsTypeKind</span> <span class='hs-varid'>lhs_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-762"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>lhs_ty</span> <span class='hs-varop'>$</span>
<a name="line-763"></a>    <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span>    <span class='hs-varop'>$</span>  <span class='hs-comment'>-- Cover the tcInstInvisibleTyBinders</span>
<a name="line-764"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span>
<a name="line-765"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcInstInvisibleTyBinders</span> <span class='hs-varid'>res_ty</span> <span class='hs-varid'>res_kind</span> <span class='hs-layout'>}</span>
<a name="line-766"></a>  <span class='hs-comment'>-- See Note [Do not always instantiate eagerly in types]</span>
<a name="line-767"></a>
<a name="line-768"></a><a name="tcInferLHsTypeUnsaturated"></a><span class='hs-comment'>-- Used to check the argument of GHCi :kind</span>
<a name="line-769"></a><span class='hs-comment'>-- Allow and report wildcards, e.g. :kind T _</span>
<a name="line-770"></a><span class='hs-comment'>-- Do not saturate family applications: see Note [Dealing with :kind]</span>
<a name="line-771"></a><span class='hs-comment'>-- Does not instantiate eagerly; See Note [Do not always instantiate eagerly in types]</span>
<a name="line-772"></a><span class='hs-definition'>tcInferLHsTypeUnsaturated</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-773"></a><span class='hs-definition'>tcInferLHsTypeUnsaturated</span> <span class='hs-varid'>hs_ty</span>
<a name="line-774"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-775"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHoleMode</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-conid'>HM_Sig</span>  <span class='hs-comment'>-- Allow and report holes</span>
<a name="line-776"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitHsAppTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-777"></a>           <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_args</span><span class='hs-layout'>)</span>
<a name="line-778"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-sel'>_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferTyAppHead</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_fun_ty</span>
<a name="line-779"></a>                    <span class='hs-layout'>;</span> <span class='hs-varid'>tcInferTyApps_nosat</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_fun_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>hs_args</span> <span class='hs-layout'>}</span>
<a name="line-780"></a>                      <span class='hs-comment'>-- Notice the 'nosat'; do not instantiate trailing</span>
<a name="line-781"></a>                      <span class='hs-comment'>-- invisible arguments of a type family.</span>
<a name="line-782"></a>                      <span class='hs-comment'>-- See Note [Dealing with :kind]</span>
<a name="line-783"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span>
<a name="line-784"></a>
<a name="line-785"></a><span class='hs-comment'>{- Note [Dealing with :kind]
<a name="line-786"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-787"></a>Consider this GHCi command
<a name="line-788"></a>  ghci&gt; type family F :: Either j k
<a name="line-789"></a>  ghci&gt; :kind F
<a name="line-790"></a>  F :: forall {j,k}. Either j k
<a name="line-791"></a>
<a name="line-792"></a>We will only get the 'forall' if we /refrain/ from saturating those
<a name="line-793"></a>invisible binders. But generally we /do/ saturate those invisible
<a name="line-794"></a>binders (see tcInferTyApps), and we want to do so for nested application
<a name="line-795"></a>even in GHCi.  Consider for example (#16287)
<a name="line-796"></a>  ghci&gt; type family F :: k
<a name="line-797"></a>  ghci&gt; data T :: (forall k. k) -&gt; Type
<a name="line-798"></a>  ghci&gt; :kind T F
<a name="line-799"></a>We want to reject this. It's just at the very top level that we want
<a name="line-800"></a>to switch off saturation.
<a name="line-801"></a>
<a name="line-802"></a>So tcInferLHsTypeUnsaturated does a little special case for top level
<a name="line-803"></a>applications.  Actually the common case is a bare variable, as above.
<a name="line-804"></a>
<a name="line-805"></a>Note [Do not always instantiate eagerly in types]
<a name="line-806"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-807"></a>Terms are eagerly instantiated. This means that if you say
<a name="line-808"></a>
<a name="line-809"></a>  x = id
<a name="line-810"></a>
<a name="line-811"></a>then `id` gets instantiated to have type alpha -&gt; alpha. The variable
<a name="line-812"></a>alpha is then unconstrained and regeneralized. But we cannot do this
<a name="line-813"></a>in types, as we have no type-level lambda. So, when we are sure
<a name="line-814"></a>that we will not want to regeneralize later -- because we are done
<a name="line-815"></a>checking a type, for example -- we can instantiate. But we do not
<a name="line-816"></a>instantiate at variables, nor do we in tcInferLHsTypeUnsaturated,
<a name="line-817"></a>which is used by :kind in GHCi.
<a name="line-818"></a>
<a name="line-819"></a>************************************************************************
<a name="line-820"></a>*                                                                      *
<a name="line-821"></a>      Type-checking modes
<a name="line-822"></a>*                                                                      *
<a name="line-823"></a>************************************************************************
<a name="line-824"></a>
<a name="line-825"></a>The kind-checker is parameterised by a TcTyMode, which contains some
<a name="line-826"></a>information about where we're checking a type.
<a name="line-827"></a>
<a name="line-828"></a>The renamer issues errors about what it can. All errors issued here must
<a name="line-829"></a>concern things that the renamer can't handle.
<a name="line-830"></a>
<a name="line-831"></a>-}</span>
<a name="line-832"></a>
<a name="line-833"></a><a name="tcMult"></a><span class='hs-definition'>tcMult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsArrow</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Mult</span>
<a name="line-834"></a><span class='hs-definition'>tcMult</span> <span class='hs-varid'>hc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_mult</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hc</span>
<a name="line-835"></a>
<a name="line-836"></a><a name="TcTyMode"></a><span class='hs-comment'>-- | Info about the context in which we're checking a type. Currently,</span>
<a name="line-837"></a><a name="TcTyMode"></a><span class='hs-comment'>-- differentiates only between types and kinds, but this will likely</span>
<a name="line-838"></a><a name="TcTyMode"></a><span class='hs-comment'>-- grow, at least to include the distinction between patterns and</span>
<a name="line-839"></a><a name="TcTyMode"></a><span class='hs-comment'>-- not-patterns.</span>
<a name="line-840"></a><a name="TcTyMode"></a><span class='hs-comment'>--</span>
<a name="line-841"></a><a name="TcTyMode"></a><span class='hs-comment'>-- To find out where the mode is used, search for 'mode_tyki'</span>
<a name="line-842"></a><a name="TcTyMode"></a><span class='hs-comment'>--</span>
<a name="line-843"></a><a name="TcTyMode"></a><span class='hs-comment'>-- This data type is purely local, not exported from this module</span>
<a name="line-844"></a><a name="TcTyMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-845"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_tyki</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span>
<a name="line-846"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>mode_holes</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HoleInfo</span>   <span class='hs-layout'>}</span>
<a name="line-847"></a>
<a name="line-848"></a><a name="HoleInfo"></a><span class='hs-comment'>-- See Note [Levels for wildcards]</span>
<a name="line-849"></a><a name="HoleInfo"></a><span class='hs-comment'>-- Nothing &lt;=&gt; no wildcards expected</span>
<a name="line-850"></a><a name="HoleInfo"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>HoleInfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcLevel</span><span class='hs-layout'>,</span> <span class='hs-conid'>HoleMode</span><span class='hs-layout'>)</span>
<a name="line-851"></a>
<a name="line-852"></a><a name="HoleMode"></a><span class='hs-comment'>-- HoleMode says how to treat the occurrences</span>
<a name="line-853"></a><a name="HoleMode"></a><span class='hs-comment'>-- of anonymous wildcards; see tcAnonWildCardOcc</span>
<a name="line-854"></a><a name="HoleMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>HoleMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HM_Sig</span>      <span class='hs-comment'>-- Partial type signatures: f :: _ -&gt; Int</span>
<a name="line-855"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HM_FamPat</span>   <span class='hs-comment'>-- Family instances: F _ Int = Bool</span>
<a name="line-856"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HM_VTA</span>      <span class='hs-comment'>-- Visible type and kind application:</span>
<a name="line-857"></a>                            <span class='hs-comment'>--   f @(Maybe _)</span>
<a name="line-858"></a>                            <span class='hs-comment'>--   Maybe @(_ -&gt; _)</span>
<a name="line-859"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HM_TyAppPat</span> <span class='hs-comment'>-- Visible type applications in patterns:</span>
<a name="line-860"></a>                            <span class='hs-comment'>--   foo (Con @_ @t x) = ...</span>
<a name="line-861"></a>                            <span class='hs-comment'>--   case x of Con @_ @t v -&gt; ...</span>
<a name="line-862"></a>
<a name="line-863"></a><a name="mkMode"></a><span class='hs-definition'>mkMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-864"></a><span class='hs-definition'>mkMode</span> <span class='hs-varid'>tyki</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_tyki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyki</span><span class='hs-layout'>,</span> <span class='hs-varid'>mode_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-865"></a>
<a name="line-866"></a><a name="typeLevelMode"></a><span class='hs-definition'>typeLevelMode</span><span class='hs-layout'>,</span> <span class='hs-varid'>kindLevelMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-867"></a><a name="kindLevelMode"></a><span class='hs-comment'>-- These modes expect no wildcards (holes) in the type</span>
<a name="line-868"></a><span class='hs-definition'>kindLevelMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMode</span> <span class='hs-conid'>KindLevel</span>
<a name="line-869"></a><span class='hs-definition'>typeLevelMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkMode</span> <span class='hs-conid'>TypeLevel</span>
<a name="line-870"></a>
<a name="line-871"></a><a name="mkHoleMode"></a><span class='hs-definition'>mkHoleMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TypeOrKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HoleMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-872"></a><span class='hs-definition'>mkHoleMode</span> <span class='hs-varid'>tyki</span> <span class='hs-varid'>hm</span>
<a name="line-873"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-874"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_tyki</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyki</span>
<a name="line-875"></a>                          <span class='hs-layout'>,</span> <span class='hs-varid'>mode_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>lvl</span><span class='hs-layout'>,</span><span class='hs-varid'>hm</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-876"></a>
<a name="line-877"></a><a name="instance%20Outputable%20HoleMode"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>HoleMode</span> <span class='hs-keyword'>where</span>
<a name="line-878"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HM_Sig</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"HM_Sig"</span>
<a name="line-879"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HM_FamPat</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"HM_FamPat"</span>
<a name="line-880"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HM_VTA</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"HM_VTA"</span>
<a name="line-881"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>HM_TyAppPat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"HM_TyAppPat"</span>
<a name="line-882"></a>
<a name="line-883"></a><a name="instance%20Outputable%20TcTyMode"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyword'>where</span>
<a name="line-884"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_tyki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyki</span><span class='hs-layout'>,</span> <span class='hs-varid'>mode_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hm</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-885"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"TcTyMode"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>braces</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tyki</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>comma</span>
<a name="line-886"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hm</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-887"></a>
<a name="line-888"></a><span class='hs-comment'>{-
<a name="line-889"></a>Note [Bidirectional type checking]
<a name="line-890"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-891"></a>In expressions, whenever we see a polymorphic identifier, say `id`, we are
<a name="line-892"></a>free to instantiate it with metavariables, knowing that we can always
<a name="line-893"></a>re-generalize with type-lambdas when necessary. For example:
<a name="line-894"></a>
<a name="line-895"></a>  rank2 :: (forall a. a -&gt; a) -&gt; ()
<a name="line-896"></a>  x = rank2 id
<a name="line-897"></a>
<a name="line-898"></a>When checking the body of `x`, we can instantiate `id` with a metavariable.
<a name="line-899"></a>Then, when we're checking the application of `rank2`, we notice that we really
<a name="line-900"></a>need a polymorphic `id`, and then re-generalize over the unconstrained
<a name="line-901"></a>metavariable.
<a name="line-902"></a>
<a name="line-903"></a>In types, however, we're not so lucky, because *we cannot re-generalize*!
<a name="line-904"></a>There is no lambda. So, we must be careful only to instantiate at the last
<a name="line-905"></a>possible moment, when we're sure we're never going to want the lost polymorphism
<a name="line-906"></a>again. This is done in calls to tcInstInvisibleTyBinders.
<a name="line-907"></a>
<a name="line-908"></a>To implement this behavior, we use bidirectional type checking, where we
<a name="line-909"></a>explicitly think about whether we know the kind of the type we're checking
<a name="line-910"></a>or not. Note that there is a difference between not knowing a kind and
<a name="line-911"></a>knowing a metavariable kind: the metavariables are TauTvs, and cannot become
<a name="line-912"></a>forall-quantified kinds. Previously (before dependent types), there were
<a name="line-913"></a>no higher-rank kinds, and so we could instantiate early and be sure that
<a name="line-914"></a>no types would have polymorphic kinds, and so we could always assume that
<a name="line-915"></a>the kind of a type was a fresh metavariable. Not so anymore, thus the
<a name="line-916"></a>need for two algorithms.
<a name="line-917"></a>
<a name="line-918"></a>For HsType forms that can never be kind-polymorphic, we implement only the
<a name="line-919"></a>"down" direction, where we safely assume a metavariable kind. For HsType forms
<a name="line-920"></a>that *can* be kind-polymorphic, we implement just the "up" (functions with
<a name="line-921"></a>"infer" in their name) version, as we gain nothing by also implementing the
<a name="line-922"></a>"down" version.
<a name="line-923"></a>
<a name="line-924"></a>Note [Future-proofing the type checker]
<a name="line-925"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-926"></a>As discussed in Note [Bidirectional type checking], each HsType form is
<a name="line-927"></a>handled in *either* tc_infer_hs_type *or* tc_hs_type. These functions
<a name="line-928"></a>are mutually recursive, so that either one can work for any type former.
<a name="line-929"></a>But, we want to make sure that our pattern-matches are complete. So,
<a name="line-930"></a>we have a bunch of repetitive code just so that we get warnings if we're
<a name="line-931"></a>missing any patterns.
<a name="line-932"></a>
<a name="line-933"></a>-}</span>
<a name="line-934"></a>
<a name="line-935"></a><a name="tc_infer_lhs_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-936"></a><span class='hs-comment'>-- | Check and desugar a type, returning the core type and its</span>
<a name="line-937"></a><span class='hs-comment'>-- possibly-polymorphic kind. Much like 'tcInferRho' at the expression</span>
<a name="line-938"></a><span class='hs-comment'>-- level.</span>
<a name="line-939"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-940"></a><span class='hs-definition'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-941"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-942"></a>    <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-943"></a>
<a name="line-944"></a><a name="tc_infer_hs_type_ek"></a><span class='hs-comment'>---------------------------</span>
<a name="line-945"></a><span class='hs-comment'>-- | Call 'tc_infer_hs_type' and check its result against an expected kind.</span>
<a name="line-946"></a><span class='hs-definition'>tc_infer_hs_type_ek</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-947"></a><span class='hs-definition'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ek</span>
<a name="line-948"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span>
<a name="line-949"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span> <span class='hs-varid'>ek</span> <span class='hs-layout'>}</span>
<a name="line-950"></a>
<a name="line-951"></a><a name="tc_infer_hs_type"></a><span class='hs-comment'>---------------------------</span>
<a name="line-952"></a><span class='hs-comment'>-- | Infer the kind of a type and desugar. This is the "up" type-checker,</span>
<a name="line-953"></a><span class='hs-comment'>-- as described in Note [Bidirectional type checking]</span>
<a name="line-954"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-955"></a>
<a name="line-956"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-957"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>t</span>
<a name="line-958"></a>
<a name="line-959"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-960"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_fun_ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitHsAppTys</span> <span class='hs-varid'>ty</span>
<a name="line-961"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun_ty</span><span class='hs-layout'>,</span> <span class='hs-sel'>_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferTyAppHead</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_fun_ty</span>
<a name="line-962"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcInferTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_fun_ty</span> <span class='hs-varid'>fun_ty</span> <span class='hs-varid'>hs_args</span> <span class='hs-layout'>}</span>
<a name="line-963"></a>
<a name="line-964"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span>
<a name="line-965"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mode'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_tyki</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindLevel</span> <span class='hs-layout'>}</span>
<a name="line-966"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>sig'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind_sig</span> <span class='hs-varid'>mode'</span> <span class='hs-conid'>KindSigCtxt</span> <span class='hs-varid'>sig</span>
<a name="line-967"></a>                 <span class='hs-comment'>-- We must typecheck the kind signature, and solve all</span>
<a name="line-968"></a>                 <span class='hs-comment'>-- its equalities etc; from this point on we may do</span>
<a name="line-969"></a>                 <span class='hs-comment'>-- things like instantiate its foralls, so it needs</span>
<a name="line-970"></a>                 <span class='hs-comment'>-- to be fully determined (#14904)</span>
<a name="line-971"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_infer_hs_type:sig"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>sig'</span><span class='hs-layout'>)</span>
<a name="line-972"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>sig'</span>
<a name="line-973"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-974"></a>
<a name="line-975"></a><span class='hs-comment'>-- HsSpliced is an annotation produced by 'GHC.Rename.Splice.rnSpliceType' to communicate</span>
<a name="line-976"></a><span class='hs-comment'>-- the splice location to the typechecker. Here we skip over it in order to have</span>
<a name="line-977"></a><span class='hs-comment'>-- the same kind inferred for a given expression whether it was produced from</span>
<a name="line-978"></a><span class='hs-comment'>-- splices or not.</span>
<a name="line-979"></a><span class='hs-comment'>--</span>
<a name="line-980"></a><span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices].</span>
<a name="line-981"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliced</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-982"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-983"></a>
<a name="line-984"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-985"></a>
<a name="line-986"></a><span class='hs-comment'>-- See Note [Typechecking HsCoreTys]</span>
<a name="line-987"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>XHsType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-988"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclEnv</span>
<a name="line-989"></a>       <span class='hs-comment'>-- Raw uniques since we go from NameEnv to TvSubstEnv.</span>
<a name="line-990"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>subst_prs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Unique</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-991"></a>           <span class='hs-varid'>subst_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUnique</span> <span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-992"></a>                       <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ATyVar</span> <span class='hs-varid'>nm</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>nameEnvElts</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcl_env</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-993"></a>           <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTvSubst</span>
<a name="line-994"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkVarSet</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>subst_prs</span><span class='hs-layout'>)</span>
<a name="line-995"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>listToUFM_Directly</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftSnd</span> <span class='hs-varid'>mkTyVarTy</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst_prs</span><span class='hs-layout'>)</span>
<a name="line-996"></a>           <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ty</span>
<a name="line-997"></a>       <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-998"></a>
<a name="line-999"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-1000"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>tys</span>  <span class='hs-comment'>-- this is so that we can use visible kind application with '[]</span>
<a name="line-1001"></a>              <span class='hs-comment'>-- e.g ... '[] @Bool</span>
<a name="line-1002"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>promotedNilDataCon</span><span class='hs-layout'>,</span>
<a name="line-1003"></a>            <span class='hs-varid'>mkSpecForAllTys</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>alphaTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkListTy</span> <span class='hs-varid'>alphaTy</span><span class='hs-layout'>)</span>
<a name="line-1004"></a>
<a name="line-1005"></a><span class='hs-definition'>tc_infer_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>other_ty</span>
<a name="line-1006"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1007"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>other_ty</span> <span class='hs-varid'>kv</span>
<a name="line-1008"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1009"></a>
<a name="line-1010"></a><span class='hs-comment'>{-
<a name="line-1011"></a>Note [Typechecking HsCoreTys]
<a name="line-1012"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1013"></a>HsCoreTy is an escape hatch that allows embedding Core Types in HsTypes.
<a name="line-1014"></a>As such, there's not much to be done in order to typecheck an HsCoreTy,
<a name="line-1015"></a>since it's already been typechecked to some extent. There is one thing that
<a name="line-1016"></a>we must do, however: we must substitute the type variables from the tcl_env.
<a name="line-1017"></a>To see why, consider GeneralizedNewtypeDeriving, which is one of the main
<a name="line-1018"></a>clients of HsCoreTy (example adapted from #14579):
<a name="line-1019"></a>
<a name="line-1020"></a>  newtype T a = MkT a deriving newtype Eq
<a name="line-1021"></a>
<a name="line-1022"></a>This will produce an InstInfo GhcPs that looks roughly like this:
<a name="line-1023"></a>
<a name="line-1024"></a>  instance forall a_1. Eq a_1 =&gt; Eq (T a_1) where
<a name="line-1025"></a>    (==) = coerce @(  a_1 -&gt;   a_1 -&gt; Bool) -- The type within @(...) is an HsCoreTy
<a name="line-1026"></a>                  @(T a_1 -&gt; T a_1 -&gt; Bool) -- So is this
<a name="line-1027"></a>                  (==)
<a name="line-1028"></a>
<a name="line-1029"></a>This is then fed into the renamer. Since all of the type variables in this
<a name="line-1030"></a>InstInfo use Exact RdrNames, the resulting InstInfo GhcRn looks basically
<a name="line-1031"></a>identical. Things get more interesting when the InstInfo is fed into the
<a name="line-1032"></a>typechecker, however. GHC will first generate fresh skolems to instantiate
<a name="line-1033"></a>the instance-bound type variables with. In the example above, we might generate
<a name="line-1034"></a>the skolem a_2 and use that to instantiate a_1, which extends the local type
<a name="line-1035"></a>environment (tcl_env) with [a_1 :-&gt; a_2]. This gives us:
<a name="line-1036"></a>
<a name="line-1037"></a>  instance forall a_2. Eq a_2 =&gt; Eq (T a_2) where ...
<a name="line-1038"></a>
<a name="line-1039"></a>To ensure that the body of this instance is well scoped, every occurrence of
<a name="line-1040"></a>the `a` type variable should refer to a_2, the new skolem. However, the
<a name="line-1041"></a>HsCoreTys mention a_1, not a_2. Luckily, the tcl_env provides exactly the
<a name="line-1042"></a>substitution we need ([a_1 :-&gt; a_2]) to fix up the scoping. We apply this
<a name="line-1043"></a>substitution to each HsCoreTy and all is well:
<a name="line-1044"></a>
<a name="line-1045"></a>  instance forall a_2. Eq a_2 =&gt; Eq (T a_2) where
<a name="line-1046"></a>    (==) = coerce @(  a_2 -&gt;   a_2 -&gt; Bool)
<a name="line-1047"></a>                  @(T a_2 -&gt; T a_2 -&gt; Bool)
<a name="line-1048"></a>                  (==)
<a name="line-1049"></a>-}</span>
<a name="line-1050"></a>
<a name="line-1051"></a><a name="tcLHsType"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-1052"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1053"></a><span class='hs-definition'>tcLHsType</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1054"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1055"></a>
<a name="line-1056"></a><a name="tc_lhs_type"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1057"></a><span class='hs-definition'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>span</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1058"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>span</span> <span class='hs-varop'>$</span>
<a name="line-1059"></a>    <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1060"></a>
<a name="line-1061"></a><a name="tc_hs_type"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1062"></a><span class='hs-comment'>-- See Note [Bidirectional type checking]</span>
<a name="line-1063"></a>
<a name="line-1064"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>   <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1065"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsDocTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1066"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsBangTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>bang</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span>
<a name="line-1067"></a>    <span class='hs-comment'>-- While top-level bangs at this point are eliminated (eg !(Maybe Int)),</span>
<a name="line-1068"></a>    <span class='hs-comment'>-- other kinds of bangs are not (eg ((!Maybe) Int)). These kinds of</span>
<a name="line-1069"></a>    <span class='hs-comment'>-- bangs are invalid, so fail. (#7210, #14761)</span>
<a name="line-1070"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>bangError</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-varop'>$</span>
<a name="line-1071"></a>                 <span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"annotation:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span>
<a name="line-1072"></a>                 <span class='hs-varid'>text</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"annotation cannot appear nested inside a type"</span>
<a name="line-1073"></a>         <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>bang</span> <span class='hs-keyword'>of</span>
<a name="line-1074"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>SrcUnpack</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"UNPACK"</span>
<a name="line-1075"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>SrcNoUnpack</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"NOUNPACK"</span>
<a name="line-1076"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>NoSrcUnpack</span> <span class='hs-conid'>SrcLazy</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"laziness"</span>
<a name="line-1077"></a>             <span class='hs-conid'>HsSrcBang</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>bangError</span> <span class='hs-str'>"strictness"</span> <span class='hs-layout'>}</span>
<a name="line-1078"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsRecTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>_</span>
<a name="line-1079"></a>      <span class='hs-comment'>-- Record types (which only show up temporarily in constructor</span>
<a name="line-1080"></a>      <span class='hs-comment'>-- signatures) should have been removed by now</span>
<a name="line-1081"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Record syntax is illegal here:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1082"></a>
<a name="line-1083"></a><span class='hs-comment'>-- HsSpliced is an annotation produced by 'GHC.Rename.Splice.rnSpliceType'.</span>
<a name="line-1084"></a><span class='hs-comment'>-- Here we get rid of it and add the finalizers to the global environment</span>
<a name="line-1085"></a><span class='hs-comment'>-- while capturing the local environment.</span>
<a name="line-1086"></a><span class='hs-comment'>--</span>
<a name="line-1087"></a><span class='hs-comment'>-- See Note [Delaying modFinalizers in untyped splices].</span>
<a name="line-1088"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSpliced</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mod_finalizers</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSplicedTy</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1089"></a>           <span class='hs-varid'>exp_kind</span>
<a name="line-1090"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>addModFinalizersWithLclEnv</span> <span class='hs-varid'>mod_finalizers</span>
<a name="line-1091"></a>       <span class='hs-varid'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1092"></a>
<a name="line-1093"></a><span class='hs-comment'>-- This should never happen; type splices are expanded by the renamer</span>
<a name="line-1094"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSpliceTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-sel'>_exp_kind</span>
<a name="line-1095"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Unexpected type splice:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1096"></a>
<a name="line-1097"></a><span class='hs-comment'>---------- Functions and applications</span>
<a name="line-1098"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1099"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1100"></a>
<a name="line-1101"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty1</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span>
<a name="line-1103"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsUnrestrictedArrow</span> <span class='hs-conid'>NormalSyntax</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1104"></a>
<a name="line-1105"></a><span class='hs-comment'>--------- Foralls</span>
<a name="line-1106"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsForAllTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_tele</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tele</span><span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1107"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcTKTelescope</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tele</span> <span class='hs-varop'>$</span>
<a name="line-1108"></a>                            <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1109"></a>                 <span class='hs-comment'>-- Pass on the mode from the type, to any wildcards</span>
<a name="line-1110"></a>                 <span class='hs-comment'>-- in kind signatures on the forall'd variables</span>
<a name="line-1111"></a>                 <span class='hs-comment'>-- e.g.      f :: _ -&gt; Int -&gt; forall (a :: _). blah</span>
<a name="line-1112"></a>                 <span class='hs-comment'>-- Why exp_kind?  See Note [Body kind of HsForAllTy]</span>
<a name="line-1113"></a>
<a name="line-1114"></a>       <span class='hs-comment'>-- Do not kind-generalise here!  See Note [Kind generalisation]</span>
<a name="line-1115"></a>
<a name="line-1116"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkForAllTys</span> <span class='hs-varid'>tv_bndrs</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1117"></a>
<a name="line-1118"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsQualTy</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hst_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hst_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1119"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromMaybeContext</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-1120"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1121"></a>
<a name="line-1122"></a>  <span class='hs-comment'>-- See Note [Body kind of a HsQualTy]</span>
<a name="line-1123"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1124"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_context</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ctxt</span>
<a name="line-1125"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1126"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1127"></a>
<a name="line-1128"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1129"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_context</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ctxt</span>
<a name="line-1130"></a>
<a name="line-1131"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>  <span class='hs-comment'>-- The body kind (result of the function) can</span>
<a name="line-1132"></a>                                <span class='hs-comment'>-- be TYPE r, for any r, hence newOpenTypeKind</span>
<a name="line-1133"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>ek</span>
<a name="line-1134"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span>
<a name="line-1135"></a>                           <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1136"></a>
<a name="line-1137"></a><span class='hs-comment'>--------- Lists, arrays, and tuples</span>
<a name="line-1138"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsListTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>elt_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1139"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tau_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>elt_ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1140"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>listTyCon</span>
<a name="line-1141"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>tau_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1142"></a>
<a name="line-1143"></a><span class='hs-comment'>-- See Note [Distinguishing tuple kinds] in GHC.Hs.Type</span>
<a name="line-1144"></a><span class='hs-comment'>-- See Note [Inferring tuple kinds]</span>
<a name="line-1145"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsBoxedOrConstraintTuple</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1146"></a>     <span class='hs-comment'>-- (NB: not zonking before looking at exp_k, to avoid left-right bias)</span>
<a name="line-1147"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1148"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-1149"></a>    <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1150"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1151"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tc_hs_type tuple 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span>
<a name="line-1152"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys</span><span class='hs-layout'>,</span> <span class='hs-varid'>kinds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span>
<a name="line-1153"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>kinds</span>
<a name="line-1154"></a>           <span class='hs-comment'>-- Infer each arg type separately, because errors can be</span>
<a name="line-1155"></a>           <span class='hs-comment'>-- confusing if we give them a shared kind.  Eg #7410</span>
<a name="line-1156"></a>           <span class='hs-comment'>-- (Either Int, Int), we do not want to get an error saying</span>
<a name="line-1157"></a>           <span class='hs-comment'>-- "the second argument of a tuple should have kind *-&gt;*"</span>
<a name="line-1158"></a>
<a name="line-1159"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>arg_kind</span><span class='hs-layout'>,</span> <span class='hs-varid'>tup_sort</span><span class='hs-layout'>)</span>
<a name="line-1160"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kinds</span>
<a name="line-1161"></a>                              <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyword'>of</span>
<a name="line-1162"></a>                    <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span><span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-1163"></a>                    <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>,</span> <span class='hs-conid'>BoxedTuple</span><span class='hs-layout'>)</span>
<a name="line-1164"></a>         <span class='hs-comment'>-- In the [] case, it's not clear what the kind is, so guess *</span>
<a name="line-1165"></a>
<a name="line-1166"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sequence</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-1167"></a>                            <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>arg_kind</span>
<a name="line-1168"></a>                          <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span><span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zip3</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>kinds</span> <span class='hs-keyglyph'>]</span>
<a name="line-1169"></a>
<a name="line-1170"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys'</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>arg_kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1171"></a>
<a name="line-1172"></a>
<a name="line-1173"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>HsUnboxedTuple</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1174"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-conid'>UnboxedTuple</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1175"></a>
<a name="line-1176"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsSumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1177"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>hs_tys</span>
<a name="line-1178"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newOpenTypeKind</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span>
<a name="line-1179"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau_tys</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_tys</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-1180"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arg_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>kindRep</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-1181"></a>             <span class='hs-varid'>arg_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>arg_reps</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span>
<a name="line-1182"></a>             <span class='hs-varid'>sum_ty</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>sumTyCon</span> <span class='hs-varid'>arity</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg_tys</span>
<a name="line-1183"></a>             <span class='hs-varid'>sum_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unboxedSumKind</span> <span class='hs-varid'>arg_reps</span>
<a name="line-1184"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>sum_ty</span> <span class='hs-varid'>sum_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1185"></a>       <span class='hs-layout'>}</span>
<a name="line-1186"></a>
<a name="line-1187"></a><span class='hs-comment'>--------- Promoted lists and tuples</span>
<a name="line-1188"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitListTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1189"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tks</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-1190"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>taus'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unifyKinds</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tks</span>
<a name="line-1191"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_cons</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mk_nil</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>taus'</span><span class='hs-layout'>)</span>
<a name="line-1192"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkListTy</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1193"></a>  <span class='hs-keyword'>where</span>
<a name="line-1194"></a>    <span class='hs-varid'>mk_cons</span> <span class='hs-varid'>k</span> <span class='hs-varid'>a</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>consDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>b</span><span class='hs-keyglyph'>]</span>
<a name="line-1195"></a>    <span class='hs-varid'>mk_nil</span>  <span class='hs-varid'>k</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-layout'>(</span><span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>nilDataCon</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>k</span><span class='hs-keyglyph'>]</span>
<a name="line-1196"></a>
<a name="line-1197"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsExplicitTupleTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1198"></a>  <span class='hs-comment'>-- using newMetaKindVar means that we force instantiations of any polykinded</span>
<a name="line-1199"></a>  <span class='hs-comment'>-- types. At first, I just used tc_infer_lhs_type, but that led to #11255.</span>
<a name="line-1200"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ks</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-1201"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>taus</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>ks</span>
<a name="line-1202"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kind_con</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span>           <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-1203"></a>             <span class='hs-varid'>ty_con</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promotedTupleDataCon</span> <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-1204"></a>             <span class='hs-varid'>tup_k</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>kind_con</span> <span class='hs-varid'>ks</span>
<a name="line-1205"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTupSize</span> <span class='hs-varid'>arity</span>
<a name="line-1206"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>ty_con</span> <span class='hs-layout'>(</span><span class='hs-varid'>ks</span> <span class='hs-varop'>++</span> <span class='hs-varid'>taus</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>tup_k</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1207"></a>  <span class='hs-keyword'>where</span>
<a name="line-1208"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-1209"></a>
<a name="line-1210"></a><span class='hs-comment'>--------- Constraint types</span>
<a name="line-1211"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsIParamTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1212"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_tyki</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-1213"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1214"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStrLitTy</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsIPNameFS</span> <span class='hs-varid'>n</span>
<a name="line-1215"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupClass</span> <span class='hs-varid'>ipClassName</span>
<a name="line-1216"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>ipClass</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span><span class='hs-varid'>ty'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1217"></a>                           <span class='hs-varid'>constraintKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1218"></a>
<a name="line-1219"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsStarTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1220"></a>  <span class='hs-comment'>-- Desugaring 'HsStarTy' to 'Data.Kind.Type' here means that we don't have to</span>
<a name="line-1221"></a>  <span class='hs-comment'>-- handle it in 'coreView' and 'tcView'.</span>
<a name="line-1222"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1223"></a>
<a name="line-1224"></a><span class='hs-comment'>--------- Literals</span>
<a name="line-1225"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsNumTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1226"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>naturalTyCon</span>
<a name="line-1227"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNumLitTy</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>naturalTy</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1228"></a>
<a name="line-1229"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsStrTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1230"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>typeSymbolKindCon</span>
<a name="line-1231"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkStrLitTy</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>typeSymbolKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1232"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rn_ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyLit</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsCharTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1233"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>charTyCon</span>
<a name="line-1234"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkCharLitTy</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-varid'>charTy</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1235"></a>
<a name="line-1236"></a><span class='hs-comment'>--------- Wildcards</span>
<a name="line-1237"></a>
<a name="line-1238"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>        <span class='hs-varid'>ek</span>
<a name="line-1239"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcAnonWildCardOcc</span> <span class='hs-conid'>NoExtraConstraint</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-1240"></a>
<a name="line-1241"></a><span class='hs-comment'>--------- Potentially kind-polymorphic types: call the "up" checker</span>
<a name="line-1242"></a><span class='hs-comment'>-- See Note [Future-proofing the type checker]</span>
<a name="line-1243"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-1244"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-1245"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsAppKindTy</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>         <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-1246"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>             <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-1247"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsKindSig</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>          <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-1248"></a><span class='hs-definition'>tc_hs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>XHsType</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_hs_type_ek</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>ek</span>
<a name="line-1249"></a>
<a name="line-1250"></a><span class='hs-comment'>{-
<a name="line-1251"></a>Note [Variable Specificity and Forall Visibility]
<a name="line-1252"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1253"></a>A HsForAllTy contains an HsForAllTelescope to denote the visibility of the forall
<a name="line-1254"></a>binder. Furthermore, each invisible type variable binder also has a
<a name="line-1255"></a>Specificity. Together, these determine the variable binders (ArgFlag) for each
<a name="line-1256"></a>variable in the generated ForAllTy type.
<a name="line-1257"></a>
<a name="line-1258"></a>This table summarises this relation:
<a name="line-1259"></a>----------------------------------------------------------------------------
<a name="line-1260"></a>| User-written type         HsForAllTelescope   Specificity        ArgFlag
<a name="line-1261"></a>|---------------------------------------------------------------------------
<a name="line-1262"></a>| f :: forall a. type       HsForAllInvis       SpecifiedSpec      Specified
<a name="line-1263"></a>| f :: forall {a}. type     HsForAllInvis       InferredSpec       Inferred
<a name="line-1264"></a>| f :: forall a -&gt; type     HsForAllVis         SpecifiedSpec      Required
<a name="line-1265"></a>| f :: forall {a} -&gt; type   HsForAllVis         InferredSpec       /
<a name="line-1266"></a>|   This last form is non-sensical and is thus rejected.
<a name="line-1267"></a>----------------------------------------------------------------------------
<a name="line-1268"></a>
<a name="line-1269"></a>For more information regarding the interpretation of the resulting ArgFlag, see
<a name="line-1270"></a>Note [VarBndrs, TyCoVarBinders, TyConBinders, and visibility] in "GHC.Core.TyCo.Rep".
<a name="line-1271"></a>-}</span>
<a name="line-1272"></a>
<a name="line-1273"></a><a name="tc_mult"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-1274"></a><span class='hs-definition'>tc_mult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsArrow</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Mult</span>
<a name="line-1275"></a><span class='hs-definition'>tc_mult</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-varid'>arrowToHsType</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>multiplicityTy</span>
<a name="line-1276"></a><a name="tc_fun_type"></a><span class='hs-comment'>------------------------------------------</span>
<a name="line-1277"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsArrow</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>
<a name="line-1278"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1279"></a><span class='hs-definition'>tc_fun_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>mode_tyki</span> <span class='hs-varid'>mode</span> <span class='hs-keyword'>of</span>
<a name="line-1280"></a>  <span class='hs-conid'>TypeLevel</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1281"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-1282"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-1283"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>arg_k</span>
<a name="line-1284"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>res_k</span>
<a name="line-1285"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mult'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_mult</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>mult</span>
<a name="line-1286"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVisFunTy</span> <span class='hs-varid'>mult'</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-1287"></a>                           <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1288"></a>  <span class='hs-conid'>KindLevel</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-comment'>-- no representation polymorphism in kinds. yet.</span>
<a name="line-1289"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty1'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1290"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>ty2'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty2</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1291"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mult'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_mult</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>mult</span>
<a name="line-1292"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsFunTy</span> <span class='hs-varid'>noAnn</span> <span class='hs-varid'>mult</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVisFunTy</span> <span class='hs-varid'>mult'</span> <span class='hs-varid'>ty1'</span> <span class='hs-varid'>ty2'</span><span class='hs-layout'>)</span>
<a name="line-1293"></a>                           <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1294"></a>
<a name="line-1295"></a><span class='hs-comment'>{- Note [Skolem escape and forall-types]
<a name="line-1296"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1297"></a>See also Note [Checking telescopes].
<a name="line-1298"></a>
<a name="line-1299"></a>Consider
<a name="line-1300"></a>  f :: forall a. (forall kb (b :: kb). Proxy '[a, b]) -&gt; ()
<a name="line-1301"></a>
<a name="line-1302"></a>The Proxy '[a,b] forces a and b to have the same kind.  But a's
<a name="line-1303"></a>kind must be bound outside the 'forall a', and hence escapes.
<a name="line-1304"></a>We discover this by building an implication constraint for
<a name="line-1305"></a>each forall.  So the inner implication constraint will look like
<a name="line-1306"></a>    forall kb (b::kb).  kb ~ ka
<a name="line-1307"></a>where ka is a's kind.  We can't unify these two, /even/ if ka is
<a name="line-1308"></a>unification variable, because it would be untouchable inside
<a name="line-1309"></a>this inner implication.
<a name="line-1310"></a>
<a name="line-1311"></a>That's what the pushLevelAndCaptureConstraints, plus subsequent
<a name="line-1312"></a>buildTvImplication/emitImplication is all about, when kind-checking
<a name="line-1313"></a>HsForAllTy.
<a name="line-1314"></a>
<a name="line-1315"></a>Note that
<a name="line-1316"></a>
<a name="line-1317"></a>* We don't need to /simplify/ the constraints here
<a name="line-1318"></a>  because we aren't generalising. We just capture them.
<a name="line-1319"></a>
<a name="line-1320"></a>* We can't use emitResidualTvConstraint, because that has a fast-path
<a name="line-1321"></a>  for empty constraints.  We can't take that fast path here, because
<a name="line-1322"></a>  we must do the bad-telescope check even if there are no inner wanted
<a name="line-1323"></a>  constraints. See Note [Checking telescopes] in
<a name="line-1324"></a>  GHC.Tc.Types.Constraint.  Lacking this check led to #16247.
<a name="line-1325"></a>-}</span>
<a name="line-1326"></a>
<a name="line-1327"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1328"></a>*                                                                      *
<a name="line-1329"></a>                Tuples
<a name="line-1330"></a>*                                                                      *
<a name="line-1331"></a>********************************************************************* -}</span>
<a name="line-1332"></a>
<a name="line-1333"></a><a name="tupKindSort_maybe"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1334"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TupleSort</span>
<a name="line-1335"></a><span class='hs-definition'>tupKindSort_maybe</span> <span class='hs-varid'>k</span>
<a name="line-1336"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>k'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitCastTy_maybe</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k'</span>
<a name="line-1337"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>k'</span>      <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>k</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupKindSort_maybe</span> <span class='hs-varid'>k'</span>
<a name="line-1338"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-varid'>k</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>ConstraintTuple</span>
<a name="line-1339"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsLiftedTypeKind</span> <span class='hs-varid'>k</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-conid'>BoxedTuple</span>
<a name="line-1340"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1341"></a>
<a name="line-1342"></a><a name="tc_tuple"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1343"></a><span class='hs-definition'>tc_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1344"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-1345"></a>           <span class='hs-conid'>BoxedTuple</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>liftedTypeKind</span><span class='hs-layout'>)</span>
<a name="line-1346"></a>           <span class='hs-conid'>UnboxedTuple</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>replicateM</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-1347"></a>           <span class='hs-conid'>ConstraintTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>replicate</span> <span class='hs-varid'>arity</span> <span class='hs-varid'>constraintKind</span><span class='hs-layout'>)</span>
<a name="line-1348"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau_tys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>arg_kinds</span>
<a name="line-1349"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>arg_kinds</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-1350"></a>  <span class='hs-keyword'>where</span>
<a name="line-1351"></a>    <span class='hs-varid'>arity</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tys</span>
<a name="line-1352"></a>
<a name="line-1353"></a><a name="finish_tuple"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1354"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TupleSort</span>
<a name="line-1355"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ argument types</span>
<a name="line-1356"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcKind</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- ^ of these kinds</span>
<a name="line-1357"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>      <span class='hs-comment'>-- ^ expected kind of the whole tuple</span>
<a name="line-1358"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1359"></a><span class='hs-definition'>finish_tuple</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varid'>tau_tys</span> <span class='hs-varid'>tau_kinds</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1360"></a>  <span class='hs-varid'>traceTc</span> <span class='hs-str'>"finish_tuple"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tup_sort</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tau_kinds</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-1361"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>tup_sort</span> <span class='hs-keyword'>of</span>
<a name="line-1362"></a>    <span class='hs-conid'>ConstraintTuple</span>
<a name="line-1363"></a>      <span class='hs-keyglyph'>|</span>  <span class='hs-keyglyph'>[</span><span class='hs-varid'>tau_ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tau_tys</span>
<a name="line-1364"></a>         <span class='hs-comment'>-- Drop any uses of 1-tuple constraints here.</span>
<a name="line-1365"></a>         <span class='hs-comment'>-- See Note [Ignore unary constraint tuples]</span>
<a name="line-1366"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>check_expected_kind</span> <span class='hs-varid'>tau_ty</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1367"></a>      <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>otherwise</span>
<a name="line-1368"></a>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cTupleTyCon</span> <span class='hs-varid'>arity</span>
<a name="line-1369"></a>            <span class='hs-varid'>checkCTupSize</span> <span class='hs-varid'>arity</span>
<a name="line-1370"></a>            <span class='hs-varid'>check_expected_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1371"></a>    <span class='hs-conid'>BoxedTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1372"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>Boxed</span> <span class='hs-varid'>arity</span>
<a name="line-1373"></a>      <span class='hs-varid'>checkTupSize</span> <span class='hs-varid'>arity</span>
<a name="line-1374"></a>      <span class='hs-varid'>checkWiredInTyCon</span> <span class='hs-varid'>tycon</span>
<a name="line-1375"></a>      <span class='hs-varid'>check_expected_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>tau_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-1376"></a>    <span class='hs-conid'>UnboxedTuple</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1377"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>tycon</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tupleTyCon</span> <span class='hs-conid'>Unboxed</span> <span class='hs-varid'>arity</span>
<a name="line-1378"></a>          <span class='hs-varid'>tau_reps</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>kindRep</span> <span class='hs-varid'>tau_kinds</span>
<a name="line-1379"></a>          <span class='hs-comment'>-- See also Note [Unboxed tuple RuntimeRep vars] in GHC.Core.TyCon</span>
<a name="line-1380"></a>          <span class='hs-varid'>arg_tys</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tau_reps</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tau_tys</span>
<a name="line-1381"></a>          <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unboxedTupleKind</span> <span class='hs-varid'>tau_reps</span>
<a name="line-1382"></a>      <span class='hs-varid'>checkTupSize</span> <span class='hs-varid'>arity</span>
<a name="line-1383"></a>      <span class='hs-varid'>check_expected_kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>arg_tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_kind</span>
<a name="line-1384"></a>  <span class='hs-keyword'>where</span>
<a name="line-1385"></a>    <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>tau_tys</span>
<a name="line-1386"></a>    <span class='hs-varid'>check_expected_kind</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-keyglyph'>=</span>
<a name="line-1387"></a>      <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>rn_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1388"></a>
<a name="line-1389"></a><span class='hs-comment'>{-
<a name="line-1390"></a>Note [Ignore unary constraint tuples]
<a name="line-1391"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1392"></a>GHC provides unary tuples and unboxed tuples (see Note [One-tuples] in
<a name="line-1393"></a>GHC.Builtin.Types) but does *not* provide unary constraint tuples. Why? First,
<a name="line-1394"></a>recall the definition of a unary tuple data type:
<a name="line-1395"></a>
<a name="line-1396"></a>  data Solo a = Solo a
<a name="line-1397"></a>
<a name="line-1398"></a>Note that `Solo a` is *not* the same thing as `a`, since Solo is boxed and
<a name="line-1399"></a>lazy. Therefore, the presence of `Solo` matters semantically. On the other
<a name="line-1400"></a>hand, suppose we had a unary constraint tuple:
<a name="line-1401"></a>
<a name="line-1402"></a>  class a =&gt; Solo% a
<a name="line-1403"></a>
<a name="line-1404"></a>This compiles down a newtype (i.e., a cast) in Core, so `Solo% a` is
<a name="line-1405"></a>semantically equivalent to `a`. Therefore, a 1-tuple constraint would have
<a name="line-1406"></a>no user-visible impact, nor would it allow you to express anything that
<a name="line-1407"></a>you couldn't otherwise.
<a name="line-1408"></a>
<a name="line-1409"></a>We could simply add Solo% for consistency with tuples (Solo) and unboxed
<a name="line-1410"></a>tuples (Solo#), but that would require even more magic to wire in another
<a name="line-1411"></a>magical class, so we opt not to do so. We must be careful, however, since
<a name="line-1412"></a>one can try to sneak in uses of unary constraint tuples through Template
<a name="line-1413"></a>Haskell, such as in this program (from #17511):
<a name="line-1414"></a>
<a name="line-1415"></a>  f :: $(pure (ForallT [] [TupleT 1 `AppT` (ConT ''Show `AppT` ConT ''Int)]
<a name="line-1416"></a>                       (ConT ''String)))
<a name="line-1417"></a>  -- f :: Solo% (Show Int) =&gt; String
<a name="line-1418"></a>  f = "abc"
<a name="line-1419"></a>
<a name="line-1420"></a>This use of `TupleT 1` will produce an HsBoxedOrConstraintTuple of arity 1,
<a name="line-1421"></a>and since it is used in a Constraint position, GHC will attempt to treat
<a name="line-1422"></a>it as thought it were a constraint tuple, which can potentially lead to
<a name="line-1423"></a>trouble if one attempts to look up the name of a constraint tuple of arity
<a name="line-1424"></a>1 (as it won't exist). To avoid this trouble, we simply take any unary
<a name="line-1425"></a>constraint tuples discovered when typechecking and drop themi.e., treat
<a name="line-1426"></a>"Solo% a" as though the user had written "a". This is always safe to do
<a name="line-1427"></a>since the two constraints should be semantically equivalent.
<a name="line-1428"></a>-}</span>
<a name="line-1429"></a>
<a name="line-1430"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1431"></a>*                                                                      *
<a name="line-1432"></a>                Type applications
<a name="line-1433"></a>*                                                                      *
<a name="line-1434"></a>********************************************************************* -}</span>
<a name="line-1435"></a>
<a name="line-1436"></a><a name="splitHsAppTys"></a><span class='hs-definition'>splitHsAppTys</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1437"></a><span class='hs-definition'>splitHsAppTys</span> <span class='hs-varid'>hs_ty</span>
<a name="line-1438"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_app</span> <span class='hs-varid'>hs_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>noLocA</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-1439"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1440"></a>  <span class='hs-keyword'>where</span>
<a name="line-1441"></a>    <span class='hs-varid'>is_app</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1442"></a>    <span class='hs-varid'>is_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppKindTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1443"></a>    <span class='hs-varid'>is_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1444"></a>    <span class='hs-varid'>is_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>op</span> <span class='hs-varop'>`hasKey`</span> <span class='hs-varid'>funTyConKey</span><span class='hs-layout'>)</span>
<a name="line-1445"></a>      <span class='hs-comment'>-- I'm not sure why this funTyConKey test is necessary</span>
<a name="line-1446"></a>      <span class='hs-comment'>-- Can it even happen?  Perhaps for   t1 `(-&gt;)` t2</span>
<a name="line-1447"></a>      <span class='hs-comment'>-- but then maybe it's ok to treat that like a normal</span>
<a name="line-1448"></a>      <span class='hs-comment'>-- application rather than using the special rule for HsFunTy</span>
<a name="line-1449"></a>    <span class='hs-varid'>is_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1450"></a>    <span class='hs-varid'>is_app</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>is_app</span> <span class='hs-varid'>ty</span>
<a name="line-1451"></a>    <span class='hs-varid'>is_app</span> <span class='hs-keyword'>_</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1452"></a>
<a name="line-1453"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1454"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1455"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>,</span>
<a name="line-1456"></a>           <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsArg</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- AZ temp</span>
<a name="line-1457"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span>  <span class='hs-layout'>(</span><span class='hs-conid'>HsAppTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>      <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValArg</span> <span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-1458"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span>  <span class='hs-layout'>(</span><span class='hs-conid'>HsAppKindTy</span> <span class='hs-varid'>l</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTypeArg</span> <span class='hs-varid'>l</span> <span class='hs-varid'>k</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-1459"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>sp</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsParTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>f</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>        <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArgPar</span> <span class='hs-layout'>(</span><span class='hs-varid'>locA</span> <span class='hs-varid'>sp</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-1460"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span>  <span class='hs-layout'>(</span><span class='hs-conid'>HsOpTy</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>l</span> <span class='hs-varid'>op</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-varid'>sp</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-varid'>r</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-1461"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span> <span class='hs-conid'>L</span> <span class='hs-layout'>(</span><span class='hs-varid'>na2la</span> <span class='hs-varid'>sp</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-varid'>noAnn</span> <span class='hs-conid'>NotPromoted</span> <span class='hs-varid'>op</span><span class='hs-layout'>)</span>
<a name="line-1462"></a>        <span class='hs-layout'>,</span> <span class='hs-conid'>HsValArg</span> <span class='hs-varid'>l</span> <span class='hs-conop'>:</span> <span class='hs-conid'>HsValArg</span> <span class='hs-varid'>r</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span> <span class='hs-layout'>)</span>
<a name="line-1463"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>f</span> <span class='hs-keyword'>as</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span>
<a name="line-1464"></a>
<a name="line-1465"></a><a name="tcInferTyAppHead"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1466"></a><span class='hs-definition'>tcInferTyAppHead</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-1467"></a><span class='hs-comment'>-- Version of tc_infer_lhs_type specialised for the head of an</span>
<a name="line-1468"></a><span class='hs-comment'>-- application. In particular, for a HsTyVar (which includes type</span>
<a name="line-1469"></a><span class='hs-comment'>-- constructors, it does not zoom off into tcInferTyApps and family</span>
<a name="line-1470"></a><span class='hs-comment'>-- saturation</span>
<a name="line-1471"></a><span class='hs-definition'>tcInferTyAppHead</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1472"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tv</span>
<a name="line-1473"></a><span class='hs-definition'>tcInferTyAppHead</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-1474"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_infer_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span>
<a name="line-1475"></a>
<a name="line-1476"></a><a name="tcInferTyApps"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1477"></a><span class='hs-comment'>-- | Apply a type of a given kind to a list of arguments. This instantiates</span>
<a name="line-1478"></a><span class='hs-comment'>-- invisible parameters as necessary. Always consumes all the arguments,</span>
<a name="line-1479"></a><span class='hs-comment'>-- using matchExpectedFunKind as necessary.</span>
<a name="line-1480"></a><span class='hs-comment'>-- This takes an optional @VarEnv Kind@ which maps kind variables to kinds.-</span>
<a name="line-1481"></a><span class='hs-comment'>-- These kinds should be used to instantiate invisible kind variables;</span>
<a name="line-1482"></a><span class='hs-comment'>-- they come from an enclosing class for an associated type/data family.</span>
<a name="line-1483"></a><span class='hs-comment'>--</span>
<a name="line-1484"></a><span class='hs-comment'>-- tcInferTyApps also arranges to saturate any trailing invisible arguments</span>
<a name="line-1485"></a><span class='hs-comment'>--   of a type-family application, which is usually the right thing to do</span>
<a name="line-1486"></a><span class='hs-comment'>-- tcInferTyApps_nosat does not do this saturation; it is used only</span>
<a name="line-1487"></a><span class='hs-comment'>--   by ":kind" in GHCi</span>
<a name="line-1488"></a><span class='hs-definition'>tcInferTyApps</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcInferTyApps_nosat</span>
<a name="line-1489"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-1490"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>        <span class='hs-comment'>-- ^ Function (for printing only)</span>
<a name="line-1491"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>               <span class='hs-comment'>-- ^ Function</span>
<a name="line-1492"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- ^ Args</span>
<a name="line-1493"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- ^ (f args, args, result kind)</span>
<a name="line-1494"></a><span class='hs-definition'>tcInferTyApps</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>hs_args</span>
<a name="line-1495"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>f_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInferTyApps_nosat</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>hs_args</span>
<a name="line-1496"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>saturateFamApp</span> <span class='hs-varid'>f_args</span> <span class='hs-varid'>res_k</span> <span class='hs-layout'>}</span>
<a name="line-1497"></a>
<a name="line-1498"></a><a name="tcInferTyApps_nosat"></a><span class='hs-definition'>tcInferTyApps_nosat</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>orig_hs_args</span>
<a name="line-1499"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_hs_args</span><span class='hs-layout'>)</span>
<a name="line-1500"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>f_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>go_init</span> <span class='hs-num'>1</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>orig_hs_args</span>
<a name="line-1501"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps }"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>f_args</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span>
<a name="line-1502"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>f_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1503"></a>  <span class='hs-keyword'>where</span>
<a name="line-1504"></a>
<a name="line-1505"></a>    <span class='hs-comment'>-- go_init just initialises the auxiliary</span>
<a name="line-1506"></a>    <span class='hs-comment'>-- arguments of the 'go' loop</span>
<a name="line-1507"></a>    <span class='hs-varid'>go_init</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>all_args</span>
<a name="line-1508"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>empty_subst</span> <span class='hs-varid'>fun_ki</span> <span class='hs-varid'>all_args</span>
<a name="line-1509"></a>      <span class='hs-keyword'>where</span>
<a name="line-1510"></a>        <span class='hs-varid'>fun_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>fun</span>
<a name="line-1511"></a>           <span class='hs-comment'>-- We do (tcTypeKind fun) here, even though the caller</span>
<a name="line-1512"></a>           <span class='hs-comment'>-- knows the function kind, to absolutely guarantee</span>
<a name="line-1513"></a>           <span class='hs-comment'>-- INVARIANT for 'go'</span>
<a name="line-1514"></a>           <span class='hs-comment'>-- Note that in a typical application (F t1 t2 t3),</span>
<a name="line-1515"></a>           <span class='hs-comment'>-- the 'fun' is just a TyCon, so tcTypeKind is fast</span>
<a name="line-1516"></a>
<a name="line-1517"></a>        <span class='hs-varid'>empty_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mkInScopeSet</span> <span class='hs-varop'>$</span>
<a name="line-1518"></a>                      <span class='hs-varid'>tyCoVarsOfType</span> <span class='hs-varid'>fun_ki</span>
<a name="line-1519"></a>
<a name="line-1520"></a>    <span class='hs-varid'>go</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>             <span class='hs-comment'>-- The # of the next argument</span>
<a name="line-1521"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>          <span class='hs-comment'>-- Function applied to some args</span>
<a name="line-1522"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TCvSubst</span>        <span class='hs-comment'>-- Applies to function kind</span>
<a name="line-1523"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>          <span class='hs-comment'>-- Function kind</span>
<a name="line-1524"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Un-type-checked args</span>
<a name="line-1525"></a>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Result type and its kind</span>
<a name="line-1526"></a>    <span class='hs-comment'>-- INVARIANT: in any call (go n fun subst fun_ki args)</span>
<a name="line-1527"></a>    <span class='hs-comment'>--               tcTypeKind fun  =  subst(fun_ki)</span>
<a name="line-1528"></a>    <span class='hs-comment'>-- So the 'subst' and 'fun_ki' arguments are simply</span>
<a name="line-1529"></a>    <span class='hs-comment'>-- there to avoid repeatedly calling tcTypeKind.</span>
<a name="line-1530"></a>    <span class='hs-comment'>--</span>
<a name="line-1531"></a>    <span class='hs-comment'>-- Reason for INVARIANT: to support the Purely Kinded Type Invariant</span>
<a name="line-1532"></a>    <span class='hs-comment'>-- it's important that if fun_ki has a forall, then so does</span>
<a name="line-1533"></a>    <span class='hs-comment'>-- (tcTypeKind fun), because the next thing we are going to do</span>
<a name="line-1534"></a>    <span class='hs-comment'>-- is apply 'fun' to an argument type.</span>
<a name="line-1535"></a>
<a name="line-1536"></a>    <span class='hs-comment'>-- Dispatch on all_args first, for performance reasons</span>
<a name="line-1537"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun_ki</span> <span class='hs-varid'>all_args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>all_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>tcSplitPiTy_maybe</span> <span class='hs-varid'>fun_ki</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-1538"></a>
<a name="line-1539"></a>      <span class='hs-comment'>---------------- No user-written args left. We're done!</span>
<a name="line-1540"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun_ki</span><span class='hs-layout'>)</span>
<a name="line-1541"></a>
<a name="line-1542"></a>      <span class='hs-comment'>---------------- HsArgPar: We don't care about parens here</span>
<a name="line-1543"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsArgPar</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun_ki</span> <span class='hs-varid'>args</span>
<a name="line-1544"></a>
<a name="line-1545"></a>      <span class='hs-comment'>---------------- HsTypeArg: a kind application (fun @ki)</span>
<a name="line-1546"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsTypeArg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_ki_arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hs_args</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ki_binder</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_ki</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1547"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>ki_binder</span> <span class='hs-keyword'>of</span>
<a name="line-1548"></a>
<a name="line-1549"></a>        <span class='hs-comment'>-- FunTy with PredTy on LHS, or ForAllTy with Inferred</span>
<a name="line-1550"></a>        <span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Inferred</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instantiate</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>inner_ki</span>
<a name="line-1551"></a>        <span class='hs-conid'>Anon</span> <span class='hs-conid'>InvisArg</span> <span class='hs-keyword'>_</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instantiate</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>inner_ki</span>
<a name="line-1552"></a>
<a name="line-1553"></a>        <span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>  <span class='hs-comment'>-- Visible kind application</span>
<a name="line-1554"></a>          <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps (vis kind app)"</span>
<a name="line-1555"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ki_arg</span>
<a name="line-1556"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span>
<a name="line-1557"></a>                             <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1558"></a>
<a name="line-1559"></a>             <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1560"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>arg_mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHoleMode</span> <span class='hs-conid'>KindLevel</span> <span class='hs-conid'>HM_VTA</span>
<a name="line-1561"></a>                   <span class='hs-comment'>-- HM_VKA: see Note [Wildcards in visible kind application]</span>
<a name="line-1562"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>ki_arg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funAppCtxt</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>hs_ki_arg</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1563"></a>                         <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>arg_mode</span> <span class='hs-varid'>hs_ki_arg</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1564"></a>
<a name="line-1565"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps (vis kind app)"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-1566"></a>             <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkAppTyM</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>ki_arg</span>
<a name="line-1567"></a>             <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>hs_args</span> <span class='hs-layout'>}</span>
<a name="line-1568"></a>
<a name="line-1569"></a>        <span class='hs-comment'>-- Attempted visible kind application (fun @ki), but fun_ki is</span>
<a name="line-1570"></a>        <span class='hs-comment'>--   forall k -&gt; blah   or   k1 -&gt; k2</span>
<a name="line-1571"></a>        <span class='hs-comment'>-- So we need a normal application.  Error.</span>
<a name="line-1572"></a>        <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ty_app_err</span> <span class='hs-varid'>hs_ki_arg</span> <span class='hs-varop'>$</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun_ki</span>
<a name="line-1573"></a>
<a name="line-1574"></a>      <span class='hs-comment'>-- No binder; try applying the substitution, or fail if that's not possible</span>
<a name="line-1575"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsTypeArg</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ki_arg</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>try_again_after_substing_or</span> <span class='hs-varop'>$</span>
<a name="line-1576"></a>                                           <span class='hs-varid'>ty_app_err</span> <span class='hs-varid'>ki_arg</span> <span class='hs-varid'>substed_fun_ki</span>
<a name="line-1577"></a>
<a name="line-1578"></a>      <span class='hs-comment'>---------------- HsValArg: a normal argument (fun ty)</span>
<a name="line-1579"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsValArg</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ki_binder</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_ki</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1580"></a>        <span class='hs-comment'>-- next binder is invisible; need to instantiate it</span>
<a name="line-1581"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInvisibleBinder</span> <span class='hs-varid'>ki_binder</span>   <span class='hs-comment'>-- FunTy with InvisArg on LHS;</span>
<a name="line-1582"></a>                                        <span class='hs-comment'>-- or ForAllTy with Inferred or Specified</span>
<a name="line-1583"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>instantiate</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>inner_ki</span>
<a name="line-1584"></a>
<a name="line-1585"></a>        <span class='hs-comment'>-- "normal" case</span>
<a name="line-1586"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1587"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps (vis normal app)"</span>
<a name="line-1588"></a>                          <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1589"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span>
<a name="line-1590"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>)</span>
<a name="line-1591"></a>                                <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1592"></a>                <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1593"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>funAppCtxt</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1594"></a>                          <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1595"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps (vis normal app) 2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span><span class='hs-layout'>)</span>
<a name="line-1596"></a>                <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkAppTyM</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>arg'</span>
<a name="line-1597"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-varop'>+</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>args</span> <span class='hs-layout'>}</span>
<a name="line-1598"></a>
<a name="line-1599"></a>          <span class='hs-comment'>-- no binder; try applying the substitution, or infer another arrow in fun kind</span>
<a name="line-1600"></a>      <span class='hs-layout'>(</span><span class='hs-conid'>HsValArg</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-1601"></a>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>try_again_after_substing_or</span> <span class='hs-varop'>$</span>
<a name="line-1602"></a>           <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arrows_needed</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_initial_val_args</span> <span class='hs-varid'>all_args</span>
<a name="line-1603"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>co</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matchExpectedFunKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>arrows_needed</span> <span class='hs-varid'>substed_fun_ki</span>
<a name="line-1604"></a>
<a name="line-1605"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>fun'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>fun</span> <span class='hs-varop'>`mkTcCastTy`</span> <span class='hs-varid'>co</span><span class='hs-layout'>)</span>
<a name="line-1606"></a>                     <span class='hs-comment'>-- This zonk is essential, to expose the fruits</span>
<a name="line-1607"></a>                     <span class='hs-comment'>-- of matchExpectedFunKind to the 'go' loop</span>
<a name="line-1608"></a>
<a name="line-1609"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps (no binder)"</span> <span class='hs-varop'>$</span>
<a name="line-1610"></a>                   <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_ki</span>
<a name="line-1611"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arrows_needed</span>
<a name="line-1612"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co</span>
<a name="line-1613"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun'</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>fun'</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-1614"></a>              <span class='hs-layout'>;</span> <span class='hs-varid'>go_init</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun'</span> <span class='hs-varid'>all_args</span> <span class='hs-layout'>}</span>
<a name="line-1615"></a>                <span class='hs-comment'>-- Use go_init to establish go's INVARIANT</span>
<a name="line-1616"></a>      <span class='hs-keyword'>where</span>
<a name="line-1617"></a>        <span class='hs-varid'>instantiate</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>inner_ki</span>
<a name="line-1618"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcInferTyApps (need to instantiate)"</span>
<a name="line-1619"></a>                         <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ki_binder</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>subst</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1620"></a>               <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstInvisibleTyBinder</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki_binder</span>
<a name="line-1621"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg'</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>inner_ki</span> <span class='hs-varid'>all_args</span> <span class='hs-layout'>}</span>
<a name="line-1622"></a>                 <span class='hs-comment'>-- Because tcInvisibleTyBinder instantiate ki_binder,</span>
<a name="line-1623"></a>                 <span class='hs-comment'>-- the kind of arg' will have the same shape as the kind</span>
<a name="line-1624"></a>                 <span class='hs-comment'>-- of ki_binder.  So we don't need mkAppTyM here.</span>
<a name="line-1625"></a>
<a name="line-1626"></a>        <span class='hs-varid'>try_again_after_substing_or</span> <span class='hs-varid'>fallthrough</span>
<a name="line-1627"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-1628"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>n</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>zapped_subst</span> <span class='hs-varid'>substed_fun_ki</span> <span class='hs-varid'>all_args</span>
<a name="line-1629"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1630"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fallthrough</span>
<a name="line-1631"></a>
<a name="line-1632"></a>        <span class='hs-varid'>zapped_subst</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zapTCvSubst</span> <span class='hs-varid'>subst</span>
<a name="line-1633"></a>        <span class='hs-varid'>substed_fun_ki</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun_ki</span>
<a name="line-1634"></a>        <span class='hs-varid'>hs_ty</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-varid'>orig_hs_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>orig_hs_args</span><span class='hs-layout'>)</span>
<a name="line-1635"></a>
<a name="line-1636"></a>    <span class='hs-varid'>n_initial_val_args</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>HsArg</span> <span class='hs-varid'>tm</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Arity</span>
<a name="line-1637"></a>    <span class='hs-comment'>-- Count how many leading HsValArgs we have</span>
<a name="line-1638"></a>    <span class='hs-varid'>n_initial_val_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValArg</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1</span> <span class='hs-varop'>+</span> <span class='hs-varid'>n_initial_val_args</span> <span class='hs-varid'>args</span>
<a name="line-1639"></a>    <span class='hs-varid'>n_initial_val_args</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArgPar</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_initial_val_args</span> <span class='hs-varid'>args</span>
<a name="line-1640"></a>    <span class='hs-varid'>n_initial_val_args</span> <span class='hs-keyword'>_</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-1641"></a>
<a name="line-1642"></a>    <span class='hs-varid'>ty_app_err</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>ty</span>
<a name="line-1643"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-varop'>$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Cannot apply function of kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-1644"></a>                <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"to visible kind argument"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1645"></a>
<a name="line-1646"></a>
<a name="line-1647"></a><a name="mkAppTyM"></a><span class='hs-definition'>mkAppTyM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TCvSubst</span>
<a name="line-1648"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyCoBinder</span>    <span class='hs-comment'>-- fun, plus its top-level binder</span>
<a name="line-1649"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>                  <span class='hs-comment'>-- arg</span>
<a name="line-1650"></a>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TCvSubst</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Extended subst, plus (fun arg)</span>
<a name="line-1651"></a><span class='hs-comment'>-- Precondition: the application (fun arg) is well-kinded after zonking</span>
<a name="line-1652"></a><span class='hs-comment'>--               That is, the application makes sense</span>
<a name="line-1653"></a><span class='hs-comment'>--</span>
<a name="line-1654"></a><span class='hs-comment'>-- Precondition: for (mkAppTyM subst fun bndr arg)</span>
<a name="line-1655"></a><span class='hs-comment'>--       tcTypeKind fun  =  Pi bndr. body</span>
<a name="line-1656"></a><span class='hs-comment'>--  That is, fun always has a ForAllTy or FunTy at the top</span>
<a name="line-1657"></a><span class='hs-comment'>--           and 'bndr' is fun's pi-binder</span>
<a name="line-1658"></a><span class='hs-comment'>--</span>
<a name="line-1659"></a><span class='hs-comment'>-- Postcondition: if fun and arg satisfy (PKTI), the purely-kinded type</span>
<a name="line-1660"></a><span class='hs-comment'>--                invariant, then so does the result type (fun arg)</span>
<a name="line-1661"></a><span class='hs-comment'>--</span>
<a name="line-1662"></a><span class='hs-comment'>-- We do not require that</span>
<a name="line-1663"></a><span class='hs-comment'>--    tcTypeKind arg = tyVarKind (binderVar bndr)</span>
<a name="line-1664"></a><span class='hs-comment'>-- This must be true after zonking (precondition 1), but it's not</span>
<a name="line-1665"></a><span class='hs-comment'>-- required for the (PKTI).</span>
<a name="line-1666"></a><span class='hs-definition'>mkAppTyM</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>ki_binder</span> <span class='hs-varid'>arg</span>
<a name="line-1667"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-comment'>-- See Note [mkAppTyM]: Nasty case 2</span>
<a name="line-1668"></a>    <span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fun</span>
<a name="line-1669"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isTypeSynonymTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-1670"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>args</span> <span class='hs-varop'>`lengthIs`</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-1671"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isTrickyTvBinder</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-comment'>-- We could cache this in the synonym</span>
<a name="line-1672"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg'</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span>  <span class='hs-varid'>arg</span>
<a name="line-1673"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTypes</span> <span class='hs-varid'>args</span>
<a name="line-1674"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ki_binder</span> <span class='hs-keyword'>of</span>
<a name="line-1675"></a>                        <span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>subst</span>
<a name="line-1676"></a>                        <span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>extendTvSubstAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg'</span>
<a name="line-1677"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>args'</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>arg'</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1678"></a>
<a name="line-1679"></a>
<a name="line-1680"></a><span class='hs-definition'>mkAppTyM</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span>
<a name="line-1681"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst</span><span class='hs-layout'>,</span> <span class='hs-varid'>mk_app_ty</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-1682"></a>
<a name="line-1683"></a><span class='hs-definition'>mkAppTyM</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg</span>
<a name="line-1684"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>arg'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isTrickyTvBinder</span> <span class='hs-varid'>tv</span>
<a name="line-1685"></a>                 <span class='hs-keyword'>then</span> <span class='hs-comment'>-- See Note [mkAppTyM]: Nasty case 1</span>
<a name="line-1686"></a>                      <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>arg</span>
<a name="line-1687"></a>                 <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span>     <span class='hs-varid'>arg</span>
<a name="line-1688"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>extendTvSubstAndInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg'</span>
<a name="line-1689"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>mk_app_ty</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg'</span> <span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1690"></a>
<a name="line-1691"></a><a name="mk_app_ty"></a><span class='hs-definition'>mk_app_ty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>
<a name="line-1692"></a><span class='hs-comment'>-- This function just adds an ASSERT for mkAppTyM's precondition</span>
<a name="line-1693"></a><span class='hs-definition'>mk_app_ty</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span>
<a name="line-1694"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT2</span><span class='hs-layout'>(</span> <span class='hs-varid'>isPiTy</span> <span class='hs-varid'>fun_kind</span>
<a name="line-1695"></a>           <span class='hs-layout'>,</span>  <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span> <span class='hs-layout'>)</span>
<a name="line-1696"></a>    <span class='hs-varid'>mkAppTy</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span>
<a name="line-1697"></a>  <span class='hs-keyword'>where</span>
<a name="line-1698"></a>    <span class='hs-varid'>fun_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTypeKind</span> <span class='hs-varid'>fun</span>
<a name="line-1699"></a>
<a name="line-1700"></a><a name="isTrickyTvBinder"></a><span class='hs-definition'>isTrickyTvBinder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-1701"></a><span class='hs-comment'>-- NB: isTrickyTvBinder is just an optimisation</span>
<a name="line-1702"></a><span class='hs-comment'>-- It would be absolutely sound to return True always</span>
<a name="line-1703"></a><span class='hs-definition'>isTrickyTvBinder</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isPiTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1704"></a>
<a name="line-1705"></a><span class='hs-comment'>{- Note [The Purely Kinded Type Invariant (PKTI)]
<a name="line-1706"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1707"></a>During type inference, we maintain this invariant
<a name="line-1708"></a>
<a name="line-1709"></a> (PKTI) It is legal to call 'tcTypeKind' on any Type ty,
<a name="line-1710"></a>        on any sub-term of ty, /without/ zonking ty
<a name="line-1711"></a>
<a name="line-1712"></a>        Moreover, any such returned kind
<a name="line-1713"></a>        will itself satisfy (PKTI)
<a name="line-1714"></a>
<a name="line-1715"></a>By "legal to call tcTypeKind" we mean "tcTypeKind will not crash".
<a name="line-1716"></a>The way in which tcTypeKind can crash is in applications
<a name="line-1717"></a>    (a t1 t2 .. tn)
<a name="line-1718"></a>if 'a' is a type variable whose kind doesn't have enough arrows
<a name="line-1719"></a>or foralls.  (The crash is in piResultTys.)
<a name="line-1720"></a>
<a name="line-1721"></a>The loop in tcInferTyApps has to be very careful to maintain the (PKTI).
<a name="line-1722"></a>For example, suppose
<a name="line-1723"></a>    kappa is a unification variable
<a name="line-1724"></a>    We have already unified kappa := Type
<a name="line-1725"></a>      yielding    co :: Refl (Type -&gt; Type)
<a name="line-1726"></a>    a :: kappa
<a name="line-1727"></a>then consider the type
<a name="line-1728"></a>    (a Int)
<a name="line-1729"></a>If we call tcTypeKind on that, we'll crash, because the (un-zonked)
<a name="line-1730"></a>kind of 'a' is just kappa, not an arrow kind.  So we must zonk first.
<a name="line-1731"></a>
<a name="line-1732"></a>So the type inference engine is very careful when building applications.
<a name="line-1733"></a>This happens in tcInferTyApps. Suppose we are kind-checking the type (a Int),
<a name="line-1734"></a>where (a :: kappa).  Then in tcInferApps we'll run out of binders on
<a name="line-1735"></a>a's kind, so we'll call matchExpectedFunKind, and unify
<a name="line-1736"></a>   kappa := kappa1 -&gt; kappa2,  with evidence co :: kappa ~ (kappa1 ~ kappa2)
<a name="line-1737"></a>At this point we must zonk the function type to expose the arrrow, so
<a name="line-1738"></a>that (a Int) will satisfy (PKTI).
<a name="line-1739"></a>
<a name="line-1740"></a>The absence of this caused #14174 and #14520.
<a name="line-1741"></a>
<a name="line-1742"></a>The calls to mkAppTyM is the other place we are very careful; see Note [mkAppTyM].
<a name="line-1743"></a>
<a name="line-1744"></a>Wrinkle around FunTy:
<a name="line-1745"></a>Note that the PKTI does *not* guarantee anything about the shape of FunTys.
<a name="line-1746"></a>Specifically, when we have (FunTy vis mult arg res), it should be the case
<a name="line-1747"></a>that arg :: TYPE rr1 and res :: TYPE rr2, for some rr1 and rr2. However, we
<a name="line-1748"></a>might not have this. Example: if the user writes (a -&gt; b), then we might
<a name="line-1749"></a>invent a :: kappa1 and b :: kappa2. We soon will check whether kappa1 ~ TYPE rho1
<a name="line-1750"></a>(for some rho1), and that will lead to kappa1 := TYPE rho1 (ditto for kappa2).
<a name="line-1751"></a>However, when we build the FunTy, we might not have zonked `a`, and so the
<a name="line-1752"></a>FunTy will be built without being able to purely extract the RuntimeReps.
<a name="line-1753"></a>
<a name="line-1754"></a>Because the PKTI does not guarantee that the RuntimeReps are available in a FunTy,
<a name="line-1755"></a>we must be aware of this when splitting: splitTyConApp and splitAppTy will *not*
<a name="line-1756"></a>split a FunTy if the RuntimeReps are not available. See also Note [Decomposing FunTy]
<a name="line-1757"></a>in GHC.Tc.Solver.Canonical.
<a name="line-1758"></a>
<a name="line-1759"></a>Note [mkAppTyM]
<a name="line-1760"></a>~~~~~~~~~~~~~~~
<a name="line-1761"></a>mkAppTyM is trying to guarantee the Purely Kinded Type Invariant
<a name="line-1762"></a>(PKTI) for its result type (fun arg).  There are two ways it can go wrong:
<a name="line-1763"></a>
<a name="line-1764"></a>* Nasty case 1: forall types (polykinds/T14174a)
<a name="line-1765"></a>    T :: forall (p :: *-&gt;*). p Int -&gt; p Bool
<a name="line-1766"></a>  Now kind-check (T x), where x::kappa.
<a name="line-1767"></a>  Well, T and x both satisfy the PKTI, but
<a name="line-1768"></a>     T x :: x Int -&gt; x Bool
<a name="line-1769"></a>  and (x Int) does /not/ satisfy the PKTI.
<a name="line-1770"></a>
<a name="line-1771"></a>* Nasty case 2: type synonyms
<a name="line-1772"></a>    type S f a = f a
<a name="line-1773"></a>  Even though (S ff aa) would satisfy the (PKTI) if S was a data type
<a name="line-1774"></a>  (i.e. nasty case 1 is dealt with), it might still not satisfy (PKTI)
<a name="line-1775"></a>  if S is a type synonym, because the /expansion/ of (S ff aa) is
<a name="line-1776"></a>  (ff aa), and /that/ does not satisfy (PKTI).  E.g. perhaps
<a name="line-1777"></a>  (ff :: kappa), where 'kappa' has already been unified with (*-&gt;*).
<a name="line-1778"></a>
<a name="line-1779"></a>  We check for nasty case 2 on the final argument of a type synonym.
<a name="line-1780"></a>
<a name="line-1781"></a>Notice that in both cases the trickiness only happens if the
<a name="line-1782"></a>bound variable has a pi-type.  Hence isTrickyTvBinder.
<a name="line-1783"></a>-}</span>
<a name="line-1784"></a>
<a name="line-1785"></a>
<a name="line-1786"></a><a name="saturateFamApp"></a><span class='hs-definition'>saturateFamApp</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-1787"></a><span class='hs-comment'>-- Precondition for (saturateFamApp ty kind):</span>
<a name="line-1788"></a><span class='hs-comment'>--     tcTypeKind ty = kind</span>
<a name="line-1789"></a><span class='hs-comment'>--</span>
<a name="line-1790"></a><span class='hs-comment'>-- If 'ty' is an unsaturated family application with trailing</span>
<a name="line-1791"></a><span class='hs-comment'>-- invisible arguments, instantiate them.</span>
<a name="line-1792"></a><span class='hs-comment'>-- See Note [saturateFamApp]</span>
<a name="line-1793"></a>
<a name="line-1794"></a><span class='hs-definition'>saturateFamApp</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>kind</span>
<a name="line-1795"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-1796"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>mustBeSaturated</span> <span class='hs-varid'>tc</span>
<a name="line-1797"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>n_to_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span>
<a name="line-1798"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstInvisibleTyBindersN</span> <span class='hs-varid'>n_to_inst</span> <span class='hs-varid'>kind</span>
<a name="line-1799"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span> <span class='hs-varop'>`mkTcAppTys`</span> <span class='hs-varid'>extra_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1800"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-1801"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-1802"></a>
<a name="line-1803"></a><span class='hs-comment'>{- Note [saturateFamApp]
<a name="line-1804"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1805"></a>Consider
<a name="line-1806"></a>   type family F :: Either j k
<a name="line-1807"></a>   type instance F @Type = Right Maybe
<a name="line-1808"></a>   type instance F @Type = Right Either```
<a name="line-1809"></a>
<a name="line-1810"></a>Then F :: forall {j,k}. Either j k
<a name="line-1811"></a>
<a name="line-1812"></a>The two type instances do a visible kind application that instantiates
<a name="line-1813"></a>'j' but not 'k'.  But we want to end up with instances that look like
<a name="line-1814"></a>  type instance F @Type @(*-&gt;*) = Right @Type @(*-&gt;*) Maybe
<a name="line-1815"></a>
<a name="line-1816"></a>so that F has arity 2.  We must instantiate that trailing invisible
<a name="line-1817"></a>binder. In general, Invisible binders precede Specified and Required,
<a name="line-1818"></a>so this is only going to bite for apparently-nullary families.
<a name="line-1819"></a>
<a name="line-1820"></a>Note that
<a name="line-1821"></a>  type family F2 :: forall k. k -&gt; *
<a name="line-1822"></a>is quite different and really does have arity 0.
<a name="line-1823"></a>
<a name="line-1824"></a>It's not just type instances where we need to saturate those
<a name="line-1825"></a>unsaturated arguments: see #11246.  Hence doing this in tcInferApps.
<a name="line-1826"></a>-}</span>
<a name="line-1827"></a>
<a name="line-1828"></a><a name="appTypeToArg"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTypeArg</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span>
<a name="line-1829"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span>                       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span>
<a name="line-1830"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsValArg</span> <span class='hs-varid'>arg</span>    <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsAppTy</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1831"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsArgPar</span> <span class='hs-keyword'>_</span>      <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-varid'>f</span>                 <span class='hs-varid'>args</span>
<a name="line-1832"></a><span class='hs-definition'>appTypeToArg</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsTypeArg</span> <span class='hs-varid'>l</span> <span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-1833"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>appTypeToArg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHsAppKindTy</span> <span class='hs-varid'>l</span> <span class='hs-varid'>f</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-1834"></a>
<a name="line-1835"></a>
<a name="line-1836"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-1837"></a>*                                                                      *
<a name="line-1838"></a>                checkExpectedKind
<a name="line-1839"></a>*                                                                      *
<a name="line-1840"></a>********************************************************************* -}</span>
<a name="line-1841"></a>
<a name="line-1842"></a><a name="checkExpectedKind"></a><span class='hs-comment'>-- | This instantiates invisible arguments for the type being checked if it must</span>
<a name="line-1843"></a><span class='hs-comment'>-- be saturated and is not yet saturated. It then calls and uses the result</span>
<a name="line-1844"></a><span class='hs-comment'>-- from checkExpectedKindX to build the final type</span>
<a name="line-1845"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HasDebugCallStack</span>
<a name="line-1846"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span>       <span class='hs-comment'>-- ^ type we're checking (for printing)</span>
<a name="line-1847"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>             <span class='hs-comment'>-- ^ type we're checking</span>
<a name="line-1848"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>             <span class='hs-comment'>-- ^ the known kind of that type</span>
<a name="line-1849"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcKind</span>             <span class='hs-comment'>-- ^ the expected kind</span>
<a name="line-1850"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-1851"></a><span class='hs-comment'>-- Just a convenience wrapper to save calls to 'ppr'</span>
<a name="line-1852"></a><span class='hs-definition'>checkExpectedKind</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1853"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span>
<a name="line-1854"></a>
<a name="line-1855"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_args</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInstInvisibleTyBindersN</span> <span class='hs-varid'>n_to_inst</span> <span class='hs-varid'>act_kind</span>
<a name="line-1856"></a>
<a name="line-1857"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>origin</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act_kind'</span>
<a name="line-1858"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1859"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>uo_thing</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span><span class='hs-layout'>)</span>
<a name="line-1860"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>uo_visible</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span> <span class='hs-comment'>-- the hs_ty is visible</span>
<a name="line-1861"></a>
<a name="line-1862"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKindX"</span> <span class='hs-varop'>$</span>
<a name="line-1863"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_ty</span>
<a name="line-1864"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"act_kind':"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind'</span>
<a name="line-1865"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"exp_kind:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span> <span class='hs-keyglyph'>]</span>
<a name="line-1866"></a>
<a name="line-1867"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>res_ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ty</span> <span class='hs-varop'>`mkTcAppTys`</span> <span class='hs-varid'>new_args</span>
<a name="line-1868"></a>
<a name="line-1869"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>act_kind'</span> <span class='hs-varop'>`tcEqType`</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1870"></a>         <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>res_ty</span>  <span class='hs-comment'>-- This is very common</span>
<a name="line-1871"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>uType</span> <span class='hs-conid'>KindLevel</span> <span class='hs-varid'>origin</span> <span class='hs-varid'>act_kind'</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1872"></a>                 <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkExpectedKind"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_kind</span>
<a name="line-1873"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1874"></a>                                                     <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>co_k</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-1875"></a>                <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>res_ty</span> <span class='hs-varop'>`mkTcCastTy`</span> <span class='hs-varid'>co_k</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-1876"></a>    <span class='hs-keyword'>where</span>
<a name="line-1877"></a>      <span class='hs-comment'>-- We need to make sure that both kinds have the same number of implicit</span>
<a name="line-1878"></a>      <span class='hs-comment'>-- foralls out front. If the actual kind has more, instantiate accordingly.</span>
<a name="line-1879"></a>      <span class='hs-comment'>-- Otherwise, just pass the type &amp; kind through: the errors are caught</span>
<a name="line-1880"></a>      <span class='hs-comment'>-- in unifyType.</span>
<a name="line-1881"></a>      <span class='hs-varid'>n_exp_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invisibleTyBndrCount</span> <span class='hs-varid'>exp_kind</span>
<a name="line-1882"></a>      <span class='hs-varid'>n_act_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invisibleTyBndrCount</span> <span class='hs-varid'>act_kind</span>
<a name="line-1883"></a>      <span class='hs-varid'>n_to_inst</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_act_invis_bndrs</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_exp_invis_bndrs</span>
<a name="line-1884"></a>
<a name="line-1885"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1886"></a>
<a name="line-1887"></a><a name="tcHsContext"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-1888"></a><span class='hs-definition'>tcHsContext</span> <span class='hs-varid'>cxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_hs_context</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>cxt</span>
<a name="line-1889"></a>
<a name="line-1890"></a><a name="tcLHsPredType"></a><span class='hs-definition'>tcLHsPredType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-1891"></a><span class='hs-definition'>tcLHsPredType</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>typeLevelMode</span> <span class='hs-varid'>pred</span>
<a name="line-1892"></a>
<a name="line-1893"></a><a name="tc_hs_context"></a><span class='hs-definition'>tc_hs_context</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>PredType</span><span class='hs-keyglyph'>]</span>
<a name="line-1894"></a><span class='hs-definition'>tc_hs_context</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-1895"></a><span class='hs-definition'>tc_hs_context</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-1896"></a>
<a name="line-1897"></a><a name="tc_lhs_pred"></a><span class='hs-definition'>tc_lhs_pred</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>PredType</span>
<a name="line-1898"></a><span class='hs-definition'>tc_lhs_pred</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>constraintKind</span>
<a name="line-1899"></a>
<a name="line-1900"></a><a name="tcTyVar"></a><span class='hs-comment'>---------------------------</span>
<a name="line-1901"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-1902"></a><span class='hs-comment'>-- See Note [Type checking recursive type and class declarations]</span>
<a name="line-1903"></a><span class='hs-comment'>-- in GHC.Tc.TyCl</span>
<a name="line-1904"></a><span class='hs-comment'>-- This does not instantiate. See Note [Do not always instantiate eagerly in types]</span>
<a name="line-1905"></a><span class='hs-definition'>tcTyVar</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>name</span>         <span class='hs-comment'>-- Could be a tyvar, a tycon, or a datacon</span>
<a name="line-1906"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"lk1"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-1907"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookup</span> <span class='hs-varid'>name</span>
<a name="line-1908"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>thing</span> <span class='hs-keyword'>of</span>
<a name="line-1909"></a>           <span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-1910"></a>
<a name="line-1911"></a>           <span class='hs-comment'>-- See Note [Recursion through the kinds]</span>
<a name="line-1912"></a>           <span class='hs-conid'>ATcTyCon</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1913"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc_tc</span>
<a name="line-1914"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>tc_tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc_tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1915"></a>
<a name="line-1916"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-1917"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span>
<a name="line-1918"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConTy</span> <span class='hs-varid'>tc</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1919"></a>
<a name="line-1920"></a>           <span class='hs-conid'>AGlobal</span> <span class='hs-layout'>(</span><span class='hs-conid'>AConLike</span> <span class='hs-layout'>(</span><span class='hs-conid'>RealDataCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1921"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DataKinds</span>
<a name="line-1922"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span> <span class='hs-varid'>specialPromotedDc</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1923"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKindsDC</span>
<a name="line-1924"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>isFamInstTyCon</span> <span class='hs-layout'>(</span><span class='hs-varid'>dataConTyCon</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1925"></a>                       <span class='hs-comment'>-- see #15245</span>
<a name="line-1926"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>FamDataConPE</span>
<a name="line-1927"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dataConFullSig</span> <span class='hs-varid'>dc</span>
<a name="line-1928"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>theta</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>dc_theta_illegal_constraint</span> <span class='hs-varid'>theta</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-1929"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>dc_theta_illegal_constraint</span> <span class='hs-varid'>theta</span> <span class='hs-keyword'>of</span>
<a name="line-1930"></a>                       <span class='hs-conid'>Just</span> <span class='hs-varid'>pred</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varop'>$</span>
<a name="line-1931"></a>                                    <span class='hs-conid'>ConstrainedDataConPE</span> <span class='hs-varid'>pred</span>
<a name="line-1932"></a>                       <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pure</span> <span class='hs-conid'>()</span>
<a name="line-1933"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>promoteDataCon</span> <span class='hs-varid'>dc</span>
<a name="line-1934"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1935"></a>
<a name="line-1936"></a>           <span class='hs-conid'>APromotionErr</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-1937"></a>
<a name="line-1938"></a>           <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>wrongThingErr</span> <span class='hs-str'>"type"</span> <span class='hs-varid'>thing</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-1939"></a>  <span class='hs-keyword'>where</span>
<a name="line-1940"></a>    <span class='hs-varid'>check_tc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-1941"></a>    <span class='hs-varid'>check_tc</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>data_kinds</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>xoptM</span> <span class='hs-conid'>LangExt.DataKinds</span>
<a name="line-1942"></a>                     <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTypeLevel</span> <span class='hs-layout'>(</span><span class='hs-varid'>mode_tyki</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span>
<a name="line-1943"></a>                               <span class='hs-varid'>data_kinds</span> <span class='hs-varop'>||</span>
<a name="line-1944"></a>                               <span class='hs-varid'>isKindTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-1945"></a>                       <span class='hs-varid'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-conid'>NoDataKindsTC</span> <span class='hs-layout'>}</span>
<a name="line-1946"></a>
<a name="line-1947"></a>    <span class='hs-comment'>-- We cannot promote a data constructor with a context that contains</span>
<a name="line-1948"></a>    <span class='hs-comment'>-- constraints other than equalities, so error if we find one.</span>
<a name="line-1949"></a>    <span class='hs-comment'>-- See Note [Constraints in kinds] in GHC.Core.TyCo.Rep</span>
<a name="line-1950"></a>    <span class='hs-varid'>dc_theta_illegal_constraint</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThetaType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>PredType</span>
<a name="line-1951"></a>    <span class='hs-varid'>dc_theta_illegal_constraint</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>find</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isEqPred</span><span class='hs-layout'>)</span>
<a name="line-1952"></a>
<a name="line-1953"></a><span class='hs-comment'>{-
<a name="line-1954"></a>Note [Recursion through the kinds]
<a name="line-1955"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1956"></a>Consider these examples
<a name="line-1957"></a>
<a name="line-1958"></a>Ticket #11554:
<a name="line-1959"></a>  data P (x :: k) = Q
<a name="line-1960"></a>  data A :: Type where
<a name="line-1961"></a>    MkA :: forall (a :: A). P a -&gt; A
<a name="line-1962"></a>
<a name="line-1963"></a>Ticket #12174
<a name="line-1964"></a>  data V a
<a name="line-1965"></a>  data T = forall (a :: T). MkT (V a)
<a name="line-1966"></a>
<a name="line-1967"></a>The type is recursive (which is fine) but it is recursive /through the
<a name="line-1968"></a>kinds/.  In earlier versions of GHC this caused a loop in the compiler
<a name="line-1969"></a>(to do with knot-tying) but there is nothing fundamentally wrong with
<a name="line-1970"></a>the code (kinds are types, and the recursive declarations are OK). But
<a name="line-1971"></a>it's hard to distinguish "recursion through the kinds" from "recursion
<a name="line-1972"></a>through the types". Consider this (also #11554):
<a name="line-1973"></a>
<a name="line-1974"></a>  data PB k (x :: k) = Q
<a name="line-1975"></a>  data B :: Type where
<a name="line-1976"></a>    MkB :: P B a -&gt; B
<a name="line-1977"></a>
<a name="line-1978"></a>Here the occurrence of B is not obviously in a kind position.
<a name="line-1979"></a>
<a name="line-1980"></a>So now GHC allows all these programs.  #12081 and #15942 are other
<a name="line-1981"></a>examples.
<a name="line-1982"></a>
<a name="line-1983"></a>Note [Body kind of a HsForAllTy]
<a name="line-1984"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-1985"></a>The body of a forall is usually a type, but in principle
<a name="line-1986"></a>there's no reason to prohibit *unlifted* types.
<a name="line-1987"></a>In fact, GHC can itself construct a function with an
<a name="line-1988"></a>unboxed tuple inside a for-all (via CPR analysis; see
<a name="line-1989"></a>typecheck/should_compile/tc170).
<a name="line-1990"></a>
<a name="line-1991"></a>Moreover in instance heads we get forall-types with
<a name="line-1992"></a>kind Constraint.
<a name="line-1993"></a>
<a name="line-1994"></a>It's tempting to check that the body kind is either * or #. But this is
<a name="line-1995"></a>wrong. For example:
<a name="line-1996"></a>
<a name="line-1997"></a>  class C a b
<a name="line-1998"></a>  newtype N = Mk Foo deriving (C a)
<a name="line-1999"></a>
<a name="line-2000"></a>We're doing newtype-deriving for C. But notice how `a` isn't in scope in
<a name="line-2001"></a>the predicate `C a`. So we quantify, yielding `forall a. C a` even though
<a name="line-2002"></a>`C a` has kind `* -&gt; Constraint`. The `forall a. C a` is a bit cheeky, but
<a name="line-2003"></a>convenient. Bottom line: don't check for * or # here.
<a name="line-2004"></a>
<a name="line-2005"></a>Note [Body kind of a HsQualTy]
<a name="line-2006"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2007"></a>If ctxt is non-empty, the HsQualTy really is a /function/, so the
<a name="line-2008"></a>kind of the result really is '*', and in that case the kind of the
<a name="line-2009"></a>body-type can be lifted or unlifted.
<a name="line-2010"></a>
<a name="line-2011"></a>However, consider
<a name="line-2012"></a>    instance Eq a =&gt; Eq [a] where ...
<a name="line-2013"></a>or
<a name="line-2014"></a>    f :: (Eq a =&gt; Eq [a]) =&gt; blah
<a name="line-2015"></a>Here both body-kind of the HsQualTy is Constraint rather than *.
<a name="line-2016"></a>Rather crudely we tell the difference by looking at exp_kind. It's
<a name="line-2017"></a>very convenient to typecheck instance types like any other HsSigType.
<a name="line-2018"></a>
<a name="line-2019"></a>Admittedly the '(Eq a =&gt; Eq [a]) =&gt; blah' case is erroneous, but it's
<a name="line-2020"></a>better to reject in checkValidType.  If we say that the body kind
<a name="line-2021"></a>should be '*' we risk getting TWO error messages, one saying that Eq
<a name="line-2022"></a>[a] doesn't have kind '*', and one saying that we need a Constraint to
<a name="line-2023"></a>the left of the outer (=&gt;).
<a name="line-2024"></a>
<a name="line-2025"></a>How do we figure out the right body kind?  Well, it's a bit of a
<a name="line-2026"></a>kludge: I just look at the expected kind.  If it's Constraint, we
<a name="line-2027"></a>must be in this instance situation context. It's a kludge because it
<a name="line-2028"></a>wouldn't work if any unification was involved to compute that result
<a name="line-2029"></a>kind -- but it isn't.  (The true way might be to use the 'mode'
<a name="line-2030"></a>parameter, but that seemed like a sledgehammer to crack a nut.)
<a name="line-2031"></a>
<a name="line-2032"></a>Note [Inferring tuple kinds]
<a name="line-2033"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2034"></a>Give a tuple type (a,b,c), which the parser labels as HsBoxedOrConstraintTuple,
<a name="line-2035"></a>we try to figure out whether it's a tuple of kind * or Constraint.
<a name="line-2036"></a>  Step 1: look at the expected kind
<a name="line-2037"></a>  Step 2: infer argument kinds
<a name="line-2038"></a>
<a name="line-2039"></a>If after Step 2 it's not clear from the arguments that it's
<a name="line-2040"></a>Constraint, then it must be *.  Once having decided that we re-check
<a name="line-2041"></a>the arguments to give good error messages in
<a name="line-2042"></a>  e.g.  (Maybe, Maybe)
<a name="line-2043"></a>
<a name="line-2044"></a>Note that we will still fail to infer the correct kind in this case:
<a name="line-2045"></a>
<a name="line-2046"></a>  type T a = ((a,a), D a)
<a name="line-2047"></a>  type family D :: Constraint -&gt; Constraint
<a name="line-2048"></a>
<a name="line-2049"></a>While kind checking T, we do not yet know the kind of D, so we will default the
<a name="line-2050"></a>kind of T to * -&gt; *. It works if we annotate `a` with kind `Constraint`.
<a name="line-2051"></a>
<a name="line-2052"></a>Note [Desugaring types]
<a name="line-2053"></a>~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2054"></a>The type desugarer is phase 2 of dealing with HsTypes.  Specifically:
<a name="line-2055"></a>
<a name="line-2056"></a>  * It transforms from HsType to Type
<a name="line-2057"></a>
<a name="line-2058"></a>  * It zonks any kinds.  The returned type should have no mutable kind
<a name="line-2059"></a>    or type variables (hence returning Type not TcType):
<a name="line-2060"></a>      - any unconstrained kind variables are defaulted to (Any *) just
<a name="line-2061"></a>        as in GHC.Tc.Utils.Zonk.
<a name="line-2062"></a>      - there are no mutable type variables because we are
<a name="line-2063"></a>        kind-checking a type
<a name="line-2064"></a>    Reason: the returned type may be put in a TyCon or DataCon where
<a name="line-2065"></a>    it will never subsequently be zonked.
<a name="line-2066"></a>
<a name="line-2067"></a>You might worry about nested scopes:
<a name="line-2068"></a>        ..a:kappa in scope..
<a name="line-2069"></a>            let f :: forall b. T '[a,b] -&gt; Int
<a name="line-2070"></a>In this case, f's type could have a mutable kind variable kappa in it;
<a name="line-2071"></a>and we might then default it to (Any *) when dealing with f's type
<a name="line-2072"></a>signature.  But we don't expect this to happen because we can't get a
<a name="line-2073"></a>lexically scoped type variable with a mutable kind variable in it.  A
<a name="line-2074"></a>delicate point, this.  If it becomes an issue we might need to
<a name="line-2075"></a>distinguish top-level from nested uses.
<a name="line-2076"></a>
<a name="line-2077"></a>Moreover
<a name="line-2078"></a>  * it cannot fail,
<a name="line-2079"></a>  * it does no unifications
<a name="line-2080"></a>  * it does no validity checking, except for structural matters, such as
<a name="line-2081"></a>        (a) spurious ! annotations.
<a name="line-2082"></a>        (b) a class used as a type
<a name="line-2083"></a>
<a name="line-2084"></a>Note [Kind of a type splice]
<a name="line-2085"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2086"></a>Consider these terms, each with TH type splice inside:
<a name="line-2087"></a>     [| e1 :: Maybe $(..blah..) |]
<a name="line-2088"></a>     [| e2 :: $(..blah..) |]
<a name="line-2089"></a>When kind-checking the type signature, we'll kind-check the splice
<a name="line-2090"></a>$(..blah..); we want to give it a kind that can fit in any context,
<a name="line-2091"></a>as if $(..blah..) :: forall k. k.
<a name="line-2092"></a>
<a name="line-2093"></a>In the e1 example, the context of the splice fixes kappa to *.  But
<a name="line-2094"></a>in the e2 example, we'll desugar the type, zonking the kind unification
<a name="line-2095"></a>variables as we go.  When we encounter the unconstrained kappa, we
<a name="line-2096"></a>want to default it to '*', not to (Any *).
<a name="line-2097"></a>
<a name="line-2098"></a>-}</span>
<a name="line-2099"></a>
<a name="line-2100"></a><a name="addTypeCtxt"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2101"></a>        <span class='hs-comment'>-- Wrap a context around only if we want to show that contexts.</span>
<a name="line-2102"></a>        <span class='hs-comment'>-- Omit invisible ones and ones user's won't grok</span>
<a name="line-2103"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>thing</span>   <span class='hs-comment'>-- "In the type '_'" just isn't helpful.</span>
<a name="line-2104"></a><span class='hs-definition'>addTypeCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span>
<a name="line-2105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varid'>doc</span> <span class='hs-varid'>thing</span>
<a name="line-2106"></a>  <span class='hs-keyword'>where</span>
<a name="line-2107"></a>    <span class='hs-varid'>doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the type"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2108"></a>
<a name="line-2109"></a>
<a name="line-2110"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2111"></a>*                                                                      *
<a name="line-2112"></a>                Type-variable binders
<a name="line-2113"></a>*                                                                      *
<a name="line-2114"></a>********************************************************************* -}</span>
<a name="line-2115"></a>
<a name="line-2116"></a><a name="bindNamedWildCardBinders"></a><span class='hs-definition'>bindNamedWildCardBinders</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-2117"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2118"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2119"></a><span class='hs-comment'>-- Bring into scope the /named/ wildcard binders.  Remember that</span>
<a name="line-2120"></a><span class='hs-comment'>-- plain wildcards _ are anonymous and dealt with by HsWildCardTy</span>
<a name="line-2121"></a><span class='hs-comment'>-- Soe Note [The wildcard story for types] in GHC.Hs.Type</span>
<a name="line-2122"></a><span class='hs-definition'>bindNamedWildCardBinders</span> <span class='hs-varid'>wc_names</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>newNamedWildTyVar</span> <span class='hs-varid'>wc_names</span>
<a name="line-2124"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wc_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wc_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>wcs</span>
<a name="line-2125"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-varid'>wc_prs</span> <span class='hs-varop'>$</span>
<a name="line-2126"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>wc_prs</span> <span class='hs-layout'>}</span>
<a name="line-2127"></a>
<a name="line-2128"></a><a name="newNamedWildTyVar"></a><span class='hs-definition'>newNamedWildTyVar</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-2129"></a><span class='hs-comment'>-- ^ New unification variable '_' for a wildcard</span>
<a name="line-2130"></a><span class='hs-definition'>newNamedWildTyVar</span> <span class='hs-sel'>_name</span>   <span class='hs-comment'>-- Currently ignoring the "_x" wildcard name used in the type</span>
<a name="line-2131"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-2132"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TauTv</span>
<a name="line-2133"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wc_name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVarName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"w"</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- See Note [Wildcard names]</span>
<a name="line-2134"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tyvar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>wc_name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span>
<a name="line-2135"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"newWildTyVar"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tyvar</span><span class='hs-layout'>)</span>
<a name="line-2136"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tyvar</span> <span class='hs-layout'>}</span>
<a name="line-2137"></a>
<a name="line-2138"></a><a name="tcAnonWildCardOcc"></a><span class='hs-comment'>---------------------------</span>
<a name="line-2139"></a><span class='hs-definition'>tcAnonWildCardOcc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IsExtraConstraint</span>
<a name="line-2140"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsType</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-2141"></a><span class='hs-definition'>tcAnonWildCardOcc</span> <span class='hs-varid'>is_extra</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>hole_lvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>hole_mode</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-2142"></a>                  <span class='hs-varid'>ty</span> <span class='hs-varid'>exp_kind</span>
<a name="line-2143"></a>    <span class='hs-comment'>-- hole_lvl: see Note [Checking partial type signatures]</span>
<a name="line-2144"></a>    <span class='hs-comment'>--           esp the bullet on nested forall types</span>
<a name="line-2145"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kv_details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTauTvDetailsAtLevel</span> <span class='hs-varid'>hole_lvl</span>
<a name="line-2146"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kv_name</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVarName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"k"</span><span class='hs-layout'>)</span>
<a name="line-2147"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wc_details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTauTvDetailsAtLevel</span> <span class='hs-varid'>hole_lvl</span>
<a name="line-2148"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>wc_name</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVarName</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-varid'>wc_nm</span><span class='hs-layout'>)</span>
<a name="line-2149"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>kv</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>kv_name</span> <span class='hs-varid'>liftedTypeKind</span> <span class='hs-varid'>kv_details</span>
<a name="line-2150"></a>             <span class='hs-varid'>wc_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>kv</span>
<a name="line-2151"></a>             <span class='hs-varid'>wc_tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>wc_name</span> <span class='hs-varid'>wc_kind</span> <span class='hs-varid'>wc_details</span>
<a name="line-2152"></a>
<a name="line-2153"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcAnonWildCardOcc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hole_lvl</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>emit_holes</span><span class='hs-layout'>)</span>
<a name="line-2154"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>when</span> <span class='hs-varid'>emit_holes</span> <span class='hs-varop'>$</span>
<a name="line-2155"></a>         <span class='hs-varid'>emitAnonTypeHole</span> <span class='hs-varid'>is_extra</span> <span class='hs-varid'>wc_tv</span>
<a name="line-2156"></a>         <span class='hs-comment'>-- Why the 'when' guard?</span>
<a name="line-2157"></a>         <span class='hs-comment'>-- See Note [Wildcards in visible kind application]</span>
<a name="line-2158"></a>
<a name="line-2159"></a>       <span class='hs-comment'>-- You might think that this would always just unify</span>
<a name="line-2160"></a>       <span class='hs-comment'>-- wc_kind with exp_kind, so we could avoid even creating kv</span>
<a name="line-2161"></a>       <span class='hs-comment'>-- But the level numbers might not allow that unification,</span>
<a name="line-2162"></a>       <span class='hs-comment'>-- so we have to do it properly (T14140a)</span>
<a name="line-2163"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-varid'>ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>wc_tv</span><span class='hs-layout'>)</span> <span class='hs-varid'>wc_kind</span> <span class='hs-varid'>exp_kind</span> <span class='hs-layout'>}</span>
<a name="line-2164"></a>  <span class='hs-keyword'>where</span>
<a name="line-2165"></a>     <span class='hs-comment'>-- See Note [Wildcard names]</span>
<a name="line-2166"></a>     <span class='hs-varid'>wc_nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hole_mode</span> <span class='hs-keyword'>of</span>
<a name="line-2167"></a>               <span class='hs-conid'>HM_Sig</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"w"</span>
<a name="line-2168"></a>               <span class='hs-conid'>HM_FamPat</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"_"</span>
<a name="line-2169"></a>               <span class='hs-conid'>HM_VTA</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"w"</span>
<a name="line-2170"></a>               <span class='hs-conid'>HM_TyAppPat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"_"</span>
<a name="line-2171"></a>
<a name="line-2172"></a>     <span class='hs-varid'>emit_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>hole_mode</span> <span class='hs-keyword'>of</span>
<a name="line-2173"></a>                     <span class='hs-conid'>HM_Sig</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-2174"></a>                     <span class='hs-conid'>HM_FamPat</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2175"></a>                     <span class='hs-conid'>HM_VTA</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2176"></a>                     <span class='hs-conid'>HM_TyAppPat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-2177"></a>
<a name="line-2178"></a><span class='hs-definition'>tcAnonWildCardOcc</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>_</span>
<a name="line-2179"></a><span class='hs-comment'>-- mode_holes is Nothing.  Should not happen, because renamer</span>
<a name="line-2180"></a><span class='hs-comment'>-- should already have rejected holes in unexpected places</span>
<a name="line-2181"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"tcWildCardOcc"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>mode</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty</span><span class='hs-layout'>)</span>
<a name="line-2182"></a>
<a name="line-2183"></a><span class='hs-comment'>{- Note [Wildcard names]
<a name="line-2184"></a>~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2185"></a>So we hackily use the mode_holes flag to control the name used
<a name="line-2186"></a>for wildcards:
<a name="line-2187"></a>
<a name="line-2188"></a>* For proper holes (whether in a visible type application (VTA) or no),
<a name="line-2189"></a>  we rename the '_' to 'w'. This is so that we see variables like 'w0'
<a name="line-2190"></a>  or 'w1' in error messages, a vast improvement upon '_0' and '_1'. For
<a name="line-2191"></a>  example, we prefer
<a name="line-2192"></a>       Found type wildcard _ standing for w0
<a name="line-2193"></a>  over
<a name="line-2194"></a>       Found type wildcard _ standing for _1
<a name="line-2195"></a>
<a name="line-2196"></a>  Even in the VTA case, where we do not emit an error to be printed, we
<a name="line-2197"></a>  want to do the renaming, as the variables may appear in other,
<a name="line-2198"></a>  non-wildcard error messages.
<a name="line-2199"></a>
<a name="line-2200"></a>* However, holes in the left-hand sides of type families ("type
<a name="line-2201"></a>  patterns") stand for type variables which we do not care to name --
<a name="line-2202"></a>  much like the use of an underscore in an ordinary term-level
<a name="line-2203"></a>  pattern. When we spot these, we neither wish to generate an error
<a name="line-2204"></a>  message nor to rename the variable.  We don't rename the variable so
<a name="line-2205"></a>  that we can pretty-print a type family LHS as, e.g.,
<a name="line-2206"></a>    F _ Int _ = ...
<a name="line-2207"></a>  and not
<a name="line-2208"></a>     F w1 Int w2 = ...
<a name="line-2209"></a>
<a name="line-2210"></a>  See also Note [Wildcards in family instances] in
<a name="line-2211"></a>  GHC.Rename.Module. The choice of HM_FamPat is made in
<a name="line-2212"></a>  tcFamTyPats. There is also some unsavory magic, relying on that
<a name="line-2213"></a>  underscore, in GHC.Core.Coercion.tidyCoAxBndrsForUser.
<a name="line-2214"></a>
<a name="line-2215"></a>Note [Wildcards in visible kind application]
<a name="line-2216"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2217"></a>There are cases where users might want to pass in a wildcard as a visible kind
<a name="line-2218"></a>argument, for instance:
<a name="line-2219"></a>
<a name="line-2220"></a>data T :: forall k1 k2. k1  k2  Type where
<a name="line-2221"></a>  MkT :: T a b
<a name="line-2222"></a>x :: T @_ @Nat False n
<a name="line-2223"></a>x = MkT
<a name="line-2224"></a>
<a name="line-2225"></a>So we should allow '@_' without emitting any hole constraints, and
<a name="line-2226"></a>regardless of whether PartialTypeSignatures is enabled or not. But how
<a name="line-2227"></a>would the typechecker know which '_' is being used in VKA and which is
<a name="line-2228"></a>not when it calls emitNamedTypeHole in
<a name="line-2229"></a>tcHsPartialSigType on all HsWildCardBndrs?  The solution is to neither
<a name="line-2230"></a>rename nor include unnamed wildcards in HsWildCardBndrs, but instead
<a name="line-2231"></a>give every anonymous wildcard a fresh wild tyvar in tcAnonWildCardOcc.
<a name="line-2232"></a>
<a name="line-2233"></a>And whenever we see a '@', we set mode_holes to HM_VKA, so that
<a name="line-2234"></a>we do not call emitAnonTypeHole in tcAnonWildCardOcc.
<a name="line-2235"></a>See related Note [Wildcards in visible type application] here and
<a name="line-2236"></a>Note [The wildcard story for types] in GHC.Hs.Type
<a name="line-2237"></a>-}</span>
<a name="line-2238"></a>
<a name="line-2239"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2240"></a>*                                                                      *
<a name="line-2241"></a>             Kind inference for type declarations
<a name="line-2242"></a>*                                                                      *
<a name="line-2243"></a>********************************************************************* -}</span>
<a name="line-2244"></a>
<a name="line-2245"></a><a name="InitialKindStrategy"></a><span class='hs-comment'>-- See Note [kcCheckDeclHeader vs kcInferDeclHeader]</span>
<a name="line-2246"></a><a name="InitialKindStrategy"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>InitialKindStrategy</span>
<a name="line-2247"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>InitialKindCheck</span> <span class='hs-conid'>SAKS_or_CUSK</span>
<a name="line-2248"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>InitialKindInfer</span>
<a name="line-2249"></a>
<a name="line-2250"></a><a name="SAKS_or_CUSK"></a><span class='hs-comment'>-- Does the declaration have a standalone kind signature (SAKS) or a complete</span>
<a name="line-2251"></a><a name="SAKS_or_CUSK"></a><span class='hs-comment'>-- user-specified kind (CUSK)?</span>
<a name="line-2252"></a><a name="SAKS_or_CUSK"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SAKS_or_CUSK</span>
<a name="line-2253"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SAKS</span> <span class='hs-conid'>Kind</span>  <span class='hs-comment'>-- Standalone kind signature, fully zonked! (zonkTcTypeToType)</span>
<a name="line-2254"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>CUSK</span>       <span class='hs-comment'>-- Complete user-specified kind (CUSK)</span>
<a name="line-2255"></a>
<a name="line-2256"></a><a name="instance%20Outputable%20SAKS_or_CUSK"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Outputable</span> <span class='hs-conid'>SAKS_or_CUSK</span> <span class='hs-keyword'>where</span>
<a name="line-2257"></a>  <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SAKS</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"SAKS"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k</span>
<a name="line-2258"></a>  <span class='hs-varid'>ppr</span> <span class='hs-conid'>CUSK</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"CUSK"</span>
<a name="line-2259"></a>
<a name="line-2260"></a><a name="kcDeclHeader"></a><span class='hs-comment'>-- See Note [kcCheckDeclHeader vs kcInferDeclHeader]</span>
<a name="line-2261"></a><span class='hs-definition'>kcDeclHeader</span>
<a name="line-2262"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InitialKindStrategy</span>
<a name="line-2263"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-2264"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span>      <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-2265"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>  <span class='hs-comment'>-- ^ Binders in the header</span>
<a name="line-2266"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ContextKind</span>   <span class='hs-comment'>-- ^ The result kind</span>
<a name="line-2267"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>       <span class='hs-comment'>-- ^ A suitably-kinded TcTyCon</span>
<a name="line-2268"></a><span class='hs-definition'>kcDeclHeader</span> <span class='hs-layout'>(</span><span class='hs-conid'>InitialKindCheck</span> <span class='hs-varid'>msig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcCheckDeclHeader</span> <span class='hs-varid'>msig</span>
<a name="line-2269"></a><span class='hs-definition'>kcDeclHeader</span> <span class='hs-conid'>InitialKindInfer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcInferDeclHeader</span>
<a name="line-2270"></a>
<a name="line-2271"></a><span class='hs-comment'>{- Note [kcCheckDeclHeader vs kcInferDeclHeader]
<a name="line-2272"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2273"></a>kcCheckDeclHeader and kcInferDeclHeader are responsible for getting the initial kind
<a name="line-2274"></a>of a type constructor.
<a name="line-2275"></a>
<a name="line-2276"></a>* kcCheckDeclHeader: the TyCon has a standalone kind signature or a CUSK. In that
<a name="line-2277"></a>  case, find the full, final, poly-kinded kind of the TyCon.  It's very like a
<a name="line-2278"></a>  term-level binding where we have a complete type signature for the function.
<a name="line-2279"></a>
<a name="line-2280"></a>* kcInferDeclHeader: the TyCon has neither a standalone kind signature nor a
<a name="line-2281"></a>  CUSK. Find a monomorphic kind, with unification variables in it; they will be
<a name="line-2282"></a>  generalised later.  It's very like a term-level binding where we do not have a
<a name="line-2283"></a>  type signature (or, more accurately, where we have a partial type signature),
<a name="line-2284"></a>  so we infer the type and generalise.
<a name="line-2285"></a>-}</span>
<a name="line-2286"></a>
<a name="line-2287"></a><a name="kcCheckDeclHeader"></a><span class='hs-comment'>------------------------------</span>
<a name="line-2288"></a><span class='hs-definition'>kcCheckDeclHeader</span>
<a name="line-2289"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SAKS_or_CUSK</span>
<a name="line-2290"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-2291"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span>      <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-2292"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>  <span class='hs-comment'>-- ^ Binders in the header</span>
<a name="line-2293"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ContextKind</span>   <span class='hs-comment'>-- ^ The result kind. AnyKind == no result signature</span>
<a name="line-2294"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>       <span class='hs-comment'>-- ^ A suitably-kinded generalized TcTyCon</span>
<a name="line-2295"></a><span class='hs-definition'>kcCheckDeclHeader</span> <span class='hs-layout'>(</span><span class='hs-conid'>SAKS</span> <span class='hs-varid'>sig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcCheckDeclHeader_sig</span> <span class='hs-varid'>sig</span>
<a name="line-2296"></a><span class='hs-definition'>kcCheckDeclHeader</span> <span class='hs-conid'>CUSK</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kcCheckDeclHeader_cusk</span>
<a name="line-2297"></a>
<a name="line-2298"></a><a name="kcCheckDeclHeader_cusk"></a><span class='hs-definition'>kcCheckDeclHeader_cusk</span>
<a name="line-2299"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-2300"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span>      <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-2301"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>  <span class='hs-comment'>-- ^ Binders in the header</span>
<a name="line-2302"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ContextKind</span>   <span class='hs-comment'>-- ^ The result kind</span>
<a name="line-2303"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>       <span class='hs-comment'>-- ^ A suitably-kinded generalized TcTyCon</span>
<a name="line-2304"></a><span class='hs-definition'>kcCheckDeclHeader_cusk</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span>
<a name="line-2305"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span>
<a name="line-2306"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>kc_res_ki</span>
<a name="line-2307"></a>  <span class='hs-comment'>-- CUSK case</span>
<a name="line-2308"></a>  <span class='hs-comment'>-- See note [Required, Specified, and Inferred for types] in GHC.Tc.TyCl</span>
<a name="line-2309"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTyConFlavCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varop'>$</span>
<a name="line-2310"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2311"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndSolveEqualitiesX</span> <span class='hs-str'>"kcCheckDeclHeader_cusk"</span> <span class='hs-varop'>$</span>
<a name="line-2312"></a>              <span class='hs-varid'>bindImplicitTKBndrs_Q_Skol</span> <span class='hs-varid'>kv_ns</span>                      <span class='hs-varop'>$</span>
<a name="line-2313"></a>              <span class='hs-varid'>bindExplicitTKBndrs_Q_Skol</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>hs_tvs</span>           <span class='hs-varop'>$</span>
<a name="line-2314"></a>              <span class='hs-varid'>newExpectedKind</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>kc_res_ki</span>
<a name="line-2315"></a>
<a name="line-2316"></a>           <span class='hs-comment'>-- Now, because we're in a CUSK,</span>
<a name="line-2317"></a>           <span class='hs-comment'>-- we quantify over the mentioned kind vars</span>
<a name="line-2318"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>spec_req_tkvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-2319"></a>             <span class='hs-varid'>all_kinds</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>res_kind</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>spec_req_tkvs</span>
<a name="line-2320"></a>
<a name="line-2321"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>candidates'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidateQTyVarsOfKinds</span> <span class='hs-varid'>all_kinds</span>
<a name="line-2322"></a>             <span class='hs-comment'>-- 'candidates' are all the variables that we are going to</span>
<a name="line-2323"></a>             <span class='hs-comment'>-- skolemise and then quantify over.  We do not include spec_req_tvs</span>
<a name="line-2324"></a>             <span class='hs-comment'>-- because they are /already/ skolems</span>
<a name="line-2325"></a>
<a name="line-2326"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>non_tc_candidates</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isTcTyVar</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>nonDetEltsUniqSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>all_kinds</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2327"></a>             <span class='hs-varid'>candidates</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>candidates'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dv_kvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dv_kvs</span> <span class='hs-varid'>candidates'</span> <span class='hs-varop'>`extendDVarSetList`</span> <span class='hs-varid'>non_tc_candidates</span> <span class='hs-layout'>}</span>
<a name="line-2328"></a>             <span class='hs-varid'>inf_candidates</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>candidates</span> <span class='hs-varop'>`delCandidates`</span> <span class='hs-varid'>spec_req_tkvs</span>
<a name="line-2329"></a>
<a name="line-2330"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>inferred</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>inf_candidates</span>
<a name="line-2331"></a>                     <span class='hs-comment'>-- NB: 'inferred' comes back sorted in dependency order</span>
<a name="line-2332"></a>
<a name="line-2333"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>scoped_kvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-2334"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tc_tvs</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTyCoVarKind</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-2335"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res_kind</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span>           <span class='hs-varid'>res_kind</span>
<a name="line-2336"></a>
<a name="line-2337"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>mentioned_kv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>candidateKindVars</span> <span class='hs-varid'>candidates</span>
<a name="line-2338"></a>             <span class='hs-varid'>specified</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>scopedSort</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-2339"></a>                                <span class='hs-comment'>-- NB: maintain the L-R order of scoped_kvs</span>
<a name="line-2340"></a>
<a name="line-2341"></a>             <span class='hs-varid'>final_tc_binders</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mkNamedTyConBinders</span> <span class='hs-conid'>Inferred</span>  <span class='hs-varid'>inferred</span>
<a name="line-2342"></a>                              <span class='hs-varop'>++</span> <span class='hs-varid'>mkNamedTyConBinders</span> <span class='hs-conid'>Specified</span> <span class='hs-varid'>specified</span>
<a name="line-2343"></a>                              <span class='hs-varop'>++</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkRequiredTyConBinder</span> <span class='hs-varid'>mentioned_kv_set</span><span class='hs-layout'>)</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-2344"></a>
<a name="line-2345"></a>             <span class='hs-varid'>all_tv_prs</span> <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>mkTyVarNamePairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span>
<a name="line-2346"></a>             <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>final_tc_binders</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>all_tv_prs</span>
<a name="line-2347"></a>                               <span class='hs-conid'>True</span> <span class='hs-comment'>-- it is generalised</span>
<a name="line-2348"></a>                               <span class='hs-varid'>flav</span>
<a name="line-2349"></a>
<a name="line-2350"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportUnsolvedEqualities</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVars</span> <span class='hs-varid'>final_tc_binders</span><span class='hs-layout'>)</span>
<a name="line-2351"></a>                                  <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-2352"></a>
<a name="line-2353"></a>         <span class='hs-comment'>-- If the ordering from</span>
<a name="line-2354"></a>         <span class='hs-comment'>-- Note [Required, Specified, and Inferred for types] in GHC.Tc.TyCl</span>
<a name="line-2355"></a>         <span class='hs-comment'>-- doesn't work, we catch it here, before an error cascade</span>
<a name="line-2356"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTyConTelescope</span> <span class='hs-varid'>tycon</span>
<a name="line-2357"></a>
<a name="line-2358"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcCheckDeclHeader_cusk "</span> <span class='hs-varop'>$</span>
<a name="line-2359"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"name"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span>
<a name="line-2360"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kv_ns"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span>
<a name="line-2361"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"hs_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-2362"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"scoped_kvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-2363"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tc_tvs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-2364"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"res_kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>res_kind</span>
<a name="line-2365"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"candidates"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>candidates</span>
<a name="line-2366"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"inferred"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>inferred</span>
<a name="line-2367"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"specified"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>specified</span>
<a name="line-2368"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"final_tc_binders"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>final_tc_binders</span>
<a name="line-2369"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"mkTyConKind final_tc_bndrs res_kind"</span>
<a name="line-2370"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>final_tc_binders</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-2371"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"all_tv_prs"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>all_tv_prs</span> <span class='hs-keyglyph'>]</span>
<a name="line-2372"></a>
<a name="line-2373"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>}</span>
<a name="line-2374"></a>  <span class='hs-keyword'>where</span>
<a name="line-2375"></a>    <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConSkol</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>name</span>
<a name="line-2376"></a>    <span class='hs-varid'>ctxt_kind</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcFlavourIsOpen</span> <span class='hs-varid'>flav</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-2377"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-2378"></a>
<a name="line-2379"></a><a name="kcInferDeclHeader"></a><span class='hs-comment'>-- | Kind-check a 'LHsQTyVars'. Used in 'inferInitialKind' (for tycon kinds and</span>
<a name="line-2380"></a><span class='hs-comment'>-- other kinds).</span>
<a name="line-2381"></a><span class='hs-comment'>--</span>
<a name="line-2382"></a><span class='hs-comment'>-- This function does not do telescope checking.</span>
<a name="line-2383"></a><span class='hs-definition'>kcInferDeclHeader</span>
<a name="line-2384"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-2385"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span>      <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-2386"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>
<a name="line-2387"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ContextKind</span>   <span class='hs-comment'>-- ^ The result kind</span>
<a name="line-2388"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>       <span class='hs-comment'>-- ^ A suitably-kinded non-generalized TcTyCon</span>
<a name="line-2389"></a><span class='hs-definition'>kcInferDeclHeader</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span>
<a name="line-2390"></a>              <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_ext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>kv_ns</span>
<a name="line-2391"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>kc_res_ki</span>
<a name="line-2392"></a>  <span class='hs-comment'>-- No standalane kind signature and no CUSK.</span>
<a name="line-2393"></a>  <span class='hs-comment'>-- See note [Required, Specified, and Inferred for types] in GHC.Tc.TyCl</span>
<a name="line-2394"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTyConFlavCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varop'>$</span>
<a name="line-2395"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2396"></a>           <span class='hs-comment'>-- Why bindImplicitTKBndrs_Q_Tv which uses newTyVarTyVar?</span>
<a name="line-2397"></a>           <span class='hs-comment'>-- See Note [Inferring kinds for type declarations] in GHC.Tc.TyCl</span>
<a name="line-2398"></a>           <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindImplicitTKBndrs_Q_Tv</span> <span class='hs-varid'>kv_ns</span>            <span class='hs-varop'>$</span>
<a name="line-2399"></a>              <span class='hs-varid'>bindExplicitTKBndrs_Q_Tv</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-varop'>$</span>
<a name="line-2400"></a>              <span class='hs-varid'>newExpectedKind</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>kc_res_ki</span>
<a name="line-2401"></a>              <span class='hs-comment'>-- Why "_Tv" not "_Skol"? See third wrinkle in</span>
<a name="line-2402"></a>              <span class='hs-comment'>-- Note [Inferring kinds for type declarations] in GHC.Tc.TyCl,</span>
<a name="line-2403"></a>
<a name="line-2404"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span>   <span class='hs-comment'>-- NB: Don't add scoped_kvs to tyConTyVars, because they</span>
<a name="line-2405"></a>               <span class='hs-comment'>-- might unify with kind vars in other types in a mutually</span>
<a name="line-2406"></a>               <span class='hs-comment'>-- recursive group.</span>
<a name="line-2407"></a>               <span class='hs-comment'>-- See Note [Inferring kinds for type declarations] in GHC.Tc.TyCl</span>
<a name="line-2408"></a>
<a name="line-2409"></a>             <span class='hs-varid'>tc_binders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAnonTyConBinders</span> <span class='hs-conid'>VisArg</span> <span class='hs-varid'>tc_tvs</span>
<a name="line-2410"></a>               <span class='hs-comment'>-- Also, note that tc_binders has the tyvars from only the</span>
<a name="line-2411"></a>               <span class='hs-comment'>-- user-written tyvarbinders. See S1 in Note [How TcTyCons work]</span>
<a name="line-2412"></a>               <span class='hs-comment'>-- in GHC.Tc.TyCl</span>
<a name="line-2413"></a>               <span class='hs-comment'>--</span>
<a name="line-2414"></a>               <span class='hs-comment'>-- mkAnonTyConBinder: see Note [No polymorphic recursion]</span>
<a name="line-2415"></a>
<a name="line-2416"></a>             <span class='hs-varid'>all_tv_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarNamePairs</span> <span class='hs-layout'>(</span><span class='hs-varid'>scoped_kvs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>)</span>
<a name="line-2417"></a>               <span class='hs-comment'>-- NB: bindExplicitTKBndrs_Q_Tv does not clone;</span>
<a name="line-2418"></a>               <span class='hs-comment'>--     ditto Implicit</span>
<a name="line-2419"></a>               <span class='hs-comment'>-- See Note [Cloning for type variable binders]</span>
<a name="line-2420"></a>
<a name="line-2421"></a>             <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>res_kind</span> <span class='hs-varid'>all_tv_prs</span>
<a name="line-2422"></a>                               <span class='hs-conid'>False</span> <span class='hs-comment'>-- not yet generalised</span>
<a name="line-2423"></a>                               <span class='hs-varid'>flav</span>
<a name="line-2424"></a>
<a name="line-2425"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcInferDeclHeader: not-cusk"</span> <span class='hs-varop'>$</span>
<a name="line-2426"></a>         <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kv_ns</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-2427"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scoped_kvs</span>
<a name="line-2428"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tc_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyConKind</span> <span class='hs-varid'>tc_binders</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-2429"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tycon</span> <span class='hs-layout'>}</span>
<a name="line-2430"></a>  <span class='hs-keyword'>where</span>
<a name="line-2431"></a>    <span class='hs-varid'>ctxt_kind</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcFlavourIsOpen</span> <span class='hs-varid'>flav</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-2432"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-2433"></a>
<a name="line-2434"></a><a name="kcCheckDeclHeader_sig"></a><span class='hs-comment'>-- | Kind-check a declaration header against a standalone kind signature.</span>
<a name="line-2435"></a><span class='hs-comment'>-- See Note [Arity inference in kcCheckDeclHeader_sig]</span>
<a name="line-2436"></a><span class='hs-definition'>kcCheckDeclHeader_sig</span>
<a name="line-2437"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span>              <span class='hs-comment'>-- ^ Standalone kind signature, fully zonked! (zonkTcTypeToType)</span>
<a name="line-2438"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span>              <span class='hs-comment'>-- ^ of the thing being checked</span>
<a name="line-2439"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span>      <span class='hs-comment'>-- ^ What sort of 'TyCon' is being checked</span>
<a name="line-2440"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsQTyVars</span> <span class='hs-conid'>GhcRn</span>  <span class='hs-comment'>-- ^ Binders in the header</span>
<a name="line-2441"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ContextKind</span>   <span class='hs-comment'>-- ^ The result kind. AnyKind == no result signature</span>
<a name="line-2442"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyCon</span>       <span class='hs-comment'>-- ^ A suitably-kinded TcTyCon</span>
<a name="line-2443"></a><span class='hs-definition'>kcCheckDeclHeader_sig</span> <span class='hs-varid'>kisig</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span>
<a name="line-2444"></a>          <span class='hs-layout'>(</span><span class='hs-conid'>HsQTvs</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsq_ext</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_nms</span>
<a name="line-2445"></a>                  <span class='hs-layout'>,</span> <span class='hs-varid'>hsq_explicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>explicit_nms</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>kc_res_ki</span>
<a name="line-2446"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addTyConFlavCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span> <span class='hs-varop'>$</span>
<a name="line-2447"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>  <span class='hs-comment'>-- Step 1: zip user-written binders with quantifiers from the kind signature.</span>
<a name="line-2448"></a>          <span class='hs-comment'>-- For example:</span>
<a name="line-2449"></a>          <span class='hs-comment'>--</span>
<a name="line-2450"></a>          <span class='hs-comment'>--   type F :: forall k -&gt; k -&gt; forall j. j -&gt; Type</span>
<a name="line-2451"></a>          <span class='hs-comment'>--   data F i a b = ...</span>
<a name="line-2452"></a>          <span class='hs-comment'>--</span>
<a name="line-2453"></a>          <span class='hs-comment'>-- Results in the following 'zipped_binders':</span>
<a name="line-2454"></a>          <span class='hs-comment'>--</span>
<a name="line-2455"></a>          <span class='hs-comment'>--                   TyBinder      LHsTyVarBndr</span>
<a name="line-2456"></a>          <span class='hs-comment'>--    ---------------------------------------</span>
<a name="line-2457"></a>          <span class='hs-comment'>--    ZippedBinder   forall k -&gt;   i</span>
<a name="line-2458"></a>          <span class='hs-comment'>--    ZippedBinder   k -&gt;          a</span>
<a name="line-2459"></a>          <span class='hs-comment'>--    ZippedBinder   forall j.</span>
<a name="line-2460"></a>          <span class='hs-comment'>--    ZippedBinder   j -&gt;          b</span>
<a name="line-2461"></a>          <span class='hs-comment'>--</span>
<a name="line-2462"></a>          <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>zipped_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>excess_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>kisig'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zipBinders</span> <span class='hs-varid'>kisig</span> <span class='hs-varid'>explicit_nms</span>
<a name="line-2463"></a>
<a name="line-2464"></a>          <span class='hs-comment'>-- Report binders that don't have a corresponding quantifier.</span>
<a name="line-2465"></a>          <span class='hs-comment'>-- For example:</span>
<a name="line-2466"></a>          <span class='hs-comment'>--</span>
<a name="line-2467"></a>          <span class='hs-comment'>--   type T :: Type -&gt; Type</span>
<a name="line-2468"></a>          <span class='hs-comment'>--   data T b1 b2 b3 = ...</span>
<a name="line-2469"></a>          <span class='hs-comment'>--</span>
<a name="line-2470"></a>          <span class='hs-comment'>-- Here, b1 is zipped with Type-&gt;, while b2 and b3 are excess binders.</span>
<a name="line-2471"></a>          <span class='hs-comment'>--</span>
<a name="line-2472"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>excess_bndrs</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tooManyBindersErr</span> <span class='hs-varid'>kisig'</span> <span class='hs-varid'>excess_bndrs</span><span class='hs-layout'>)</span>
<a name="line-2473"></a>
<a name="line-2474"></a>          <span class='hs-comment'>-- Convert each ZippedBinder to TyConBinder        for  tyConBinders</span>
<a name="line-2475"></a>          <span class='hs-comment'>--                       and to [(Name, TcTyVar)]  for  tcTyConScopedTyVars</span>
<a name="line-2476"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>vis_tcbs</span><span class='hs-layout'>,</span> <span class='hs-varid'>concat</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>explicit_tv_prs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapAndUnzipM</span> <span class='hs-varid'>zipped_to_tcb</span> <span class='hs-varid'>zipped_binders</span>
<a name="line-2477"></a>
<a name="line-2478"></a>        <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>implicit_tvs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>invis_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>r_ki</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2479"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndSolveEqualitiesX</span> <span class='hs-str'>"kcCheckDeclHeader_sig"</span> <span class='hs-varop'>$</span>  <span class='hs-comment'>-- #16687</span>
<a name="line-2480"></a>                <span class='hs-varid'>bindImplicitTKBndrs_Tv</span> <span class='hs-varid'>implicit_nms</span>                  <span class='hs-varop'>$</span>
<a name="line-2481"></a>                <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-varid'>explicit_tv_prs</span>                 <span class='hs-varop'>$</span>
<a name="line-2482"></a>                <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Check that inline kind annotations on binders are valid.</span>
<a name="line-2483"></a>                     <span class='hs-comment'>-- For example:</span>
<a name="line-2484"></a>                     <span class='hs-comment'>--</span>
<a name="line-2485"></a>                     <span class='hs-comment'>--   type T :: Maybe k -&gt; Type</span>
<a name="line-2486"></a>                     <span class='hs-comment'>--   data T (a :: Maybe j) = ...</span>
<a name="line-2487"></a>                     <span class='hs-comment'>--</span>
<a name="line-2488"></a>                     <span class='hs-comment'>-- Here we unify   Maybe k ~ Maybe j</span>
<a name="line-2489"></a>                     <span class='hs-varid'>mapM_</span> <span class='hs-varid'>check_zipped_binder</span> <span class='hs-varid'>zipped_binders</span>
<a name="line-2490"></a>
<a name="line-2491"></a>                     <span class='hs-comment'>-- Kind-check the result kind annotation, if present:</span>
<a name="line-2492"></a>                     <span class='hs-comment'>--</span>
<a name="line-2493"></a>                     <span class='hs-comment'>--    data T a b :: res_ki where</span>
<a name="line-2494"></a>                     <span class='hs-comment'>--               ^^^^^^^^^</span>
<a name="line-2495"></a>                     <span class='hs-comment'>-- We do it here because at this point the environment has been</span>
<a name="line-2496"></a>                     <span class='hs-comment'>-- extended with both 'implicit_tcv_prs' and 'explicit_tv_prs'.</span>
<a name="line-2497"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>ctx_k</span>    <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>kc_res_ki</span>
<a name="line-2498"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>m_res_ki</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctx_k</span> <span class='hs-keyword'>of</span>
<a name="line-2499"></a>                                  <span class='hs-conid'>AnyKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-2500"></a>                                  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctx_k</span>
<a name="line-2501"></a>
<a name="line-2502"></a>                     <span class='hs-comment'>-- Step 2: split off invisible binders.</span>
<a name="line-2503"></a>                     <span class='hs-comment'>-- For example:</span>
<a name="line-2504"></a>                     <span class='hs-comment'>--</span>
<a name="line-2505"></a>                     <span class='hs-comment'>--   type F :: forall k1 k2. (k1, k2) -&gt; Type</span>
<a name="line-2506"></a>                     <span class='hs-comment'>--   type family F</span>
<a name="line-2507"></a>                     <span class='hs-comment'>--</span>
<a name="line-2508"></a>                     <span class='hs-comment'>-- Does 'forall k1 k2' become a part of 'tyConBinders' or 'tyConResKind'?</span>
<a name="line-2509"></a>                     <span class='hs-comment'>-- See Note [Arity inference in kcCheckDeclHeader_sig]</span>
<a name="line-2510"></a>                   <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>invis_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>r_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>split_invis</span> <span class='hs-varid'>kisig'</span> <span class='hs-varid'>m_res_ki</span>
<a name="line-2511"></a>
<a name="line-2512"></a>                     <span class='hs-comment'>-- Check that the inline result kind annotation is valid.</span>
<a name="line-2513"></a>                     <span class='hs-comment'>-- For example:</span>
<a name="line-2514"></a>                     <span class='hs-comment'>--</span>
<a name="line-2515"></a>                     <span class='hs-comment'>--   type T :: Type -&gt; Maybe k</span>
<a name="line-2516"></a>                     <span class='hs-comment'>--   type family T a :: Maybe j where</span>
<a name="line-2517"></a>                     <span class='hs-comment'>--</span>
<a name="line-2518"></a>                     <span class='hs-comment'>-- Here we unify   Maybe k ~ Maybe j</span>
<a name="line-2519"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>whenIsJust</span> <span class='hs-varid'>m_res_ki</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>res_ki</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2520"></a>                      <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- See Note [discardResult in kcCheckDeclHeader_sig]</span>
<a name="line-2521"></a>                      <span class='hs-varid'>unifyKind</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>r_ki</span> <span class='hs-varid'>res_ki</span>
<a name="line-2522"></a>
<a name="line-2523"></a>                   <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>invis_binders</span><span class='hs-layout'>,</span> <span class='hs-varid'>r_ki</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2524"></a>
<a name="line-2525"></a>        <span class='hs-comment'>-- Convert each invisible TyCoBinder to TyConBinder for tyConBinders.</span>
<a name="line-2526"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>invis_tcbs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>invis_to_tcb</span> <span class='hs-varid'>invis_binders</span>
<a name="line-2527"></a>
<a name="line-2528"></a>        <span class='hs-comment'>-- Zonk the implicitly quantified variables.</span>
<a name="line-2529"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>implicit_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-2530"></a>
<a name="line-2531"></a>        <span class='hs-comment'>-- Build the final, generalized TcTyCon</span>
<a name="line-2532"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tcbs</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vis_tcbs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>invis_tcbs</span>
<a name="line-2533"></a>              <span class='hs-varid'>implicit_tv_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_nms</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>implicit_tvs</span>
<a name="line-2534"></a>              <span class='hs-varid'>all_tv_prs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implicit_tv_prs</span> <span class='hs-varop'>++</span> <span class='hs-varid'>explicit_tv_prs</span>
<a name="line-2535"></a>              <span class='hs-varid'>tc</span>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTcTyCon</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tcbs</span> <span class='hs-varid'>r_ki</span> <span class='hs-varid'>all_tv_prs</span> <span class='hs-conid'>True</span> <span class='hs-varid'>flav</span>
<a name="line-2536"></a>              <span class='hs-varid'>skol_info</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TyConSkol</span> <span class='hs-varid'>flav</span> <span class='hs-varid'>name</span>
<a name="line-2537"></a>
<a name="line-2538"></a>        <span class='hs-comment'>-- Check that there are no unsolved equalities</span>
<a name="line-2539"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>reportUnsolvedEqualities</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVars</span> <span class='hs-varid'>tcbs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-2540"></a>
<a name="line-2541"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kcCheckDeclHeader_sig done:"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>vcat</span>
<a name="line-2542"></a>          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tyConName = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConName</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2543"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"kisig ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>debugPprType</span> <span class='hs-varid'>kisig</span>
<a name="line-2544"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tyConKind ="</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>debugPprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2545"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tyConBinders = "</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2546"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tcTyConScopedTyVars"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcTyConScopedTyVars</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2547"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"tyConResKind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>debugPprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-2548"></a>          <span class='hs-keyglyph'>]</span>
<a name="line-2549"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>}</span>
<a name="line-2550"></a>  <span class='hs-keyword'>where</span>
<a name="line-2551"></a>    <span class='hs-comment'>-- Consider this declaration:</span>
<a name="line-2552"></a>    <span class='hs-comment'>--</span>
<a name="line-2553"></a>    <span class='hs-comment'>--    type T :: forall a. forall b -&gt; (a~b) =&gt; Proxy a -&gt; Type</span>
<a name="line-2554"></a>    <span class='hs-comment'>--    data T x p = MkT</span>
<a name="line-2555"></a>    <span class='hs-comment'>--</span>
<a name="line-2556"></a>    <span class='hs-comment'>-- Here, we have every possible variant of ZippedBinder:</span>
<a name="line-2557"></a>    <span class='hs-comment'>--</span>
<a name="line-2558"></a>    <span class='hs-comment'>--                   TyBinder           LHsTyVarBndr</span>
<a name="line-2559"></a>    <span class='hs-comment'>--    ----------------------------------------------</span>
<a name="line-2560"></a>    <span class='hs-comment'>--    ZippedBinder   forall {k}.</span>
<a name="line-2561"></a>    <span class='hs-comment'>--    ZippedBinder   forall (a::k).</span>
<a name="line-2562"></a>    <span class='hs-comment'>--    ZippedBinder   forall (b::k) -&gt;   x</span>
<a name="line-2563"></a>    <span class='hs-comment'>--    ZippedBinder   (a~b) =&gt;</span>
<a name="line-2564"></a>    <span class='hs-comment'>--    ZippedBinder   Proxy a -&gt;         p</span>
<a name="line-2565"></a>    <span class='hs-comment'>--</span>
<a name="line-2566"></a>    <span class='hs-comment'>-- Given a ZippedBinder zipped_to_tcb produces:</span>
<a name="line-2567"></a>    <span class='hs-comment'>--</span>
<a name="line-2568"></a>    <span class='hs-comment'>--  * TyConBinder      for  tyConBinders</span>
<a name="line-2569"></a>    <span class='hs-comment'>--  * (Name, TcTyVar)  for  tcTyConScopedTyVars, if there's a user-written LHsTyVarBndr</span>
<a name="line-2570"></a>    <span class='hs-comment'>--</span>
<a name="line-2571"></a>    <span class='hs-varid'>zipped_to_tcb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZippedBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConBinder</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2572"></a>    <span class='hs-varid'>zipped_to_tcb</span> <span class='hs-varid'>zb</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>zb</span> <span class='hs-keyword'>of</span>
<a name="line-2573"></a>
<a name="line-2574"></a>      <span class='hs-comment'>-- Inferred variable, no user-written binder.</span>
<a name="line-2575"></a>      <span class='hs-comment'>-- Example:   forall {k}.</span>
<a name="line-2576"></a>      <span class='hs-conid'>ZippedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Specified</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2577"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNamedTyConBinder</span> <span class='hs-conid'>Specified</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-2578"></a>
<a name="line-2579"></a>      <span class='hs-comment'>-- Specified variable, no user-written binder.</span>
<a name="line-2580"></a>      <span class='hs-comment'>-- Example:   forall (a::k).</span>
<a name="line-2581"></a>      <span class='hs-conid'>ZippedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Inferred</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2582"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkNamedTyConBinder</span> <span class='hs-conid'>Inferred</span> <span class='hs-varid'>v</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-2583"></a>
<a name="line-2584"></a>      <span class='hs-comment'>-- Constraint, no user-written binder.</span>
<a name="line-2585"></a>      <span class='hs-comment'>-- Example:   (a~b) =&gt;</span>
<a name="line-2586"></a>      <span class='hs-conid'>ZippedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-conid'>InvisArg</span> <span class='hs-varid'>bndr_ki</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-2587"></a>        <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newSysName</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarOccFS</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsLit</span> <span class='hs-str'>"ev"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2588"></a>        <span class='hs-keyword'>let</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>name</span> <span class='hs-layout'>(</span><span class='hs-varid'>scaledThing</span> <span class='hs-varid'>bndr_ki</span><span class='hs-layout'>)</span>
<a name="line-2589"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkAnonTyConBinder</span> <span class='hs-conid'>InvisArg</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-2590"></a>
<a name="line-2591"></a>      <span class='hs-comment'>-- Non-dependent visible argument with a user-written binder.</span>
<a name="line-2592"></a>      <span class='hs-comment'>-- Example:   Proxy a -&gt;</span>
<a name="line-2593"></a>      <span class='hs-conid'>ZippedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-conid'>VisArg</span> <span class='hs-varid'>bndr_ki</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2594"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-2595"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>v_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>b</span>
<a name="line-2596"></a>              <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-varid'>v_name</span> <span class='hs-layout'>(</span><span class='hs-varid'>scaledThing</span> <span class='hs-varid'>bndr_ki</span><span class='hs-layout'>)</span>
<a name="line-2597"></a>              <span class='hs-varid'>tcb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAnonTyConBinder</span> <span class='hs-conid'>VisArg</span> <span class='hs-varid'>tv</span>
<a name="line-2598"></a>          <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>v_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2599"></a>
<a name="line-2600"></a>      <span class='hs-comment'>-- Dependent visible argument with a user-written binder.</span>
<a name="line-2601"></a>      <span class='hs-comment'>-- Example:   forall (b::k) -&gt;</span>
<a name="line-2602"></a>      <span class='hs-conid'>ZippedBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>v</span> <span class='hs-conid'>Required</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2603"></a>        <span class='hs-varid'>return</span> <span class='hs-varop'>$</span>
<a name="line-2604"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>v_name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getName</span> <span class='hs-varid'>b</span>
<a name="line-2605"></a>              <span class='hs-varid'>tcb</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkNamedTyConBinder</span> <span class='hs-conid'>Required</span> <span class='hs-varid'>v</span>
<a name="line-2606"></a>          <span class='hs-keyword'>in</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>v_name</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-2607"></a>
<a name="line-2608"></a>      <span class='hs-comment'>-- 'zipBinders' does not produce any other variants of ZippedBinder.</span>
<a name="line-2609"></a>      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"goVis: invalid ZippedBinder"</span>
<a name="line-2610"></a>
<a name="line-2611"></a>    <span class='hs-comment'>-- Given an invisible binder that comes from 'split_invis',</span>
<a name="line-2612"></a>    <span class='hs-comment'>-- convert it to TyConBinder.</span>
<a name="line-2613"></a>    <span class='hs-varid'>invis_to_tcb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCoBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TyConBinder</span>
<a name="line-2614"></a>    <span class='hs-varid'>invis_to_tcb</span> <span class='hs-varid'>tb</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-2615"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span><span class='hs-layout'>,</span> <span class='hs-varid'>stv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipped_to_tcb</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZippedBinder</span> <span class='hs-varid'>tb</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-2616"></a>      <span class='hs-conid'>MASSERT</span><span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>stv</span><span class='hs-layout'>)</span>
<a name="line-2617"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>tcb</span>
<a name="line-2618"></a>
<a name="line-2619"></a>    <span class='hs-comment'>-- Check that the inline kind annotation on a binder is valid</span>
<a name="line-2620"></a>    <span class='hs-comment'>-- by unifying it with the kind of the quantifier.</span>
<a name="line-2621"></a>    <span class='hs-varid'>check_zipped_binder</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ZippedBinder</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-2622"></a>    <span class='hs-varid'>check_zipped_binder</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZippedBinder</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2623"></a>    <span class='hs-varid'>check_zipped_binder</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZippedBinder</span> <span class='hs-varid'>tb</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2624"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>unLoc</span> <span class='hs-varid'>b</span> <span class='hs-keyword'>of</span>
<a name="line-2625"></a>        <span class='hs-conid'>UserTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-2626"></a>        <span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>v</span> <span class='hs-varid'>v_hs_ki</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-2627"></a>          <span class='hs-varid'>v_ki</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLHsKindSig</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarBndrKindCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>v_hs_ki</span>
<a name="line-2628"></a>          <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span> <span class='hs-comment'>-- See Note [discardResult in kcCheckDeclHeader_sig]</span>
<a name="line-2629"></a>            <span class='hs-varid'>unifyKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2630"></a>                      <span class='hs-layout'>(</span><span class='hs-varid'>tyBinderType</span> <span class='hs-varid'>tb</span><span class='hs-layout'>)</span>
<a name="line-2631"></a>                      <span class='hs-varid'>v_ki</span>
<a name="line-2632"></a>
<a name="line-2633"></a>    <span class='hs-comment'>-- Split the invisible binders that should become a part of 'tyConBinders'</span>
<a name="line-2634"></a>    <span class='hs-comment'>-- rather than 'tyConResKind'.</span>
<a name="line-2635"></a>    <span class='hs-comment'>-- See Note [Arity inference in kcCheckDeclHeader_sig]</span>
<a name="line-2636"></a>    <span class='hs-varid'>split_invis</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyCoBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-2637"></a>    <span class='hs-varid'>split_invis</span> <span class='hs-varid'>sig_ki</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span>
<a name="line-2638"></a>      <span class='hs-comment'>-- instantiate all invisible binders</span>
<a name="line-2639"></a>      <span class='hs-varid'>splitInvisPiTys</span> <span class='hs-varid'>sig_ki</span>
<a name="line-2640"></a>    <span class='hs-varid'>split_invis</span> <span class='hs-varid'>sig_ki</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>res_ki</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-2641"></a>      <span class='hs-comment'>-- subtraction a la checkExpectedKind</span>
<a name="line-2642"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>n_res_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invisibleTyBndrCount</span> <span class='hs-varid'>res_ki</span>
<a name="line-2643"></a>          <span class='hs-varid'>n_sig_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>invisibleTyBndrCount</span> <span class='hs-varid'>sig_ki</span>
<a name="line-2644"></a>          <span class='hs-varid'>n_inst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n_sig_invis_bndrs</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n_res_invis_bndrs</span>
<a name="line-2645"></a>      <span class='hs-keyword'>in</span> <span class='hs-varid'>splitInvisPiTysN</span> <span class='hs-varid'>n_inst</span> <span class='hs-varid'>sig_ki</span>
<a name="line-2646"></a>
<a name="line-2647"></a><a name="ZippedBinder"></a><span class='hs-comment'>-- A quantifier from a kind signature zipped with a user-written binder for it.</span>
<a name="line-2648"></a><a name="ZippedBinder"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ZippedBinder</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ZippedBinder</span> <span class='hs-conid'>TyBinder</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>()</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2649"></a>
<a name="line-2650"></a><a name="zipBinders"></a><span class='hs-comment'>-- See Note [Arity inference in kcCheckDeclHeader_sig]</span>
<a name="line-2651"></a><span class='hs-definition'>zipBinders</span>
<a name="line-2652"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span>                      <span class='hs-comment'>-- Kind signature</span>
<a name="line-2653"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>()</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>   <span class='hs-comment'>-- User-written binders</span>
<a name="line-2654"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ZippedBinder</span><span class='hs-keyglyph'>]</span>          <span class='hs-comment'>-- Zipped binders</span>
<a name="line-2655"></a>     <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>()</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Leftover user-written binders</span>
<a name="line-2656"></a>     <span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span> <span class='hs-layout'>)</span>                  <span class='hs-comment'>-- Remainder of the kind signature</span>
<a name="line-2657"></a><span class='hs-definition'>zipBinders</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zip_binders</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>emptyTCvSubst</span>
<a name="line-2658"></a>  <span class='hs-keyword'>where</span>
<a name="line-2659"></a>    <span class='hs-comment'>-- subst: we substitute as we go, to ensure that the resulting</span>
<a name="line-2660"></a>    <span class='hs-comment'>-- binders in the [ZippedBndr] all have distinct uniques.</span>
<a name="line-2661"></a>    <span class='hs-comment'>-- If not, the TyCon may get multiple binders with the same unique,</span>
<a name="line-2662"></a>    <span class='hs-comment'>-- which results in chaos (see #19092,3,4)</span>
<a name="line-2663"></a>    <span class='hs-comment'>-- (The incoming kind might be forall k. k -&gt; forall k. k -&gt; Type</span>
<a name="line-2664"></a>    <span class='hs-comment'>--  where those two k's have the same unique. Without the substitution</span>
<a name="line-2665"></a>    <span class='hs-comment'>--  we'd get a repeated 'k'.)</span>
<a name="line-2666"></a>    <span class='hs-varid'>zip_binders</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>bs</span>
<a name="line-2667"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>b</span><span class='hs-conop'>:</span><span class='hs-varid'>bs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bs</span>  <span class='hs-comment'>-- Stop as soon as 'bs' becomes empty</span>
<a name="line-2668"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tb</span><span class='hs-layout'>,</span><span class='hs-varid'>ki'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitPiTy_maybe</span> <span class='hs-varid'>ki</span>
<a name="line-2669"></a>      <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tb'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyCoBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tb</span>
<a name="line-2670"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isInvisibleBinder</span> <span class='hs-varid'>tb</span>
<a name="line-2671"></a>        <span class='hs-keyword'>then</span> <span class='hs-varid'>zip_binders</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZippedBinder</span> <span class='hs-varid'>tb'</span> <span class='hs-conid'>Nothing</span>  <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ki'</span> <span class='hs-varid'>bs</span>
<a name="line-2672"></a>        <span class='hs-keyword'>else</span> <span class='hs-varid'>zip_binders</span> <span class='hs-layout'>(</span><span class='hs-conid'>ZippedBinder</span> <span class='hs-varid'>tb'</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>ki'</span> <span class='hs-varid'>bs'</span>
<a name="line-2673"></a>
<a name="line-2674"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-2675"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>bs</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span>
<a name="line-2676"></a>
<a name="line-2677"></a><a name="tooManyBindersErr"></a><span class='hs-definition'>tooManyBindersErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>()</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-2678"></a><span class='hs-definition'>tooManyBindersErr</span> <span class='hs-varid'>ki</span> <span class='hs-varid'>bndrs</span> <span class='hs-keyglyph'>=</span>
<a name="line-2679"></a>   <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Not a function kind:"</span><span class='hs-layout'>)</span>
<a name="line-2680"></a>      <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ki</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span>
<a name="line-2681"></a>   <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"but extra binders found:"</span><span class='hs-layout'>)</span>
<a name="line-2682"></a>      <span class='hs-num'>4</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-2683"></a>
<a name="line-2684"></a><span class='hs-comment'>{- Note [Arity inference in kcCheckDeclHeader_sig]
<a name="line-2685"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2686"></a>Given a kind signature 'kisig' and a declaration header, kcCheckDeclHeader_sig
<a name="line-2687"></a>verifies that the declaration conforms to the signature. The end result is a
<a name="line-2688"></a>TcTyCon 'tc' such that:
<a name="line-2689"></a>
<a name="line-2690"></a>  tyConKind tc == kisig
<a name="line-2691"></a>
<a name="line-2692"></a>This TcTyCon would be rather easy to produce if we didn't have to worry about
<a name="line-2693"></a>arity. Consider these declarations:
<a name="line-2694"></a>
<a name="line-2695"></a>  type family S1 :: forall k. k -&gt; Type
<a name="line-2696"></a>  type family S2 (a :: k) :: Type
<a name="line-2697"></a>
<a name="line-2698"></a>Both S1 and S2 can be given the same standalone kind signature:
<a name="line-2699"></a>
<a name="line-2700"></a>  type S2 :: forall k. k -&gt; Type
<a name="line-2701"></a>
<a name="line-2702"></a>And, indeed, tyConKind S1 == tyConKind S2. However, tyConKind is built from
<a name="line-2703"></a>tyConBinders and tyConResKind, such that
<a name="line-2704"></a>
<a name="line-2705"></a>  tyConKind tc == mkTyConKind (tyConBinders tc) (tyConResKind tc)
<a name="line-2706"></a>
<a name="line-2707"></a>For S1 and S2, tyConBinders and tyConResKind are different:
<a name="line-2708"></a>
<a name="line-2709"></a>  tyConBinders S1  ==  []
<a name="line-2710"></a>  tyConResKind S1  ==  forall k. k -&gt; Type
<a name="line-2711"></a>  tyConKind    S1  ==  forall k. k -&gt; Type
<a name="line-2712"></a>
<a name="line-2713"></a>  tyConBinders S2  ==  [spec k, anon-vis (a :: k)]
<a name="line-2714"></a>  tyConResKind S2  ==  Type
<a name="line-2715"></a>  tyConKind    S1  ==  forall k. k -&gt; Type
<a name="line-2716"></a>
<a name="line-2717"></a>This difference determines the arity:
<a name="line-2718"></a>
<a name="line-2719"></a>  tyConArity tc == length (tyConBinders tc)
<a name="line-2720"></a>
<a name="line-2721"></a>That is, the arity of S1 is 0, while the arity of S2 is 2.
<a name="line-2722"></a>
<a name="line-2723"></a>'kcCheckDeclHeader_sig' needs to infer the desired arity to split the standalone
<a name="line-2724"></a>kind signature into binders and the result kind. It does so in two rounds:
<a name="line-2725"></a>
<a name="line-2726"></a>1. zip user-written binders (vis_tcbs)
<a name="line-2727"></a>2. split off invisible binders (invis_tcbs)
<a name="line-2728"></a>
<a name="line-2729"></a>Consider the following declarations:
<a name="line-2730"></a>
<a name="line-2731"></a>    type F :: Type -&gt; forall j. j -&gt; forall k1 k2. (k1, k2) -&gt; Type
<a name="line-2732"></a>    type family F a b
<a name="line-2733"></a>
<a name="line-2734"></a>    type G :: Type -&gt; forall j. j -&gt; forall k1 k2. (k1, k2) -&gt; Type
<a name="line-2735"></a>    type family G a b :: forall r2. (r1, r2) -&gt; Type
<a name="line-2736"></a>
<a name="line-2737"></a>In step 1 (zip user-written binders), we zip the quantifiers in the signature
<a name="line-2738"></a>with the binders in the header using 'zipBinders'. In both F and G, this results in
<a name="line-2739"></a>the following zipped binders:
<a name="line-2740"></a>
<a name="line-2741"></a>                   TyBinder     LHsTyVarBndr
<a name="line-2742"></a>    ---------------------------------------
<a name="line-2743"></a>    ZippedBinder   Type -&gt;      a
<a name="line-2744"></a>    ZippedBinder   forall j.
<a name="line-2745"></a>    ZippedBinder   j -&gt;         b
<a name="line-2746"></a>
<a name="line-2747"></a>
<a name="line-2748"></a>At this point, we have accumulated three zipped binders which correspond to a
<a name="line-2749"></a>prefix of the standalone kind signature:
<a name="line-2750"></a>
<a name="line-2751"></a>  Type -&gt; forall j. j -&gt; ...
<a name="line-2752"></a>
<a name="line-2753"></a>In step 2 (split off invisible binders), we have to decide how much remaining
<a name="line-2754"></a>invisible binders of the standalone kind signature to split off:
<a name="line-2755"></a>
<a name="line-2756"></a>    forall k1 k2. (k1, k2) -&gt; Type
<a name="line-2757"></a>    ^^^^^^^^^^^^^
<a name="line-2758"></a>    split off or not?
<a name="line-2759"></a>
<a name="line-2760"></a>This decision is made in 'split_invis':
<a name="line-2761"></a>
<a name="line-2762"></a>* If a user-written result kind signature is not provided, as in F,
<a name="line-2763"></a>  then split off all invisible binders. This is why we need special treatment
<a name="line-2764"></a>  for AnyKind.
<a name="line-2765"></a>* If a user-written result kind signature is provided, as in G,
<a name="line-2766"></a>  then do as checkExpectedKind does and split off (n_sig - n_res) binders.
<a name="line-2767"></a>  That is, split off such an amount of binders that the remainder of the
<a name="line-2768"></a>  standalone kind signature and the user-written result kind signature have the
<a name="line-2769"></a>  same amount of invisible quantifiers.
<a name="line-2770"></a>
<a name="line-2771"></a>For F, split_invis splits away all invisible binders, and we have 2:
<a name="line-2772"></a>
<a name="line-2773"></a>    forall k1 k2. (k1, k2) -&gt; Type
<a name="line-2774"></a>    ^^^^^^^^^^^^^
<a name="line-2775"></a>    split away both binders
<a name="line-2776"></a>
<a name="line-2777"></a>The resulting arity of F is 3+2=5.  (length vis_tcbs = 3,
<a name="line-2778"></a>                                     length invis_tcbs = 2,
<a name="line-2779"></a>                                     length tcbs = 5)
<a name="line-2780"></a>
<a name="line-2781"></a>For G, split_invis decides to split off 1 invisible binder, so that we have the
<a name="line-2782"></a>same amount of invisible quantifiers left:
<a name="line-2783"></a>
<a name="line-2784"></a>    res_ki  =  forall    r2. (r1, r2) -&gt; Type
<a name="line-2785"></a>    kisig   =  forall k1 k2. (k1, k2) -&gt; Type
<a name="line-2786"></a>                     ^^^
<a name="line-2787"></a>                     split off this one.
<a name="line-2788"></a>
<a name="line-2789"></a>The resulting arity of G is 3+1=4. (length vis_tcbs = 3,
<a name="line-2790"></a>                                    length invis_tcbs = 1,
<a name="line-2791"></a>                                    length tcbs = 4)
<a name="line-2792"></a>
<a name="line-2793"></a>-}</span>
<a name="line-2794"></a>
<a name="line-2795"></a><span class='hs-comment'>{- Note [discardResult in kcCheckDeclHeader_sig]
<a name="line-2796"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2797"></a>We use 'unifyKind' to check inline kind annotations in declaration headers
<a name="line-2798"></a>against the signature.
<a name="line-2799"></a>
<a name="line-2800"></a>  type T :: [i] -&gt; Maybe j -&gt; Type
<a name="line-2801"></a>  data T (a :: [k1]) (b :: Maybe k2) :: Type where ...
<a name="line-2802"></a>
<a name="line-2803"></a>Here, we will unify:
<a name="line-2804"></a>
<a name="line-2805"></a>       [k1] ~ [i]
<a name="line-2806"></a>  Maybe k2  ~ Maybe j
<a name="line-2807"></a>      Type  ~ Type
<a name="line-2808"></a>
<a name="line-2809"></a>The end result is that we fill in unification variables k1, k2:
<a name="line-2810"></a>
<a name="line-2811"></a>    k1  :=  i
<a name="line-2812"></a>    k2  :=  j
<a name="line-2813"></a>
<a name="line-2814"></a>We also validate that the user isn't confused:
<a name="line-2815"></a>
<a name="line-2816"></a>  type T :: Type -&gt; Type
<a name="line-2817"></a>  data T (a :: Bool) = ...
<a name="line-2818"></a>
<a name="line-2819"></a>This will report that (Type ~ Bool) failed to unify.
<a name="line-2820"></a>
<a name="line-2821"></a>Now, consider the following example:
<a name="line-2822"></a>
<a name="line-2823"></a>  type family Id a where Id x = x
<a name="line-2824"></a>  type T :: Bool -&gt; Type
<a name="line-2825"></a>  type T (a :: Id Bool) = ...
<a name="line-2826"></a>
<a name="line-2827"></a>We will unify (Bool ~ Id Bool), and this will produce a non-reflexive coercion.
<a name="line-2828"></a>However, we are free to discard it, as the kind of 'T' is determined by the
<a name="line-2829"></a>signature, not by the inline kind annotation:
<a name="line-2830"></a>
<a name="line-2831"></a>      we have   T ::    Bool -&gt; Type
<a name="line-2832"></a>  rather than   T :: Id Bool -&gt; Type
<a name="line-2833"></a>
<a name="line-2834"></a>This (Id Bool) will not show up anywhere after we're done validating it, so we
<a name="line-2835"></a>have no use for the produced coercion.
<a name="line-2836"></a>-}</span>
<a name="line-2837"></a>
<a name="line-2838"></a><span class='hs-comment'>{- Note [No polymorphic recursion]
<a name="line-2839"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2840"></a>Should this kind-check?
<a name="line-2841"></a>  data T ka (a::ka) b  = MkT (T Type           Int   Bool)
<a name="line-2842"></a>                             (T (Type -&gt; Type) Maybe Bool)
<a name="line-2843"></a>
<a name="line-2844"></a>Notice that T is used at two different kinds in its RHS.  No!
<a name="line-2845"></a>This should not kind-check.  Polymorphic recursion is known to
<a name="line-2846"></a>be a tough nut.
<a name="line-2847"></a>
<a name="line-2848"></a>Previously, we laboriously (with help from the renamer)
<a name="line-2849"></a>tried to give T the polymorphic kind
<a name="line-2850"></a>   T :: forall ka -&gt; ka -&gt; kappa -&gt; Type
<a name="line-2851"></a>where kappa is a unification variable, even in the inferInitialKinds
<a name="line-2852"></a>phase (which is what kcInferDeclHeader is all about).  But
<a name="line-2853"></a>that is dangerously fragile (see the ticket).
<a name="line-2854"></a>
<a name="line-2855"></a>Solution: make kcInferDeclHeader give T a straightforward
<a name="line-2856"></a>monomorphic kind, with no quantification whatsoever. That's why
<a name="line-2857"></a>we use mkAnonTyConBinder for all arguments when figuring out
<a name="line-2858"></a>tc_binders.
<a name="line-2859"></a>
<a name="line-2860"></a>But notice that (#16322 comment:3)
<a name="line-2861"></a>
<a name="line-2862"></a>* The algorithm successfully kind-checks this declaration:
<a name="line-2863"></a>    data T2 ka (a::ka) = MkT2 (T2 Type a)
<a name="line-2864"></a>
<a name="line-2865"></a>  Starting with (inferInitialKinds)
<a name="line-2866"></a>    T2 :: (kappa1 :: kappa2 :: *) -&gt; (kappa3 :: kappa4 :: *) -&gt; *
<a name="line-2867"></a>  we get
<a name="line-2868"></a>    kappa4 := kappa1   -- from the (a:ka) kind signature
<a name="line-2869"></a>    kappa1 := Type     -- From application T2 Type
<a name="line-2870"></a>
<a name="line-2871"></a>  These constraints are soluble so generaliseTcTyCon gives
<a name="line-2872"></a>    T2 :: forall (k::Type) -&gt; k -&gt; *
<a name="line-2873"></a>
<a name="line-2874"></a>  But now the /typechecking/ (aka desugaring, tcTyClDecl) phase
<a name="line-2875"></a>  fails, because the call (T2 Type a) in the RHS is ill-kinded.
<a name="line-2876"></a>
<a name="line-2877"></a>  We'd really prefer all errors to show up in the kind checking
<a name="line-2878"></a>  phase.
<a name="line-2879"></a>
<a name="line-2880"></a>* This algorithm still accepts (in all phases)
<a name="line-2881"></a>     data T3 ka (a::ka) = forall b. MkT3 (T3 Type b)
<a name="line-2882"></a>  although T3 is really polymorphic-recursive too.
<a name="line-2883"></a>  Perhaps we should somehow reject that.
<a name="line-2884"></a>
<a name="line-2885"></a>Note [Kind variable ordering for associated types]
<a name="line-2886"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-2887"></a>What should be the kind of `T` in the following example? (#15591)
<a name="line-2888"></a>
<a name="line-2889"></a>  class C (a :: Type) where
<a name="line-2890"></a>    type T (x :: f a)
<a name="line-2891"></a>
<a name="line-2892"></a>As per Note [Ordering of implicit variables] in GHC.Rename.HsType, we want to quantify
<a name="line-2893"></a>the kind variables in left-to-right order of first occurrence in order to
<a name="line-2894"></a>support visible kind application. But we cannot perform this analysis on just
<a name="line-2895"></a>T alone, since its variable `a` actually occurs /before/ `f` if you consider
<a name="line-2896"></a>the fact that `a` was previously bound by the parent class `C`. That is to say,
<a name="line-2897"></a>the kind of `T` should end up being:
<a name="line-2898"></a>
<a name="line-2899"></a>  T :: forall a f. f a -&gt; Type
<a name="line-2900"></a>
<a name="line-2901"></a>(It wouldn't necessarily be /wrong/ if the kind ended up being, say,
<a name="line-2902"></a>forall f a. f a -&gt; Type, but that would not be as predictable for users of
<a name="line-2903"></a>visible kind application.)
<a name="line-2904"></a>
<a name="line-2905"></a>In contrast, if `T` were redefined to be a top-level type family, like `T2`
<a name="line-2906"></a>below:
<a name="line-2907"></a>
<a name="line-2908"></a>  type family T2 (x :: f (a :: Type))
<a name="line-2909"></a>
<a name="line-2910"></a>Then `a` first appears /after/ `f`, so the kind of `T2` should be:
<a name="line-2911"></a>
<a name="line-2912"></a>  T2 :: forall f a. f a -&gt; Type
<a name="line-2913"></a>
<a name="line-2914"></a>In order to make this distinction, we need to know (in kcCheckDeclHeader) which
<a name="line-2915"></a>type variables have been bound by the parent class (if there is one). With
<a name="line-2916"></a>the class-bound variables in hand, we can ensure that we always quantify
<a name="line-2917"></a>these first.
<a name="line-2918"></a>-}</span>
<a name="line-2919"></a>
<a name="line-2920"></a>
<a name="line-2921"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2922"></a>*                                                                      *
<a name="line-2923"></a>             Expected kinds
<a name="line-2924"></a>*                                                                      *
<a name="line-2925"></a>********************************************************************* -}</span>
<a name="line-2926"></a>
<a name="line-2927"></a><a name="ContextKind"></a><span class='hs-comment'>-- | Describes the kind expected in a certain context.</span>
<a name="line-2928"></a><a name="ContextKind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-conid'>Kind</span>   <span class='hs-comment'>-- ^ a specific kind</span>
<a name="line-2929"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnyKind</span>        <span class='hs-comment'>-- ^ any kind will do</span>
<a name="line-2930"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OpenKind</span>       <span class='hs-comment'>-- ^ something of the form @TYPE _@</span>
<a name="line-2931"></a>
<a name="line-2932"></a><a name="newExpectedKind"></a><span class='hs-comment'>-----------------------</span>
<a name="line-2933"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ContextKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-2934"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TheKind</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>k</span>
<a name="line-2935"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-conid'>AnyKind</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-2936"></a><span class='hs-definition'>newExpectedKind</span> <span class='hs-conid'>OpenKind</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-2937"></a>
<a name="line-2938"></a><a name="expectedKindInCtxt"></a><span class='hs-comment'>-----------------------</span>
<a name="line-2939"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ContextKind</span>
<a name="line-2940"></a><span class='hs-comment'>-- Depending on the context, we might accept any kind (for instance, in a TH</span>
<a name="line-2941"></a><span class='hs-comment'>-- splice), or only certain kinds (like in type signatures).</span>
<a name="line-2942"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TySynCtxt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-2943"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>GhciCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-2944"></a><span class='hs-comment'>-- The types in a 'default' decl can have varying kinds</span>
<a name="line-2945"></a><span class='hs-comment'>-- See Note [Extended defaults]" in GHC.Tc.Utils.Env</span>
<a name="line-2946"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>DefaultDeclCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-2947"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>DerivClauseCtxt</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-2948"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>TypeAppCtxt</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-2949"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>ForSigCtxt</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-2950"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>InstDeclCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>constraintKind</span>
<a name="line-2951"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-conid'>SpecInstCtxt</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TheKind</span> <span class='hs-varid'>constraintKind</span>
<a name="line-2952"></a><span class='hs-definition'>expectedKindInCtxt</span> <span class='hs-keyword'>_</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>OpenKind</span>
<a name="line-2953"></a>
<a name="line-2954"></a>
<a name="line-2955"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-2956"></a>*                                                                      *
<a name="line-2957"></a>             Bringing type variables into scope
<a name="line-2958"></a>*                                                                      *
<a name="line-2959"></a>********************************************************************* -}</span>
<a name="line-2960"></a>
<a name="line-2961"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-2962"></a><span class='hs-comment'>--    HsForAllTelescope</span>
<a name="line-2963"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-2964"></a>
<a name="line-2965"></a><a name="tcTKTelescope"></a><span class='hs-definition'>tcTKTelescope</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-2966"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsForAllTelescope</span> <span class='hs-conid'>GhcRn</span>
<a name="line-2967"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2968"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVarBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2969"></a><span class='hs-definition'>tcTKTelescope</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>tele</span> <span class='hs-varid'>thing_inside</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tele</span> <span class='hs-keyword'>of</span>
<a name="line-2970"></a>  <span class='hs-conid'>HsForAllVis</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsf_vis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>}</span>
<a name="line-2971"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>req_tv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2972"></a>            <span class='hs-comment'>-- req_tv_bndrs :: [VarBndr TyVar ()],</span>
<a name="line-2973"></a>            <span class='hs-comment'>-- but we want [VarBndr TyVar ArgFlag]</span>
<a name="line-2974"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarReqToBinders</span> <span class='hs-varid'>req_tv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2975"></a>
<a name="line-2976"></a>  <span class='hs-conid'>HsForAllInvis</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsf_invis_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bndrs</span> <span class='hs-layout'>}</span>
<a name="line-2977"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>inv_tv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2978"></a>            <span class='hs-comment'>-- inv_tv_bndrs :: [VarBndr TyVar Specificity],</span>
<a name="line-2979"></a>            <span class='hs-comment'>-- but we want [VarBndr TyVar ArgFlag]</span>
<a name="line-2980"></a>          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarSpecToBinders</span> <span class='hs-varid'>inv_tv_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2981"></a>  <span class='hs-keyword'>where</span>
<a name="line-2982"></a>    <span class='hs-varid'>skol_mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mode_holes</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>}</span>
<a name="line-2983"></a>
<a name="line-2984"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-2985"></a><span class='hs-comment'>--    HsOuterTyVarBndrs</span>
<a name="line-2986"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-2987"></a>
<a name="line-2988"></a><a name="bindOuterTKBndrsX"></a><span class='hs-definition'>bindOuterTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutputableBndrFlag</span> <span class='hs-varid'>flag</span> <span class='hs-chr'>'</span><span class='hs-conid'>Renamed</span>
<a name="line-2989"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SkolemMode</span>
<a name="line-2990"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span>
<a name="line-2991"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2992"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-2993"></a><span class='hs-definition'>bindOuterTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>outer_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2994"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>outer_bndrs</span> <span class='hs-keyword'>of</span>
<a name="line-2995"></a>      <span class='hs-conid'>HsOuterImplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_ximplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_tvs</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-2996"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>imp_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-2997"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsOuterImplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_ximplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_tvs'</span><span class='hs-layout'>}</span>
<a name="line-2998"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-2999"></a>      <span class='hs-conid'>HsOuterExplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_bndrs</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3000"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>exp_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3001"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsOuterExplicit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hso_xexplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_tvs'</span>
<a name="line-3002"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>hso_bndrs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_bndrs</span> <span class='hs-layout'>}</span>
<a name="line-3003"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3004"></a>
<a name="line-3005"></a><a name="getOuterTyVars"></a><span class='hs-definition'>getOuterTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcTc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3006"></a><span class='hs-comment'>-- The returned [TcTyVar] is not necessarily in dependency order</span>
<a name="line-3007"></a><span class='hs-comment'>-- at least for the HsOuterImplicit case</span>
<a name="line-3008"></a><span class='hs-definition'>getOuterTyVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterImplicit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hso_ximplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span>
<a name="line-3009"></a><span class='hs-definition'>getOuterTyVars</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterExplicit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hso_xexplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvbs</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>binderVars</span> <span class='hs-varid'>tvbs</span>
<a name="line-3010"></a>
<a name="line-3011"></a><a name="scopedSortOuter"></a><span class='hs-comment'>---------------</span>
<a name="line-3012"></a><span class='hs-definition'>scopedSortOuter</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-conid'>Specificity</span> <span class='hs-conid'>GhcTc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-3013"></a><span class='hs-comment'>-- Sort any /implicit/ binders into dependency order</span>
<a name="line-3014"></a><span class='hs-comment'>--     (zonking first so we can see the dependencies)</span>
<a name="line-3015"></a><span class='hs-comment'>-- /Explicit/ ones are already in the right order</span>
<a name="line-3016"></a><span class='hs-definition'>scopedSortOuter</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterImplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_ximplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_tvs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3017"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>imp_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkAndScopedSort</span> <span class='hs-varid'>imp_tvs</span>
<a name="line-3018"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-conid'>SpecifiedSpec</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>imp_tvs</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>}</span>
<a name="line-3019"></a><span class='hs-definition'>scopedSortOuter</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterExplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_xexplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_tvs</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3020"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- No need to dependency-sort (or zonk) explicit quantifiers</span>
<a name="line-3021"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>exp_tvs</span>
<a name="line-3022"></a>
<a name="line-3023"></a><a name="bindOuterSigTKBndrs_Tv"></a><span class='hs-comment'>---------------</span>
<a name="line-3024"></a><span class='hs-definition'>bindOuterSigTKBndrs_Tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsOuterSigTyVarBndrs</span> <span class='hs-conid'>GhcRn</span>
<a name="line-3025"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterSigTyVarBndrs</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3026"></a><span class='hs-definition'>bindOuterSigTKBndrs_Tv</span>
<a name="line-3027"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindOuterTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3028"></a>
<a name="line-3029"></a><a name="bindOuterSigTKBndrs_Tv_M"></a><span class='hs-definition'>bindOuterSigTKBndrs_Tv_M</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span>
<a name="line-3030"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOuterSigTyVarBndrs</span> <span class='hs-conid'>GhcRn</span>
<a name="line-3031"></a>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterSigTyVarBndrs</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3032"></a><span class='hs-comment'>-- Do not push level; do not make implication constraint; use Tvs</span>
<a name="line-3033"></a><span class='hs-comment'>-- Two major clients of this "bind-only" path are:</span>
<a name="line-3034"></a><span class='hs-comment'>--    Note [Using TyVarTvs for kind-checking GADTs] in GHC.Tc.TyCl</span>
<a name="line-3035"></a><span class='hs-comment'>--    Note [Checking partial type signatures]</span>
<a name="line-3036"></a><span class='hs-definition'>bindOuterSigTKBndrs_Tv_M</span> <span class='hs-varid'>mode</span>
<a name="line-3037"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindOuterTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3038"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>sm_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mode_holes</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3039"></a>
<a name="line-3040"></a><a name="bindOuterFamEqnTKBndrs_Q_Tv"></a><span class='hs-definition'>bindOuterFamEqnTKBndrs_Q_Tv</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsOuterFamEqnTyVarBndrs</span> <span class='hs-conid'>GhcRn</span>
<a name="line-3041"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3042"></a>                            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3043"></a><span class='hs-definition'>bindOuterFamEqnTKBndrs_Q_Tv</span> <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3044"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftFstM</span> <span class='hs-varid'>getOuterTyVars</span> <span class='hs-varop'>$</span>
<a name="line-3045"></a>    <span class='hs-varid'>bindOuterTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3046"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3047"></a>                      <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3048"></a>    <span class='hs-comment'>-- sm_clone=False: see Note [Cloning for type variable binders]</span>
<a name="line-3049"></a>
<a name="line-3050"></a><a name="bindOuterFamEqnTKBndrs"></a><span class='hs-definition'>bindOuterFamEqnTKBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HsOuterFamEqnTyVarBndrs</span> <span class='hs-conid'>GhcRn</span>
<a name="line-3051"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3052"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3053"></a><span class='hs-definition'>bindOuterFamEqnTKBndrs</span> <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3054"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftFstM</span> <span class='hs-varid'>getOuterTyVars</span> <span class='hs-varop'>$</span>
<a name="line-3055"></a>    <span class='hs-varid'>bindOuterTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3056"></a>                      <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3057"></a>    <span class='hs-comment'>-- sm_clone=False: see Note [Cloning for type variable binders]</span>
<a name="line-3058"></a>
<a name="line-3059"></a><a name="tcOuterTKBndrs"></a><span class='hs-comment'>---------------</span>
<a name="line-3060"></a><span class='hs-definition'>tcOuterTKBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutputableBndrFlag</span> <span class='hs-varid'>flag</span> <span class='hs-chr'>'</span><span class='hs-conid'>Renamed</span>
<a name="line-3061"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-3062"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span>
<a name="line-3063"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3064"></a><span class='hs-definition'>tcOuterTKBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcOuterTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3065"></a>  <span class='hs-comment'>-- Do not clone the outer binders</span>
<a name="line-3066"></a>  <span class='hs-comment'>-- See Note [Cloning for type variable binder] under "must not"</span>
<a name="line-3067"></a>
<a name="line-3068"></a><a name="tcOuterTKBndrsX"></a><span class='hs-definition'>tcOuterTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutputableBndrFlag</span> <span class='hs-varid'>flag</span> <span class='hs-chr'>'</span><span class='hs-conid'>Renamed</span>
<a name="line-3069"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SkolemMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-3070"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span>
<a name="line-3071"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsOuterTyVarBndrs</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcTc</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3072"></a><span class='hs-comment'>-- Push level, capture constraints, make implication</span>
<a name="line-3073"></a><span class='hs-definition'>tcOuterTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>outer_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3074"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>outer_bndrs</span> <span class='hs-keyword'>of</span>
<a name="line-3075"></a>      <span class='hs-conid'>HsOuterImplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_ximplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_tvs</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3076"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>imp_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcImplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>imp_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3077"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsOuterImplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_ximplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>imp_tvs'</span><span class='hs-layout'>}</span>
<a name="line-3078"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3079"></a>      <span class='hs-conid'>HsOuterExplicit</span><span class='hs-layout'>{</span><span class='hs-varid'>hso_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_bndrs</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3080"></a>        <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>exp_tvs'</span><span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>exp_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3081"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-conid'>HsOuterExplicit</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hso_xexplicit</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_tvs'</span>
<a name="line-3082"></a>                                      <span class='hs-layout'>,</span> <span class='hs-varid'>hso_bndrs</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp_bndrs</span> <span class='hs-layout'>}</span>
<a name="line-3083"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3084"></a>
<a name="line-3085"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3086"></a><span class='hs-comment'>--    Explicit tyvar binders</span>
<a name="line-3087"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3088"></a>
<a name="line-3089"></a><a name="tcExplicitTKBndrs"></a><span class='hs-definition'>tcExplicitTKBndrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutputableBndrFlag</span> <span class='hs-varid'>flag</span> <span class='hs-chr'>'</span><span class='hs-conid'>Renamed</span>
<a name="line-3090"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-3091"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3092"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>flag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3093"></a><span class='hs-definition'>tcExplicitTKBndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3094"></a>
<a name="line-3095"></a><a name="tcExplicitTKBndrsX"></a><span class='hs-definition'>tcExplicitTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>OutputableBndrFlag</span> <span class='hs-varid'>flag</span> <span class='hs-chr'>'</span><span class='hs-conid'>Renamed</span>
<a name="line-3096"></a>                   <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SkolemMode</span>
<a name="line-3097"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-3098"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3099"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>flag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3100"></a><span class='hs-comment'>-- Push level, capture constraints,</span>
<a name="line-3101"></a><span class='hs-comment'>-- and emit an implication constraint with a ForAllSkol ic_info,</span>
<a name="line-3102"></a><span class='hs-comment'>-- so that it is subject to a telescope test.</span>
<a name="line-3103"></a><span class='hs-definition'>tcExplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3104"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3105"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndCaptureConstraints</span> <span class='hs-varop'>$</span>
<a name="line-3106"></a>                <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>$</span>
<a name="line-3107"></a>                <span class='hs-varid'>thing_inside</span>
<a name="line-3108"></a>
<a name="line-3109"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ForAllSkol</span> <span class='hs-layout'>(</span><span class='hs-varid'>fsep</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>bndrs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3110"></a>             <span class='hs-comment'>-- Notice that we use ForAllSkol here, ignoring the enclosing</span>
<a name="line-3111"></a>             <span class='hs-comment'>-- skol_info unlike tc_implicit_tk_bndrs, because the bad-telescope</span>
<a name="line-3112"></a>             <span class='hs-comment'>-- test applies only to ForAllSkol</span>
<a name="line-3113"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitResidualTvConstraint</span> <span class='hs-varid'>skol_info</span> <span class='hs-layout'>(</span><span class='hs-varid'>binderVars</span> <span class='hs-varid'>skol_tvs</span><span class='hs-layout'>)</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-3114"></a>
<a name="line-3115"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3116"></a>
<a name="line-3117"></a><a name="bindExplicitTKBndrs_Skol"></a><span class='hs-comment'>----------------</span>
<a name="line-3118"></a><span class='hs-comment'>-- | Skolemise the 'HsTyVarBndr's in an 'HsForAllTelescope' with the supplied</span>
<a name="line-3119"></a><span class='hs-comment'>-- 'TcTyMode'.</span>
<a name="line-3120"></a><span class='hs-definition'>bindExplicitTKBndrs_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Tv</span>
<a name="line-3121"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndrFlag</span> <span class='hs-varid'>flag</span> <span class='hs-chr'>'</span><span class='hs-conid'>Renamed</span><span class='hs-layout'>)</span>
<a name="line-3122"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-3123"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3124"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>flag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3125"></a>
<a name="line-3126"></a><span class='hs-definition'>bindExplicitTKBndrs_Skol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3127"></a><a name="bindExplicitTKBndrs_Tv"></a><span class='hs-definition'>bindExplicitTKBndrs_Tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3128"></a>   <span class='hs-comment'>-- sm_clone: see Note [Cloning for type variable binders]</span>
<a name="line-3129"></a>
<a name="line-3130"></a><a name="bindExplicitTKBndrs_Q_Skol"></a><span class='hs-definition'>bindExplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindExplicitTKBndrs_Q_Tv</span>
<a name="line-3131"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ContextKind</span>
<a name="line-3132"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-conid'>()</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-3133"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3134"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3135"></a><span class='hs-comment'>-- These do not clone: see Note [Cloning for type variable binders]</span>
<a name="line-3136"></a><span class='hs-definition'>bindExplicitTKBndrs_Q_Skol</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3137"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftFstM</span> <span class='hs-varid'>binderVars</span> <span class='hs-varop'>$</span>
<a name="line-3138"></a>    <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3139"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>sm_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3140"></a>                         <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3141"></a>    <span class='hs-comment'>-- sm_clone=False: see Note [Cloning for type variable binders]</span>
<a name="line-3142"></a>
<a name="line-3143"></a><a name="bindExplicitTKBndrs_Q_Tv"></a><span class='hs-definition'>bindExplicitTKBndrs_Q_Tv</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3144"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftFstM</span> <span class='hs-varid'>binderVars</span> <span class='hs-varop'>$</span>
<a name="line-3145"></a>    <span class='hs-varid'>bindExplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-3146"></a>                                    <span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3147"></a>                         <span class='hs-varid'>hs_bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3148"></a>    <span class='hs-comment'>-- sm_clone=False: see Note [Cloning for type variable binders]</span>
<a name="line-3149"></a>
<a name="line-3150"></a><a name="bindExplicitTKBndrsX"></a><span class='hs-definition'>bindExplicitTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>OutputableBndrFlag</span> <span class='hs-varid'>flag</span> <span class='hs-chr'>'</span><span class='hs-conid'>Renamed</span><span class='hs-layout'>)</span>
<a name="line-3151"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>SkolemMode</span>
<a name="line-3152"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsTyVarBndr</span> <span class='hs-varid'>flag</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span>
<a name="line-3153"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3154"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>VarBndr</span> <span class='hs-conid'>TyVar</span> <span class='hs-varid'>flag</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Returned [TcTyVar] are in 1-1 correspondence</span>
<a name="line-3155"></a>                                      <span class='hs-comment'>-- with the passed-in [LHsTyVarBndr]</span>
<a name="line-3156"></a><span class='hs-definition'>bindExplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_parent</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-3157"></a>                                   <span class='hs-layout'>,</span> <span class='hs-varid'>sm_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hole_info</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3158"></a>                     <span class='hs-varid'>hs_tvs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3159"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"bindExplicitTKBndrs"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span>
<a name="line-3160"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>hs_tvs</span> <span class='hs-layout'>}</span>
<a name="line-3161"></a>  <span class='hs-keyword'>where</span>
<a name="line-3162"></a>    <span class='hs-varid'>tc_ki_mode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode_tyki</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>KindLevel</span><span class='hs-layout'>,</span> <span class='hs-varid'>mode_holes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hole_info</span> <span class='hs-layout'>}</span>
<a name="line-3163"></a>                 <span class='hs-comment'>-- Inherit the HoleInfo from the context</span>
<a name="line-3164"></a>
<a name="line-3165"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3166"></a>               <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3167"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_tv</span> <span class='hs-conop'>:</span> <span class='hs-varid'>hs_tvs</span><span class='hs-layout'>)</span>
<a name="line-3168"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclTypeEnv</span>
<a name="line-3169"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_hs_bndr</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>hs_tv</span>
<a name="line-3170"></a>            <span class='hs-comment'>-- Extend the environment as we go, in case a binder</span>
<a name="line-3171"></a>            <span class='hs-comment'>-- is mentioned in the kind of a later binder</span>
<a name="line-3172"></a>            <span class='hs-comment'>--   e.g. forall k (a::k). blah</span>
<a name="line-3173"></a>            <span class='hs-comment'>-- NB: tv's Name may differ from hs_tv's</span>
<a name="line-3174"></a>            <span class='hs-comment'>-- See Note [Cloning for type variable binders]</span>
<a name="line-3175"></a>            <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span><span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-varid'>hsTyVarName</span> <span class='hs-varid'>hs_tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-varop'>$</span>
<a name="line-3176"></a>                           <span class='hs-varid'>go</span> <span class='hs-varid'>hs_tvs</span>
<a name="line-3177"></a>            <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsTyVarBndrFlag</span> <span class='hs-varid'>hs_tv</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3178"></a>
<a name="line-3179"></a>
<a name="line-3180"></a>    <span class='hs-varid'>tc_hs_bndr</span> <span class='hs-varid'>lcl_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>UserTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3181"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>check_parent</span>
<a name="line-3182"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>name</span>
<a name="line-3183"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span>
<a name="line-3184"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3185"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-3186"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>newTyVarBndr</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-3187"></a>
<a name="line-3188"></a>    <span class='hs-varid'>tc_hs_bndr</span> <span class='hs-varid'>lcl_env</span> <span class='hs-layout'>(</span><span class='hs-conid'>KindedTyVar</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span><span class='hs-layout'>)</span>
<a name="line-3189"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>check_parent</span>
<a name="line-3190"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>name</span>
<a name="line-3191"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind_sig</span> <span class='hs-varid'>tc_ki_mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarBndrKindCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span>
<a name="line-3192"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>discardResult</span> <span class='hs-varop'>$</span>
<a name="line-3193"></a>             <span class='hs-varid'>unifyKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-3194"></a>                          <span class='hs-comment'>-- This unify rejects:</span>
<a name="line-3195"></a>                          <span class='hs-comment'>--    class C (m :: * -&gt; *) where</span>
<a name="line-3196"></a>                          <span class='hs-comment'>--      type F (m :: *) = ...</span>
<a name="line-3197"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>}</span>
<a name="line-3198"></a>
<a name="line-3199"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3200"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_kind_sig</span> <span class='hs-varid'>tc_ki_mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyVarBndrKindCtxt</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>lhs_kind</span>
<a name="line-3201"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>newTyVarBndr</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-3202"></a>
<a name="line-3203"></a><a name="newTyVarBndr"></a><span class='hs-definition'>newTyVarBndr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcTyVar</span>
<a name="line-3204"></a><span class='hs-definition'>newTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-conid'>SM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clone</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvtv</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-3205"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>clone</span> <span class='hs-keyword'>of</span>
<a name="line-3206"></a>              <span class='hs-conid'>True</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uniq</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUnique</span>
<a name="line-3207"></a>                         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>setNameUnique</span> <span class='hs-varid'>name</span> <span class='hs-varid'>uniq</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3208"></a>              <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>name</span>
<a name="line-3209"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>details</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tvtv</span> <span class='hs-keyword'>of</span>
<a name="line-3210"></a>                 <span class='hs-conid'>True</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newMetaDetails</span> <span class='hs-conid'>TyVarTv</span>
<a name="line-3211"></a>                 <span class='hs-conid'>False</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lvl</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTcLevel</span>
<a name="line-3212"></a>                             <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>SkolemTv</span> <span class='hs-varid'>lvl</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3213"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTcTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-varid'>details</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3214"></a>
<a name="line-3215"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3216"></a><span class='hs-comment'>--    Implicit tyvar binders</span>
<a name="line-3217"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3218"></a>
<a name="line-3219"></a><a name="tcImplicitTKBndrsX"></a><span class='hs-definition'>tcImplicitTKBndrsX</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SkolemInfo</span>
<a name="line-3220"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-3221"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3222"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3223"></a><span class='hs-comment'>-- The workhorse:</span>
<a name="line-3224"></a><span class='hs-comment'>--    push level, capture constraints,</span>
<a name="line-3225"></a><span class='hs-comment'>--    and emit an implication constraint with a ForAllSkol ic_info,</span>
<a name="line-3226"></a><span class='hs-comment'>--    so that it is subject to a telescope test.</span>
<a name="line-3227"></a><span class='hs-definition'>tcImplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>bndrs</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tclvl</span><span class='hs-layout'>,</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3229"></a>             <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>pushLevelAndCaptureConstraints</span>       <span class='hs-varop'>$</span>
<a name="line-3230"></a>                <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>bndrs</span> <span class='hs-varop'>$</span>
<a name="line-3231"></a>                <span class='hs-varid'>thing_inside</span>
<a name="line-3232"></a>
<a name="line-3233"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>emitResidualTvConstraint</span> <span class='hs-varid'>skol_info</span> <span class='hs-varid'>skol_tvs</span> <span class='hs-varid'>tclvl</span> <span class='hs-varid'>wanted</span>
<a name="line-3234"></a>
<a name="line-3235"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>skol_tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3236"></a>
<a name="line-3237"></a><a name="bindImplicitTKBndrs_Skol"></a><span class='hs-comment'>------------------</span>
<a name="line-3238"></a><span class='hs-definition'>bindImplicitTKBndrs_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Tv</span><span class='hs-layout'>,</span>
<a name="line-3239"></a>  <span class='hs-varid'>bindImplicitTKBndrs_Q_Skol</span><span class='hs-layout'>,</span> <span class='hs-varid'>bindImplicitTKBndrs_Q_Tv</span>
<a name="line-3240"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-3241"></a><span class='hs-definition'>bindImplicitTKBndrs_Skol</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3242"></a><a name="bindImplicitTKBndrs_Tv"></a><span class='hs-definition'>bindImplicitTKBndrs_Tv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3243"></a><a name="bindImplicitTKBndrs_Q_Skol"></a><span class='hs-definition'>bindImplicitTKBndrs_Q_Skol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3244"></a><a name="bindImplicitTKBndrs_Q_Tv"></a><span class='hs-definition'>bindImplicitTKBndrs_Q_Tv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>bindImplicitTKBndrsX</span> <span class='hs-layout'>(</span><span class='hs-varid'>smVanilla</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3245"></a>
<a name="line-3246"></a><a name="bindImplicitTKBndrsX"></a><span class='hs-definition'>bindImplicitTKBndrsX</span>
<a name="line-3247"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemMode</span>
<a name="line-3248"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-3249"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3250"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>   <span class='hs-comment'>-- Returned [TcTyVar] are in 1-1 correspondence</span>
<a name="line-3251"></a>                           <span class='hs-comment'>-- with the passed in [Name]</span>
<a name="line-3252"></a><span class='hs-definition'>bindImplicitTKBndrsX</span> <span class='hs-varid'>skol_mode</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>SM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>check_parent</span><span class='hs-layout'>,</span> <span class='hs-varid'>sm_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt_kind</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-3253"></a>                     <span class='hs-varid'>tv_names</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3254"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLclTypeEnv</span>
<a name="line-3255"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>new_tv</span> <span class='hs-varid'>lcl_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv_names</span>
<a name="line-3256"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"bindImplicitTKBndrsX"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_names</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tkvs</span><span class='hs-layout'>)</span>
<a name="line-3257"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-layout'>(</span><span class='hs-varid'>tv_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>tkvs</span><span class='hs-layout'>)</span>
<a name="line-3258"></a>                <span class='hs-varid'>thing_inside</span>
<a name="line-3259"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tkvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3260"></a>  <span class='hs-keyword'>where</span>
<a name="line-3261"></a>    <span class='hs-varid'>new_tv</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>name</span>
<a name="line-3262"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>check_parent</span>
<a name="line-3263"></a>      <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>lookupNameEnv</span> <span class='hs-varid'>lcl_env</span> <span class='hs-varid'>name</span>
<a name="line-3264"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>tv</span>
<a name="line-3265"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3266"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-3267"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>newTyVarBndr</span> <span class='hs-varid'>skol_mode</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-3268"></a>
<a name="line-3269"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3270"></a><span class='hs-comment'>--           SkolemMode</span>
<a name="line-3271"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3272"></a>
<a name="line-3273"></a><a name="SkolemMode"></a><span class='hs-comment'>-- | 'SkolemMode' describes how to typecheck an explicit ('HsTyVarBndr') or</span>
<a name="line-3274"></a><a name="SkolemMode"></a><span class='hs-comment'>-- implicit ('Name') binder in a type. It is just a record of flags</span>
<a name="line-3275"></a><a name="SkolemMode"></a><span class='hs-comment'>-- that describe what sort of 'TcTyVar' to create.</span>
<a name="line-3276"></a><a name="SkolemMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SkolemMode</span>
<a name="line-3277"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- True &lt;=&gt; check the in-scope parent type variable</span>
<a name="line-3278"></a>                              <span class='hs-comment'>-- Used only for asssociated types</span>
<a name="line-3279"></a>
<a name="line-3280"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>sm_clone</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- True &lt;=&gt; fresh unique</span>
<a name="line-3281"></a>                              <span class='hs-comment'>-- See Note [Cloning for type variable binders]</span>
<a name="line-3282"></a>
<a name="line-3283"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- True &lt;=&gt; use a TyVarTv, rather than SkolemTv</span>
<a name="line-3284"></a>                              <span class='hs-comment'>-- Why?  See Note [Inferring kinds for type declarations]</span>
<a name="line-3285"></a>                              <span class='hs-comment'>-- in GHC.Tc.TyCl, and (in this module)</span>
<a name="line-3286"></a>                              <span class='hs-comment'>-- Note [Checking partial type signatures]</span>
<a name="line-3287"></a>
<a name="line-3288"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>sm_kind</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ContextKind</span>  <span class='hs-comment'>-- Use this for the kind of any new binders</span>
<a name="line-3289"></a>
<a name="line-3290"></a>       <span class='hs-layout'>,</span> <span class='hs-varid'>sm_holes</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>HoleInfo</span>     <span class='hs-comment'>-- What to do for wildcards in the kind</span>
<a name="line-3291"></a>       <span class='hs-layout'>}</span>
<a name="line-3292"></a>
<a name="line-3293"></a><a name="smVanilla"></a><span class='hs-definition'>smVanilla</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SkolemMode</span>
<a name="line-3294"></a><span class='hs-definition'>smVanilla</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>SM</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sm_clone</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"sm_clone"</span>  <span class='hs-comment'>-- We always override this</span>
<a name="line-3295"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>sm_parent</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3296"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>sm_tvtv</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3297"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>sm_kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyKind</span>
<a name="line-3298"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>sm_holes</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span> <span class='hs-layout'>}</span>
<a name="line-3299"></a>
<a name="line-3300"></a><span class='hs-comment'>{- Note [Cloning for type variable binders]
<a name="line-3301"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3302"></a>Sometimes we must clone the Name of a type variable binder (written in
<a name="line-3303"></a>the source program); and sometimes we must not. This is controlled by
<a name="line-3304"></a>the sm_clone field of SkolemMode.
<a name="line-3305"></a>
<a name="line-3306"></a>In some cases it doesn't matter whether or not we clone. Perhaps
<a name="line-3307"></a>it'd be better to use MustClone/MayClone/MustNotClone.
<a name="line-3308"></a>
<a name="line-3309"></a>When we /must not/ clone
<a name="line-3310"></a>* In the binders of a type signature (tcOuterTKBndrs)
<a name="line-3311"></a>      f :: forall a{27}. blah
<a name="line-3312"></a>      f = rhs
<a name="line-3313"></a>  Then 'a' scopes over 'rhs'. When we kind-check the signature (tcHsSigType),
<a name="line-3314"></a>  we must get the type (forall a{27}. blah) for the Id f, because
<a name="line-3315"></a>  we bring that type variable into scope when we typecheck 'rhs'.
<a name="line-3316"></a>
<a name="line-3317"></a>* In the binders of a data family instance (bindOuterFamEqnTKBndrs)
<a name="line-3318"></a>     data instance
<a name="line-3319"></a>       forall p q. D (p,q) = D1 p | D2 q
<a name="line-3320"></a>  We kind-check the LHS in tcDataFamInstHeader, and then separately
<a name="line-3321"></a>  (in tcDataFamInstDecl) bring p,q into scope before looking at the
<a name="line-3322"></a>  the constructor decls.
<a name="line-3323"></a>
<a name="line-3324"></a>* bindExplicitTKBndrs_Q_Tv/bindImplicitTKBndrs_Q_Tv do not clone
<a name="line-3325"></a>  We take advantage of this in kcInferDeclHeader:
<a name="line-3326"></a>     all_tv_prs = mkTyVarNamePairs (scoped_kvs ++ tc_tvs)
<a name="line-3327"></a>  If we cloned, we'd need to take a bit more care here; not hard.
<a name="line-3328"></a>
<a name="line-3329"></a>* bindExplicitTKBndrs_Q_Skol, bindExplicitTKBndrs_Skol, do not clone.
<a name="line-3330"></a>  There is no need, I think.
<a name="line-3331"></a>
<a name="line-3332"></a>  The payoff here is that avoiding gratuitous cloning means that we can
<a name="line-3333"></a>  almost always take the fast path in swizzleTcTyConBndrs.
<a name="line-3334"></a>
<a name="line-3335"></a>When we /must/ clone.
<a name="line-3336"></a>* bindOuterSigTKBndrs_Tv, bindExplicitTKBndrs_Tv do cloning
<a name="line-3337"></a>
<a name="line-3338"></a>  This for a narrow and tricky reason which, alas, I couldn't find a
<a name="line-3339"></a>  simpler way round.  #16221 is the poster child:
<a name="line-3340"></a>
<a name="line-3341"></a>     data SameKind :: k -&gt; k -&gt; *
<a name="line-3342"></a>     data T a = forall k2 (b :: k2). MkT (SameKind a b) !Int
<a name="line-3343"></a>
<a name="line-3344"></a>  When kind-checking T, we give (a :: kappa1). Then:
<a name="line-3345"></a>
<a name="line-3346"></a>  - In kcConDecl we make a TyVarTv unification variable kappa2 for k2
<a name="line-3347"></a>    (as described in Note [Using TyVarTvs for kind-checking GADTs],
<a name="line-3348"></a>    even though this example is an existential)
<a name="line-3349"></a>  - So we get (b :: kappa2) via bindExplicitTKBndrs_Tv
<a name="line-3350"></a>  - We end up unifying kappa1 := kappa2, because of the (SameKind a b)
<a name="line-3351"></a>
<a name="line-3352"></a>  Now we generalise over kappa2. But if kappa2's Name is precisely k2
<a name="line-3353"></a>  (i.e. we did not clone) we'll end up giving T the utterly final kind
<a name="line-3354"></a>    T :: forall k2. k2 -&gt; *
<a name="line-3355"></a>  Nothing directly wrong with that but when we typecheck the data constructor
<a name="line-3356"></a>  we have k2 in scope; but then it's brought into scope /again/ when we find
<a name="line-3357"></a>  the forall k2.  This is chaotic, and we end up giving it the type
<a name="line-3358"></a>    MkT :: forall k2 (a :: k2) k2 (b :: k2).
<a name="line-3359"></a>           SameKind @k2 a b -&gt; Int -&gt; T @{k2} a
<a name="line-3360"></a>  which is bogus -- because of the shadowing of k2, we can't
<a name="line-3361"></a>  apply T to the kind or a!
<a name="line-3362"></a>
<a name="line-3363"></a>  And there no reason /not/ to clone the Name when making a unification
<a name="line-3364"></a>  variable.  So that's what we do.
<a name="line-3365"></a>-}</span>
<a name="line-3366"></a>
<a name="line-3367"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3368"></a><span class='hs-comment'>-- Binding type/class variables in the</span>
<a name="line-3369"></a><span class='hs-comment'>-- kind-checking and typechecking phases</span>
<a name="line-3370"></a><span class='hs-comment'>--------------------------------------</span>
<a name="line-3371"></a>
<a name="line-3372"></a><a name="bindTyClTyVars"></a><span class='hs-definition'>bindTyClTyVars</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span>
<a name="line-3373"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcTyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-3374"></a><span class='hs-comment'>-- ^ Used for the type variables of a type or class decl</span>
<a name="line-3375"></a><span class='hs-comment'>-- in the "kind checking" and "type checking" pass,</span>
<a name="line-3376"></a><span class='hs-comment'>-- but not in the initial-kind run.</span>
<a name="line-3377"></a><span class='hs-definition'>bindTyClTyVars</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varid'>thing_inside</span>
<a name="line-3378"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tycon</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcLookupTcTyCon</span> <span class='hs-varid'>tycon_name</span>
<a name="line-3379"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>scoped_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcTyConScopedTyVars</span> <span class='hs-varid'>tycon</span>
<a name="line-3380"></a>             <span class='hs-varid'>res_kind</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConResKind</span> <span class='hs-varid'>tycon</span>
<a name="line-3381"></a>             <span class='hs-varid'>binders</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyConBinders</span> <span class='hs-varid'>tycon</span>
<a name="line-3382"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"bindTyClTyVars"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tycon_name</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>binders</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>scoped_prs</span><span class='hs-layout'>)</span>
<a name="line-3383"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-varid'>scoped_prs</span> <span class='hs-varop'>$</span>
<a name="line-3384"></a>         <span class='hs-varid'>thing_inside</span> <span class='hs-varid'>tycon</span> <span class='hs-varid'>binders</span> <span class='hs-varid'>res_kind</span> <span class='hs-layout'>}</span>
<a name="line-3385"></a>
<a name="line-3386"></a>
<a name="line-3387"></a><span class='hs-comment'>{- *********************************************************************
<a name="line-3388"></a>*                                                                      *
<a name="line-3389"></a>             Kind generalisation
<a name="line-3390"></a>*                                                                      *
<a name="line-3391"></a>********************************************************************* -}</span>
<a name="line-3392"></a>
<a name="line-3393"></a><a name="zonkAndScopedSort"></a><span class='hs-definition'>zonkAndScopedSort</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TcTyVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3394"></a><span class='hs-definition'>zonkAndScopedSort</span> <span class='hs-varid'>spec_tkvs</span>
<a name="line-3395"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>spec_tkvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcTyVarToTyVar</span> <span class='hs-varid'>spec_tkvs</span>
<a name="line-3396"></a>         <span class='hs-comment'>-- Zonk the kinds, to we can do the dependency analayis</span>
<a name="line-3397"></a>
<a name="line-3398"></a>       <span class='hs-comment'>-- Do a stable topological sort, following</span>
<a name="line-3399"></a>       <span class='hs-comment'>-- Note [Ordering of implicit variables] in GHC.Rename.HsType</span>
<a name="line-3400"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>scopedSort</span> <span class='hs-varid'>spec_tkvs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3401"></a>
<a name="line-3402"></a><a name="kindGeneralizeSome"></a><span class='hs-comment'>-- | Generalize some of the free variables in the given type.</span>
<a name="line-3403"></a><span class='hs-comment'>-- All such variables should be *kind* variables; any type variables</span>
<a name="line-3404"></a><span class='hs-comment'>-- should be explicitly quantified (with a `forall`) before now.</span>
<a name="line-3405"></a><span class='hs-comment'>--</span>
<a name="line-3406"></a><span class='hs-comment'>-- The WantedConstraints are un-solved kind constraints. Generally</span>
<a name="line-3407"></a><span class='hs-comment'>-- they'll be reported as errors later, but meanwhile we refrain</span>
<a name="line-3408"></a><span class='hs-comment'>-- from quantifying over any variable free in these unsolved</span>
<a name="line-3409"></a><span class='hs-comment'>-- constraints. See Note [Failure in local type signatures].</span>
<a name="line-3410"></a><span class='hs-comment'>--</span>
<a name="line-3411"></a><span class='hs-comment'>-- But in all cases, generalize only those variables whose TcLevel is</span>
<a name="line-3412"></a><span class='hs-comment'>-- strictly greater than the ambient level. This "strictly greater</span>
<a name="line-3413"></a><span class='hs-comment'>-- than" means that you likely need to push the level before creating</span>
<a name="line-3414"></a><span class='hs-comment'>-- whatever type gets passed here.</span>
<a name="line-3415"></a><span class='hs-comment'>--</span>
<a name="line-3416"></a><span class='hs-comment'>-- Any variable whose level is greater than the ambient level but is</span>
<a name="line-3417"></a><span class='hs-comment'>-- not selected to be generalized will be promoted. (See [Promoting</span>
<a name="line-3418"></a><span class='hs-comment'>-- unification variables] in "GHC.Tc.Solver" and Note [Recipe for</span>
<a name="line-3419"></a><span class='hs-comment'>-- checking a signature].)</span>
<a name="line-3420"></a><span class='hs-comment'>--</span>
<a name="line-3421"></a><span class='hs-comment'>-- The resulting KindVar are the variables to quantify over, in the</span>
<a name="line-3422"></a><span class='hs-comment'>-- correct, well-scoped order. They should generally be Inferred, not</span>
<a name="line-3423"></a><span class='hs-comment'>-- Specified, but that's really up to the caller of this function.</span>
<a name="line-3424"></a><span class='hs-definition'>kindGeneralizeSome</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span>
<a name="line-3425"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span>    <span class='hs-comment'>-- ^ needn't be zonked</span>
<a name="line-3426"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3427"></a><span class='hs-definition'>kindGeneralizeSome</span> <span class='hs-varid'>wanted</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-3428"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Use the "Kind" variant here, as any types we see</span>
<a name="line-3429"></a>         <span class='hs-comment'>-- here will already have all type variables quantified;</span>
<a name="line-3430"></a>         <span class='hs-comment'>-- thus, every free variable is really a kv, never a tv.</span>
<a name="line-3431"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidateQTyVarsOfKind</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-3432"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>filterConstrainedCandidates</span> <span class='hs-varid'>wanted</span> <span class='hs-varid'>dvs</span>
<a name="line-3433"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>dvs</span> <span class='hs-layout'>}</span>
<a name="line-3434"></a>
<a name="line-3435"></a><a name="filterConstrainedCandidates"></a><span class='hs-definition'>filterConstrainedCandidates</span>
<a name="line-3436"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>WantedConstraints</span>    <span class='hs-comment'>-- Don't quantify over variables free in these</span>
<a name="line-3437"></a>                          <span class='hs-comment'>--   Not necessarily fully zonked</span>
<a name="line-3438"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CandidatesQTvs</span>       <span class='hs-comment'>-- Candidates for quantification</span>
<a name="line-3439"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>CandidatesQTvs</span>
<a name="line-3440"></a><span class='hs-comment'>-- filterConstrainedCandidates removes any candidates that are free in</span>
<a name="line-3441"></a><span class='hs-comment'>-- 'wanted'; instead, it promotes them.  This bit is very much like</span>
<a name="line-3442"></a><span class='hs-comment'>-- decideMonoTyVars in GHC.Tc.Solver, but constraints are so much</span>
<a name="line-3443"></a><span class='hs-comment'>-- simpler in kinds, it is much easier here. (In particular, we never</span>
<a name="line-3444"></a><span class='hs-comment'>-- quantify over a constraint in a type.)</span>
<a name="line-3445"></a><span class='hs-definition'>filterConstrainedCandidates</span> <span class='hs-varid'>wanted</span> <span class='hs-varid'>dvs</span>
<a name="line-3446"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span>   <span class='hs-comment'>-- Fast path for a common case</span>
<a name="line-3447"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>dvs</span>
<a name="line-3448"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3449"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_tvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTyCoVarsAndFV</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfWC</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>)</span>
<a name="line-3450"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>to_promote</span><span class='hs-layout'>,</span> <span class='hs-varid'>dvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partitionCandidates</span> <span class='hs-varid'>dvs</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-varid'>wc_tvs</span><span class='hs-layout'>)</span>
<a name="line-3451"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteTyVarSet</span> <span class='hs-varid'>to_promote</span>
<a name="line-3452"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>dvs'</span> <span class='hs-layout'>}</span>
<a name="line-3453"></a>
<a name="line-3454"></a><a name="kindGeneralizeAll"></a><span class='hs-comment'>-- |- Specialised version of 'kindGeneralizeSome', but with empty</span>
<a name="line-3455"></a><span class='hs-comment'>-- WantedConstraints, so no filtering is needed</span>
<a name="line-3456"></a><span class='hs-comment'>-- i.e.   kindGeneraliseAll = kindGeneralizeSome emptyWC</span>
<a name="line-3457"></a><span class='hs-definition'>kindGeneralizeAll</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>KindVar</span><span class='hs-keyglyph'>]</span>
<a name="line-3458"></a><span class='hs-definition'>kindGeneralizeAll</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-3459"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kindGeneralizeAll"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind_or_type</span><span class='hs-layout'>)</span>
<a name="line-3460"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidateQTyVarsOfKind</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-3461"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>quantifyTyVars</span> <span class='hs-varid'>dvs</span> <span class='hs-layout'>}</span>
<a name="line-3462"></a>
<a name="line-3463"></a><a name="kindGeneralizeNone"></a><span class='hs-comment'>-- | Specialized version of 'kindGeneralizeSome', but where no variables</span>
<a name="line-3464"></a><span class='hs-comment'>-- can be generalized, but perhaps some may need to be promoted.</span>
<a name="line-3465"></a><span class='hs-comment'>-- Use this variant when it is unknowable whether metavariables might</span>
<a name="line-3466"></a><span class='hs-comment'>-- later be constrained.</span>
<a name="line-3467"></a><span class='hs-comment'>--</span>
<a name="line-3468"></a><span class='hs-comment'>-- To see why this promotion is needed, see</span>
<a name="line-3469"></a><span class='hs-comment'>-- Note [Recipe for checking a signature], and especially</span>
<a name="line-3470"></a><span class='hs-comment'>-- Note [Promotion in signatures].</span>
<a name="line-3471"></a><span class='hs-definition'>kindGeneralizeNone</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span>  <span class='hs-comment'>-- needn't be zonked</span>
<a name="line-3472"></a>                   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3473"></a><span class='hs-definition'>kindGeneralizeNone</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-3474"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"kindGeneralizeNone"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind_or_type</span><span class='hs-layout'>)</span>
<a name="line-3475"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dvs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>candidateQTyVarsOfKind</span> <span class='hs-varid'>kind_or_type</span>
<a name="line-3476"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>promoteTyVarSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>candidateKindVars</span> <span class='hs-varid'>dvs</span><span class='hs-layout'>)</span>
<a name="line-3477"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-3478"></a>
<a name="line-3479"></a><span class='hs-comment'>{- Note [Levels and generalisation]
<a name="line-3480"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3481"></a>Consider
<a name="line-3482"></a>  f x = e
<a name="line-3483"></a>with no type signature. We are currently at level i.
<a name="line-3484"></a>We must
<a name="line-3485"></a>  * Push the level to level (i+1)
<a name="line-3486"></a>  * Allocate a fresh alpha[i+1] for the result type
<a name="line-3487"></a>  * Check that e :: alpha[i+1], gathering constraint WC
<a name="line-3488"></a>  * Solve WC as far as possible
<a name="line-3489"></a>  * Zonking the result type alpha[i+1], say to beta[i-1] -&gt; gamma[i]
<a name="line-3490"></a>  * Find the free variables with level &gt; i, in this case gamma[i]
<a name="line-3491"></a>  * Skolemise those free variables and quantify over them, giving
<a name="line-3492"></a>       f :: forall g. beta[i-1] -&gt; g
<a name="line-3493"></a>  * Emit the residiual constraint wrapped in an implication for g,
<a name="line-3494"></a>    thus   forall g. WC
<a name="line-3495"></a>
<a name="line-3496"></a>All of this happens for types too.  Consider
<a name="line-3497"></a>  f :: Int -&gt; (forall a. Proxy a -&gt; Int)
<a name="line-3498"></a>
<a name="line-3499"></a>Note [Kind generalisation]
<a name="line-3500"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3501"></a>We do kind generalisation only at the outer level of a type signature.
<a name="line-3502"></a>For example, consider
<a name="line-3503"></a>  T :: forall k. k -&gt; *
<a name="line-3504"></a>  f :: (forall a. T a -&gt; Int) -&gt; Int
<a name="line-3505"></a>When kind-checking f's type signature we generalise the kind at
<a name="line-3506"></a>the outermost level, thus:
<a name="line-3507"></a>  f1 :: forall k. (forall (a:k). T k a -&gt; Int) -&gt; Int  -- YES!
<a name="line-3508"></a>and *not* at the inner forall:
<a name="line-3509"></a>  f2 :: (forall k. forall (a:k). T k a -&gt; Int) -&gt; Int  -- NO!
<a name="line-3510"></a>Reason: same as for HM inference on value level declarations,
<a name="line-3511"></a>we want to infer the most general type.  The f2 type signature
<a name="line-3512"></a>would be *less applicable* than f1, because it requires a more
<a name="line-3513"></a>polymorphic argument.
<a name="line-3514"></a>
<a name="line-3515"></a>NB: There are no explicit kind variables written in f's signature.
<a name="line-3516"></a>When there are, the renamer adds these kind variables to the list of
<a name="line-3517"></a>variables bound by the forall, so you can indeed have a type that's
<a name="line-3518"></a>higher-rank in its kind. But only by explicit request.
<a name="line-3519"></a>
<a name="line-3520"></a>Note [Kinds of quantified type variables]
<a name="line-3521"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3522"></a>tcTyVarBndrsGen quantifies over a specified list of type variables,
<a name="line-3523"></a>*and* over the kind variables mentioned in the kinds of those tyvars.
<a name="line-3524"></a>
<a name="line-3525"></a>Note that we must zonk those kinds (obviously) but less obviously, we
<a name="line-3526"></a>must return type variables whose kinds are zonked too. Example
<a name="line-3527"></a>    (a :: k7)  where  k7 := k9 -&gt; k9
<a name="line-3528"></a>We must return
<a name="line-3529"></a>    [k9, a:k9-&gt;k9]
<a name="line-3530"></a>and NOT
<a name="line-3531"></a>    [k9, a:k7]
<a name="line-3532"></a>Reason: we're going to turn this into a for-all type,
<a name="line-3533"></a>   forall k9. forall (a:k7). blah
<a name="line-3534"></a>which the type checker will then instantiate, and instantiate does not
<a name="line-3535"></a>look through unification variables!
<a name="line-3536"></a>
<a name="line-3537"></a>Hence using zonked_kinds when forming tvs'.
<a name="line-3538"></a>
<a name="line-3539"></a>-}</span>
<a name="line-3540"></a>
<a name="line-3541"></a><a name="etaExpandAlgTyCon"></a><span class='hs-comment'>-----------------------------------</span>
<a name="line-3542"></a><span class='hs-definition'>etaExpandAlgTyCon</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span>
<a name="line-3543"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>   <span class='hs-comment'>-- must be zonked</span>
<a name="line-3544"></a>                  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBinder</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Kind</span><span class='hs-layout'>)</span>
<a name="line-3545"></a><span class='hs-comment'>-- GADT decls can have a (perhaps partial) kind signature</span>
<a name="line-3546"></a><span class='hs-comment'>--      e.g.  data T a :: * -&gt; * -&gt; * where ...</span>
<a name="line-3547"></a><span class='hs-comment'>-- This function makes up suitable (kinded) TyConBinders for the</span>
<a name="line-3548"></a><span class='hs-comment'>-- argument kinds.  E.g. in this case it might return</span>
<a name="line-3549"></a><span class='hs-comment'>--   ([b::*, c::*], *)</span>
<a name="line-3550"></a><span class='hs-comment'>-- Never emits constraints.</span>
<a name="line-3551"></a><span class='hs-comment'>-- It's a little trickier than you might think: see</span>
<a name="line-3552"></a><span class='hs-comment'>-- Note [TyConBinders for the result kind signature of a data type]</span>
<a name="line-3553"></a><span class='hs-comment'>-- See Note [Datatype return kinds] in GHC.Tc.TyCl</span>
<a name="line-3554"></a><span class='hs-definition'>etaExpandAlgTyCon</span> <span class='hs-varid'>tc_bndrs</span> <span class='hs-varid'>kind</span>
<a name="line-3555"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>loc</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getSrcSpanM</span>
<a name="line-3556"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>uniqs</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newUniqueSupply</span>
<a name="line-3557"></a>        <span class='hs-layout'>;</span> <span class='hs-varop'>!</span><span class='hs-varid'>rdr_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getLocalRdrEnv</span>
<a name="line-3558"></a>        <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>new_occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>occ</span>
<a name="line-3559"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>str</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>allNameStrings</span>
<a name="line-3560"></a>                         <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occ</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkOccName</span> <span class='hs-varid'>tvName</span> <span class='hs-varid'>str</span>
<a name="line-3561"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookupLocalRdrOcc</span> <span class='hs-varid'>rdr_env</span> <span class='hs-varid'>occ</span><span class='hs-layout'>)</span>
<a name="line-3562"></a>                         <span class='hs-comment'>-- Note [Avoid name clashes for associated data types]</span>
<a name="line-3563"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>occ</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>lhs_occs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-3564"></a>              <span class='hs-varid'>new_uniqs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqsFromSupply</span> <span class='hs-varid'>uniqs</span>
<a name="line-3565"></a>              <span class='hs-varid'>subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkVarSet</span> <span class='hs-varid'>lhs_tvs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3566"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>new_occs</span> <span class='hs-varid'>new_uniqs</span> <span class='hs-varid'>subst</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3567"></a>  <span class='hs-keyword'>where</span>
<a name="line-3568"></a>    <span class='hs-varid'>lhs_tvs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>binderVar</span> <span class='hs-varid'>tc_bndrs</span>
<a name="line-3569"></a>    <span class='hs-varid'>lhs_occs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>lhs_tvs</span>
<a name="line-3570"></a>
<a name="line-3571"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>uniqs</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>acc</span> <span class='hs-varid'>kind</span>
<a name="line-3572"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>splitPiTy_maybe</span> <span class='hs-varid'>kind</span> <span class='hs-keyword'>of</span>
<a name="line-3573"></a>          <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span><span class='hs-layout'>,</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-3574"></a>
<a name="line-3575"></a>          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Anon</span> <span class='hs-varid'>af</span> <span class='hs-varid'>arg</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-3576"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>occs'</span> <span class='hs-varid'>uniqs'</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind'</span>
<a name="line-3577"></a>            <span class='hs-keyword'>where</span>
<a name="line-3578"></a>              <span class='hs-varid'>arg'</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-layout'>(</span><span class='hs-varid'>scaledThing</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span>
<a name="line-3579"></a>              <span class='hs-comment'>-- Force the occ before making the TyVar as otherwise it retains the TcLclEnv</span>
<a name="line-3580"></a>              <span class='hs-varid'>tv</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occ</span> <span class='hs-varop'>`seq`</span> <span class='hs-varid'>mkTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInternalName</span> <span class='hs-varid'>uniq</span> <span class='hs-varid'>occ</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varid'>arg'</span>
<a name="line-3581"></a>              <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvInScope</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3582"></a>              <span class='hs-varid'>tcb</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>(</span><span class='hs-conid'>AnonTCB</span> <span class='hs-varid'>af</span><span class='hs-layout'>)</span>
<a name="line-3583"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>uniq</span><span class='hs-conop'>:</span><span class='hs-varid'>uniqs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>uniqs</span>
<a name="line-3584"></a>              <span class='hs-layout'>(</span><span class='hs-varop'>!</span><span class='hs-varid'>occ</span><span class='hs-conop'>:</span><span class='hs-varid'>occs'</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>occs</span>
<a name="line-3585"></a>
<a name="line-3586"></a>          <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind'</span><span class='hs-layout'>)</span>
<a name="line-3587"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>occs</span> <span class='hs-varid'>uniqs</span> <span class='hs-varid'>subst'</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>kind'</span>
<a name="line-3588"></a>            <span class='hs-keyword'>where</span>
<a name="line-3589"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>subst'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>substTyVarBndr</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span>
<a name="line-3590"></a>              <span class='hs-varid'>tcb</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv'</span> <span class='hs-layout'>(</span><span class='hs-conid'>NamedTCB</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span>
<a name="line-3591"></a>
<a name="line-3592"></a><a name="DataSort"></a><span class='hs-comment'>-- | A description of whether something is a</span>
<a name="line-3593"></a><a name="DataSort"></a><span class='hs-comment'>--</span>
<a name="line-3594"></a><a name="DataSort"></a><span class='hs-comment'>-- * @data@ or @newtype@ ('DataDeclSort')</span>
<a name="line-3595"></a><a name="DataSort"></a><span class='hs-comment'>--</span>
<a name="line-3596"></a><a name="DataSort"></a><span class='hs-comment'>-- * @data instance@ or @newtype instance@ ('DataInstanceSort')</span>
<a name="line-3597"></a><a name="DataSort"></a><span class='hs-comment'>--</span>
<a name="line-3598"></a><a name="DataSort"></a><span class='hs-comment'>-- * @data family@ ('DataFamilySort')</span>
<a name="line-3599"></a><a name="DataSort"></a><span class='hs-comment'>--</span>
<a name="line-3600"></a><a name="DataSort"></a><span class='hs-comment'>-- At present, this data type is only consumed by 'checkDataKindSig'.</span>
<a name="line-3601"></a><a name="DataSort"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DataSort</span>
<a name="line-3602"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DataDeclSort</span>     <span class='hs-conid'>NewOrData</span>
<a name="line-3603"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataInstanceSort</span> <span class='hs-conid'>NewOrData</span>
<a name="line-3604"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DataFamilySort</span>
<a name="line-3605"></a>
<a name="line-3606"></a><a name="AllowedDataResKind"></a><span class='hs-comment'>-- | Local helper type used in 'checkDataKindSig'.</span>
<a name="line-3607"></a><a name="AllowedDataResKind"></a><span class='hs-comment'>--</span>
<a name="line-3608"></a><a name="AllowedDataResKind"></a><span class='hs-comment'>-- Superficially similar to 'ContextKind', but it lacks 'AnyKind'</span>
<a name="line-3609"></a><a name="AllowedDataResKind"></a><span class='hs-comment'>-- and 'AnyBoxedKind', and instead of @'TheKind' liftedTypeKind@</span>
<a name="line-3610"></a><a name="AllowedDataResKind"></a><span class='hs-comment'>-- provides 'LiftedKind', which is much simpler to match on and</span>
<a name="line-3611"></a><a name="AllowedDataResKind"></a><span class='hs-comment'>-- handle in 'isAllowedDataResKind'.</span>
<a name="line-3612"></a><a name="AllowedDataResKind"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>AllowedDataResKind</span>
<a name="line-3613"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyTYPEKind</span>
<a name="line-3614"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>AnyBoxedKind</span>
<a name="line-3615"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>LiftedKind</span>
<a name="line-3616"></a>
<a name="line-3617"></a><a name="isAllowedDataResKind"></a><span class='hs-definition'>isAllowedDataResKind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>AllowedDataResKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3618"></a><span class='hs-definition'>isAllowedDataResKind</span> <span class='hs-conid'>AnyTYPEKind</span>  <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIsRuntimeTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-3619"></a><span class='hs-definition'>isAllowedDataResKind</span> <span class='hs-conid'>AnyBoxedKind</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIsBoxedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-3620"></a><span class='hs-definition'>isAllowedDataResKind</span> <span class='hs-conid'>LiftedKind</span>   <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tcIsLiftedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-3621"></a>
<a name="line-3622"></a><a name="checkDataKindSig"></a><span class='hs-comment'>-- | Checks that the return kind in a data declaration's kind signature is</span>
<a name="line-3623"></a><span class='hs-comment'>-- permissible. There are three cases:</span>
<a name="line-3624"></a><span class='hs-comment'>--</span>
<a name="line-3625"></a><span class='hs-comment'>-- If dealing with a @data@, @newtype@, @data instance@, or @newtype instance@</span>
<a name="line-3626"></a><span class='hs-comment'>-- declaration, check that the return kind is @Type@.</span>
<a name="line-3627"></a><span class='hs-comment'>--</span>
<a name="line-3628"></a><span class='hs-comment'>-- If the declaration is a @newtype@ or @newtype instance@ and the</span>
<a name="line-3629"></a><span class='hs-comment'>-- @UnliftedNewtypes@ extension is enabled, this check is slightly relaxed so</span>
<a name="line-3630"></a><span class='hs-comment'>-- that a return kind of the form @TYPE r@ (for some @r@) is permitted.</span>
<a name="line-3631"></a><span class='hs-comment'>-- See @Note [Implementation of UnliftedNewtypes]@ in "GHC.Tc.TyCl".</span>
<a name="line-3632"></a><span class='hs-comment'>--</span>
<a name="line-3633"></a><span class='hs-comment'>-- If dealing with a @data family@ declaration, check that the return kind is</span>
<a name="line-3634"></a><span class='hs-comment'>-- either of the form:</span>
<a name="line-3635"></a><span class='hs-comment'>--</span>
<a name="line-3636"></a><span class='hs-comment'>-- 1. @TYPE r@ (for some @r@), or</span>
<a name="line-3637"></a><span class='hs-comment'>--</span>
<a name="line-3638"></a><span class='hs-comment'>-- 2. @k@ (where @k@ is a bare kind variable; see #12369)</span>
<a name="line-3639"></a><span class='hs-comment'>--</span>
<a name="line-3640"></a><span class='hs-comment'>-- See also Note [Datatype return kinds] in "GHC.Tc.TyCl"</span>
<a name="line-3641"></a><span class='hs-definition'>checkDataKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DataSort</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Kind</span>  <span class='hs-comment'>-- any arguments in the kind are stripped off</span>
<a name="line-3642"></a>                 <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3643"></a><span class='hs-definition'>checkDataKindSig</span> <span class='hs-varid'>data_sort</span> <span class='hs-varid'>kind</span>
<a name="line-3644"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-3645"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"checkDataKindSig"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-3646"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tYPE_ok</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>||</span> <span class='hs-varid'>is_kind_var</span><span class='hs-layout'>)</span>
<a name="line-3647"></a>                 <span class='hs-layout'>(</span><span class='hs-varid'>err_msg</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3648"></a>  <span class='hs-keyword'>where</span>
<a name="line-3649"></a>    <span class='hs-varid'>res_kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>snd</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcSplitPiTys</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-3650"></a>       <span class='hs-comment'>-- Look for the result kind after</span>
<a name="line-3651"></a>       <span class='hs-comment'>-- peeling off any foralls and arrows</span>
<a name="line-3652"></a>
<a name="line-3653"></a>    <span class='hs-varid'>pp_dec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-3654"></a>    <span class='hs-varid'>pp_dec</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-varop'>$</span>
<a name="line-3655"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>data_sort</span> <span class='hs-keyword'>of</span>
<a name="line-3656"></a>        <span class='hs-conid'>DataDeclSort</span>     <span class='hs-conid'>DataType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"Data type"</span>
<a name="line-3657"></a>        <span class='hs-conid'>DataDeclSort</span>     <span class='hs-conid'>NewType</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"Newtype"</span>
<a name="line-3658"></a>        <span class='hs-conid'>DataInstanceSort</span> <span class='hs-conid'>DataType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"Data instance"</span>
<a name="line-3659"></a>        <span class='hs-conid'>DataInstanceSort</span> <span class='hs-conid'>NewType</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"Newtype instance"</span>
<a name="line-3660"></a>        <span class='hs-conid'>DataFamilySort</span>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-str'>"Data family"</span>
<a name="line-3661"></a>
<a name="line-3662"></a>    <span class='hs-varid'>is_newtype</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-3663"></a>    <span class='hs-varid'>is_newtype</span> <span class='hs-keyglyph'>=</span>
<a name="line-3664"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>data_sort</span> <span class='hs-keyword'>of</span>
<a name="line-3665"></a>        <span class='hs-conid'>DataDeclSort</span>     <span class='hs-varid'>new_or_data</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NewType</span>
<a name="line-3666"></a>        <span class='hs-conid'>DataInstanceSort</span> <span class='hs-varid'>new_or_data</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>new_or_data</span> <span class='hs-varop'>==</span> <span class='hs-conid'>NewType</span>
<a name="line-3667"></a>        <span class='hs-conid'>DataFamilySort</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-3668"></a>
<a name="line-3669"></a>    <span class='hs-varid'>is_datatype</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-3670"></a>    <span class='hs-varid'>is_datatype</span> <span class='hs-keyglyph'>=</span>
<a name="line-3671"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>data_sort</span> <span class='hs-keyword'>of</span>
<a name="line-3672"></a>        <span class='hs-conid'>DataDeclSort</span>     <span class='hs-conid'>DataType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-3673"></a>        <span class='hs-conid'>DataInstanceSort</span> <span class='hs-conid'>DataType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-3674"></a>        <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-3675"></a>
<a name="line-3676"></a>    <span class='hs-varid'>is_data_family</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-3677"></a>    <span class='hs-varid'>is_data_family</span> <span class='hs-keyglyph'>=</span>
<a name="line-3678"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>data_sort</span> <span class='hs-keyword'>of</span>
<a name="line-3679"></a>        <span class='hs-conid'>DataDeclSort</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-3680"></a>        <span class='hs-conid'>DataInstanceSort</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-3681"></a>        <span class='hs-conid'>DataFamilySort</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span>
<a name="line-3682"></a>
<a name="line-3683"></a>    <span class='hs-varid'>allowed_kind</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AllowedDataResKind</span>
<a name="line-3684"></a>    <span class='hs-varid'>allowed_kind</span> <span class='hs-varid'>dflags</span>
<a name="line-3685"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_newtype</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt.UnliftedNewtypes</span> <span class='hs-varid'>dflags</span>
<a name="line-3686"></a>        <span class='hs-comment'>-- With UnliftedNewtypes, we allow kinds other than Type, but they</span>
<a name="line-3687"></a>        <span class='hs-comment'>-- must still be of the form `TYPE r` since we don't want to accept</span>
<a name="line-3688"></a>        <span class='hs-comment'>-- Constraint or Nat.</span>
<a name="line-3689"></a>        <span class='hs-comment'>-- See Note [Implementation of UnliftedNewtypes] in GHC.Tc.TyCl.</span>
<a name="line-3690"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyTYPEKind</span>
<a name="line-3691"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_data_family</span>
<a name="line-3692"></a>        <span class='hs-comment'>-- If this is a `data family` declaration, we don't need to check if</span>
<a name="line-3693"></a>        <span class='hs-comment'>-- UnliftedNewtypes is enabled, since data family declarations can</span>
<a name="line-3694"></a>        <span class='hs-comment'>-- have return kind `TYPE r` unconditionally (#16827).</span>
<a name="line-3695"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyTYPEKind</span>
<a name="line-3696"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_datatype</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt.UnliftedDatatypes</span> <span class='hs-varid'>dflags</span>
<a name="line-3697"></a>        <span class='hs-comment'>-- With UnliftedDatatypes, we allow kinds other than Type, but they</span>
<a name="line-3698"></a>        <span class='hs-comment'>-- must still be of the form `TYPE (BoxedRep l)`, so that we don't</span>
<a name="line-3699"></a>        <span class='hs-comment'>-- accept result kinds like `TYPE IntRep`.</span>
<a name="line-3700"></a>        <span class='hs-comment'>-- See Note [Implementation of UnliftedDatatypes] in GHC.Tc.TyCl.</span>
<a name="line-3701"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AnyBoxedKind</span>
<a name="line-3702"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3703"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LiftedKind</span>
<a name="line-3704"></a>
<a name="line-3705"></a>    <span class='hs-varid'>tYPE_ok</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-3706"></a>    <span class='hs-varid'>tYPE_ok</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isAllowedDataResKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>allowed_kind</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span> <span class='hs-varid'>res_kind</span>
<a name="line-3707"></a>
<a name="line-3708"></a>    <span class='hs-comment'>-- In the particular case of a data family, permit a return kind of the</span>
<a name="line-3709"></a>    <span class='hs-comment'>-- form `:: k` (where `k` is a bare kind variable).</span>
<a name="line-3710"></a>    <span class='hs-varid'>is_kind_var</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-3711"></a>    <span class='hs-varid'>is_kind_var</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>is_data_family</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isJust</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcGetCastedTyVar_maybe</span> <span class='hs-varid'>res_kind</span><span class='hs-layout'>)</span>
<a name="line-3712"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-3713"></a>
<a name="line-3714"></a>    <span class='hs-varid'>pp_allowed_kind</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-3715"></a>      <span class='hs-keyword'>case</span> <span class='hs-varid'>allowed_kind</span> <span class='hs-varid'>dflags</span> <span class='hs-keyword'>of</span>
<a name="line-3716"></a>        <span class='hs-conid'>AnyTYPEKind</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tYPETyCon</span>
<a name="line-3717"></a>        <span class='hs-conid'>AnyBoxedKind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>boxedRepDataConTyCon</span>
<a name="line-3718"></a>        <span class='hs-conid'>LiftedKind</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-3719"></a>
<a name="line-3720"></a>    <span class='hs-varid'>err_msg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DynFlags</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-3721"></a>    <span class='hs-varid'>err_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>=</span>
<a name="line-3722"></a>      <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pp_dec</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-3723"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"has non-"</span> <span class='hs-varop'>&lt;&gt;</span>
<a name="line-3724"></a>                  <span class='hs-varid'>pp_allowed_kind</span> <span class='hs-varid'>dflags</span>
<a name="line-3725"></a>                <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>is_data_family</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>text</span> <span class='hs-str'>"and non-variable"</span> <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-3726"></a>                  <span class='hs-varid'>text</span> <span class='hs-str'>"return kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-3727"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>ext_hint</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>]</span>
<a name="line-3728"></a>
<a name="line-3729"></a>    <span class='hs-varid'>ext_hint</span> <span class='hs-varid'>dflags</span>
<a name="line-3730"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsRuntimeTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-3731"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>is_newtype</span>
<a name="line-3732"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt.UnliftedNewtypes</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-3733"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you intended to use UnliftedNewtypes"</span>
<a name="line-3734"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tcIsBoxedTypeKind</span> <span class='hs-varid'>kind</span>
<a name="line-3735"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>is_datatype</span>
<a name="line-3736"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>xopt</span> <span class='hs-conid'>LangExt.UnliftedDatatypes</span> <span class='hs-varid'>dflags</span><span class='hs-layout'>)</span>
<a name="line-3737"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Perhaps you intended to use UnliftedDatatypes"</span>
<a name="line-3738"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3739"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-3740"></a>
<a name="line-3741"></a><a name="checkClassKindSig"></a><span class='hs-comment'>-- | Checks that the result kind of a class is exactly `Constraint`, rejecting</span>
<a name="line-3742"></a><span class='hs-comment'>-- type synonyms and type families that reduce to `Constraint`. See #16826.</span>
<a name="line-3743"></a><span class='hs-definition'>checkClassKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Kind</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-3744"></a><span class='hs-definition'>checkClassKindSig</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcIsConstraintKind</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>err_msg</span>
<a name="line-3745"></a>  <span class='hs-keyword'>where</span>
<a name="line-3746"></a>    <span class='hs-varid'>err_msg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>
<a name="line-3747"></a>    <span class='hs-varid'>err_msg</span> <span class='hs-keyglyph'>=</span>
<a name="line-3748"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"Kind signature on a class must end with"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>constraintKind</span> <span class='hs-varop'>$$</span>
<a name="line-3749"></a>      <span class='hs-varid'>text</span> <span class='hs-str'>"unobscured by type families"</span>
<a name="line-3750"></a>
<a name="line-3751"></a><a name="tcbVisibilities"></a><span class='hs-definition'>tcbVisibilities</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TyCon</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Type</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>TyConBndrVis</span><span class='hs-keyglyph'>]</span>
<a name="line-3752"></a><span class='hs-comment'>-- Result is in 1-1 correspondence with orig_args</span>
<a name="line-3753"></a><span class='hs-definition'>tcbVisibilities</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>orig_args</span>
<a name="line-3754"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConKind</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>orig_args</span>
<a name="line-3755"></a>  <span class='hs-keyword'>where</span>
<a name="line-3756"></a>    <span class='hs-varid'>init_subst</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEmptyTCvSubst</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInScopeSet</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyCoVarsOfTypes</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3757"></a>    <span class='hs-varid'>go</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span>
<a name="line-3758"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-3759"></a>
<a name="line-3760"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>fun_kind</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>all_args</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>arg</span> <span class='hs-conop'>:</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-3761"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tcb</span><span class='hs-layout'>,</span> <span class='hs-varid'>inner_kind</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitPiTy_maybe</span> <span class='hs-varid'>fun_kind</span>
<a name="line-3762"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcb</span> <span class='hs-keyword'>of</span>
<a name="line-3763"></a>          <span class='hs-conid'>Anon</span> <span class='hs-varid'>af</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AnonTCB</span> <span class='hs-varid'>af</span>   <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>inner_kind</span> <span class='hs-varid'>subst</span>  <span class='hs-varid'>args</span>
<a name="line-3764"></a>          <span class='hs-conid'>Named</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bndr</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>vis</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>NamedTCB</span> <span class='hs-varid'>vis</span> <span class='hs-conop'>:</span> <span class='hs-varid'>go</span> <span class='hs-varid'>inner_kind</span> <span class='hs-varid'>subst'</span> <span class='hs-varid'>args</span>
<a name="line-3765"></a>                 <span class='hs-keyword'>where</span>
<a name="line-3766"></a>                    <span class='hs-varid'>subst'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>extendTCvSubst</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>tv</span> <span class='hs-varid'>arg</span>
<a name="line-3767"></a>
<a name="line-3768"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEmptyTCvSubst</span> <span class='hs-varid'>subst</span><span class='hs-layout'>)</span>
<a name="line-3769"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>substTy</span> <span class='hs-varid'>subst</span> <span class='hs-varid'>fun_kind</span><span class='hs-layout'>)</span> <span class='hs-varid'>init_subst</span> <span class='hs-varid'>all_args</span>
<a name="line-3770"></a>
<a name="line-3771"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3772"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"addTcbVisibilities"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>orig_args</span><span class='hs-layout'>)</span>
<a name="line-3773"></a>
<a name="line-3774"></a>
<a name="line-3775"></a><span class='hs-comment'>{- Note [TyConBinders for the result kind signature of a data type]
<a name="line-3776"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3777"></a>Given
<a name="line-3778"></a>  data T (a::*) :: * -&gt; forall k. k -&gt; *
<a name="line-3779"></a>we want to generate the extra TyConBinders for T, so we finally get
<a name="line-3780"></a>  (a::*) (b::*) (k::*) (c::k)
<a name="line-3781"></a>The function etaExpandAlgTyCon generates these extra TyConBinders from
<a name="line-3782"></a>the result kind signature.
<a name="line-3783"></a>
<a name="line-3784"></a>We need to take care to give the TyConBinders
<a name="line-3785"></a>  (a) OccNames that are fresh (because the TyConBinders of a TyCon
<a name="line-3786"></a>      must have distinct OccNames
<a name="line-3787"></a>
<a name="line-3788"></a>  (b) Uniques that are fresh (obviously)
<a name="line-3789"></a>
<a name="line-3790"></a>For (a) we need to avoid clashes with the tyvars declared by
<a name="line-3791"></a>the user before the "::"; in the above example that is 'a'.
<a name="line-3792"></a>And also see Note [Avoid name clashes for associated data types].
<a name="line-3793"></a>
<a name="line-3794"></a>For (b) suppose we have
<a name="line-3795"></a>   data T :: forall k. k -&gt; forall k. k -&gt; *
<a name="line-3796"></a>where the two k's are identical even up to their uniques.  Surprisingly,
<a name="line-3797"></a>this can happen: see #14515.
<a name="line-3798"></a>
<a name="line-3799"></a>It's reasonably easy to solve all this; just run down the list with a
<a name="line-3800"></a>substitution; hence the recursive 'go' function.  But it has to be
<a name="line-3801"></a>done.
<a name="line-3802"></a>
<a name="line-3803"></a>Note [Avoid name clashes for associated data types]
<a name="line-3804"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3805"></a>Consider    class C a b where
<a name="line-3806"></a>               data D b :: * -&gt; *
<a name="line-3807"></a>When typechecking the decl for D, we'll invent an extra type variable
<a name="line-3808"></a>for D, to fill out its kind.  Ideally we don't want this type variable
<a name="line-3809"></a>to be 'a', because when pretty printing we'll get
<a name="line-3810"></a>            class C a b where
<a name="line-3811"></a>               data D b a0
<a name="line-3812"></a>(NB: the tidying happens in the conversion to Iface syntax, which happens
<a name="line-3813"></a>as part of pretty-printing a TyThing.)
<a name="line-3814"></a>
<a name="line-3815"></a>That's why we look in the LocalRdrEnv to see what's in scope. This is
<a name="line-3816"></a>important only to get nice-looking output when doing ":info C" in GHCi.
<a name="line-3817"></a>It isn't essential for correctness.
<a name="line-3818"></a>
<a name="line-3819"></a>
<a name="line-3820"></a>************************************************************************
<a name="line-3821"></a>*                                                                      *
<a name="line-3822"></a>             Partial signatures
<a name="line-3823"></a>*                                                                      *
<a name="line-3824"></a>************************************************************************
<a name="line-3825"></a>
<a name="line-3826"></a>-}</span>
<a name="line-3827"></a>
<a name="line-3828"></a><a name="tcHsPartialSigType"></a><span class='hs-definition'>tcHsPartialSigType</span>
<a name="line-3829"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-3830"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsSigWcType</span> <span class='hs-conid'>GhcRn</span>       <span class='hs-comment'>-- The type signature</span>
<a name="line-3831"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Wildcards</span>
<a name="line-3832"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span>       <span class='hs-comment'>-- Extra-constraints wildcard</span>
<a name="line-3833"></a>         <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- Original tyvar names, in correspondence with</span>
<a name="line-3834"></a>                              <span class='hs-comment'>--   the implicitly and explicitly bound type variables</span>
<a name="line-3835"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>TcThetaType</span>        <span class='hs-comment'>-- Theta part</span>
<a name="line-3836"></a>         <span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span> <span class='hs-layout'>)</span>           <span class='hs-comment'>-- Tau part</span>
<a name="line-3837"></a><span class='hs-comment'>-- See Note [Checking partial type signatures]</span>
<a name="line-3838"></a><span class='hs-definition'>tcHsPartialSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-3839"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>HsWC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hswc_ext</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hswc_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_ty</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_ty</span>
<a name="line-3840"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>HsSig</span><span class='hs-layout'>{</span><span class='hs-varid'>sig_bndrs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>body_ty</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>sig_ty</span>
<a name="line-3841"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_tau</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>splitLHsQualTy</span> <span class='hs-varid'>body_ty</span>
<a name="line-3842"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span> <span class='hs-varop'>$</span>
<a name="line-3843"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHoleMode</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-conid'>HM_Sig</span>
<a name="line-3844"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>outer_bndrs</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3845"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>solveEqualities</span> <span class='hs-str'>"tcHsPartialSigType"</span> <span class='hs-varop'>$</span>
<a name="line-3846"></a>               <span class='hs-comment'>-- See Note [Failure in local type signatures]</span>
<a name="line-3847"></a>               <span class='hs-varid'>bindNamedWildCardBinders</span> <span class='hs-varid'>sig_wcs</span>             <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-3848"></a>               <span class='hs-varid'>bindOuterSigTKBndrs_Tv_M</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_outer_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-3849"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Instantiate the type-class context; but if there</span>
<a name="line-3850"></a>                      <span class='hs-comment'>-- is an extra-constraints wildcard, just discard it here</span>
<a name="line-3851"></a>                    <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcPartialContext</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ctxt</span>
<a name="line-3852"></a>
<a name="line-3853"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>ek</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newOpenTypeKind</span>
<a name="line-3854"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>tau</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_tau</span> <span class='hs-varop'>$</span>
<a name="line-3855"></a>                           <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_tau</span> <span class='hs-varid'>ek</span>
<a name="line-3856"></a>
<a name="line-3857"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3858"></a>
<a name="line-3859"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPartialSigType 2"</span> <span class='hs-varid'>empty</span>
<a name="line-3860"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>outer_tv_bndrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>scopedSortOuter</span> <span class='hs-varid'>outer_bndrs</span>
<a name="line-3861"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPartialSigType 3"</span> <span class='hs-varid'>empty</span>
<a name="line-3862"></a>
<a name="line-3863"></a>         <span class='hs-comment'>-- No kind-generalization here:</span>
<a name="line-3864"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kindGeneralizeNone</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkInvisForAllTys</span> <span class='hs-varid'>outer_tv_bndrs</span> <span class='hs-varop'>$</span>
<a name="line-3865"></a>                             <span class='hs-varid'>mkPhiTy</span> <span class='hs-varid'>theta</span> <span class='hs-varop'>$</span>
<a name="line-3866"></a>                             <span class='hs-varid'>tau</span><span class='hs-layout'>)</span>
<a name="line-3867"></a>
<a name="line-3868"></a>       <span class='hs-comment'>-- Spit out the wildcards (including the extra-constraints one)</span>
<a name="line-3869"></a>       <span class='hs-comment'>-- as "hole" constraints, so that they'll be reported if necessary</span>
<a name="line-3870"></a>       <span class='hs-comment'>-- See Note [Extra-constraint holes in partial type signatures]</span>
<a name="line-3871"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>emitNamedTypeHole</span> <span class='hs-varid'>wcs</span>
<a name="line-3872"></a>
<a name="line-3873"></a>       <span class='hs-comment'>-- Zonk, so that any nested foralls can "see" their occurrences</span>
<a name="line-3874"></a>       <span class='hs-comment'>-- See Note [Checking partial type signatures], and in particular</span>
<a name="line-3875"></a>       <span class='hs-comment'>-- Note [Levels for wildcards]</span>
<a name="line-3876"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>outer_tv_bndrs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkInvisTVBinder</span> <span class='hs-varid'>outer_tv_bndrs</span>
<a name="line-3877"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>theta</span>          <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>theta</span>
<a name="line-3878"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tau</span>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>tau</span>
<a name="line-3879"></a>
<a name="line-3880"></a>         <span class='hs-comment'>-- We return a proper (Name,InvisTVBinder) environment, to be sure that</span>
<a name="line-3881"></a>         <span class='hs-comment'>-- we bring the right name into scope in the function body.</span>
<a name="line-3882"></a>         <span class='hs-comment'>-- Test case: partial-sigs/should_compile/LocalDefinitionBug</span>
<a name="line-3883"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>outer_bndr_names</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span>
<a name="line-3884"></a>             <span class='hs-varid'>outer_bndr_names</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hsOuterTyVarNames</span> <span class='hs-varid'>hs_outer_bndrs</span>
<a name="line-3885"></a>             <span class='hs-varid'>tv_prs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span><span class='hs-conid'>InvisTVBinder</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-3886"></a>             <span class='hs-varid'>tv_prs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outer_bndr_names</span> <span class='hs-varop'>`zip`</span> <span class='hs-varid'>outer_tv_bndrs</span>
<a name="line-3887"></a>
<a name="line-3888"></a>      <span class='hs-comment'>-- NB: checkValidType on the final inferred type will be</span>
<a name="line-3889"></a>      <span class='hs-comment'>--     done later by checkInferredPolyId.  We can't do it</span>
<a name="line-3890"></a>      <span class='hs-comment'>--     here because we don't have a complete type to check</span>
<a name="line-3891"></a>
<a name="line-3892"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPartialSigType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>)</span>
<a name="line-3893"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>wcx</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-varid'>tau</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3894"></a>
<a name="line-3895"></a><a name="tcPartialContext"></a><span class='hs-definition'>tcPartialContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>LHsContext</span> <span class='hs-conid'>GhcRn</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-3896"></a><span class='hs-definition'>tcPartialContext</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>[]</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-3897"></a><span class='hs-definition'>tcPartialContext</span> <span class='hs-varid'>mode</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>L</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>hs_theta</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-3898"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>hs_theta1</span><span class='hs-layout'>,</span> <span class='hs-varid'>hs_ctxt_last</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>snocView</span> <span class='hs-varid'>hs_theta</span>
<a name="line-3899"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>L</span> <span class='hs-varid'>wc_loc</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>HsWildCardTy</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ignoreParens</span> <span class='hs-varid'>hs_ctxt_last</span>
<a name="line-3900"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_tv_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setSrcSpanA</span> <span class='hs-varid'>wc_loc</span> <span class='hs-varop'>$</span>
<a name="line-3901"></a>                     <span class='hs-varid'>tcAnonWildCardOcc</span> <span class='hs-conid'>YesExtraConstraint</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>constraintKind</span>
<a name="line-3902"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_theta1</span>
<a name="line-3903"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>wc_tv_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3904"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-3905"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>theta</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc_lhs_pred</span> <span class='hs-varid'>mode</span><span class='hs-layout'>)</span> <span class='hs-varid'>hs_theta</span>
<a name="line-3906"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>theta</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-3907"></a>
<a name="line-3908"></a><span class='hs-comment'>{- Note [Checking partial type signatures]
<a name="line-3909"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3910"></a>This Note is about tcHsPartialSigType.  See also
<a name="line-3911"></a>Note [Recipe for checking a signature]
<a name="line-3912"></a>
<a name="line-3913"></a>When we have a partial signature like
<a name="line-3914"></a>   f :: forall a. a -&gt; _
<a name="line-3915"></a>we do the following
<a name="line-3916"></a>
<a name="line-3917"></a>* tcHsPartialSigType does not make quantified type (forall a. blah)
<a name="line-3918"></a>  and then instantiate it -- it makes no sense to instantiate a type
<a name="line-3919"></a>  with wildcards in it.  Rather, tcHsPartialSigType just returns the
<a name="line-3920"></a>  'a' and the 'blah' separately.
<a name="line-3921"></a>
<a name="line-3922"></a>  Nor, for the same reason, do we push a level in tcHsPartialSigType.
<a name="line-3923"></a>
<a name="line-3924"></a>* We instantiate 'a' to a unification variable, a TyVarTv, and /not/
<a name="line-3925"></a>  a skolem; hence the "_Tv" in bindExplicitTKBndrs_Tv.  Consider
<a name="line-3926"></a>    f :: forall a. a -&gt; _
<a name="line-3927"></a>    g :: forall b. _ -&gt; b
<a name="line-3928"></a>    f = g
<a name="line-3929"></a>    g = f
<a name="line-3930"></a>  They are typechecked as a recursive group, with monomorphic types,
<a name="line-3931"></a>  so 'a' and 'b' will get unified together.  Very like kind inference
<a name="line-3932"></a>  for mutually recursive data types (sans CUSKs or SAKS); see
<a name="line-3933"></a>  Note [Cloning for type variable binders]
<a name="line-3934"></a>
<a name="line-3935"></a>* In GHC.Tc.Gen.Sig.tcUserSigType we return a PartialSig, which (unlike
<a name="line-3936"></a>  the companion CompleteSig) contains the original, as-yet-unchecked
<a name="line-3937"></a>  source-code LHsSigWcType
<a name="line-3938"></a>
<a name="line-3939"></a>* Then, for f and g /separately/, we call tcInstSig, which in turn
<a name="line-3940"></a>  call tchsPartialSig (defined near this Note).  It kind-checks the
<a name="line-3941"></a>  LHsSigWcType, creating fresh unification variables for each "_"
<a name="line-3942"></a>  wildcard.  It's important that the wildcards for f and g are distinct
<a name="line-3943"></a>  because they might get instantiated completely differently.  E.g.
<a name="line-3944"></a>     f,g :: forall a. a -&gt; _
<a name="line-3945"></a>     f x = a
<a name="line-3946"></a>     g x = True
<a name="line-3947"></a>  It's really as if we'd written two distinct signatures.
<a name="line-3948"></a>
<a name="line-3949"></a>* Nested foralls. See Note [Levels for wildcards]
<a name="line-3950"></a>
<a name="line-3951"></a>* Just as for ordinary signatures, we must solve local equalities and
<a name="line-3952"></a>  zonk the type after kind-checking it, to ensure that all the nested
<a name="line-3953"></a>  forall binders can "see" their occurrenceds
<a name="line-3954"></a>
<a name="line-3955"></a>  Just as for ordinary signatures, this zonk also gets any Refl casts
<a name="line-3956"></a>  out of the way of instantiation.  Example: #18008 had
<a name="line-3957"></a>       foo :: (forall a. (Show a =&gt; blah) |&gt; Refl) -&gt; _
<a name="line-3958"></a>  and that Refl cast messed things up.  See #18062.
<a name="line-3959"></a>
<a name="line-3960"></a>Note [Levels for wildcards]
<a name="line-3961"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3962"></a>Consider
<a name="line-3963"></a>     f :: forall b. (forall a. a -&gt; _) -&gt; b
<a name="line-3964"></a>We do /not/ allow the "_" to be instantiated to 'a'; although we do
<a name="line-3965"></a>(as before) allow it to be instantiated to the (top level) 'b'.
<a name="line-3966"></a>Why not?  Suppose
<a name="line-3967"></a>   f x = (x True, x 'c')
<a name="line-3968"></a>
<a name="line-3969"></a>During typecking the RHS we must instantiate that (forall a. a -&gt; _),
<a name="line-3970"></a>so we must know /precisely/ where all the a's are; they must not be
<a name="line-3971"></a>hidden under (possibly-not-yet-filled-in) unification variables!
<a name="line-3972"></a>
<a name="line-3973"></a>We achieve this as follows:
<a name="line-3974"></a>
<a name="line-3975"></a>- For /named/ wildcards such sas
<a name="line-3976"></a>     g :: forall b. (forall la. a -&gt; _x) -&gt; b
<a name="line-3977"></a>  there is no problem: we create them at the outer level (ie the
<a name="line-3978"></a>  ambient level of the signature itself), and push the level when we
<a name="line-3979"></a>  go inside a forall.  So now the unification variable for the "_x"
<a name="line-3980"></a>  can't unify with skolem 'a'.
<a name="line-3981"></a>
<a name="line-3982"></a>- For /anonymous/ wildcards, such as 'f' above, we carry the ambient
<a name="line-3983"></a>  level of the signature to the hole in the TcLevel part of the
<a name="line-3984"></a>  mode_holes field of TcTyMode.  Then, in tcAnonWildCardOcc we us that
<a name="line-3985"></a>  level (and /not/ the level ambient at the occurrence of "_") to
<a name="line-3986"></a>  create the unification variable for the wildcard.  That is the sole
<a name="line-3987"></a>  purpose of the TcLevel in the mode_holes field: to transport the
<a name="line-3988"></a>  ambient level of the signature down to the anonymous wildcard
<a name="line-3989"></a>  occurrences.
<a name="line-3990"></a>
<a name="line-3991"></a>Note [Extra-constraint holes in partial type signatures]
<a name="line-3992"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-3993"></a>Consider
<a name="line-3994"></a>  f :: (_) =&gt; a -&gt; a
<a name="line-3995"></a>  f x = ...
<a name="line-3996"></a>
<a name="line-3997"></a>* The renamer leaves '_' untouched.
<a name="line-3998"></a>
<a name="line-3999"></a>* Then, in tcHsPartialSigType, we make a new hole TcTyVar, in
<a name="line-4000"></a>  tcWildCardBinders.
<a name="line-4001"></a>
<a name="line-4002"></a>* GHC.Tc.Gen.Bind.chooseInferredQuantifiers fills in that hole TcTyVar
<a name="line-4003"></a>  with the inferred constraints, e.g. (Eq a, Show a)
<a name="line-4004"></a>
<a name="line-4005"></a>* GHC.Tc.Errors.mkHoleError finally reports the error.
<a name="line-4006"></a>
<a name="line-4007"></a>An annoying difficulty happens if there are more than 64 inferred
<a name="line-4008"></a>constraints. Then we need to fill in the TcTyVar with (say) a 70-tuple.
<a name="line-4009"></a>Where do we find the TyCon?  For good reasons we only have constraint
<a name="line-4010"></a>tuples up to 62 (see Note [How tuples work] in GHC.Builtin.Types).  So how
<a name="line-4011"></a>can we make a 70-tuple?  This was the root cause of #14217.
<a name="line-4012"></a>
<a name="line-4013"></a>It's incredibly tiresome, because we only need this type to fill
<a name="line-4014"></a>in the hole, to communicate to the error reporting machinery.  Nothing
<a name="line-4015"></a>more.  So I use a HACK:
<a name="line-4016"></a>
<a name="line-4017"></a>* I make an /ordinary/ tuple of the constraints, in
<a name="line-4018"></a>  GHC.Tc.Gen.Bind.chooseInferredQuantifiers. This is ill-kinded because
<a name="line-4019"></a>  ordinary tuples can't contain constraints, but it works fine. And for
<a name="line-4020"></a>  ordinary tuples we don't have the same limit as for constraint
<a name="line-4021"></a>  tuples (which need selectors and an associated class).
<a name="line-4022"></a>
<a name="line-4023"></a>* Because it is ill-kinded, it trips an assert in writeMetaTyVar,
<a name="line-4024"></a>  so now I disable the assertion if we are writing a type of
<a name="line-4025"></a>  kind Constraint.  (That seldom/never normally happens so we aren't
<a name="line-4026"></a>  losing much.)
<a name="line-4027"></a>
<a name="line-4028"></a>Result works fine, but it may eventually bite us.
<a name="line-4029"></a>
<a name="line-4030"></a>See also Note [Do not simplify ConstraintHoles] in GHC.Tc.Solver for
<a name="line-4031"></a>information about how these are printed.
<a name="line-4032"></a>
<a name="line-4033"></a>************************************************************************
<a name="line-4034"></a>*                                                                      *
<a name="line-4035"></a>      Pattern signatures (i.e signatures that occur in patterns)
<a name="line-4036"></a>*                                                                      *
<a name="line-4037"></a>********************************************************************* -}</span>
<a name="line-4038"></a>
<a name="line-4039"></a><a name="tcHsPatSigType"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span>
<a name="line-4040"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HoleMode</span> <span class='hs-comment'>-- HM_Sig when in a SigPat, HM_TyAppPat when in a ConPat checking type applications.</span>
<a name="line-4041"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HsPatSigType</span> <span class='hs-conid'>GhcRn</span>          <span class='hs-comment'>-- The type signature</span>
<a name="line-4042"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ContextKind</span>                <span class='hs-comment'>-- What kind is expected</span>
<a name="line-4043"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- Wildcards</span>
<a name="line-4044"></a>                      <span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcTyVar</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>     <span class='hs-comment'>-- The new bit of type environment, binding</span>
<a name="line-4045"></a>                                              <span class='hs-comment'>-- the scoped type variables</span>
<a name="line-4046"></a>                      <span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>       <span class='hs-comment'>-- The type</span>
<a name="line-4047"></a><span class='hs-comment'>-- Used for type-checking type signatures in</span>
<a name="line-4048"></a><span class='hs-comment'>-- (a) patterns           e.g  f (x::Int) = e</span>
<a name="line-4049"></a><span class='hs-comment'>-- (b) RULE forall bndrs  e.g. forall (x::Int). f x = x</span>
<a name="line-4050"></a><span class='hs-comment'>-- See Note [Pattern signature binders and scoping] in GHC.Hs.Type</span>
<a name="line-4051"></a><span class='hs-comment'>--</span>
<a name="line-4052"></a><span class='hs-comment'>-- This may emit constraints</span>
<a name="line-4053"></a><span class='hs-comment'>-- See Note [Recipe for checking a signature]</span>
<a name="line-4054"></a><span class='hs-definition'>tcHsPatSigType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hole_mode</span>
<a name="line-4055"></a>  <span class='hs-layout'>(</span><span class='hs-conid'>HsPS</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsps_ext</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>HsPSRn</span> <span class='hs-layout'>{</span> <span class='hs-varid'>hsps_nwcs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>hsps_imp_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sig_ns</span> <span class='hs-layout'>}</span>
<a name="line-4056"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>hsps_body</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hs_ty</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-4057"></a>  <span class='hs-varid'>ctxt_kind</span>
<a name="line-4058"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addSigCtxt</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varop'>$</span>
<a name="line-4059"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sig_tkv_prs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>sig_ns</span>
<a name="line-4060"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkHoleMode</span> <span class='hs-conid'>TypeLevel</span> <span class='hs-varid'>hole_mode</span>
<a name="line-4061"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span>
<a name="line-4062"></a>            <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addTypeCtxt</span> <span class='hs-varid'>hs_ty</span>                     <span class='hs-varop'>$</span>
<a name="line-4063"></a>               <span class='hs-varid'>solveEqualities</span> <span class='hs-str'>"tcHsPatSigType"</span> <span class='hs-varop'>$</span>
<a name="line-4064"></a>                 <span class='hs-comment'>-- See Note [Failure in local type signatures]</span>
<a name="line-4065"></a>                 <span class='hs-comment'>-- and c.f #16033</span>
<a name="line-4066"></a>               <span class='hs-varid'>bindNamedWildCardBinders</span> <span class='hs-varid'>sig_wcs</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span> <span class='hs-varid'>wcs</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-4067"></a>               <span class='hs-varid'>tcExtendNameTyVarEnv</span> <span class='hs-varid'>sig_tkv_prs</span> <span class='hs-varop'>$</span>
<a name="line-4068"></a>               <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ek</span>     <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newExpectedKind</span> <span class='hs-varid'>ctxt_kind</span>
<a name="line-4069"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_ty</span> <span class='hs-varid'>ek</span>
<a name="line-4070"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4071"></a>
<a name="line-4072"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>mapM_</span> <span class='hs-varid'>emitNamedTypeHole</span> <span class='hs-varid'>wcs</span>
<a name="line-4073"></a>
<a name="line-4074"></a>          <span class='hs-comment'>-- sig_ty might have tyvars that are at a higher TcLevel (if hs_ty</span>
<a name="line-4075"></a>          <span class='hs-comment'>-- contains a forall). Promote these.</span>
<a name="line-4076"></a>          <span class='hs-comment'>-- Ex: f (x :: forall a. Proxy a -&gt; ()) = ... x ...</span>
<a name="line-4077"></a>          <span class='hs-comment'>-- When we instantiate x, we have to compare the kind of the argument</span>
<a name="line-4078"></a>          <span class='hs-comment'>-- to a's kind, which will be a metavariable.</span>
<a name="line-4079"></a>          <span class='hs-comment'>-- kindGeneralizeNone does this:</span>
<a name="line-4080"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>kindGeneralizeNone</span> <span class='hs-varid'>sig_ty</span>
<a name="line-4081"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>sig_ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>sig_ty</span>
<a name="line-4082"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>sig_ty</span>
<a name="line-4083"></a>
<a name="line-4084"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcHsPatSigType"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>sig_tkv_prs</span><span class='hs-layout'>)</span>
<a name="line-4085"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>wcs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_tkv_prs</span><span class='hs-layout'>,</span> <span class='hs-varid'>sig_ty</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4086"></a>  <span class='hs-keyword'>where</span>
<a name="line-4087"></a>    <span class='hs-varid'>new_implicit_tv</span> <span class='hs-varid'>name</span>
<a name="line-4088"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-4089"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>tv</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-4090"></a>                       <span class='hs-conid'>RuleSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newSkolemTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-4091"></a>                       <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>newPatSigTyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>kind</span>
<a name="line-4092"></a>                       <span class='hs-comment'>-- See Note [Typechecking pattern signature binders]</span>
<a name="line-4093"></a>             <span class='hs-comment'>-- NB: tv's Name may be fresh (in the case of newPatSigTyVar)</span>
<a name="line-4094"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>name</span><span class='hs-layout'>,</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4095"></a>
<a name="line-4096"></a><span class='hs-comment'>{- Note [Typechecking pattern signature binders]
<a name="line-4097"></a>~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
<a name="line-4098"></a>See also Note [Type variables in the type environment] in GHC.Tc.Utils.
<a name="line-4099"></a>Consider
<a name="line-4100"></a>
<a name="line-4101"></a>  data T where
<a name="line-4102"></a>    MkT :: forall a. a -&gt; (a -&gt; Int) -&gt; T
<a name="line-4103"></a>
<a name="line-4104"></a>  f :: T -&gt; ...
<a name="line-4105"></a>  f (MkT x (f :: b -&gt; c)) = &lt;blah&gt;
<a name="line-4106"></a>
<a name="line-4107"></a>Here
<a name="line-4108"></a> * The pattern (MkT p1 p2) creates a *skolem* type variable 'a_sk',
<a name="line-4109"></a>   It must be a skolem so that it retains its identity, and
<a name="line-4110"></a>   GHC.Tc.Errors.getSkolemInfo can thereby find the binding site for the skolem.
<a name="line-4111"></a>
<a name="line-4112"></a> * The type signature pattern (f :: b -&gt; c) makes fresh meta-tyvars
<a name="line-4113"></a>   beta and gamma (TauTvs), and binds "b" :-&gt; beta, "c" :-&gt; gamma in the
<a name="line-4114"></a>   environment
<a name="line-4115"></a>
<a name="line-4116"></a> * Then unification makes beta := a_sk, gamma := Int
<a name="line-4117"></a>   That's why we must make beta and gamma a MetaTv,
<a name="line-4118"></a>   not a SkolemTv, so that it can unify to a_sk (or Int, respectively).
<a name="line-4119"></a>
<a name="line-4120"></a> * Finally, in '&lt;blah&gt;' we have the envt "b" :-&gt; beta, "c" :-&gt; gamma,
<a name="line-4121"></a>   so we return the pairs ("b" :-&gt; beta, "c" :-&gt; gamma) from tcHsPatSigType,
<a name="line-4122"></a>
<a name="line-4123"></a>Another example (#13881):
<a name="line-4124"></a>   fl :: forall (l :: [a]). Sing l -&gt; Sing l
<a name="line-4125"></a>   fl (SNil :: Sing (l :: [y])) = SNil
<a name="line-4126"></a>When we reach the pattern signature, 'l' is in scope from the
<a name="line-4127"></a>outer 'forall':
<a name="line-4128"></a>   "a" :-&gt; a_sk :: *
<a name="line-4129"></a>   "l" :-&gt; l_sk :: [a_sk]
<a name="line-4130"></a>We make up a fresh meta-TauTv, y_sig, for 'y', and kind-check
<a name="line-4131"></a>the pattern signature
<a name="line-4132"></a>   Sing (l :: [y])
<a name="line-4133"></a>That unifies y_sig := a_sk.  We return from tcHsPatSigType with
<a name="line-4134"></a>the pair ("y" :-&gt; y_sig).
<a name="line-4135"></a>
<a name="line-4136"></a>For RULE binders, though, things are a bit different (yuk).
<a name="line-4137"></a>  RULE "foo" forall (x::a) (y::[a]).  f x y = ...
<a name="line-4138"></a>Here this really is the binding site of the type variable so we'd like
<a name="line-4139"></a>to use a skolem, so that we get a complaint if we unify two of them
<a name="line-4140"></a>together.  Hence the new_implicit_tv function in tcHsPatSigType.
<a name="line-4141"></a>
<a name="line-4142"></a>
<a name="line-4143"></a>************************************************************************
<a name="line-4144"></a>*                                                                      *
<a name="line-4145"></a>        Checking kinds
<a name="line-4146"></a>*                                                                      *
<a name="line-4147"></a>************************************************************************
<a name="line-4148"></a>
<a name="line-4149"></a>-}</span>
<a name="line-4150"></a>
<a name="line-4151"></a><a name="unifyKinds"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>LHsType</span> <span class='hs-conid'>GhcRn</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>TcType</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>TcType</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcKind</span><span class='hs-layout'>)</span>
<a name="line-4152"></a><span class='hs-definition'>unifyKinds</span> <span class='hs-varid'>rn_tys</span> <span class='hs-varid'>act_kinds</span>
<a name="line-4153"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaKindVar</span>
<a name="line-4154"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>check</span> <span class='hs-varid'>rn_ty</span> <span class='hs-layout'>(</span><span class='hs-varid'>ty</span><span class='hs-layout'>,</span> <span class='hs-varid'>act_kind</span><span class='hs-layout'>)</span>
<a name="line-4155"></a>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkExpectedKind</span> <span class='hs-layout'>(</span><span class='hs-varid'>unLoc</span> <span class='hs-varid'>rn_ty</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>act_kind</span> <span class='hs-varid'>kind</span>
<a name="line-4156"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>tys'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zipWithM</span> <span class='hs-varid'>check</span> <span class='hs-varid'>rn_tys</span> <span class='hs-varid'>act_kinds</span>
<a name="line-4157"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tys'</span><span class='hs-layout'>,</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4158"></a>
<a name="line-4159"></a><span class='hs-comment'>{-
<a name="line-4160"></a>************************************************************************
<a name="line-4161"></a>*                                                                      *
<a name="line-4162"></a>        Sort checking kinds
<a name="line-4163"></a>*                                                                      *
<a name="line-4164"></a>************************************************************************
<a name="line-4165"></a>
<a name="line-4166"></a>tcLHsKindSig converts a user-written kind to an internal, sort-checked kind.
<a name="line-4167"></a>It does sort checking and desugaring at the same time, in one single pass.
<a name="line-4168"></a>-}</span>
<a name="line-4169"></a>
<a name="line-4170"></a><a name="tcLHsKindSig"></a><span class='hs-definition'>tcLHsKindSig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-4171"></a><span class='hs-definition'>tcLHsKindSig</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_kind</span>
<a name="line-4172"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tc_lhs_kind_sig</span> <span class='hs-varid'>kindLevelMode</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_kind</span>
<a name="line-4173"></a>
<a name="line-4174"></a><a name="tc_lhs_kind_sig"></a><span class='hs-definition'>tc_lhs_kind_sig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcTyMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>UserTypeCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LHsKind</span> <span class='hs-conid'>GhcRn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>Kind</span>
<a name="line-4175"></a><span class='hs-definition'>tc_lhs_kind_sig</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>hs_kind</span>
<a name="line-4176"></a><span class='hs-comment'>-- See  Note [Recipe for checking a signature] in GHC.Tc.Gen.HsType</span>
<a name="line-4177"></a><span class='hs-comment'>-- Result is zonked</span>
<a name="line-4178"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"In the kind"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_kind</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-4179"></a>                 <span class='hs-varid'>solveEqualities</span> <span class='hs-str'>"tcLHsKindSig"</span> <span class='hs-varop'>$</span>
<a name="line-4180"></a>                 <span class='hs-varid'>tc_lhs_type</span> <span class='hs-varid'>mode</span> <span class='hs-varid'>hs_kind</span> <span class='hs-varid'>liftedTypeKind</span>
<a name="line-4181"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcLHsKindSig"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>hs_kind</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-4182"></a>       <span class='hs-comment'>-- No generalization:</span>
<a name="line-4183"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kindGeneralizeNone</span> <span class='hs-varid'>kind</span>
<a name="line-4184"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>kind</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>kind</span>
<a name="line-4185"></a>         <span class='hs-comment'>-- This zonk is very important in the case of higher rank kinds</span>
<a name="line-4186"></a>         <span class='hs-comment'>-- E.g. #13879    f :: forall (p :: forall z (y::z). &lt;blah&gt;).</span>
<a name="line-4187"></a>         <span class='hs-comment'>--                          &lt;more blah&gt;</span>
<a name="line-4188"></a>         <span class='hs-comment'>--      When instantiating p's kind at occurrences of p in &lt;more blah&gt;</span>
<a name="line-4189"></a>         <span class='hs-comment'>--      it's crucial that the kind we instantiate is fully zonked,</span>
<a name="line-4190"></a>         <span class='hs-comment'>--      else we may fail to substitute properly</span>
<a name="line-4191"></a>
<a name="line-4192"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>checkValidType</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>kind</span>
<a name="line-4193"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tcLHsKindSig2"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>kind</span><span class='hs-layout'>)</span>
<a name="line-4194"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>kind</span> <span class='hs-layout'>}</span>
<a name="line-4195"></a>
<a name="line-4196"></a><a name="promotionErr"></a><span class='hs-definition'>promotionErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PromotionErr</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-4197"></a><span class='hs-definition'>promotionErr</span> <span class='hs-varid'>name</span> <span class='hs-varid'>err</span>
<a name="line-4198"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWithTc</span> <span class='hs-layout'>(</span><span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprPECategory</span> <span class='hs-varid'>err</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"cannot be used here"</span><span class='hs-layout'>)</span>
<a name="line-4199"></a>                   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-varid'>reason</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4200"></a>  <span class='hs-keyword'>where</span>
<a name="line-4201"></a>    <span class='hs-varid'>reason</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>err</span> <span class='hs-keyword'>of</span>
<a name="line-4202"></a>               <span class='hs-conid'>ConstrainedDataConPE</span> <span class='hs-varid'>pred</span>
<a name="line-4203"></a>                              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it has an unpromotable context"</span>
<a name="line-4204"></a>                                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-4205"></a>               <span class='hs-conid'>FamDataConPE</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it comes from a data family instance"</span>
<a name="line-4206"></a>               <span class='hs-conid'>NoDataKindsTC</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"perhaps you intended to use DataKinds"</span>
<a name="line-4207"></a>               <span class='hs-conid'>NoDataKindsDC</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"perhaps you intended to use DataKinds"</span>
<a name="line-4208"></a>               <span class='hs-conid'>PatSynPE</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"pattern synonyms cannot be promoted"</span>
<a name="line-4209"></a>               <span class='hs-conid'>RecDataConPE</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>same_rec_group_msg</span>
<a name="line-4210"></a>               <span class='hs-conid'>ClassPE</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>same_rec_group_msg</span>
<a name="line-4211"></a>               <span class='hs-conid'>TyConPE</span>        <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>same_rec_group_msg</span>
<a name="line-4212"></a>
<a name="line-4213"></a>    <span class='hs-varid'>same_rec_group_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"it is defined and used in the same recursive group"</span>
<a name="line-4214"></a>
<a name="line-4215"></a><span class='hs-comment'>{-
<a name="line-4216"></a>************************************************************************
<a name="line-4217"></a>*                                                                      *
<a name="line-4218"></a>          Error messages and such
<a name="line-4219"></a>*                                                                      *
<a name="line-4220"></a>************************************************************************
<a name="line-4221"></a>-}</span>
<a name="line-4222"></a>
<a name="line-4223"></a>
<a name="line-4224"></a><a name="funAppCtxt"></a><span class='hs-comment'>-- | Make an appropriate message for an error in a function argument.</span>
<a name="line-4225"></a><span class='hs-comment'>-- Used for both expressions and types.</span>
<a name="line-4226"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Outputable</span> <span class='hs-varid'>fun</span><span class='hs-layout'>,</span> <span class='hs-conid'>Outputable</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>fun</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>arg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-4227"></a><span class='hs-definition'>funAppCtxt</span> <span class='hs-varid'>fun</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>arg_no</span>
<a name="line-4228"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>,</span> <span class='hs-varid'>speakNth</span> <span class='hs-varid'>arg_no</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"argument of"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-4229"></a>                    <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>fun</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>", namely"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-4230"></a>       <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>arg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-4231"></a>
<a name="line-4232"></a><a name="addTyConFlavCtxt"></a><span class='hs-comment'>-- | Add a "In the data declaration for T" or some such.</span>
<a name="line-4233"></a><span class='hs-definition'>addTyConFlavCtxt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TyConFlavour</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-4234"></a><span class='hs-definition'>addTyConFlavCtxt</span> <span class='hs-varid'>name</span> <span class='hs-varid'>flav</span>
<a name="line-4235"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addErrCtxt</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hsep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"In the"</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>flav</span>
<a name="line-4236"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"declaration for"</span><span class='hs-layout'>,</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre></body>
</html>

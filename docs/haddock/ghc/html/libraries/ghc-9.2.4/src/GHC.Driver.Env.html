<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Driver.Env</span><span>
</span><span id="line-4"></span><span>   </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#Hsc"><span class="hs-identifier">Hsc</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-5"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier">HscEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hsc_home_unit"><span class="hs-identifier">hsc_home_unit</span></a></span><span>
</span><span id="line-7"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hsc_units"><span class="hs-identifier">hsc_units</span></a></span><span>
</span><span id="line-8"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#runHsc"><span class="hs-identifier">runHsc</span></a></span><span>
</span><span id="line-9"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#mkInteractiveHscEnv"><span class="hs-identifier">mkInteractiveHscEnv</span></a></span><span>
</span><span id="line-10"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#runInteractiveHsc"><span class="hs-identifier">runInteractiveHsc</span></a></span><span>
</span><span id="line-11"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hscEPS"><span class="hs-identifier">hscEPS</span></a></span><span>
</span><span id="line-12"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hptCompleteSigs"><span class="hs-identifier">hptCompleteSigs</span></a></span><span>
</span><span id="line-13"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hptInstances"><span class="hs-identifier">hptInstances</span></a></span><span>
</span><span id="line-14"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hptAnns"><span class="hs-identifier">hptAnns</span></a></span><span>
</span><span id="line-15"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hptAllThings"><span class="hs-identifier">hptAllThings</span></a></span><span>
</span><span id="line-16"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hptSomeThingsBelowUs"><span class="hs-identifier">hptSomeThingsBelowUs</span></a></span><span>
</span><span id="line-17"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#hptRules"><span class="hs-identifier">hptRules</span></a></span><span>
</span><span id="line-18"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#prepareAnnotations"><span class="hs-identifier">prepareAnnotations</span></a></span><span>
</span><span id="line-19"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#lookupType"><span class="hs-identifier">lookupType</span></a></span><span>
</span><span id="line-20"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#lookupIfaceByModule"><span class="hs-identifier">lookupIfaceByModule</span></a></span><span>
</span><span id="line-21"></span><span>   </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html#mainModIs"><span class="hs-identifier">mainModIs</span></a></span><span>
</span><span id="line-22"></span><span>   </span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">where</span><span class="hs-cpp">

#include &quot;HsVersions.h&quot;
</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Ppr.html"><span class="hs-identifier">GHC.Driver.Ppr</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Errors.html"><span class="hs-identifier">GHC.Driver.Errors</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Errors.html#printOrThrowWarnings"><span class="hs-identifier">printOrThrowWarnings</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Runtime.Context.html"><span class="hs-identifier">GHC.Runtime.Context</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html"><span class="hs-identifier">GHC.Driver.Env.Types</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#Hsc"><span class="hs-identifier">Hsc</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier">HscEnv</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.html"><span class="hs-identifier">GHC.Unit</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html"><span class="hs-identifier">GHC.Unit.Module.ModGuts</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html"><span class="hs-identifier">GHC.Unit.Module.ModIface</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModDetails.html"><span class="hs-identifier">GHC.Unit.Module.ModDetails</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.Deps.html"><span class="hs-identifier">GHC.Unit.Module.Deps</span></a></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Home.ModInfo.html"><span class="hs-identifier">GHC.Unit.Home.ModInfo</span></a></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Env.html"><span class="hs-identifier">GHC.Unit.Env</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.External.html"><span class="hs-identifier">GHC.Unit.External</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.html"><span class="hs-identifier">GHC.Core</span></a></span><span>         </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier">CoreRule</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.FamInstEnv.html"><span class="hs-identifier">GHC.Core.FamInstEnv</span></a></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html"><span class="hs-identifier">GHC.Core.InstEnv</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Core.InstEnv.html#ClsInst"><span class="hs-identifier">ClsInst</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html"><span class="hs-identifier">GHC.Types.Annotations</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#Annotation"><span class="hs-identifier">Annotation</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#AnnEnv"><span class="hs-identifier">AnnEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#mkAnnEnv"><span class="hs-identifier">mkAnnEnv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#plusAnnEnv"><span class="hs-identifier">plusAnnEnv</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.CompleteMatch.html"><span class="hs-identifier">GHC.Types.CompleteMatch</span></a></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.html"><span class="hs-identifier">GHC.Types.Name</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Name.Env.html"><span class="hs-identifier">GHC.Types.Name.Env</span></a></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html"><span class="hs-identifier">GHC.Types.TyThing</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html"><span class="hs-identifier">GHC.Builtin.Names</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="GHC.Builtin.Names.html#gHC_PRIM"><span class="hs-identifier">gHC_PRIM</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Bag.html"><span class="hs-identifier">GHC.Data.Bag</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Monad.html"><span class="hs-identifier">GHC.Utils.Monad</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Control-Monad.html#"><span class="hs-identifier">Control.Monad</span></a></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Control-Monad.html#guard"><span class="hs-identifier">guard</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Data-IORef.html#"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span id="local-6989586621681142592"><span class="annot"><a href="GHC.Driver.Env.html#runHsc"><span class="hs-identifier hs-type">runHsc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#Hsc"><span class="hs-identifier hs-type">Hsc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681142592"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681142592"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-69"></span><span id="runHsc"><span class="annot"><span class="annottext">runHsc :: forall a. HscEnv -&gt; Hsc a -&gt; IO a
</span><a href="GHC.Driver.Env.html#runHsc"><span class="hs-identifier hs-var hs-var">runHsc</span></a></span></span><span> </span><span id="local-6989586621681142458"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142458"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Env.Types.html#Hsc"><span class="hs-identifier hs-type">Hsc</span></a></span><span> </span><span id="local-6989586621681142456"><span class="annot"><span class="annottext">HscEnv -&gt; WarningMessages -&gt; IO (a, WarningMessages)
</span><a href="#local-6989586621681142456"><span class="hs-identifier hs-var">hsc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681142455"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681142455"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681142454"><span class="annot"><span class="annottext">WarningMessages
</span><a href="#local-6989586621681142454"><span class="hs-identifier hs-var">w</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; WarningMessages -&gt; IO (a, WarningMessages)
</span><a href="#local-6989586621681142456"><span class="hs-identifier hs-var">hsc</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142458"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Bag a
</span><a href="GHC.Data.Bag.html#emptyBag"><span class="hs-identifier hs-var">emptyBag</span></a></span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><span class="annottext">Logger -&gt; DynFlags -&gt; WarningMessages -&gt; IO ()
</span><a href="GHC.Driver.Errors.html#printOrThrowWarnings"><span class="hs-identifier hs-var">printOrThrowWarnings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; Logger
</span><a href="GHC.Driver.Env.Types.html#hsc_logger"><span class="hs-identifier hs-var">hsc_logger</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142458"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142458"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">WarningMessages
</span><a href="#local-6989586621681142454"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681142455"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">-- | Switches in the DynFlags and Plugins from the InteractiveContext</span><span>
</span><span id="line-75"></span><span class="annot"><a href="GHC.Driver.Env.html#mkInteractiveHscEnv"><span class="hs-identifier hs-type">mkInteractiveHscEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span>
</span><span id="line-76"></span><span id="mkInteractiveHscEnv"><span class="annot"><span class="annottext">mkInteractiveHscEnv :: HscEnv -&gt; HscEnv
</span><a href="GHC.Driver.Env.html#mkInteractiveHscEnv"><span class="hs-identifier hs-var hs-var">mkInteractiveHscEnv</span></a></span></span><span> </span><span id="local-6989586621681142450"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142450"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681142449"><span class="annot"><span class="annottext">ic :: InteractiveContext
</span><a href="#local-6989586621681142449"><span class="hs-identifier hs-var hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; InteractiveContext
</span><a href="GHC.Driver.Env.Types.html#hsc_IC"><span class="hs-identifier hs-var">hsc_IC</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142450"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142450"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">hsc_dflags :: DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InteractiveContext -&gt; DynFlags
</span><a href="GHC.Runtime.Context.html#ic_dflags"><span class="hs-identifier hs-var">ic_dflags</span></a></span><span>  </span><span class="annot"><span class="annottext">InteractiveContext
</span><a href="#local-6989586621681142449"><span class="hs-identifier hs-var">ic</span></a></span><span>
</span><span id="line-79"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">hsc_plugins :: [LoadedPlugin]
</span><a href="GHC.Driver.Env.Types.html#hsc_plugins"><span class="hs-identifier hs-var">hsc_plugins</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InteractiveContext -&gt; [LoadedPlugin]
</span><a href="GHC.Runtime.Context.html#ic_plugins"><span class="hs-identifier hs-var">ic_plugins</span></a></span><span> </span><span class="annot"><span class="annottext">InteractiveContext
</span><a href="#local-6989586621681142449"><span class="hs-identifier hs-var">ic</span></a></span><span>
</span><span id="line-80"></span><span>               </span><span class="hs-special">}</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- | A variant of runHsc that switches in the DynFlags and Plugins from the</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- InteractiveContext before running the Hsc computation.</span><span>
</span><span id="line-84"></span><span id="local-6989586621681142444"><span class="annot"><a href="GHC.Driver.Env.html#runInteractiveHsc"><span class="hs-identifier hs-type">runInteractiveHsc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#Hsc"><span class="hs-identifier hs-type">Hsc</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681142444"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681142444"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-85"></span><span id="runInteractiveHsc"><span class="annot"><span class="annottext">runInteractiveHsc :: forall a. HscEnv -&gt; Hsc a -&gt; IO a
</span><a href="GHC.Driver.Env.html#runInteractiveHsc"><span class="hs-identifier hs-var hs-var">runInteractiveHsc</span></a></span></span><span> </span><span id="local-6989586621681142443"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142443"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HscEnv -&gt; Hsc a -&gt; IO a
</span><a href="GHC.Driver.Env.html#runHsc"><span class="hs-identifier hs-var">runHsc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; HscEnv
</span><a href="GHC.Driver.Env.html#mkInteractiveHscEnv"><span class="hs-identifier hs-var">mkInteractiveHscEnv</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142443"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><a href="GHC.Driver.Env.html#hsc_home_unit"><span class="hs-identifier hs-type">hsc_home_unit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Home.html#HomeUnit"><span class="hs-identifier hs-type">HomeUnit</span></a></span><span>
</span><span id="line-88"></span><span id="hsc_home_unit"><span class="annot"><span class="annottext">hsc_home_unit :: HscEnv -&gt; HomeUnit
</span><a href="GHC.Driver.Env.html#hsc_home_unit"><span class="hs-identifier hs-var hs-var">hsc_home_unit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; HomeUnit
</span><a href="GHC.Unit.Env.html#ue_home_unit"><span class="hs-identifier hs-var">ue_home_unit</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; UnitEnv
</span><a href="GHC.Driver.Env.Types.html#hsc_unit_env"><span class="hs-identifier hs-var">hsc_unit_env</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="annot"><a href="GHC.Driver.Env.html#hsc_units"><span class="hs-identifier hs-type">hsc_units</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.State.html#UnitState"><span class="hs-identifier hs-type">UnitState</span></a></span><span>
</span><span id="line-91"></span><span id="hsc_units"><span class="annot"><span class="annottext">hsc_units :: HscEnv -&gt; UnitState
</span><a href="GHC.Driver.Env.html#hsc_units"><span class="hs-identifier hs-var hs-var">hsc_units</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnitEnv -&gt; UnitState
</span><a href="GHC.Unit.Env.html#ue_units"><span class="hs-identifier hs-var">ue_units</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; UnitEnv
</span><a href="GHC.Driver.Env.Types.html#hsc_unit_env"><span class="hs-identifier hs-var">hsc_unit_env</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="hs-comment">{-

Note [Target code interpreter]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Template Haskell and GHCi use an interpreter to execute code that is built for
the compiler target platform (= code host platform) on the compiler host
platform (= code build platform).

The internal interpreter can be used when both platforms are the same and when
the built code is compatible with the compiler itself (same way, etc.). This
interpreter is not always available: for instance stage1 compiler doesn't have
it because there might be an ABI mismatch between the code objects (built by
stage1 compiler) and the stage1 compiler itself (built by stage0 compiler).

In most cases, an external interpreter can be used instead: it runs in a
separate process and it communicates with the compiler via a two-way message
passing channel. The process is lazily spawned to avoid overhead when it is not
used.

The target code interpreter to use can be selected per session via the
`hsc_interp` field of `HscEnv`. There may be no interpreter available at all, in
which case Template Haskell and GHCi will fail to run. The interpreter to use is
configured via command-line flags (in `GHC.setSessionDynFlags`).


-}</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- Note [hsc_type_env_var hack]</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span>
</span><span id="line-123"></span><span class="hs-comment">-- hsc_type_env_var is used to initialize tcg_type_env_var, and</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- eventually it is the mutable variable that is queried from</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- if_rec_types to get a TypeEnv.  So, clearly, it's something</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- related to knot-tying (see Note [Tying the knot]).</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- hsc_type_env_var is used in two places: initTcRn (where</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- it initializes tcg_type_env_var) and initIfaceCheck</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- (where it initializes if_rec_types).</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- But why do we need a way to feed a mutable variable in?  Why</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- can't we just initialize tcg_type_env_var when we start</span><span>
</span><span id="line-133"></span><span class="hs-comment">-- typechecking?  The problem is we need to knot-tie the</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- EPS, and we may start adding things to the EPS before type</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- checking starts.</span><span>
</span><span id="line-136"></span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- Here is a concrete example. Suppose we are running</span><span>
</span><span id="line-138"></span><span class="hs-comment">-- &quot;ghc -c A.hs&quot;, and we have this file system state:</span><span>
</span><span id="line-139"></span><span class="hs-comment">--</span><span>
</span><span id="line-140"></span><span class="hs-comment">--  A.hs-boot   A.hi-boot **up to date**</span><span>
</span><span id="line-141"></span><span class="hs-comment">--  B.hs        B.hi      **up to date**</span><span>
</span><span id="line-142"></span><span class="hs-comment">--  A.hs        A.hi      **stale**</span><span>
</span><span id="line-143"></span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- The first thing we do is run checkOldIface on A.hi.</span><span>
</span><span id="line-145"></span><span class="hs-comment">-- checkOldIface will call loadInterface on B.hi so it can</span><span>
</span><span id="line-146"></span><span class="hs-comment">-- get its hands on the fingerprints, to find out if A.hi</span><span>
</span><span id="line-147"></span><span class="hs-comment">-- needs recompilation.  But loadInterface also populates</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- the EPS!  And so if compilation turns out to be necessary,</span><span>
</span><span id="line-149"></span><span class="hs-comment">-- as it is in this case, the thunks we put into the EPS for</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- B.hi need to have the correct if_rec_types mutable variable</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- to query.</span><span>
</span><span id="line-152"></span><span class="hs-comment">--</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- If the mutable variable is only allocated WHEN we start</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- typechecking, then that's too late: we can't get the</span><span>
</span><span id="line-155"></span><span class="hs-comment">-- information to the thunks.  So we need to pre-commit</span><span>
</span><span id="line-156"></span><span class="hs-comment">-- to a type variable in 'hscIncrementalCompile' BEFORE we</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- check the old interface.</span><span>
</span><span id="line-158"></span><span class="hs-comment">--</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- This is all a massive hack because arguably checkOldIface</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- should not populate the EPS. But that's a refactor for</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- another day.</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">-- | Retrieve the ExternalPackageState cache.</span><span>
</span><span id="line-164"></span><span class="annot"><a href="GHC.Driver.Env.html#hscEPS"><span class="hs-identifier hs-type">hscEPS</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Unit.External.html#ExternalPackageState"><span class="hs-identifier hs-type">ExternalPackageState</span></a></span><span>
</span><span id="line-165"></span><span id="hscEPS"><span class="annot"><span class="annottext">hscEPS :: HscEnv -&gt; IO ExternalPackageState
</span><a href="GHC.Driver.Env.html#hscEPS"><span class="hs-identifier hs-var hs-var">hscEPS</span></a></span></span><span> </span><span id="local-6989586621681142438"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142438"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. IORef a -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; IORef ExternalPackageState
</span><a href="GHC.Driver.Env.Types.html#hsc_EPS"><span class="hs-identifier hs-var">hsc_EPS</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142438"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span class="annot"><a href="GHC.Driver.Env.html#hptCompleteSigs"><span class="hs-identifier hs-type">hptCompleteSigs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.CompleteMatch.html#CompleteMatch"><span class="hs-identifier hs-type">CompleteMatch</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-168"></span><span id="hptCompleteSigs"><span class="annot"><span class="annottext">hptCompleteSigs :: HscEnv -&gt; [CompleteMatch]
</span><a href="GHC.Driver.Env.html#hptCompleteSigs"><span class="hs-identifier hs-var hs-var">hptCompleteSigs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (HomeModInfo -&gt; [a]) -&gt; HscEnv -&gt; [a]
</span><a href="GHC.Driver.Env.html#hptAllThings"><span class="hs-identifier hs-var">hptAllThings</span></a></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModDetails -&gt; [CompleteMatch]
</span><a href="GHC.Unit.Module.ModDetails.html#md_complete_matches"><span class="hs-identifier hs-var">md_complete_matches</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModDetails
</span><a href="GHC.Unit.Home.ModInfo.html#hm_details"><span class="hs-identifier hs-var">hm_details</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span class="hs-comment">-- | Find all the instance declarations (of classes and families) from</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- the Home Package Table filtered by the provided predicate function.</span><span>
</span><span id="line-172"></span><span class="hs-comment">-- Used in @tcRnImports@, to select the instances that are in the</span><span>
</span><span id="line-173"></span><span class="hs-comment">-- transitive closure of imports from the currently compiled module.</span><span>
</span><span id="line-174"></span><span class="annot"><a href="GHC.Driver.Env.html#hptInstances"><span class="hs-identifier hs-type">hptInstances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Module.Name.html#ModuleName"><span class="hs-identifier hs-type">ModuleName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.InstEnv.html#ClsInst"><span class="hs-identifier hs-type">ClsInst</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.FamInstEnv.html#FamInst"><span class="hs-identifier hs-type">FamInst</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span id="hptInstances"><span class="annot"><span class="annottext">hptInstances :: HscEnv -&gt; (ModuleName -&gt; Bool) -&gt; ([ClsInst], [FamInst])
</span><a href="GHC.Driver.Env.html#hptInstances"><span class="hs-identifier hs-var hs-var">hptInstances</span></a></span></span><span> </span><span id="local-6989586621681142433"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142433"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621681142432"><span class="annot"><span class="annottext">ModuleName -&gt; Bool
</span><a href="#local-6989586621681142432"><span class="hs-identifier hs-var">want_this_module</span></a></span></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621681142431"><span class="annot"><span class="annottext">[[ClsInst]]
</span><a href="#local-6989586621681142431"><span class="hs-identifier hs-var">insts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681142430"><span class="annot"><span class="annottext">[[FamInst]]
</span><a href="#local-6989586621681142430"><span class="hs-identifier hs-var">famInsts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. [(a, b)] -&gt; ([a], [b])
</span><a href="../../base-4.16.3.0/src/GHC-List.html#unzip"><span class="hs-identifier hs-var">unzip</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#flip"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. (HomeModInfo -&gt; [a]) -&gt; HscEnv -&gt; [a]
</span><a href="GHC.Driver.Env.html#hptAllThings"><span class="hs-identifier hs-var">hptAllThings</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142433"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681142427"><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142427"><span class="hs-identifier hs-var">mod_info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>                </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../../base-4.16.3.0/src/Control-Monad.html#guard"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModuleName -&gt; Bool
</span><a href="#local-6989586621681142432"><span class="hs-identifier hs-var">want_this_module</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (phase :: ModIfacePhase). ModIface_ phase -&gt; Module
</span><a href="GHC.Unit.Module.ModIface.html#mi_module"><span class="hs-identifier hs-var">mi_module</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModIface
</span><a href="GHC.Unit.Home.ModInfo.html#hm_iface"><span class="hs-identifier hs-var">hm_iface</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142427"><span class="hs-identifier hs-var">mod_info</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681142423"><span class="annot"><span class="annottext">details :: ModDetails
</span><a href="#local-6989586621681142423"><span class="hs-identifier hs-var hs-var">details</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModDetails
</span><a href="GHC.Unit.Home.ModInfo.html#hm_details"><span class="hs-identifier hs-var">hm_details</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142427"><span class="hs-identifier hs-var">mod_info</span></a></span><span>
</span><span id="line-179"></span><span>                </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModDetails -&gt; [ClsInst]
</span><a href="GHC.Unit.Module.ModDetails.html#md_insts"><span class="hs-identifier hs-var">md_insts</span></a></span><span> </span><span class="annot"><span class="annottext">ModDetails
</span><a href="#local-6989586621681142423"><span class="hs-identifier hs-var">details</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ModDetails -&gt; [FamInst]
</span><a href="GHC.Unit.Module.ModDetails.html#md_fam_insts"><span class="hs-identifier hs-var">md_fam_insts</span></a></span><span> </span><span class="annot"><span class="annottext">ModDetails
</span><a href="#local-6989586621681142423"><span class="hs-identifier hs-var">details</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../../base-4.16.3.0/src/Data-Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">[[ClsInst]]
</span><a href="#local-6989586621681142431"><span class="hs-identifier hs-var">insts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../../base-4.16.3.0/src/Data-Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">[[FamInst]]
</span><a href="#local-6989586621681142430"><span class="hs-identifier hs-var">famInsts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | Get rules from modules &quot;below&quot; this one (in the dependency sense)</span><span>
</span><span id="line-183"></span><span class="annot"><a href="GHC.Driver.Env.html#hptRules"><span class="hs-identifier hs-type">hptRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#ModuleNameWithIsBoot"><span class="hs-identifier hs-type">ModuleNameWithIsBoot</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Core.html#CoreRule"><span class="hs-identifier hs-type">CoreRule</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span id="hptRules"><span class="annot"><span class="annottext">hptRules :: HscEnv -&gt; [ModuleNameWithIsBoot] -&gt; [CoreRule]
</span><a href="GHC.Driver.Env.html#hptRules"><span class="hs-identifier hs-var hs-var">hptRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
(HomeModInfo -&gt; [a])
-&gt; Bool -&gt; HscEnv -&gt; [ModuleNameWithIsBoot] -&gt; [a]
</span><a href="GHC.Driver.Env.html#hptSomeThingsBelowUs"><span class="hs-identifier hs-var">hptSomeThingsBelowUs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModDetails -&gt; [CoreRule]
</span><a href="GHC.Unit.Module.ModDetails.html#md_rules"><span class="hs-identifier hs-var">md_rules</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModDetails
</span><a href="GHC.Unit.Home.ModInfo.html#hm_details"><span class="hs-identifier hs-var">hm_details</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-comment">-- | Get annotations from modules &quot;below&quot; this one (in the dependency sense)</span><span>
</span><span id="line-188"></span><span class="annot"><a href="GHC.Driver.Env.html#hptAnns"><span class="hs-identifier hs-type">hptAnns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#ModuleNameWithIsBoot"><span class="hs-identifier hs-type">ModuleNameWithIsBoot</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Types.Annotations.html#Annotation"><span class="hs-identifier hs-type">Annotation</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-189"></span><span id="hptAnns"><span class="annot"><span class="annottext">hptAnns :: HscEnv -&gt; Maybe [ModuleNameWithIsBoot] -&gt; [Annotation]
</span><a href="GHC.Driver.Env.html#hptAnns"><span class="hs-identifier hs-var hs-var">hptAnns</span></a></span></span><span> </span><span id="local-6989586621681142418"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142418"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681142417"><span class="annot"><span class="annottext">[ModuleNameWithIsBoot]
</span><a href="#local-6989586621681142417"><span class="hs-identifier hs-var">deps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a.
(HomeModInfo -&gt; [a])
-&gt; Bool -&gt; HscEnv -&gt; [ModuleNameWithIsBoot] -&gt; [a]
</span><a href="GHC.Driver.Env.html#hptSomeThingsBelowUs"><span class="hs-identifier hs-var">hptSomeThingsBelowUs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModDetails -&gt; [Annotation]
</span><a href="GHC.Unit.Module.ModDetails.html#md_anns"><span class="hs-identifier hs-var">md_anns</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModDetails
</span><a href="GHC.Unit.Home.ModInfo.html#hm_details"><span class="hs-identifier hs-var">hm_details</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142418"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">[ModuleNameWithIsBoot]
</span><a href="#local-6989586621681142417"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-190"></span><span class="annot"><a href="GHC.Driver.Env.html#hptAnns"><span class="hs-identifier hs-var">hptAnns</span></a></span><span> </span><span id="local-6989586621681142415"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142415"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe [ModuleNameWithIsBoot]
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (HomeModInfo -&gt; [a]) -&gt; HscEnv -&gt; [a]
</span><a href="GHC.Driver.Env.html#hptAllThings"><span class="hs-identifier hs-var">hptAllThings</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModDetails -&gt; [Annotation]
</span><a href="GHC.Unit.Module.ModDetails.html#md_anns"><span class="hs-identifier hs-var">md_anns</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModDetails
</span><a href="GHC.Unit.Home.ModInfo.html#hm_details"><span class="hs-identifier hs-var">hm_details</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142415"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span id="local-6989586621681142569"><span class="annot"><a href="GHC.Driver.Env.html#hptAllThings"><span class="hs-identifier hs-type">hptAllThings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Home.ModInfo.html#HomeModInfo"><span class="hs-identifier hs-type">HomeModInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681142569"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681142569"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-193"></span><span id="hptAllThings"><span class="annot"><span class="annottext">hptAllThings :: forall a. (HomeModInfo -&gt; [a]) -&gt; HscEnv -&gt; [a]
</span><a href="GHC.Driver.Env.html#hptAllThings"><span class="hs-identifier hs-var hs-var">hptAllThings</span></a></span></span><span> </span><span id="local-6989586621681142413"><span class="annot"><span class="annottext">HomeModInfo -&gt; [a]
</span><a href="#local-6989586621681142413"><span class="hs-identifier hs-var">extract</span></a></span></span><span> </span><span id="local-6989586621681142412"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142412"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><a href="../../base-4.16.3.0/src/Data-Foldable.html#concatMap"><span class="hs-identifier hs-var">concatMap</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; [a]
</span><a href="#local-6989586621681142413"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HomePackageTable -&gt; [HomeModInfo]
</span><a href="GHC.Unit.Home.ModInfo.html#eltsHpt"><span class="hs-identifier hs-var">eltsHpt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; HomePackageTable
</span><a href="GHC.Driver.Env.Types.html#hsc_HPT"><span class="hs-identifier hs-var">hsc_HPT</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142412"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span class="hs-comment">-- | Get things from modules &quot;below&quot; this one (in the dependency sense)</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- C.f Inst.hptInstances</span><span>
</span><span id="line-197"></span><span id="local-6989586621681142544"><span class="annot"><a href="GHC.Driver.Env.html#hptSomeThingsBelowUs"><span class="hs-identifier hs-type">hptSomeThingsBelowUs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Unit.Home.ModInfo.html#HomeModInfo"><span class="hs-identifier hs-type">HomeModInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681142544"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="GHC.Unit.Types.html#ModuleNameWithIsBoot"><span class="hs-identifier hs-type">ModuleNameWithIsBoot</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621681142544"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-198"></span><span id="hptSomeThingsBelowUs"><span class="annot"><span class="annottext">hptSomeThingsBelowUs :: forall a.
(HomeModInfo -&gt; [a])
-&gt; Bool -&gt; HscEnv -&gt; [ModuleNameWithIsBoot] -&gt; [a]
</span><a href="GHC.Driver.Env.html#hptSomeThingsBelowUs"><span class="hs-identifier hs-var hs-var">hptSomeThingsBelowUs</span></a></span></span><span> </span><span id="local-6989586621681142402"><span class="annot"><span class="annottext">HomeModInfo -&gt; [a]
</span><a href="#local-6989586621681142402"><span class="hs-identifier hs-var">extract</span></a></span></span><span> </span><span id="local-6989586621681142401"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681142401"><span class="hs-identifier hs-var">include_hi_boot</span></a></span></span><span> </span><span id="local-6989586621681142400"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142400"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621681142399"><span class="annot"><span class="annottext">[ModuleNameWithIsBoot]
</span><a href="#local-6989586621681142399"><span class="hs-identifier hs-var">deps</span></a></span></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">GhcMode -&gt; Bool
</span><a href="GHC.Driver.Session.html#isOneShot"><span class="hs-identifier hs-var">isOneShot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; GhcMode
</span><a href="GHC.Driver.Session.html#ghcMode"><span class="hs-identifier hs-var">ghcMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142400"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681142396"><span class="annot"><span class="annottext">hpt :: HomePackageTable
</span><a href="#local-6989586621681142396"><span class="hs-identifier hs-var hs-var">hpt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; HomePackageTable
</span><a href="GHC.Driver.Env.Types.html#hsc_HPT"><span class="hs-identifier hs-var">hsc_HPT</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142400"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-203"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681142395"><span class="hs-identifier hs-var">thing</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-glyph">|</span><span>   </span><span class="hs-comment">-- Find each non-hi-boot module below me</span><span>
</span><span id="line-206"></span><span>      </span><span class="annot"><a href="GHC.Unit.Types.html#GWIB"><span class="hs-identifier hs-type">GWIB</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">gwib_mod :: forall mod. GenWithIsBoot mod -&gt; mod
</span><a href="GHC.Unit.Types.html#gwib_mod"><span class="hs-identifier hs-var">gwib_mod</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681142392"><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681142392"><span class="hs-identifier hs-var">mod</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">gwib_isBoot :: forall mod. GenWithIsBoot mod -&gt; IsBootInterface
</span><a href="GHC.Unit.Types.html#gwib_isBoot"><span class="hs-identifier hs-var">gwib_isBoot</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="local-6989586621681142390"><span class="annot"><span class="annottext">IsBootInterface
</span><a href="#local-6989586621681142390"><span class="hs-identifier hs-var">is_boot</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ModuleNameWithIsBoot]
</span><a href="#local-6989586621681142399"><span class="hs-identifier hs-var">deps</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681142401"><span class="hs-identifier hs-var">include_hi_boot</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IsBootInterface
</span><a href="#local-6989586621681142390"><span class="hs-identifier hs-var">is_boot</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">IsBootInterface
</span><a href="GHC.Unit.Types.html#NotBoot"><span class="hs-identifier hs-var">NotBoot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span>        </span><span class="hs-comment">-- unsavoury: when compiling the base package with --make, we</span><span>
</span><span id="line-210"></span><span>        </span><span class="hs-comment">-- sometimes try to look up RULES etc for GHC.Prim. GHC.Prim won't</span><span>
</span><span id="line-211"></span><span>        </span><span class="hs-comment">-- be in the HPT, because we never compile it; it's in the EPT</span><span>
</span><span id="line-212"></span><span>        </span><span class="hs-comment">-- instead. ToDo: clean up, and remove this slightly bogus filter:</span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681142392"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="GHC.Builtin.Names.html#gHC_PRIM"><span class="hs-identifier hs-var">gHC_PRIM</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-comment">-- Look it up in the HPT</span><span>
</span><span id="line-216"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681142386"><span class="annot"><span class="annottext">things :: [a]
</span><a href="#local-6989586621681142386"><span class="hs-identifier hs-var hs-var">things</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HomePackageTable -&gt; ModuleName -&gt; Maybe HomeModInfo
</span><a href="GHC.Unit.Home.ModInfo.html#lookupHpt"><span class="hs-identifier hs-var">lookupHpt</span></a></span><span> </span><span class="annot"><span class="annottext">HomePackageTable
</span><a href="#local-6989586621681142396"><span class="hs-identifier hs-var">hpt</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681142392"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-217"></span><span>                    </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681142384"><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142384"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; [a]
</span><a href="#local-6989586621681142402"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142384"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-218"></span><span>                    </span><span class="annot"><span class="annottext">Maybe HomeModInfo
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. String -&gt; SDoc -&gt; a -&gt; a
</span><a href="GHC.Driver.Ppr.html#pprTrace"><span class="hs-identifier hs-var">pprTrace</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;WARNING in hptSomeThingsBelowUs&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc
</span><a href="#local-6989586621681142382"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-219"></span><span>          </span><span id="local-6989586621681142382"><span class="annot"><span class="annottext">msg :: SDoc
</span><a href="#local-6989586621681142382"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SDoc] -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#vcat"><span class="hs-identifier hs-var">vcat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;missing module&quot;</span></span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#%3C%2B%3E"><span class="hs-operator hs-var">&lt;+&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">ModuleName
</span><a href="#local-6989586621681142392"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-220"></span><span>                      </span><span class="annot"><span class="annottext">String -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#text"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Probable cause: out-of-date interface files&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-221"></span><span>                        </span><span class="hs-comment">-- This really shouldn't happen, but see #962</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span>        </span><span class="hs-comment">-- And get its dfuns</span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="local-6989586621681142395"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681142395"><span class="hs-identifier hs-var">thing</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681142386"><span class="hs-identifier hs-var">things</span></a></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>
</span><span id="line-227"></span><span class="hs-comment">-- | Deal with gathering annotations in from all possible places</span><span>
</span><span id="line-228"></span><span class="hs-comment">--   and combining them into a single 'AnnEnv'</span><span>
</span><span id="line-229"></span><span class="annot"><a href="GHC.Driver.Env.html#prepareAnnotations"><span class="hs-identifier hs-type">prepareAnnotations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModGuts.html#ModGuts"><span class="hs-identifier hs-type">ModGuts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Types.Annotations.html#AnnEnv"><span class="hs-identifier hs-type">AnnEnv</span></a></span><span>
</span><span id="line-230"></span><span id="prepareAnnotations"><span class="annot"><span class="annottext">prepareAnnotations :: HscEnv -&gt; Maybe ModGuts -&gt; IO AnnEnv
</span><a href="GHC.Driver.Env.html#prepareAnnotations"><span class="hs-identifier hs-var hs-var">prepareAnnotations</span></a></span></span><span> </span><span id="local-6989586621681142377"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142377"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621681142376"><span class="annot"><span class="annottext">Maybe ModGuts
</span><a href="#local-6989586621681142376"><span class="hs-identifier hs-var">mb_guts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>    </span><span id="local-6989586621681142375"><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681142375"><span class="hs-identifier hs-var">eps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; IO ExternalPackageState
</span><a href="GHC.Driver.Env.html#hscEPS"><span class="hs-identifier hs-var">hscEPS</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142377"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- Extract annotations from the module being compiled if supplied one</span><span>
</span><span id="line-233"></span><span>        </span><span id="local-6989586621681142374"><span class="annot"><span class="annottext">mb_this_module_anns :: Maybe AnnEnv
</span><a href="#local-6989586621681142374"><span class="hs-identifier hs-var hs-var">mb_this_module_anns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Annotation] -&gt; AnnEnv
</span><a href="GHC.Types.Annotations.html#mkAnnEnv"><span class="hs-identifier hs-var">mkAnnEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; [Annotation]
</span><a href="GHC.Unit.Module.ModGuts.html#mg_anns"><span class="hs-identifier hs-var">mg_anns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ModGuts
</span><a href="#local-6989586621681142376"><span class="hs-identifier hs-var">mb_guts</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-comment">-- Extract dependencies of the module if we are supplied one,</span><span>
</span><span id="line-235"></span><span>        </span><span class="hs-comment">-- otherwise load annotations from all home package table</span><span>
</span><span id="line-236"></span><span>        </span><span class="hs-comment">-- entries regardless of dependency ordering.</span><span>
</span><span id="line-237"></span><span>        </span><span id="local-6989586621681142372"><span class="annot"><span class="annottext">home_pkg_anns :: AnnEnv
</span><a href="#local-6989586621681142372"><span class="hs-identifier hs-var hs-var">home_pkg_anns</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Annotation] -&gt; AnnEnv
</span><a href="GHC.Types.Annotations.html#mkAnnEnv"><span class="hs-identifier hs-var">mkAnnEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Maybe [ModuleNameWithIsBoot] -&gt; [Annotation]
</span><a href="GHC.Driver.Env.html#hptAnns"><span class="hs-identifier hs-var">hptAnns</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142377"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Dependencies -&gt; [ModuleNameWithIsBoot]
</span><a href="GHC.Unit.Module.Deps.html#dep_mods"><span class="hs-identifier hs-var">dep_mods</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ModGuts -&gt; Dependencies
</span><a href="GHC.Unit.Module.ModGuts.html#mg_deps"><span class="hs-identifier hs-var">mg_deps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe ModGuts
</span><a href="#local-6989586621681142376"><span class="hs-identifier hs-var">mb_guts</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span id="local-6989586621681142369"><span class="annot"><span class="annottext">other_pkg_anns :: AnnEnv
</span><a href="#local-6989586621681142369"><span class="hs-identifier hs-var hs-var">other_pkg_anns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExternalPackageState -&gt; AnnEnv
</span><a href="GHC.Unit.External.html#eps_ann_env"><span class="hs-identifier hs-var">eps_ann_env</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681142375"><span class="hs-identifier hs-var">eps</span></a></span><span>
</span><span id="line-239"></span><span>        </span><span id="local-6989586621681142367"><span class="annot"><span class="annottext">ann_env :: AnnEnv
</span><a href="#local-6989586621681142367"><span class="hs-identifier hs-var hs-var">ann_env</span></a></span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. (a -&gt; a -&gt; a) -&gt; [a] -&gt; a
</span><a href="../../base-4.16.3.0/src/GHC-List.html#foldl1%27"><span class="hs-identifier hs-var">foldl1'</span></a></span><span> </span><span class="annot"><span class="annottext">AnnEnv -&gt; AnnEnv -&gt; AnnEnv
</span><a href="GHC.Types.Annotations.html#plusAnnEnv"><span class="hs-identifier hs-var">plusAnnEnv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [Maybe a] -&gt; [a]
</span><a href="../../base-4.16.3.0/src/Data-Maybe.html#catMaybes"><span class="hs-identifier hs-var">catMaybes</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Maybe AnnEnv
</span><a href="#local-6989586621681142374"><span class="hs-identifier hs-var">mb_this_module_anns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>                                                         </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AnnEnv
</span><a href="#local-6989586621681142372"><span class="hs-identifier hs-var">home_pkg_anns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-241"></span><span>                                                         </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">AnnEnv
</span><a href="#local-6989586621681142369"><span class="hs-identifier hs-var">other_pkg_anns</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-242"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">AnnEnv
</span><a href="#local-6989586621681142367"><span class="hs-identifier hs-var">ann_env</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | Find the 'TyThing' for the given 'Name' by using all the resources</span><span>
</span><span id="line-245"></span><span class="hs-comment">-- at our disposal: the compiled modules in the 'HomePackageTable' and the</span><span>
</span><span id="line-246"></span><span class="hs-comment">-- compiled modules in other packages that live in 'PackageTypeEnv'. Note</span><span>
</span><span id="line-247"></span><span class="hs-comment">-- that this does NOT look up the 'TyThing' in the module being compiled: you</span><span>
</span><span id="line-248"></span><span class="hs-comment">-- have to do that yourself, if desired</span><span>
</span><span id="line-249"></span><span class="annot"><a href="GHC.Driver.Env.html#lookupType"><span class="hs-identifier hs-type">lookupType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.Name.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Types.TyThing.html#TyThing"><span class="hs-identifier hs-type">TyThing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span id="lookupType"><span class="annot"><span class="annottext">lookupType :: HscEnv -&gt; Name -&gt; IO (Maybe TyThing)
</span><a href="GHC.Driver.Env.html#lookupType"><span class="hs-identifier hs-var hs-var">lookupType</span></a></span></span><span> </span><span id="local-6989586621681142364"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142364"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621681142363"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681142363"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>   </span><span id="local-6989586621681142362"><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681142362"><span class="hs-identifier hs-var">eps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. IORef a -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IORef.html#readIORef"><span class="hs-identifier hs-var">readIORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; IORef ExternalPackageState
</span><a href="GHC.Driver.Env.Types.html#hsc_EPS"><span class="hs-identifier hs-var">hsc_EPS</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142364"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681142360"><span class="annot"><span class="annottext">pte :: PackageTypeEnv
</span><a href="#local-6989586621681142360"><span class="hs-identifier hs-var hs-var">pte</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExternalPackageState -&gt; PackageTypeEnv
</span><a href="GHC.Unit.External.html#eps_PTE"><span class="hs-identifier hs-var">eps_PTE</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalPackageState
</span><a href="#local-6989586621681142362"><span class="hs-identifier hs-var">eps</span></a></span><span>
</span><span id="line-253"></span><span>       </span><span id="local-6989586621681142358"><span class="annot"><span class="annottext">hpt :: HomePackageTable
</span><a href="#local-6989586621681142358"><span class="hs-identifier hs-var hs-var">hpt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; HomePackageTable
</span><a href="GHC.Driver.Env.Types.html#hsc_HPT"><span class="hs-identifier hs-var">hsc_HPT</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142364"><span class="hs-identifier hs-var">hsc_env</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>       </span><span id="local-6989586621681142357"><span class="annot"><span class="annottext">mod :: Module
</span><a href="#local-6989586621681142357"><span class="hs-identifier hs-var hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">ASSERT2</span><span class="hs-special">(</span><span> </span><span class="hs-identifier">isExternalName</span><span> </span><span class="hs-identifier">name</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">ppr</span><span> </span><span class="hs-identifier">name</span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>             </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Bool
</span><a href="GHC.Types.Name.html#isHoleName"><span class="hs-identifier hs-var">isHoleName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681142363"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-257"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">HomeUnit -&gt; ModuleName -&gt; Module
</span><a href="GHC.Unit.Home.html#mkHomeModule"><span class="hs-identifier hs-var">mkHomeModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; HomeUnit
</span><a href="GHC.Driver.Env.html#hsc_home_unit"><span class="hs-identifier hs-var">hsc_home_unit</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142364"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681142363"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">HasDebugCallStack =&gt; Name -&gt; Module
</span><a href="GHC.Types.Name.html#nameModule"><span class="hs-identifier hs-var">nameModule</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681142363"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>       </span><span class="hs-glyph">!</span><span id="local-6989586621681142348"><span class="annot"><span class="annottext">ty :: Maybe TyThing
</span><a href="#local-6989586621681142348"><span class="hs-identifier hs-var hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">GhcMode -&gt; Bool
</span><a href="GHC.Driver.Session.html#isOneShot"><span class="hs-identifier hs-var">isOneShot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; GhcMode
</span><a href="GHC.Driver.Session.html#ghcMode"><span class="hs-identifier hs-var">ghcMode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142364"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>               </span><span class="hs-comment">-- in one-shot, we don't use the HPT</span><span>
</span><span id="line-262"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall a. NameEnv a -&gt; Name -&gt; Maybe a
</span><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">PackageTypeEnv
</span><a href="#local-6989586621681142360"><span class="hs-identifier hs-var">pte</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681142363"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-263"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HomePackageTable -&gt; Module -&gt; Maybe HomeModInfo
</span><a href="GHC.Unit.Home.ModInfo.html#lookupHptByModule"><span class="hs-identifier hs-var">lookupHptByModule</span></a></span><span> </span><span class="annot"><span class="annottext">HomePackageTable
</span><a href="#local-6989586621681142358"><span class="hs-identifier hs-var">hpt</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681142357"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-264"></span><span>                </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681142345"><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142345"><span class="hs-identifier hs-var">hm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. NameEnv a -&gt; Name -&gt; Maybe a
</span><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModDetails -&gt; PackageTypeEnv
</span><a href="GHC.Unit.Module.ModDetails.html#md_types"><span class="hs-identifier hs-var">md_types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModDetails
</span><a href="GHC.Unit.Home.ModInfo.html#hm_details"><span class="hs-identifier hs-var">hm_details</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142345"><span class="hs-identifier hs-var">hm</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681142363"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-265"></span><span>                </span><span class="annot"><span class="annottext">Maybe HomeModInfo
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. NameEnv a -&gt; Name -&gt; Maybe a
</span><a href="GHC.Types.Name.Env.html#lookupNameEnv"><span class="hs-identifier hs-var">lookupNameEnv</span></a></span><span> </span><span class="annot"><span class="annottext">PackageTypeEnv
</span><a href="#local-6989586621681142360"><span class="hs-identifier hs-var">pte</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621681142363"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-266"></span><span>   </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe TyThing
</span><a href="#local-6989586621681142348"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">-- | Find the 'ModIface' for a 'Module', searching in both the loaded home</span><span>
</span><span id="line-269"></span><span class="hs-comment">-- and external package module information</span><span>
</span><span id="line-270"></span><span class="annot"><a href="GHC.Driver.Env.html#lookupIfaceByModule"><span class="hs-identifier hs-type">lookupIfaceByModule</span></a></span><span>
</span><span id="line-271"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Home.ModInfo.html#HomePackageTable"><span class="hs-identifier hs-type">HomePackageTable</span></a></span><span>
</span><span id="line-272"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.External.html#PackageIfaceTable"><span class="hs-identifier hs-type">PackageIfaceTable</span></a></span><span>
</span><span id="line-273"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>
</span><span id="line-274"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html#ModIface"><span class="hs-identifier hs-type">ModIface</span></a></span><span>
</span><span id="line-275"></span><span id="lookupIfaceByModule"><span class="annot"><span class="annottext">lookupIfaceByModule :: HomePackageTable -&gt; PackageIfaceTable -&gt; Module -&gt; Maybe ModIface
</span><a href="GHC.Driver.Env.html#lookupIfaceByModule"><span class="hs-identifier hs-var hs-var">lookupIfaceByModule</span></a></span></span><span> </span><span id="local-6989586621681142343"><span class="annot"><span class="annottext">HomePackageTable
</span><a href="#local-6989586621681142343"><span class="hs-identifier hs-var">hpt</span></a></span></span><span> </span><span id="local-6989586621681142342"><span class="annot"><span class="annottext">PackageIfaceTable
</span><a href="#local-6989586621681142342"><span class="hs-identifier hs-var">pit</span></a></span></span><span> </span><span id="local-6989586621681142341"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681142341"><span class="hs-identifier hs-var">mod</span></a></span></span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HomePackageTable -&gt; Module -&gt; Maybe HomeModInfo
</span><a href="GHC.Unit.Home.ModInfo.html#lookupHptByModule"><span class="hs-identifier hs-var">lookupHptByModule</span></a></span><span> </span><span class="annot"><span class="annottext">HomePackageTable
</span><a href="#local-6989586621681142343"><span class="hs-identifier hs-var">hpt</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681142341"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-277"></span><span>       </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681142340"><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142340"><span class="hs-identifier hs-var">hm</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModIface
</span><a href="GHC.Unit.Home.ModInfo.html#hm_iface"><span class="hs-identifier hs-var">hm_iface</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681142340"><span class="hs-identifier hs-var">hm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>       </span><span class="annot"><span class="annottext">Maybe HomeModInfo
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. ModuleEnv a -&gt; Module -&gt; Maybe a
</span><a href="GHC.Unit.Module.Env.html#lookupModuleEnv"><span class="hs-identifier hs-var">lookupModuleEnv</span></a></span><span> </span><span class="annot"><span class="annottext">PackageIfaceTable
</span><a href="#local-6989586621681142342"><span class="hs-identifier hs-var">pit</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681142341"><span class="hs-identifier hs-var">mod</span></a></span><span>
</span><span id="line-279"></span><span>   </span><span class="hs-comment">-- If the module does come from the home package, why do we look in the PIT as well?</span><span>
</span><span id="line-280"></span><span>   </span><span class="hs-comment">-- (a) In OneShot mode, even home-package modules accumulate in the PIT</span><span>
</span><span id="line-281"></span><span>   </span><span class="hs-comment">-- (b) Even in Batch (--make) mode, there is *one* case where a home-package</span><span>
</span><span id="line-282"></span><span>   </span><span class="hs-comment">--     module is in the PIT, namely GHC.Prim when compiling the base package.</span><span>
</span><span id="line-283"></span><span>   </span><span class="hs-comment">-- We could eliminate (b) if we wanted, by making GHC.Prim belong to a package</span><span>
</span><span id="line-284"></span><span>   </span><span class="hs-comment">-- of its own, but it doesn't seem worth the bother.</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="annot"><a href="GHC.Driver.Env.html#mainModIs"><span class="hs-identifier hs-type">mainModIs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Unit.Types.html#Module"><span class="hs-identifier hs-type">Module</span></a></span><span>
</span><span id="line-287"></span><span id="mainModIs"><span class="annot"><span class="annottext">mainModIs :: HscEnv -&gt; Module
</span><a href="GHC.Driver.Env.html#mainModIs"><span class="hs-identifier hs-var hs-var">mainModIs</span></a></span></span><span> </span><span id="local-6989586621681142338"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142338"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HomeUnit -&gt; ModuleName -&gt; Module
</span><a href="GHC.Unit.Home.html#mkHomeModule"><span class="hs-identifier hs-var">mkHomeModule</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; HomeUnit
</span><a href="GHC.Driver.Env.html#hsc_home_unit"><span class="hs-identifier hs-var">hsc_home_unit</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142338"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; ModuleName
</span><a href="GHC.Driver.Session.html#mainModuleNameIs"><span class="hs-identifier hs-var">mainModuleNameIs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681142338"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-288"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE BangPatterns #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE CPP #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- | Interacting with the iserv interpreter, whether it is running on an</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- external process or in the current process.</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">GHC.Runtime.Interpreter</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html"><span class="hs-identifier">GHC.Runtime.Interpreter.Types</span></a></span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span>  </span><span class="annot"><span class="hs-comment">-- * High-level interface to the interpreter</span></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalStmt"><span class="hs-identifier">evalStmt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStatus_"><span class="hs-identifier">EvalStatus_</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStatus"><span class="hs-identifier">EvalStatus</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalResult"><span class="hs-identifier">EvalResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalExpr"><span class="hs-identifier">EvalExpr</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#resumeStmt"><span class="hs-identifier">resumeStmt</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#abandonStmt"><span class="hs-identifier">abandonStmt</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalIO"><span class="hs-identifier">evalIO</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalString"><span class="hs-identifier">evalString</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalStringToIOString"><span class="hs-identifier">evalStringToIOString</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mallocData"><span class="hs-identifier">mallocData</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#createBCOs"><span class="hs-identifier">createBCOs</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#addSptEntry"><span class="hs-identifier">addSptEntry</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkCostCentres"><span class="hs-identifier">mkCostCentres</span></a></span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#costCentreStackInfo"><span class="hs-identifier">costCentreStackInfo</span></a></span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#newBreakArray"><span class="hs-identifier">newBreakArray</span></a></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#storeBreakpoint"><span class="hs-identifier">storeBreakpoint</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#breakpointStatus"><span class="hs-identifier">breakpointStatus</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#getBreakpointVar"><span class="hs-identifier">getBreakpointVar</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#getClosure"><span class="hs-identifier">getClosure</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#getModBreaks"><span class="hs-identifier">getModBreaks</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#seqHValue"><span class="hs-identifier">seqHValue</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier">interpreterDynamic</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpreterProfiled"><span class="hs-identifier">interpreterProfiled</span></a></span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><span class="hs-comment">-- * The object-code linker</span></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#initObjLinker"><span class="hs-identifier">initObjLinker</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#lookupSymbol"><span class="hs-identifier">lookupSymbol</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#lookupClosure"><span class="hs-identifier">lookupClosure</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier">loadDLL</span></a></span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadArchive"><span class="hs-identifier">loadArchive</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadObj"><span class="hs-identifier">loadObj</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#unloadObj"><span class="hs-identifier">unloadObj</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#addLibrarySearchPath"><span class="hs-identifier">addLibrarySearchPath</span></a></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#removeLibrarySearchPath"><span class="hs-identifier">removeLibrarySearchPath</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#resolveObjs"><span class="hs-identifier">resolveObjs</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#findSystemLibrary"><span class="hs-identifier">findSystemLibrary</span></a></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Lower-level API using messages</span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier">interpCmd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#Message"><span class="hs-identifier">Message</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#withIServ"><span class="hs-identifier">withIServ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#withIServ_"><span class="hs-identifier">withIServ_</span></a></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#hscInterp"><span class="hs-identifier">hscInterp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#stopInterp"><span class="hs-identifier">stopInterp</span></a></span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#iservCall"><span class="hs-identifier">iservCall</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#readIServ"><span class="hs-identifier">readIServ</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#writeIServ"><span class="hs-identifier">writeIServ</span></a></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#purgeLookupSymbolCache"><span class="hs-identifier">purgeLookupSymbolCache</span></a></span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#freeHValueRefs"><span class="hs-identifier">freeHValueRefs</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier">mkFinalizedHValue</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#wormhole"><span class="hs-identifier">wormhole</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#wormholeRef"><span class="hs-identifier">wormholeRef</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkEvalOpts"><span class="hs-identifier">mkEvalOpts</span></a></span><span>
</span><span id="line-57"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.html#fromEvalResult"><span class="hs-identifier">fromEvalResult</span></a></span><span>
</span><span id="line-58"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Prelude.html"><span class="hs-identifier">GHC.Prelude</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Ppr.html"><span class="hs-identifier">GHC.Driver.Ppr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Driver.Ppr.html#showSDoc"><span class="hs-identifier">showSDoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Env.html"><span class="hs-identifier">GHC.Driver.Env</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html"><span class="hs-identifier">GHC.Driver.Session</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html"><span class="hs-identifier">GHC.Runtime.Interpreter.Types</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#"><span class="hs-identifier">GHCi.Message</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#"><span class="hs-identifier">GHCi.RemoteTypes</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-ResolvedBCO.html#"><span class="hs-identifier">GHCi.ResolvedBCO</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-BreakArray.html#"><span class="hs-identifier">GHCi.BreakArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-BreakArray.html#BreakArray"><span class="hs-identifier">BreakArray</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Runtime.Eval.Types.html"><span class="hs-identifier">GHC.Runtime.Eval.Types</span></a></span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Eval.Types.html#BreakInfo"><span class="hs-identifier">BreakInfo</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.ByteCode.Types.html"><span class="hs-identifier">GHC.ByteCode.Types</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html"><span class="hs-identifier">GHC.Linker.Types</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.Maybe.html"><span class="hs-identifier">GHC.Data.Maybe</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html"><span class="hs-identifier">GHC.Data.FastString</span></a></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.html"><span class="hs-identifier">GHC.Types.Unique</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html"><span class="hs-identifier">GHC.Types.SrcLoc</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Unique.FM.html"><span class="hs-identifier">GHC.Types.Unique.FM</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Types.Basic.html"><span class="hs-identifier">GHC.Types.Basic</span></a></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Panic.html"><span class="hs-identifier">GHC.Utils.Panic</span></a></span><span>
</span><span id="line-85"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Exception.html"><span class="hs-identifier">GHC.Utils.Exception</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ex</span></span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html"><span class="hs-identifier">GHC.Utils.Outputable</span></a></span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier">brackets</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier">ppr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Fingerprint.html"><span class="hs-identifier">GHC.Utils.Fingerprint</span></a></span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Utils.Misc.html"><span class="hs-identifier">GHC.Utils.Misc</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.html"><span class="hs-identifier">GHC.Unit.Module</span></a></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Module.ModIface.html"><span class="hs-identifier">GHC.Unit.Module.ModIface</span></a></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Unit.Home.ModInfo.html"><span class="hs-identifier">GHC.Unit.Home.ModInfo</span></a></span><span class="hs-cpp">

#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Run.html#"><span class="hs-identifier">GHCi.Run</span></a></span><span>
</span><span id="line-96"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="GHC.Platform.Ways.html"><span class="hs-identifier">GHC.Platform.Ways</span></a></span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-99"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Control-Concurrent.html#"><span class="hs-identifier">Control.Concurrent</span></a></span><span>
</span><span id="line-100"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Control-Monad.html#"><span class="hs-identifier">Control.Monad</span></a></span><span>
</span><span id="line-101"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#"><span class="hs-identifier">Control.Monad.IO.Class</span></a></span><span>
</span><span id="line-102"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../exceptions-0.10.4/src/Control-Monad-Catch.html#"><span class="hs-identifier">Control.Monad.Catch</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../exceptions-0.10.4/src/Control-Monad-Catch.html#mask"><span class="hs-identifier">mask</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../exceptions-0.10.4/src/Control-Monad-Catch.html#onException"><span class="hs-identifier">onException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../binary-0.8.9.0/src/Data-Binary.html#"><span class="hs-identifier">Data.Binary</span></a></span><span>
</span><span id="line-104"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../binary-0.8.9.0/src/Data-Binary-Put.html#"><span class="hs-identifier">Data.Binary.Put</span></a></span><span>
</span><span id="line-105"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../bytestring-0.11.3.1/src/Data-ByteString.html#"><span class="hs-identifier">Data.ByteString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../bytestring-0.11.3.1/src/Data-ByteString-Internal.html#ByteString"><span class="hs-identifier">ByteString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../bytestring-0.11.3.1/src/Data-ByteString-Lazy.html#"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LB</span></span><span>
</span><span id="line-107"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../array-0.5.4.0/src/Data-Array.html#"><span class="hs-identifier">Data.Array</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Arr.html#%21"><span class="hs-operator">(!)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Data-IORef.html#"><span class="hs-identifier">Data.IORef</span></a></span><span>
</span><span id="line-109"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/Foreign.html#"><span class="hs-identifier">Foreign</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/Foreign-Marshal-Error.html#void"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-110"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="../../ghc-heap-9.2.4/src/GHC-Exts-Heap.html#"><span class="hs-identifier">GHC.Exts.Heap</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Heap</span></span><span>
</span><span id="line-111"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Stack-CCS.html#"><span class="hs-identifier">GHC.Stack.CCS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Stack-CCS.html#CostCentre"><span class="hs-identifier">CostCentre</span></a></span><span class="hs-special">,</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Stack-CCS.html#CostCentreStack"><span class="hs-identifier">CostCentreStack</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/System-Exit.html#"><span class="hs-identifier">System.Exit</span></a></span><span>
</span><span id="line-113"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-IO-Handle-Types.html#"><span class="hs-identifier">GHC.IO.Handle.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-IO-Handle-Types.html#Handle"><span class="hs-identifier">Handle</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">Foreign.C</span><span>
</span><span id="line-116"></span><span class="hs-keyword">import</span><span> </span><span class="hs-identifier">GHC.IO.Handle.FD</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdToHandle</span><span class="hs-special">)</span><span class="hs-cpp">
#else
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../unix-2.7.2.2/src/System-Posix.html#"><span class="hs-identifier">System.Posix</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Posix</span></span><span class="hs-cpp">
#endif
</span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../directory-1.3.6.2/src/System-Directory.html#"><span class="hs-identifier">System.Directory</span></a></span><span>
</span><span id="line-121"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../process-1.6.13.2/src/System-Process.html#"><span class="hs-identifier">System.Process</span></a></span><span>
</span><span id="line-122"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Conc.html#"><span class="hs-identifier">GHC.Conc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#getNumProcessors"><span class="hs-identifier">getNumProcessors</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#pseq"><span class="hs-identifier">pseq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#par"><span class="hs-identifier">par</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-comment">{- Note [Remote GHCi]

When the flag -fexternal-interpreter is given to GHC, interpreted code
is run in a separate process called iserv, and we communicate with the
external process over a pipe using Binary-encoded messages.

Motivation
~~~~~~~~~~

When the interpreted code is running in a separate process, it can
use a different &quot;way&quot;, e.g. profiled or dynamic.  This means

- compiling Template Haskell code with -prof does not require
  building the code without -prof first

- when GHC itself is profiled, it can interpret unprofiled code,
  and the same applies to dynamic linking.

- An unprofiled GHCi can load and run profiled code, which means it
  can use the stack-trace functionality provided by profiling without
  taking the performance hit on the compiler that profiling would
  entail.

For other reasons see remote-GHCi on the wiki.

Implementation Overview
~~~~~~~~~~~~~~~~~~~~~~~

The main pieces are:

- libraries/ghci, containing:
  - types for talking about remote values (GHCi.RemoteTypes)
  - the message protocol (GHCi.Message),
  - implementation of the messages (GHCi.Run)
  - implementation of Template Haskell (GHCi.TH)
  - a few other things needed to run interpreted code

- top-level iserv directory, containing the codefor the external
  server.  This is a fairly simple wrapper, most of the functionality
  is provided by modules in libraries/ghci.

- This module which provides the interface to the server used
  by the rest of GHC.

GHC works with and without -fexternal-interpreter.  With the flag, all
interpreted code is run by the iserv binary.  Without the flag,
interpreted code is run in the same process as GHC.

Things that do not work with -fexternal-interpreter
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

dynCompileExpr cannot work, because we have no way to run code of an
unknown type in the remote process.  This API fails with an error
message if it is used with -fexternal-interpreter.

Other Notes on Remote GHCi
~~~~~~~~~~~~~~~~~~~~~~~~~~
  * This wiki page has an implementation overview:
    https://gitlab.haskell.org/ghc/ghc/wikis/commentary/compiler/external-interpreter
  * Note [External GHCi pointers] in &quot;GHC.Runtime.Interpreter&quot;
  * Note [Remote Template Haskell] in libraries/ghci/GHCi/TH.hs
-}</span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-comment">-- | Run a command in the interpreter's context.  With</span><span>
</span><span id="line-189"></span><span class="hs-comment">-- @-fexternal-interpreter@, the command is serialized and sent to an</span><span>
</span><span id="line-190"></span><span class="hs-comment">-- external iserv process, and the response is deserialized (hence the</span><span>
</span><span id="line-191"></span><span class="hs-comment">-- @Binary@ constraint).  With @-fno-external-interpreter@ we execute</span><span>
</span><span id="line-192"></span><span class="hs-comment">-- the command directly here.</span><span>
</span><span id="line-193"></span><span id="local-6989586621681207554"><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-type">interpCmd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../binary-0.8.9.0/src/Data-Binary-Class.html#Binary"><span class="hs-identifier hs-type">Binary</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207554"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207554"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207554"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-194"></span><span id="interpCmd"><span class="annot"><span class="annottext">interpCmd :: forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var hs-var">interpCmd</span></a></span></span><span> </span><span id="local-6989586621681207159"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207159"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207158"><span class="annot"><span class="annottext">Message a
</span><a href="#local-6989586621681207158"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207159"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>  </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. Message a -&gt; IO a
</span><a href="../../ghci-9.2.4/src/GHCi-Run.html#run"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="annot"><span class="annottext">Message a
</span><a href="#local-6989586621681207158"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-comment">-- Just run it directly</span><span class="hs-cpp">
#endif
</span><span>  </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span id="local-6989586621681207153"><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681207153"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681207152"><span class="annot"><span class="annottext">IServ
</span><a href="#local-6989586621681207152"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
(MonadIO m, ExceptionMonad m) =&gt;
IServConfig -&gt; IServ -&gt; (IServInstance -&gt; m a) -&gt; m a
</span><a href="GHC.Runtime.Interpreter.html#withIServ_"><span class="hs-identifier hs-var">withIServ_</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681207153"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">IServ
</span><a href="#local-6989586621681207152"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207151"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207151"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>    </span><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#uninterruptibleMask_"><span class="hs-identifier hs-var">uninterruptibleMask_</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-comment">-- Note [uninterruptibleMask_]</span><span>
</span><span id="line-200"></span><span>      </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; IServInstance -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207151"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="annot"><span class="annottext">Message a
</span><a href="#local-6989586621681207158"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-comment">-- | Retrieve the target code interpreter</span><span>
</span><span id="line-204"></span><span class="hs-comment">--</span><span>
</span><span id="line-205"></span><span class="hs-comment">-- Fails if no target code interpreter is available</span><span>
</span><span id="line-206"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#hscInterp"><span class="hs-identifier hs-type">hscInterp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-207"></span><span id="hscInterp"><span class="annot"><span class="annottext">hscInterp :: HscEnv -&gt; Interp
</span><a href="GHC.Runtime.Interpreter.html#hscInterp"><span class="hs-identifier hs-var hs-var">hscInterp</span></a></span></span><span> </span><span id="local-6989586621681207149"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681207149"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">HscEnv -&gt; Maybe Interp
</span><a href="GHC.Driver.Env.Types.html#hsc_interp"><span class="hs-identifier hs-var">hsc_interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681207149"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-208"></span><span>   </span><span class="annot"><span class="annottext">Maybe Interp
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a e. Exception e =&gt; e -&gt; a
</span><a href="../../base-4.16.3.0/src/GHC-Exception.html#throw"><span class="hs-identifier hs-var">throw</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><a href="GHC.Utils.Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Couldn't find a target code interpreter. Try with -fexternal-interpreter&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>   </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681207145"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207145"><span class="hs-identifier hs-var">i</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207145"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-comment">-- Note [uninterruptibleMask_ and interpCmd]</span><span>
</span><span id="line-212"></span><span class="hs-comment">--</span><span>
</span><span id="line-213"></span><span class="hs-comment">-- If we receive an async exception, such as ^C, while communicating</span><span>
</span><span id="line-214"></span><span class="hs-comment">-- with the iserv process then we will be out-of-sync and not be able</span><span>
</span><span id="line-215"></span><span class="hs-comment">-- to recover.  Thus we use uninterruptibleMask_ during</span><span>
</span><span id="line-216"></span><span class="hs-comment">-- communication.  A ^C will be delivered to the iserv process (because</span><span>
</span><span id="line-217"></span><span class="hs-comment">-- signals get sent to the whole process group) which will interrupt</span><span>
</span><span id="line-218"></span><span class="hs-comment">-- the running computation and return an EvalException result.</span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="hs-comment">-- | Grab a lock on the 'IServ' and do something with it.</span><span>
</span><span id="line-221"></span><span class="hs-comment">-- Overloaded because this is used from TcM as well as IO.</span><span>
</span><span id="line-222"></span><span id="local-6989586621681207533"><span id="local-6989586621681207534"><span class="annot"><a href="GHC.Runtime.Interpreter.html#withIServ"><span class="hs-identifier hs-type">withIServ</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Utils.Exception.html#ExceptionMonad"><span class="hs-identifier hs-type">ExceptionMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207534"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServConfig"><span class="hs-identifier hs-type">IServConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServ"><span class="hs-identifier hs-type">IServ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681207534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621681207533"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681207534"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207533"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-225"></span><span id="withIServ"><span class="annot"><span class="annottext">withIServ :: forall (m :: * -&gt; *) a.
ExceptionMonad m =&gt;
IServConfig
-&gt; IServ -&gt; (IServInstance -&gt; m (IServInstance, a)) -&gt; m a
</span><a href="GHC.Runtime.Interpreter.html#withIServ"><span class="hs-identifier hs-var hs-var">withIServ</span></a></span></span><span> </span><span id="local-6989586621681207117"><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681207117"><span class="hs-identifier hs-var">conf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServ"><span class="hs-identifier hs-type">IServ</span></a></span><span> </span><span id="local-6989586621681207115"><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681207115"><span class="hs-identifier hs-var">mIServState</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681207114"><span class="annot"><span class="annottext">IServInstance -&gt; m (IServInstance, a)
</span><a href="#local-6989586621681207114"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><a href="../../exceptions-0.10.4/src/Control-Monad-Catch.html#mask"><span class="hs-identifier hs-var">MC.mask</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207113"><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621681207113"><span class="hs-identifier hs-var">restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-227"></span><span>    </span><span id="local-6989586621681207112"><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681207112"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681207115"><span class="hs-identifier hs-var">mIServState</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621681207109"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207109"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681207112"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-comment">-- start the external iserv process if we haven't done so yet</span><span>
</span><span id="line-231"></span><span>      </span><span class="annot"><span class="annottext">IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServPending"><span class="hs-identifier hs-var">IServPending</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>         </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServConfig -&gt; IO IServInstance
</span><a href="GHC.Runtime.Interpreter.html#spawnIServ"><span class="hs-identifier hs-var">spawnIServ</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681207117"><span class="hs-identifier hs-var">conf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-233"></span><span>           </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><a href="../../exceptions-0.10.4/src/Control-Monad-Catch.html#onException"><span class="hs-operator hs-var">`MC.onException`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/GHC-MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681207115"><span class="hs-identifier hs-var">mIServState</span></a></span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681207112"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span>      </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-type">IServRunning</span></a></span><span> </span><span id="local-6989586621681207104"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207104"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207104"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681207103"><span class="annot"><span class="annottext">iserv' :: IServInstance
</span><a href="#local-6989586621681207103"><span class="hs-identifier hs-var hs-var">iserv'</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207109"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">iservPendingFrees :: [HValueRef]
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPendingFrees"><span class="hs-identifier hs-var">iservPendingFrees</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681207101"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207101"><span class="hs-identifier hs-var">iserv''</span></a></span></span><span class="hs-special">,</span><span id="local-6989586621681207100"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681207100"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>      </span><span class="hs-comment">-- free any ForeignHValues that have been garbage collected.</span><span>
</span><span id="line-242"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../../base-4.16.3.0/src/Data-Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; [HValueRef]
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPendingFrees"><span class="hs-identifier hs-var">iservPendingFrees</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207109"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; IServInstance -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207109"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HValueRef] -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#FreeHValueRefs"><span class="hs-identifier hs-var">FreeHValueRefs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; [HValueRef]
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPendingFrees"><span class="hs-identifier hs-var">iservPendingFrees</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207109"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-244"></span><span>      </span><span class="hs-comment">-- run the inner action</span><span>
</span><span id="line-245"></span><span>      </span><span class="annot"><span class="annottext">forall a. m a -&gt; m a
</span><a href="#local-6989586621681207113"><span class="hs-identifier hs-var">restore</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance -&gt; m (IServInstance, a)
</span><a href="#local-6989586621681207114"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207103"><span class="hs-identifier hs-var">iserv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. MonadCatch m =&gt; m a -&gt; m b -&gt; m a
</span><a href="../../exceptions-0.10.4/src/Control-Monad-Catch.html#onException"><span class="hs-operator hs-var">`MC.onException`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/GHC-MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681207115"><span class="hs-identifier hs-var">mIServState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-var">IServRunning</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207103"><span class="hs-identifier hs-var">iserv'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/GHC-MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681207115"><span class="hs-identifier hs-var">mIServState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-var">IServRunning</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207101"><span class="hs-identifier hs-var">iserv''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681207100"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span id="local-6989586621681207544"><span id="local-6989586621681207546"><span class="annot"><a href="GHC.Runtime.Interpreter.html#withIServ_"><span class="hs-identifier hs-type">withIServ_</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#MonadIO"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207546"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="GHC.Utils.Exception.html#ExceptionMonad"><span class="hs-identifier hs-type">ExceptionMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207546"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServConfig"><span class="hs-identifier hs-type">IServConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServ"><span class="hs-identifier hs-type">IServ</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681207546"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207544"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621681207546"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207544"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-253"></span><span id="withIServ_"><span class="annot"><span class="annottext">withIServ_ :: forall (m :: * -&gt; *) a.
(MonadIO m, ExceptionMonad m) =&gt;
IServConfig -&gt; IServ -&gt; (IServInstance -&gt; m a) -&gt; m a
</span><a href="GHC.Runtime.Interpreter.html#withIServ_"><span class="hs-identifier hs-var hs-var">withIServ_</span></a></span></span><span> </span><span id="local-6989586621681207085"><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681207085"><span class="hs-identifier hs-var">conf</span></a></span></span><span> </span><span id="local-6989586621681207084"><span class="annot"><span class="annottext">IServ
</span><a href="#local-6989586621681207084"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span id="local-6989586621681207083"><span class="annot"><span class="annottext">IServInstance -&gt; m a
</span><a href="#local-6989586621681207083"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
ExceptionMonad m =&gt;
IServConfig
-&gt; IServ -&gt; (IServInstance -&gt; m (IServInstance, a)) -&gt; m a
</span><a href="GHC.Runtime.Interpreter.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681207085"><span class="hs-identifier hs-var">conf</span></a></span><span> </span><span class="annot"><span class="annottext">IServ
</span><a href="#local-6989586621681207084"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207082"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207082"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-254"></span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207082"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance -&gt; m a
</span><a href="#local-6989586621681207083"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681207082"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-255"></span><span>
</span><span id="line-256"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- Wrappers around messages</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="hs-comment">-- | Execute an action of type @IO [a]@, returning 'ForeignHValue's for</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- each of the results.</span><span>
</span><span id="line-261"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalStmt"><span class="hs-identifier hs-type">evalStmt</span></a></span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-comment">-- used by mkEvalOpts</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>     </span><span class="hs-comment">-- &quot;step&quot; for mkEvalOpts</span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalExpr"><span class="hs-identifier hs-type">EvalExpr</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStatus_"><span class="hs-identifier hs-type">EvalStatus_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span id="evalStmt"><span class="annot"><span class="annottext">evalStmt :: Interp
-&gt; DynFlags
-&gt; Bool
-&gt; EvalExpr ForeignHValue
-&gt; IO (EvalStatus_ [ForeignHValue] [HValueRef])
</span><a href="GHC.Runtime.Interpreter.html#evalStmt"><span class="hs-identifier hs-var hs-var">evalStmt</span></a></span></span><span> </span><span id="local-6989586621681207080"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207080"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207079"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681207079"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681207078"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681207078"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621681207077"><span class="annot"><span class="annottext">EvalExpr ForeignHValue
</span><a href="#local-6989586621681207077"><span class="hs-identifier hs-var">foreign_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>  </span><span id="local-6989586621681207076"><span class="annot"><span class="annottext">EvalStatus_ [HValueRef] [HValueRef]
</span><a href="#local-6989586621681207076"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a.
EvalExpr ForeignHValue -&gt; (EvalExpr HValueRef -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621681207075"><span class="hs-identifier hs-var">withExpr</span></a></span><span> </span><span class="annot"><span class="annottext">EvalExpr ForeignHValue
</span><a href="#local-6989586621681207077"><span class="hs-identifier hs-var">foreign_expr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207074"><span class="annot"><span class="annottext">EvalExpr HValueRef
</span><a href="#local-6989586621681207074"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-269"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207080"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvalOpts
-&gt; EvalExpr HValueRef
-&gt; Message (EvalStatus_ [HValueRef] [HValueRef])
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStmt"><span class="hs-identifier hs-var">EvalStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Bool -&gt; EvalOpts
</span><a href="GHC.Runtime.Interpreter.html#mkEvalOpts"><span class="hs-identifier hs-var">mkEvalOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681207079"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681207078"><span class="hs-identifier hs-var">step</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EvalExpr HValueRef
</span><a href="#local-6989586621681207074"><span class="hs-identifier hs-var">expr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>  </span><span class="annot"><span class="annottext">Interp
-&gt; EvalStatus_ [HValueRef] [HValueRef]
-&gt; IO (EvalStatus_ [ForeignHValue] [HValueRef])
</span><a href="GHC.Runtime.Interpreter.html#handleEvalStatus"><span class="hs-identifier hs-var">handleEvalStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207080"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">EvalStatus_ [HValueRef] [HValueRef]
</span><a href="#local-6989586621681207076"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-271"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-272"></span><span>  </span><span id="local-6989586621681207499"><span class="annot"><a href="#local-6989586621681207075"><span class="hs-identifier hs-type">withExpr</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalExpr"><span class="hs-identifier hs-type">EvalExpr</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalExpr"><span class="hs-identifier hs-type">EvalExpr</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207499"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207499"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621681207075"><span class="annot"><span class="annottext">withExpr :: forall a.
EvalExpr ForeignHValue -&gt; (EvalExpr HValueRef -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621681207075"><span class="hs-identifier hs-var hs-var">withExpr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalThis"><span class="hs-identifier hs-type">EvalThis</span></a></span><span> </span><span id="local-6989586621681207070"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207070"><span class="hs-identifier hs-var">fhv</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681207069"><span class="annot"><span class="annottext">EvalExpr HValueRef -&gt; IO a
</span><a href="#local-6989586621681207069"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207070"><span class="hs-identifier hs-var">fhv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207067"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207067"><span class="hs-identifier hs-var">hvref</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EvalExpr HValueRef -&gt; IO a
</span><a href="#local-6989586621681207069"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. a -&gt; EvalExpr a
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalThis"><span class="hs-identifier hs-var">EvalThis</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207067"><span class="hs-identifier hs-var">hvref</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><a href="#local-6989586621681207075"><span class="hs-identifier hs-var">withExpr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalApp"><span class="hs-identifier hs-type">EvalApp</span></a></span><span> </span><span id="local-6989586621681207065"><span class="annot"><span class="annottext">EvalExpr ForeignHValue
</span><a href="#local-6989586621681207065"><span class="hs-identifier hs-var">fl</span></a></span></span><span> </span><span id="local-6989586621681207064"><span class="annot"><span class="annottext">EvalExpr ForeignHValue
</span><a href="#local-6989586621681207064"><span class="hs-identifier hs-var">fr</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621681207063"><span class="annot"><span class="annottext">EvalExpr HValueRef -&gt; IO a
</span><a href="#local-6989586621681207063"><span class="hs-identifier hs-var">cont</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="annottext">forall a.
EvalExpr ForeignHValue -&gt; (EvalExpr HValueRef -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621681207075"><span class="hs-identifier hs-var">withExpr</span></a></span><span> </span><span class="annot"><span class="annottext">EvalExpr ForeignHValue
</span><a href="#local-6989586621681207065"><span class="hs-identifier hs-var">fl</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207062"><span class="annot"><span class="annottext">EvalExpr HValueRef
</span><a href="#local-6989586621681207062"><span class="hs-identifier hs-var">fl'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">forall a.
EvalExpr ForeignHValue -&gt; (EvalExpr HValueRef -&gt; IO a) -&gt; IO a
</span><a href="#local-6989586621681207075"><span class="hs-identifier hs-var">withExpr</span></a></span><span> </span><span class="annot"><span class="annottext">EvalExpr ForeignHValue
</span><a href="#local-6989586621681207064"><span class="hs-identifier hs-var">fr</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207061"><span class="annot"><span class="annottext">EvalExpr HValueRef
</span><a href="#local-6989586621681207061"><span class="hs-identifier hs-var">fr'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><span class="annottext">EvalExpr HValueRef -&gt; IO a
</span><a href="#local-6989586621681207063"><span class="hs-identifier hs-var">cont</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. EvalExpr a -&gt; EvalExpr a -&gt; EvalExpr a
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalApp"><span class="hs-identifier hs-var">EvalApp</span></a></span><span> </span><span class="annot"><span class="annottext">EvalExpr HValueRef
</span><a href="#local-6989586621681207062"><span class="hs-identifier hs-var">fl'</span></a></span><span> </span><span class="annot"><span class="annottext">EvalExpr HValueRef
</span><a href="#local-6989586621681207061"><span class="hs-identifier hs-var">fr'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#resumeStmt"><span class="hs-identifier hs-type">resumeStmt</span></a></span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-comment">-- used by mkEvalOpts</span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>     </span><span class="hs-comment">-- &quot;step&quot; for mkEvalOpts</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#ResumeContext"><span class="hs-identifier hs-type">ResumeContext</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStatus_"><span class="hs-identifier hs-type">EvalStatus_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span id="resumeStmt"><span class="annot"><span class="annottext">resumeStmt :: Interp
-&gt; DynFlags
-&gt; Bool
-&gt; ForeignRef (ResumeContext [HValueRef])
-&gt; IO (EvalStatus_ [ForeignHValue] [HValueRef])
</span><a href="GHC.Runtime.Interpreter.html#resumeStmt"><span class="hs-identifier hs-var hs-var">resumeStmt</span></a></span></span><span> </span><span id="local-6989586621681207060"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207060"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207059"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681207059"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681207058"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681207058"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span id="local-6989586621681207057"><span class="annot"><span class="annottext">ForeignRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207057"><span class="hs-identifier hs-var">resume_ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-287"></span><span>  </span><span id="local-6989586621681207056"><span class="annot"><span class="annottext">EvalStatus_ [HValueRef] [HValueRef]
</span><a href="#local-6989586621681207056"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207057"><span class="hs-identifier hs-var">resume_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207055"><span class="annot"><span class="annottext">RemoteRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207055"><span class="hs-identifier hs-var">rhv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-288"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207060"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EvalOpts
-&gt; RemoteRef (ResumeContext [HValueRef])
-&gt; Message (EvalStatus_ [HValueRef] [HValueRef])
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#ResumeStmt"><span class="hs-identifier hs-var">ResumeStmt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; Bool -&gt; EvalOpts
</span><a href="GHC.Runtime.Interpreter.html#mkEvalOpts"><span class="hs-identifier hs-var">mkEvalOpts</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681207059"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681207058"><span class="hs-identifier hs-var">step</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RemoteRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207055"><span class="hs-identifier hs-var">rhv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><span class="annottext">Interp
-&gt; EvalStatus_ [HValueRef] [HValueRef]
-&gt; IO (EvalStatus_ [ForeignHValue] [HValueRef])
</span><a href="GHC.Runtime.Interpreter.html#handleEvalStatus"><span class="hs-identifier hs-var">handleEvalStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207060"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">EvalStatus_ [HValueRef] [HValueRef]
</span><a href="#local-6989586621681207056"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#abandonStmt"><span class="hs-identifier hs-type">abandonStmt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#ResumeContext"><span class="hs-identifier hs-type">ResumeContext</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-292"></span><span id="abandonStmt"><span class="annot"><span class="annottext">abandonStmt :: Interp -&gt; ForeignRef (ResumeContext [HValueRef]) -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#abandonStmt"><span class="hs-identifier hs-var hs-var">abandonStmt</span></a></span></span><span> </span><span id="local-6989586621681207053"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207053"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207052"><span class="annot"><span class="annottext">ForeignRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207052"><span class="hs-identifier hs-var">resume_ctxt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207052"><span class="hs-identifier hs-var">resume_ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207051"><span class="annot"><span class="annottext">RemoteRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207051"><span class="hs-identifier hs-var">rhv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207053"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteRef (ResumeContext [HValueRef]) -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#AbandonStmt"><span class="hs-identifier hs-var">AbandonStmt</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207051"><span class="hs-identifier hs-var">rhv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#handleEvalStatus"><span class="hs-identifier hs-type">handleEvalStatus</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStatus"><span class="hs-identifier hs-type">EvalStatus</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStatus_"><span class="hs-identifier hs-type">EvalStatus_</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span id="handleEvalStatus"><span class="annot"><span class="annottext">handleEvalStatus :: Interp
-&gt; EvalStatus_ [HValueRef] [HValueRef]
-&gt; IO (EvalStatus_ [ForeignHValue] [HValueRef])
</span><a href="GHC.Runtime.Interpreter.html#handleEvalStatus"><span class="hs-identifier hs-var hs-var">handleEvalStatus</span></a></span></span><span> </span><span id="local-6989586621681207049"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207049"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207048"><span class="annot"><span class="annottext">EvalStatus_ [HValueRef] [HValueRef]
</span><a href="#local-6989586621681207048"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EvalStatus_ [HValueRef] [HValueRef]
</span><a href="#local-6989586621681207048"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalBreak"><span class="hs-identifier hs-type">EvalBreak</span></a></span><span> </span><span id="local-6989586621681207046"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681207046"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span id="local-6989586621681207045"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207045"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621681207044"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207044"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681207043"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207043"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621681207042"><span class="annot"><span class="annottext">RemoteRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207042"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621681207041"><span class="annot"><span class="annottext">RemotePtr CostCentreStack
</span><a href="#local-6989586621681207041"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a b.
Bool
-&gt; HValueRef
-&gt; Int
-&gt; Int
-&gt; RemoteRef (ResumeContext b)
-&gt; RemotePtr CostCentreStack
-&gt; EvalStatus_ a b
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalBreak"><span class="hs-identifier hs-var">EvalBreak</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681207046"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207045"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207044"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207043"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef (ResumeContext [HValueRef])
</span><a href="#local-6989586621681207042"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr CostCentreStack
</span><a href="#local-6989586621681207041"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalComplete"><span class="hs-identifier hs-type">EvalComplete</span></a></span><span> </span><span id="local-6989586621681207039"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681207039"><span class="hs-identifier hs-var">alloc</span></a></span></span><span> </span><span id="local-6989586621681207038"><span class="annot"><span class="annottext">EvalResult [HValueRef]
</span><a href="#local-6989586621681207038"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="annottext">forall a b. Word64 -&gt; EvalResult a -&gt; EvalStatus_ a b
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalComplete"><span class="hs-identifier hs-var">EvalComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621681207039"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">EvalResult [HValueRef] -&gt; IO (EvalResult [ForeignHValue])
</span><a href="#local-6989586621681207037"><span class="hs-identifier hs-var">addFinalizer</span></a></span><span> </span><span class="annot"><span class="annottext">EvalResult [HValueRef]
</span><a href="#local-6989586621681207038"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-305"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-306"></span><span>  </span><span id="local-6989586621681207037"><span class="annot"><span class="annottext">addFinalizer :: EvalResult [HValueRef] -&gt; IO (EvalResult [ForeignHValue])
</span><a href="#local-6989586621681207037"><span class="hs-identifier hs-var hs-var">addFinalizer</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalException"><span class="hs-identifier hs-type">EvalException</span></a></span><span> </span><span id="local-6989586621681207035"><span class="annot"><span class="annottext">SerializableException
</span><a href="#local-6989586621681207035"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. SerializableException -&gt; EvalResult a
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalException"><span class="hs-identifier hs-var">EvalException</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableException
</span><a href="#local-6989586621681207035"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="#local-6989586621681207037"><span class="hs-identifier hs-var">addFinalizer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalSuccess"><span class="hs-identifier hs-type">EvalSuccess</span></a></span><span> </span><span id="local-6989586621681207033"><span class="annot"><span class="annottext">[HValueRef]
</span><a href="#local-6989586621681207033"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><span class="annottext">forall a. a -&gt; EvalResult a
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalSuccess"><span class="hs-identifier hs-var">EvalSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../../base-4.16.3.0/src/Data-Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207049"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HValueRef]
</span><a href="#local-6989586621681207033"><span class="hs-identifier hs-var">rs</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span class="hs-comment">-- | Execute an action of type @IO ()@</span><span>
</span><span id="line-311"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalIO"><span class="hs-identifier hs-type">evalIO</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span id="evalIO"><span class="annot"><span class="annottext">evalIO :: Interp -&gt; ForeignHValue -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#evalIO"><span class="hs-identifier hs-var hs-var">evalIO</span></a></span></span><span> </span><span id="local-6989586621681207031"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207031"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207030"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207030"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207030"><span class="hs-identifier hs-var">fhv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207029"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207029"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207031"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HValueRef -&gt; Message (EvalResult ())
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalIO"><span class="hs-identifier hs-var">EvalIO</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207029"><span class="hs-identifier hs-var">fhv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. EvalResult a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="hs-comment">-- | Execute an action of type @IO String@</span><span>
</span><span id="line-317"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalString"><span class="hs-identifier hs-type">evalString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-318"></span><span id="evalString"><span class="annot"><span class="annottext">evalString :: Interp -&gt; ForeignHValue -&gt; IO String
</span><a href="GHC.Runtime.Interpreter.html#evalString"><span class="hs-identifier hs-var hs-var">evalString</span></a></span></span><span> </span><span id="local-6989586621681207027"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207027"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207026"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207026"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207026"><span class="hs-identifier hs-var">fhv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207025"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207025"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207027"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HValueRef -&gt; Message (EvalResult String)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalString"><span class="hs-identifier hs-var">EvalString</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207025"><span class="hs-identifier hs-var">fhv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. EvalResult a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span class="hs-comment">-- | Execute an action of type @String -&gt; IO String@</span><span>
</span><span id="line-323"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#evalStringToIOString"><span class="hs-identifier hs-type">evalStringToIOString</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span>
</span><span id="line-324"></span><span id="evalStringToIOString"><span class="annot"><span class="annottext">evalStringToIOString :: Interp -&gt; ForeignHValue -&gt; String -&gt; IO String
</span><a href="GHC.Runtime.Interpreter.html#evalStringToIOString"><span class="hs-identifier hs-var hs-var">evalStringToIOString</span></a></span></span><span> </span><span id="local-6989586621681207023"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207023"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207022"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207022"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span id="local-6989586621681207021"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681207021"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681207022"><span class="hs-identifier hs-var">fhv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681207020"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207020"><span class="hs-identifier hs-var">fhv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207023"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HValueRef -&gt; String -&gt; Message (EvalResult String)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStringToString"><span class="hs-identifier hs-var">EvalStringToString</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681207020"><span class="hs-identifier hs-var">fhv</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681207021"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. EvalResult a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>
</span><span id="line-329"></span><span class="hs-comment">-- | Allocate and store the given bytes in memory, returning a pointer</span><span>
</span><span id="line-330"></span><span class="hs-comment">-- to the memory in the remote process.</span><span>
</span><span id="line-331"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mallocData"><span class="hs-identifier hs-type">mallocData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../bytestring-0.11.3.1/src/Data-ByteString-Internal.html#ByteString"><span class="hs-identifier hs-type">ByteString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span id="mallocData"><span class="annot"><span class="annottext">mallocData :: Interp -&gt; ByteString -&gt; IO (RemotePtr ())
</span><a href="GHC.Runtime.Interpreter.html#mallocData"><span class="hs-identifier hs-var hs-var">mallocData</span></a></span></span><span> </span><span id="local-6989586621681207018"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207018"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207017"><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681207017"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207018"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Message (RemotePtr ())
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#MallocData"><span class="hs-identifier hs-var">MallocData</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681207017"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkCostCentres"><span class="hs-identifier hs-type">mkCostCentres</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">,</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Stack-CCS.html#CostCentre"><span class="hs-identifier hs-type">CostCentre</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-335"></span><span id="mkCostCentres"><span class="annot"><span class="annottext">mkCostCentres :: Interp -&gt; String -&gt; [(String, String)] -&gt; IO [RemotePtr CostCentre]
</span><a href="GHC.Runtime.Interpreter.html#mkCostCentres"><span class="hs-identifier hs-var hs-var">mkCostCentres</span></a></span></span><span> </span><span id="local-6989586621681207015"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207015"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207014"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681207014"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span id="local-6989586621681207013"><span class="annot"><span class="annottext">[(String, String)]
</span><a href="#local-6989586621681207013"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207015"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; [(String, String)] -&gt; Message [RemotePtr CostCentre]
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#MkCostCentres"><span class="hs-identifier hs-var">MkCostCentres</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681207014"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">[(String, String)]
</span><a href="#local-6989586621681207013"><span class="hs-identifier hs-var">ccs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-comment">-- | Create a set of BCOs that may be mutually recursive.</span><span>
</span><span id="line-339"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#createBCOs"><span class="hs-identifier hs-type">createBCOs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-ResolvedBCO.html#ResolvedBCO"><span class="hs-identifier hs-type">ResolvedBCO</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span id="createBCOs"><span class="annot"><span class="annottext">createBCOs :: Interp -&gt; DynFlags -&gt; [ResolvedBCO] -&gt; IO [HValueRef]
</span><a href="GHC.Runtime.Interpreter.html#createBCOs"><span class="hs-identifier hs-var hs-var">createBCOs</span></a></span></span><span> </span><span id="local-6989586621681207011"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207011"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681207010"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681207010"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681207009"><span class="annot"><span class="annottext">[ResolvedBCO]
</span><a href="#local-6989586621681207009"><span class="hs-identifier hs-var">rbcos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621681207008"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207008"><span class="hs-identifier hs-var">n_jobs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">DynFlags -&gt; Maybe Int
</span><a href="GHC.Driver.Session.html#parMakeCount"><span class="hs-identifier hs-var">parMakeCount</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681207010"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-342"></span><span>              </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#getNumProcessors"><span class="hs-identifier hs-var">getNumProcessors</span></a></span><span>
</span><span id="line-343"></span><span>              </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681207006"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207006"><span class="hs-identifier hs-var">n</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207006"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-comment">-- Serializing ResolvedBCO is expensive, so if we're in parallel mode</span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-comment">-- (-j&lt;n&gt;) parallelise the serialization.</span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207008"><span class="hs-identifier hs-var">n_jobs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>    </span><span class="hs-keyword">then</span><span>
</span><span id="line-348"></span><span>      </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207011"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ByteString] -&gt; Message [HValueRef]
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#CreateBCOs"><span class="hs-identifier hs-var">CreateBCOs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="../../binary-0.8.9.0/src/Data-Binary-Put.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Binary t =&gt; t -&gt; Put
</span><a href="../../binary-0.8.9.0/src/Data-Binary-Class.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">[ResolvedBCO]
</span><a href="#local-6989586621681207009"><span class="hs-identifier hs-var">rbcos</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-351"></span><span>      </span><span id="local-6989586621681207002"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207002"><span class="hs-identifier hs-var">old_caps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Int
</span><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#getNumCapabilities"><span class="hs-identifier hs-var">getNumCapabilities</span></a></span><span>
</span><span id="line-352"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207002"><span class="hs-identifier hs-var">old_caps</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207008"><span class="hs-identifier hs-var">n_jobs</span></a></span><span>
</span><span id="line-353"></span><span>         </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621681206998"><span class="hs-identifier hs-var">puts</span></a></span><span>
</span><span id="line-354"></span><span>         </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a b c. IO a -&gt; IO b -&gt; IO c -&gt; IO c
</span><a href="../../base-4.16.3.0/src/Control-Exception-Base.html#bracket_"><span class="hs-identifier hs-var">bracket_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#setNumCapabilities"><span class="hs-identifier hs-var">setNumCapabilities</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207008"><span class="hs-identifier hs-var">n_jobs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#setNumCapabilities"><span class="hs-identifier hs-var">setNumCapabilities</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681207002"><span class="hs-identifier hs-var">old_caps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>                       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#void"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#evaluate"><span class="hs-identifier hs-var">evaluate</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621681206998"><span class="hs-identifier hs-var">puts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>      </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681207011"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ByteString] -&gt; Message [HValueRef]
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#CreateBCOs"><span class="hs-identifier hs-var">CreateBCOs</span></a></span><span> </span><span class="annot"><span class="annottext">[ByteString]
</span><a href="#local-6989586621681206998"><span class="hs-identifier hs-var">puts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-359"></span><span>  </span><span id="local-6989586621681206998"><span class="annot"><span class="annottext">puts :: [ByteString]
</span><a href="#local-6989586621681206998"><span class="hs-identifier hs-var hs-var">puts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall {t} {a}. (t -&gt; a) -&gt; [t] -&gt; [a]
</span><a href="#local-6989586621681206995"><span class="hs-identifier hs-var">parMap</span></a></span><span> </span><span class="annot"><span class="annottext">forall {t}. Binary t =&gt; t -&gt; ByteString
</span><a href="#local-6989586621681206994"><span class="hs-identifier hs-var">doChunk</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Int -&gt; [a] -&gt; [[a]]
</span><a href="GHC.Utils.Misc.html#chunkList"><span class="hs-identifier hs-var">chunkList</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span> </span><span class="annot"><span class="annottext">[ResolvedBCO]
</span><a href="#local-6989586621681207009"><span class="hs-identifier hs-var">rbcos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>
</span><span id="line-361"></span><span>  </span><span class="hs-comment">-- make sure we force the whole lazy ByteString</span><span>
</span><span id="line-362"></span><span>  </span><span id="local-6989586621681206994"><span class="annot"><span class="annottext">doChunk :: t -&gt; ByteString
</span><a href="#local-6989586621681206994"><span class="hs-identifier hs-var hs-var">doChunk</span></a></span></span><span> </span><span id="local-6989586621681206990"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681206990"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#pseq"><span class="hs-identifier hs-var">pseq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Int64
</span><a href="../../bytestring-0.11.3.1/src/Data-ByteString-Lazy.html#length"><span class="hs-identifier hs-var">LB.length</span></a></span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681206988"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ByteString
</span><a href="#local-6989586621681206988"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-363"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681206988"><span class="annot"><span class="annottext">bs :: ByteString
</span><a href="#local-6989586621681206988"><span class="hs-identifier hs-var hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Put -&gt; ByteString
</span><a href="../../binary-0.8.9.0/src/Data-Binary-Put.html#runPut"><span class="hs-identifier hs-var">runPut</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall t. Binary t =&gt; t -&gt; Put
</span><a href="../../binary-0.8.9.0/src/Data-Binary-Class.html#put"><span class="hs-identifier hs-var">put</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681206990"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-comment">-- We don't have the parallel package, so roll our own simple parMap</span><span>
</span><span id="line-366"></span><span>  </span><span id="local-6989586621681206995"><span class="annot"><span class="annottext">parMap :: (t -&gt; a) -&gt; [t] -&gt; [a]
</span><a href="#local-6989586621681206995"><span class="hs-identifier hs-var hs-var">parMap</span></a></span></span><span> </span><span class="annot"><span class="annottext">t -&gt; a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-367"></span><span>  </span><span class="annot"><a href="#local-6989586621681206995"><span class="hs-identifier hs-var">parMap</span></a></span><span> </span><span id="local-6989586621681206987"><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621681206987"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621681206986"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681206986"><span class="hs-identifier hs-var">x</span></a></span></span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span id="local-6989586621681206985"><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681206985"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681206984"><span class="hs-identifier hs-var">fx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#par"><span class="hs-operator hs-var">`par`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681206983"><span class="hs-identifier hs-var">fxs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. a -&gt; b -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Conc-Sync.html#pseq"><span class="hs-operator hs-var">`pseq`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681206984"><span class="hs-identifier hs-var">fx</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621681206983"><span class="hs-identifier hs-var">fxs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621681206984"><span class="annot"><span class="annottext">fx :: a
</span><a href="#local-6989586621681206984"><span class="hs-identifier hs-var hs-var">fx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621681206987"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621681206986"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">;</span><span> </span><span id="local-6989586621681206983"><span class="annot"><span class="annottext">fxs :: [a]
</span><a href="#local-6989586621681206983"><span class="hs-identifier hs-var hs-var">fxs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(t -&gt; a) -&gt; [t] -&gt; [a]
</span><a href="#local-6989586621681206995"><span class="hs-identifier hs-var">parMap</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; a
</span><a href="#local-6989586621681206987"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[t]
</span><a href="#local-6989586621681206985"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#addSptEntry"><span class="hs-identifier hs-type">addSptEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Fingerprint-Type.html#Fingerprint"><span class="hs-identifier hs-type">Fingerprint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span id="addSptEntry"><span class="annot"><span class="annottext">addSptEntry :: Interp -&gt; Fingerprint -&gt; ForeignHValue -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#addSptEntry"><span class="hs-identifier hs-var hs-var">addSptEntry</span></a></span></span><span> </span><span id="local-6989586621681206982"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206982"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206981"><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621681206981"><span class="hs-identifier hs-var">fpr</span></a></span></span><span> </span><span id="local-6989586621681206980"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206980"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-372"></span><span>  </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206980"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206979"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206979"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-373"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206982"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Fingerprint -&gt; HValueRef -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#AddSptEntry"><span class="hs-identifier hs-var">AddSptEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Fingerprint
</span><a href="#local-6989586621681206981"><span class="hs-identifier hs-var">fpr</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206979"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#costCentreStackInfo"><span class="hs-identifier hs-type">costCentreStackInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#RemotePtr"><span class="hs-identifier hs-type">RemotePtr</span></a></span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Stack-CCS.html#CostCentreStack"><span class="hs-identifier hs-type">CostCentreStack</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-376"></span><span id="costCentreStackInfo"><span class="annot"><span class="annottext">costCentreStackInfo :: Interp -&gt; RemotePtr CostCentreStack -&gt; IO [String]
</span><a href="GHC.Runtime.Interpreter.html#costCentreStackInfo"><span class="hs-identifier hs-var hs-var">costCentreStackInfo</span></a></span></span><span> </span><span id="local-6989586621681206977"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206977"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206976"><span class="annot"><span class="annottext">RemotePtr CostCentreStack
</span><a href="#local-6989586621681206976"><span class="hs-identifier hs-var">ccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-377"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206977"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemotePtr CostCentreStack -&gt; Message [String]
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#CostCentreStackInfo"><span class="hs-identifier hs-var">CostCentreStackInfo</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr CostCentreStack
</span><a href="#local-6989586621681206976"><span class="hs-identifier hs-var">ccs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#newBreakArray"><span class="hs-identifier hs-type">newBreakArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-BreakArray.html#BreakArray"><span class="hs-identifier hs-type">BreakArray</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span id="newBreakArray"><span class="annot"><span class="annottext">newBreakArray :: Interp -&gt; Int -&gt; IO (ForeignRef BreakArray)
</span><a href="GHC.Runtime.Interpreter.html#newBreakArray"><span class="hs-identifier hs-var hs-var">newBreakArray</span></a></span></span><span> </span><span id="local-6989586621681206974"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206974"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206973"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206973"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-381"></span><span>  </span><span id="local-6989586621681206972"><span class="annot"><span class="annottext">RemoteRef BreakArray
</span><a href="#local-6989586621681206972"><span class="hs-identifier hs-var">breakArray</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206974"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Message (RemoteRef BreakArray)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#NewBreakArray"><span class="hs-identifier hs-var">NewBreakArray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206973"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-382"></span><span>  </span><span class="annot"><span class="annottext">forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206974"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef BreakArray
</span><a href="#local-6989586621681206972"><span class="hs-identifier hs-var">breakArray</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#storeBreakpoint"><span class="hs-identifier hs-type">storeBreakpoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-BreakArray.html#BreakArray"><span class="hs-identifier hs-type">BreakArray</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-385"></span><span id="storeBreakpoint"><span class="annot"><span class="annottext">storeBreakpoint :: Interp -&gt; ForeignRef BreakArray -&gt; Int -&gt; Int -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#storeBreakpoint"><span class="hs-identifier hs-var hs-var">storeBreakpoint</span></a></span></span><span> </span><span id="local-6989586621681206970"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206970"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206969"><span class="annot"><span class="annottext">ForeignRef BreakArray
</span><a href="#local-6989586621681206969"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621681206968"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206968"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span id="local-6989586621681206967"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206967"><span class="hs-identifier hs-var">cnt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>                               </span><span class="hs-comment">-- #19157</span><span>
</span><span id="line-386"></span><span>  </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef BreakArray
</span><a href="#local-6989586621681206969"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206966"><span class="annot"><span class="annottext">RemoteRef BreakArray
</span><a href="#local-6989586621681206966"><span class="hs-identifier hs-var">breakarray</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-387"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206970"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteRef BreakArray -&gt; Int -&gt; Int -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#SetupBreakpoint"><span class="hs-identifier hs-var">SetupBreakpoint</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef BreakArray
</span><a href="#local-6989586621681206966"><span class="hs-identifier hs-var">breakarray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206968"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206967"><span class="hs-identifier hs-var">cnt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#breakpointStatus"><span class="hs-identifier hs-type">breakpointStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-BreakArray.html#BreakArray"><span class="hs-identifier hs-type">BreakArray</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-390"></span><span id="breakpointStatus"><span class="annot"><span class="annottext">breakpointStatus :: Interp -&gt; ForeignRef BreakArray -&gt; Int -&gt; IO Bool
</span><a href="GHC.Runtime.Interpreter.html#breakpointStatus"><span class="hs-identifier hs-var hs-var">breakpointStatus</span></a></span></span><span> </span><span id="local-6989586621681206964"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206964"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206963"><span class="annot"><span class="annottext">ForeignRef BreakArray
</span><a href="#local-6989586621681206963"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621681206962"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206962"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>  </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef BreakArray
</span><a href="#local-6989586621681206963"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206961"><span class="annot"><span class="annottext">RemoteRef BreakArray
</span><a href="#local-6989586621681206961"><span class="hs-identifier hs-var">breakarray</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-392"></span><span>    </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206964"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteRef BreakArray -&gt; Int -&gt; Message Bool
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#BreakpointStatus"><span class="hs-identifier hs-var">BreakpointStatus</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef BreakArray
</span><a href="#local-6989586621681206961"><span class="hs-identifier hs-var">breakarray</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206962"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#getBreakpointVar"><span class="hs-identifier hs-type">getBreakpointVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span id="getBreakpointVar"><span class="annot"><span class="annottext">getBreakpointVar :: Interp -&gt; ForeignHValue -&gt; Int -&gt; IO (Maybe ForeignHValue)
</span><a href="GHC.Runtime.Interpreter.html#getBreakpointVar"><span class="hs-identifier hs-var hs-var">getBreakpointVar</span></a></span></span><span> </span><span id="local-6989586621681206959"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206959"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206958"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206958"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span id="local-6989586621681206957"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206957"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206958"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206956"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206956"><span class="hs-identifier hs-var">apStack</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-397"></span><span>    </span><span id="local-6989586621681206955"><span class="annot"><span class="annottext">Maybe HValueRef
</span><a href="#local-6989586621681206955"><span class="hs-identifier hs-var">mb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206959"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HValueRef -&gt; Int -&gt; Message (Maybe HValueRef)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#GetBreakpointVar"><span class="hs-identifier hs-var">GetBreakpointVar</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206956"><span class="hs-identifier hs-var">apStack</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206957"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../../base-4.16.3.0/src/Data-Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206959"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe HValueRef
</span><a href="#local-6989586621681206955"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#getClosure"><span class="hs-identifier hs-type">getClosure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghc-heap-9.2.4/src/GHC-Exts-Heap-Closures.html#GenClosure"><span class="hs-identifier hs-type">Heap.GenClosure</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span id="getClosure"><span class="annot"><span class="annottext">getClosure :: Interp -&gt; ForeignHValue -&gt; IO (GenClosure ForeignHValue)
</span><a href="GHC.Runtime.Interpreter.html#getClosure"><span class="hs-identifier hs-var hs-var">getClosure</span></a></span></span><span> </span><span id="local-6989586621681206953"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206953"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206952"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206952"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206952"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206951"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206951"><span class="hs-identifier hs-var">hval</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-403"></span><span>    </span><span id="local-6989586621681206950"><span class="annot"><span class="annottext">GenClosure HValueRef
</span><a href="#local-6989586621681206950"><span class="hs-identifier hs-var">mb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206953"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HValueRef -&gt; Message (GenClosure HValueRef)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#GetClosure"><span class="hs-identifier hs-var">GetClosure</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206951"><span class="hs-identifier hs-var">hval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>    </span><span class="annot"><span class="annottext">forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><a href="../../base-4.16.3.0/src/Data-Traversable.html#mapM"><span class="hs-identifier hs-var">mapM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206953"><span class="hs-identifier hs-var">interp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">GenClosure HValueRef
</span><a href="#local-6989586621681206950"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span class="hs-comment">-- | Send a Seq message to the iserv process to force a value      #2950</span><span>
</span><span id="line-407"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#seqHValue"><span class="hs-identifier hs-type">seqHValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignHValue"><span class="hs-identifier hs-type">ForeignHValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span id="seqHValue"><span class="annot"><span class="annottext">seqHValue :: Interp -&gt; HscEnv -&gt; ForeignHValue -&gt; IO (EvalResult ())
</span><a href="GHC.Runtime.Interpreter.html#seqHValue"><span class="hs-identifier hs-var hs-var">seqHValue</span></a></span></span><span> </span><span id="local-6989586621681206948"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206948"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206947"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681206947"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621681206946"><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206946"><span class="hs-identifier hs-var">ref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-409"></span><span>  </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignHValue
</span><a href="#local-6989586621681206946"><span class="hs-identifier hs-var">ref</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206945"><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206945"><span class="hs-identifier hs-var">hval</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-410"></span><span>    </span><span id="local-6989586621681206944"><span class="annot"><span class="annottext">EvalStatus_ () ()
</span><a href="#local-6989586621681206944"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206948"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HValueRef -&gt; Message (EvalStatus_ () ())
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#Seq"><span class="hs-identifier hs-var">Seq</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206945"><span class="hs-identifier hs-var">hval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>    </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; EvalStatus_ () () -&gt; IO (EvalResult ())
</span><a href="GHC.Runtime.Interpreter.html#handleSeqHValueStatus"><span class="hs-identifier hs-var">handleSeqHValueStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206948"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681206947"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">EvalStatus_ () ()
</span><a href="#local-6989586621681206944"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span class="hs-comment">-- | Process the result of a Seq or ResumeSeq message.             #2950</span><span>
</span><span id="line-414"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#handleSeqHValueStatus"><span class="hs-identifier hs-type">handleSeqHValueStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Driver.Env.Types.html#HscEnv"><span class="hs-identifier hs-type">HscEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalStatus"><span class="hs-identifier hs-type">EvalStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span id="handleSeqHValueStatus"><span class="annot"><span class="annottext">handleSeqHValueStatus :: Interp -&gt; HscEnv -&gt; EvalStatus_ () () -&gt; IO (EvalResult ())
</span><a href="GHC.Runtime.Interpreter.html#handleSeqHValueStatus"><span class="hs-identifier hs-var hs-var">handleSeqHValueStatus</span></a></span></span><span> </span><span id="local-6989586621681206941"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206941"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206940"><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681206940"><span class="hs-identifier hs-var">hsc_env</span></a></span></span><span> </span><span id="local-6989586621681206939"><span class="annot"><span class="annottext">EvalStatus_ () ()
</span><a href="#local-6989586621681206939"><span class="hs-identifier hs-var">eval_status</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EvalStatus_ () ()
</span><a href="#local-6989586621681206939"><span class="hs-identifier hs-var">eval_status</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalBreak"><span class="hs-identifier hs-type">EvalBreak</span></a></span><span> </span><span id="local-6989586621681206938"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681206938"><span class="hs-identifier hs-var">is_exception</span></a></span></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681206937"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206937"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span id="local-6989586621681206936"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206936"><span class="hs-identifier hs-var">mod_uniq</span></a></span></span><span> </span><span id="local-6989586621681206935"><span class="annot"><span class="annottext">RemoteRef (ResumeContext ())
</span><a href="#local-6989586621681206935"><span class="hs-identifier hs-var">resume_ctxt</span></a></span></span><span> </span><span class="annot"><span class="annottext">RemotePtr CostCentreStack
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>      </span><span class="hs-comment">-- A breakpoint was hit; inform the user and tell them</span><span>
</span><span id="line-419"></span><span>      </span><span class="hs-comment">-- which breakpoint was hit.</span><span>
</span><span id="line-420"></span><span>      </span><span id="local-6989586621681206934"><span class="annot"><span class="annottext">ForeignRef (ResumeContext ())
</span><a href="#local-6989586621681206934"><span class="hs-identifier hs-var">resume_ctxt_fhv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../../base-4.16.3.0/src/Control-Monad-IO-Class.html#liftIO"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var">mkFinalizedHValue</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206941"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef (ResumeContext ())
</span><a href="#local-6989586621681206935"><span class="hs-identifier hs-var">resume_ctxt</span></a></span><span>
</span><span id="line-421"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681206933"><span class="annot"><span class="annottext">hmi :: HomeModInfo
</span><a href="#local-6989586621681206933"><span class="hs-identifier hs-var hs-var">hmi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;handleRunStatus&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-422"></span><span>                  </span><span class="annot"><span class="annottext">HomePackageTable -&gt; Unique -&gt; Maybe HomeModInfo
</span><a href="GHC.Unit.Home.ModInfo.html#lookupHptDirectly"><span class="hs-identifier hs-var">lookupHptDirectly</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; HomePackageTable
</span><a href="GHC.Driver.Env.Types.html#hsc_HPT"><span class="hs-identifier hs-var">hsc_HPT</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681206940"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-423"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Unique
</span><a href="GHC.Types.Unique.html#mkUniqueGrimily"><span class="hs-identifier hs-var">mkUniqueGrimily</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206936"><span class="hs-identifier hs-var">mod_uniq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>          </span><span id="local-6989586621681206928"><span class="annot"><span class="annottext">modl :: Module
</span><a href="#local-6989586621681206928"><span class="hs-identifier hs-var hs-var">modl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (phase :: ModIfacePhase). ModIface_ phase -&gt; Module
</span><a href="GHC.Unit.Module.ModIface.html#mi_module"><span class="hs-identifier hs-var">mi_module</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModIface
</span><a href="GHC.Unit.Home.ModInfo.html#hm_iface"><span class="hs-identifier hs-var">hm_iface</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681206933"><span class="hs-identifier hs-var">hmi</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-425"></span><span>          </span><span id="local-6989586621681206925"><span class="annot"><span class="annottext">bp :: Maybe BreakInfo
</span><a href="#local-6989586621681206925"><span class="hs-identifier hs-var hs-var">bp</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681206938"><span class="hs-identifier hs-var">is_exception</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-426"></span><span>             </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; Int -&gt; BreakInfo
</span><a href="GHC.Runtime.Eval.Types.html#BreakInfo"><span class="hs-identifier hs-var">BreakInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681206928"><span class="hs-identifier hs-var">modl</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206937"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-427"></span><span>          </span><span id="local-6989586621681206921"><span class="annot"><span class="annottext">sdocBpLoc :: Maybe BreakInfo -&gt; SDoc
</span><a href="#local-6989586621681206921"><span class="hs-identifier hs-var hs-var">sdocBpLoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SDoc -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#brackets"><span class="hs-identifier hs-var">brackets</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Outputable a =&gt; a -&gt; SDoc
</span><a href="GHC.Utils.Outputable.html#ppr"><span class="hs-identifier hs-var">ppr</span></a></span><span> </span><span class="annot"><span class="annottext">forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BreakInfo -&gt; SrcSpan
</span><a href="#local-6989586621681206919"><span class="hs-identifier hs-var">getSeqBpSpan</span></a></span><span>
</span><span id="line-428"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/System-IO.html#putStrLn"><span class="hs-identifier hs-var">putStrLn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;*** Ignoring breakpoint &quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-429"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DynFlags -&gt; SDoc -&gt; String
</span><a href="GHC.Driver.Ppr.html#showSDoc"><span class="hs-identifier hs-var">showSDoc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; DynFlags
</span><a href="GHC.Driver.Env.Types.html#hsc_dflags"><span class="hs-identifier hs-var">hsc_dflags</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681206940"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BreakInfo -&gt; SDoc
</span><a href="#local-6989586621681206921"><span class="hs-identifier hs-var">sdocBpLoc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BreakInfo
</span><a href="#local-6989586621681206925"><span class="hs-identifier hs-var">bp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-comment">-- resume the seq (:force) processing in the iserv process</span><span>
</span><span id="line-431"></span><span>      </span><span class="annot"><span class="annottext">forall a b. ForeignRef a -&gt; (RemoteRef a -&gt; IO b) -&gt; IO b
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#withForeignRef"><span class="hs-identifier hs-var">withForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef (ResumeContext ())
</span><a href="#local-6989586621681206934"><span class="hs-identifier hs-var">resume_ctxt_fhv</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206916"><span class="annot"><span class="annottext">RemoteRef (ResumeContext ())
</span><a href="#local-6989586621681206916"><span class="hs-identifier hs-var">hval</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>        </span><span id="local-6989586621681206915"><span class="annot"><span class="annottext">EvalStatus_ () ()
</span><a href="#local-6989586621681206915"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206941"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemoteRef (ResumeContext ()) -&gt; Message (EvalStatus_ () ())
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#ResumeSeq"><span class="hs-identifier hs-var">ResumeSeq</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef (ResumeContext ())
</span><a href="#local-6989586621681206916"><span class="hs-identifier hs-var">hval</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><span class="annottext">Interp -&gt; HscEnv -&gt; EvalStatus_ () () -&gt; IO (EvalResult ())
</span><a href="GHC.Runtime.Interpreter.html#handleSeqHValueStatus"><span class="hs-identifier hs-var">handleSeqHValueStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206941"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681206940"><span class="hs-identifier hs-var">hsc_env</span></a></span><span> </span><span class="annot"><span class="annottext">EvalStatus_ () ()
</span><a href="#local-6989586621681206915"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-434"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalComplete"><span class="hs-identifier hs-type">EvalComplete</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621681206913"><span class="annot"><span class="annottext">EvalResult ()
</span><a href="#local-6989586621681206913"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">EvalResult ()
</span><a href="#local-6989586621681206913"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><a href="#local-6989586621681206919"><span class="hs-identifier hs-type">getSeqBpSpan</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.Runtime.Eval.Types.html#BreakInfo"><span class="hs-identifier hs-type">BreakInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Types.SrcLoc.html#SrcSpan"><span class="hs-identifier hs-type">SrcSpan</span></a></span><span>
</span><span id="line-437"></span><span>    </span><span class="hs-comment">-- Just case: Stopped at a breakpoint, extract SrcSpan information</span><span>
</span><span id="line-438"></span><span>    </span><span class="hs-comment">-- from the breakpoint.</span><span>
</span><span id="line-439"></span><span>    </span><span id="local-6989586621681206919"><span class="annot"><span class="annottext">getSeqBpSpan :: Maybe BreakInfo -&gt; SrcSpan
</span><a href="#local-6989586621681206919"><span class="hs-identifier hs-var hs-var">getSeqBpSpan</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="GHC.Runtime.Eval.Types.html#BreakInfo"><span class="hs-identifier hs-type">BreakInfo</span></a></span><span class="hs-special">{</span><span id="local-6989586621681206911"><span id="local-6989586621681206912"><span class="annot"><span class="annottext">Int
Module
breakInfo_number :: BreakInfo -&gt; Int
breakInfo_module :: BreakInfo -&gt; Module
breakInfo_number :: Int
breakInfo_module :: Module
</span><a href="GHC.Runtime.Eval.Types.html#breakInfo_number"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-440"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModBreaks -&gt; Array Int SrcSpan
</span><a href="GHC.ByteCode.Types.html#modBreaks_locs"><span class="hs-identifier hs-var">modBreaks_locs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Module -&gt; ModBreaks
</span><a href="#local-6989586621681206907"><span class="hs-identifier hs-var">breaks</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681206912"><span class="hs-identifier hs-var">breakInfo_module</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">forall i e. Ix i =&gt; Array i e -&gt; i -&gt; e
</span><a href="../../base-4.16.3.0/src/GHC-Arr.html#%21"><span class="hs-operator hs-var">!</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206911"><span class="hs-identifier hs-var">breakInfo_number</span></a></span><span>
</span><span id="line-441"></span><span>    </span><span class="hs-comment">-- Nothing case - should not occur!</span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-comment">-- Reason: Setting of flags in libraries/ghci/GHCi/Run.hs:evalOptsSeq</span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><a href="#local-6989586621681206919"><span class="hs-identifier hs-var">getSeqBpSpan</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe BreakInfo
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FastString -&gt; SrcSpan
</span><a href="GHC.Types.SrcLoc.html#mkGeneralSrcSpan"><span class="hs-identifier hs-var">mkGeneralSrcSpan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; FastString
</span><a href="GHC.Data.FastString.html#fsLit"><span class="hs-identifier hs-var">fsLit</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&lt;unknown&gt;&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>    </span><span id="local-6989586621681206907"><span class="annot"><span class="annottext">breaks :: Module -&gt; ModBreaks
</span><a href="#local-6989586621681206907"><span class="hs-identifier hs-var hs-var">breaks</span></a></span></span><span> </span><span id="local-6989586621681206904"><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681206904"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; ModBreaks
</span><a href="GHC.Runtime.Interpreter.html#getModBreaks"><span class="hs-identifier hs-var">getModBreaks</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. HasCallStack =&gt; String -&gt; Maybe a -&gt; a
</span><a href="GHC.Data.Maybe.html#expectJust"><span class="hs-identifier hs-var">expectJust</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getSeqBpSpan&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-445"></span><span>      </span><span class="annot"><span class="annottext">HomePackageTable -&gt; ModuleName -&gt; Maybe HomeModInfo
</span><a href="GHC.Unit.Home.ModInfo.html#lookupHpt"><span class="hs-identifier hs-var">lookupHpt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HscEnv -&gt; HomePackageTable
</span><a href="GHC.Driver.Env.Types.html#hsc_HPT"><span class="hs-identifier hs-var">hsc_HPT</span></a></span><span> </span><span class="annot"><span class="annottext">HscEnv
</span><a href="#local-6989586621681206940"><span class="hs-identifier hs-var">hsc_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall unit. GenModule unit -&gt; ModuleName
</span><a href="GHC.Unit.Types.html#moduleName"><span class="hs-identifier hs-var">moduleName</span></a></span><span> </span><span class="annot"><span class="annottext">Module
</span><a href="#local-6989586621681206904"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- Interface to the object-code linker</span><span>
</span><span id="line-450"></span><span>
</span><span id="line-451"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#initObjLinker"><span class="hs-identifier hs-type">initObjLinker</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span id="initObjLinker"><span class="annot"><span class="annottext">initObjLinker :: Interp -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#initObjLinker"><span class="hs-identifier hs-var hs-var">initObjLinker</span></a></span></span><span> </span><span id="local-6989586621681206901"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206901"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206901"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#InitLinker"><span class="hs-identifier hs-var">InitLinker</span></a></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#lookupSymbol"><span class="hs-identifier hs-type">lookupSymbol</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.Data.FastString.html#FastString"><span class="hs-identifier hs-type">FastString</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span id="lookupSymbol"><span class="annot"><span class="annottext">lookupSymbol :: Interp -&gt; FastString -&gt; IO (Maybe (Ptr ()))
</span><a href="GHC.Runtime.Interpreter.html#lookupSymbol"><span class="hs-identifier hs-var hs-var">lookupSymbol</span></a></span></span><span> </span><span id="local-6989586621681206899"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206899"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206898"><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621681206898"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206899"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>  </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. RemotePtr a -&gt; Ptr a
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#fromRemotePtr"><span class="hs-identifier hs-var">fromRemotePtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Message a -&gt; IO a
</span><a href="../../ghci-9.2.4/src/GHCi-Run.html#run"><span class="hs-identifier hs-var">run</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message (Maybe (RemotePtr ()))
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#LookupSymbol"><span class="hs-identifier hs-var">LookupSymbol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621681206898"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-460"></span><span>  </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span id="local-6989586621681206894"><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206894"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621681206893"><span class="annot"><span class="annottext">IServ
</span><a href="#local-6989586621681206893"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a.
ExceptionMonad m =&gt;
IServConfig
-&gt; IServ -&gt; (IServInstance -&gt; m (IServInstance, a)) -&gt; m a
</span><a href="GHC.Runtime.Interpreter.html#withIServ"><span class="hs-identifier hs-var">withIServ</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206894"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">IServ
</span><a href="#local-6989586621681206893"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206892"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206892"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-comment">-- Profiling of GHCi showed a lot of time and allocation spent</span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-comment">-- making cross-process LookupSymbol calls, so I added a GHC-side</span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-comment">-- cache which sped things up quite a lot.  We have to be careful</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-comment">-- to purge this cache when unloading code though.</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681206891"><span class="annot"><span class="annottext">cache :: UniqFM FastString (Ptr ())
</span><a href="#local-6989586621681206891"><span class="hs-identifier hs-var hs-var">cache</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IServInstance -&gt; UniqFM FastString (Ptr ())
</span><a href="GHC.Runtime.Interpreter.Types.html#iservLookupSymbolCache"><span class="hs-identifier hs-var">iservLookupSymbolCache</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206892"><span class="hs-identifier hs-var">iserv</span></a></span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall key elt. Uniquable key =&gt; UniqFM key elt -&gt; key -&gt; Maybe elt
</span><a href="GHC.Types.Unique.FM.html#lookupUFM"><span class="hs-identifier hs-var">lookupUFM</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM FastString (Ptr ())
</span><a href="#local-6989586621681206891"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621681206898"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-467"></span><span>      </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681206888"><span class="annot"><span class="annottext">Ptr ()
</span><a href="#local-6989586621681206888"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206892"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr ()
</span><a href="#local-6989586621681206888"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Ptr ())
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-469"></span><span>        </span><span id="local-6989586621681206887"><span class="annot"><span class="annottext">Maybe (RemotePtr ())
</span><a href="#local-6989586621681206887"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#uninterruptibleMask_"><span class="hs-identifier hs-var">uninterruptibleMask_</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-470"></span><span>                 </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; IServInstance -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206892"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message (Maybe (RemotePtr ()))
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#LookupSymbol"><span class="hs-identifier hs-var">LookupSymbol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FastString -&gt; String
</span><a href="GHC.Data.FastString.html#unpackFS"><span class="hs-identifier hs-var">unpackFS</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621681206898"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-471"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (RemotePtr ())
</span><a href="#local-6989586621681206887"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-472"></span><span>          </span><span class="annot"><span class="annottext">Maybe (RemotePtr ())
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206892"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>          </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681206886"><span class="annot"><span class="annottext">RemotePtr ()
</span><a href="#local-6989586621681206886"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-474"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681206885"><span class="annot"><span class="annottext">p :: Ptr ()
</span><a href="#local-6989586621681206885"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. RemotePtr a -&gt; Ptr a
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#fromRemotePtr"><span class="hs-identifier hs-var">fromRemotePtr</span></a></span><span> </span><span class="annot"><span class="annottext">RemotePtr ()
</span><a href="#local-6989586621681206886"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-475"></span><span>                </span><span id="local-6989586621681206884"><span class="annot"><span class="annottext">cache' :: UniqFM FastString (Ptr ())
</span><a href="#local-6989586621681206884"><span class="hs-identifier hs-var hs-var">cache'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall key elt.
Uniquable key =&gt;
UniqFM key elt -&gt; key -&gt; elt -&gt; UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#addToUFM"><span class="hs-identifier hs-var">addToUFM</span></a></span><span> </span><span class="annot"><span class="annottext">UniqFM FastString (Ptr ())
</span><a href="#local-6989586621681206891"><span class="hs-identifier hs-var">cache</span></a></span><span> </span><span class="annot"><span class="annottext">FastString
</span><a href="#local-6989586621681206898"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr ()
</span><a href="#local-6989586621681206885"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-476"></span><span>                </span><span id="local-6989586621681206882"><span class="annot"><span class="annottext">iserv' :: IServInstance
</span><a href="#local-6989586621681206882"><span class="hs-identifier hs-var hs-var">iserv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206892"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">iservLookupSymbolCache :: UniqFM FastString (Ptr ())
</span><a href="GHC.Runtime.Interpreter.Types.html#iservLookupSymbolCache"><span class="hs-identifier hs-var">iservLookupSymbolCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UniqFM FastString (Ptr ())
</span><a href="#local-6989586621681206884"><span class="hs-identifier hs-var">cache'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-477"></span><span>            </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206882"><span class="hs-identifier hs-var">iserv'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr ()
</span><a href="#local-6989586621681206885"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#lookupClosure"><span class="hs-identifier hs-type">lookupClosure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span id="lookupClosure"><span class="annot"><span class="annottext">lookupClosure :: Interp -&gt; String -&gt; IO (Maybe HValueRef)
</span><a href="GHC.Runtime.Interpreter.html#lookupClosure"><span class="hs-identifier hs-var hs-var">lookupClosure</span></a></span></span><span> </span><span id="local-6989586621681206881"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206881"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206880"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206880"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-481"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206881"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message (Maybe HValueRef)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#LookupClosure"><span class="hs-identifier hs-var">LookupClosure</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206880"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#purgeLookupSymbolCache"><span class="hs-identifier hs-type">purgeLookupSymbolCache</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span id="purgeLookupSymbolCache"><span class="annot"><span class="annottext">purgeLookupSymbolCache :: Interp -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#purgeLookupSymbolCache"><span class="hs-identifier hs-var hs-var">purgeLookupSymbolCache</span></a></span></span><span> </span><span id="local-6989586621681206878"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206878"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206878"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>  </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>  </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServ"><span class="hs-identifier hs-type">IServ</span></a></span><span> </span><span id="local-6989586621681206877"><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681206877"><span class="hs-identifier hs-var">mstate</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-489"></span><span>    </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/Control-Concurrent-MVar.html#modifyMVar_"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681206877"><span class="hs-identifier hs-var">mstate</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206875"><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206875"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206875"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-490"></span><span>      </span><span class="annot"><span class="annottext">IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServPending"><span class="hs-identifier hs-var">IServPending</span></a></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206875"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-491"></span><span>      </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-type">IServRunning</span></a></span><span> </span><span id="local-6989586621681206874"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206874"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IServInstance -&gt; IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-var">IServRunning</span></a></span><span>
</span><span id="line-492"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206874"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">iservLookupSymbolCache :: UniqFM FastString (Ptr ())
</span><a href="GHC.Runtime.Interpreter.Types.html#iservLookupSymbolCache"><span class="hs-identifier hs-var">iservLookupSymbolCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall key elt. UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#emptyUFM"><span class="hs-identifier hs-var">emptyUFM</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span>
</span><span id="line-495"></span><span class="hs-comment">-- | loadDLL loads a dynamic library using the OS's native linker</span><span>
</span><span id="line-496"></span><span class="hs-comment">-- (i.e. dlopen() on Unix, LoadLibrary() on Windows).  It takes either</span><span>
</span><span id="line-497"></span><span class="hs-comment">-- an absolute pathname to the file, or a relative filename</span><span>
</span><span id="line-498"></span><span class="hs-comment">-- (e.g. &quot;libfoo.so&quot; or &quot;foo.dll&quot;).  In the latter case, loadDLL</span><span>
</span><span id="line-499"></span><span class="hs-comment">-- searches the standard locations for the appropriate library.</span><span>
</span><span id="line-500"></span><span class="hs-comment">--</span><span>
</span><span id="line-501"></span><span class="hs-comment">-- Returns:</span><span>
</span><span id="line-502"></span><span class="hs-comment">--</span><span>
</span><span id="line-503"></span><span class="hs-comment">-- Nothing      =&gt; success</span><span>
</span><span id="line-504"></span><span class="hs-comment">-- Just err_msg =&gt; failure</span><span>
</span><span id="line-505"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier hs-type">loadDLL</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span id="loadDLL"><span class="annot"><span class="annottext">loadDLL :: Interp -&gt; String -&gt; IO (Maybe String)
</span><a href="GHC.Runtime.Interpreter.html#loadDLL"><span class="hs-identifier hs-var hs-var">loadDLL</span></a></span></span><span> </span><span id="local-6989586621681206872"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206872"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206871"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206871"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206872"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message (Maybe String)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#LoadDLL"><span class="hs-identifier hs-var">LoadDLL</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206871"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-507"></span><span>
</span><span id="line-508"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadArchive"><span class="hs-identifier hs-type">loadArchive</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span id="loadArchive"><span class="annot"><span class="annottext">loadArchive :: Interp -&gt; String -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#loadArchive"><span class="hs-identifier hs-var hs-var">loadArchive</span></a></span></span><span> </span><span id="local-6989586621681206869"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206869"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206868"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206868"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-510"></span><span>  </span><span id="local-6989586621681206867"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206867"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO String
</span><a href="../../directory-1.3.6.2/src/System-Directory.html#canonicalizePath"><span class="hs-identifier hs-var">canonicalizePath</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206868"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><span id="line-511"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206869"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#LoadArchive"><span class="hs-identifier hs-var">LoadArchive</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206867"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span>
</span><span id="line-513"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#loadObj"><span class="hs-identifier hs-type">loadObj</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span id="loadObj"><span class="annot"><span class="annottext">loadObj :: Interp -&gt; String -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#loadObj"><span class="hs-identifier hs-var hs-var">loadObj</span></a></span></span><span> </span><span id="local-6989586621681206864"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206864"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206863"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206863"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-515"></span><span>  </span><span id="local-6989586621681206862"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206862"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO String
</span><a href="../../directory-1.3.6.2/src/System-Directory.html#canonicalizePath"><span class="hs-identifier hs-var">canonicalizePath</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206863"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206864"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#LoadObj"><span class="hs-identifier hs-var">LoadObj</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206862"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#unloadObj"><span class="hs-identifier hs-type">unloadObj</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span id="unloadObj"><span class="annot"><span class="annottext">unloadObj :: Interp -&gt; String -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#unloadObj"><span class="hs-identifier hs-var hs-var">unloadObj</span></a></span></span><span> </span><span id="local-6989586621681206860"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206860"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206859"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206859"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-520"></span><span>  </span><span id="local-6989586621681206858"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206858"><span class="hs-identifier hs-var">path'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; IO String
</span><a href="../../directory-1.3.6.2/src/System-Directory.html#canonicalizePath"><span class="hs-identifier hs-var">canonicalizePath</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206859"><span class="hs-identifier hs-var">path</span></a></span><span> </span><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206860"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#UnloadObj"><span class="hs-identifier hs-var">UnloadObj</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206858"><span class="hs-identifier hs-var">path'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="hs-comment">-- Note [loadObj and relative paths]</span><span>
</span><span id="line-524"></span><span class="hs-comment">-- the iserv process might have a different current directory from the</span><span>
</span><span id="line-525"></span><span class="hs-comment">-- GHC process, so we must make paths absolute before sending them</span><span>
</span><span id="line-526"></span><span class="hs-comment">-- over.</span><span>
</span><span id="line-527"></span><span>
</span><span id="line-528"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#addLibrarySearchPath"><span class="hs-identifier hs-type">addLibrarySearchPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span id="addLibrarySearchPath"><span class="annot"><span class="annottext">addLibrarySearchPath :: Interp -&gt; String -&gt; IO (Ptr ())
</span><a href="GHC.Runtime.Interpreter.html#addLibrarySearchPath"><span class="hs-identifier hs-var hs-var">addLibrarySearchPath</span></a></span></span><span> </span><span id="local-6989586621681206856"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206856"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206855"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206855"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-530"></span><span>  </span><span class="annot"><span class="annottext">forall a. RemotePtr a -&gt; Ptr a
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#fromRemotePtr"><span class="hs-identifier hs-var">fromRemotePtr</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206856"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message (RemotePtr ())
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#AddLibrarySearchPath"><span class="hs-identifier hs-var">AddLibrarySearchPath</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206855"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#removeLibrarySearchPath"><span class="hs-identifier hs-type">removeLibrarySearchPath</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Ptr.html#Ptr"><span class="hs-identifier hs-type">Ptr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-533"></span><span id="removeLibrarySearchPath"><span class="annot"><span class="annottext">removeLibrarySearchPath :: Interp -&gt; Ptr () -&gt; IO Bool
</span><a href="GHC.Runtime.Interpreter.html#removeLibrarySearchPath"><span class="hs-identifier hs-var hs-var">removeLibrarySearchPath</span></a></span></span><span> </span><span id="local-6989586621681206853"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206853"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206852"><span class="annot"><span class="annottext">Ptr ()
</span><a href="#local-6989586621681206852"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-534"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206853"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RemotePtr () -&gt; Message Bool
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#RemoveLibrarySearchPath"><span class="hs-identifier hs-var">RemoveLibrarySearchPath</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. Ptr a -&gt; RemotePtr a
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#toRemotePtr"><span class="hs-identifier hs-var">toRemotePtr</span></a></span><span> </span><span class="annot"><span class="annottext">Ptr ()
</span><a href="#local-6989586621681206852"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#resolveObjs"><span class="hs-identifier hs-type">resolveObjs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Types.Basic.html#SuccessFlag"><span class="hs-identifier hs-type">SuccessFlag</span></a></span><span>
</span><span id="line-537"></span><span id="resolveObjs"><span class="annot"><span class="annottext">resolveObjs :: Interp -&gt; IO SuccessFlag
</span><a href="GHC.Runtime.Interpreter.html#resolveObjs"><span class="hs-identifier hs-var hs-var">resolveObjs</span></a></span></span><span> </span><span id="local-6989586621681206849"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206849"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SuccessFlag
</span><a href="GHC.Types.Basic.html#successIf"><span class="hs-identifier hs-var">successIf</span></a></span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../base-4.16.3.0/src/Data-Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206849"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="annot"><span class="annottext">Message Bool
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#ResolveObjs"><span class="hs-identifier hs-var">ResolveObjs</span></a></span><span>
</span><span id="line-538"></span><span>
</span><span id="line-539"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#findSystemLibrary"><span class="hs-identifier hs-type">findSystemLibrary</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-540"></span><span id="findSystemLibrary"><span class="annot"><span class="annottext">findSystemLibrary :: Interp -&gt; String -&gt; IO (Maybe String)
</span><a href="GHC.Runtime.Interpreter.html#findSystemLibrary"><span class="hs-identifier hs-var hs-var">findSystemLibrary</span></a></span></span><span> </span><span id="local-6989586621681206846"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206846"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206845"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206845"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206846"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Message (Maybe String)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#FindSystemLibrary"><span class="hs-identifier hs-var">FindSystemLibrary</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206845"><span class="hs-identifier hs-var">str</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>
</span><span id="line-542"></span><span>
</span><span id="line-543"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-544"></span><span class="hs-comment">-- Raw calls and messages</span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span class="hs-comment">-- | Send a 'Message' and receive the response from the iserv process</span><span>
</span><span id="line-547"></span><span id="local-6989586621681207539"><span class="annot"><a href="GHC.Runtime.Interpreter.html#iservCall"><span class="hs-identifier hs-type">iservCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../binary-0.8.9.0/src/Data-Binary-Class.html#Binary"><span class="hs-identifier hs-type">Binary</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207539"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207539"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207539"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-548"></span><span id="iservCall"><span class="annot"><span class="annottext">iservCall :: forall a. Binary a =&gt; IServInstance -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#iservCall"><span class="hs-identifier hs-var hs-var">iservCall</span></a></span></span><span> </span><span id="local-6989586621681206840"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206840"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span id="local-6989586621681206839"><span class="annot"><span class="annottext">Message a
</span><a href="#local-6989586621681206839"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-549"></span><span>  </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Pipe -&gt; Message a -&gt; IO a
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#remoteCall"><span class="hs-identifier hs-var">remoteCall</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; Pipe
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPipe"><span class="hs-identifier hs-var">iservPipe</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206840"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Message a
</span><a href="#local-6989586621681206839"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-550"></span><span>    </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#catch"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681206835"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206835"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Exception-Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. IServInstance -&gt; SomeException -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#handleIServFailure"><span class="hs-identifier hs-var">handleIServFailure</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206840"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206835"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span class="hs-comment">-- | Read a value from the iserv process</span><span>
</span><span id="line-553"></span><span id="local-6989586621681207414"><span class="annot"><a href="GHC.Runtime.Interpreter.html#readIServ"><span class="hs-identifier hs-type">readIServ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../binary-0.8.9.0/src/Data-Binary-Get-Internal.html#Get"><span class="hs-identifier hs-type">Get</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207414"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207414"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-554"></span><span id="readIServ"><span class="annot"><span class="annottext">readIServ :: forall a. IServInstance -&gt; Get a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#readIServ"><span class="hs-identifier hs-var hs-var">readIServ</span></a></span></span><span> </span><span id="local-6989586621681206832"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206832"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span id="local-6989586621681206831"><span class="annot"><span class="annottext">Get a
</span><a href="#local-6989586621681206831"><span class="hs-identifier hs-var">get</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-555"></span><span>  </span><span class="annot"><span class="annottext">forall a. Pipe -&gt; Get a -&gt; IO a
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#readPipe"><span class="hs-identifier hs-var">readPipe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; Pipe
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPipe"><span class="hs-identifier hs-var">iservPipe</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206832"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Get a
</span><a href="#local-6989586621681206831"><span class="hs-identifier hs-var">get</span></a></span><span>
</span><span id="line-556"></span><span>    </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#catch"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681206829"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206829"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Exception-Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. IServInstance -&gt; SomeException -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#handleIServFailure"><span class="hs-identifier hs-var">handleIServFailure</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206832"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206829"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span class="hs-comment">-- | Send a value to the iserv process</span><span>
</span><span id="line-559"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#writeIServ"><span class="hs-identifier hs-type">writeIServ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../binary-0.8.9.0/src/Data-Binary-Put.html#Put"><span class="hs-identifier hs-type">Put</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span id="writeIServ"><span class="annot"><span class="annottext">writeIServ :: IServInstance -&gt; Put -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#writeIServ"><span class="hs-identifier hs-var hs-var">writeIServ</span></a></span></span><span> </span><span id="local-6989586621681206828"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206828"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span id="local-6989586621681206827"><span class="annot"><span class="annottext">Put
</span><a href="#local-6989586621681206827"><span class="hs-identifier hs-var">put</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-561"></span><span>  </span><span class="annot"><span class="annottext">Pipe -&gt; Put -&gt; IO ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#writePipe"><span class="hs-identifier hs-var">writePipe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; Pipe
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPipe"><span class="hs-identifier hs-var">iservPipe</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206828"><span class="hs-identifier hs-var">iserv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Put
</span><a href="#local-6989586621681206827"><span class="hs-identifier hs-var">put</span></a></span><span>
</span><span id="line-562"></span><span>    </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; IO a -&gt; (e -&gt; IO a) -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#catch"><span class="hs-operator hs-var">`catch`</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621681206825"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206825"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Exception-Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. IServInstance -&gt; SomeException -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#handleIServFailure"><span class="hs-identifier hs-var">handleIServFailure</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206828"><span class="hs-identifier hs-var">iserv</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206825"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-563"></span><span>
</span><span id="line-564"></span><span id="local-6989586621681207415"><span class="annot"><a href="GHC.Runtime.Interpreter.html#handleIServFailure"><span class="hs-identifier hs-type">handleIServFailure</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Exception-Type.html#SomeException"><span class="hs-identifier hs-type">SomeException</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207415"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-565"></span><span id="handleIServFailure"><span class="annot"><span class="annottext">handleIServFailure :: forall a. IServInstance -&gt; SomeException -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#handleIServFailure"><span class="hs-identifier hs-var hs-var">handleIServFailure</span></a></span></span><span> </span><span id="local-6989586621681206817"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206817"><span class="hs-identifier hs-var">iserv</span></a></span></span><span> </span><span id="local-6989586621681206816"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206816"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-566"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681206815"><span class="annot"><span class="annottext">proc :: ProcessHandle
</span><a href="#local-6989586621681206815"><span class="hs-identifier hs-var hs-var">proc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IServInstance -&gt; ProcessHandle
</span><a href="GHC.Runtime.Interpreter.Types.html#iservProcess"><span class="hs-identifier hs-var">iservProcess</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206817"><span class="hs-identifier hs-var">iserv</span></a></span><span>
</span><span id="line-567"></span><span>  </span><span id="local-6989586621681206813"><span class="annot"><span class="annottext">Maybe ExitCode
</span><a href="#local-6989586621681206813"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ProcessHandle -&gt; IO (Maybe ExitCode)
</span><a href="../../process-1.6.13.2/src/System-Process.html#getProcessExitCode"><span class="hs-identifier hs-var">getProcessExitCode</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206815"><span class="hs-identifier hs-var">proc</span></a></span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ExitCode
</span><a href="#local-6989586621681206813"><span class="hs-identifier hs-var">ex</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-569"></span><span>    </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-IO-Exception.html#ExitFailure"><span class="hs-identifier hs-type">ExitFailure</span></a></span><span> </span><span id="local-6989586621681206810"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206810"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-570"></span><span>      </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><a href="GHC.Utils.Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ghc-iserv terminated (&quot;</span></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><a href="../../base-4.16.3.0/src/GHC-Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621681206810"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-571"></span><span>    </span><span class="annot"><span class="annottext">Maybe ExitCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-572"></span><span>      </span><span class="annot"><span class="annottext">ProcessHandle -&gt; IO ()
</span><a href="../../process-1.6.13.2/src/System-Process.html#terminateProcess"><span class="hs-identifier hs-var">terminateProcess</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206815"><span class="hs-identifier hs-var">proc</span></a></span><span>
</span><span id="line-573"></span><span>      </span><span class="annot"><span class="annottext">ExitCode
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ProcessHandle -&gt; IO ExitCode
</span><a href="../../process-1.6.13.2/src/System-Process.html#waitForProcess"><span class="hs-identifier hs-var">waitForProcess</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206815"><span class="hs-identifier hs-var">proc</span></a></span><span>
</span><span id="line-574"></span><span>      </span><span class="annot"><span class="annottext">forall a e. Exception e =&gt; e -&gt; a
</span><a href="../../base-4.16.3.0/src/GHC-Exception.html#throw"><span class="hs-identifier hs-var">throw</span></a></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621681206816"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-575"></span><span>
</span><span id="line-576"></span><span class="hs-comment">-- | Spawn an external interpreter</span><span>
</span><span id="line-577"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#spawnIServ"><span class="hs-identifier hs-type">spawnIServ</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServConfig"><span class="hs-identifier hs-type">IServConfig</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span>
</span><span id="line-578"></span><span id="spawnIServ"><span class="annot"><span class="annottext">spawnIServ :: IServConfig -&gt; IO IServInstance
</span><a href="GHC.Runtime.Interpreter.html#spawnIServ"><span class="hs-identifier hs-var hs-var">spawnIServ</span></a></span></span><span> </span><span id="local-6989586621681206805"><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206805"><span class="hs-identifier hs-var">conf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-579"></span><span>  </span><span class="annot"><span class="annottext">IServConfig -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.Types.html#iservConfTrace"><span class="hs-identifier hs-var">iservConfTrace</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206805"><span class="hs-identifier hs-var">conf</span></a></span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681206803"><span class="annot"><span class="annottext">createProc :: CreateProcess -&gt; IO ProcessHandle
</span><a href="#local-6989586621681206803"><span class="hs-identifier hs-var hs-var">createProc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../base-4.16.3.0/src/Data-Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621681206801"><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621681206801"><span class="hs-identifier hs-var">cp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span> </span><span class="hs-special">{</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">Maybe Handle
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621681206800"><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206800"><span class="hs-identifier hs-var">ph</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CreateProcess
-&gt; IO (Maybe Handle, Maybe Handle, Maybe Handle, ProcessHandle)
</span><a href="../../process-1.6.13.2/src/System-Process.html#createProcess"><span class="hs-identifier hs-var">createProcess</span></a></span><span> </span><span class="annot"><span class="annottext">CreateProcess
</span><a href="#local-6989586621681206801"><span class="hs-identifier hs-var">cp</span></a></span><span>
</span><span id="line-581"></span><span>                                        </span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206800"><span class="hs-identifier hs-var">ph</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-582"></span><span>                             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServConfig -&gt; Maybe (CreateProcess -&gt; IO ProcessHandle)
</span><a href="GHC.Runtime.Interpreter.Types.html#iservConfHook"><span class="hs-identifier hs-var">iservConfHook</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206805"><span class="hs-identifier hs-var">conf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621681206797"><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206797"><span class="hs-identifier hs-var">ph</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681206796"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206796"><span class="hs-identifier hs-var">rh</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681206795"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206795"><span class="hs-identifier hs-var">wh</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CreateProcess -&gt; IO ProcessHandle)
-&gt; String -&gt; [String] -&gt; IO (ProcessHandle, Handle, Handle)
</span><a href="GHC.Runtime.Interpreter.html#runWithPipes"><span class="hs-identifier hs-var">runWithPipes</span></a></span><span> </span><span class="annot"><span class="annottext">CreateProcess -&gt; IO ProcessHandle
</span><a href="#local-6989586621681206803"><span class="hs-identifier hs-var">createProc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServConfig -&gt; String
</span><a href="GHC.Runtime.Interpreter.Types.html#iservConfProgram"><span class="hs-identifier hs-var">iservConfProgram</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206805"><span class="hs-identifier hs-var">conf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>                                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServConfig -&gt; [String]
</span><a href="GHC.Runtime.Interpreter.Types.html#iservConfOpts"><span class="hs-identifier hs-var">iservConfOpts</span></a></span><span>    </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206805"><span class="hs-identifier hs-var">conf</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-585"></span><span>  </span><span id="local-6989586621681206791"><span class="annot"><span class="annottext">IORef (Maybe ByteString)
</span><a href="#local-6989586621681206791"><span class="hs-identifier hs-var">lo_ref</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; IO (IORef a)
</span><a href="../../base-4.16.3.0/src/GHC-IORef.html#newIORef"><span class="hs-identifier hs-var">newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-586"></span><span>  </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServInstance"><span class="hs-identifier hs-type">IServInstance</span></a></span><span>
</span><span id="line-587"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">iservPipe :: Pipe
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPipe"><span class="hs-identifier hs-var">iservPipe</span></a></span><span>              </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#Pipe"><span class="hs-identifier hs-type">Pipe</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">pipeRead :: Handle
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#pipeRead"><span class="hs-identifier hs-var">pipeRead</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206796"><span class="hs-identifier hs-var">rh</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pipeWrite :: Handle
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#pipeWrite"><span class="hs-identifier hs-var">pipeWrite</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206795"><span class="hs-identifier hs-var">wh</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">pipeLeftovers :: IORef (Maybe ByteString)
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#pipeLeftovers"><span class="hs-identifier hs-var">pipeLeftovers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Maybe ByteString)
</span><a href="#local-6989586621681206791"><span class="hs-identifier hs-var">lo_ref</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-588"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">iservProcess :: ProcessHandle
</span><a href="GHC.Runtime.Interpreter.Types.html#iservProcess"><span class="hs-identifier hs-var">iservProcess</span></a></span><span>           </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206797"><span class="hs-identifier hs-var">ph</span></a></span><span>
</span><span id="line-589"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">iservLookupSymbolCache :: UniqFM FastString (Ptr ())
</span><a href="GHC.Runtime.Interpreter.Types.html#iservLookupSymbolCache"><span class="hs-identifier hs-var">iservLookupSymbolCache</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall key elt. UniqFM key elt
</span><a href="GHC.Types.Unique.FM.html#emptyUFM"><span class="hs-identifier hs-var">emptyUFM</span></a></span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">iservPendingFrees :: [HValueRef]
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPendingFrees"><span class="hs-identifier hs-var">iservPendingFrees</span></a></span><span>      </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-591"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span class="hs-comment">-- | Stop the interpreter</span><span>
</span><span id="line-594"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#stopInterp"><span class="hs-identifier hs-type">stopInterp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span id="stopInterp"><span class="annot"><span class="annottext">stopInterp :: Interp -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#stopInterp"><span class="hs-identifier hs-var hs-var">stopInterp</span></a></span></span><span> </span><span id="local-6989586621681206784"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206784"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206784"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>    </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>    </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServ"><span class="hs-identifier hs-type">IServ</span></a></span><span> </span><span id="local-6989586621681206783"><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681206783"><span class="hs-identifier hs-var">mstate</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-600"></span><span>      </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) b.
MonadMask m =&gt;
((forall a. m a -&gt; m a) -&gt; m b) -&gt; m b
</span><a href="../../exceptions-0.10.4/src/Control-Monad-Catch.html#mask"><span class="hs-identifier hs-var">MC.mask</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206782"><span class="annot"><span class="annottext">forall a. IO a -&gt; IO a
</span><a href="#local-6989586621681206782"><span class="hs-identifier hs-var">_restore</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/Control-Concurrent-MVar.html#modifyMVar_"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681206783"><span class="hs-identifier hs-var">mstate</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206781"><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206781"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-601"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206781"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-602"></span><span>          </span><span class="annot"><span class="annottext">IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServPending"><span class="hs-identifier hs-var">IServPending</span></a></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206781"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-comment">-- already stopped</span><span>
</span><span id="line-603"></span><span>          </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-type">IServRunning</span></a></span><span> </span><span id="local-6989586621681206780"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206780"><span class="hs-identifier hs-var">i</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-604"></span><span>            </span><span id="local-6989586621681206779"><span class="annot"><span class="annottext">Maybe ExitCode
</span><a href="#local-6989586621681206779"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ProcessHandle -&gt; IO (Maybe ExitCode)
</span><a href="../../process-1.6.13.2/src/System-Process.html#getProcessExitCode"><span class="hs-identifier hs-var">getProcessExitCode</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; ProcessHandle
</span><a href="GHC.Runtime.Interpreter.Types.html#iservProcess"><span class="hs-identifier hs-var">iservProcess</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206780"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-605"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a -&gt; Bool
</span><a href="../../base-4.16.3.0/src/Data-Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ExitCode
</span><a href="#local-6989586621681206779"><span class="hs-identifier hs-var">ex</span></a></span><span>
</span><span id="line-606"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; IServInstance -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#iservCall"><span class="hs-identifier hs-var">iservCall</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206780"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#Shutdown"><span class="hs-identifier hs-var">Shutdown</span></a></span><span>
</span><span id="line-608"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServPending"><span class="hs-identifier hs-var">IServPending</span></a></span><span>
</span><span id="line-609"></span><span>
</span><span id="line-610"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#runWithPipes"><span class="hs-identifier hs-type">runWithPipes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../process-1.6.13.2/src/System-Process-Common.html#CreateProcess"><span class="hs-identifier hs-type">CreateProcess</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="../../process-1.6.13.2/src/System-Process-Common.html#ProcessHandle"><span class="hs-identifier hs-type">ProcessHandle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-611"></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-IO.html#FilePath"><span class="hs-identifier hs-type">FilePath</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../process-1.6.13.2/src/System-Process-Common.html#ProcessHandle"><span class="hs-identifier hs-type">ProcessHandle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-IO-Handle-Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-IO-Handle-Types.html#Handle"><span class="hs-identifier hs-type">Handle</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#if defined(mingw32_HOST_OS)
</span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-string">&quot;io.h _close&quot;</span><span>
</span><span id="line-614"></span><span>   </span><span class="hs-identifier">c__close</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><span id="line-615"></span><span>
</span><span id="line-616"></span><span class="hs-keyword">foreign</span><span> </span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">ccall</span><span> </span><span class="hs-keyword">unsafe</span><span> </span><span class="hs-string">&quot;io.h _get_osfhandle&quot;</span><span>
</span><span id="line-617"></span><span>   </span><span class="hs-identifier">_get_osfhandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">CInt</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span class="hs-identifier">runWithPipes</span><span> </span><span class="hs-identifier">createProc</span><span> </span><span class="hs-identifier">prog</span><span> </span><span class="hs-identifier">opts</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-620"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">rfd1</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wfd1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">createPipeFd</span><span> </span><span class="hs-comment">-- we read on rfd1</span><span>
</span><span id="line-621"></span><span>    </span><span class="hs-special">(</span><span class="hs-identifier">rfd2</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wfd2</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">createPipeFd</span><span> </span><span class="hs-comment">-- we write on wfd2</span><span>
</span><span id="line-622"></span><span>    </span><span class="hs-identifier">wh_client</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_get_osfhandle</span><span> </span><span class="hs-identifier">wfd1</span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-identifier">rh_client</span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">_get_osfhandle</span><span> </span><span class="hs-identifier">rfd2</span><span>
</span><span id="line-624"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-identifier">args</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">wh_client</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">show</span><span> </span><span class="hs-identifier">rh_client</span><span> </span><span class="hs-glyph">:</span><span> </span><span class="hs-identifier">opts</span><span>
</span><span id="line-625"></span><span>    </span><span class="hs-identifier">ph</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">createProc</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">proc</span><span> </span><span class="hs-identifier">prog</span><span> </span><span class="hs-identifier">args</span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>    </span><span class="hs-identifier">rh</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-identifier">rfd1</span><span>
</span><span id="line-627"></span><span>    </span><span class="hs-identifier">wh</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-identifier">wfd2</span><span>
</span><span id="line-628"></span><span>    </span><span class="hs-identifier">return</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">ph</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">rh</span><span class="hs-special">,</span><span> </span><span class="hs-identifier">wh</span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>      </span><span class="hs-keyword">where</span><span> </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier">CInt</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">IO</span><span> </span><span class="hs-identifier">Handle</span><span>
</span><span id="line-630"></span><span>            </span><span class="hs-identifier">mkHandle</span><span> </span><span class="hs-identifier">fd</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">fdToHandle</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span> </span><span class="hs-special">`</span><span class="hs-identifier">Ex.onException</span><span class="hs-special">`</span><span> </span><span class="hs-special">(</span><span class="hs-identifier">c__close</span><span> </span><span class="hs-identifier">fd</span><span class="hs-special">)</span><span class="hs-cpp">

#else
</span><span id="runWithPipes"><span class="annot"><span class="annottext">runWithPipes :: (CreateProcess -&gt; IO ProcessHandle)
-&gt; String -&gt; [String] -&gt; IO (ProcessHandle, Handle, Handle)
</span><a href="GHC.Runtime.Interpreter.html#runWithPipes"><span class="hs-identifier hs-var hs-var">runWithPipes</span></a></span></span><span> </span><span id="local-6989586621681206775"><span class="annot"><span class="annottext">CreateProcess -&gt; IO ProcessHandle
</span><a href="#local-6989586621681206775"><span class="hs-identifier hs-var">createProc</span></a></span></span><span> </span><span id="local-6989586621681206774"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206774"><span class="hs-identifier hs-var">prog</span></a></span></span><span> </span><span id="local-6989586621681206773"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621681206773"><span class="hs-identifier hs-var">opts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-634"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681206772"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206772"><span class="hs-identifier hs-var">rfd1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681206771"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206771"><span class="hs-identifier hs-var">wfd1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Fd, Fd)
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#createPipe"><span class="hs-identifier hs-var">Posix.createPipe</span></a></span><span> </span><span class="hs-comment">-- we read on rfd1</span><span>
</span><span id="line-635"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621681206769"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206769"><span class="hs-identifier hs-var">rfd2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621681206768"><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206768"><span class="hs-identifier hs-var">wfd2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Fd, Fd)
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#createPipe"><span class="hs-identifier hs-var">Posix.createPipe</span></a></span><span> </span><span class="hs-comment">-- we write on wfd2</span><span>
</span><span id="line-636"></span><span>    </span><span class="annot"><span class="annottext">Fd -&gt; FdOption -&gt; Bool -&gt; IO ()
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#setFdOption"><span class="hs-identifier hs-var">setFdOption</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206772"><span class="hs-identifier hs-var">rfd1</span></a></span><span> </span><span class="annot"><span class="annottext">FdOption
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#CloseOnExec"><span class="hs-identifier hs-var">CloseOnExec</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-637"></span><span>    </span><span class="annot"><span class="annottext">Fd -&gt; FdOption -&gt; Bool -&gt; IO ()
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#setFdOption"><span class="hs-identifier hs-var">setFdOption</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206768"><span class="hs-identifier hs-var">wfd2</span></a></span><span> </span><span class="annot"><span class="annottext">FdOption
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#CloseOnExec"><span class="hs-identifier hs-var">CloseOnExec</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-638"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681206765"><span class="annot"><span class="annottext">args :: [String]
</span><a href="#local-6989586621681206765"><span class="hs-identifier hs-var hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><a href="../../base-4.16.3.0/src/GHC-Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206771"><span class="hs-identifier hs-var">wfd1</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">forall a. Show a =&gt; a -&gt; String
</span><a href="../../base-4.16.3.0/src/GHC-Show.html#show"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206769"><span class="hs-identifier hs-var">rfd2</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621681206773"><span class="hs-identifier hs-var">opts</span></a></span><span>
</span><span id="line-639"></span><span>    </span><span id="local-6989586621681206764"><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206764"><span class="hs-identifier hs-var">ph</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CreateProcess -&gt; IO ProcessHandle
</span><a href="#local-6989586621681206775"><span class="hs-identifier hs-var">createProc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; [String] -&gt; CreateProcess
</span><a href="../../process-1.6.13.2/src/System-Process.html#proc"><span class="hs-identifier hs-var">proc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621681206774"><span class="hs-identifier hs-var">prog</span></a></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621681206765"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>    </span><span class="annot"><span class="annottext">Fd -&gt; IO ()
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#closeFd"><span class="hs-identifier hs-var">closeFd</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206771"><span class="hs-identifier hs-var">wfd1</span></a></span><span>
</span><span id="line-641"></span><span>    </span><span class="annot"><span class="annottext">Fd -&gt; IO ()
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#closeFd"><span class="hs-identifier hs-var">closeFd</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206769"><span class="hs-identifier hs-var">rfd2</span></a></span><span>
</span><span id="line-642"></span><span>    </span><span id="local-6989586621681206761"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206761"><span class="hs-identifier hs-var">rh</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; IO Handle
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#fdToHandle"><span class="hs-identifier hs-var">fdToHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206772"><span class="hs-identifier hs-var">rfd1</span></a></span><span>
</span><span id="line-643"></span><span>    </span><span id="local-6989586621681206759"><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206759"><span class="hs-identifier hs-var">wh</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Fd -&gt; IO Handle
</span><a href="../../unix-2.7.2.2/src/System-Posix-IO-Common.html#fdToHandle"><span class="hs-identifier hs-var">fdToHandle</span></a></span><span> </span><span class="annot"><span class="annottext">Fd
</span><a href="#local-6989586621681206768"><span class="hs-identifier hs-var">wfd2</span></a></span><span>
</span><span id="line-644"></span><span>    </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ProcessHandle
</span><a href="#local-6989586621681206764"><span class="hs-identifier hs-var">ph</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206761"><span class="hs-identifier hs-var">rh</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Handle
</span><a href="#local-6989586621681206759"><span class="hs-identifier hs-var">wh</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>
</span><span id="line-647"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-648"></span><span class="hs-comment">{- Note [External GHCi pointers]

We have the following ways to reference things in GHCi:

HValue
------

HValue is a direct reference to a value in the local heap.  Obviously
we cannot use this to refer to things in the external process.


RemoteRef
---------

RemoteRef is a StablePtr to a heap-resident value.  When
-fexternal-interpreter is used, this value resides in the external
process's heap.  RemoteRefs are mostly used to send pointers in
messages between GHC and iserv.

A RemoteRef must be explicitly freed when no longer required, using
freeHValueRefs, or by attaching a finalizer with mkForeignHValue.

To get from a RemoteRef to an HValue you can use 'wormholeRef', which
fails with an error message if -fexternal-interpreter is in use.

ForeignRef
----------

A ForeignRef is a RemoteRef with a finalizer that will free the
'RemoteRef' when it is garbage collected.  We mostly use ForeignHValue
on the GHC side.

The finalizer adds the RemoteRef to the iservPendingFrees list in the
IServ record.  The next call to interpCmd will free any RemoteRefs in
the list.  It was done this way rather than calling interpCmd directly,
because I didn't want to have arbitrary threads calling interpCmd.  In
principle it would probably be ok, but it seems less hairy this way.
-}</span><span>
</span><span id="line-686"></span><span>
</span><span id="line-687"></span><span class="hs-comment">-- | Creates a 'ForeignRef' that will automatically release the</span><span>
</span><span id="line-688"></span><span class="hs-comment">-- 'RemoteRef' when it is no longer referenced.</span><span>
</span><span id="line-689"></span><span id="local-6989586621681207482"><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-type">mkFinalizedHValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#RemoteRef"><span class="hs-identifier hs-type">RemoteRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207482"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207482"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-690"></span><span id="mkFinalizedHValue"><span class="annot"><span class="annottext">mkFinalizedHValue :: forall a. Interp -&gt; RemoteRef a -&gt; IO (ForeignRef a)
</span><a href="GHC.Runtime.Interpreter.html#mkFinalizedHValue"><span class="hs-identifier hs-var hs-var">mkFinalizedHValue</span></a></span></span><span> </span><span id="local-6989586621681206753"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206753"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206752"><span class="annot"><span class="annottext">RemoteRef a
</span><a href="#local-6989586621681206752"><span class="hs-identifier hs-var">rref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-691"></span><span>   </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621681206751"><span class="annot"><span class="annottext">hvref :: HValueRef
</span><a href="#local-6989586621681206751"><span class="hs-identifier hs-var hs-var">hvref</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. RemoteRef a -&gt; HValueRef
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#toHValueRef"><span class="hs-identifier hs-var">toHValueRef</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef a
</span><a href="#local-6989586621681206752"><span class="hs-identifier hs-var">rref</span></a></span><span>
</span><span id="line-692"></span><span>
</span><span id="line-693"></span><span>   </span><span id="local-6989586621681206749"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681206749"><span class="hs-identifier hs-var">free</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206753"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>      </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. RemoteRef a -&gt; IO ()
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#freeRemoteRef"><span class="hs-identifier hs-var">freeRemoteRef</span></a></span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206751"><span class="hs-identifier hs-var">hvref</span></a></span><span class="hs-special">)</span><span class="hs-cpp">
#endif
</span><span>      </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServ"><span class="hs-identifier hs-type">IServ</span></a></span><span> </span><span id="local-6989586621681206747"><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681206747"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../../base-4.16.3.0/src/Control-Concurrent-MVar.html#modifyMVar_"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar IServState
</span><a href="#local-6989586621681206747"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621681206746"><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206746"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-698"></span><span>       </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206746"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-699"></span><span>         </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServPending"><span class="hs-identifier hs-type">IServPending</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">IServState
</span><a href="#local-6989586621681206746"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-comment">-- already shut down</span><span>
</span><span id="line-700"></span><span>         </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-type">IServRunning</span></a></span><span> </span><span id="local-6989586621681206745"><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206745"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-701"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-glyph">!</span><span id="local-6989586621681206744"><span class="annot"><span class="annottext">inst' :: IServInstance
</span><a href="#local-6989586621681206744"><span class="hs-identifier hs-var hs-var">inst'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206745"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">iservPendingFrees :: [HValueRef]
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPendingFrees"><span class="hs-identifier hs-var">iservPendingFrees</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HValueRef
</span><a href="#local-6989586621681206751"><span class="hs-identifier hs-var">hvref</span></a></span><span class="annot"><span class="annottext">forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="annot"><span class="annottext">IServInstance -&gt; [HValueRef]
</span><a href="GHC.Runtime.Interpreter.Types.html#iservPendingFrees"><span class="hs-identifier hs-var">iservPendingFrees</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206745"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-702"></span><span>            </span><span class="annot"><span class="annottext">forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IServInstance -&gt; IServState
</span><a href="GHC.Runtime.Interpreter.Types.html#IServRunning"><span class="hs-identifier hs-var">IServRunning</span></a></span><span> </span><span class="annot"><span class="annottext">IServInstance
</span><a href="#local-6989586621681206744"><span class="hs-identifier hs-var">inst'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span>   </span><span class="annot"><span class="annottext">forall a. RemoteRef a -&gt; IO () -&gt; IO (ForeignRef a)
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#mkForeignRef"><span class="hs-identifier hs-var">mkForeignRef</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef a
</span><a href="#local-6989586621681206752"><span class="hs-identifier hs-var">rref</span></a></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621681206749"><span class="hs-identifier hs-var">free</span></a></span><span>
</span><span id="line-705"></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#freeHValueRefs"><span class="hs-identifier hs-type">freeHValueRefs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#HValueRef"><span class="hs-identifier hs-type">HValueRef</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-708"></span><span id="freeHValueRefs"><span class="annot"><span class="annottext">freeHValueRefs :: Interp -&gt; [HValueRef] -&gt; IO ()
</span><a href="GHC.Runtime.Interpreter.html#freeHValueRefs"><span class="hs-identifier hs-var hs-var">freeHValueRefs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Interp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-709"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#freeHValueRefs"><span class="hs-identifier hs-var">freeHValueRefs</span></a></span><span> </span><span id="local-6989586621681206742"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206742"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206741"><span class="annot"><span class="annottext">[HValueRef]
</span><a href="#local-6989586621681206741"><span class="hs-identifier hs-var">refs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Binary a =&gt; Interp -&gt; Message a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#interpCmd"><span class="hs-identifier hs-var">interpCmd</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206742"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HValueRef] -&gt; Message ()
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#FreeHValueRefs"><span class="hs-identifier hs-var">FreeHValueRefs</span></a></span><span> </span><span class="annot"><span class="annottext">[HValueRef]
</span><a href="#local-6989586621681206741"><span class="hs-identifier hs-var">refs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-710"></span><span>
</span><span id="line-711"></span><span class="hs-comment">-- | Convert a 'ForeignRef' to the value it references directly.  This</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- only works when the interpreter is running in the same process as</span><span>
</span><span id="line-713"></span><span class="hs-comment">-- the compiler, so it fails when @-fexternal-interpreter@ is on.</span><span>
</span><span id="line-714"></span><span id="local-6989586621681207393"><span class="annot"><a href="GHC.Runtime.Interpreter.html#wormhole"><span class="hs-identifier hs-type">wormhole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#ForeignRef"><span class="hs-identifier hs-type">ForeignRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207393"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207393"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-715"></span><span id="wormhole"><span class="annot"><span class="annottext">wormhole :: forall a. Interp -&gt; ForeignRef a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#wormhole"><span class="hs-identifier hs-var hs-var">wormhole</span></a></span></span><span> </span><span id="local-6989586621681206740"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206740"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206739"><span class="annot"><span class="annottext">ForeignRef a
</span><a href="#local-6989586621681206739"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Interp -&gt; RemoteRef a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#wormholeRef"><span class="hs-identifier hs-var">wormholeRef</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206740"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a. ForeignRef a -&gt; RemoteRef a
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#unsafeForeignRefToRemoteRef"><span class="hs-identifier hs-var">unsafeForeignRefToRemoteRef</span></a></span><span> </span><span class="annot"><span class="annottext">ForeignRef a
</span><a href="#local-6989586621681206739"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span class="hs-comment">-- | Convert an 'RemoteRef' to the value it references directly.  This</span><span>
</span><span id="line-718"></span><span class="hs-comment">-- only works when the interpreter is running in the same process as</span><span>
</span><span id="line-719"></span><span class="hs-comment">-- the compiler, so it fails when @-fexternal-interpreter@ is on.</span><span>
</span><span id="line-720"></span><span id="local-6989586621681207391"><span class="annot"><a href="GHC.Runtime.Interpreter.html#wormholeRef"><span class="hs-identifier hs-type">wormholeRef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#RemoteRef"><span class="hs-identifier hs-type">RemoteRef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207391"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207391"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-721"></span><span id="wormholeRef"><span class="annot"><span class="annottext">wormholeRef :: forall a. Interp -&gt; RemoteRef a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#wormholeRef"><span class="hs-identifier hs-var hs-var">wormholeRef</span></a></span></span><span> </span><span id="local-6989586621681206736"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206736"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span id="local-6989586621681206735"><span class="annot"><span class="annottext">RemoteRef a
</span><a href="#local-6989586621681206735"><span class="hs-identifier hs-var">_r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206736"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>  </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall a. RemoteRef a -&gt; IO a
</span><a href="../../ghci-9.2.4/src/GHCi-RemoteTypes.html#localRef"><span class="hs-identifier hs-var">localRef</span></a></span><span> </span><span class="annot"><span class="annottext">RemoteRef a
</span><a href="#local-6989586621681206735"><span class="hs-identifier hs-var">_r</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-726"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; GhcException
</span><a href="GHC.Utils.Panic.html#InstallationError"><span class="hs-identifier hs-var">InstallationError</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;this operation requires -fno-external-interpreter&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-727"></span><span>
</span><span id="line-728"></span><span class="hs-comment">-- -----------------------------------------------------------------------------</span><span>
</span><span id="line-729"></span><span class="hs-comment">-- Misc utils</span><span>
</span><span id="line-730"></span><span>
</span><span id="line-731"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#mkEvalOpts"><span class="hs-identifier hs-type">mkEvalOpts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Driver.Session.html#DynFlags"><span class="hs-identifier hs-type">DynFlags</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalOpts"><span class="hs-identifier hs-type">EvalOpts</span></a></span><span>
</span><span id="line-732"></span><span id="mkEvalOpts"><span class="annot"><span class="annottext">mkEvalOpts :: DynFlags -&gt; Bool -&gt; EvalOpts
</span><a href="GHC.Runtime.Interpreter.html#mkEvalOpts"><span class="hs-identifier hs-var hs-var">mkEvalOpts</span></a></span></span><span> </span><span id="local-6989586621681206733"><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681206733"><span class="hs-identifier hs-var">dflags</span></a></span></span><span> </span><span id="local-6989586621681206732"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681206732"><span class="hs-identifier hs-var">step</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-733"></span><span>  </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalOpts"><span class="hs-identifier hs-type">EvalOpts</span></a></span><span>
</span><span id="line-734"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">useSandboxThread :: Bool
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#useSandboxThread"><span class="hs-identifier hs-var">useSandboxThread</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_GhciSandbox"><span class="hs-identifier hs-var">Opt_GhciSandbox</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681206733"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-735"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">singleStep :: Bool
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#singleStep"><span class="hs-identifier hs-var">singleStep</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621681206732"><span class="hs-identifier hs-var">step</span></a></span><span>
</span><span id="line-736"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">breakOnException :: Bool
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#breakOnException"><span class="hs-identifier hs-var">breakOnException</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_BreakOnException"><span class="hs-identifier hs-var">Opt_BreakOnException</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681206733"><span class="hs-identifier hs-var">dflags</span></a></span><span>
</span><span id="line-737"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">breakOnError :: Bool
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#breakOnError"><span class="hs-identifier hs-var">breakOnError</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">GeneralFlag -&gt; DynFlags -&gt; Bool
</span><a href="GHC.Driver.Session.html#gopt"><span class="hs-identifier hs-var">gopt</span></a></span><span> </span><span class="annot"><span class="annottext">GeneralFlag
</span><a href="GHC.Driver.Flags.html#Opt_BreakOnError"><span class="hs-identifier hs-var">Opt_BreakOnError</span></a></span><span> </span><span class="annot"><span class="annottext">DynFlags
</span><a href="#local-6989586621681206733"><span class="hs-identifier hs-var">dflags</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-738"></span><span>
</span><span id="line-739"></span><span id="local-6989586621681207479"><span class="annot"><a href="GHC.Runtime.Interpreter.html#fromEvalResult"><span class="hs-identifier hs-type">fromEvalResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalResult"><span class="hs-identifier hs-type">EvalResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621681207479"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621681207479"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-740"></span><span id="fromEvalResult"><span class="annot"><span class="annottext">fromEvalResult :: forall a. EvalResult a -&gt; IO a
</span><a href="GHC.Runtime.Interpreter.html#fromEvalResult"><span class="hs-identifier hs-var hs-var">fromEvalResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalException"><span class="hs-identifier hs-type">EvalException</span></a></span><span> </span><span id="local-6989586621681206720"><span class="annot"><span class="annottext">SerializableException
</span><a href="#local-6989586621681206720"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall e a. Exception e =&gt; e -&gt; IO a
</span><a href="../../base-4.16.3.0/src/GHC-IO.html#throwIO"><span class="hs-identifier hs-var">throwIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SerializableException -&gt; SomeException
</span><a href="../../ghci-9.2.4/src/GHCi-Message.html#fromSerializableException"><span class="hs-identifier hs-var">fromSerializableException</span></a></span><span> </span><span class="annot"><span class="annottext">SerializableException
</span><a href="#local-6989586621681206720"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#fromEvalResult"><span class="hs-identifier hs-var">fromEvalResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../ghci-9.2.4/src/GHCi-Message.html#EvalSuccess"><span class="hs-identifier hs-type">EvalSuccess</span></a></span><span> </span><span id="local-6989586621681206718"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681206718"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621681206718"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#getModBreaks"><span class="hs-identifier hs-type">getModBreaks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Unit.Home.ModInfo.html#HomeModInfo"><span class="hs-identifier hs-type">HomeModInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="GHC.ByteCode.Types.html#ModBreaks"><span class="hs-identifier hs-type">ModBreaks</span></a></span><span>
</span><span id="line-744"></span><span id="getModBreaks"><span class="annot"><span class="annottext">getModBreaks :: HomeModInfo -&gt; ModBreaks
</span><a href="GHC.Runtime.Interpreter.html#getModBreaks"><span class="hs-identifier hs-var hs-var">getModBreaks</span></a></span></span><span> </span><span id="local-6989586621681206717"><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681206717"><span class="hs-identifier hs-var">hmi</span></a></span></span><span>
</span><span id="line-745"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621681206716"><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621681206716"><span class="hs-identifier hs-var">linkable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HomeModInfo -&gt; Maybe Linkable
</span><a href="GHC.Unit.Home.ModInfo.html#hm_linkable"><span class="hs-identifier hs-var">hm_linkable</span></a></span><span> </span><span class="annot"><span class="annottext">HomeModInfo
</span><a href="#local-6989586621681206717"><span class="hs-identifier hs-var">hmi</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-746"></span><span>    </span><span class="hs-special">[</span><span id="local-6989586621681206714"><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621681206714"><span class="hs-identifier hs-var">cbc</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../../base-4.16.3.0/src/Data-Maybe.html#mapMaybe"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">Unlinked -&gt; Maybe CompiledByteCode
</span><a href="#local-6989586621681206712"><span class="hs-identifier hs-var">onlyBCOs</span></a></span><span> </span><span class="annot"><span class="annottext">forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable -&gt; [Unlinked]
</span><a href="GHC.Linker.Types.html#linkableUnlinked"><span class="hs-identifier hs-var">linkableUnlinked</span></a></span><span> </span><span class="annot"><span class="annottext">Linkable
</span><a href="#local-6989586621681206716"><span class="hs-identifier hs-var">linkable</span></a></span><span>
</span><span id="line-747"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a -&gt; a
</span><a href="../../base-4.16.3.0/src/Data-Maybe.html#fromMaybe"><span class="hs-identifier hs-var">fromMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">ModBreaks
</span><a href="GHC.ByteCode.Types.html#emptyModBreaks"><span class="hs-identifier hs-var">emptyModBreaks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompiledByteCode -&gt; Maybe ModBreaks
</span><a href="GHC.ByteCode.Types.html#bc_breaks"><span class="hs-identifier hs-var">bc_breaks</span></a></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621681206714"><span class="hs-identifier hs-var">cbc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../../base-4.16.3.0/src/GHC-Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-749"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModBreaks
</span><a href="GHC.ByteCode.Types.html#emptyModBreaks"><span class="hs-identifier hs-var">emptyModBreaks</span></a></span><span> </span><span class="hs-comment">-- probably object code</span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-751"></span><span>    </span><span class="hs-comment">-- The linkable may have 'DotO's as well; only consider BCOs. See #20570.</span><span>
</span><span id="line-752"></span><span>    </span><span class="annot"><a href="#local-6989586621681206712"><span class="hs-identifier hs-type">onlyBCOs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Linker.Types.html#Unlinked"><span class="hs-identifier hs-type">Unlinked</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="GHC.ByteCode.Types.html#CompiledByteCode"><span class="hs-identifier hs-type">CompiledByteCode</span></a></span><span>
</span><span id="line-753"></span><span>    </span><span id="local-6989586621681206712"><span class="annot"><span class="annottext">onlyBCOs :: Unlinked -&gt; Maybe CompiledByteCode
</span><a href="#local-6989586621681206712"><span class="hs-identifier hs-var hs-var">onlyBCOs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="GHC.Linker.Types.html#BCOs"><span class="hs-identifier hs-type">BCOs</span></a></span><span> </span><span id="local-6989586621681206707"><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621681206707"><span class="hs-identifier hs-var">cbc</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SptEntry]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. a -&gt; Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CompiledByteCode
</span><a href="#local-6989586621681206707"><span class="hs-identifier hs-var">cbc</span></a></span><span>
</span><span id="line-754"></span><span>    </span><span class="annot"><a href="#local-6989586621681206712"><span class="hs-identifier hs-var">onlyBCOs</span></a></span><span> </span><span class="annot"><span class="annottext">Unlinked
</span><span class="hs-identifier">_</span></span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. Maybe a
</span><a href="../../base-4.16.3.0/src/GHC-Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-755"></span><span>
</span><span id="line-756"></span><span class="hs-comment">-- | Interpreter uses Profiling way</span><span>
</span><span id="line-757"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpreterProfiled"><span class="hs-identifier hs-type">interpreterProfiled</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-758"></span><span id="interpreterProfiled"><span class="annot"><span class="annottext">interpreterProfiled :: Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterProfiled"><span class="hs-identifier hs-var hs-var">interpreterProfiled</span></a></span></span><span> </span><span id="local-6989586621681206706"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206706"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206706"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>  </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Platform.Ways.html#hostIsProfiled"><span class="hs-identifier hs-var">hostIsProfiled</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span id="local-6989586621681206704"><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206704"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">IServ
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IServConfig -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.Types.html#iservConfProfiled"><span class="hs-identifier hs-var">iservConfProfiled</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206704"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-763"></span><span>
</span><span id="line-764"></span><span class="hs-comment">-- | Interpreter uses Dynamic way</span><span>
</span><span id="line-765"></span><span class="annot"><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-type">interpreterDynamic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#Interp"><span class="hs-identifier hs-type">Interp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-766"></span><span id="interpreterDynamic"><span class="annot"><span class="annottext">interpreterDynamic :: Interp -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.html#interpreterDynamic"><span class="hs-identifier hs-var hs-var">interpreterDynamic</span></a></span></span><span> </span><span id="local-6989586621681206702"><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206702"><span class="hs-identifier hs-var">interp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Interp -&gt; InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#interpInstance"><span class="hs-identifier hs-var">interpInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Interp
</span><a href="#local-6989586621681206702"><span class="hs-identifier hs-var">interp</span></a></span><span> </span><span class="hs-keyword">of</span><span class="hs-cpp">
#if defined(HAVE_INTERNAL_INTERPRETER)
</span><span>  </span><span class="annot"><span class="annottext">InterpInstance
</span><a href="GHC.Runtime.Interpreter.Types.html#InternalInterp"><span class="hs-identifier hs-var">InternalInterp</span></a></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="GHC.Platform.Ways.html#hostIsDynamic"><span class="hs-identifier hs-var">hostIsDynamic</span></a></span><span class="hs-cpp">
#endif
</span><span>  </span><span class="annot"><a href="GHC.Runtime.Interpreter.Types.html#ExternalInterp"><span class="hs-identifier hs-type">ExternalInterp</span></a></span><span> </span><span id="local-6989586621681206700"><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206700"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">IServ
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IServConfig -&gt; Bool
</span><a href="GHC.Runtime.Interpreter.Types.html#iservConfDynamic"><span class="hs-identifier hs-var">iservConfDynamic</span></a></span><span> </span><span class="annot"><span class="annottext">IServConfig
</span><a href="#local-6989586621681206700"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-771"></span></pre></body></html>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>System/Console/Haskeline/Backend/Posix/Encoder.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{- | This module provides a wrapper for I/O encoding for the "old" and "new" ways.
<a name="line-2"></a>The "old" way uses iconv+utf8-string.
<a name="line-3"></a>The "new" way uses the base library's built-in encoding functionality.
<a name="line-4"></a>For the "new" way, we require ghc&gt;=7.4.1 due to GHC bug #5436.
<a name="line-5"></a>
<a name="line-6"></a>This module exports opaque Encoder/Decoder datatypes, along with several helper
<a name="line-7"></a>functions that wrap the old/new ways.
<a name="line-8"></a>-}</span>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>System.Console.Haskeline.Backend.Posix.Encoder</span> <span class='hs-layout'>(</span>
<a name="line-10"></a>        <span class='hs-conid'>ExternalHandle</span><span class='hs-layout'>(</span><span class='hs-varid'>eH</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-11"></a>        <span class='hs-varid'>externalHandle</span><span class='hs-layout'>,</span>
<a name="line-12"></a>        <span class='hs-varid'>withCodingMode</span><span class='hs-layout'>,</span>
<a name="line-13"></a>        <span class='hs-varid'>openInCodingMode</span><span class='hs-layout'>,</span>
<a name="line-14"></a>        <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.Monad.Catch</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadMask</span><span class='hs-layout'>,</span> <span class='hs-varid'>bracket</span><span class='hs-layout'>)</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.IO</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Console.Haskeline.Monads</span>
<a name="line-19"></a>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>GHC.IO.Encoding</span> <span class='hs-layout'>(</span><span class='hs-varid'>initLocaleEncoding</span><span class='hs-layout'>)</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System.Console.Haskeline.Recover</span>
<a name="line-22"></a>
<a name="line-23"></a>
<a name="line-24"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- | An 'ExternalHandle' is a handle which may or may not be in the correct</span>
<a name="line-25"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- mode for Unicode input/output.  When the POSIX backend opens a file</span>
<a name="line-26"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- (or /dev/tty) it sets it permanently to the correct mode.</span>
<a name="line-27"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- However, when it uses an existing handle like stdin, it only temporarily</span>
<a name="line-28"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- sets it to the correct mode (e.g., for the duration of getInputLine);</span>
<a name="line-29"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- otherwise, we might interfere with the rest of the Haskell program.</span>
<a name="line-30"></a><a name="ExternalHandle"></a><span class='hs-comment'>--</span>
<a name="line-31"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- The correct mode is the locale encoding, set to transliterate errors (rather</span>
<a name="line-32"></a><a name="ExternalHandle"></a><span class='hs-comment'>-- than crashing, as is the base library's default).  See Recover.hs.</span>
<a name="line-33"></a><a name="ExternalHandle"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExternalHandle</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExternalHandle</span>
<a name="line-34"></a>                        <span class='hs-layout'>{</span> <span class='hs-varid'>externalMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExternalMode</span>
<a name="line-35"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>eH</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span>
<a name="line-36"></a>                        <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="ExternalMode"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ExternalMode</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CodingMode</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>OtherMode</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="externalHandle"></a><span class='hs-definition'>externalHandle</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ExternalHandle</span>
<a name="line-41"></a><span class='hs-definition'>externalHandle</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ExternalHandle</span> <span class='hs-conid'>OtherMode</span>
<a name="line-42"></a>
<a name="line-43"></a><a name="withCodingMode"></a><span class='hs-comment'>-- | Use to ensure that an external handle is in the correct mode</span>
<a name="line-44"></a><span class='hs-comment'>-- for the duration of the given action.</span>
<a name="line-45"></a><span class='hs-definition'>withCodingMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadIO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadMask</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>ExternalHandle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-46"></a><span class='hs-definition'>withCodingMode</span> <span class='hs-conid'>ExternalHandle</span> <span class='hs-layout'>{</span><span class='hs-varid'>externalMode</span><span class='hs-keyglyph'>=</span><span class='hs-conid'>CodingMode</span><span class='hs-layout'>}</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span>
<a name="line-47"></a><span class='hs-definition'>withCodingMode</span> <span class='hs-layout'>(</span><span class='hs-conid'>ExternalHandle</span> <span class='hs-conid'>OtherMode</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-48"></a>    <span class='hs-varid'>bracket</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hGetEncoding</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-49"></a>            <span class='hs-layout'>(</span><span class='hs-varid'>liftIO</span> <span class='hs-varop'>.</span> <span class='hs-varid'>hSetBinOrEncoding</span> <span class='hs-varid'>h</span><span class='hs-layout'>)</span>
<a name="line-50"></a>            <span class='hs-varop'>$</span> <span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-51"></a>                <span class='hs-varid'>liftIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hSetEncoding</span> <span class='hs-varid'>h</span> <span class='hs-varid'>haskelineEncoding</span>
<a name="line-52"></a>                <span class='hs-varid'>act</span>
<a name="line-53"></a>
<a name="line-54"></a><a name="hSetBinOrEncoding"></a><span class='hs-definition'>hSetBinOrEncoding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TextEncoding</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-55"></a><span class='hs-definition'>hSetBinOrEncoding</span> <span class='hs-varid'>h</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hSetBinaryMode</span> <span class='hs-varid'>h</span> <span class='hs-conid'>True</span>
<a name="line-56"></a><span class='hs-definition'>hSetBinOrEncoding</span> <span class='hs-varid'>h</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>enc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hSetEncoding</span> <span class='hs-varid'>h</span> <span class='hs-varid'>enc</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="haskelineEncoding"></a><span class='hs-definition'>haskelineEncoding</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TextEncoding</span>
<a name="line-59"></a><span class='hs-definition'>haskelineEncoding</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>transliterateFailure</span> <span class='hs-varid'>initLocaleEncoding</span>
<a name="line-60"></a>
<a name="line-61"></a><a name="openInCodingMode"></a><span class='hs-comment'>-- Open a file and permanently set it to the correct mode.</span>
<a name="line-62"></a><span class='hs-definition'>openInCodingMode</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IOMode</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>ExternalHandle</span>
<a name="line-63"></a><span class='hs-definition'>openInCodingMode</span> <span class='hs-varid'>path</span> <span class='hs-varid'>iomode</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-64"></a>    <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openFile</span> <span class='hs-varid'>path</span> <span class='hs-varid'>iomode</span>
<a name="line-65"></a>    <span class='hs-varid'>hSetEncoding</span> <span class='hs-varid'>h</span> <span class='hs-varid'>haskelineEncoding</span>
<a name="line-66"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>ExternalHandle</span> <span class='hs-conid'>CodingMode</span> <span class='hs-varid'>h</span>
<a name="line-67"></a>
<a name="line-68"></a>
<a name="line-69"></a>
</pre></body>
</html>

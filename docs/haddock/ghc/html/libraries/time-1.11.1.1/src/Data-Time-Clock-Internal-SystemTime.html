<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>lib/Data/Time/Clock/Internal/SystemTime.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-cpp'>#</span><span class='hs-varid'>include</span> <span class='hs-str'>"HsTimeConfig.h"</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-cpp'>#if defined(mingw32_HOST_OS) || !defined(HAVE_CLOCK_GETTIME)</span>
<a name="line-4"></a><span class='hs-comment'>{-# LANGUAGE Safe #-}</span>
<a name="line-5"></a><span class='hs-cpp'>#else</span>
<a name="line-6"></a><span class='hs-comment'>{-# LANGUAGE Trustworthy #-}</span>
<a name="line-7"></a><span class='hs-cpp'>#endif</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Data.Time.Clock.Internal.SystemTime</span>
<a name="line-10"></a>    <span class='hs-layout'>(</span> <span class='hs-conid'>SystemTime</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-11"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>getSystemTime</span>
<a name="line-12"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>getTime_resolution</span>
<a name="line-13"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>getTAISystemTime</span>
<a name="line-14"></a>    <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-15"></a>
<a name="line-16"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Data</span>
<a name="line-17"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control.DeepSeq</span>
<a name="line-18"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Int</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int64</span><span class='hs-layout'>)</span>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Time.Clock.Internal.DiffTime</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Word</span>
<a name="line-21"></a>
<a name="line-22"></a><span class='hs-cpp'>#ifdef mingw32_HOST_OS</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>System.Win32.Time</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Win32</span>
<a name="line-24"></a><span class='hs-cpp'>#elif defined(HAVE_CLOCK_GETTIME)</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Time.Clock.Internal.CTimespec</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C.Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>CLong</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>CTime</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-cpp'>#else</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data.Time.Clock.Internal.CTimeval</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Foreign.C.Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>CLong</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-30"></a><span class='hs-cpp'>#endif</span>
<a name="line-31"></a><span class='hs-comment'>--------------------------------------------------------------------------------</span>
<a name="line-32"></a>
<a name="line-33"></a><a name="SystemTime"></a><span class='hs-comment'>-- | 'SystemTime' is time returned by system clock functions.</span>
<a name="line-34"></a><a name="SystemTime"></a><span class='hs-comment'>-- Its semantics depends on the clock function, but the epoch is typically the beginning of 1970.</span>
<a name="line-35"></a><a name="SystemTime"></a><span class='hs-comment'>-- Note that 'systemNanoseconds' of 1E9 to 2E9-1 can be used to represent leap seconds.</span>
<a name="line-36"></a><a name="SystemTime"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>SystemTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MkSystemTime</span>
<a name="line-37"></a>    <span class='hs-layout'>{</span> <span class='hs-varid'>systemSeconds</span> <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span><span class='hs-varop'>!</span><span class='hs-conid'>Int64</span>
<a name="line-38"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>systemNanoseconds</span> <span class='hs-keyglyph'>::</span> <span class='hs-comment'>{-# UNPACK #-}</span><span class='hs-varop'>!</span><span class='hs-conid'>Word32</span>
<a name="line-39"></a>    <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Eq</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ord</span><span class='hs-layout'>,</span> <span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Data</span><span class='hs-layout'>,</span> <span class='hs-conid'>Typeable</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a><a name="instance%20NFData%20SystemTime"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>NFData</span> <span class='hs-conid'>SystemTime</span> <span class='hs-keyword'>where</span>
<a name="line-42"></a>    <span class='hs-varid'>rnf</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`seq`</span> <span class='hs-conid'>()</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="getSystemTime"></a><span class='hs-comment'>-- | Get the system time, epoch start of 1970 UTC, leap-seconds ignored.</span>
<a name="line-45"></a><span class='hs-comment'>-- 'getSystemTime' is typically much faster than 'getCurrentTime'.</span>
<a name="line-46"></a><span class='hs-definition'>getSystemTime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>SystemTime</span>
<a name="line-47"></a><a name="getTime_resolution"></a><span class='hs-comment'>-- | The resolution of 'getSystemTime', 'getCurrentTime', 'getPOSIXTime'.</span>
<a name="line-48"></a><span class='hs-comment'>-- On UNIX systems this uses @clock_getres@, which may be &lt;https://github.com/microsoft/WSL/issues/6029 wrong on WSL2&gt;.</span>
<a name="line-49"></a><span class='hs-definition'>getTime_resolution</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DiffTime</span>
<a name="line-50"></a><a name="getTAISystemTime"></a><span class='hs-comment'>-- | If supported, get TAI time, epoch start of 1970 TAI, with resolution.</span>
<a name="line-51"></a><span class='hs-comment'>-- This is supported only on UNIX systems, and only those with CLOCK_TAI available at run-time.</span>
<a name="line-52"></a><span class='hs-definition'>getTAISystemTime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>DiffTime</span><span class='hs-layout'>,</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>SystemTime</span><span class='hs-layout'>)</span>
<a name="line-53"></a><span class='hs-cpp'>#ifdef mingw32_HOST_OS</span>
<a name="line-54"></a><span class='hs-comment'>-- On Windows, the equlvalent of POSIX time is "file time", defined as</span>
<a name="line-55"></a><span class='hs-comment'>-- the number of 100-nanosecond intervals that have elapsed since</span>
<a name="line-56"></a><span class='hs-comment'>-- 12:00 A.M. January 1, 1601 (UTC).  We can convert this into a POSIX</span>
<a name="line-57"></a><span class='hs-comment'>-- time by adjusting the offset to be relative to the POSIX epoch.</span>
<a name="line-58"></a><span class='hs-definition'>getSystemTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-59"></a>    <span class='hs-conid'>Win32.FILETIME</span> <span class='hs-varid'>ft</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>Win32.getSystemTimeAsFileTime</span>
<a name="line-60"></a>    <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>ft</span> <span class='hs-comment'>-</span> <span class='hs-varid'>win32_epoch_adjust</span><span class='hs-layout'>)</span> <span class='hs-varop'>`divMod`</span> <span class='hs-num'>10000000</span>
<a name="line-61"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkSystemTime</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>us</span> <span class='hs-varop'>*</span> <span class='hs-num'>100</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-62"></a>  <span class='hs-keyword'>where</span>
<a name="line-63"></a>    <span class='hs-varid'>win32_epoch_adjust</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word64</span>
<a name="line-64"></a>    <span class='hs-varid'>win32_epoch_adjust</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>116444736000000000</span>
<a name="line-65"></a>
<a name="line-66"></a><span class='hs-definition'>getTime_resolution</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>100E-9</span> <span class='hs-comment'>-- 100ns</span>
<a name="line-67"></a>
<a name="line-68"></a><span class='hs-definition'>getTAISystemTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-69"></a><span class='hs-cpp'>#elif defined(HAVE_CLOCK_GETTIME)</span>
<a name="line-70"></a><a name="timespecToSystemTime"></a><span class='hs-comment'>-- Use hi-res clock_gettime</span>
<a name="line-71"></a><span class='hs-definition'>timespecToSystemTime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CTimespec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SystemTime</span>
<a name="line-72"></a><span class='hs-definition'>timespecToSystemTime</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkCTimespec</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTime</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CLong</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkSystemTime</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-73"></a>
<a name="line-74"></a><a name="timespecToDiffTime"></a><span class='hs-definition'>timespecToDiffTime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CTimespec</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DiffTime</span>
<a name="line-75"></a><span class='hs-definition'>timespecToDiffTime</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkCTimespec</span> <span class='hs-layout'>(</span><span class='hs-conid'>CTime</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span> <span class='hs-varop'>*</span> <span class='hs-num'>1E-9</span>
<a name="line-76"></a>
<a name="line-77"></a><a name="clockGetSystemTime"></a><span class='hs-definition'>clockGetSystemTime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ClockID</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>SystemTime</span>
<a name="line-78"></a><span class='hs-definition'>clockGetSystemTime</span> <span class='hs-varid'>clock</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fmap</span> <span class='hs-varid'>timespecToSystemTime</span> <span class='hs-varop'>$</span> <span class='hs-varid'>clockGetTime</span> <span class='hs-varid'>clock</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-definition'>getSystemTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>clockGetSystemTime</span> <span class='hs-varid'>clock_REALTIME</span>
<a name="line-81"></a>
<a name="line-82"></a><span class='hs-definition'>getTime_resolution</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>timespecToDiffTime</span> <span class='hs-varid'>realtimeRes</span>
<a name="line-83"></a>
<a name="line-84"></a><span class='hs-definition'>getTAISystemTime</span> <span class='hs-keyglyph'>=</span>
<a name="line-85"></a>    <span class='hs-varid'>fmap</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>resolution</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>timespecToDiffTime</span> <span class='hs-varid'>resolution</span><span class='hs-layout'>,</span> <span class='hs-varid'>clockGetSystemTime</span> <span class='hs-varid'>clock_TAI</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>clockResolution</span> <span class='hs-varid'>clock_TAI</span>
<a name="line-86"></a><span class='hs-cpp'>#else</span>
<a name="line-87"></a><span class='hs-comment'>-- Use gettimeofday</span>
<a name="line-88"></a><span class='hs-definition'>getSystemTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-89"></a>    <span class='hs-conid'>MkCTimeval</span> <span class='hs-layout'>(</span><span class='hs-conid'>CLong</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CLong</span> <span class='hs-varid'>us</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCTimeval</span>
<a name="line-90"></a>    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>MkSystemTime</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>us</span> <span class='hs-varop'>*</span> <span class='hs-num'>1000</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-91"></a>
<a name="line-92"></a><span class='hs-definition'>getTime_resolution</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>1E-6</span> <span class='hs-comment'>-- microsecond</span>
<a name="line-93"></a>
<a name="line-94"></a><span class='hs-definition'>getTAISystemTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-95"></a><span class='hs-cpp'>#endif</span>
</pre></body>
</html>

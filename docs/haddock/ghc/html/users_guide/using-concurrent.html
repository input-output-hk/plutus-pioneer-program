

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>5.4. Using Concurrent Haskell &mdash; Glasgow Haskell Compiler 9.2.4 User&#39;s Guide</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML "></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="search" type="application/opensearchdescription+xml"
          title="Search within Glasgow Haskell Compiler 9.2.4 User&#39;s Guide"
          href="_static/opensearch.xml"/>

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5.6. Flag reference" href="flags.html" />
    <link rel="prev" title="5.3. Optimisation (code improvement)" href="using-optimisation.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Glasgow Haskell Compiler
          

          
          </a>

          
            
            
              <div class="version">
                9.2.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-notes.html">2. Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="ghci.html">3. Using GHCi</a></li>
<li class="toctree-l1"><a class="reference internal" href="runghc.html">4. Using runghc</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="usage.html">5. Using GHC</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="using.html">5.1. Using GHC</a></li>
<li class="toctree-l2"><a class="reference internal" href="using-warnings.html">5.2. Warnings and sanity-checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="using-optimisation.html">5.3. Optimisation (code improvement)</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.4. Using Concurrent Haskell</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-smp-parallelism">5.5. Using SMP parallelism</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#compile-time-options-for-smp-parallelism">5.5.1. Compile-time options for SMP parallelism</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rts-options-for-smp-parallelism">5.5.2. RTS options for SMP parallelism</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hints-for-using-smp-parallelism">5.5.3. Hints for using SMP parallelism</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="flags.html">5.6. Flag reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="runtime_control.html">5.7. Running a compiled program</a></li>
<li class="toctree-l2"><a class="reference internal" href="separate_compilation.html">5.8. Filenames and separate compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="packages.html">5.9. Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="codegens.html">5.10. GHC Backends</a></li>
<li class="toctree-l2"><a class="reference internal" href="phases.html">5.11. Options related to a particular phase</a></li>
<li class="toctree-l2"><a class="reference internal" href="shared_libs.html">5.12. Using shared libraries</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">5.13. Debugging the compiler</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="exts.html">6. Language extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="extending_ghc.html">7. Extending and using GHC as a Library</a></li>
<li class="toctree-l1"><a class="reference internal" href="profiling.html">8. Profiling</a></li>
<li class="toctree-l1"><a class="reference internal" href="debug-info.html">9. Debugging compiled programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="gone_wrong.html">10. What to do when something goes wrong</a></li>
<li class="toctree-l1"><a class="reference internal" href="hints.html">11. Hints</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">12. Other Haskell utility programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="win32-dlls.html">13. Running GHC on Win32 systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="bugs.html">14. Known bugs and infelicities</a></li>
<li class="toctree-l1"><a class="reference internal" href="eventlog-formats.html">15. Eventlog encodings</a></li>
<li class="toctree-l1"><a class="reference internal" href="editing-guide.html">16. Care and feeding of your GHC User’s Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Glasgow Haskell Compiler</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="usage.html"><span class="section-number">5. </span>Using GHC</a> &raquo;</li>
        
      <li><span class="section-number">5.4. </span>Using Concurrent Haskell</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/using-concurrent.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="using-concurrent-haskell">
<span id="using-concurrent"></span><h1><span class="section-number">5.4. </span>Using Concurrent Haskell<a class="headerlink" href="#using-concurrent-haskell" title="Permalink to this heading">¶</a></h1>
<p id="index-0">GHC supports Concurrent Haskell by default, without requiring a special
option or libraries compiled in a certain way. To get access to the
support libraries for Concurrent Haskell, just import
<a class="reference external" href="./../libraries/base-4.16.3.0/Control-Concurrent.html">Control.Concurrent</a>. More information on Concurrent Haskell is
provided in the documentation for that module.</p>
<p>Optionally, the program may be linked with the <a class="reference internal" href="phases.html#ghc-flag-threaded"><code class="xref std std-ghc-flag docutils literal notranslate"><span class="pre">-threaded</span></code></a> option (see
<a class="reference internal" href="phases.html#options-linker"><span class="std std-ref">Options affecting linking</span></a>. This provides two benefits:</p>
<ul class="simple">
<li><p>It enables the <a class="reference internal" href="#rts-flag-N-x"><code class="xref std std-rts-flag docutils literal notranslate"><span class="pre">-N</span> <span class="pre">⟨x⟩</span></code></a> to be used, which allows threads to run in
parallel on a multi-processor or multi-core machine. See <a class="reference internal" href="#using-smp"><span class="std std-ref">Using SMP parallelism</span></a>.</p></li>
<li><p>If a thread makes a foreign call (and the call is not marked
<code class="docutils literal notranslate"><span class="pre">unsafe</span></code>), then other Haskell threads in the program will continue
to run while the foreign call is in progress. Additionally,
<code class="docutils literal notranslate"><span class="pre">foreign</span> <span class="pre">export</span></code>ed Haskell functions may be called from multiple
OS threads simultaneously. See <a class="reference internal" href="exts/ffi.html#ffi-threads"><span class="std std-ref">Multi-threading and the FFI</span></a>.</p></li>
</ul>
<p>The following RTS option(s) affect the behaviour of Concurrent Haskell
programs:</p>
<span class="target" id="index-1"></span><dl class="std rts-flag">
<dt class="sig sig-object std" id="rts-flag-C-s">
<span class="sig-name descname"><span class="pre">-C</span></span><span class="sig-prename descclassname"> <span class="pre">⟨s⟩</span></span><a class="headerlink" href="#rts-flag-C-s" title="Permalink to this definition">¶</a></dt>
<dd><dl class="field-list simple">
<dt class="field-odd">Default<span class="colon">:</span></dt>
<dd class="field-odd"><p>20 milliseconds</p>
</dd>
</dl>
<p>Sets the context switch interval to ⟨s⟩ seconds.
A context switch will occur at the next heap block allocation after
the timer expires (a heap block allocation occurs every 4k of
allocation). With <code class="docutils literal notranslate"><span class="pre">-C0</span></code> or <code class="docutils literal notranslate"><span class="pre">-C</span></code>, context switches will occur as
often as possible (at every heap block allocation).</p>
</dd></dl>

</section>
<section id="using-smp-parallelism">
<span id="using-smp"></span><h1><span class="section-number">5.5. </span>Using SMP parallelism<a class="headerlink" href="#using-smp-parallelism" title="Permalink to this heading">¶</a></h1>
<p id="index-2">GHC supports running Haskell programs in parallel on an SMP (symmetric
multiprocessor).</p>
<p>There’s a fine distinction between <em>concurrency</em> and <em>parallelism</em>:
parallelism is all about making your program run <em>faster</em> by making use
of multiple processors simultaneously. Concurrency, on the other hand,
is a means of abstraction: it is a convenient way to structure a program
that must respond to multiple asynchronous events.</p>
<p>However, the two terms are certainly related. By making use of multiple
CPUs it is possible to run concurrent threads in parallel, and this is
exactly what GHC’s SMP parallelism support does. But it is also possible
to obtain performance improvements with parallelism on programs that do
not use concurrency. This section describes how to use GHC to compile
and run parallel programs, in <a class="reference internal" href="exts/parallel.html#lang-parallel"><span class="std std-ref">Parallel and Concurrent</span></a> we describe the
language features that affect parallelism.</p>
<section id="compile-time-options-for-smp-parallelism">
<span id="parallel-compile-options"></span><h2><span class="section-number">5.5.1. </span>Compile-time options for SMP parallelism<a class="headerlink" href="#compile-time-options-for-smp-parallelism" title="Permalink to this heading">¶</a></h2>
<p>In order to make use of multiple CPUs, your program must be linked with
the <a class="reference internal" href="phases.html#ghc-flag-threaded"><code class="xref std std-ghc-flag docutils literal notranslate"><span class="pre">-threaded</span></code></a> option (see <a class="reference internal" href="phases.html#options-linker"><span class="std std-ref">Options affecting linking</span></a>). Additionally, the
following compiler options affect parallelism:</p>
<dl class="std ghc-flag">
<dt class="sig sig-object std">
<span class="sig-name descname"><span class="pre">-feager-blackholing</span></span></dt>
<dd><p>Blackholing is the act of marking a thunk (lazy computation) as
being under evaluation. It is useful for three reasons: firstly it
lets us detect certain kinds of infinite loop (the
<code class="docutils literal notranslate"><span class="pre">NonTermination</span></code> exception), secondly it avoids certain kinds of
space leak, and thirdly it avoids repeating a computation in a
parallel program, because we can tell when a computation is already
in progress.</p>
<p>The option <a class="reference internal" href="using-optimisation.html#ghc-flag-feager-blackholing"><code class="xref std std-ghc-flag docutils literal notranslate"><span class="pre">-feager-blackholing</span></code></a> causes each thunk to be
blackholed as soon as evaluation begins. The default is “lazy
blackholing”, whereby thunks are only marked as being under
evaluation when a thread is paused for some reason. Lazy blackholing
is typically more efficient (by 1-2% or so), because most thunks
don’t need to be blackholed. However, eager blackholing can avoid
more repeated computation in a parallel program, and this often
turns out to be important for parallelism.</p>
<p>We recommend compiling any code that is intended to be run in
parallel with the <a class="reference internal" href="using-optimisation.html#ghc-flag-feager-blackholing"><code class="xref std std-ghc-flag docutils literal notranslate"><span class="pre">-feager-blackholing</span></code></a> flag.</p>
</dd></dl>

</section>
<section id="rts-options-for-smp-parallelism">
<span id="parallel-options"></span><h2><span class="section-number">5.5.2. </span>RTS options for SMP parallelism<a class="headerlink" href="#rts-options-for-smp-parallelism" title="Permalink to this heading">¶</a></h2>
<p>There are two ways to run a program on multiple processors: call
<a class="reference external" href="./../libraries/base-4.16.3.0/Control-Concurrent.html#v:setNumCapabilities">Control.Concurrent.setNumCapabilities</a> from your program, or
use the RTS <a class="reference internal" href="#rts-flag-N-x"><code class="xref std std-rts-flag docutils literal notranslate"><span class="pre">-N</span> <span class="pre">⟨x⟩</span></code></a> options.</p>
<dl class="std rts-flag">
<dt class="sig sig-object std" id="rts-flag-N-x">
<span class="sig-name descname"><span class="pre">-N</span></span><span class="sig-prename descclassname"> <span class="pre">⟨x⟩</span></span><a class="headerlink" href="#rts-flag-N-x" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object std" id="rts-flag-N">
<span class="sig-name descname"><span class="pre">-N</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="#rts-flag-N" title="Permalink to this definition">¶</a></dt>
<dt class="sig sig-object std" id="rts-flag-maxN-x">
<span class="sig-name descname"><span class="pre">-maxN</span></span><span class="sig-prename descclassname"> <span class="pre">⟨x⟩</span></span><a class="headerlink" href="#rts-flag-maxN-x" title="Permalink to this definition">¶</a></dt>
<dd><p>Use ⟨x⟩ simultaneous threads when running the program.</p>
<p>The runtime manages a set of virtual processors, which we call
<em>capabilities</em>, the number of which is determined by the <code class="docutils literal notranslate"><span class="pre">-N</span></code>
option. Each capability can run one Haskell thread at a time, so the
number of capabilities is equal to the number of Haskell threads
that can run physically in parallel. A capability is animated by one
or more OS threads; the runtime manages a pool of OS threads for
each capability, so that if a Haskell thread makes a foreign call
(see <a class="reference internal" href="exts/ffi.html#ffi-threads"><span class="std std-ref">Multi-threading and the FFI</span></a>) another OS thread can take over that
capability.</p>
<p>Normally ⟨x⟩ should be chosen to match the number of CPU cores on
the machine <a class="footnote-reference brackets" href="#id2" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>. For example, on a dual-core machine we would
probably use <code class="docutils literal notranslate"><span class="pre">+RTS</span> <span class="pre">-N2</span> <span class="pre">-RTS</span></code>.</p>
<p>Omitting ⟨x⟩, i.e. <code class="docutils literal notranslate"><span class="pre">+RTS</span> <span class="pre">-N</span> <span class="pre">-RTS</span></code>, lets the runtime choose the
value of ⟨x⟩ itself based on how many processors are in your
machine.</p>
<p>Omitting <code class="docutils literal notranslate"><span class="pre">-N⟨x⟩</span></code> entirely means <code class="docutils literal notranslate"><span class="pre">-N1</span></code>.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">-maxN⟨x⟩</span></code>, i.e. <code class="docutils literal notranslate"><span class="pre">+RTS</span> <span class="pre">-maxN3</span> <span class="pre">-RTS</span></code>, the runtime will choose
at most (x), also limited by the number of processors on the system.
Omitting (x) is an error, if you need a default use option <code class="docutils literal notranslate"><span class="pre">-N</span></code>.</p>
<p>Be careful when using all the processors in your machine: if some of
your processors are in use by other programs, this can actually harm
performance rather than improve it. Asking GHC to create more capabilities
than you have physical threads is almost always a bad idea.</p>
<p>Setting <code class="docutils literal notranslate"><span class="pre">-N</span></code> also has the effect of enabling the parallel garbage
collector (see <a class="reference internal" href="runtime_control.html#rts-options-gc"><span class="std std-ref">RTS options to control the garbage collector</span></a>).</p>
<p>The current value of the <code class="docutils literal notranslate"><span class="pre">-N</span></code> option is available to the Haskell
program via <code class="docutils literal notranslate"><span class="pre">Control.Concurrent.getNumCapabilities</span></code>, and it may be
changed while the program is running by calling
<code class="docutils literal notranslate"><span class="pre">Control.Concurrent.setNumCapabilities</span></code>.</p>
</dd></dl>

<p>The following options affect the way the runtime schedules threads on
CPUs:</p>
<dl class="std rts-flag">
<dt class="sig sig-object std" id="rts-flag-qa">
<span class="sig-name descname"><span class="pre">-qa</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="#rts-flag-qa" title="Permalink to this definition">¶</a></dt>
<dd><p>Use the OS’s affinity facilities to try to pin OS threads to CPU
cores.</p>
<p>When this option is enabled, the OS threads for a capability <span class="math notranslate nohighlight">\(i\)</span> are
bound to the CPU core <span class="math notranslate nohighlight">\(i\)</span> using the API provided by the OS for setting
thread affinity. e.g. on Linux GHC uses <code class="docutils literal notranslate"><span class="pre">sched_setaffinity()</span></code>.</p>
<p>Depending on your workload and the other activity on the machine,
this may or may not result in a performance improvement. We
recommend trying it out and measuring the difference.</p>
</dd></dl>

<dl class="std rts-flag">
<dt class="sig sig-object std" id="rts-flag-qm">
<span class="sig-name descname"><span class="pre">-qm</span></span><span class="sig-prename descclassname"></span><a class="headerlink" href="#rts-flag-qm" title="Permalink to this definition">¶</a></dt>
<dd><p>Disable automatic migration for load balancing. Normally the runtime
will automatically try to schedule threads across the available CPUs
to make use of idle CPUs; this option disables that behaviour. Note
that migration only applies to threads; sparks created by <code class="docutils literal notranslate"><span class="pre">par</span></code>
are load-balanced separately by work-stealing.</p>
<p>This option is probably only of use for concurrent programs that
explicitly schedule threads onto CPUs with
<a class="reference external" href="./../libraries/base-4.16.3.0/Control-Concurrent.html#v:forkOn">Control.Concurrent.forkOn</a>.</p>
</dd></dl>

</section>
<section id="hints-for-using-smp-parallelism">
<h2><span class="section-number">5.5.3. </span>Hints for using SMP parallelism<a class="headerlink" href="#hints-for-using-smp-parallelism" title="Permalink to this heading">¶</a></h2>
<p>Add the <a class="reference internal" href="runtime_control.html#rts-flag-s-file"><code class="xref std std-rts-flag docutils literal notranslate"><span class="pre">-s</span> <span class="pre">[⟨file⟩]</span></code></a> RTS option when running the program to see
timing stats, which will help to tell you whether your program got faster by
using more CPUs or not. If the user time is greater than the elapsed time, then
the program used more than one CPU. You should also run the program without
<a class="reference internal" href="#rts-flag-N-x"><code class="xref std std-rts-flag docutils literal notranslate"><span class="pre">-N</span> <span class="pre">⟨x⟩</span></code></a> for comparison.</p>
<p>The output of <code class="docutils literal notranslate"><span class="pre">+RTS</span> <span class="pre">-s</span></code> tells you how many “sparks” were created and
executed during the run of the program (see <a class="reference internal" href="runtime_control.html#rts-options-gc"><span class="std std-ref">RTS options to control the garbage collector</span></a>),
which will give you an idea how well your <code class="docutils literal notranslate"><span class="pre">par</span></code> annotations are
working.</p>
<p>GHC’s parallelism support has improved in 6.12.1 as a result of much
experimentation and tuning in the runtime system. We’d still be
interested to hear how well it works for you, and we’re also interested
in collecting parallel programs to add to our benchmarking suite.</p>
<aside class="footnote-list brackets">
<aside class="footnote brackets" id="id2" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Whether hyperthreading cores should be counted or not is an open
question; please feel free to experiment and let us know what results you
find.</p>
</aside>
</aside>
</section>
</section>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="flags.html" class="btn btn-neutral float-right" title="5.6. Flag reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="using-optimisation.html" class="btn btn-neutral float-left" title="5.3. Optimisation (code improvement)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2022, GHC Team

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>
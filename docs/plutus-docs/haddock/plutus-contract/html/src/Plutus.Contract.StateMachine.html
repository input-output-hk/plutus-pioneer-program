<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds              #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass         #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric          #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies     #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts       #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE FunctionalDependencies #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase             #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE MonoLocalBinds         #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns         #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings      #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell        #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications       #-}</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Plutus.Contract.StateMachine</span><span class="hs-special">(</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- $statemachine</span></span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier">StateMachineClient</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">TxConstraints</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#SMContractError"><span class="hs-identifier">SMContractError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier">AsSMContractError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier">SM.StateMachine</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier">SM.StateMachineInstance</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier">SM.State</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier">OnChainState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#WaitingResult"><span class="hs-identifier">WaitingResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#InvalidTransition"><span class="hs-identifier">InvalidTransition</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionResult"><span class="hs-identifier">TransitionResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html#ThreadToken"><span class="hs-identifier">ThreadToken</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Constructing the machine instance</span></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#mkValidator"><span class="hs-identifier">SM.mkValidator</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#mkStateMachine"><span class="hs-identifier">SM.mkStateMachine</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Constructing the state machine client</span></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#mkStateMachineClient"><span class="hs-identifier">mkStateMachineClient</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#defaultChooser"><span class="hs-identifier">defaultChooser</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#getStates"><span class="hs-identifier">getStates</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Running the state machine</span></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runGuardedStep"><span class="hs-identifier">runGuardedStep</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runStep"><span class="hs-identifier">runStep</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runInitialise"><span class="hs-identifier">runInitialise</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runGuardedStepWith"><span class="hs-identifier">runGuardedStepWith</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runStepWith"><span class="hs-identifier">runStepWith</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runInitialiseWith"><span class="hs-identifier">runInitialiseWith</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#getThreadToken"><span class="hs-identifier">getThreadToken</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#getOnChainState"><span class="hs-identifier">getOnChainState</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#getStateData"><span class="hs-identifier">getStateData</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdate"><span class="hs-identifier">waitForUpdate</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdateUntilSlot"><span class="hs-identifier">waitForUpdateUntilSlot</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdateUntilTime"><span class="hs-identifier">waitForUpdateUntilTime</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdateTimeout"><span class="hs-identifier">waitForUpdateTimeout</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Lower-level API</span></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineTransition"><span class="hs-identifier">StateMachineTransition</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#mkStep"><span class="hs-identifier">mkStep</span></a></span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Re-exports</span></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Void</span></a></span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">_2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">makeClassyPrisms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">review</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator">(^?)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">unless</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Monad.Error.Lens</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">FromJSON</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">ToJSON</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">listToMaybe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">mapMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier">Text</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">absurd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">POSIXTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">TxOutRef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">ScriptLookups</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">TxConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">txOwnInputs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">txOwnOutputs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">UnbalancedTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>                           </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">mustMintValueWithRedeemer</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">mustPayToTheScriptWithDatumInTx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">mustSpendOutputFromTheScript</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>                           </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">mustSpendPubKeyOutput</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">plutusV1MintingPolicy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints.OffChain</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Constraints</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Tx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tx</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Typed.Scripts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Scripts</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Value</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Value</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">Plutus.ChainIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">ChainIndexTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">_citxInputs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">_citxRedeemers</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.html"><span class="hs-identifier">Plutus.Contract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.Error.html#AsContractError"><span class="hs-identifier">AsContractError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.Error.html#_ContractError"><span class="hs-identifier">_ContractError</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier">Contract</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Error.html#ContractError"><span class="hs-identifier">ContractError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Promise"><span class="hs-identifier">Promise</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#adjustUnbalancedTx"><span class="hs-identifier">adjustUnbalancedTx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>                        </span><span class="annot"><a href="Plutus.Contract.Types.html#awaitPromise"><span class="hs-identifier">awaitPromise</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#isSlot"><span class="hs-identifier">isSlot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#isTime"><span class="hs-identifier">isTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Logging.html#logWarn"><span class="hs-identifier">logWarn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#mapError"><span class="hs-identifier">mapError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#never"><span class="hs-identifier">never</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#ownFirstPaymentPubKeyHash"><span class="hs-identifier">ownFirstPaymentPubKeyHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#ownUtxos"><span class="hs-identifier">ownUtxos</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>                        </span><span class="annot"><a href="Plutus.Contract.Types.html#promiseBind"><span class="hs-identifier">promiseBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#select"><span class="hs-identifier">select</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#submitTxConfirmed"><span class="hs-identifier">submitTxConfirmed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#utxoIsProduced"><span class="hs-identifier">utxoIsProduced</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#utxoIsSpent"><span class="hs-identifier">utxoIsSpent</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html#utxosAt"><span class="hs-identifier">utxosAt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>                        </span><span class="annot"><a href="Plutus.Contract.Request.html#utxosTxOutTxFromTx"><span class="hs-identifier">utxosTxOutTxFromTx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.Request.html"><span class="hs-identifier">Plutus.Contract.Request</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.Request.html#mkTxConstraints"><span class="hs-identifier">mkTxConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.MintingPolarity.html"><span class="hs-identifier">Plutus.Contract.StateMachine.MintingPolarity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.MintingPolarity.html#MintingPolarity"><span class="hs-identifier">MintingPolarity</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.MintingPolarity.html#Burn"><span class="hs-identifier">Burn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.MintingPolarity.html#Mint"><span class="hs-identifier">Mint</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html"><span class="hs-identifier">Plutus.Contract.StateMachine.OnChain</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier">State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier">State</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#stateData"><span class="hs-identifier">stateData</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#stateValue"><span class="hs-identifier">stateValue</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>                                             </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier">StateMachine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier">StateMachine</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#smFinal"><span class="hs-identifier">smFinal</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#smThreadToken"><span class="hs-identifier">smThreadToken</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#smTransition"><span class="hs-identifier">smTransition</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-85"></span><span>                                             </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier">StateMachineInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier">StateMachineInstance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#stateMachine"><span class="hs-identifier">stateMachine</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#typedValidator"><span class="hs-identifier">typedValidator</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html"><span class="hs-identifier">Plutus.Contract.StateMachine.OnChain</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SM</span></span><span>
</span><span id="line-87"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html"><span class="hs-identifier">Plutus.Contract.StateMachine.ThreadToken</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html#ThreadToken"><span class="hs-identifier">ThreadToken</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html#ThreadToken"><span class="hs-identifier">ThreadToken</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html#curPolicy"><span class="hs-identifier">curPolicy</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html#ttOutRef"><span class="hs-identifier">ttOutRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contract.Wallet.html"><span class="hs-identifier">Plutus.Contract.Wallet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.Wallet.html#getUnspentOutput"><span class="hs-identifier">getUnspentOutput</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">Plutus.Script.Utils.V1.Scripts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">scriptCurrencySymbol</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">Plutus.Script.Utils.V2.Typed.Scripts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Typed</span></span><span>
</span><span id="line-91"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Plutus.V2.Ledger.Tx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V2</span></span><span>
</span><span id="line-92"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-93"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx.Monoid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">inv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- $statemachine</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- To write your contract as a state machine you need</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- * Two types @state@ and @input@ for the state and inputs of the machine</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- * A 'SM.StateMachineInstance state input' describing the transitions and</span><span>
</span><span id="line-99"></span><span class="hs-comment">--   checks of the state machine (this is the on-chain code)</span><span>
</span><span id="line-100"></span><span class="hs-comment">-- * A 'StateMachineClient state input' with the state machine instance and</span><span>
</span><span id="line-101"></span><span class="hs-comment">--   an allocation function</span><span>
</span><span id="line-102"></span><span class="hs-comment">--</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- In many cases it is enough to define the transition function</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- @t :: (state, Value) -&gt; input -&gt; Maybe (TxConstraints state)@ and use</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- 'mkStateMachine' and 'mkStateMachineClient' to get the client.</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- You can then use 'runInitialise' and 'runStep' to initialise and transition</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- the state machine. 'runStep' gets the current state from the utxo set and</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- makes the transition to the next state using the given input and taking care</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- of all payments.</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Typed representation of the on-chain state of a state machine instance</span><span>
</span><span id="line-112"></span><span class="hs-keyword">newtype</span><span> </span><span id="OnChainState"><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-var">OnChainState</span></a></span></span><span> </span><span id="local-6989586621680838283"><span class="annot"><a href="#local-6989586621680838283"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680838282"><span class="annot"><a href="#local-6989586621680838282"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-113"></span><span>    </span><span id="OnChainState"><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-var">OnChainState</span></a></span></span><span>
</span><span id="line-114"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="ocsTxOutRef"><span class="annot"><span class="annottext">OnChainState s i -&gt; TypedScriptTxOutRef (StateMachine s i)
</span><a href="Plutus.Contract.StateMachine.html#ocsTxOutRef"><span class="hs-identifier hs-var hs-var">ocsTxOutRef</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">Typed.TypedScriptTxOutRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier hs-type">SM.StateMachine</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838283"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838282"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Typed UTXO</span><span>
</span><span id="line-115"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span id="local-6989586621680838027"><span id="local-6989586621680838028"><span class="annot"><a href="Plutus.Contract.StateMachine.html#getStateData"><span class="hs-identifier hs-type">getStateData</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838028"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838027"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680838028"><span class="hs-identifier hs-type">s</span></a></span></span></span><span>
</span><span id="line-118"></span><span id="getStateData"><span class="annot"><span class="annottext">getStateData :: OnChainState s i -&gt; s
</span><a href="Plutus.Contract.StateMachine.html#getStateData"><span class="hs-identifier hs-var hs-var">getStateData</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOut (StateMachine s i) -&gt; s
forall a. TypedScriptTxOut a -&gt; DatumType a
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutData</span></a></span><span> </span><span class="annot"><span class="annottext">(TypedScriptTxOut (StateMachine s i) -&gt; s)
-&gt; (OnChainState s i -&gt; TypedScriptTxOut (StateMachine s i))
-&gt; OnChainState s i
-&gt; s
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine s i)
-&gt; TypedScriptTxOut (StateMachine s i)
forall a. TypedScriptTxOutRef a -&gt; TypedScriptTxOut a
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutRefOut</span></a></span><span> </span><span class="annot"><span class="annottext">(TypedScriptTxOutRef (StateMachine s i)
 -&gt; TypedScriptTxOut (StateMachine s i))
-&gt; (OnChainState s i -&gt; TypedScriptTxOutRef (StateMachine s i))
-&gt; OnChainState s i
-&gt; TypedScriptTxOut (StateMachine s i)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState s i -&gt; TypedScriptTxOutRef (StateMachine s i)
forall s i.
OnChainState s i -&gt; TypedScriptTxOutRef (StateMachine s i)
</span><a href="Plutus.Contract.StateMachine.html#ocsTxOutRef"><span class="hs-identifier hs-var hs-var">ocsTxOutRef</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#getInput"><span class="hs-identifier hs-type">getInput</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-121"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837960"><span class="annot"><a href="#local-6989586621680837960"><span class="hs-identifier hs-type">i</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837960"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">ChainIndexTx</span></a></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837960"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-126"></span><span id="getInput"><span class="annot"><span class="annottext">getInput :: TxOutRef -&gt; ChainIndexTx -&gt; Maybe i
</span><a href="Plutus.Contract.StateMachine.html#getInput"><span class="hs-identifier hs-var hs-var">getInput</span></a></span></span><span> </span><span id="local-6989586621680837734"><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837734"><span class="hs-identifier hs-var">outRef</span></a></span></span><span> </span><span id="local-6989586621680837733"><span class="annot"><span class="annottext">ChainIndexTx
</span><a href="#local-6989586621680837733"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-comment">-- We retrieve the correspondent redeemer according to the index of txIn in the list</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837732"><span class="annot"><span class="annottext">findRedeemer :: (Integer, TxIn) -&gt; Maybe Redeemer
</span><a href="#local-6989586621680837732"><span class="hs-identifier hs-var hs-var">findRedeemer</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837731"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680837731"><span class="hs-identifier hs-var">ix</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TxIn
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RedeemerPtr -&gt; Map RedeemerPtr Redeemer -&gt; Maybe Redeemer
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScriptTag -&gt; Integer -&gt; RedeemerPtr
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Tx.RedeemerPtr</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptTag
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Tx.Spend</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680837731"><span class="hs-identifier hs-var">ix</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainIndexTx -&gt; Map RedeemerPtr Redeemer
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var hs-var">_citxRedeemers</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexTx
</span><a href="#local-6989586621680837733"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Ledger.Redeemer</span></a></span><span> </span><span id="local-6989586621680837726"><span class="annot"><span class="annottext">BuiltinData
</span><a href="#local-6989586621680837726"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Redeemer] -&gt; Maybe Redeemer
forall a. [a] -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">([Redeemer] -&gt; Maybe Redeemer) -&gt; [Redeemer] -&gt; Maybe Redeemer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((Integer, TxIn) -&gt; Maybe Redeemer)
-&gt; [(Integer, TxIn)] -&gt; [Redeemer]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer, TxIn) -&gt; Maybe Redeemer
</span><a href="#local-6989586621680837732"><span class="hs-identifier hs-var">findRedeemer</span></a></span><span> </span><span class="annot"><span class="annottext">([(Integer, TxIn)] -&gt; [Redeemer])
-&gt; [(Integer, TxIn)] -&gt; [Redeemer]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((Integer, TxIn) -&gt; Bool) -&gt; [(Integer, TxIn)] -&gt; [(Integer, TxIn)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Tx.TxIn</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837724"><span class="annot"><span class="annottext">TxOutRef
txInRef :: TxIn -&gt; TxOutRef
txInRef :: TxOutRef
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">Tx.txInRef</span></a></span></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837734"><span class="hs-identifier hs-var">outRef</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; TxOutRef -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837724"><span class="hs-identifier hs-var">txInRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Integer, TxIn)] -&gt; [(Integer, TxIn)])
-&gt; [(Integer, TxIn)] -&gt; [(Integer, TxIn)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Integer] -&gt; [TxIn] -&gt; [(Integer, TxIn)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">zip</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">([TxIn] -&gt; [(Integer, TxIn)]) -&gt; [TxIn] -&gt; [(Integer, TxIn)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexTx -&gt; [TxIn]
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var hs-var">_citxInputs</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexTx
</span><a href="#local-6989586621680837733"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="annottext">BuiltinData -&gt; Maybe i
forall a. FromData a =&gt; BuiltinData -&gt; Maybe a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.fromBuiltinData</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinData
</span><a href="#local-6989586621680837726"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-131"></span><span>
</span><span id="line-132"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#getStates"><span class="hs-identifier hs-type">getStates</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680838083"><span class="annot"><a href="#local-6989586621680838083"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680838082"><span class="annot"><a href="#local-6989586621680838082"><span class="hs-identifier hs-type">i</span></a></span></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838083"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838083"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier hs-type">SM.StateMachineInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838083"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838082"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Tx.TxOutRef</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Tx.DecoratedTxOut</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838083"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838082"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-138"></span><span id="getStates"><span class="annot"><span class="annottext">getStates :: StateMachineInstance s i
-&gt; Map TxOutRef DecoratedTxOut -&gt; [OnChainState s i]
</span><a href="Plutus.Contract.StateMachine.html#getStates"><span class="hs-identifier hs-var hs-var">getStates</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier hs-type">SM.StateMachineInstance</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachine s i
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680837721"><span class="annot"><span class="annottext">TypedValidator (StateMachine s i)
</span><a href="#local-6989586621680837721"><span class="hs-identifier hs-var">si</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680837720"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837720"><span class="hs-identifier hs-var">refMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><span class="annottext">(((TxOutRef, DecoratedTxOut) -&gt; Maybe (OnChainState s i))
 -&gt; [(TxOutRef, DecoratedTxOut)] -&gt; [OnChainState s i])
-&gt; [(TxOutRef, DecoratedTxOut)]
-&gt; ((TxOutRef, DecoratedTxOut) -&gt; Maybe (OnChainState s i))
-&gt; [OnChainState s i]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">((TxOutRef, DecoratedTxOut) -&gt; Maybe (OnChainState s i))
-&gt; [(TxOutRef, DecoratedTxOut)] -&gt; [OnChainState s i]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mapMaybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut -&gt; [(TxOutRef, DecoratedTxOut)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837720"><span class="hs-identifier hs-var">refMap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TxOutRef, DecoratedTxOut) -&gt; Maybe (OnChainState s i))
 -&gt; [OnChainState s i])
-&gt; ((TxOutRef, DecoratedTxOut) -&gt; Maybe (OnChainState s i))
-&gt; [OnChainState s i]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680837717"><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837717"><span class="hs-identifier hs-var">txOutRef</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837716"><span class="annot"><span class="annottext">DecoratedTxOut
</span><a href="#local-6989586621680837716"><span class="hs-identifier hs-var">ciTxOut</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837715"><span class="annot"><span class="annottext">txOut :: TxOut
</span><a href="#local-6989586621680837715"><span class="hs-identifier hs-var hs-var">txOut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecoratedTxOut -&gt; TxOut
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">Tx.toTxInfoTxOut</span></a></span><span> </span><span class="annot"><span class="annottext">DecoratedTxOut
</span><a href="#local-6989586621680837716"><span class="hs-identifier hs-var">ciTxOut</span></a></span><span>
</span><span id="line-141"></span><span>      </span><span id="local-6989586621680837713"><span class="annot"><span class="annottext">Datum
</span><a href="#local-6989586621680837713"><span class="hs-identifier hs-var">datum</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DecoratedTxOut
</span><a href="#local-6989586621680837716"><span class="hs-identifier hs-var">ciTxOut</span></a></span><span> </span><span class="annot"><span class="annottext">DecoratedTxOut
-&gt; Getting (First Datum) DecoratedTxOut Datum -&gt; Maybe Datum
forall s a. s -&gt; Getting (First a) s a -&gt; Maybe a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^?</span></a></span><span> </span><span class="annot"><span class="annottext">((DatumHash, DatumFromQuery)
 -&gt; Const (First Datum) (DatumHash, DatumFromQuery))
-&gt; DecoratedTxOut -&gt; Const (First Datum) DecoratedTxOut
Traversal' DecoratedTxOut (DatumHash, DatumFromQuery)
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">Tx.decoratedTxOutScriptDatum</span></a></span><span> </span><span class="annot"><span class="annottext">(((DatumHash, DatumFromQuery)
  -&gt; Const (First Datum) (DatumHash, DatumFromQuery))
 -&gt; DecoratedTxOut -&gt; Const (First Datum) DecoratedTxOut)
-&gt; ((Datum -&gt; Const (First Datum) Datum)
    -&gt; (DatumHash, DatumFromQuery)
    -&gt; Const (First Datum) (DatumHash, DatumFromQuery))
-&gt; Getting (First Datum) DecoratedTxOut Datum
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(DatumFromQuery -&gt; Const (First Datum) DatumFromQuery)
-&gt; (DatumHash, DatumFromQuery)
-&gt; Const (First Datum) (DatumHash, DatumFromQuery)
forall s t a b. Field2 s t a b =&gt; Lens s t a b
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">_2</span></a></span><span> </span><span class="annot"><span class="annottext">((DatumFromQuery -&gt; Const (First Datum) DatumFromQuery)
 -&gt; (DatumHash, DatumFromQuery)
 -&gt; Const (First Datum) (DatumHash, DatumFromQuery))
-&gt; ((Datum -&gt; Const (First Datum) Datum)
    -&gt; DatumFromQuery -&gt; Const (First Datum) DatumFromQuery)
-&gt; (Datum -&gt; Const (First Datum) Datum)
-&gt; (DatumHash, DatumFromQuery)
-&gt; Const (First Datum) (DatumHash, DatumFromQuery)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Datum -&gt; Const (First Datum) Datum)
-&gt; DatumFromQuery -&gt; Const (First Datum) DatumFromQuery
Traversal' DatumFromQuery Datum
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">Tx.datumInDatumFromQuery</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span id="local-6989586621680837710"><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine s i)
</span><a href="#local-6989586621680837710"><span class="hs-identifier hs-var">ocsTxOutRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ConnectionError -&gt; Maybe (TypedScriptTxOutRef (StateMachine s i)))
-&gt; (TypedScriptTxOutRef (StateMachine s i)
    -&gt; Maybe (TypedScriptTxOutRef (StateMachine s i)))
-&gt; Either ConnectionError (TypedScriptTxOutRef (StateMachine s i))
-&gt; Maybe (TypedScriptTxOutRef (StateMachine s i))
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (TypedScriptTxOutRef (StateMachine s i))
-&gt; ConnectionError
-&gt; Maybe (TypedScriptTxOutRef (StateMachine s i))
forall a b. a -&gt; b -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypedScriptTxOutRef (StateMachine s i))
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine s i)
-&gt; Maybe (TypedScriptTxOutRef (StateMachine s i))
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Either ConnectionError (TypedScriptTxOutRef (StateMachine s i))
 -&gt; Maybe (TypedScriptTxOutRef (StateMachine s i)))
-&gt; Either ConnectionError (TypedScriptTxOutRef (StateMachine s i))
-&gt; Maybe (TypedScriptTxOutRef (StateMachine s i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine s i)
-&gt; TxOutRef
-&gt; TxOut
-&gt; Datum
-&gt; Either ConnectionError (TypedScriptTxOutRef (StateMachine s i))
forall out (m :: * -&gt; *).
(FromData (DatumType out), ToData (DatumType out),
 MonadError ConnectionError m) =&gt;
TypedValidator out
-&gt; TxOutRef -&gt; TxOut -&gt; Datum -&gt; m (TypedScriptTxOutRef out)
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Typed.typeScriptTxOutRef</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine s i)
</span><a href="#local-6989586621680837721"><span class="hs-identifier hs-var">si</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837717"><span class="hs-identifier hs-var">txOutRef</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680837715"><span class="hs-identifier hs-var">txOut</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="#local-6989586621680837713"><span class="hs-identifier hs-var">datum</span></a></span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><span class="annottext">OnChainState s i -&gt; Maybe (OnChainState s i)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState :: forall s i.
TypedScriptTxOutRef (StateMachine s i) -&gt; OnChainState s i
</span><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine s i)
ocsTxOutRef :: TypedScriptTxOutRef (StateMachine s i)
ocsTxOutRef :: TypedScriptTxOutRef (StateMachine s i)
</span><a href="#local-6989586621680837710"><span class="hs-identifier hs-var hs-var">ocsTxOutRef</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | An invalid transition</span><span>
</span><span id="line-146"></span><span id="local-6989586621680837705"><span id="local-6989586621680837706"></span></span><span class="hs-keyword">data</span><span> </span><span id="InvalidTransition"><span class="annot"><a href="Plutus.Contract.StateMachine.html#InvalidTransition"><span class="hs-identifier hs-var">InvalidTransition</span></a></span></span><span> </span><span id="local-6989586621680837824"><span class="annot"><a href="#local-6989586621680837824"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680837823"><span class="annot"><a href="#local-6989586621680837823"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>    </span><span id="InvalidTransition"><span class="annot"><a href="Plutus.Contract.StateMachine.html#InvalidTransition"><span class="hs-identifier hs-var">InvalidTransition</span></a></span></span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="tfState"><span class="annot"><span class="annottext">InvalidTransition s i -&gt; Maybe (State s)
</span><a href="Plutus.Contract.StateMachine.html#tfState"><span class="hs-identifier hs-var hs-var">tfState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837824"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Current state. 'Nothing' indicates that there is no current state.</span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="tfInput"><span class="annot"><span class="annottext">InvalidTransition s i -&gt; i
</span><a href="Plutus.Contract.StateMachine.html#tfInput"><span class="hs-identifier hs-var hs-var">tfInput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680837823"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-comment">-- ^ Transition that was attempted but failed</span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837698"><span id="local-6989586621680837700"><span class="annot"><span class="annottext">InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool
(InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool)
-&gt; (InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool)
-&gt; Eq (InvalidTransition s i)
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
forall s i.
(Eq s, Eq i) =&gt;
InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool
/= :: InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool
$c/= :: forall s i.
(Eq s, Eq i) =&gt;
InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool
== :: InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool
$c== :: forall s i.
(Eq s, Eq i) =&gt;
InvalidTransition s i -&gt; InvalidTransition s i -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837691"><span id="local-6989586621680837693"><span id="local-6989586621680837695"><span class="annot"><span class="annottext">Int -&gt; InvalidTransition s i -&gt; ShowS
[InvalidTransition s i] -&gt; ShowS
InvalidTransition s i -&gt; String
(Int -&gt; InvalidTransition s i -&gt; ShowS)
-&gt; (InvalidTransition s i -&gt; String)
-&gt; ([InvalidTransition s i] -&gt; ShowS)
-&gt; Show (InvalidTransition s i)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall s i.
(Show s, Show i) =&gt;
Int -&gt; InvalidTransition s i -&gt; ShowS
forall s i. (Show s, Show i) =&gt; [InvalidTransition s i] -&gt; ShowS
forall s i. (Show s, Show i) =&gt; InvalidTransition s i -&gt; String
showList :: [InvalidTransition s i] -&gt; ShowS
$cshowList :: forall s i. (Show s, Show i) =&gt; [InvalidTransition s i] -&gt; ShowS
show :: InvalidTransition s i -&gt; String
$cshow :: forall s i. (Show s, Show i) =&gt; InvalidTransition s i -&gt; String
showsPrec :: Int -&gt; InvalidTransition s i -&gt; ShowS
$cshowsPrec :: forall s i.
(Show s, Show i) =&gt;
Int -&gt; InvalidTransition s i -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. InvalidTransition s i -&gt; Rep (InvalidTransition s i) x)
-&gt; (forall x.
    Rep (InvalidTransition s i) x -&gt; InvalidTransition s i)
-&gt; Generic (InvalidTransition s i)
forall x. Rep (InvalidTransition s i) x -&gt; InvalidTransition s i
forall x. InvalidTransition s i -&gt; Rep (InvalidTransition s i) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall s i x.
Rep (InvalidTransition s i) x -&gt; InvalidTransition s i
forall s i x.
InvalidTransition s i -&gt; Rep (InvalidTransition s i) x
$cto :: forall s i x.
Rep (InvalidTransition s i) x -&gt; InvalidTransition s i
$cfrom :: forall s i x.
InvalidTransition s i -&gt; Rep (InvalidTransition s i) x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837679"><span id="local-6989586621680837681"><span id="local-6989586621680837683"><span id="local-6989586621680837685"><span class="annot"><span class="annottext">[InvalidTransition s i] -&gt; Encoding
[InvalidTransition s i] -&gt; Value
InvalidTransition s i -&gt; Encoding
InvalidTransition s i -&gt; Value
(InvalidTransition s i -&gt; Value)
-&gt; (InvalidTransition s i -&gt; Encoding)
-&gt; ([InvalidTransition s i] -&gt; Value)
-&gt; ([InvalidTransition s i] -&gt; Encoding)
-&gt; ToJSON (InvalidTransition s i)
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
forall s i.
(ToJSON i, ToJSON s) =&gt;
[InvalidTransition s i] -&gt; Encoding
forall s i.
(ToJSON i, ToJSON s) =&gt;
[InvalidTransition s i] -&gt; Value
forall s i.
(ToJSON i, ToJSON s) =&gt;
InvalidTransition s i -&gt; Encoding
forall s i. (ToJSON i, ToJSON s) =&gt; InvalidTransition s i -&gt; Value
toEncodingList :: [InvalidTransition s i] -&gt; Encoding
$ctoEncodingList :: forall s i.
(ToJSON i, ToJSON s) =&gt;
[InvalidTransition s i] -&gt; Encoding
toJSONList :: [InvalidTransition s i] -&gt; Value
$ctoJSONList :: forall s i.
(ToJSON i, ToJSON s) =&gt;
[InvalidTransition s i] -&gt; Value
toEncoding :: InvalidTransition s i -&gt; Encoding
$ctoEncoding :: forall s i.
(ToJSON i, ToJSON s) =&gt;
InvalidTransition s i -&gt; Encoding
toJSON :: InvalidTransition s i -&gt; Value
$ctoJSON :: forall s i. (ToJSON i, ToJSON s) =&gt; InvalidTransition s i -&gt; Value
</span><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837674"><span id="local-6989586621680837676"><span class="annot"><span class="annottext">Value -&gt; Parser [InvalidTransition s i]
Value -&gt; Parser (InvalidTransition s i)
(Value -&gt; Parser (InvalidTransition s i))
-&gt; (Value -&gt; Parser [InvalidTransition s i])
-&gt; FromJSON (InvalidTransition s i)
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
forall s i.
(FromJSON s, FromJSON i) =&gt;
Value -&gt; Parser [InvalidTransition s i]
forall s i.
(FromJSON s, FromJSON i) =&gt;
Value -&gt; Parser (InvalidTransition s i)
parseJSONList :: Value -&gt; Parser [InvalidTransition s i]
$cparseJSONList :: forall s i.
(FromJSON s, FromJSON i) =&gt;
Value -&gt; Parser [InvalidTransition s i]
parseJSON :: Value -&gt; Parser (InvalidTransition s i)
$cparseJSON :: forall s i.
(FromJSON s, FromJSON i) =&gt;
Value -&gt; Parser (InvalidTransition s i)
</span><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-comment">-- | Result of an attempted transition</span><span>
</span><span id="line-155"></span><span class="hs-keyword">data</span><span> </span><span id="TransitionResult"><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionResult"><span class="hs-identifier hs-var">TransitionResult</span></a></span></span><span> </span><span id="local-6989586621680837831"><span class="annot"><a href="#local-6989586621680837831"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680837830"><span class="annot"><a href="#local-6989586621680837830"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>    </span><span id="TransitionFailure"><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionFailure"><span class="hs-identifier hs-var">TransitionFailure</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#InvalidTransition"><span class="hs-identifier hs-type">InvalidTransition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837831"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837830"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The transition is not allowed</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="TransitionSuccess"><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionSuccess"><span class="hs-identifier hs-var">TransitionSuccess</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680837831"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-comment">-- ^ The transition is allowed and results in a new state</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span id="local-6989586621680837669"><span id="local-6989586621680837670"></span></span><span class="hs-keyword">data</span><span> </span><span id="SMContractError"><span class="annot"><a href="Plutus.Contract.StateMachine.html#SMContractError"><span class="hs-identifier hs-var">SMContractError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>    </span><span id="ChooserError"><span class="annot"><a href="Plutus.Contract.StateMachine.html#ChooserError"><span class="hs-identifier hs-var">ChooserError</span></a></span></span><span> </span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span>
</span><span id="line-161"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="UnableToExtractTransition"><span class="annot"><a href="Plutus.Contract.StateMachine.html#UnableToExtractTransition"><span class="hs-identifier hs-var">UnableToExtractTransition</span></a></span></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SMCContractError"><span class="annot"><a href="Plutus.Contract.StateMachine.html#SMCContractError"><span class="hs-identifier hs-var">SMCContractError</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contract.Error.html#ContractError"><span class="hs-identifier hs-type">ContractError</span></a></span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837660"><span id="local-6989586621680837662"><span id="local-6989586621680837664"><span class="annot"><span class="annottext">Int -&gt; SMContractError -&gt; ShowS
[SMContractError] -&gt; ShowS
SMContractError -&gt; String
(Int -&gt; SMContractError -&gt; ShowS)
-&gt; (SMContractError -&gt; String)
-&gt; ([SMContractError] -&gt; ShowS)
-&gt; Show SMContractError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SMContractError] -&gt; ShowS
$cshowList :: [SMContractError] -&gt; ShowS
show :: SMContractError -&gt; String
$cshow :: SMContractError -&gt; String
showsPrec :: Int -&gt; SMContractError -&gt; ShowS
$cshowsPrec :: Int -&gt; SMContractError -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837656"><span id="local-6989586621680837658"><span class="annot"><span class="annottext">SMContractError -&gt; SMContractError -&gt; Bool
(SMContractError -&gt; SMContractError -&gt; Bool)
-&gt; (SMContractError -&gt; SMContractError -&gt; Bool)
-&gt; Eq SMContractError
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SMContractError -&gt; SMContractError -&gt; Bool
$c/= :: SMContractError -&gt; SMContractError -&gt; Bool
== :: SMContractError -&gt; SMContractError -&gt; Bool
$c== :: SMContractError -&gt; SMContractError -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. SMContractError -&gt; Rep SMContractError x)
-&gt; (forall x. Rep SMContractError x -&gt; SMContractError)
-&gt; Generic SMContractError
forall x. Rep SMContractError x -&gt; SMContractError
forall x. SMContractError -&gt; Rep SMContractError x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep SMContractError x -&gt; SMContractError
$cfrom :: forall x. SMContractError -&gt; Rep SMContractError x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837646"><span id="local-6989586621680837648"><span id="local-6989586621680837650"><span id="local-6989586621680837652"><span class="annot"><span class="annottext">[SMContractError] -&gt; Encoding
[SMContractError] -&gt; Value
SMContractError -&gt; Encoding
SMContractError -&gt; Value
(SMContractError -&gt; Value)
-&gt; (SMContractError -&gt; Encoding)
-&gt; ([SMContractError] -&gt; Value)
-&gt; ([SMContractError] -&gt; Encoding)
-&gt; ToJSON SMContractError
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [SMContractError] -&gt; Encoding
$ctoEncodingList :: [SMContractError] -&gt; Encoding
toJSONList :: [SMContractError] -&gt; Value
$ctoJSONList :: [SMContractError] -&gt; Value
toEncoding :: SMContractError -&gt; Encoding
$ctoEncoding :: SMContractError -&gt; Encoding
toJSON :: SMContractError -&gt; Value
$ctoJSON :: SMContractError -&gt; Value
</span><a href="#local-6989586621680837646"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837642"><span id="local-6989586621680837644"><span class="annot"><span class="annottext">Value -&gt; Parser [SMContractError]
Value -&gt; Parser SMContractError
(Value -&gt; Parser SMContractError)
-&gt; (Value -&gt; Parser [SMContractError]) -&gt; FromJSON SMContractError
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [SMContractError]
$cparseJSONList :: Value -&gt; Parser [SMContractError]
parseJSON :: Value -&gt; Parser SMContractError
$cparseJSON :: Value -&gt; Parser SMContractError
</span><a href="#local-6989586621680837642"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span id="_SMCContractError"><span id="_UnableToExtractTransition"><span id="_ChooserError"><span id="_SMContractError"><span id="local-6989586621680837631"><span id="local-6989586621680837633"><span id="local-6989586621680837635"><span id="local-6989586621680837637"><span id="local-6989586621680837639"><span id="local-6989586621680837640"><span id="local-6989586621680837641"><span id="AsSMContractError"><span id="local-6989586621680838182"><span class="hs-identifier">makeClassyPrisms</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">SMContractError</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680837605"><span id="local-6989586621680837607"><span id="local-6989586621680837609"><span id="local-6989586621680837611"><span id="local-6989586621680837613"><span id="local-6989586621680837615"><span id="local-6989586621680837617"><span id="local-6989586621680837619"><span id="local-6989586621680837621"><span id="local-6989586621680837623"><span class="annot"><a href="Plutus.Contract.Error.html#AsContractError"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#SMContractError"><span class="hs-identifier hs-type">SMContractError</span></a></span></span></span></span></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-169"></span><span>    </span><span id="local-6989586621680837603"><span class="annot"><span class="annottext">_ContractError :: p ContractError (f ContractError)
-&gt; p SMContractError (f SMContractError)
</span><a href="#local-6989586621680837603"><span class="hs-identifier hs-var hs-var hs-var hs-var">_ContractError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p ContractError (f ContractError)
-&gt; p SMContractError (f SMContractError)
forall r. AsSMContractError r =&gt; Prism' r ContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMCContractError"><span class="hs-identifier hs-var">_SMCContractError</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="hs-comment">-- | Client-side definition of a state machine.</span><span>
</span><span id="line-172"></span><span class="hs-keyword">data</span><span> </span><span id="StateMachineClient"><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-var">StateMachineClient</span></a></span></span><span> </span><span id="local-6989586621680838108"><span class="annot"><a href="#local-6989586621680838108"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680838107"><span class="annot"><a href="#local-6989586621680838107"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="StateMachineClient"><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-var">StateMachineClient</span></a></span></span><span>
</span><span id="line-173"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="scInstance"><span class="annot"><span class="annottext">StateMachineClient s i -&gt; StateMachineInstance s i
</span><a href="Plutus.Contract.StateMachine.html#scInstance"><span class="hs-identifier hs-var hs-var">scInstance</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier hs-type">SM.StateMachineInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838108"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838107"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-174"></span><span>    </span><span class="hs-comment">-- ^ The instance of the state machine, defining the machine's transitions,</span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">--   its final states and its check function.</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="scChooser"><span class="annot"><span class="annottext">StateMachineClient s i
-&gt; [OnChainState s i] -&gt; Either SMContractError (OnChainState s i)
</span><a href="Plutus.Contract.StateMachine.html#scChooser"><span class="hs-identifier hs-var hs-var">scChooser</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838108"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838107"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#SMContractError"><span class="hs-identifier hs-type">SMContractError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838108"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838107"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-comment">-- ^ A function that chooses the relevant on-chain state, given a list of</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-comment">--   all potential on-chain states found at the contract address.</span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="hs-comment">-- | A state chooser function that fails if confronted with anything other</span><span>
</span><span id="line-182"></span><span class="hs-comment">--   than exactly one output</span><span>
</span><span id="line-183"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#defaultChooser"><span class="hs-identifier hs-type">defaultChooser</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680838112"><span class="annot"><a href="#local-6989586621680838112"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680838111"><span class="annot"><a href="#local-6989586621680838111"><span class="hs-identifier hs-type">input</span></a></span></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838112"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838111"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#SMContractError"><span class="hs-identifier hs-type">SMContractError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838112"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838111"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-187"></span><span id="defaultChooser"><span class="annot"><span class="annottext">defaultChooser :: [OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
</span><a href="Plutus.Contract.StateMachine.html#defaultChooser"><span class="hs-identifier hs-var hs-var">defaultChooser</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621680837599"><span class="annot"><span class="annottext">OnChainState state input
</span><a href="#local-6989586621680837599"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnChainState state input
-&gt; Either SMContractError (OnChainState state input)
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state input
</span><a href="#local-6989586621680837599"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-188"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#defaultChooser"><span class="hs-identifier hs-var">defaultChooser</span></a></span><span> </span><span id="local-6989586621680837598"><span class="annot"><span class="annottext">[OnChainState state input]
</span><a href="#local-6989586621680837598"><span class="hs-identifier hs-var">xs</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837597"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621680837597"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OnChainState state input] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[OnChainState state input]
</span><a href="#local-6989586621680837598"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; outputs, expected 1&quot;</span></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">SMContractError
-&gt; Either SMContractError (OnChainState state input)
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SMContractError
</span><a href="Plutus.Contract.StateMachine.html#ChooserError"><span class="hs-identifier hs-var">ChooserError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier hs-var">Text.pack</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680837597"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span class="hs-comment">-- | A state chooser function that searches for an output with the thread token</span><span>
</span><span id="line-193"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#threadTokenChooser"><span class="hs-identifier hs-type">threadTokenChooser</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680838110"><span class="annot"><a href="#local-6989586621680838110"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680838109"><span class="annot"><a href="#local-6989586621680838109"><span class="hs-identifier hs-type">input</span></a></span></span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838110"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838109"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#SMContractError"><span class="hs-identifier hs-type">SMContractError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838110"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838109"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span id="threadTokenChooser"><span class="annot"><span class="annottext">threadTokenChooser :: Value
-&gt; [OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
</span><a href="Plutus.Contract.StateMachine.html#threadTokenChooser"><span class="hs-identifier hs-var hs-var">threadTokenChooser</span></a></span></span><span> </span><span id="local-6989586621680837592"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837592"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span id="local-6989586621680837591"><span class="annot"><span class="annottext">[OnChainState state input]
</span><a href="#local-6989586621680837591"><span class="hs-identifier hs-var">states</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837590"><span class="annot"><span class="annottext">hasToken :: OnChainState state input -&gt; Bool
</span><a href="#local-6989586621680837590"><span class="hs-identifier hs-var hs-var">hasToken</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837589"><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input)
ocsTxOutRef :: TypedScriptTxOutRef (StateMachine state input)
ocsTxOutRef :: forall s i.
OnChainState s i -&gt; TypedScriptTxOutRef (StateMachine s i)
</span><a href="#local-6989586621680837589"><span class="hs-identifier hs-var hs-var">ocsTxOutRef</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837592"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`Value.leq`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOut -&gt; Value
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">V2.txOutValue</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOut -&gt; Value) -&gt; TxOut -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOut (StateMachine state input) -&gt; TxOut
forall a. TypedScriptTxOut a -&gt; TxOut
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutTxOut</span></a></span><span> </span><span class="annot"><span class="annottext">(TypedScriptTxOut (StateMachine state input) -&gt; TxOut)
-&gt; TypedScriptTxOut (StateMachine state input) -&gt; TxOut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input)
-&gt; TypedScriptTxOut (StateMachine state input)
forall a. TypedScriptTxOutRef a -&gt; TypedScriptTxOut a
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutRefOut</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input)
</span><a href="#local-6989586621680837589"><span class="hs-identifier hs-var">ocsTxOutRef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(OnChainState state input -&gt; Bool)
-&gt; [OnChainState state input] -&gt; [OnChainState state input]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state input -&gt; Bool
</span><a href="#local-6989586621680837590"><span class="hs-identifier hs-var">hasToken</span></a></span><span> </span><span class="annot"><span class="annottext">[OnChainState state input]
</span><a href="#local-6989586621680837591"><span class="hs-identifier hs-var">states</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-201"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621680837585"><span class="annot"><span class="annottext">OnChainState state input
</span><a href="#local-6989586621680837585"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OnChainState state input
-&gt; Either SMContractError (OnChainState state input)
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state input
</span><a href="#local-6989586621680837585"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span id="local-6989586621680837584"><span class="annot"><span class="annottext">[OnChainState state input]
</span><a href="#local-6989586621680837584"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-203"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837583"><span class="annot"><span class="annottext">msg :: String
</span><a href="#local-6989586621680837583"><span class="hs-identifier hs-var hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[String] -&gt; String
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">unwords</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Found&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OnChainState state input] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">[OnChainState state input]
</span><a href="#local-6989586621680837584"><span class="hs-identifier hs-var">xs</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;outputs with thread token&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Value -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837592"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expected 1&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-204"></span><span>            </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">SMContractError
-&gt; Either SMContractError (OnChainState state input)
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; SMContractError
</span><a href="Plutus.Contract.StateMachine.html#ChooserError"><span class="hs-identifier hs-var">ChooserError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier hs-var">Text.pack</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621680837583"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-comment">-- | A state machine client with the 'defaultChooser' function</span><span>
</span><span id="line-207"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#mkStateMachineClient"><span class="hs-identifier hs-type">mkStateMachineClient</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837581"><span class="annot"><a href="#local-6989586621680837581"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837580"><span class="annot"><a href="#local-6989586621680837580"><span class="hs-identifier hs-type">input</span></a></span></span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier hs-type">SM.StateMachineInstance</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837581"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837580"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837581"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837580"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-211"></span><span id="mkStateMachineClient"><span class="annot"><span class="annottext">mkStateMachineClient :: StateMachineInstance state input -&gt; StateMachineClient state input
</span><a href="Plutus.Contract.StateMachine.html#mkStateMachineClient"><span class="hs-identifier hs-var hs-var">mkStateMachineClient</span></a></span></span><span> </span><span id="local-6989586621680837579"><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837579"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837578"><span class="annot"><span class="annottext">threadTokenVal :: Value
</span><a href="#local-6989586621680837578"><span class="hs-identifier hs-var hs-var">threadTokenVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input -&gt; Value
forall s i. StateMachineInstance s i -&gt; Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#threadTokenValueOrZero"><span class="hs-identifier hs-var">SM.threadTokenValueOrZero</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837579"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-213"></span><span>        </span><span id="local-6989586621680837576"><span class="annot"><span class="annottext">scChooser :: [OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
</span><a href="#local-6989586621680837576"><span class="hs-identifier hs-var hs-var">scChooser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Value.isZero</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837578"><span class="hs-identifier hs-var">threadTokenVal</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
forall state input.
[OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
</span><a href="Plutus.Contract.StateMachine.html#defaultChooser"><span class="hs-identifier hs-var">defaultChooser</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Value
-&gt; [OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
forall state input.
Value
-&gt; [OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
</span><a href="Plutus.Contract.StateMachine.html#threadTokenChooser"><span class="hs-identifier hs-var">threadTokenChooser</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837578"><span class="hs-identifier hs-var">threadTokenVal</span></a></span><span>
</span><span id="line-214"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">StateMachineClient :: forall s i.
StateMachineInstance s i
-&gt; ([OnChainState s i]
    -&gt; Either SMContractError (OnChainState s i))
-&gt; StateMachineClient s i
</span><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scInstance :: StateMachineInstance state input
</span><a href="Plutus.Contract.StateMachine.html#scInstance"><span class="hs-identifier hs-var">scInstance</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837579"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
scChooser :: [OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
scChooser :: [OnChainState state input]
-&gt; Either SMContractError (OnChainState state input)
</span><a href="#local-6989586621680837576"><span class="hs-identifier hs-var hs-var">scChooser</span></a></span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="hs-comment">{-| Get the current on-chain state of the state machine instance.
    Return Nothing if there is no state on chain.
    Throws an @SMContractError@ if the number of outputs at the machine address is greater than one.
-}</span><span>
</span><span id="line-223"></span><span id="local-6989586621680837996"><span id="local-6989586621680837997"><span id="local-6989586621680837998"><span id="local-6989586621680837999"><span id="local-6989586621680838000"><span class="annot"><a href="Plutus.Contract.StateMachine.html#getOnChainState"><span class="hs-identifier hs-type">getOnChainState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838000"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837999"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837999"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837999"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837998"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837997"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837996"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838000"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837999"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837998"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Tx.DecoratedTxOut</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-230"></span><span id="getOnChainState"><span class="annot"><span class="annottext">getOnChainState :: StateMachineClient state i
-&gt; Contract
     w
     schema
     e
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
</span><a href="Plutus.Contract.StateMachine.html#getOnChainState"><span class="hs-identifier hs-var hs-var">getOnChainState</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837574"><span class="annot"><span class="annottext">StateMachineInstance state i
scInstance :: StateMachineInstance state i
scInstance :: forall s i. StateMachineClient s i -&gt; StateMachineInstance s i
</span><a href="#local-6989586621680837574"><span class="hs-identifier hs-var hs-var">scInstance</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837573"><span class="annot"><span class="annottext">[OnChainState state i]
-&gt; Either SMContractError (OnChainState state i)
scChooser :: [OnChainState state i]
-&gt; Either SMContractError (OnChainState state i)
scChooser :: forall s i.
StateMachineClient s i
-&gt; [OnChainState s i] -&gt; Either SMContractError (OnChainState s i)
</span><a href="#local-6989586621680837573"><span class="hs-identifier hs-var hs-var">scChooser</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SMContractError -&gt; e)
-&gt; Contract
     w
     schema
     SMContractError
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
-&gt; Contract
     w
     schema
     e
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="Plutus.Contract.Types.html#mapError"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e SMContractError -&gt; SMContractError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
forall r. AsSMContractError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMContractError"><span class="hs-identifier hs-var">_SMContractError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract
   w
   schema
   SMContractError
   (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
 -&gt; Contract
      w
      schema
      e
      (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)))
-&gt; Contract
     w
     schema
     SMContractError
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
-&gt; Contract
     w
     schema
     e
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>    </span><span id="local-6989586621680837572"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837572"><span class="hs-identifier hs-var">utxoTx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CardanoAddress
-&gt; Contract w schema SMContractError (Map TxOutRef DecoratedTxOut)
forall w (s :: Row *) e.
AsContractError e =&gt;
CardanoAddress -&gt; Contract w s e (Map TxOutRef DecoratedTxOut)
</span><a href="Plutus.Contract.Request.html#utxosAt"><span class="hs-identifier hs-var">utxosAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachineInstance state i -&gt; CardanoAddress
forall s i. StateMachineInstance s i -&gt; CardanoAddress
</span><a href="Plutus.Contract.StateMachine.OnChain.html#machineAddress"><span class="hs-identifier hs-var">SM.machineAddress</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
</span><a href="#local-6989586621680837574"><span class="hs-identifier hs-var">scInstance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837570"><span class="annot"><span class="annottext">states :: [OnChainState state i]
</span><a href="#local-6989586621680837570"><span class="hs-identifier hs-var hs-var">states</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
-&gt; Map TxOutRef DecoratedTxOut -&gt; [OnChainState state i]
forall s i.
(FromData s, ToData s) =&gt;
StateMachineInstance s i
-&gt; Map TxOutRef DecoratedTxOut -&gt; [OnChainState s i]
</span><a href="Plutus.Contract.StateMachine.html#getStates"><span class="hs-identifier hs-var">getStates</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
</span><a href="#local-6989586621680837574"><span class="hs-identifier hs-var">scInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837572"><span class="hs-identifier hs-var">utxoTx</span></a></span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[OnChainState state i]
</span><a href="#local-6989586621680837570"><span class="hs-identifier hs-var">states</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
-&gt; Contract
     w
     schema
     SMContractError
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">[OnChainState state i]
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[OnChainState state i]
-&gt; Either SMContractError (OnChainState state i)
</span><a href="#local-6989586621680837573"><span class="hs-identifier hs-var">scChooser</span></a></span><span> </span><span class="annot"><span class="annottext">[OnChainState state i]
</span><a href="#local-6989586621680837570"><span class="hs-identifier hs-var">states</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-236"></span><span>                </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680837569"><span class="annot"><span class="annottext">SMContractError
</span><a href="#local-6989586621680837569"><span class="hs-identifier hs-var">err</span></a></span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AReview SMContractError SMContractError
-&gt; SMContractError
-&gt; Contract
     w
     schema
     SMContractError
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
forall e (m :: * -&gt; *) t x.
MonadError e m =&gt;
AReview e t -&gt; t -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing</span></a></span><span> </span><span class="annot"><span class="annottext">AReview SMContractError SMContractError
forall r. AsSMContractError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMContractError"><span class="hs-identifier hs-var">_SMContractError</span></a></span><span> </span><span class="annot"><span class="annottext">SMContractError
</span><a href="#local-6989586621680837569"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-237"></span><span>                </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680837567"><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837567"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
-&gt; Contract
     w
     schema
     SMContractError
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
 -&gt; Contract
      w
      schema
      SMContractError
      (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)))
-&gt; Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
-&gt; Contract
     w
     schema
     SMContractError
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(OnChainState state i, Map TxOutRef DecoratedTxOut)
-&gt; Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837567"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837572"><span class="hs-identifier hs-var">utxoTx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | The outcome of 'waitForUpdateTimeout'</span><span>
</span><span id="line-240"></span><span id="local-6989586621680837565"><span id="local-6989586621680837566"></span></span><span class="hs-keyword">data</span><span> </span><span id="WaitingResult"><span class="annot"><a href="Plutus.Contract.StateMachine.html#WaitingResult"><span class="hs-identifier hs-var">WaitingResult</span></a></span></span><span> </span><span id="local-6989586621680837969"><span class="annot"><a href="#local-6989586621680837969"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680837968"><span class="annot"><a href="#local-6989586621680837968"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span id="local-6989586621680837970"><span class="annot"><a href="#local-6989586621680837970"><span class="hs-identifier hs-type">s</span></a></span></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-glyph">=</span><span> </span><span id="Timeout"><span class="annot"><a href="Plutus.Contract.StateMachine.html#Timeout"><span class="hs-identifier hs-var">Timeout</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680837969"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-comment">-- ^ The timeout happened before any change of the on-chain state was detected</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ContractEnded"><span class="annot"><a href="Plutus.Contract.StateMachine.html#ContractEnded"><span class="hs-identifier hs-var">ContractEnded</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680837968"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-comment">-- ^ The state machine instance ended</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="Transition"><span class="annot"><a href="Plutus.Contract.StateMachine.html#Transition"><span class="hs-identifier hs-var">Transition</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680837968"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837970"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-comment">-- ^ The state machine instance transitioned to a new state</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="InitialState"><span class="annot"><a href="Plutus.Contract.StateMachine.html#InitialState"><span class="hs-identifier hs-var">InitialState</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621680837970"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-comment">-- ^ The state machine instance was initialised</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837555"><span id="local-6989586621680837557"><span id="local-6989586621680837559"><span class="annot"><span class="annottext">Int -&gt; WaitingResult t i s -&gt; ShowS
[WaitingResult t i s] -&gt; ShowS
WaitingResult t i s -&gt; String
(Int -&gt; WaitingResult t i s -&gt; ShowS)
-&gt; (WaitingResult t i s -&gt; String)
-&gt; ([WaitingResult t i s] -&gt; ShowS)
-&gt; Show (WaitingResult t i s)
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
forall t i s.
(Show t, Show i, Show s) =&gt;
Int -&gt; WaitingResult t i s -&gt; ShowS
forall t i s.
(Show t, Show i, Show s) =&gt;
[WaitingResult t i s] -&gt; ShowS
forall t i s.
(Show t, Show i, Show s) =&gt;
WaitingResult t i s -&gt; String
showList :: [WaitingResult t i s] -&gt; ShowS
$cshowList :: forall t i s.
(Show t, Show i, Show s) =&gt;
[WaitingResult t i s] -&gt; ShowS
show :: WaitingResult t i s -&gt; String
$cshow :: forall t i s.
(Show t, Show i, Show s) =&gt;
WaitingResult t i s -&gt; String
showsPrec :: Int -&gt; WaitingResult t i s -&gt; ShowS
$cshowsPrec :: forall t i s.
(Show t, Show i, Show s) =&gt;
Int -&gt; WaitingResult t i s -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">(forall x. WaitingResult t i s -&gt; Rep (WaitingResult t i s) x)
-&gt; (forall x. Rep (WaitingResult t i s) x -&gt; WaitingResult t i s)
-&gt; Generic (WaitingResult t i s)
forall x. Rep (WaitingResult t i s) x -&gt; WaitingResult t i s
forall x. WaitingResult t i s -&gt; Rep (WaitingResult t i s) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall t i s x. Rep (WaitingResult t i s) x -&gt; WaitingResult t i s
forall t i s x. WaitingResult t i s -&gt; Rep (WaitingResult t i s) x
$cto :: forall t i s x. Rep (WaitingResult t i s) x -&gt; WaitingResult t i s
$cfrom :: forall t i s x. WaitingResult t i s -&gt; Rep (WaitingResult t i s) x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span id="local-6989586621680837549"><span id="local-6989586621680837551"><span class="annot"><span class="annottext">a -&gt; WaitingResult t i b -&gt; WaitingResult t i a
(a -&gt; b) -&gt; WaitingResult t i a -&gt; WaitingResult t i b
(forall a b.
 (a -&gt; b) -&gt; WaitingResult t i a -&gt; WaitingResult t i b)
-&gt; (forall a b. a -&gt; WaitingResult t i b -&gt; WaitingResult t i a)
-&gt; Functor (WaitingResult t i)
forall a b. a -&gt; WaitingResult t i b -&gt; WaitingResult t i a
forall a b. (a -&gt; b) -&gt; WaitingResult t i a -&gt; WaitingResult t i b
forall t i a b. a -&gt; WaitingResult t i b -&gt; WaitingResult t i a
forall t i a b.
(a -&gt; b) -&gt; WaitingResult t i a -&gt; WaitingResult t i b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; WaitingResult t i b -&gt; WaitingResult t i a
$c&lt;$ :: forall t i a b. a -&gt; WaitingResult t i b -&gt; WaitingResult t i a
fmap :: (a -&gt; b) -&gt; WaitingResult t i a -&gt; WaitingResult t i b
$cfmap :: forall t i a b.
(a -&gt; b) -&gt; WaitingResult t i a -&gt; WaitingResult t i b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837540"><span id="local-6989586621680837542"><span id="local-6989586621680837544"><span id="local-6989586621680837546"><span class="annot"><span class="annottext">[WaitingResult t i s] -&gt; Encoding
[WaitingResult t i s] -&gt; Value
WaitingResult t i s -&gt; Encoding
WaitingResult t i s -&gt; Value
(WaitingResult t i s -&gt; Value)
-&gt; (WaitingResult t i s -&gt; Encoding)
-&gt; ([WaitingResult t i s] -&gt; Value)
-&gt; ([WaitingResult t i s] -&gt; Encoding)
-&gt; ToJSON (WaitingResult t i s)
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
[WaitingResult t i s] -&gt; Encoding
forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
[WaitingResult t i s] -&gt; Value
forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
WaitingResult t i s -&gt; Encoding
forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
WaitingResult t i s -&gt; Value
toEncodingList :: [WaitingResult t i s] -&gt; Encoding
$ctoEncodingList :: forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
[WaitingResult t i s] -&gt; Encoding
toJSONList :: [WaitingResult t i s] -&gt; Value
$ctoJSONList :: forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
[WaitingResult t i s] -&gt; Value
toEncoding :: WaitingResult t i s -&gt; Encoding
$ctoEncoding :: forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
WaitingResult t i s -&gt; Encoding
toJSON :: WaitingResult t i s -&gt; Value
$ctoJSON :: forall t i s.
(ToJSON s, ToJSON i, ToJSON t) =&gt;
WaitingResult t i s -&gt; Value
</span><a href="#local-6989586621680837540"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837536"><span id="local-6989586621680837538"><span class="annot"><span class="annottext">Value -&gt; Parser [WaitingResult t i s]
Value -&gt; Parser (WaitingResult t i s)
(Value -&gt; Parser (WaitingResult t i s))
-&gt; (Value -&gt; Parser [WaitingResult t i s])
-&gt; FromJSON (WaitingResult t i s)
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
forall t i s.
(FromJSON s, FromJSON t, FromJSON i) =&gt;
Value -&gt; Parser [WaitingResult t i s]
forall t i s.
(FromJSON s, FromJSON t, FromJSON i) =&gt;
Value -&gt; Parser (WaitingResult t i s)
parseJSONList :: Value -&gt; Parser [WaitingResult t i s]
$cparseJSONList :: forall t i s.
(FromJSON s, FromJSON t, FromJSON i) =&gt;
Value -&gt; Parser [WaitingResult t i s]
parseJSON :: Value -&gt; Parser (WaitingResult t i s)
$cparseJSON :: forall t i s.
(FromJSON s, FromJSON t, FromJSON i) =&gt;
Value -&gt; Parser (WaitingResult t i s)
</span><a href="#local-6989586621680837536"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-comment">-- | Wait for the on-chain state of the state machine instance to change until timeoutSlot,</span><span>
</span><span id="line-249"></span><span class="hs-comment">--   and return the new state, or return 'ContractEnded' if the instance has been</span><span>
</span><span id="line-250"></span><span class="hs-comment">--   terminated. If 'waitForUpdate' is called before the instance has even</span><span>
</span><span id="line-251"></span><span class="hs-comment">--   started then it returns the first state of the instance as soon as it</span><span>
</span><span id="line-252"></span><span class="hs-comment">--   has started.</span><span>
</span><span id="line-253"></span><span id="local-6989586621680837531"><span id="local-6989586621680837532"><span id="local-6989586621680837533"><span id="local-6989586621680837534"><span id="local-6989586621680837535"><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdateUntilSlot"><span class="hs-identifier hs-type">waitForUpdateUntilSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837535"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Error.html#AsContractError"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837535"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837534"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837534"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837533"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837534"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837533"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837532"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837531"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837535"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#WaitingResult"><span class="hs-identifier hs-type">WaitingResult</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837533"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837534"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-263"></span><span id="waitForUpdateUntilSlot"><span class="annot"><span class="annottext">waitForUpdateUntilSlot :: StateMachineClient state i
-&gt; Slot -&gt; Contract w schema e (WaitingResult Slot i state)
</span><a href="Plutus.Contract.StateMachine.html#waitForUpdateUntilSlot"><span class="hs-identifier hs-var hs-var">waitForUpdateUntilSlot</span></a></span></span><span> </span><span id="local-6989586621680837530"><span class="annot"><span class="annottext">StateMachineClient state i
</span><a href="#local-6989586621680837530"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span id="local-6989586621680837529"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680837529"><span class="hs-identifier hs-var">timeoutSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-264"></span><span>  </span><span id="local-6989586621680837528"><span class="annot"><span class="annottext">WaitingResult Slot i (OnChainState state i)
</span><a href="#local-6989586621680837528"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
-&gt; Promise w schema e Slot
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult Slot i (OnChainState state i)))
forall state i t w (schema :: Row *) e.
(AsSMContractError e, AsContractError e, FromData state,
 ToData state, FromData i) =&gt;
StateMachineClient state i
-&gt; Promise w schema e t
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult t i (OnChainState state i)))
</span><a href="Plutus.Contract.StateMachine.html#waitForUpdateTimeout"><span class="hs-identifier hs-var">waitForUpdateTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
</span><a href="#local-6989586621680837530"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot -&gt; Promise w schema e Slot
forall w (s :: Row *) e.
AsContractError e =&gt;
Slot -&gt; Promise w s e Slot
</span><a href="Plutus.Contract.Request.html#isSlot"><span class="hs-identifier hs-var">isSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680837529"><span class="hs-identifier hs-var">timeoutSlot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Contract
  w
  schema
  e
  (Promise w schema e (WaitingResult Slot i (OnChainState state i)))
-&gt; (Promise
      w schema e (WaitingResult Slot i (OnChainState state i))
    -&gt; Contract
         w schema e (WaitingResult Slot i (OnChainState state i)))
-&gt; Contract
     w schema e (WaitingResult Slot i (OnChainState state i))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Promise w schema e (WaitingResult Slot i (OnChainState state i))
-&gt; Contract
     w schema e (WaitingResult Slot i (OnChainState state i))
forall w (s :: Row *) e a. Promise w s e a -&gt; Contract w s e a
</span><a href="Plutus.Contract.Types.html#awaitPromise"><span class="hs-identifier hs-var hs-var">awaitPromise</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><span class="annottext">WaitingResult Slot i state
-&gt; Contract w schema e (WaitingResult Slot i state)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(WaitingResult Slot i state
 -&gt; Contract w schema e (WaitingResult Slot i state))
-&gt; WaitingResult Slot i state
-&gt; Contract w schema e (WaitingResult Slot i state)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(OnChainState state i -&gt; state)
-&gt; WaitingResult Slot i (OnChainState state i)
-&gt; WaitingResult Slot i state
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state i -&gt; state
forall s i. OnChainState s i -&gt; s
</span><a href="Plutus.Contract.StateMachine.html#getStateData"><span class="hs-identifier hs-var">getStateData</span></a></span><span> </span><span class="annot"><span class="annottext">WaitingResult Slot i (OnChainState state i)
</span><a href="#local-6989586621680837528"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="hs-comment">-- | Same as 'waitForUpdateUntilSlot', but works with 'POSIXTime' instead.</span><span>
</span><span id="line-268"></span><span id="local-6989586621680837523"><span id="local-6989586621680837524"><span id="local-6989586621680837525"><span id="local-6989586621680837526"><span id="local-6989586621680837527"><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdateUntilTime"><span class="hs-identifier hs-type">waitForUpdateUntilTime</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837527"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-270"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Error.html#AsContractError"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837527"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837526"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837526"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837525"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837526"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837525"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837524"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837523"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837527"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#WaitingResult"><span class="hs-identifier hs-type">WaitingResult</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837525"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837526"><span class="hs-identifier hs-type">state</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-278"></span><span id="waitForUpdateUntilTime"><span class="annot"><span class="annottext">waitForUpdateUntilTime :: StateMachineClient state i
-&gt; POSIXTime
-&gt; Contract w schema e (WaitingResult POSIXTime i state)
</span><a href="Plutus.Contract.StateMachine.html#waitForUpdateUntilTime"><span class="hs-identifier hs-var hs-var">waitForUpdateUntilTime</span></a></span></span><span> </span><span id="local-6989586621680837522"><span class="annot"><span class="annottext">StateMachineClient state i
</span><a href="#local-6989586621680837522"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span id="local-6989586621680837521"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680837521"><span class="hs-identifier hs-var">timeoutTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-279"></span><span>  </span><span id="local-6989586621680837520"><span class="annot"><span class="annottext">WaitingResult POSIXTime i (OnChainState state i)
</span><a href="#local-6989586621680837520"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
-&gt; Promise w schema e POSIXTime
-&gt; Contract
     w
     schema
     e
     (Promise
        w schema e (WaitingResult POSIXTime i (OnChainState state i)))
forall state i t w (schema :: Row *) e.
(AsSMContractError e, AsContractError e, FromData state,
 ToData state, FromData i) =&gt;
StateMachineClient state i
-&gt; Promise w schema e t
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult t i (OnChainState state i)))
</span><a href="Plutus.Contract.StateMachine.html#waitForUpdateTimeout"><span class="hs-identifier hs-var">waitForUpdateTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
</span><a href="#local-6989586621680837522"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime -&gt; Promise w schema e POSIXTime
forall w (s :: Row *) e.
AsContractError e =&gt;
POSIXTime -&gt; Promise w s e POSIXTime
</span><a href="Plutus.Contract.Request.html#isTime"><span class="hs-identifier hs-var">isTime</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680837521"><span class="hs-identifier hs-var">timeoutTime</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Contract
  w
  schema
  e
  (Promise
     w schema e (WaitingResult POSIXTime i (OnChainState state i)))
-&gt; (Promise
      w schema e (WaitingResult POSIXTime i (OnChainState state i))
    -&gt; Contract
         w schema e (WaitingResult POSIXTime i (OnChainState state i)))
-&gt; Contract
     w schema e (WaitingResult POSIXTime i (OnChainState state i))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Promise
  w schema e (WaitingResult POSIXTime i (OnChainState state i))
-&gt; Contract
     w schema e (WaitingResult POSIXTime i (OnChainState state i))
forall w (s :: Row *) e a. Promise w s e a -&gt; Contract w s e a
</span><a href="Plutus.Contract.Types.html#awaitPromise"><span class="hs-identifier hs-var hs-var">awaitPromise</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><span class="annottext">WaitingResult POSIXTime i state
-&gt; Contract w schema e (WaitingResult POSIXTime i state)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(WaitingResult POSIXTime i state
 -&gt; Contract w schema e (WaitingResult POSIXTime i state))
-&gt; WaitingResult POSIXTime i state
-&gt; Contract w schema e (WaitingResult POSIXTime i state)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(OnChainState state i -&gt; state)
-&gt; WaitingResult POSIXTime i (OnChainState state i)
-&gt; WaitingResult POSIXTime i state
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state i -&gt; state
forall s i. OnChainState s i -&gt; s
</span><a href="Plutus.Contract.StateMachine.html#getStateData"><span class="hs-identifier hs-var">getStateData</span></a></span><span> </span><span class="annot"><span class="annottext">WaitingResult POSIXTime i (OnChainState state i)
</span><a href="#local-6989586621680837520"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- | Wait until the on-chain state of the state machine instance has changed,</span><span>
</span><span id="line-283"></span><span class="hs-comment">--   and return the new state, or return 'Nothing' if the instance has been</span><span>
</span><span id="line-284"></span><span class="hs-comment">--   terminated. If 'waitForUpdate' is called before the instance has even</span><span>
</span><span id="line-285"></span><span class="hs-comment">--   started then it returns the first state of the instance as soon as it</span><span>
</span><span id="line-286"></span><span class="hs-comment">--   has started.</span><span>
</span><span id="line-287"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdate"><span class="hs-identifier hs-type">waitForUpdate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837519"><span class="annot"><a href="#local-6989586621680837519"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837518"><span class="annot"><a href="#local-6989586621680837518"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span id="local-6989586621680837517"><span class="annot"><a href="#local-6989586621680837517"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837516"><span class="annot"><a href="#local-6989586621680837516"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837515"><span class="annot"><a href="#local-6989586621680837515"><span class="hs-identifier hs-type">e</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837515"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Error.html#AsContractError"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837515"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837519"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837519"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837518"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837519"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837518"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837517"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837516"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837515"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837519"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837518"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span id="waitForUpdate"><span class="annot"><span class="annottext">waitForUpdate :: StateMachineClient state i
-&gt; Contract w schema e (Maybe (OnChainState state i))
</span><a href="Plutus.Contract.StateMachine.html#waitForUpdate"><span class="hs-identifier hs-var hs-var">waitForUpdate</span></a></span></span><span> </span><span id="local-6989586621680837514"><span class="annot"><span class="annottext">StateMachineClient state i
</span><a href="#local-6989586621680837514"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621680837513"><span class="annot"><span class="annottext">WaitingResult Void i (OnChainState state i)
</span><a href="#local-6989586621680837513"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
-&gt; Promise w schema e Void
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult Void i (OnChainState state i)))
forall state i t w (schema :: Row *) e.
(AsSMContractError e, AsContractError e, FromData state,
 ToData state, FromData i) =&gt;
StateMachineClient state i
-&gt; Promise w schema e t
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult t i (OnChainState state i)))
</span><a href="Plutus.Contract.StateMachine.html#waitForUpdateTimeout"><span class="hs-identifier hs-var">waitForUpdateTimeout</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
</span><a href="#local-6989586621680837514"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="annot"><span class="annottext">Promise w schema e Void
forall w (s :: Row *) e a. Promise w s e a
</span><a href="Plutus.Contract.Types.html#never"><span class="hs-identifier hs-var">never</span></a></span><span> </span><span class="annot"><span class="annottext">Contract
  w
  schema
  e
  (Promise w schema e (WaitingResult Void i (OnChainState state i)))
-&gt; (Promise
      w schema e (WaitingResult Void i (OnChainState state i))
    -&gt; Contract
         w schema e (WaitingResult Void i (OnChainState state i)))
-&gt; Contract
     w schema e (WaitingResult Void i (OnChainState state i))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Promise w schema e (WaitingResult Void i (OnChainState state i))
-&gt; Contract
     w schema e (WaitingResult Void i (OnChainState state i))
forall w (s :: Row *) e a. Promise w s e a -&gt; Contract w s e a
</span><a href="Plutus.Contract.Types.html#awaitPromise"><span class="hs-identifier hs-var hs-var">awaitPromise</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">WaitingResult Void i (OnChainState state i)
</span><a href="#local-6989586621680837513"><span class="hs-identifier hs-var">result</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#Timeout"><span class="hs-identifier hs-type">Timeout</span></a></span><span> </span><span id="local-6989586621680837512"><span class="annot"><span class="annottext">Void
</span><a href="#local-6989586621680837512"><span class="hs-identifier hs-var">t</span></a></span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Void -&gt; Contract w schema e (Maybe (OnChainState state i))
forall a. Void -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">absurd</span></a></span><span> </span><span class="annot"><span class="annottext">Void
</span><a href="#local-6989586621680837512"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#ContractEnded"><span class="hs-identifier hs-type">ContractEnded</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i)
-&gt; Contract w schema e (Maybe (OnChainState state i))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i)
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#InitialState"><span class="hs-identifier hs-type">InitialState</span></a></span><span> </span><span id="local-6989586621680837511"><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837511"><span class="hs-identifier hs-var">r</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i)
-&gt; Contract w schema e (Maybe (OnChainState state i))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OnChainState state i -&gt; Maybe (OnChainState state i)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837511"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#Transition"><span class="hs-identifier hs-type">Transition</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680837510"><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837510"><span class="hs-identifier hs-var">r</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i)
-&gt; Contract w schema e (Maybe (OnChainState state i))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OnChainState state i -&gt; Maybe (OnChainState state i)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837510"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="hs-comment">-- | Construct a 'Promise' that waits for an update to the state machine's</span><span>
</span><span id="line-306"></span><span class="hs-comment">--   on-chain state, or a user-defined timeout (whichever happens first).</span><span>
</span><span id="line-307"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#waitForUpdateTimeout"><span class="hs-identifier hs-type">waitForUpdateTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-308"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680838043"><span class="annot"><a href="#local-6989586621680838043"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680838042"><span class="annot"><a href="#local-6989586621680838042"><span class="hs-identifier hs-type">i</span></a></span></span><span> </span><span id="local-6989586621680838039"><span class="annot"><a href="#local-6989586621680838039"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span id="local-6989586621680838041"><span class="annot"><a href="#local-6989586621680838041"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680838040"><span class="annot"><a href="#local-6989586621680838040"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680838044"><span class="annot"><a href="#local-6989586621680838044"><span class="hs-identifier hs-type">e</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838044"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-310"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.Error.html#AsContractError"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838044"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838043"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838043"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838042"><span class="hs-identifier hs-type">i</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838043"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838042"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-comment">-- ^ The state machine client</span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Promise"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838041"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838040"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838044"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838039"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-comment">-- ^ The timeout</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838041"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838040"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838044"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.Types.html#Promise"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838041"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838040"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838044"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#WaitingResult"><span class="hs-identifier hs-type">WaitingResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838039"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838042"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838043"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680838042"><span class="hs-identifier hs-type">i</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span id="waitForUpdateTimeout"><span class="annot"><span class="annottext">waitForUpdateTimeout :: StateMachineClient state i
-&gt; Promise w schema e t
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult t i (OnChainState state i)))
</span><a href="Plutus.Contract.StateMachine.html#waitForUpdateTimeout"><span class="hs-identifier hs-var hs-var">waitForUpdateTimeout</span></a></span></span><span> </span><span id="local-6989586621680837509"><span class="annot"><span class="annottext">client :: StateMachineClient state i
</span><a href="#local-6989586621680837509"><span class="hs-identifier hs-var">client</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837508"><span class="annot"><span class="annottext">StateMachineInstance state i
scInstance :: StateMachineInstance state i
scInstance :: forall s i. StateMachineClient s i -&gt; StateMachineInstance s i
</span><a href="#local-6989586621680837508"><span class="hs-identifier hs-var hs-var">scInstance</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837507"><span class="annot"><span class="annottext">[OnChainState state i]
-&gt; Either SMContractError (OnChainState state i)
scChooser :: [OnChainState state i]
-&gt; Either SMContractError (OnChainState state i)
scChooser :: forall s i.
StateMachineClient s i
-&gt; [OnChainState s i] -&gt; Either SMContractError (OnChainState s i)
</span><a href="#local-6989586621680837507"><span class="hs-identifier hs-var hs-var">scChooser</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680837506"><span class="annot"><span class="annottext">Promise w schema e t
</span><a href="#local-6989586621680837506"><span class="hs-identifier hs-var">timeout</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621680837505"><span class="annot"><span class="annottext">Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
</span><a href="#local-6989586621680837505"><span class="hs-identifier hs-var">currentState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
-&gt; Contract
     w
     schema
     e
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
forall e state i w (schema :: Row *).
(AsSMContractError e, FromData state, ToData state) =&gt;
StateMachineClient state i
-&gt; Contract
     w
     schema
     e
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
</span><a href="Plutus.Contract.StateMachine.html#getOnChainState"><span class="hs-identifier hs-var">getOnChainState</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state i
</span><a href="#local-6989586621680837509"><span class="hs-identifier hs-var">client</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837504"><span class="annot"><span class="annottext">projectFst :: (a, (b, b)) -&gt; (a, b)
</span><a href="#local-6989586621680837504"><span class="hs-identifier hs-var hs-var">projectFst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680837503"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680837503"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837502"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680837502"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680837503"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621680837502"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837501"><span class="annot"><span class="annottext">success :: Promise w schema e (WaitingResult t i (OnChainState state i))
</span><a href="#local-6989586621680837501"><span class="hs-identifier hs-var hs-var">success</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
</span><a href="#local-6989586621680837505"><span class="hs-identifier hs-var">currentState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-322"></span><span>                    </span><span class="annot"><span class="annottext">Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-323"></span><span>                        </span><span class="hs-comment">-- There is no on-chain state, so we wait for an output to appear</span><span>
</span><span id="line-324"></span><span>                        </span><span class="hs-comment">-- at the address. Any output that appears needs to be checked</span><span>
</span><span id="line-325"></span><span>                        </span><span class="hs-comment">-- with scChooser'</span><span>
</span><span id="line-326"></span><span>                        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837500"><span class="annot"><span class="annottext">addr :: CardanoAddress
</span><a href="#local-6989586621680837500"><span class="hs-identifier hs-var hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i -&gt; CardanoAddress
forall s i. StateMachineInstance s i -&gt; CardanoAddress
</span><a href="Plutus.Contract.StateMachine.OnChain.html#machineAddress"><span class="hs-identifier hs-var">SM.machineAddress</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
</span><a href="#local-6989586621680837508"><span class="hs-identifier hs-var">scInstance</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-327"></span><span>                        </span><span class="annot"><span class="annottext">Promise w schema e (NonEmpty ChainIndexTx)
-&gt; (NonEmpty ChainIndexTx
    -&gt; Contract w schema e (WaitingResult t i (OnChainState state i)))
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
forall w (s :: Row *) e a b.
Promise w s e a -&gt; (a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="Plutus.Contract.Types.html#promiseBind"><span class="hs-identifier hs-var">promiseBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CardanoAddress -&gt; Promise w schema e (NonEmpty ChainIndexTx)
forall w (s :: Row *) e.
AsContractError e =&gt;
CardanoAddress -&gt; Promise w s e (NonEmpty ChainIndexTx)
</span><a href="Plutus.Contract.Request.html#utxoIsProduced"><span class="hs-identifier hs-var">utxoIsProduced</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621680837500"><span class="hs-identifier hs-var">addr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((NonEmpty ChainIndexTx
  -&gt; Contract w schema e (WaitingResult t i (OnChainState state i)))
 -&gt; Promise w schema e (WaitingResult t i (OnChainState state i)))
-&gt; (NonEmpty ChainIndexTx
    -&gt; Contract w schema e (WaitingResult t i (OnChainState state i)))
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680837499"><span class="annot"><span class="annottext">NonEmpty ChainIndexTx
</span><a href="#local-6989586621680837499"><span class="hs-identifier hs-var">txns</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>                            </span><span id="local-6989586621680837498"><span class="annot"><span class="annottext">NonEmpty [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
</span><a href="#local-6989586621680837498"><span class="hs-identifier hs-var">outRefMaps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ChainIndexTx
 -&gt; Contract
      w schema e [(TxOutRef, (DecoratedTxOut, ChainIndexTx))])
-&gt; NonEmpty ChainIndexTx
-&gt; Contract
     w schema e (NonEmpty [(TxOutRef, (DecoratedTxOut, ChainIndexTx))])
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexTx
-&gt; Contract w schema e [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
forall e w (s :: Row *).
AsContractError e =&gt;
ChainIndexTx
-&gt; Contract w s e [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
</span><a href="Plutus.Contract.Request.html#utxosTxOutTxFromTx"><span class="hs-identifier hs-var">utxosTxOutTxFromTx</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty ChainIndexTx
</span><a href="#local-6989586621680837499"><span class="hs-identifier hs-var">txns</span></a></span><span>
</span><span id="line-329"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837496"><span class="annot"><span class="annottext">produced :: [OnChainState state i]
</span><a href="#local-6989586621680837496"><span class="hs-identifier hs-var hs-var">produced</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
-&gt; Map TxOutRef DecoratedTxOut -&gt; [OnChainState state i]
forall s i.
(FromData s, ToData s) =&gt;
StateMachineInstance s i
-&gt; Map TxOutRef DecoratedTxOut -&gt; [OnChainState s i]
</span><a href="Plutus.Contract.StateMachine.html#getStates"><span class="hs-identifier hs-var">getStates</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680838043"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680838042"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
</span><a href="#local-6989586621680837508"><span class="hs-identifier hs-var">scInstance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TxOutRef, DecoratedTxOut)] -&gt; Map TxOutRef DecoratedTxOut
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(TxOutRef, DecoratedTxOut)] -&gt; Map TxOutRef DecoratedTxOut)
-&gt; [(TxOutRef, DecoratedTxOut)] -&gt; Map TxOutRef DecoratedTxOut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((TxOutRef, (DecoratedTxOut, ChainIndexTx))
 -&gt; (TxOutRef, DecoratedTxOut))
-&gt; [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
-&gt; [(TxOutRef, DecoratedTxOut)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOutRef, (DecoratedTxOut, ChainIndexTx))
-&gt; (TxOutRef, DecoratedTxOut)
forall a b b. (a, (b, b)) -&gt; (a, b)
</span><a href="#local-6989586621680837504"><span class="hs-identifier hs-var">projectFst</span></a></span><span> </span><span class="annot"><span class="annottext">([(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
 -&gt; [(TxOutRef, DecoratedTxOut)])
-&gt; [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
-&gt; [(TxOutRef, DecoratedTxOut)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
-&gt; [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
</span><a href="#local-6989586621680837498"><span class="hs-identifier hs-var">outRefMaps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span>                            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[OnChainState state i]
-&gt; Either SMContractError (OnChainState state i)
</span><a href="#local-6989586621680837507"><span class="hs-identifier hs-var">scChooser</span></a></span><span> </span><span class="annot"><span class="annottext">[OnChainState state i]
</span><a href="#local-6989586621680837496"><span class="hs-identifier hs-var">produced</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-331"></span><span>                                </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680837493"><span class="annot"><span class="annottext">SMContractError
</span><a href="#local-6989586621680837493"><span class="hs-identifier hs-var">e</span></a></span></span><span>             </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
-&gt; SMContractError
-&gt; Contract w schema e (WaitingResult t i (OnChainState state i))
forall e (m :: * -&gt; *) t x.
MonadError e m =&gt;
AReview e t -&gt; t -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
forall r. AsSMContractError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMContractError"><span class="hs-identifier hs-var">_SMContractError</span></a></span><span> </span><span class="annot"><span class="annottext">SMContractError
</span><a href="#local-6989586621680837493"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-332"></span><span>                                </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680837492"><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837492"><span class="hs-identifier hs-var">onChainState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WaitingResult t i (OnChainState state i)
-&gt; Contract w schema e (WaitingResult t i (OnChainState state i))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(WaitingResult t i (OnChainState state i)
 -&gt; Contract w schema e (WaitingResult t i (OnChainState state i)))
-&gt; WaitingResult t i (OnChainState state i)
-&gt; Contract w schema e (WaitingResult t i (OnChainState state i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state i -&gt; WaitingResult t i (OnChainState state i)
forall t i s. s -&gt; WaitingResult t i s
</span><a href="Plutus.Contract.StateMachine.html#InitialState"><span class="hs-identifier hs-var">InitialState</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837492"><span class="hs-identifier hs-var">onChainState</span></a></span><span>
</span><span id="line-333"></span><span>                    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837491"><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state i)
ocsTxOutRef :: TypedScriptTxOutRef (StateMachine state i)
ocsTxOutRef :: forall s i.
OnChainState s i -&gt; TypedScriptTxOutRef (StateMachine s i)
</span><a href="#local-6989586621680837491"><span class="hs-identifier hs-var hs-var">ocsTxOutRef</span></a></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-334"></span><span>                        </span><span class="annot"><span class="annottext">Promise w schema e ChainIndexTx
-&gt; (ChainIndexTx
    -&gt; Contract w schema e (WaitingResult t i (OnChainState state i)))
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
forall w (s :: Row *) e a b.
Promise w s e a -&gt; (a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="Plutus.Contract.Types.html#promiseBind"><span class="hs-identifier hs-var">promiseBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOutRef -&gt; Promise w schema e ChainIndexTx
forall w (s :: Row *) e.
AsContractError e =&gt;
TxOutRef -&gt; Promise w s e ChainIndexTx
</span><a href="Plutus.Contract.Request.html#utxoIsSpent"><span class="hs-identifier hs-var">utxoIsSpent</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state i) -&gt; TxOutRef
forall a. TypedScriptTxOutRef a -&gt; TxOutRef
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutRefRef</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state i)
</span><a href="#local-6989586621680837491"><span class="hs-identifier hs-var">ocsTxOutRef</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((ChainIndexTx
  -&gt; Contract w schema e (WaitingResult t i (OnChainState state i)))
 -&gt; Promise w schema e (WaitingResult t i (OnChainState state i)))
-&gt; (ChainIndexTx
    -&gt; Contract w schema e (WaitingResult t i (OnChainState state i)))
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680837489"><span class="annot"><span class="annottext">ChainIndexTx
</span><a href="#local-6989586621680837489"><span class="hs-identifier hs-var">txn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>                            </span><span id="local-6989586621680837488"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837488"><span class="hs-identifier hs-var">outRefMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(TxOutRef, DecoratedTxOut)] -&gt; Map TxOutRef DecoratedTxOut
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(TxOutRef, DecoratedTxOut)] -&gt; Map TxOutRef DecoratedTxOut)
-&gt; ([(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
    -&gt; [(TxOutRef, DecoratedTxOut)])
-&gt; [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
-&gt; Map TxOutRef DecoratedTxOut
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((TxOutRef, (DecoratedTxOut, ChainIndexTx))
 -&gt; (TxOutRef, DecoratedTxOut))
-&gt; [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
-&gt; [(TxOutRef, DecoratedTxOut)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOutRef, (DecoratedTxOut, ChainIndexTx))
-&gt; (TxOutRef, DecoratedTxOut)
forall a b b. (a, (b, b)) -&gt; (a, b)
</span><a href="#local-6989586621680837504"><span class="hs-identifier hs-var">projectFst</span></a></span><span> </span><span class="annot"><span class="annottext">([(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
 -&gt; Map TxOutRef DecoratedTxOut)
-&gt; Contract w schema e [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
-&gt; Contract w schema e (Map TxOutRef DecoratedTxOut)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexTx
-&gt; Contract w schema e [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
forall e w (s :: Row *).
AsContractError e =&gt;
ChainIndexTx
-&gt; Contract w s e [(TxOutRef, (DecoratedTxOut, ChainIndexTx))]
</span><a href="Plutus.Contract.Request.html#utxosTxOutTxFromTx"><span class="hs-identifier hs-var">utxosTxOutTxFromTx</span></a></span><span> </span><span class="annot"><span class="annottext">ChainIndexTx
</span><a href="#local-6989586621680837489"><span class="hs-identifier hs-var">txn</span></a></span><span>
</span><span id="line-336"></span><span>                            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837486"><span class="annot"><span class="annottext">newStates :: [OnChainState state i]
</span><a href="#local-6989586621680837486"><span class="hs-identifier hs-var hs-var">newStates</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
-&gt; Map TxOutRef DecoratedTxOut -&gt; [OnChainState state i]
forall s i.
(FromData s, ToData s) =&gt;
StateMachineInstance s i
-&gt; Map TxOutRef DecoratedTxOut -&gt; [OnChainState s i]
</span><a href="Plutus.Contract.StateMachine.html#getStates"><span class="hs-identifier hs-var">getStates</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680838043"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680838042"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state i
</span><a href="#local-6989586621680837508"><span class="hs-identifier hs-var">scInstance</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837488"><span class="hs-identifier hs-var">outRefMap</span></a></span><span>
</span><span id="line-337"></span><span>                                </span><span id="local-6989586621680837485"><span class="annot"><span class="annottext">inp :: Maybe i
</span><a href="#local-6989586621680837485"><span class="hs-identifier hs-var hs-var">inp</span></a></span></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; ChainIndexTx -&gt; Maybe i
forall i. FromData i =&gt; TxOutRef -&gt; ChainIndexTx -&gt; Maybe i
</span><a href="Plutus.Contract.StateMachine.html#getInput"><span class="hs-identifier hs-var">getInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state i) -&gt; TxOutRef
forall a. TypedScriptTxOutRef a -&gt; TxOutRef
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutRefRef</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state i)
</span><a href="#local-6989586621680837491"><span class="hs-identifier hs-var">ocsTxOutRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ChainIndexTx
</span><a href="#local-6989586621680837489"><span class="hs-identifier hs-var">txn</span></a></span><span>
</span><span id="line-338"></span><span>                            </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[OnChainState state i]
</span><a href="#local-6989586621680837486"><span class="hs-identifier hs-var">newStates</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe i
</span><a href="#local-6989586621680837485"><span class="hs-identifier hs-var">inp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-339"></span><span>                                </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680837484"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621680837484"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WaitingResult t i (OnChainState state i)
-&gt; Contract w schema e (WaitingResult t i (OnChainState state i))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i -&gt; WaitingResult t i (OnChainState state i)
forall t i s. i -&gt; WaitingResult t i s
</span><a href="Plutus.Contract.StateMachine.html#ContractEnded"><span class="hs-identifier hs-var">ContractEnded</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621680837484"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>                                </span><span class="hs-special">(</span><span id="local-6989586621680837483"><span class="annot"><span class="annottext">[OnChainState state i]
</span><a href="#local-6989586621680837483"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680837482"><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621680837482"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[OnChainState state i]
-&gt; Either SMContractError (OnChainState state i)
</span><a href="#local-6989586621680837507"><span class="hs-identifier hs-var">scChooser</span></a></span><span> </span><span class="annot"><span class="annottext">[OnChainState state i]
</span><a href="#local-6989586621680837483"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-341"></span><span>                                    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680837481"><span class="annot"><span class="annottext">SMContractError
</span><a href="#local-6989586621680837481"><span class="hs-identifier hs-var">e</span></a></span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
-&gt; SMContractError
-&gt; Contract w schema e (WaitingResult t i (OnChainState state i))
forall e (m :: * -&gt; *) t x.
MonadError e m =&gt;
AReview e t -&gt; t -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
forall r. AsSMContractError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMContractError"><span class="hs-identifier hs-var">_SMContractError</span></a></span><span> </span><span class="annot"><span class="annottext">SMContractError
</span><a href="#local-6989586621680837481"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-342"></span><span>                                    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680837480"><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837480"><span class="hs-identifier hs-var">newState</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">WaitingResult t i (OnChainState state i)
-&gt; Contract w schema e (WaitingResult t i (OnChainState state i))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">i
-&gt; OnChainState state i -&gt; WaitingResult t i (OnChainState state i)
forall t i s. i -&gt; s -&gt; WaitingResult t i s
</span><a href="Plutus.Contract.StateMachine.html#Transition"><span class="hs-identifier hs-var">Transition</span></a></span><span> </span><span class="annot"><span class="annottext">i
</span><a href="#local-6989586621680837482"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state i
</span><a href="#local-6989586621680837480"><span class="hs-identifier hs-var">newState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-343"></span><span>                                </span><span class="annot"><span class="annottext">([OnChainState state i], Maybe i)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AReview e ()
-&gt; Contract w schema e (WaitingResult t i (OnChainState state i))
forall e (m :: * -&gt; *) x. MonadError e m =&gt; AReview e () -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing_</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e ()
forall r. AsSMContractError r =&gt; Prism' r ()
</span><a href="Plutus.Contract.StateMachine.html#_UnableToExtractTransition"><span class="hs-identifier hs-var">_UnableToExtractTransition</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><span class="annottext">Promise w schema e (WaitingResult t i (OnChainState state i))
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult t i (OnChainState state i)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Promise w schema e (WaitingResult t i (OnChainState state i))
 -&gt; Contract
      w
      schema
      e
      (Promise w schema e (WaitingResult t i (OnChainState state i))))
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
-&gt; Contract
     w
     schema
     e
     (Promise w schema e (WaitingResult t i (OnChainState state i)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Promise w schema e (WaitingResult t i (OnChainState state i))
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
forall w (s :: Row *) e a.
Promise w s e a -&gt; Promise w s e a -&gt; Promise w s e a
</span><a href="Plutus.Contract.Types.html#select"><span class="hs-identifier hs-var">select</span></a></span><span> </span><span class="annot"><span class="annottext">Promise w schema e (WaitingResult t i (OnChainState state i))
</span><a href="#local-6989586621680837501"><span class="hs-identifier hs-var">success</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t -&gt; WaitingResult t i (OnChainState state i)
forall t i s. t -&gt; WaitingResult t i s
</span><a href="Plutus.Contract.StateMachine.html#Timeout"><span class="hs-identifier hs-var">Timeout</span></a></span><span> </span><span class="annot"><span class="annottext">(t -&gt; WaitingResult t i (OnChainState state i))
-&gt; Promise w schema e t
-&gt; Promise w schema e (WaitingResult t i (OnChainState state i))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Promise w schema e t
</span><a href="#local-6989586621680837506"><span class="hs-identifier hs-var">timeout</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>
</span><span id="line-346"></span><span class="hs-comment">-- | Tries to run one step of a state machine: If the /guard/ (the last argument) returns @'Nothing'@ when given the</span><span>
</span><span id="line-347"></span><span class="hs-comment">-- unbalanced transaction to be submitted, the old state and the new step, the step is run and @'Right'@ the new state is returned.</span><span>
</span><span id="line-348"></span><span class="hs-comment">-- If the guard returns @'Just' a@, @'Left' a@ is returned instead.</span><span>
</span><span id="line-349"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runGuardedStep"><span class="hs-identifier hs-type">runGuardedStep</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837478"><span class="annot"><a href="#local-6989586621680837478"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837477"><span class="annot"><a href="#local-6989586621680837477"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621680837476"><span class="annot"><a href="#local-6989586621680837476"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680837475"><span class="annot"><a href="#local-6989586621680837475"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837474"><span class="annot"><a href="#local-6989586621680837474"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837473"><span class="annot"><a href="#local-6989586621680837473"><span class="hs-identifier hs-type">input</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837476"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837475"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837475"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837473"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837475"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837473"><span class="hs-identifier hs-type">input</span></a></span><span>              </span><span class="hs-comment">-- ^ The state machine</span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837473"><span class="hs-identifier hs-type">input</span></a></span><span>                                       </span><span class="hs-comment">-- ^ The input to apply to the state machine</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">UnbalancedTx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837475"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837475"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837477"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The guard to check before running the step</span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837478"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837474"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837476"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837477"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionResult"><span class="hs-identifier hs-type">TransitionResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837475"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837473"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span id="runGuardedStep"><span class="annot"><span class="annottext">runGuardedStep :: StateMachineClient state input
-&gt; input
-&gt; (UnbalancedTx -&gt; state -&gt; state -&gt; Maybe a)
-&gt; Contract w schema e (Either a (TransitionResult state input))
</span><a href="Plutus.Contract.StateMachine.html#runGuardedStep"><span class="hs-identifier hs-var hs-var">runGuardedStep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; (UnbalancedTx -&gt; state -&gt; state -&gt; Maybe a)
-&gt; Contract w schema e (Either a (TransitionResult state input))
forall w a e state (schema :: Row *) input.
(AsSMContractError e, FromData state, ToData state,
 ToData input) =&gt;
ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; (UnbalancedTx -&gt; state -&gt; state -&gt; Maybe a)
-&gt; Contract w schema e (Either a (TransitionResult state input))
</span><a href="Plutus.Contract.StateMachine.html#runGuardedStepWith"><span class="hs-identifier hs-var">runGuardedStepWith</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span class="hs-comment">-- | Run one step of a state machine, returning the new state.</span><span>
</span><span id="line-363"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runStep"><span class="hs-identifier hs-type">runStep</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-364"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837472"><span class="annot"><a href="#local-6989586621680837472"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837471"><span class="annot"><a href="#local-6989586621680837471"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680837470"><span class="annot"><a href="#local-6989586621680837470"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837469"><span class="annot"><a href="#local-6989586621680837469"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837468"><span class="annot"><a href="#local-6989586621680837468"><span class="hs-identifier hs-type">input</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837471"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-366"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837470"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837470"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-368"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837468"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837470"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837468"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-371"></span><span>    </span><span class="hs-comment">-- ^ The state machine</span><span>
</span><span id="line-372"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837468"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-373"></span><span>    </span><span class="hs-comment">-- ^ The input to apply to the state machine</span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837472"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837469"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837471"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionResult"><span class="hs-identifier hs-type">TransitionResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837470"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837468"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span id="runStep"><span class="annot"><span class="annottext">runStep :: StateMachineClient state input
-&gt; input -&gt; Contract w schema e (TransitionResult state input)
</span><a href="Plutus.Contract.StateMachine.html#runStep"><span class="hs-identifier hs-var hs-var">runStep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; Contract w schema e (TransitionResult state input)
forall w e state (schema :: Row *) input.
(AsSMContractError e, FromData state, ToData state,
 ToData input) =&gt;
ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; Contract w schema e (TransitionResult state input)
</span><a href="Plutus.Contract.StateMachine.html#runStepWith"><span class="hs-identifier hs-var">runStepWith</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span class="hs-comment">-- | Create a thread token. The thread token contains a reference to an unspent output of the wallet,</span><span>
</span><span id="line-378"></span><span class="hs-comment">-- so it needs to used with 'mkStateMachine' immediately, and the machine must be initialised,</span><span>
</span><span id="line-379"></span><span class="hs-comment">-- to prevent the output from getting spent in the mean time.</span><span>
</span><span id="line-380"></span><span id="local-6989586621680837465"><span id="local-6989586621680837466"><span id="local-6989586621680837467"><span class="annot"><a href="Plutus.Contract.StateMachine.html#getThreadToken"><span class="hs-identifier hs-type">getThreadToken</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837467"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837466"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837465"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837467"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html#ThreadToken"><span class="hs-identifier hs-type">ThreadToken</span></a></span></span></span></span><span>
</span><span id="line-381"></span><span id="getThreadToken"><span class="annot"><span class="annottext">getThreadToken :: Contract w schema e ThreadToken
</span><a href="Plutus.Contract.StateMachine.html#getThreadToken"><span class="hs-identifier hs-var hs-var">getThreadToken</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SMContractError -&gt; e)
-&gt; Contract w schema SMContractError ThreadToken
-&gt; Contract w schema e ThreadToken
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="Plutus.Contract.Types.html#mapError"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e SMContractError -&gt; SMContractError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
forall r. AsSMContractError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMContractError"><span class="hs-identifier hs-var">_SMContractError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract w schema SMContractError ThreadToken
 -&gt; Contract w schema e ThreadToken)
-&gt; Contract w schema SMContractError ThreadToken
-&gt; Contract w schema e ThreadToken
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-382"></span><span>    </span><span id="local-6989586621680837464"><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837464"><span class="hs-identifier hs-var">txOutRef</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract w schema SMContractError TxOutRef
forall e w (s :: Row *).
AsContractError e =&gt;
Contract w s e TxOutRef
</span><a href="Plutus.Contract.Wallet.html#getUnspentOutput"><span class="hs-identifier hs-var">getUnspentOutput</span></a></span><span>
</span><span id="line-383"></span><span>    </span><span class="annot"><span class="annottext">ThreadToken -&gt; Contract w schema SMContractError ThreadToken
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ThreadToken -&gt; Contract w schema SMContractError ThreadToken)
-&gt; ThreadToken -&gt; Contract w schema SMContractError ThreadToken
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; CurrencySymbol -&gt; ThreadToken
</span><a href="Plutus.Contract.StateMachine.ThreadToken.html#ThreadToken"><span class="hs-identifier hs-var">ThreadToken</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837464"><span class="hs-identifier hs-var">txOutRef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MintingPolicy -&gt; CurrencySymbol
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">scriptCurrencySymbol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOutRef -&gt; MintingPolicy
</span><a href="Plutus.Contract.StateMachine.ThreadToken.html#curPolicy"><span class="hs-identifier hs-var">curPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837464"><span class="hs-identifier hs-var">txOutRef</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>
</span><span id="line-385"></span><span class="hs-comment">-- | Initialise a state machine</span><span>
</span><span id="line-386"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runInitialise"><span class="hs-identifier hs-type">runInitialise</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837463"><span class="annot"><a href="#local-6989586621680837463"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837462"><span class="annot"><a href="#local-6989586621680837462"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680837461"><span class="annot"><a href="#local-6989586621680837461"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837460"><span class="annot"><a href="#local-6989586621680837460"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837459"><span class="annot"><a href="#local-6989586621680837459"><span class="hs-identifier hs-type">input</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-388"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837461"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837461"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837459"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837462"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837461"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837459"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-394"></span><span>    </span><span class="hs-comment">-- ^ The state machine</span><span>
</span><span id="line-395"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837461"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-comment">-- ^ The initial state</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-398"></span><span>    </span><span class="hs-comment">-- ^ The value locked by the contract at the beginning</span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837463"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837460"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837462"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837461"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-400"></span><span id="runInitialise"><span class="annot"><span class="annottext">runInitialise :: StateMachineClient state input
-&gt; state -&gt; Value -&gt; Contract w schema e state
</span><a href="Plutus.Contract.StateMachine.html#runInitialise"><span class="hs-identifier hs-var hs-var">runInitialise</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; state
-&gt; Value
-&gt; Contract w schema e state
forall w e state (schema :: Row *) input.
(FromData state, ToData state, ToData input,
 AsSMContractError e) =&gt;
ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; state
-&gt; Value
-&gt; Contract w schema e state
</span><a href="Plutus.Contract.StateMachine.html#runInitialiseWith"><span class="hs-identifier hs-var">runInitialiseWith</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-comment">-- | Constraints &amp; lookups needed to transition a state machine instance</span><span>
</span><span id="line-403"></span><span class="hs-keyword">data</span><span> </span><span id="StateMachineTransition"><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineTransition"><span class="hs-identifier hs-var">StateMachineTransition</span></a></span></span><span> </span><span id="local-6989586621680837838"><span class="annot"><a href="#local-6989586621680837838"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837837"><span class="annot"><a href="#local-6989586621680837837"><span class="hs-identifier hs-type">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-404"></span><span>    </span><span id="StateMachineTransition"><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineTransition"><span class="hs-identifier hs-var">StateMachineTransition</span></a></span></span><span>
</span><span id="line-405"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="smtConstraints"><span class="annot"><span class="annottext">StateMachineTransition state input -&gt; TxConstraints input state
</span><a href="Plutus.Contract.StateMachine.html#smtConstraints"><span class="hs-identifier hs-var hs-var">smtConstraints</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837837"><span class="hs-identifier hs-type">input</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837838"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-406"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="smtOldState"><span class="annot"><span class="annottext">StateMachineTransition state input -&gt; State state
</span><a href="Plutus.Contract.StateMachine.html#smtOldState"><span class="hs-identifier hs-var hs-var">smtOldState</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837838"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-407"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="smtNewState"><span class="annot"><span class="annottext">StateMachineTransition state input -&gt; State state
</span><a href="Plutus.Contract.StateMachine.html#smtNewState"><span class="hs-identifier hs-var hs-var">smtNewState</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837838"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-408"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="smtLookups"><span class="annot"><span class="annottext">StateMachineTransition state input
-&gt; ScriptLookups (StateMachine state input)
</span><a href="Plutus.Contract.StateMachine.html#smtLookups"><span class="hs-identifier hs-var hs-var">smtLookups</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">ScriptLookups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier hs-type">StateMachine</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837838"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837837"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-comment">-- | Initialise a state machine and supply additional constraints and lookups for transaction.</span><span>
</span><span id="line-412"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runInitialiseWith"><span class="hs-identifier hs-type">runInitialiseWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-413"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837908"><span class="annot"><a href="#local-6989586621680837908"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837909"><span class="annot"><a href="#local-6989586621680837909"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680837911"><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837907"><span class="annot"><a href="#local-6989586621680837907"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837910"><span class="annot"><a href="#local-6989586621680837910"><span class="hs-identifier hs-type">input</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-414"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837910"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837909"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">ScriptLookups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier hs-type">StateMachine</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837910"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>    </span><span class="hs-comment">-- ^ Additional lookups</span><span>
</span><span id="line-421"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837910"><span class="hs-identifier hs-type">input</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-422"></span><span>    </span><span class="hs-comment">-- ^ Additional constraints</span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837910"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-424"></span><span>    </span><span class="hs-comment">-- ^ The state machine</span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-426"></span><span>    </span><span class="hs-comment">-- ^ The initial state</span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-comment">-- ^ The value locked by the contract at the beginning</span><span>
</span><span id="line-429"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837908"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837907"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837909"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837911"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-430"></span><span id="runInitialiseWith"><span class="annot"><span class="annottext">runInitialiseWith :: ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; state
-&gt; Value
-&gt; Contract w schema e state
</span><a href="Plutus.Contract.StateMachine.html#runInitialiseWith"><span class="hs-identifier hs-var hs-var">runInitialiseWith</span></a></span></span><span> </span><span id="local-6989586621680837453"><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837453"><span class="hs-identifier hs-var">customLookups</span></a></span></span><span> </span><span id="local-6989586621680837452"><span class="annot"><span class="annottext">TxConstraints input state
</span><a href="#local-6989586621680837452"><span class="hs-identifier hs-var">customConstraints</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837451"><span class="annot"><span class="annottext">StateMachineInstance state input
scInstance :: StateMachineInstance state input
scInstance :: forall s i. StateMachineClient s i -&gt; StateMachineInstance s i
</span><a href="#local-6989586621680837451"><span class="hs-identifier hs-var hs-var">scInstance</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680837450"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837450"><span class="hs-identifier hs-var">initialState</span></a></span></span><span> </span><span id="local-6989586621680837449"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837449"><span class="hs-identifier hs-var">initialValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-431"></span><span>    </span><span class="annot"><span class="annottext">(SMContractError -&gt; e)
-&gt; Contract w schema SMContractError state
-&gt; Contract w schema e state
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="Plutus.Contract.Types.html#mapError"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e SMContractError -&gt; SMContractError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
forall r. AsSMContractError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMContractError"><span class="hs-identifier hs-var">_SMContractError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract w schema SMContractError state
 -&gt; Contract w schema e state)
-&gt; Contract w schema SMContractError state
-&gt; Contract w schema e state
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-432"></span><span>      </span><span id="local-6989586621680837448"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837448"><span class="hs-identifier hs-var">utxo</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract w schema SMContractError (Map TxOutRef DecoratedTxOut)
forall w (s :: Row *) e.
AsContractError e =&gt;
Contract w s e (Map TxOutRef DecoratedTxOut)
</span><a href="Plutus.Contract.Request.html#ownUtxos"><span class="hs-identifier hs-var">ownUtxos</span></a></span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier hs-type">StateMachineInstance</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837447"><span class="annot"><span class="annottext">StateMachine state input
stateMachine :: StateMachine state input
stateMachine :: forall s i. StateMachineInstance s i -&gt; StateMachine s i
</span><a href="#local-6989586621680837447"><span class="hs-identifier hs-var hs-var">stateMachine</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837446"><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
typedValidator :: TypedValidator (StateMachine state input)
typedValidator :: forall s i.
StateMachineInstance s i -&gt; TypedValidator (StateMachine s i)
</span><a href="#local-6989586621680837446"><span class="hs-identifier hs-var hs-var">typedValidator</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837451"><span class="hs-identifier hs-var">scInstance</span></a></span><span>
</span><span id="line-434"></span><span>          </span><span id="local-6989586621680837445"><span class="annot"><span class="annottext">constraints :: TxConstraints input state
</span><a href="#local-6989586621680837445"><span class="hs-identifier hs-var hs-var">constraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-435"></span><span>              </span><span class="annot"><span class="annottext">state -&gt; Value -&gt; TxConstraints input state
forall o i. o -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">mustPayToTheScriptWithDatumInTx</span></a></span><span>
</span><span id="line-436"></span><span>                </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837450"><span class="hs-identifier hs-var">initialState</span></a></span><span>
</span><span id="line-437"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837449"><span class="hs-identifier hs-var">initialValue</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input -&gt; Value
forall s i. StateMachineInstance s i -&gt; Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#threadTokenValueOrZero"><span class="hs-identifier hs-var">SM.threadTokenValueOrZero</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837451"><span class="hs-identifier hs-var">scInstance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>              </span><span class="annot"><span class="annottext">TxConstraints input state
-&gt; TxConstraints input state -&gt; TxConstraints input state
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(ThreadToken -&gt; TxConstraints input state)
-&gt; Maybe ThreadToken -&gt; TxConstraints input state
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadToken -&gt; TxConstraints input state
</span><a href="#local-6989586621680837443"><span class="hs-identifier hs-var">ttConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachine state input -&gt; Maybe ThreadToken
forall s i. StateMachine s i -&gt; Maybe ThreadToken
</span><a href="Plutus.Contract.StateMachine.OnChain.html#smThreadToken"><span class="hs-identifier hs-var hs-var">smThreadToken</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachine state input
</span><a href="#local-6989586621680837447"><span class="hs-identifier hs-var">stateMachine</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>              </span><span class="annot"><span class="annottext">TxConstraints input state
-&gt; TxConstraints input state -&gt; TxConstraints input state
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
</span><a href="#local-6989586621680837452"><span class="hs-identifier hs-var">customConstraints</span></a></span><span>
</span><span id="line-440"></span><span>          </span><span id="local-6989586621680837442"><span class="annot"><span class="annottext">red :: Redeemer
</span><a href="#local-6989586621680837442"><span class="hs-identifier hs-var hs-var">red</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuiltinData -&gt; Redeemer
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Ledger.Redeemer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ValidatorHash, MintingPolarity) -&gt; BuiltinData
forall a. ToData a =&gt; a -&gt; BuiltinData
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.toBuiltinData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input) -&gt; ValidatorHash
forall a. TypedValidator a -&gt; ValidatorHash
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.validatorHash</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
</span><a href="#local-6989586621680837446"><span class="hs-identifier hs-var">typedValidator</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MintingPolarity
</span><a href="Plutus.Contract.StateMachine.MintingPolarity.html#Mint"><span class="hs-identifier hs-var">Mint</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>          </span><span id="local-6989586621680837443"><span class="annot"><span class="annottext">ttConstraints :: ThreadToken -&gt; TxConstraints input state
</span><a href="#local-6989586621680837443"><span class="hs-identifier hs-var hs-var">ttConstraints</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.ThreadToken.html#ThreadToken"><span class="hs-identifier hs-type">ThreadToken</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837439"><span class="annot"><span class="annottext">TxOutRef
ttOutRef :: TxOutRef
ttOutRef :: ThreadToken -&gt; TxOutRef
</span><a href="#local-6989586621680837439"><span class="hs-identifier hs-var hs-var">ttOutRef</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>              </span><span class="annot"><span class="annottext">Redeemer -&gt; Value -&gt; TxConstraints input state
forall i o. Redeemer -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">mustMintValueWithRedeemer</span></a></span><span> </span><span class="annot"><span class="annottext">Redeemer
</span><a href="#local-6989586621680837442"><span class="hs-identifier hs-var">red</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachineInstance state input -&gt; Value
forall s i. StateMachineInstance s i -&gt; Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#threadTokenValueOrZero"><span class="hs-identifier hs-var">SM.threadTokenValueOrZero</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837451"><span class="hs-identifier hs-var">scInstance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>              </span><span class="annot"><span class="annottext">TxConstraints input state
-&gt; TxConstraints input state -&gt; TxConstraints input state
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; TxConstraints input state
forall i o. TxOutRef -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">mustSpendPubKeyOutput</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680837439"><span class="hs-identifier hs-var">ttOutRef</span></a></span><span>
</span><span id="line-444"></span><span>          </span><span id="local-6989586621680837438"><span class="annot"><span class="annottext">lookups :: ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837438"><span class="hs-identifier hs-var hs-var">lookups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. TypedValidator a -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.typedValidatorLookups</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
</span><a href="#local-6989586621680837446"><span class="hs-identifier hs-var">typedValidator</span></a></span><span>
</span><span id="line-445"></span><span>              </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(ThreadToken -&gt; ScriptLookups (StateMachine state input))
-&gt; Maybe ThreadToken -&gt; ScriptLookups (StateMachine state input)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MintingPolicy -&gt; ScriptLookups (StateMachine state input)
forall a. MintingPolicy -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">plutusV1MintingPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">(MintingPolicy -&gt; ScriptLookups (StateMachine state input))
-&gt; (ThreadToken -&gt; MintingPolicy)
-&gt; ThreadToken
-&gt; ScriptLookups (StateMachine state input)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; MintingPolicy
</span><a href="Plutus.Contract.StateMachine.ThreadToken.html#curPolicy"><span class="hs-identifier hs-var">curPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOutRef -&gt; MintingPolicy)
-&gt; (ThreadToken -&gt; TxOutRef) -&gt; ThreadToken -&gt; MintingPolicy
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadToken -&gt; TxOutRef
</span><a href="Plutus.Contract.StateMachine.ThreadToken.html#ttOutRef"><span class="hs-identifier hs-var hs-var">ttOutRef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachine state input -&gt; Maybe ThreadToken
forall s i. StateMachine s i -&gt; Maybe ThreadToken
</span><a href="Plutus.Contract.StateMachine.OnChain.html#smThreadToken"><span class="hs-identifier hs-var hs-var">smThreadToken</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachine state input
</span><a href="#local-6989586621680837447"><span class="hs-identifier hs-var">stateMachine</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>              </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
-&gt; ScriptLookups (StateMachine state input)
forall a. Map TxOutRef DecoratedTxOut -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.unspentOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837448"><span class="hs-identifier hs-var">utxo</span></a></span><span>
</span><span id="line-447"></span><span>              </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837453"><span class="hs-identifier hs-var">customLookups</span></a></span><span>
</span><span id="line-448"></span><span>      </span><span id="local-6989586621680837435"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837435"><span class="hs-identifier hs-var">utx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; TxConstraints
     (RedeemerType (StateMachine state input))
     (DatumType (StateMachine state input))
-&gt; Contract w schema SMContractError UnbalancedTx
forall a w (s :: Row *) e.
(ToData (RedeemerType a), FromData (DatumType a),
 ToData (DatumType a), AsContractError e) =&gt;
ScriptLookups a
-&gt; TxConstraints (RedeemerType a) (DatumType a)
-&gt; Contract w s e UnbalancedTx
</span><a href="Plutus.Contract.Request.html#mkTxConstraints"><span class="hs-identifier hs-var">mkTxConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837438"><span class="hs-identifier hs-var">lookups</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
TxConstraints
  (RedeemerType (StateMachine state input))
  (DatumType (StateMachine state input))
</span><a href="#local-6989586621680837445"><span class="hs-identifier hs-var">constraints</span></a></span><span>
</span><span id="line-449"></span><span>      </span><span id="local-6989586621680837434"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837434"><span class="hs-identifier hs-var">adjustedUtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w schema SMContractError UnbalancedTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e UnbalancedTx
</span><a href="Plutus.Contract.Request.html#adjustUnbalancedTx"><span class="hs-identifier hs-var">adjustUnbalancedTx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837435"><span class="hs-identifier hs-var">utx</span></a></span><span>
</span><span id="line-450"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; Contract w schema SMContractError ()
-&gt; Contract w schema SMContractError ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837435"><span class="hs-identifier hs-var">utx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; UnbalancedTx -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837434"><span class="hs-identifier hs-var">adjustedUtx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract w schema SMContractError ()
 -&gt; Contract w schema SMContractError ())
-&gt; Contract w schema SMContractError ()
-&gt; Contract w schema SMContractError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-451"></span><span>        </span><span class="annot"><span class="annottext">forall a w (s :: Row *) e. ToJSON a =&gt; a -&gt; Contract w s e ()
forall w (s :: Row *) e. ToJSON Text =&gt; Text -&gt; Contract w s e ()
</span><a href="Plutus.Contract.Logging.html#logWarn"><span class="hs-identifier hs-var">logWarn</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Contract w schema SMContractError ())
-&gt; Text -&gt; Contract w schema SMContractError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Plutus.Contract.StateMachine.runInitialise: &quot;</span></span><span>
</span><span id="line-452"></span><span>                      </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Found a transaction output value with less than the minimum amount of Ada. Adjusting ...&quot;</span></span><span>
</span><span id="line-453"></span><span>      </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w schema SMContractError ()
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e ()
</span><a href="Plutus.Contract.Request.html#submitTxConfirmed"><span class="hs-identifier hs-var">submitTxConfirmed</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837434"><span class="hs-identifier hs-var">adjustedUtx</span></a></span><span>
</span><span id="line-454"></span><span>      </span><span class="annot"><span class="annottext">state -&gt; Contract w schema SMContractError state
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837450"><span class="hs-identifier hs-var">initialState</span></a></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span class="hs-comment">-- | Run one step of a state machine, returning the new state. We can supply additional constraints and lookups for transaction.</span><span>
</span><span id="line-457"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runStepWith"><span class="hs-identifier hs-type">runStepWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837927"><span class="annot"><a href="#local-6989586621680837927"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837930"><span class="annot"><a href="#local-6989586621680837930"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680837929"><span class="annot"><a href="#local-6989586621680837929"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837926"><span class="annot"><a href="#local-6989586621680837926"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837928"><span class="annot"><a href="#local-6989586621680837928"><span class="hs-identifier hs-type">input</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837930"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-460"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837929"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-461"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837929"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837928"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-463"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">ScriptLookups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier hs-type">StateMachine</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837929"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837928"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-comment">-- ^ Additional lookups</span><span>
</span><span id="line-466"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837928"><span class="hs-identifier hs-type">input</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837929"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-comment">-- ^ Additional constraints</span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837929"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837928"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-comment">-- ^ The state machine</span><span>
</span><span id="line-470"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837928"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-comment">-- ^ The input to apply to the state machine</span><span>
</span><span id="line-472"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837927"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837926"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837930"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionResult"><span class="hs-identifier hs-type">TransitionResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837929"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837928"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span id="runStepWith"><span class="annot"><span class="annottext">runStepWith :: ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; Contract w schema e (TransitionResult state input)
</span><a href="Plutus.Contract.StateMachine.html#runStepWith"><span class="hs-identifier hs-var hs-var">runStepWith</span></a></span></span><span> </span><span id="local-6989586621680837433"><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837433"><span class="hs-identifier hs-var">lookups</span></a></span></span><span> </span><span id="local-6989586621680837432"><span class="annot"><span class="annottext">TxConstraints input state
</span><a href="#local-6989586621680837432"><span class="hs-identifier hs-var">constraints</span></a></span></span><span> </span><span id="local-6989586621680837431"><span class="annot"><span class="annottext">StateMachineClient state input
</span><a href="#local-6989586621680837431"><span class="hs-identifier hs-var">smc</span></a></span></span><span> </span><span id="local-6989586621680837430"><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837430"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-474"></span><span>    </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; (UnbalancedTx -&gt; state -&gt; state -&gt; Maybe Void)
-&gt; Contract w schema e (Either Void (TransitionResult state input))
forall w a e state (schema :: Row *) input.
(AsSMContractError e, FromData state, ToData state,
 ToData input) =&gt;
ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; (UnbalancedTx -&gt; state -&gt; state -&gt; Maybe a)
-&gt; Contract w schema e (Either a (TransitionResult state input))
</span><a href="Plutus.Contract.StateMachine.html#runGuardedStepWith"><span class="hs-identifier hs-var">runGuardedStepWith</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837433"><span class="hs-identifier hs-var">lookups</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
</span><a href="#local-6989586621680837432"><span class="hs-identifier hs-var">constraints</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state input
</span><a href="#local-6989586621680837431"><span class="hs-identifier hs-var">smc</span></a></span><span> </span><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837430"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">UnbalancedTx
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">state
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">state
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Void
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Contract w schema e (Either Void (TransitionResult state input))
-&gt; (Either Void (TransitionResult state input)
    -&gt; Contract w schema e (TransitionResult state input))
-&gt; Contract w schema e (TransitionResult state input)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionResult state input
-&gt; Contract w schema e (TransitionResult state input)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionResult state input
 -&gt; Contract w schema e (TransitionResult state input))
-&gt; (Either Void (TransitionResult state input)
    -&gt; TransitionResult state input)
-&gt; Either Void (TransitionResult state input)
-&gt; Contract w schema e (TransitionResult state input)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680837429"><span class="annot"><span class="annottext">Void
</span><a href="#local-6989586621680837429"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Void -&gt; TransitionResult state input
forall a. Void -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">absurd</span></a></span><span> </span><span class="annot"><span class="annottext">Void
</span><a href="#local-6989586621680837429"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-476"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680837428"><span class="annot"><span class="annottext">TransitionResult state input
</span><a href="#local-6989586621680837428"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TransitionResult state input
</span><a href="#local-6989586621680837428"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span class="hs-comment">-- | The same as 'runGuardedStep' but we can supply additional constraints and lookups for transaction.</span><span>
</span><span id="line-479"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#runGuardedStepWith"><span class="hs-identifier hs-type">runGuardedStepWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837938"><span class="annot"><a href="#local-6989586621680837938"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837939"><span class="annot"><a href="#local-6989586621680837939"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span id="local-6989586621680837942"><span class="annot"><a href="#local-6989586621680837942"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680837941"><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837937"><span class="annot"><a href="#local-6989586621680837937"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837940"><span class="annot"><a href="#local-6989586621680837940"><span class="hs-identifier hs-type">input</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-481"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837942"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-482"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-484"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837940"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-485"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">ScriptLookups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier hs-type">StateMachine</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837940"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span>    </span><span class="hs-comment">-- ^ Additional lookups</span><span>
</span><span id="line-487"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837940"><span class="hs-identifier hs-type">input</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span>                   </span><span class="hs-comment">-- ^ Additional constraints</span><span>
</span><span id="line-488"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837940"><span class="hs-identifier hs-type">input</span></a></span><span>              </span><span class="hs-comment">-- ^ The state machine</span><span>
</span><span id="line-489"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837940"><span class="hs-identifier hs-type">input</span></a></span><span>                                       </span><span class="hs-comment">-- ^ The input to apply to the state machine</span><span>
</span><span id="line-490"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">UnbalancedTx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837939"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ The guard to check before running the step</span><span>
</span><span id="line-491"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837938"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837937"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837942"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837939"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#TransitionResult"><span class="hs-identifier hs-type">TransitionResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837941"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837940"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span id="runGuardedStepWith"><span class="annot"><span class="annottext">runGuardedStepWith :: ScriptLookups (StateMachine state input)
-&gt; TxConstraints input state
-&gt; StateMachineClient state input
-&gt; input
-&gt; (UnbalancedTx -&gt; state -&gt; state -&gt; Maybe a)
-&gt; Contract w schema e (Either a (TransitionResult state input))
</span><a href="Plutus.Contract.StateMachine.html#runGuardedStepWith"><span class="hs-identifier hs-var hs-var">runGuardedStepWith</span></a></span></span><span> </span><span id="local-6989586621680837427"><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837427"><span class="hs-identifier hs-var">userLookups</span></a></span></span><span> </span><span id="local-6989586621680837426"><span class="annot"><span class="annottext">TxConstraints input state
</span><a href="#local-6989586621680837426"><span class="hs-identifier hs-var">userConstraints</span></a></span></span><span> </span><span id="local-6989586621680837425"><span class="annot"><span class="annottext">StateMachineClient state input
</span><a href="#local-6989586621680837425"><span class="hs-identifier hs-var">smc</span></a></span></span><span> </span><span id="local-6989586621680837424"><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837424"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span id="local-6989586621680837423"><span class="annot"><span class="annottext">UnbalancedTx -&gt; state -&gt; state -&gt; Maybe a
</span><a href="#local-6989586621680837423"><span class="hs-identifier hs-var">guard</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-493"></span><span>  </span><span class="annot"><span class="annottext">(SMContractError -&gt; e)
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
-&gt; Contract w schema e (Either a (TransitionResult state input))
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="Plutus.Contract.Types.html#mapError"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e SMContractError -&gt; SMContractError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e SMContractError
forall r. AsSMContractError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contract.StateMachine.html#_SMContractError"><span class="hs-identifier hs-var">_SMContractError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract
   w schema SMContractError (Either a (TransitionResult state input))
 -&gt; Contract w schema e (Either a (TransitionResult state input)))
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
-&gt; Contract w schema e (Either a (TransitionResult state input))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state input
-&gt; input
-&gt; Contract
     w
     schema
     SMContractError
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
forall w e state (schema :: Row *) input.
(AsSMContractError e, FromData state, ToData state) =&gt;
StateMachineClient state input
-&gt; input
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
</span><a href="Plutus.Contract.StateMachine.html#mkStep"><span class="hs-identifier hs-var">mkStep</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state input
</span><a href="#local-6989586621680837425"><span class="hs-identifier hs-var">smc</span></a></span><span> </span><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837424"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="annot"><span class="annottext">Contract
  w
  schema
  SMContractError
  (Either
     (InvalidTransition state input)
     (StateMachineTransition state input))
-&gt; (Either
      (InvalidTransition state input)
      (StateMachineTransition state input)
    -&gt; Contract
         w schema SMContractError (Either a (TransitionResult state input)))
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-494"></span><span>    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineTransition"><span class="hs-identifier hs-type">StateMachineTransition</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837422"><span class="annot"><span class="annottext">TxConstraints input state
smtConstraints :: TxConstraints input state
smtConstraints :: forall state input.
StateMachineTransition state input -&gt; TxConstraints input state
</span><a href="#local-6989586621680837422"><span class="hs-identifier hs-var hs-var">smtConstraints</span></a></span></span><span class="hs-special">,</span><span class="annot"><span class="annottext">smtOldState :: forall state input.
StateMachineTransition state input -&gt; State state
</span><a href="Plutus.Contract.StateMachine.html#smtOldState"><span class="hs-identifier hs-var">smtOldState</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier hs-type">State</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateData :: forall s. State s -&gt; s
</span><a href="Plutus.Contract.StateMachine.OnChain.html#stateData"><span class="hs-identifier hs-var">stateData</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680837421"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837421"><span class="hs-identifier hs-var">os</span></a></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">smtNewState :: forall state input.
StateMachineTransition state input -&gt; State state
</span><a href="Plutus.Contract.StateMachine.html#smtNewState"><span class="hs-identifier hs-var">smtNewState</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier hs-type">State</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateData :: forall s. State s -&gt; s
</span><a href="Plutus.Contract.StateMachine.OnChain.html#stateData"><span class="hs-identifier hs-var">stateData</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680837420"><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837420"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837419"><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
smtLookups :: ScriptLookups (StateMachine state input)
smtLookups :: forall state input.
StateMachineTransition state input
-&gt; ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837419"><span class="hs-identifier hs-var hs-var">smtLookups</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-495"></span><span>        </span><span id="local-6989586621680837418"><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680837418"><span class="hs-identifier hs-var">pk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract w schema SMContractError PaymentPubKeyHash
forall w (s :: Row *) e.
AsContractError e =&gt;
Contract w s e PaymentPubKeyHash
</span><a href="Plutus.Contract.Request.html#ownFirstPaymentPubKeyHash"><span class="hs-identifier hs-var">ownFirstPaymentPubKeyHash</span></a></span><span>
</span><span id="line-496"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837417"><span class="annot"><span class="annottext">lookups :: ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837417"><span class="hs-identifier hs-var hs-var">lookups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837419"><span class="hs-identifier hs-var">smtLookups</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">slOwnPaymentPubKeyHash :: Maybe PaymentPubKeyHash
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.slOwnPaymentPubKeyHash</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; Maybe PaymentPubKeyHash
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680837418"><span class="hs-identifier hs-var">pk</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-497"></span><span>        </span><span id="local-6989586621680837415"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837415"><span class="hs-identifier hs-var">utx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; TxConstraints
     (RedeemerType (StateMachine state input))
     (DatumType (StateMachine state input))
-&gt; Contract w schema SMContractError UnbalancedTx
forall a w (s :: Row *) e.
(ToData (RedeemerType a), FromData (DatumType a),
 ToData (DatumType a), AsContractError e) =&gt;
ScriptLookups a
-&gt; TxConstraints (RedeemerType a) (DatumType a)
-&gt; Contract w s e UnbalancedTx
</span><a href="Plutus.Contract.Request.html#mkTxConstraints"><span class="hs-identifier hs-var">mkTxConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837417"><span class="hs-identifier hs-var">lookups</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837427"><span class="hs-identifier hs-var">userLookups</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxConstraints input state
</span><a href="#local-6989586621680837422"><span class="hs-identifier hs-var">smtConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
-&gt; TxConstraints input state -&gt; TxConstraints input state
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input state
</span><a href="#local-6989586621680837426"><span class="hs-identifier hs-var">userConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>        </span><span id="local-6989586621680837414"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837414"><span class="hs-identifier hs-var">adjustedUtx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w schema SMContractError UnbalancedTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e UnbalancedTx
</span><a href="Plutus.Contract.Request.html#adjustUnbalancedTx"><span class="hs-identifier hs-var">adjustUnbalancedTx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837415"><span class="hs-identifier hs-var">utx</span></a></span><span>
</span><span id="line-499"></span><span>        </span><span class="annot"><span class="annottext">Bool
-&gt; Contract w schema SMContractError ()
-&gt; Contract w schema SMContractError ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837415"><span class="hs-identifier hs-var">utx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; UnbalancedTx -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837414"><span class="hs-identifier hs-var">adjustedUtx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract w schema SMContractError ()
 -&gt; Contract w schema SMContractError ())
-&gt; Contract w schema SMContractError ()
-&gt; Contract w schema SMContractError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-500"></span><span>          </span><span class="annot"><span class="annottext">forall a w (s :: Row *) e. ToJSON a =&gt; a -&gt; Contract w s e ()
forall w (s :: Row *) e. ToJSON Text =&gt; Text -&gt; Contract w s e ()
</span><a href="Plutus.Contract.Logging.html#logWarn"><span class="hs-identifier hs-var">logWarn</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Contract w schema SMContractError ())
-&gt; Text -&gt; Contract w schema SMContractError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Plutus.Contract.StateMachine.runStep: &quot;</span></span><span>
</span><span id="line-501"></span><span>                       </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Found a transaction output value with less than the minimum amount of Ada. Adjusting ...&quot;</span></span><span>
</span><span id="line-502"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; state -&gt; state -&gt; Maybe a
</span><a href="#local-6989586621680837423"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837414"><span class="hs-identifier hs-var">adjustedUtx</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837421"><span class="hs-identifier hs-var">os</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837420"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-503"></span><span>            </span><span class="annot"><span class="annottext">Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-504"></span><span>                </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w schema SMContractError ()
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e ()
</span><a href="Plutus.Contract.Request.html#submitTxConfirmed"><span class="hs-identifier hs-var">submitTxConfirmed</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680837414"><span class="hs-identifier hs-var">adjustedUtx</span></a></span><span>
</span><span id="line-505"></span><span>                </span><span class="annot"><span class="annottext">Either a (TransitionResult state input)
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either a (TransitionResult state input)
 -&gt; Contract
      w schema SMContractError (Either a (TransitionResult state input)))
-&gt; Either a (TransitionResult state input)
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionResult state input
-&gt; Either a (TransitionResult state input)
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionResult state input
 -&gt; Either a (TransitionResult state input))
-&gt; TransitionResult state input
-&gt; Either a (TransitionResult state input)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">state -&gt; TransitionResult state input
forall s i. s -&gt; TransitionResult s i
</span><a href="Plutus.Contract.StateMachine.html#TransitionSuccess"><span class="hs-identifier hs-var">TransitionSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">state
</span><a href="#local-6989586621680837420"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-506"></span><span>            </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680837413"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680837413"><span class="hs-identifier hs-var">a</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either a (TransitionResult state input)
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either a (TransitionResult state input)
 -&gt; Contract
      w schema SMContractError (Either a (TransitionResult state input)))
-&gt; Either a (TransitionResult state input)
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Either a (TransitionResult state input)
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680837413"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-507"></span><span>    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680837412"><span class="annot"><span class="annottext">InvalidTransition state input
</span><a href="#local-6989586621680837412"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either a (TransitionResult state input)
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either a (TransitionResult state input)
 -&gt; Contract
      w schema SMContractError (Either a (TransitionResult state input)))
-&gt; Either a (TransitionResult state input)
-&gt; Contract
     w schema SMContractError (Either a (TransitionResult state input))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TransitionResult state input
-&gt; Either a (TransitionResult state input)
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(TransitionResult state input
 -&gt; Either a (TransitionResult state input))
-&gt; TransitionResult state input
-&gt; Either a (TransitionResult state input)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidTransition state input -&gt; TransitionResult state input
forall s i. InvalidTransition s i -&gt; TransitionResult s i
</span><a href="Plutus.Contract.StateMachine.html#TransitionFailure"><span class="hs-identifier hs-var">TransitionFailure</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidTransition state input
</span><a href="#local-6989586621680837412"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-508"></span><span>
</span><span id="line-509"></span><span class="hs-comment">-- | Given a state machine client and an input to apply to</span><span>
</span><span id="line-510"></span><span class="hs-comment">--   the client's state machine instance, compute the 'StateMachineTransition'</span><span>
</span><span id="line-511"></span><span class="hs-comment">--   that can produce an actual transaction performing the transition</span><span>
</span><span id="line-512"></span><span class="annot"><a href="Plutus.Contract.StateMachine.html#mkStep"><span class="hs-identifier hs-type">mkStep</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-513"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680837840"><span class="annot"><a href="#local-6989586621680837840"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680837843"><span class="annot"><a href="#local-6989586621680837843"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621680837842"><span class="annot"><a href="#local-6989586621680837842"><span class="hs-identifier hs-type">state</span></a></span></span><span> </span><span id="local-6989586621680837839"><span class="annot"><a href="#local-6989586621680837839"><span class="hs-identifier hs-type">schema</span></a></span></span><span> </span><span id="local-6989586621680837841"><span class="annot"><a href="#local-6989586621680837841"><span class="hs-identifier hs-type">input</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-514"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#AsSMContractError"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837843"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837842"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-516"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.ToData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837842"><span class="hs-identifier hs-type">state</span></a></span><span>
</span><span id="line-517"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837842"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837841"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680837841"><span class="hs-identifier hs-type">input</span></a></span><span>
</span><span id="line-520"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contract.Types.html#Contract"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837840"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837839"><span class="hs-identifier hs-type">schema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837843"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#InvalidTransition"><span class="hs-identifier hs-type">InvalidTransition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837842"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837841"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineTransition"><span class="hs-identifier hs-type">StateMachineTransition</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837842"><span class="hs-identifier hs-type">state</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680837841"><span class="hs-identifier hs-type">input</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span id="mkStep"><span class="annot"><span class="annottext">mkStep :: StateMachineClient state input
-&gt; input
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
</span><a href="Plutus.Contract.StateMachine.html#mkStep"><span class="hs-identifier hs-var hs-var">mkStep</span></a></span></span><span> </span><span id="local-6989586621680837411"><span class="annot"><span class="annottext">client :: StateMachineClient state input
</span><a href="#local-6989586621680837411"><span class="hs-identifier hs-var">client</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contract.StateMachine.html#StateMachineClient"><span class="hs-identifier hs-type">StateMachineClient</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837410"><span class="annot"><span class="annottext">StateMachineInstance state input
scInstance :: StateMachineInstance state input
scInstance :: forall s i. StateMachineClient s i -&gt; StateMachineInstance s i
</span><a href="#local-6989586621680837410"><span class="hs-identifier hs-var hs-var">scInstance</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680837409"><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837409"><span class="hs-identifier hs-var">input</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-522"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachineInstance"><span class="hs-identifier hs-type">StateMachineInstance</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837408"><span class="annot"><span class="annottext">StateMachine state input
stateMachine :: StateMachine state input
stateMachine :: forall s i. StateMachineInstance s i -&gt; StateMachine s i
</span><a href="#local-6989586621680837408"><span class="hs-identifier hs-var hs-var">stateMachine</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837407"><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
typedValidator :: TypedValidator (StateMachine state input)
typedValidator :: forall s i.
StateMachineInstance s i -&gt; TypedValidator (StateMachine s i)
</span><a href="#local-6989586621680837407"><span class="hs-identifier hs-var hs-var">typedValidator</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837410"><span class="hs-identifier hs-var">scInstance</span></a></span><span>
</span><span id="line-523"></span><span>        </span><span class="annot"><a href="Plutus.Contract.StateMachine.OnChain.html#StateMachine"><span class="hs-identifier hs-type">StateMachine</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837406"><span class="annot"><span class="annottext">State state
-&gt; input -&gt; Maybe (TxConstraints Void Void, State state)
smTransition :: State state
-&gt; input -&gt; Maybe (TxConstraints Void Void, State state)
smTransition :: forall s i.
StateMachine s i
-&gt; State s -&gt; i -&gt; Maybe (TxConstraints Void Void, State s)
</span><a href="#local-6989586621680837406"><span class="hs-identifier hs-var hs-var">smTransition</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachine state input
</span><a href="#local-6989586621680837408"><span class="hs-identifier hs-var">stateMachine</span></a></span><span>
</span><span id="line-524"></span><span>    </span><span id="local-6989586621680837405"><span class="annot"><span class="annottext">Maybe (OnChainState state input, Map TxOutRef DecoratedTxOut)
</span><a href="#local-6989586621680837405"><span class="hs-identifier hs-var">maybeState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateMachineClient state input
-&gt; Contract
     w
     schema
     e
     (Maybe (OnChainState state input, Map TxOutRef DecoratedTxOut))
forall e state i w (schema :: Row *).
(AsSMContractError e, FromData state, ToData state) =&gt;
StateMachineClient state i
-&gt; Contract
     w
     schema
     e
     (Maybe (OnChainState state i, Map TxOutRef DecoratedTxOut))
</span><a href="Plutus.Contract.StateMachine.html#getOnChainState"><span class="hs-identifier hs-var">getOnChainState</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient state input
</span><a href="#local-6989586621680837411"><span class="hs-identifier hs-var">client</span></a></span><span>
</span><span id="line-525"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (OnChainState state input, Map TxOutRef DecoratedTxOut)
</span><a href="#local-6989586621680837405"><span class="hs-identifier hs-var">maybeState</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-526"></span><span>        </span><span class="annot"><span class="annottext">Maybe (OnChainState state input, Map TxOutRef DecoratedTxOut)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either
  (InvalidTransition state input)
  (StateMachineTransition state input)
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (InvalidTransition state input)
   (StateMachineTransition state input)
 -&gt; Contract
      w
      schema
      e
      (Either
         (InvalidTransition state input)
         (StateMachineTransition state input)))
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidTransition state input
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidTransition state input
 -&gt; Either
      (InvalidTransition state input)
      (StateMachineTransition state input))
-&gt; InvalidTransition state input
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (State state) -&gt; input -&gt; InvalidTransition state input
forall s i. Maybe (State s) -&gt; i -&gt; InvalidTransition s i
</span><a href="Plutus.Contract.StateMachine.html#InvalidTransition"><span class="hs-identifier hs-var">InvalidTransition</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (State state)
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837409"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-527"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837404"><span class="annot"><span class="annottext">OnChainState state input
</span><a href="#local-6989586621680837404"><span class="hs-identifier hs-var">onChainState</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837403"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837403"><span class="hs-identifier hs-var">utxo</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-528"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Plutus.Contract.StateMachine.html#OnChainState"><span class="hs-identifier hs-type">OnChainState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680837402"><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input)
ocsTxOutRef :: TypedScriptTxOutRef (StateMachine state input)
ocsTxOutRef :: forall s i.
OnChainState s i -&gt; TypedScriptTxOutRef (StateMachine s i)
</span><a href="#local-6989586621680837402"><span class="hs-identifier hs-var hs-var">ocsTxOutRef</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnChainState state input
</span><a href="#local-6989586621680837404"><span class="hs-identifier hs-var">onChainState</span></a></span><span>
</span><span id="line-529"></span><span>                </span><span id="local-6989586621680837401"><span class="annot"><span class="annottext">oldState :: State state
</span><a href="#local-6989586621680837401"><span class="hs-identifier hs-var hs-var">oldState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State :: forall s. s -&gt; Value -&gt; State s
</span><a href="Plutus.Contract.StateMachine.OnChain.html#State"><span class="hs-identifier hs-type">State</span></a></span><span>
</span><span id="line-530"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stateData :: state
</span><a href="Plutus.Contract.StateMachine.OnChain.html#stateData"><span class="hs-identifier hs-var">stateData</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnChainState state input -&gt; state
forall s i. OnChainState s i -&gt; s
</span><a href="Plutus.Contract.StateMachine.html#getStateData"><span class="hs-identifier hs-var">getStateData</span></a></span><span> </span><span class="annot"><span class="annottext">OnChainState state input
</span><a href="#local-6989586621680837404"><span class="hs-identifier hs-var">onChainState</span></a></span><span>
</span><span id="line-531"></span><span>                      </span><span class="hs-comment">-- Hide the thread token value from the client code</span><span>
</span><span id="line-532"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stateValue :: Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#stateValue"><span class="hs-identifier hs-var">stateValue</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxOut -&gt; Value
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">V2.txOutValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedScriptTxOut (StateMachine state input) -&gt; TxOut
forall a. TypedScriptTxOut a -&gt; TxOut
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutTxOut</span></a></span><span> </span><span class="annot"><span class="annottext">(TypedScriptTxOut (StateMachine state input) -&gt; TxOut)
-&gt; TypedScriptTxOut (StateMachine state input) -&gt; TxOut
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input)
-&gt; TypedScriptTxOut (StateMachine state input)
forall a. TypedScriptTxOutRef a -&gt; TypedScriptTxOut a
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutRefOut</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input)
</span><a href="#local-6989586621680837402"><span class="hs-identifier hs-var">ocsTxOutRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value
forall a. Group a =&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">inv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachineInstance state input -&gt; Value
forall s i. StateMachineInstance s i -&gt; Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#threadTokenValueOrZero"><span class="hs-identifier hs-var">SM.threadTokenValueOrZero</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837410"><span class="hs-identifier hs-var">scInstance</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-534"></span><span>                </span><span id="local-6989586621680837400"><span class="annot"><span class="annottext">inputConstraints :: TxConstraints input Any
</span><a href="#local-6989586621680837400"><span class="hs-identifier hs-var hs-var">inputConstraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; input -&gt; TxConstraints input Any
forall i o. TxOutRef -&gt; i -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">mustSpendOutputFromTheScript</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input) -&gt; TxOutRef
forall a. TypedScriptTxOutRef a -&gt; TxOutRef
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var hs-var">Typed.tyTxOutRefRef</span></a></span><span> </span><span class="annot"><span class="annottext">TypedScriptTxOutRef (StateMachine state input)
</span><a href="#local-6989586621680837402"><span class="hs-identifier hs-var">ocsTxOutRef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837409"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">State state
-&gt; input -&gt; Maybe (TxConstraints Void Void, State state)
</span><a href="#local-6989586621680837406"><span class="hs-identifier hs-var">smTransition</span></a></span><span> </span><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837401"><span class="hs-identifier hs-var">oldState</span></a></span><span> </span><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837409"><span class="hs-identifier hs-var">input</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-537"></span><span>                </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680837399"><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680837399"><span class="hs-identifier hs-var">newConstraints</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680837398"><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837398"><span class="hs-identifier hs-var">newState</span></a></span></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-538"></span><span>                    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680837397"><span class="annot"><span class="annottext">isFinal :: Bool
</span><a href="#local-6989586621680837397"><span class="hs-identifier hs-var hs-var">isFinal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachine state input -&gt; state -&gt; Bool
forall s i. StateMachine s i -&gt; s -&gt; Bool
</span><a href="Plutus.Contract.StateMachine.OnChain.html#smFinal"><span class="hs-identifier hs-var hs-var">smFinal</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachine state input
</span><a href="#local-6989586621680837408"><span class="hs-identifier hs-var">stateMachine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State state -&gt; state
forall s. State s -&gt; s
</span><a href="Plutus.Contract.StateMachine.OnChain.html#stateData"><span class="hs-identifier hs-var hs-var">stateData</span></a></span><span> </span><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837398"><span class="hs-identifier hs-var">newState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>                        </span><span id="local-6989586621680837396"><span class="annot"><span class="annottext">lookups :: ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837396"><span class="hs-identifier hs-var hs-var">lookups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-540"></span><span>                            </span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. TypedValidator a -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.typedValidatorLookups</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
</span><a href="#local-6989586621680837407"><span class="hs-identifier hs-var">typedValidator</span></a></span><span>
</span><span id="line-541"></span><span>                            </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
-&gt; ScriptLookups (StateMachine state input)
forall a. Map TxOutRef DecoratedTxOut -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.unspentOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680837403"><span class="hs-identifier hs-var">utxo</span></a></span><span>
</span><span id="line-542"></span><span>                            </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
-&gt; ScriptLookups (StateMachine state input)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680837397"><span class="hs-identifier hs-var">isFinal</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(ThreadToken -&gt; ScriptLookups (StateMachine state input))
-&gt; Maybe ThreadToken -&gt; ScriptLookups (StateMachine state input)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MintingPolicy -&gt; ScriptLookups (StateMachine state input)
forall a. MintingPolicy -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">plutusV1MintingPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">(MintingPolicy -&gt; ScriptLookups (StateMachine state input))
-&gt; (ThreadToken -&gt; MintingPolicy)
-&gt; ThreadToken
-&gt; ScriptLookups (StateMachine state input)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; MintingPolicy
</span><a href="Plutus.Contract.StateMachine.ThreadToken.html#curPolicy"><span class="hs-identifier hs-var">curPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">(TxOutRef -&gt; MintingPolicy)
-&gt; (ThreadToken -&gt; TxOutRef) -&gt; ThreadToken -&gt; MintingPolicy
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ThreadToken -&gt; TxOutRef
</span><a href="Plutus.Contract.StateMachine.ThreadToken.html#ttOutRef"><span class="hs-identifier hs-var hs-var">ttOutRef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachine state input -&gt; Maybe ThreadToken
forall s i. StateMachine s i -&gt; Maybe ThreadToken
</span><a href="Plutus.Contract.StateMachine.OnChain.html#smThreadToken"><span class="hs-identifier hs-var hs-var">smThreadToken</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachine state input
</span><a href="#local-6989586621680837408"><span class="hs-identifier hs-var">stateMachine</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-543"></span><span>                        </span><span id="local-6989586621680837395"><span class="annot"><span class="annottext">red :: Redeemer
</span><a href="#local-6989586621680837395"><span class="hs-identifier hs-var hs-var">red</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuiltinData -&gt; Redeemer
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Ledger.Redeemer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ValidatorHash, MintingPolarity) -&gt; BuiltinData
forall a. ToData a =&gt; a -&gt; BuiltinData
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.toBuiltinData</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input) -&gt; ValidatorHash
forall a. TypedValidator a -&gt; ValidatorHash
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.validatorHash</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine state input)
</span><a href="#local-6989586621680837407"><span class="hs-identifier hs-var">typedValidator</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MintingPolarity
</span><a href="Plutus.Contract.StateMachine.MintingPolarity.html#Burn"><span class="hs-identifier hs-var">Burn</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-544"></span><span>                        </span><span id="local-6989586621680837394"><span class="annot"><span class="annottext">unmint :: TxConstraints Void Void
</span><a href="#local-6989586621680837394"><span class="hs-identifier hs-var hs-var">unmint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680837397"><span class="hs-identifier hs-var">isFinal</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Redeemer -&gt; Value -&gt; TxConstraints Void Void
forall i o. Redeemer -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">mustMintValueWithRedeemer</span></a></span><span> </span><span class="annot"><span class="annottext">Redeemer
</span><a href="#local-6989586621680837395"><span class="hs-identifier hs-var">red</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; Value
forall a. Group a =&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">inv</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; Value) -&gt; Value -&gt; Value
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input -&gt; Value
forall s i. StateMachineInstance s i -&gt; Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#threadTokenValueOrZero"><span class="hs-identifier hs-var">SM.threadTokenValueOrZero</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837410"><span class="hs-identifier hs-var">scInstance</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-545"></span><span>                        </span><span class="hs-comment">-- Add the thread token value back to the output</span><span>
</span><span id="line-546"></span><span>                        </span><span id="local-6989586621680837393"><span class="annot"><span class="annottext">valueWithToken :: Value
</span><a href="#local-6989586621680837393"><span class="hs-identifier hs-var hs-var">valueWithToken</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State state -&gt; Value
forall s. State s -&gt; Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#stateValue"><span class="hs-identifier hs-var hs-var">stateValue</span></a></span><span> </span><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837398"><span class="hs-identifier hs-var">newState</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input -&gt; Value
forall s i. StateMachineInstance s i -&gt; Value
</span><a href="Plutus.Contract.StateMachine.OnChain.html#threadTokenValueOrZero"><span class="hs-identifier hs-var">SM.threadTokenValueOrZero</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance state input
</span><a href="#local-6989586621680837410"><span class="hs-identifier hs-var">scInstance</span></a></span><span>
</span><span id="line-547"></span><span>                        </span><span id="local-6989586621680837392"><span class="annot"><span class="annottext">outputConstraints :: TxConstraints Any state
</span><a href="#local-6989586621680837392"><span class="hs-identifier hs-var hs-var">outputConstraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680837397"><span class="hs-identifier hs-var">isFinal</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TxConstraints Any state
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">state -&gt; Value -&gt; TxConstraints Any state
forall o i. o -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">mustPayToTheScriptWithDatumInTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State state -&gt; state
forall s. State s -&gt; s
</span><a href="Plutus.Contract.StateMachine.OnChain.html#stateData"><span class="hs-identifier hs-var hs-var">stateData</span></a></span><span> </span><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837398"><span class="hs-identifier hs-var">newState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680837393"><span class="hs-identifier hs-var">valueWithToken</span></a></span><span>
</span><span id="line-548"></span><span>                    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Either
  (InvalidTransition state input)
  (StateMachineTransition state input)
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-549"></span><span>                        </span><span class="annot"><span class="annottext">(Either
   (InvalidTransition state input)
   (StateMachineTransition state input)
 -&gt; Contract
      w
      schema
      e
      (Either
         (InvalidTransition state input)
         (StateMachineTransition state input)))
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineTransition state input
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span>
</span><span id="line-550"></span><span>                        </span><span class="annot"><span class="annottext">(StateMachineTransition state input
 -&gt; Either
      (InvalidTransition state input)
      (StateMachineTransition state input))
-&gt; StateMachineTransition state input
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineTransition :: forall state input.
TxConstraints input state
-&gt; State state
-&gt; State state
-&gt; ScriptLookups (StateMachine state input)
-&gt; StateMachineTransition state input
</span><a href="Plutus.Contract.StateMachine.html#StateMachineTransition"><span class="hs-identifier hs-type">StateMachineTransition</span></a></span><span>
</span><span id="line-551"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">smtConstraints :: TxConstraints input state
</span><a href="Plutus.Contract.StateMachine.html#smtConstraints"><span class="hs-identifier hs-var">smtConstraints</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-552"></span><span>                                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680837399"><span class="hs-identifier hs-var">newConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680837394"><span class="hs-identifier hs-var">unmint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>                                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">txOwnInputs :: [ScriptInputConstraint input]
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">txOwnInputs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxConstraints input Any -&gt; [ScriptInputConstraint input]
forall i o. TxConstraints i o -&gt; [ScriptInputConstraint i]
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var hs-var">txOwnInputs</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints input Any
</span><a href="#local-6989586621680837400"><span class="hs-identifier hs-var">inputConstraints</span></a></span><span>
</span><span id="line-554"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">txOwnOutputs :: [ScriptOutputConstraint state]
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">txOwnOutputs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxConstraints Any state -&gt; [ScriptOutputConstraint state]
forall i o. TxConstraints i o -&gt; [ScriptOutputConstraint o]
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var hs-var">txOwnOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints Any state
</span><a href="#local-6989586621680837392"><span class="hs-identifier hs-var">outputConstraints</span></a></span><span>
</span><span id="line-555"></span><span>                                    </span><span class="hs-special">}</span><span>
</span><span id="line-556"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">smtOldState :: State state
</span><a href="Plutus.Contract.StateMachine.html#smtOldState"><span class="hs-identifier hs-var">smtOldState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837401"><span class="hs-identifier hs-var">oldState</span></a></span><span>
</span><span id="line-557"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">smtNewState :: State state
</span><a href="Plutus.Contract.StateMachine.html#smtNewState"><span class="hs-identifier hs-var">smtNewState</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837398"><span class="hs-identifier hs-var">newState</span></a></span><span>
</span><span id="line-558"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">smtLookups :: ScriptLookups (StateMachine state input)
</span><a href="Plutus.Contract.StateMachine.html#smtLookups"><span class="hs-identifier hs-var">smtLookups</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptLookups (StateMachine state input)
</span><a href="#local-6989586621680837396"><span class="hs-identifier hs-var">lookups</span></a></span><span>
</span><span id="line-559"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-560"></span><span>                </span><span class="annot"><span class="annottext">Maybe (TxConstraints Void Void, State state)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either
  (InvalidTransition state input)
  (StateMachineTransition state input)
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Either
   (InvalidTransition state input)
   (StateMachineTransition state input)
 -&gt; Contract
      w
      schema
      e
      (Either
         (InvalidTransition state input)
         (StateMachineTransition state input)))
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
-&gt; Contract
     w
     schema
     e
     (Either
        (InvalidTransition state input)
        (StateMachineTransition state input))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">InvalidTransition state input
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(InvalidTransition state input
 -&gt; Either
      (InvalidTransition state input)
      (StateMachineTransition state input))
-&gt; InvalidTransition state input
-&gt; Either
     (InvalidTransition state input)
     (StateMachineTransition state input)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (State state) -&gt; input -&gt; InvalidTransition state input
forall s i. Maybe (State s) -&gt; i -&gt; InvalidTransition s i
</span><a href="Plutus.Contract.StateMachine.html#InvalidTransition"><span class="hs-identifier hs-var">InvalidTransition</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State state -&gt; Maybe (State state)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">State state
</span><a href="#local-6989586621680837401"><span class="hs-identifier hs-var">oldState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">input
</span><a href="#local-6989586621680837409"><span class="hs-identifier hs-var">input</span></a></span><span>
</span><span id="line-561"></span></pre></body></html>
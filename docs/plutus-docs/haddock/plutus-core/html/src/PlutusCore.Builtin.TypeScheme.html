<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- | This module assigns types to built-ins.</span><span>
</span><span id="line-2"></span><span class="hs-comment">-- See the @plutus/plutus-core/docs/Constant application.md@</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- article for how this emerged.</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DataKinds        #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE GADTs            #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE KindSignatures   #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies     #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators    #-}</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE StrictData       #-}</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">PlutusCore.Builtin.TypeScheme</span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier">TypeScheme</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#argProxy"><span class="hs-identifier">argProxy</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier">typeSchemeToType</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownKind.html"><span class="hs-identifier">PlutusCore.Builtin.KnownKind</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html"><span class="hs-identifier">PlutusCore.Builtin.KnownType</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html"><span class="hs-identifier">PlutusCore.Builtin.KnownTypeAst</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Core.html"><span class="hs-identifier">PlutusCore.Core</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="PlutusCore.Name.html"><span class="hs-identifier">PlutusCore.Name</span></a></span><span>
</span><span id="line-25"></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Kind</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GHC</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier">Type</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Proxy</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Text</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.TypeLits</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">infixr</span><span> </span><span class="hs-number">9</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeArrow"><span class="hs-operator hs-type">`TypeSchemeArrow`</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">{- Note [MakeKnown in TypeSchemeArrow]
There's a @MakeKnown val arg@ constrained packed in the 'TypeSchemeArrow' constructor. It's not
supposed to be there, but unfortunately, in the @Generators@ tests we use 'TypeScheme' for
generation of arbitrary arguments of builtins and that requires 'makeKnown', which makes us have
the 'MakeKnown' in 'TypeSchemeArrow'.

The solution is to fix the @Generators@ tests. Explicitly constraining @args@ outside of
'TypeScheme' sounds like a promising strategy. Maybe we could just delete those tests altogether.

However it's also worth considering untangling 'RuntimeScheme' from 'TypeScheme' and generating the
two in parallel, so that we only need to optimize the former. Then we will be able to afford having
any kind of nonsense in 'TypeScheme'. Another reason for that would be the fact that Core output
has 'typeSchemeToRuntimeScheme' all over the place as it can't be inlined due to being a recursive
function, which we can't turn into an inlinable class method, because the indices of 'TypeScheme'
don't reflect its structure due to the 'TypeSchemeAll' constructor not being reflected at the type
level in any way. It's unlikely that having those 'typeSchemeToRuntimeScheme' has any impact on
performance, because they're only evaluated once during initialization, but it certainly has impact
on readability of the Core output.
-}</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-comment">-- | Type schemes of primitive operations.</span><span>
</span><span id="line-54"></span><span class="hs-comment">-- @as@ is a list of types of arguments, @r@ is the resulting type.</span><span>
</span><span id="line-55"></span><span class="hs-comment">-- E.g. @Text -&gt; Bool -&gt; Integer@ is encoded as @TypeScheme val [Text, Bool] Integer@.</span><span>
</span><span id="line-56"></span><span class="hs-keyword">data</span><span> </span><span id="TypeScheme"><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-var">TypeScheme</span></a></span></span><span> </span><span id="local-6989586621680956259"><span class="annot"><a href="#local-6989586621680956259"><span class="hs-identifier hs-type">val</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680956258"><span class="annot"><a href="#local-6989586621680956258"><span class="hs-identifier hs-type">args</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">GHC.Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621680956257"><span class="annot"><a href="#local-6989586621680956257"><span class="hs-identifier hs-type">res</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-57"></span><span>    </span><span id="local-6989586621680956255"><span id="local-6989586621680956256"><span id="TypeSchemeResult"><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeResult"><span class="hs-identifier hs-var">TypeSchemeResult</span></a></span></span><span>
</span><span id="line-58"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html#KnownTypeAst"><span class="hs-identifier hs-type">KnownTypeAst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#UniOf"><span class="hs-identifier hs-type">UniOf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956256"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680956255"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#MakeKnown"><span class="hs-identifier hs-type">MakeKnown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956256"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956255"><span class="hs-identifier hs-type">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956256"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621680956255"><span class="hs-identifier hs-type">res</span></a></span></span></span><span>
</span><span id="line-60"></span><span>    </span><span id="local-6989586621680956249"><span id="local-6989586621680956250"><span id="local-6989586621680956251"><span id="local-6989586621680956252"><span id="TypeSchemeArrow"><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeArrow"><span class="hs-identifier hs-var">TypeSchemeArrow</span></a></span></span><span>
</span><span id="line-61"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.KnownTypeAst.html#KnownTypeAst"><span class="hs-identifier hs-type">KnownTypeAst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#UniOf"><span class="hs-identifier hs-type">UniOf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956252"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680956251"><span class="hs-identifier hs-type">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#MakeKnown"><span class="hs-identifier hs-type">MakeKnown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956252"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956251"><span class="hs-identifier hs-type">arg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownType.html#ReadKnown"><span class="hs-identifier hs-type">ReadKnown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956252"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956251"><span class="hs-identifier hs-type">arg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956252"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956250"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956249"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956252"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956251"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680956250"><span class="hs-identifier hs-type">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680956249"><span class="hs-identifier hs-type">res</span></a></span></span></span></span></span><span>
</span><span id="line-63"></span><span>    </span><span id="local-6989586621680956242"><span id="local-6989586621680956243"><span id="local-6989586621680956244"><span id="local-6989586621680956245"><span id="local-6989586621680956246"><span id="local-6989586621680956247"><span id="TypeSchemeAll"><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeAll"><span class="hs-identifier hs-var">TypeSchemeAll</span></a></span></span><span>
</span><span id="line-64"></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">KnownSymbol</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956247"><span class="hs-identifier hs-type">text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">KnownNat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956246"><span class="hs-identifier hs-type">uniq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.KnownKind.html#KnownKind"><span class="hs-identifier hs-type">KnownKind</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956245"><span class="hs-identifier hs-type">kind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>           </span><span class="hs-comment">-- Here we require the user to manually provide the unique of a type variable.</span><span>
</span><span id="line-66"></span><span>           </span><span class="hs-comment">-- That's nothing but silly, but I do not see what else we can do with the current design.</span><span>
</span><span id="line-67"></span><span>        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956247"><span class="hs-identifier hs-type">text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680956246"><span class="hs-identifier hs-type">uniq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680956245"><span class="hs-identifier hs-type">kind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956244"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956243"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956242"><span class="hs-identifier hs-type">res</span></a></span><span>
</span><span id="line-69"></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956244"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956243"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956242"><span class="hs-identifier hs-type">res</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span id="local-6989586621680956284"><span id="local-6989586621680956285"><span id="local-6989586621680956286"><span id="local-6989586621680956287"><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#argProxy"><span class="hs-identifier hs-type">argProxy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956287"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956286"><span class="hs-identifier hs-type">arg</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621680956285"><span class="hs-identifier hs-type">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680956284"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956286"><span class="hs-identifier hs-type">arg</span></a></span></span></span></span></span><span>
</span><span id="line-72"></span><span id="argProxy"><span class="annot"><span class="annottext">argProxy :: TypeScheme val (arg : args) res -&gt; Proxy arg
</span><a href="PlutusCore.Builtin.TypeScheme.html#argProxy"><span class="hs-identifier hs-var hs-var">argProxy</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeScheme val (arg : args) res
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy arg
forall k (t :: k). Proxy t
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span>
</span><span id="line-73"></span><span>
</span><span id="line-74"></span><span class="hs-comment">-- | Convert a 'TypeScheme' to the corresponding 'Type'.</span><span>
</span><span id="line-75"></span><span class="hs-comment">-- Basically, a map from the PHOAS representation to the FOAS one.</span><span>
</span><span id="line-76"></span><span id="local-6989586621680956281"><span id="local-6989586621680956282"><span id="local-6989586621680956283"><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier hs-type">typeSchemeToType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeScheme"><span class="hs-identifier hs-type">TypeScheme</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956283"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956282"><span class="hs-identifier hs-type">args</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956281"><span class="hs-identifier hs-type">res</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="PlutusCore.Core.Type.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="annot"><a href="PlutusCore.Name.html#TyName"><span class="hs-identifier hs-type">TyName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Core.Type.html#UniOf"><span class="hs-identifier hs-type">UniOf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680956283"><span class="hs-identifier hs-type">val</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-77"></span><span id="typeSchemeToType"><span class="annot"><span class="annottext">typeSchemeToType :: TypeScheme val args res -&gt; Type TyName (UniOf val) ()
</span><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier hs-var hs-var">typeSchemeToType</span></a></span></span><span> </span><span id="local-6989586621680956239"><span class="annot"><span class="annottext">sch :: TypeScheme val args res
</span><a href="#local-6989586621680956239"><span class="hs-identifier hs-var">sch</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><span class="annottext">TypeScheme val args res
</span><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeResult"><span class="hs-identifier hs-var">TypeSchemeResult</span></a></span><span>       </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res -&gt; Type TyName (UniOf val) ()
forall a (uni :: * -&gt; *) (x :: a) (proxy :: a -&gt; *).
KnownTypeAst uni x =&gt;
proxy x -&gt; Type TyName uni ()
</span><a href="PlutusCore.Builtin.KnownTypeAst.html#toTypeAst"><span class="hs-identifier hs-var">toTypeAst</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res
</span><a href="#local-6989586621680956239"><span class="hs-identifier hs-var">sch</span></a></span><span>
</span><span id="line-78"></span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier hs-var">typeSchemeToType</span></a></span><span> </span><span id="local-6989586621680956237"><span class="annot"><span class="annottext">sch :: TypeScheme val args res
</span><a href="#local-6989586621680956237"><span class="hs-identifier hs-var">sch</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeArrow"><span class="hs-identifier hs-type">TypeSchemeArrow</span></a></span><span> </span><span id="local-6989586621680956236"><span class="annot"><span class="annottext">TypeScheme val args res
</span><a href="#local-6989586621680956236"><span class="hs-identifier hs-var">schB</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><span class="annottext">()
-&gt; Type TyName (UniOf val) ()
-&gt; Type TyName (UniOf val) ()
-&gt; Type TyName (UniOf val) ()
forall tyname (uni :: * -&gt; *) ann.
ann
-&gt; Type tyname uni ann
-&gt; Type tyname uni ann
-&gt; Type tyname uni ann
</span><a href="PlutusCore.Core.Type.html#TyFun"><span class="hs-identifier hs-var">TyFun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy arg -&gt; Type TyName (UniOf val) ()
forall a (uni :: * -&gt; *) (x :: a) (proxy :: a -&gt; *).
KnownTypeAst uni x =&gt;
proxy x -&gt; Type TyName uni ()
</span><a href="PlutusCore.Builtin.KnownTypeAst.html#toTypeAst"><span class="hs-identifier hs-var">toTypeAst</span></a></span><span> </span><span class="annot"><span class="annottext">(Proxy arg -&gt; Type TyName (UniOf val) ())
-&gt; Proxy arg -&gt; Type TyName (UniOf val) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val (arg : args) res -&gt; Proxy arg
forall val arg (args :: [*]) res.
TypeScheme val (arg : args) res -&gt; Proxy arg
</span><a href="PlutusCore.Builtin.TypeScheme.html#argProxy"><span class="hs-identifier hs-var">argProxy</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res
TypeScheme val (arg : args) res
</span><a href="#local-6989586621680956237"><span class="hs-identifier hs-var">sch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Type TyName (UniOf val) () -&gt; Type TyName (UniOf val) ())
-&gt; Type TyName (UniOf val) () -&gt; Type TyName (UniOf val) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res -&gt; Type TyName (UniOf val) ()
forall val (args :: [*]) res.
TypeScheme val args res -&gt; Type TyName (UniOf val) ()
</span><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier hs-var">typeSchemeToType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res
</span><a href="#local-6989586621680956236"><span class="hs-identifier hs-var">schB</span></a></span><span>
</span><span id="line-80"></span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier hs-var">typeSchemeToType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="PlutusCore.Builtin.TypeScheme.html#TypeSchemeAll"><span class="hs-identifier hs-type">TypeSchemeAll</span></a></span><span> </span><span id="local-6989586621680956234"><span class="annot"><span class="annottext">Proxy '(text, uniq, kind)
</span><a href="#local-6989586621680956234"><span class="hs-identifier hs-var">proxy</span></a></span></span><span> </span><span id="local-6989586621680956233"><span class="annot"><span class="annottext">TypeScheme val args res
</span><a href="#local-6989586621680956233"><span class="hs-identifier hs-var">schK</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Proxy '(text, uniq, kind)
</span><a href="#local-6989586621680956234"><span class="hs-identifier hs-var">proxy</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680956230"><span id="local-6989586621680956231"><span id="local-6989586621680956232"><span class="annot"><span class="annottext">Proxy '(text, uniq, kind)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Proxy</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680956232"><span class="hs-identifier hs-type">text</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680956231"><span class="hs-identifier hs-type">uniq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680956230"><span class="hs-identifier hs-type">kind</span></a></span><span class="hs-special">)</span></span></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-82"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680956229"><span class="annot"><span class="annottext">text :: Text
</span><a href="#local-6989586621680956229"><span class="hs-identifier hs-var hs-var">text</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Text
</span><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier hs-var">Text.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Text) -&gt; String -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy text -&gt; String
forall (n :: Symbol) (proxy :: Symbol -&gt; *).
KnownSymbol n =&gt;
proxy n -&gt; String
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">symbolVal</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680956232"><span class="hs-identifier hs-type">text</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy text
forall k (t :: k). Proxy t
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span>
</span><span id="line-83"></span><span>            </span><span id="local-6989586621680956226"><span class="annot"><span class="annottext">uniq :: Int
</span><a href="#local-6989586621680956226"><span class="hs-identifier hs-var hs-var">uniq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Int) -&gt; Integer -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy uniq -&gt; Integer
forall (n :: Nat) (proxy :: Nat -&gt; *).
KnownNat n =&gt;
proxy n -&gt; Integer
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">natVal</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680956231"><span class="hs-identifier hs-type">uniq</span></a></span><span> </span><span class="annot"><span class="annottext">Proxy uniq
forall k (t :: k). Proxy t
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Proxy</span></a></span><span>
</span><span id="line-84"></span><span>            </span><span id="local-6989586621680956224"><span class="annot"><span class="annottext">a :: TyName
</span><a href="#local-6989586621680956224"><span class="hs-identifier hs-var hs-var">a</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; TyName
</span><a href="PlutusCore.Name.html#TyName"><span class="hs-identifier hs-var">TyName</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; TyName) -&gt; Name -&gt; TyName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Unique -&gt; Name
</span><a href="PlutusCore.Name.html#Name"><span class="hs-identifier hs-var">Name</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621680956229"><span class="hs-identifier hs-var">text</span></a></span><span> </span><span class="annot"><span class="annottext">(Unique -&gt; Name) -&gt; Unique -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Unique
</span><a href="PlutusCore.Name.html#Unique"><span class="hs-identifier hs-var">Unique</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621680956226"><span class="hs-identifier hs-var">uniq</span></a></span><span>
</span><span id="line-85"></span><span>        </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">()
-&gt; TyName
-&gt; Kind ()
-&gt; Type TyName (UniOf val) ()
-&gt; Type TyName (UniOf val) ()
forall tyname (uni :: * -&gt; *) ann.
ann
-&gt; tyname -&gt; Kind ann -&gt; Type tyname uni ann -&gt; Type tyname uni ann
</span><a href="PlutusCore.Core.Type.html#TyForall"><span class="hs-identifier hs-var">TyForall</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TyName
</span><a href="#local-6989586621680956224"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SingKind kind -&gt; Kind ()
forall k. SingKind k -&gt; Kind ()
</span><a href="PlutusCore.Builtin.KnownKind.html#demoteKind"><span class="hs-identifier hs-var">demoteKind</span></a></span><span> </span><span class="annot"><span class="annottext">(SingKind kind -&gt; Kind ()) -&gt; SingKind kind -&gt; Kind ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">KnownKind kind =&gt; SingKind kind
forall k. KnownKind k =&gt; SingKind k
</span><a href="PlutusCore.Builtin.KnownKind.html#knownKind"><span class="hs-identifier hs-var">knownKind</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621680956230"><span class="hs-identifier hs-type">kind</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Type TyName (UniOf val) () -&gt; Type TyName (UniOf val) ())
-&gt; Type TyName (UniOf val) () -&gt; Type TyName (UniOf val) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res -&gt; Type TyName (UniOf val) ()
forall val (args :: [*]) res.
TypeScheme val args res -&gt; Type TyName (UniOf val) ()
</span><a href="PlutusCore.Builtin.TypeScheme.html#typeSchemeToType"><span class="hs-identifier hs-var">typeSchemeToType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeScheme val args res
</span><a href="#local-6989586621680956233"><span class="hs-identifier hs-var">schK</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="hs-comment">{- Note [Pattern matching on built-in types]
At the moment we really only support direct pattern matching on enumeration types: 'Void', 'Unit',
'Bool' etc. This is because the denotation of a builtin cannot construct general terms (as opposed
to constants), only juggle the ones that were provided as arguments without changing them.
So e.g. if we wanted to add the following data type:

    newtype AnInt = AnInt Int

as a built-in type, we wouldn't be able to add the following function as its pattern matcher:

    matchAnInt :: AnInt -&gt; (Int -&gt; r) -&gt; r
    matchAnInt (AnInt i) f = f i

because currently we cannot express the @f i@ part using the builtins machinery as that would
require applying an arbitrary Plutus Core function in the denotation of a builtin, which would
allow us to return arbitrary terms from the builtin application machinery, which is something
that we originally had, but decided to abandon due to performance concerns.

But it's still possible to have @AnInt@ as a built-in type, it's just that instead of trying to
make its pattern matcher into a builtin we can have the following builtin:

    anIntToInt :: AnInt -&gt; Int
    anIntToInt (AnInt i) = i

which fits perfectly well into the builtins machinery.

Although that becomes annoying for more complex data types. For tuples we need to provide two
projection functions ('fst' and 'snd') instead of a single pattern matcher, which is not too
bad, but to get pattern matching on lists we need three built-in functions: @null@, @head@ and
@tail@ and to require `Bool` to be in the universe to be able to define a PLC equivalent of

    matchList :: [a] -&gt; r -&gt; (a -&gt; [a] -&gt; r) -&gt; r
    matchList xs z f = if null xs then z else f (head xs) (tail xs)

If a constructor stores more than one value, the corresponding projection function packs them
into a (possibly nested) pair, for example for

    data Data
        = Constr Integer [Data]
        | &lt;...&gt;

we have (pseudocode):

    unConstrData (Constr i ds) = (i, ds)

In order to get pattern matching over 'Data' we need a projection function per constructor as well
as with lists, but writing (where the @Data@ suffix indicates that a function is a builtin that
somehow corresponds to a constructor of 'Data')

    if isConstrData d
        then uncurry fConstr $ unConstrData d
        else if isMapData d
            then fMap $ unMapData d
            else if isListData d
                then fList $ unListData d
                else &lt;...&gt;

is tedious and inefficient and so instead we have a single @chooseData@ builtin that matches on
its @Data@ argument and chooses the appropriate branch (type instantiations and strictness concerns
are omitted for clarity):

     chooseData
        (uncurry fConstr $ unConstrData d)
        (fMap $ unMapData d)
        (fList $ unListData d)
        &lt;...&gt;
        d

which, for example, evaluates to @fMap es@ when @d@ is @Map es@

On the bright side, this encoding of pattern matchers does work, so maybe it's indeed worth to
prioritize performance over convenience, especially given the fact that performance is of a concern
to every single end user while the inconvenience is only a concern for the compiler writers and
we don't add complex built-in types too often.
-}</span><span>
</span><span id="line-162"></span><span>
</span><span id="line-163"></span><span class="hs-comment">{- Note [Representable built-in functions over polymorphic built-in types]
In Note [Pattern matching on built-in types] we talked about how general higher-order polymorphic
built-in functions are troubling, but polymorphic built-in functions can be troubling even in
the first-order case. In a Plutus program we always pair constants of built-in types with their
tags from the universe, which means that in order to produce a constant embedded into a program
we need the tag of the type of that constant. We can't get that tag from a Plutus type -- those
are gone at runtime, so the only place we can get a type tag from during evaluation is some already
existing constant. I.e. the following built-in function is representable:

    tail : all a. [a] -&gt; [a]

because for constructing the result we need a type tag for @[a]@, but we have a value of that type
as an argument and so we can extract the type tag from it. Same applies to

    swap : all a b. (a, b) -&gt; (b, a)

since 'SomeConstantOf' always contains a type tag for each type that a polymorphic built-in type is
instantiated with and so constructing a type tag for @(b, a)@ given type tags for @a@ and @b@ is
unproblematic.

And so neither

    cons : all a. a -&gt; [a] -&gt; [a]

is troubling (even though that ones requires checking at runtime that the element to be prepended
is of the same type as the type of the elements of the list as it's impossible to enforce this kind
of type safety in Haskell over possibly untyped PLC).

However consider the following imaginary builtin:

    nil : all a. [a]

we can't represent it for two reasons:

1. we don't have any argument providing us a type tag for @a@ and hence we can't construct a type
   tag for @[a]@
2. it would be a very unsound builtin to have. We can only instantiate built-in types with other
   built-in types and so allowing @nil {some_non_built_in_type}@ would be a lie that couldn't reduce
   to anything since it's not even possible to represent a built-in list with non-built-in elements
   (even if there's zero of them)

&quot;Wait, but wouldn't @cons {some_non_built_in_type}@ be a lie as well?&quot; -- No! Since @cons@ does not
just construct a list filled with elements of a non-built-in type but also expects one as an
argument and providing such an argument is impossible, 'cause it's pretty much the same thing as
populating 'Void' -- both values are equally unrepresentable. And so @cons {some_non_built_in_type}@
is a way to say @absurd@, which is perfectly fine to have.

Finally,

    comma :: all a b. a -&gt; b -&gt; (a, b)

is representable (because we can require arguments to be constants carrying universes with them,
which we can use to construct the resulting universe), but is still a lie, because instantiating
that builtin with non-built-in types is possible and so the PLC type checker won't throw on such
an instantiation, which will become 'EvalutionFailure' at runtime the moment unlifting of a
non-constant is attempted when a constant is expected.

So could we still get @nil@ or a safe version of @comma@ somehow? Well, we could have this
weirdness:

    nilOfTypeOf : all a. [a] -&gt; [a]

i.e. ask for an already existing list, but ignore the actual list and only use the type tag.

But since we're ignoring the actual list, can't we just not pass it in the first place? And instead
pass around our good old friends, singletons. We should be able to do that, but it hasn't been
investigated. Perhaps something along the lines of adding the following constructor to 'DefaultUni':

    DefaultUniProtoSing :: DefaultUni (Esc (Proxy @GHC.Type))

and then defining

    nil : all a. sing a -&gt; [a]

and then the Plutus Tx compiler can provide a type class or something for constructing singletons
for built-in types.
-}</span><span>
</span><span id="line-240"></span></pre></body></html>
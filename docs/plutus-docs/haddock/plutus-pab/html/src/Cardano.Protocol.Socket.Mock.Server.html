<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds         #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts  #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GADTs             #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase        #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns    #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies      #-}</span><span>
</span><span id="line-9"></span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Cardano.Protocol.Socket.Mock.Server</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.BM.Data.Trace</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Trace</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Node.Types.html"><span class="hs-identifier">Cardano.Node.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Node.Types.html#PABServerLogMsg"><span class="hs-identifier">PABServerLogMsg</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/dy85hyx24kbdxbcbs19gvac43vbvvnjd-bytestring-lib-bytestring-0.10.12.0-haddock-doc/share/doc/bytestring/html/src"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LBS</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">intersect</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">listToMaybe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier">Text</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Void</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Concurrent</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/2myid1dmcir40n7j5xgzi0viq9sz375m-tasty-lib-tasty-1.4.3-haddock-doc/share/doc/tasty/html/src"><span class="hs-identifier">Control.Concurrent.Async</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">index</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">ix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier">Control.Monad.Freer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier">interpret</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier">runM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier">Control.Monad.Freer.State</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier">runState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier">Control.Monad.Reader</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/nhl1qjsgl4zpvgrmpa6xzrl7bwwbxld1-contra-tracer-lib-contra-tracer-0.1.0.0-haddock-doc/share/doc/contra-tracer/html/src"><span class="hs-identifier">Control.Tracer</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Server</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">ChainSyncServer</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">ServerStIdle</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">ServerStIntersect</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>                                                    </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">ServerStNext</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Ouroboros.Network.Protocol.ChainSync.Server</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ChainSync</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Ouroboros.Network.Protocol.LocalTxSubmission.Server</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TxSubmission</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Ouroboros.Network.Protocol.LocalTxSubmission.Type</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TxSubmission</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">Plutus.Monitoring.Util</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">LM</span></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier">Cardano.Slotting.Slot</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier">SlotNo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier">WithOrigin</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Ouroboros.Network.Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Point</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">pointSlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier">Ouroboros.Network.IOManager</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier">Ouroboros.Network.Mux</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Ouroboros.Network.NodeToClient</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">NodeToClientProtocols</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">nodeToClientCodecCBORTerm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>                                       </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">nodeToClientHandshakeCodec</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier">nullErrorPolicies</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">versionedNodeToClientProtocols</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Ouroboros.Network.Point</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">OP</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Codec</span></a></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier">Ouroboros.Network.Protocol.Handshake.Version</span></a></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier">Ouroboros.Network.Snocket</span></a></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier">Ouroboros.Network.Socket</span></a></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier">Cardano.Api</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">C</span></span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">Cardano.Protocol.Socket.Type</span></a></span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Cardano.Chain.html"><span class="hs-identifier">Cardano.Chain</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier">MockNodeServerChainState</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#addTxToPool"><span class="hs-identifier">addTxToPool</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#chainNewestFirst"><span class="hs-identifier">chainNewestFirst</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#channel"><span class="hs-identifier">channel</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#currentSlot"><span class="hs-identifier">currentSlot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#getChannel"><span class="hs-identifier">getChannel</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>                      </span><span class="annot"><a href="Cardano.Chain.html#getTip"><span class="hs-identifier">getTip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#handleControlChain"><span class="hs-identifier">handleControlChain</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#tip"><span class="hs-identifier">tip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Cardano.Chain.html#txPool"><span class="hs-identifier">txPool</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">Cardano.Node.Emulator.Chain</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Chain</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">Cardano.Node.Emulator.Params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">Params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Block</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">CardanoTx</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Slot</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">SomeCardanoApiTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">CardanoApiEmulatorEraTx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-keyword">data</span><span> </span><span id="CommandChannel"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#CommandChannel"><span class="hs-identifier hs-var">CommandChannel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="CommandChannel"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#CommandChannel"><span class="hs-identifier hs-var">CommandChannel</span></a></span></span><span>
</span><span id="line-59"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ccCommand"><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerCommand"><span class="hs-identifier hs-type">ServerCommand</span></a></span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ccResponse"><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerResponse
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ccResponse"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TQueue</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerResponse"><span class="hs-identifier hs-type">ServerResponse</span></a></span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-keyword">type</span><span> </span><span id="Error"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#Error"><span class="hs-identifier hs-var">Error</span></a></span></span><span> </span><span id="local-6989586621680385053"><span class="annot"><a href="#local-6989586621680385053"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/71gg7bx8f4jr17lsf2w77qrjmdg3xvan-text-lib-text-1.2.4.1-haddock-doc/share/doc/text/html/src"><span class="hs-identifier hs-type">Text</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385053"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">{- | Clone the original channel for each connected client, then use
     this wrapper to make sure that no data is consumed from the
     original channel. -}</span><span>
</span><span id="line-68"></span><span class="hs-keyword">newtype</span><span> </span><span id="LocalChannel"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-var">LocalChannel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LocalChannel"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-var">LocalChannel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-comment">{- | A handler used to pass around the path to the server
     and channels used for controlling the server. -}</span><span>
</span><span id="line-72"></span><span class="hs-keyword">data</span><span> </span><span id="ServerHandler"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-var">ServerHandler</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ServerHandler"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-var">ServerHandler</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-73"></span><span>    </span><span id="shSocketPath"><span class="annot"><span class="annottext">ServerHandler -&gt; FilePath
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#shSocketPath"><span class="hs-identifier hs-var hs-var">shSocketPath</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-comment">-- The client will send a `ServerCommand` and the server will</span><span>
</span><span id="line-75"></span><span>    </span><span class="hs-comment">-- respond with a `ServerResponse`.</span><span>
</span><span id="line-76"></span><span>    </span><span id="shCommandChannel"><span class="annot"><span class="annottext">ServerHandler -&gt; CommandChannel
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#shCommandChannel"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#CommandChannel"><span class="hs-identifier hs-type">CommandChannel</span></a></span><span>
</span><span id="line-77"></span><span class="hs-special">}</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-comment">{- | The commands that control the server. This API is not part of the client
     interface, and in order to call them directly you will need access to the
     returned ServerHandler -}</span><span>
</span><span id="line-82"></span><span class="hs-keyword">data</span><span> </span><span id="ServerCommand"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerCommand"><span class="hs-identifier hs-var">ServerCommand</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>    </span><span class="hs-comment">-- This command will add a new block by processing</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-comment">-- transactions in the memory pool.</span><span>
</span><span id="line-85"></span><span>    </span><span id="ProcessBlock"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- Set the slot number</span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ModifySlot"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ModifySlot"><span class="hs-identifier hs-var">ModifySlot</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- Append a transaction to the transaction pool.</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AddTx"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#AddTx"><span class="hs-identifier hs-var">AddTx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.Tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.BabbageEra</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680385041"><span id="local-6989586621680385044"><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Show</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerCommand"><span class="hs-identifier hs-type">ServerCommand</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621680385039"><span class="annot"><span class="annottext">show :: ServerCommand -&gt; FilePath
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">show</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ProcessBlock&quot;</span></span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ModifySlot"><span class="hs-identifier hs-type">ModifySlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;ModifySlot&quot;</span></span><span>
</span><span id="line-95"></span><span>        </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#AddTx"><span class="hs-identifier hs-type">AddTx</span></a></span><span> </span><span id="local-6989586621680385037"><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680385037"><span class="hs-identifier hs-var">t</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">FilePath
</span><span class="hs-string">&quot;AddTx &quot;</span></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; FilePath
forall a. Show a =&gt; a -&gt; FilePath
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">show</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680385037"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">{- | The response from the server. Can be used for the information
     passed back, or for synchronisation.
-}</span><span>
</span><span id="line-100"></span><span class="hs-keyword">data</span><span> </span><span id="ServerResponse"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerResponse"><span class="hs-identifier hs-var">ServerResponse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- A block was added. We are using this for synchronization.</span><span>
</span><span id="line-102"></span><span>    </span><span id="BlockAdded"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#BlockAdded"><span class="hs-identifier hs-var">BlockAdded</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span>
</span><span id="line-103"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SlotChanged"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#SlotChanged"><span class="hs-identifier hs-var">SlotChanged</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span id="local-6989586621680385029"><span id="local-6989586621680385031"><span id="local-6989586621680385033"><span class="annot"><span class="annottext">Int -&gt; ServerResponse -&gt; ShowS
[ServerResponse] -&gt; ShowS
ServerResponse -&gt; FilePath
(Int -&gt; ServerResponse -&gt; ShowS)
-&gt; (ServerResponse -&gt; FilePath)
-&gt; ([ServerResponse] -&gt; ShowS)
-&gt; Show ServerResponse
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; FilePath) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ServerResponse] -&gt; ShowS
$cshowList :: [ServerResponse] -&gt; ShowS
show :: ServerResponse -&gt; FilePath
$cshow :: ServerResponse -&gt; FilePath
showsPrec :: Int -&gt; ServerResponse -&gt; ShowS
$cshowsPrec :: Int -&gt; ServerResponse -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span id="local-6989586621680385028"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#processBlock"><span class="hs-identifier hs-type">processBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385028"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385028"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span></span><span>
</span><span id="line-107"></span><span id="processBlock"><span class="annot"><span class="annottext">processBlock :: ServerHandler -&gt; m Block
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#processBlock"><span class="hs-identifier hs-var hs-var">processBlock</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680385026"><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: ServerHandler -&gt; CommandChannel
</span><a href="#local-6989586621680385026"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; ServerCommand -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">writeTQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621680385026"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span><span>
</span><span id="line-109"></span><span>    </span><span class="hs-comment">-- Wait for the server to finish processing blocks.</span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">IO Block -&gt; m Block
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Block -&gt; m Block) -&gt; IO Block -&gt; m Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Block -&gt; IO Block) -&gt; STM Block -&gt; IO Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; STM ServerResponse
forall a. TQueue a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">readTQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerResponse
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ccResponse"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621680385026"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM ServerResponse -&gt; (ServerResponse -&gt; STM Block) -&gt; STM Block
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-111"></span><span>        </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#BlockAdded"><span class="hs-identifier hs-type">BlockAdded</span></a></span><span> </span><span id="local-6989586621680385021"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680385021"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Block -&gt; STM Block
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680385021"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-112"></span><span>        </span><span class="annot"><span class="annottext">ServerResponse
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM Block
forall a. STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span id="local-6989586621680385019"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#modifySlot"><span class="hs-identifier hs-type">modifySlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385019"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385019"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span></span><span>
</span><span id="line-115"></span><span id="modifySlot"><span class="annot"><span class="annottext">modifySlot :: (Slot -&gt; Slot) -&gt; ServerHandler -&gt; m Slot
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#modifySlot"><span class="hs-identifier hs-var hs-var">modifySlot</span></a></span></span><span> </span><span id="local-6989586621680385017"><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621680385017"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span class="hs-special">{</span><span id="local-6989586621680385016"><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: ServerHandler -&gt; CommandChannel
</span><a href="#local-6989586621680385016"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; ServerCommand -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">writeTQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621680385016"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ServerCommand -&gt; STM ()) -&gt; ServerCommand -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; Slot) -&gt; ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ModifySlot"><span class="hs-identifier hs-var">ModifySlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621680385017"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-comment">-- Wait for the server to finish changing the slot.</span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><span class="annottext">IO Slot -&gt; m Slot
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Slot -&gt; m Slot) -&gt; IO Slot -&gt; m Slot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Slot -&gt; IO Slot
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Slot -&gt; IO Slot) -&gt; STM Slot -&gt; IO Slot
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; STM ServerResponse
forall a. TQueue a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">readTQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerResponse
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ccResponse"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621680385016"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM ServerResponse -&gt; (ServerResponse -&gt; STM Slot) -&gt; STM Slot
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#SlotChanged"><span class="hs-identifier hs-type">SlotChanged</span></a></span><span> </span><span id="local-6989586621680385015"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680385015"><span class="hs-identifier hs-var">slot</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Slot -&gt; STM Slot
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680385015"><span class="hs-identifier hs-var">slot</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span class="annot"><span class="annottext">ServerResponse
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM Slot
forall a. STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">retry</span></a></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span id="local-6989586621680385014"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#addTx"><span class="hs-identifier hs-type">addTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385014"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.Tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.BabbageEra</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385014"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-123"></span><span id="addTx"><span class="annot"><span class="annottext">addTx :: ServerHandler -&gt; Tx BabbageEra -&gt; m ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#addTx"><span class="hs-identifier hs-var hs-var">addTx</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span id="local-6989586621680385012"><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: ServerHandler -&gt; CommandChannel
</span><a href="#local-6989586621680385012"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span id="local-6989586621680385011"><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680385011"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; ServerCommand -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">writeTQueue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CommandChannel -&gt; TQueue ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ccCommand"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span><span>  </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621680385012"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ServerCommand -&gt; STM ()) -&gt; ServerCommand -&gt; STM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#AddTx"><span class="hs-identifier hs-var">AddTx</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680385011"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">{- Create a thread that keeps the number of blocks in the channel to the maximum
   limit of K -}</span><span>
</span><span id="line-128"></span><span id="local-6989586621680385316"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#pruneChain"><span class="hs-identifier hs-type">pruneChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385316"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385316"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">ThreadId</span></a></span></span><span>
</span><span id="line-129"></span><span id="pruneChain"><span class="annot"><span class="annottext">pruneChain :: Integer -&gt; TChan Block -&gt; m ThreadId
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#pruneChain"><span class="hs-identifier hs-var hs-var">pruneChain</span></a></span></span><span> </span><span id="local-6989586621680385009"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680385009"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680385008"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385008"><span class="hs-identifier hs-var">original</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>  </span><span id="local-6989586621680385007"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385007"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TChan Block) -&gt; m (TChan Block)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (TChan Block) -&gt; m (TChan Block))
-&gt; IO (TChan Block) -&gt; m (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TChan Block) -&gt; IO (TChan Block)
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan Block) -&gt; IO (TChan Block))
-&gt; STM (TChan Block) -&gt; IO (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM (TChan Block)
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">cloneTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385008"><span class="hs-identifier hs-var">original</span></a></span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">IO ThreadId -&gt; m ThreadId
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; m ThreadId)
-&gt; (IO () -&gt; IO ThreadId) -&gt; IO () -&gt; m ThreadId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ThreadId) -&gt; IO () -&gt; m ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621680385003"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680385009"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385007"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-133"></span><span>  </span><span id="local-6989586621680385388"><span class="annot"><a href="#local-6989586621680385003"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385388"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385388"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-134"></span><span>  </span><span id="local-6989586621680385003"><span class="annot"><span class="annottext">go :: Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621680385003"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621680385002"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680385002"><span class="hs-identifier hs-var">k'</span></a></span></span><span> </span><span id="local-6989586621680385001"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385001"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-comment">-- Wait for data on the channel</span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">Block
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Block -&gt; m Block
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Block -&gt; m Block) -&gt; IO Block -&gt; m Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Block -&gt; IO Block) -&gt; STM Block -&gt; IO Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM Block
forall a. TChan a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385001"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680385002"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-138"></span><span>       </span><span class="hs-comment">{- When the counter reaches zero, there are K blocks in the
          original channel and we start to remove the oldest stored
          block by reading it. -}</span><span>
</span><span id="line-141"></span><span>       </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>           </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TChan Block -&gt; STM Block
forall a. TChan a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385008"><span class="hs-identifier hs-var">original</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IO Block -&gt; IO () -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; IO ()
forall (m :: * -&gt; *). MonadIO m =&gt; Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621680385003"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385001"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-143"></span><span>       </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>           </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; m ()
forall (m :: * -&gt; *). MonadIO m =&gt; Integer -&gt; TChan Block -&gt; m ()
</span><a href="#local-6989586621680385003"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680385002"><span class="hs-identifier hs-var">k'</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680385001"><span class="hs-identifier hs-var">localChannel</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span id="local-6989586621680385317"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#handleCommand"><span class="hs-identifier hs-type">handleCommand</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-147"></span><span>    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385317"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-148"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Types.html#PABServerLogMsg"><span class="hs-identifier hs-type">PABServerLogMsg</span></a></span><span>
</span><span id="line-149"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#CommandChannel"><span class="hs-identifier hs-type">CommandChannel</span></a></span><span>
</span><span id="line-150"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span>
</span><span id="line-151"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-type">Params</span></a></span><span>
</span><span id="line-152"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385317"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-153"></span><span id="handleCommand"><span class="annot"><span class="annottext">handleCommand :: Trace IO PABServerLogMsg
-&gt; CommandChannel
-&gt; MVar MockNodeServerChainState
-&gt; Params
-&gt; m ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#handleCommand"><span class="hs-identifier hs-var hs-var">handleCommand</span></a></span></span><span> </span><span id="local-6989586621680384998"><span class="annot"><span class="annottext">Trace IO PABServerLogMsg
</span><a href="#local-6989586621680384998"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#CommandChannel"><span class="hs-identifier hs-type">CommandChannel</span></a></span><span> </span><span class="hs-special">{</span><span id="local-6989586621680384997"><span class="annot"><span class="annottext">TQueue ServerCommand
ccCommand :: TQueue ServerCommand
ccCommand :: CommandChannel -&gt; TQueue ServerCommand
</span><a href="#local-6989586621680384997"><span class="hs-identifier hs-var hs-var">ccCommand</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680384996"><span class="annot"><span class="annottext">TQueue ServerResponse
ccResponse :: TQueue ServerResponse
ccResponse :: CommandChannel -&gt; TQueue ServerResponse
</span><a href="#local-6989586621680384996"><span class="hs-identifier hs-var hs-var">ccResponse</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680384995"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384995"><span class="hs-identifier hs-var">mvChainState</span></a></span></span><span> </span><span id="local-6989586621680384994"><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680384994"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-154"></span><span>    </span><span class="annot"><span class="annottext">IO ServerCommand -&gt; m ServerCommand
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">STM ServerCommand -&gt; IO ServerCommand
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM ServerCommand -&gt; IO ServerCommand)
-&gt; STM ServerCommand -&gt; IO ServerCommand
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; STM ServerCommand
forall a. TQueue a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">readTQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand
</span><a href="#local-6989586621680384997"><span class="hs-identifier hs-var">ccCommand</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m ServerCommand -&gt; (ServerCommand -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-155"></span><span>        </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#AddTx"><span class="hs-identifier hs-type">AddTx</span></a></span><span> </span><span id="local-6989586621680384993"><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680384993"><span class="hs-identifier hs-var">tx</span></a></span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; (MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384995"><span class="hs-identifier hs-var">mvChainState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; (MockNodeServerChainState -&gt; MockNodeServerChainState)
-&gt; MockNodeServerChainState
-&gt; IO MockNodeServerChainState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  MockNodeServerChainState MockNodeServerChainState TxPool TxPool
-&gt; (TxPool -&gt; TxPool)
-&gt; MockNodeServerChainState
-&gt; MockNodeServerChainState
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  MockNodeServerChainState MockNodeServerChainState TxPool TxPool
Lens' MockNodeServerChainState TxPool
</span><a href="Cardano.Chain.html#txPool"><span class="hs-identifier hs-var">txPool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeCardanoApiTx -&gt; CardanoTx
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">CardanoApiTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; SomeCardanoApiTx
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">CardanoApiEmulatorEraTx</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680384993"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">CardanoTx -&gt; TxPool -&gt; TxPool
forall a. a -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-glyph hs-var">:</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>        </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ModifySlot"><span class="hs-identifier hs-type">ModifySlot</span></a></span><span> </span><span id="local-6989586621680384989"><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621680384989"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>            </span><span id="local-6989586621680384988"><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384988"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; IO MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall a. MVar a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384995"><span class="hs-identifier hs-var">mvChainState</span></a></span><span>
</span><span id="line-159"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621680384986"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680384986"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680384985"><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384985"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Slot, MockNodeServerChainState)
-&gt; IO (Slot, MockNodeServerChainState)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Slot, MockNodeServerChainState)
 -&gt; IO (Slot, MockNodeServerChainState))
-&gt; IO (Slot, MockNodeServerChainState)
-&gt; IO (Slot, MockNodeServerChainState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; Slot)
-&gt; Eff
     '[ChainControlEffect, LogMsg ChainEvent,
       State MockNodeServerChainState, IO]
     Slot
forall (effs :: [* -&gt; *]).
Member ChainControlEffect effs =&gt;
(Slot -&gt; Slot) -&gt; Eff effs Slot
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var">Chain.modifySlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot
</span><a href="#local-6989586621680384989"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-160"></span><span>                  </span><span class="annot"><span class="annottext">Eff
  '[ChainControlEffect, LogMsg ChainEvent,
    State MockNodeServerChainState, IO]
  Slot
-&gt; (Eff
      '[ChainControlEffect, LogMsg ChainEvent,
        State MockNodeServerChainState, IO]
      Slot
    -&gt; Eff
         '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Slot)
-&gt; Eff
     '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Slot
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainControlEffect
 ~&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO])
-&gt; Eff
     '[ChainControlEffect, LogMsg ChainEvent,
       State MockNodeServerChainState, IO]
   ~&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO]
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]).
(eff ~&gt; Eff effs) -&gt; Eff (eff : effs) ~&gt; Eff effs
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">interpret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Params
-&gt; ChainControlEffect
   ~&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO]
forall (effs :: [* -&gt; *]) (m :: * -&gt; *).
(Member (State MockNodeServerChainState) effs,
 Member (LogMsg ChainEvent) effs, LastMember m effs, MonadIO m) =&gt;
Params -&gt; ChainControlEffect ~&gt; Eff effs
</span><a href="Cardano.Chain.html#handleControlChain"><span class="hs-identifier hs-var">handleControlChain</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680384994"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>                  </span><span class="annot"><span class="annottext">Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Slot
-&gt; (Eff
      '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Slot
    -&gt; Eff '[State MockNodeServerChainState, IO] Slot)
-&gt; Eff '[State MockNodeServerChainState, IO] Slot
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(LogMsg ChainEvent ~&gt; Eff '[State MockNodeServerChainState, IO])
-&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO]
   ~&gt; Eff '[State MockNodeServerChainState, IO]
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]).
(eff ~&gt; Eff effs) -&gt; Eff (eff : effs) ~&gt; Eff effs
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">interpret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainEvent -&gt; PABServerLogMsg)
-&gt; Trace IO PABServerLogMsg
-&gt; LogMsg ChainEvent ~&gt; Eff '[State MockNodeServerChainState, IO]
forall b a (m :: * -&gt; *) (effs :: [* -&gt; *]).
(LastMember m effs, MonadIO m) =&gt;
(b -&gt; a) -&gt; Trace m a -&gt; LogMsg b ~&gt; Eff effs
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">LM.handleLogMsgTraceMap</span></a></span><span> </span><span class="annot"><span class="annottext">ChainEvent -&gt; PABServerLogMsg
</span><a href="Cardano.Node.Types.html#ProcessingChainEvent"><span class="hs-identifier hs-var">ProcessingChainEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO PABServerLogMsg
</span><a href="#local-6989586621680384998"><span class="hs-identifier hs-var">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-162"></span><span>                  </span><span class="annot"><span class="annottext">Eff '[State MockNodeServerChainState, IO] Slot
-&gt; (Eff '[State MockNodeServerChainState, IO] Slot
    -&gt; Eff '[IO] (Slot, MockNodeServerChainState))
-&gt; Eff '[IO] (Slot, MockNodeServerChainState)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
-&gt; Eff '[State MockNodeServerChainState, IO] Slot
-&gt; Eff '[IO] (Slot, MockNodeServerChainState)
forall s (effs :: [* -&gt; *]) a.
s -&gt; Eff (State s : effs) a -&gt; Eff effs (a, s)
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">runState</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384988"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-163"></span><span>                  </span><span class="annot"><span class="annottext">Eff '[IO] (Slot, MockNodeServerChainState)
-&gt; (Eff '[IO] (Slot, MockNodeServerChainState)
    -&gt; IO (Slot, MockNodeServerChainState))
-&gt; IO (Slot, MockNodeServerChainState)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Eff '[IO] (Slot, MockNodeServerChainState)
-&gt; IO (Slot, MockNodeServerChainState)
forall (m :: * -&gt; *) a. Monad m =&gt; Eff '[m] a -&gt; m a
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">runM</span></a></span><span>
</span><span id="line-164"></span><span>            </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; MockNodeServerChainState -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384995"><span class="hs-identifier hs-var">mvChainState</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384985"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-165"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-166"></span><span>                </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; ServerResponse -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">writeTQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse
</span><a href="#local-6989586621680384996"><span class="hs-identifier hs-var">ccResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot -&gt; ServerResponse
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#SlotChanged"><span class="hs-identifier hs-var">SlotChanged</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680384986"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><span class="annottext">ServerCommand
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ProcessBlock"><span class="hs-identifier hs-var">ProcessBlock</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-168"></span><span>            </span><span id="local-6989586621680384979"><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384979"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; IO MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall a. MVar a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384995"><span class="hs-identifier hs-var">mvChainState</span></a></span><span>
</span><span id="line-169"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621680384978"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384978"><span class="hs-identifier hs-var">block</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680384977"><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384977"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (Block, MockNodeServerChainState)
-&gt; IO (Block, MockNodeServerChainState)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Block, MockNodeServerChainState)
 -&gt; IO (Block, MockNodeServerChainState))
-&gt; IO (Block, MockNodeServerChainState)
-&gt; IO (Block, MockNodeServerChainState)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Eff
  '[ChainControlEffect, LogMsg ChainEvent,
    State MockNodeServerChainState, IO]
  Block
forall (effs :: [* -&gt; *]).
Member ChainControlEffect effs =&gt;
Eff effs Block
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var">Chain.processBlock</span></a></span><span>
</span><span id="line-170"></span><span>                  </span><span class="annot"><span class="annottext">Eff
  '[ChainControlEffect, LogMsg ChainEvent,
    State MockNodeServerChainState, IO]
  Block
-&gt; (Eff
      '[ChainControlEffect, LogMsg ChainEvent,
        State MockNodeServerChainState, IO]
      Block
    -&gt; Eff
         '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Block)
-&gt; Eff
     '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Block
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainControlEffect
 ~&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO])
-&gt; Eff
     '[ChainControlEffect, LogMsg ChainEvent,
       State MockNodeServerChainState, IO]
   ~&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO]
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]).
(eff ~&gt; Eff effs) -&gt; Eff (eff : effs) ~&gt; Eff effs
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">interpret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Params
-&gt; ChainControlEffect
   ~&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO]
forall (effs :: [* -&gt; *]) (m :: * -&gt; *).
(Member (State MockNodeServerChainState) effs,
 Member (LogMsg ChainEvent) effs, LastMember m effs, MonadIO m) =&gt;
Params -&gt; ChainControlEffect ~&gt; Eff effs
</span><a href="Cardano.Chain.html#handleControlChain"><span class="hs-identifier hs-var">handleControlChain</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680384994"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>                  </span><span class="annot"><span class="annottext">Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Block
-&gt; (Eff
      '[LogMsg ChainEvent, State MockNodeServerChainState, IO] Block
    -&gt; Eff '[State MockNodeServerChainState, IO] Block)
-&gt; Eff '[State MockNodeServerChainState, IO] Block
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(LogMsg ChainEvent ~&gt; Eff '[State MockNodeServerChainState, IO])
-&gt; Eff '[LogMsg ChainEvent, State MockNodeServerChainState, IO]
   ~&gt; Eff '[State MockNodeServerChainState, IO]
forall (eff :: * -&gt; *) (effs :: [* -&gt; *]).
(eff ~&gt; Eff effs) -&gt; Eff (eff : effs) ~&gt; Eff effs
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">interpret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ChainEvent -&gt; PABServerLogMsg)
-&gt; Trace IO PABServerLogMsg
-&gt; LogMsg ChainEvent ~&gt; Eff '[State MockNodeServerChainState, IO]
forall b a (m :: * -&gt; *) (effs :: [* -&gt; *]).
(LastMember m effs, MonadIO m) =&gt;
(b -&gt; a) -&gt; Trace m a -&gt; LogMsg b ~&gt; Eff effs
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">LM.handleLogMsgTraceMap</span></a></span><span> </span><span class="annot"><span class="annottext">ChainEvent -&gt; PABServerLogMsg
</span><a href="Cardano.Node.Types.html#ProcessingChainEvent"><span class="hs-identifier hs-var">ProcessingChainEvent</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO PABServerLogMsg
</span><a href="#local-6989586621680384998"><span class="hs-identifier hs-var">trace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>                  </span><span class="annot"><span class="annottext">Eff '[State MockNodeServerChainState, IO] Block
-&gt; (Eff '[State MockNodeServerChainState, IO] Block
    -&gt; Eff '[IO] (Block, MockNodeServerChainState))
-&gt; Eff '[IO] (Block, MockNodeServerChainState)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
-&gt; Eff '[State MockNodeServerChainState, IO] Block
-&gt; Eff '[IO] (Block, MockNodeServerChainState)
forall s (effs :: [* -&gt; *]) a.
s -&gt; Eff (State s : effs) a -&gt; Eff effs (a, s)
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">runState</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384979"><span class="hs-identifier hs-var">state</span></a></span><span>
</span><span id="line-173"></span><span>                  </span><span class="annot"><span class="annottext">Eff '[IO] (Block, MockNodeServerChainState)
-&gt; (Eff '[IO] (Block, MockNodeServerChainState)
    -&gt; IO (Block, MockNodeServerChainState))
-&gt; IO (Block, MockNodeServerChainState)
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Eff '[IO] (Block, MockNodeServerChainState)
-&gt; IO (Block, MockNodeServerChainState)
forall (m :: * -&gt; *) a. Monad m =&gt; Eff '[m] a -&gt; m a
</span><a href="../file:///nix/store/bvsf6n0jyy81dv6f71yfdy6shyr2f8sf-freer-simple-lib-freer-simple-1.2.1.2-haddock-doc/share/doc/freer-simple/html/src"><span class="hs-identifier hs-var">runM</span></a></span><span>
</span><span id="line-174"></span><span>            </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; MockNodeServerChainState -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384995"><span class="hs-identifier hs-var">mvChainState</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384977"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-175"></span><span>            </span><span class="annot"><span class="annottext">STM () -&gt; IO ()
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM () -&gt; IO ()) -&gt; STM () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-176"></span><span>                </span><span class="annot"><span class="annottext">TQueue ServerResponse -&gt; ServerResponse -&gt; STM ()
forall a. TQueue a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">writeTQueue</span></a></span><span> </span><span class="annot"><span class="annottext">TQueue ServerResponse
</span><a href="#local-6989586621680384996"><span class="hs-identifier hs-var">ccResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block -&gt; ServerResponse
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#BlockAdded"><span class="hs-identifier hs-var">BlockAdded</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384978"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span class="hs-comment">{- | Start the server in a new thread, and return a server handler
     used to control the server -}</span><span>
</span><span id="line-180"></span><span id="local-6989586621680384975"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#runServerNode"><span class="hs-identifier hs-type">runServerNode</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680384975"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-182"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Trace</span></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Cardano.Node.Types.html#PABServerLogMsg"><span class="hs-identifier hs-type">PABServerLogMsg</span></a></span><span>
</span><span id="line-183"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-184"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-185"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span>
</span><span id="line-186"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-type">Params</span></a></span><span>
</span><span id="line-187"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680384975"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span></span><span>
</span><span id="line-188"></span><span id="runServerNode"><span class="annot"><span class="annottext">runServerNode :: Trace IO PABServerLogMsg
-&gt; FilePath
-&gt; Integer
-&gt; MockNodeServerChainState
-&gt; Params
-&gt; m ServerHandler
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#runServerNode"><span class="hs-identifier hs-var hs-var">runServerNode</span></a></span></span><span> </span><span id="local-6989586621680384973"><span class="annot"><span class="annottext">Trace IO PABServerLogMsg
</span><a href="#local-6989586621680384973"><span class="hs-identifier hs-var">trace</span></a></span></span><span> </span><span id="local-6989586621680384972"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680384972"><span class="hs-identifier hs-var">shSocketPath</span></a></span></span><span> </span><span id="local-6989586621680384971"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384971"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621680384970"><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384970"><span class="hs-identifier hs-var">initialState</span></a></span></span><span> </span><span id="local-6989586621680384969"><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680384969"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO ServerHandler -&gt; m ServerHandler
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ServerHandler -&gt; m ServerHandler)
-&gt; IO ServerHandler -&gt; m ServerHandler
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621680384968"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384968"><span class="hs-identifier hs-var">serverState</span></a></span></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState -&gt; IO (MVar MockNodeServerChainState)
forall a. a -&gt; IO (MVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">newMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384970"><span class="hs-identifier hs-var">initialState</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span id="local-6989586621680384966"><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621680384966"><span class="hs-identifier hs-var">shCommandChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TQueue ServerCommand -&gt; TQueue ServerResponse -&gt; CommandChannel
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#CommandChannel"><span class="hs-identifier hs-var">CommandChannel</span></a></span><span> </span><span class="annot"><span class="annottext">(TQueue ServerCommand -&gt; TQueue ServerResponse -&gt; CommandChannel)
-&gt; IO (TQueue ServerCommand)
-&gt; IO (TQueue ServerResponse -&gt; CommandChannel)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO (TQueue ServerCommand)
forall a. IO (TQueue a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">newTQueueIO</span></a></span><span> </span><span class="annot"><span class="annottext">IO (TQueue ServerResponse -&gt; CommandChannel)
-&gt; IO (TQueue ServerResponse) -&gt; IO CommandChannel
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IO (TQueue ServerResponse)
forall a. IO (TQueue a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">newTQueueIO</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621680384963"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384963"><span class="hs-identifier hs-var">globalChannel</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; IO (TChan Block)
forall (m :: * -&gt; *).
MonadIO m =&gt;
MVar MockNodeServerChainState -&gt; m (TChan Block)
</span><a href="Cardano.Chain.html#getChannel"><span class="hs-identifier hs-var">getChannel</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384968"><span class="hs-identifier hs-var">serverState</span></a></span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId)
-&gt; (IO Void -&gt; IO ()) -&gt; IO Void -&gt; IO ThreadId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO Void -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span>    </span><span class="annot"><span class="annottext">(IO Void -&gt; IO ThreadId) -&gt; IO Void -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath -&gt; MVar MockNodeServerChainState -&gt; IO Void
forall (m :: * -&gt; *).
MonadIO m =&gt;
FilePath -&gt; MVar MockNodeServerChainState -&gt; m Void
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#protocolLoop"><span class="hs-identifier hs-var">protocolLoop</span></a></span><span>        </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680384972"><span class="hs-identifier hs-var">shSocketPath</span></a></span><span>     </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384968"><span class="hs-identifier hs-var">serverState</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ThreadId
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forkIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; (IO () -&gt; IO ()) -&gt; IO () -&gt; IO ThreadId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO ()
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">forever</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ThreadId) -&gt; IO () -&gt; IO ThreadId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO PABServerLogMsg
-&gt; CommandChannel
-&gt; MVar MockNodeServerChainState
-&gt; Params
-&gt; IO ()
forall (m :: * -&gt; *).
MonadIO m =&gt;
Trace IO PABServerLogMsg
-&gt; CommandChannel
-&gt; MVar MockNodeServerChainState
-&gt; Params
-&gt; m ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#handleCommand"><span class="hs-identifier hs-var">handleCommand</span></a></span><span> </span><span class="annot"><span class="annottext">Trace IO PABServerLogMsg
</span><a href="#local-6989586621680384973"><span class="hs-identifier hs-var">trace</span></a></span><span> </span><span class="annot"><span class="annottext">CommandChannel
</span><a href="#local-6989586621680384966"><span class="hs-identifier hs-var">shCommandChannel</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384968"><span class="hs-identifier hs-var">serverState</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680384969"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">IO ThreadId -&gt; IO ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span>                    </span><span class="annot"><span class="annottext">(IO ThreadId -&gt; IO ()) -&gt; IO ThreadId -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TChan Block -&gt; IO ThreadId
forall (m :: * -&gt; *).
MonadIO m =&gt;
Integer -&gt; TChan Block -&gt; m ThreadId
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#pruneChain"><span class="hs-identifier hs-var">pruneChain</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384971"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384963"><span class="hs-identifier hs-var">globalChannel</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><span class="annottext">ServerHandler -&gt; IO ServerHandler
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerHandler -&gt; IO ServerHandler)
-&gt; ServerHandler -&gt; IO ServerHandler
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ServerHandler :: FilePath -&gt; CommandChannel -&gt; ServerHandler
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#ServerHandler"><span class="hs-identifier hs-type">ServerHandler</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">FilePath
shSocketPath :: FilePath
shSocketPath :: FilePath
</span><a href="#local-6989586621680384972"><span class="hs-identifier hs-var hs-var">shSocketPath</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CommandChannel
shCommandChannel :: CommandChannel
shCommandChannel :: CommandChannel
</span><a href="#local-6989586621680384966"><span class="hs-identifier hs-var hs-var">shCommandChannel</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-comment">-- * ChainSync protocol</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-comment">{- A monad for running all code executed when a state
   transition is invoked. It makes the implementation of
   state transitions easier to read. -}</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span class="hs-keyword">type</span><span> </span><span id="ChainSyncMonad"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ChainSyncMonad"><span class="hs-identifier hs-var">ChainSyncMonad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../file:///nix/store/8r01jj9dl6h1x2byph07y6wxfb3ysd8c-transformers-lib-transformers-0.5.6.2-haddock-doc/share/doc/transformers/html/src"><span class="hs-identifier hs-type">ReaderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span id="local-6989586621680385245"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#runChainSync"><span class="hs-identifier hs-type">runChainSync</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385245"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385245"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-206"></span><span id="runChainSync"><span class="annot"><span class="annottext">runChainSync :: MVar MockNodeServerChainState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#runChainSync"><span class="hs-identifier hs-var hs-var">runChainSync</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ChainSyncMonad a -&gt; MVar MockNodeServerChainState -&gt; IO a)
-&gt; MVar MockNodeServerChainState -&gt; ChainSyncMonad a -&gt; IO a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">flip</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad a -&gt; MVar MockNodeServerChainState -&gt; IO a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><a href="../file:///nix/store/8r01jj9dl6h1x2byph07y6wxfb3ysd8c-transformers-lib-transformers-0.5.6.2-haddock-doc/share/doc/transformers/html/src"><span class="hs-identifier hs-var hs-var">runReaderT</span></a></span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">{- The initial state of the protocol. You can move into
   requesting the next block or reset state by searching for an
   intersection. -}</span><span>
</span><span id="line-211"></span><span id="local-6989586621680385258"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#idleState"><span class="hs-identifier hs-type">idleState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385258"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-213"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385258"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-215"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385258"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385258"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-216"></span><span id="idleState"><span class="annot"><span class="annottext">idleState :: LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#idleState"><span class="hs-identifier hs-var hs-var">idleState</span></a></span></span><span> </span><span id="local-6989586621680384954"><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621680384954"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-217"></span><span>    </span><span class="annot"><span class="annottext">ServerStIdle Block (Point Block) Block m ()
-&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIdle :: forall header point tip (m :: * -&gt; *) a.
m (Either
     (ServerStNext header point tip m a)
     (m (ServerStNext header point tip m a)))
-&gt; ([point] -&gt; m (ServerStIntersect header point tip m a))
-&gt; m a
-&gt; ServerStIdle header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">recvMsgRequestNext :: m (Either
     (ServerStNext Block (Point Block) Block m ())
     (m (ServerStNext Block (Point Block) Block m ())))
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">recvMsgRequestNext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalChannel
-&gt; m (Either
        (ServerStNext Block (Point Block) Block m ())
        (m (ServerStNext Block (Point Block) Block m ())))
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
LocalChannel
-&gt; m (Either
        (ServerStNext Block (Point Block) Block m ())
        (m (ServerStNext Block (Point Block) Block m ())))
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#nextState"><span class="hs-identifier hs-var">nextState</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621680384954"><span class="hs-identifier hs-var">channel'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-219"></span><span>        </span><span class="annot"><span class="annottext">recvMsgFindIntersect :: [Point Block]
-&gt; m (ServerStIntersect Block (Point Block) Block m ())
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">recvMsgFindIntersect</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Point Block]
-&gt; m (ServerStIntersect Block (Point Block) Block m ())
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
[Point Block]
-&gt; m (ServerStIntersect Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#findIntersect"><span class="hs-identifier hs-var">findIntersect</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="annottext">recvMsgDoneClient :: m ()
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">recvMsgDoneClient</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="hs-comment">{- Get the next block, either immediately (the Just/Left branch)
   or within a monad (IO, in our case) where you can wait for the
   next block (Nothing/Right branch) -}</span><span>
</span><span id="line-226"></span><span id="local-6989586621680385295"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#nextState"><span class="hs-identifier hs-type">nextState</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-227"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385295"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385295"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-230"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385295"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStNext</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385295"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-231"></span><span>              </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680385295"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStNext</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385295"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-232"></span><span id="nextState"><span class="annot"><span class="annottext">nextState :: LocalChannel
-&gt; m (Either
        (ServerStNext Block (Point Block) Block m ())
        (m (ServerStNext Block (Point Block) Block m ())))
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#nextState"><span class="hs-identifier hs-var hs-var">nextState</span></a></span></span><span> </span><span id="local-6989586621680384947"><span class="annot"><span class="annottext">localChannel :: LocalChannel
</span><a href="#local-6989586621680384947"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span> </span><span id="local-6989586621680384946"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384946"><span class="hs-identifier hs-var">channel'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-233"></span><span>    </span><span id="local-6989586621680384945"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384945"><span class="hs-identifier hs-var">chainState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar MockNodeServerChainState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-234"></span><span>    </span><span id="local-6989586621680384943"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384943"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; m Block
forall (m :: * -&gt; *).
MonadIO m =&gt;
MVar MockNodeServerChainState -&gt; m Block
</span><a href="Cardano.Chain.html#getTip"><span class="hs-identifier hs-var">getTip</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384945"><span class="hs-identifier hs-var">chainState</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (Maybe Block) -&gt; m (Maybe Block)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe Block) -&gt; m (Maybe Block))
-&gt; (STM (Maybe Block) -&gt; IO (Maybe Block))
-&gt; STM (Maybe Block)
-&gt; m (Maybe Block)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe Block) -&gt; IO (Maybe Block)
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe Block) -&gt; m (Maybe Block))
-&gt; STM (Maybe Block) -&gt; m (Maybe Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM (Maybe Block)
forall a. TChan a -&gt; STM (Maybe a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">tryReadTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384946"><span class="hs-identifier hs-var">channel'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Maybe Block)
-&gt; (Maybe Block
    -&gt; m (Either
            (ServerStNext Block (Point Block) Block m ())
            (m (ServerStNext Block (Point Block) Block m ()))))
-&gt; m (Either
        (ServerStNext Block (Point Block) Block m ())
        (m (ServerStNext Block (Point Block) Block m ())))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">Maybe Block
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-237"></span><span>            </span><span class="annot"><span class="annottext">m (ServerStNext Block (Point Block) Block m ())
-&gt; Either
     (ServerStNext Block (Point Block) Block m ())
     (m (ServerStNext Block (Point Block) Block m ()))
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ServerStNext Block (Point Block) Block m ())
 -&gt; Either
      (ServerStNext Block (Point Block) Block m ())
      (m (ServerStNext Block (Point Block) Block m ())))
-&gt; (ServerStNext Block (Point Block) Block m ()
    -&gt; m (ServerStNext Block (Point Block) Block m ()))
-&gt; ServerStNext Block (Point Block) Block m ()
-&gt; Either
     (ServerStNext Block (Point Block) Block m ())
     (m (ServerStNext Block (Point Block) Block m ()))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block m ()
-&gt; m (ServerStNext Block (Point Block) Block m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext Block (Point Block) Block m ()
 -&gt; Either
      (ServerStNext Block (Point Block) Block m ())
      (m (ServerStNext Block (Point Block) Block m ())))
-&gt; m (ServerStNext Block (Point Block) Block m ())
-&gt; m (Either
        (ServerStNext Block (Point Block) Block m ())
        (m (ServerStNext Block (Point Block) Block m ())))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>                </span><span id="local-6989586621680384941"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384941"><span class="hs-identifier hs-var">nextBlock</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO Block -&gt; m Block
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Block -&gt; m Block)
-&gt; (STM Block -&gt; IO Block) -&gt; STM Block -&gt; m Block
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">STM Block -&gt; IO Block
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM Block -&gt; m Block) -&gt; STM Block -&gt; m Block
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM Block
forall a. TChan a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">readTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384946"><span class="hs-identifier hs-var">channel'</span></a></span><span>
</span><span id="line-239"></span><span>                </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; (MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384945"><span class="hs-identifier hs-var">chainState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; (MockNodeServerChainState -&gt; MockNodeServerChainState)
-&gt; MockNodeServerChainState
-&gt; IO MockNodeServerChainState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe Block -&gt; Identity (Maybe Block))
-&gt; MockNodeServerChainState -&gt; Identity MockNodeServerChainState
Lens' MockNodeServerChainState (Maybe Block)
</span><a href="Cardano.Chain.html#tip"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe Block -&gt; Identity (Maybe Block))
 -&gt; MockNodeServerChainState -&gt; Identity MockNodeServerChainState)
-&gt; Block -&gt; MockNodeServerChainState -&gt; MockNodeServerChainState
forall s t a b. ASetter s t a (Maybe b) -&gt; b -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">?~</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384941"><span class="hs-identifier hs-var">nextBlock</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>                </span><span class="annot"><span class="annottext">LocalChannel
-&gt; Block
-&gt; Block
-&gt; m (ServerStNext Block (Point Block) Block m ())
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
LocalChannel
-&gt; Block
-&gt; Block
-&gt; m (ServerStNext Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#sendRollForward"><span class="hs-identifier hs-var">sendRollForward</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621680384947"><span class="hs-identifier hs-var">localChannel</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384943"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384941"><span class="hs-identifier hs-var">nextBlock</span></a></span><span>
</span><span id="line-241"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680384938"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384938"><span class="hs-identifier hs-var">nextBlock</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="annottext">IO () -&gt; m ()
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; m ()) -&gt; IO () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; (MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384945"><span class="hs-identifier hs-var">chainState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; (MockNodeServerChainState -&gt; MockNodeServerChainState)
-&gt; MockNodeServerChainState
-&gt; IO MockNodeServerChainState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Maybe Block -&gt; Identity (Maybe Block))
-&gt; MockNodeServerChainState -&gt; Identity MockNodeServerChainState
Lens' MockNodeServerChainState (Maybe Block)
</span><a href="Cardano.Chain.html#tip"><span class="hs-identifier hs-var">tip</span></a></span><span> </span><span class="annot"><span class="annottext">((Maybe Block -&gt; Identity (Maybe Block))
 -&gt; MockNodeServerChainState -&gt; Identity MockNodeServerChainState)
-&gt; Block -&gt; MockNodeServerChainState -&gt; MockNodeServerChainState
forall s t a b. ASetter s t a (Maybe b) -&gt; b -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">?~</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384938"><span class="hs-identifier hs-var">nextBlock</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>            </span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block m ()
-&gt; Either
     (ServerStNext Block (Point Block) Block m ())
     (m (ServerStNext Block (Point Block) Block m ()))
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext Block (Point Block) Block m ()
 -&gt; Either
      (ServerStNext Block (Point Block) Block m ())
      (m (ServerStNext Block (Point Block) Block m ())))
-&gt; m (ServerStNext Block (Point Block) Block m ())
-&gt; m (Either
        (ServerStNext Block (Point Block) Block m ())
        (m (ServerStNext Block (Point Block) Block m ())))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
-&gt; Block
-&gt; Block
-&gt; m (ServerStNext Block (Point Block) Block m ())
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
LocalChannel
-&gt; Block
-&gt; Block
-&gt; m (ServerStNext Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#sendRollForward"><span class="hs-identifier hs-var">sendRollForward</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621680384947"><span class="hs-identifier hs-var">localChannel</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384943"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384938"><span class="hs-identifier hs-var">nextBlock</span></a></span><span>
</span><span id="line-244"></span><span>
</span><span id="line-245"></span><span class="hs-comment">{- This protocol state will search for a block intersection
   with some client provided blocks. When an intersection is found
   the client state is reset to the new offset (the Just branch)
   or to the genesis block if no intersection was found. -}</span><span>
</span><span id="line-249"></span><span id="local-6989586621680385293"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#findIntersect"><span class="hs-identifier hs-type">findIntersect</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-250"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385293"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385293"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-253"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385293"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIntersect</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385293"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-254"></span><span id="findIntersect"><span class="annot"><span class="annottext">findIntersect :: [Point Block]
-&gt; m (ServerStIntersect Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#findIntersect"><span class="hs-identifier hs-var hs-var">findIntersect</span></a></span></span><span> </span><span id="local-6989586621680384937"><span class="annot"><span class="annottext">[Point Block]
</span><a href="#local-6989586621680384937"><span class="hs-identifier hs-var">clientPoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621680384936"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384936"><span class="hs-identifier hs-var">mvState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar MockNodeServerChainState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621680384935"><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384935"><span class="hs-identifier hs-var">chainState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO MockNodeServerChainState -&gt; m MockNodeServerChainState
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO MockNodeServerChainState -&gt; m MockNodeServerChainState)
-&gt; IO MockNodeServerChainState -&gt; m MockNodeServerChainState
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall a. MVar a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">readMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384936"><span class="hs-identifier hs-var">mvState</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621680384933"><span class="annot"><span class="annottext">[Point Block]
</span><a href="#local-6989586621680384933"><span class="hs-identifier hs-var">serverPoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; MockNodeServerChainState -&gt; m [Point Block]
forall (m :: * -&gt; *).
MonadIO m =&gt;
TChan Block -&gt; MockNodeServerChainState -&gt; m [Point Block]
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#getChainPoints"><span class="hs-identifier hs-var">getChainPoints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting (TChan Block) MockNodeServerChainState (TChan Block)
-&gt; MockNodeServerChainState -&gt; TChan Block
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (TChan Block) MockNodeServerChainState (TChan Block)
Lens' MockNodeServerChainState (TChan Block)
</span><a href="Cardano.Chain.html#channel"><span class="hs-identifier hs-var">channel</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384935"><span class="hs-identifier hs-var">chainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384935"><span class="hs-identifier hs-var">chainState</span></a></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680384930"><span class="annot"><span class="annottext">point :: Maybe (Point Block)
</span><a href="#local-6989586621680384930"><span class="hs-identifier hs-var hs-var">point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Point Block] -&gt; Maybe (Point Block)
forall a. [a] -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-259"></span><span>              </span><span class="annot"><span class="annottext">([Point Block] -&gt; Maybe (Point Block))
-&gt; [Point Block] -&gt; Maybe (Point Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Point Block] -&gt; [Point Block] -&gt; [Point Block]
forall a. Eq a =&gt; [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">intersect</span></a></span><span> </span><span class="annot"><span class="annottext">[Point Block]
</span><a href="#local-6989586621680384933"><span class="hs-identifier hs-var">serverPoints</span></a></span><span>
</span><span id="line-260"></span><span>                          </span><span class="annot"><span class="annottext">[Point Block]
</span><a href="#local-6989586621680384937"><span class="hs-identifier hs-var">clientPoints</span></a></span><span>
</span><span id="line-261"></span><span>    </span><span id="local-6989586621680384929"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384929"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; m Block
forall (m :: * -&gt; *).
MonadIO m =&gt;
MVar MockNodeServerChainState -&gt; m Block
</span><a href="Cardano.Chain.html#getTip"><span class="hs-identifier hs-var">getTip</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384936"><span class="hs-identifier hs-var">mvState</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">ServerStIntersect Block (Point Block) Block m ()
-&gt; m (ServerStIntersect Block (Point Block) Block m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStIntersect Block (Point Block) Block m ()
 -&gt; m (ServerStIntersect Block (Point Block) Block m ()))
-&gt; ServerStIntersect Block (Point Block) Block m ()
-&gt; m (ServerStIntersect Block (Point Block) Block m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Point Block)
</span><a href="#local-6989586621680384930"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-263"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Point Block)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>          </span><span class="annot"><span class="annottext">Block
-&gt; ChainSyncServer Block (Point Block) Block m ()
-&gt; ServerStIntersect Block (Point Block) Block m ()
forall tip header point (m :: * -&gt; *) a.
tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">SendMsgIntersectNotFound</span></a></span><span>
</span><span id="line-265"></span><span>            </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384929"><span class="hs-identifier hs-var">tip'</span></a></span><span>
</span><span id="line-266"></span><span>            </span><span class="hs-comment">-- No intersection found. Resume from origin.</span><span>
</span><span id="line-267"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ServerStIdle Block (Point Block) Block m ())
-&gt; ChainSyncServer Block (Point Block) Block m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">ChainSyncServer</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ServerStIdle Block (Point Block) Block m ())
 -&gt; ChainSyncServer Block (Point Block) Block m ())
-&gt; m (ServerStIdle Block (Point Block) Block m ())
-&gt; ChainSyncServer Block (Point Block) Block m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m LocalChannel
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
Integer -&gt; m LocalChannel
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#cloneChainFrom"><span class="hs-identifier hs-var">cloneChainFrom</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">m LocalChannel
-&gt; (LocalChannel
    -&gt; m (ServerStIdle Block (Point Block) Block m ()))
-&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680384925"><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384925"><span class="hs-identifier hs-var">point'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-269"></span><span>          </span><span class="annot"><span class="annottext">Point Block
-&gt; Block
-&gt; ChainSyncServer Block (Point Block) Block m ()
-&gt; ServerStIntersect Block (Point Block) Block m ()
forall point tip header (m :: * -&gt; *) a.
point
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">SendMsgIntersectFound</span></a></span><span>
</span><span id="line-270"></span><span>            </span><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384925"><span class="hs-identifier hs-var">point'</span></a></span><span>
</span><span id="line-271"></span><span>            </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384929"><span class="hs-identifier hs-var">tip'</span></a></span><span>
</span><span id="line-272"></span><span>            </span><span class="hs-comment">-- Resuming from point'.</span><span>
</span><span id="line-273"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ServerStIdle Block (Point Block) Block m ())
-&gt; ChainSyncServer Block (Point Block) Block m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">ChainSyncServer</span></a></span><span> </span><span class="annot"><span class="annottext">(m (ServerStIdle Block (Point Block) Block m ())
 -&gt; ChainSyncServer Block (Point Block) Block m ())
-&gt; m (ServerStIdle Block (Point Block) Block m ())
-&gt; ChainSyncServer Block (Point Block) Block m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; m LocalChannel
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
Integer -&gt; m LocalChannel
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#cloneChainFrom"><span class="hs-identifier hs-var">cloneChainFrom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Point Block -&gt; Integer
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#pointOffset"><span class="hs-identifier hs-var">pointOffset</span></a></span><span> </span><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384925"><span class="hs-identifier hs-var">point'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m LocalChannel
-&gt; (LocalChannel
    -&gt; m (ServerStIdle Block (Point Block) Block m ()))
-&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span class="hs-comment">{- This is a wrapper around the creation of a `ServerStNext` -}</span><span>
</span><span id="line-276"></span><span id="local-6989586621680385279"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#sendRollForward"><span class="hs-identifier hs-type">sendRollForward</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385279"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385279"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-280"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-comment">-- tip</span><span>
</span><span id="line-281"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-comment">-- current</span><span>
</span><span id="line-282"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385279"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStNext</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385279"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-283"></span><span id="sendRollForward"><span class="annot"><span class="annottext">sendRollForward :: LocalChannel
-&gt; Block
-&gt; Block
-&gt; m (ServerStNext Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#sendRollForward"><span class="hs-identifier hs-var hs-var">sendRollForward</span></a></span></span><span> </span><span id="local-6989586621680384922"><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621680384922"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span id="local-6989586621680384921"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384921"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621680384920"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384920"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block m ()
-&gt; m (ServerStNext Block (Point Block) Block m ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext Block (Point Block) Block m ()
 -&gt; m (ServerStNext Block (Point Block) Block m ()))
-&gt; ServerStNext Block (Point Block) Block m ()
-&gt; m (ServerStNext Block (Point Block) Block m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-284"></span><span>    </span><span class="annot"><span class="annottext">Block
-&gt; Block
-&gt; ChainSyncServer Block (Point Block) Block m ()
-&gt; ServerStNext Block (Point Block) Block m ()
forall header tip point (m :: * -&gt; *) a.
header
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStNext header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">SendMsgRollForward</span></a></span><span>
</span><span id="line-285"></span><span>        </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384920"><span class="hs-identifier hs-var">current</span></a></span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384921"><span class="hs-identifier hs-var">tip'</span></a></span><span>
</span><span id="line-287"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m (ServerStIdle Block (Point Block) Block m ())
-&gt; ChainSyncServer Block (Point Block) Block m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">ChainSyncServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel
</span><a href="#local-6989586621680384922"><span class="hs-identifier hs-var">channel'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="hs-comment">{- This is the state for a new connection. For now we start with
   slot 0, and in idleState. This will probably change, since it
   makes more sense to start in the `StIntersect` state. -}</span><span>
</span><span id="line-292"></span><span id="local-6989586621680385111"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#chainSyncServer"><span class="hs-identifier hs-type">chainSyncServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385111"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-294"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ChainSyncServer</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385111"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-296"></span><span id="chainSyncServer"><span class="annot"><span class="annottext">chainSyncServer :: ChainSyncServer Block (Point Block) Block m ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#chainSyncServer"><span class="hs-identifier hs-var hs-var">chainSyncServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><span class="annottext">m (ServerStIdle Block (Point Block) Block m ())
-&gt; ChainSyncServer Block (Point Block) Block m ()
forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">ChainSyncServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; m LocalChannel
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
Integer -&gt; m LocalChannel
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#cloneChainFrom"><span class="hs-identifier hs-var">cloneChainFrom</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">m LocalChannel
-&gt; (LocalChannel
    -&gt; m (ServerStIdle Block (Point Block) Block m ()))
-&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
LocalChannel -&gt; m (ServerStIdle Block (Point Block) Block m ())
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#idleState"><span class="hs-identifier hs-var">idleState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="hs-comment">{- Use a `TChan` to model a broadcast channel of which we
   clone (with potentially varying offsets) for clients. -}</span><span>
</span><span id="line-301"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#cloneChainFrom"><span class="hs-identifier hs-type">cloneChainFrom</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680385259"><span class="annot"><a href="#local-6989586621680385259"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385259"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385259"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-305"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385259"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-type">LocalChannel</span></a></span><span>
</span><span id="line-306"></span><span id="cloneChainFrom"><span class="annot"><span class="annottext">cloneChainFrom :: Integer -&gt; m LocalChannel
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#cloneChainFrom"><span class="hs-identifier hs-var hs-var">cloneChainFrom</span></a></span></span><span> </span><span id="local-6989586621680384917"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384917"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; LocalChannel
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#LocalChannel"><span class="hs-identifier hs-var">LocalChannel</span></a></span><span> </span><span class="annot"><span class="annottext">(TChan Block -&gt; LocalChannel) -&gt; m (TChan Block) -&gt; m LocalChannel
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">m (TChan Block)
</span><a href="#local-6989586621680384916"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-307"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-308"></span><span>    </span><span class="annot"><a href="#local-6989586621680384916"><span class="hs-identifier hs-type">go</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621680385259"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span>    </span><span id="local-6989586621680384916"><span class="annot"><span class="annottext">go :: m (TChan Block)
</span><a href="#local-6989586621680384916"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>        </span><span id="local-6989586621680384915"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384915"><span class="hs-identifier hs-var">globalChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar MockNodeServerChainState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-var">ask</span></a></span><span> </span><span class="annot"><span class="annottext">m (MVar MockNodeServerChainState)
-&gt; (MVar MockNodeServerChainState -&gt; m (TChan Block))
-&gt; m (TChan Block)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; m (TChan Block)
forall (m :: * -&gt; *).
MonadIO m =&gt;
MVar MockNodeServerChainState -&gt; m (TChan Block)
</span><a href="Cardano.Chain.html#getChannel"><span class="hs-identifier hs-var">getChannel</span></a></span><span>
</span><span id="line-311"></span><span>        </span><span class="annot"><span class="annottext">IO (TChan Block) -&gt; m (TChan Block)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (TChan Block) -&gt; m (TChan Block))
-&gt; IO (TChan Block) -&gt; m (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TChan Block) -&gt; IO (TChan Block)
forall a. STM a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">atomically</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (TChan Block) -&gt; IO (TChan Block))
-&gt; STM (TChan Block) -&gt; IO (TChan Block)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-312"></span><span>            </span><span id="local-6989586621680384914"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384914"><span class="hs-identifier hs-var">localChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; STM (TChan Block)
forall a. TChan a -&gt; STM (TChan a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">cloneTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384915"><span class="hs-identifier hs-var">globalChannel</span></a></span><span>
</span><span id="line-313"></span><span>            </span><span class="annot"><span class="annottext">TChan Block -&gt; Integer -&gt; STM (TChan Block)
forall a. TChan a -&gt; Integer -&gt; STM (TChan a)
</span><a href="#local-6989586621680384913"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384914"><span class="hs-identifier hs-var">localChannel</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384917"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621680385249"><span class="annot"><a href="#local-6989586621680384913"><span class="hs-identifier hs-type">consume</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385249"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385249"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-316"></span><span>    </span><span id="local-6989586621680384913"><span class="annot"><span class="annottext">consume :: TChan a -&gt; Integer -&gt; STM (TChan a)
</span><a href="#local-6989586621680384913"><span class="hs-identifier hs-var hs-var">consume</span></a></span></span><span> </span><span id="local-6989586621680384912"><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621680384912"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span id="local-6989586621680384911"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384911"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384911"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TChan a -&gt; STM (TChan a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621680384912"><span class="hs-identifier hs-var">channel'</span></a></span><span>
</span><span id="line-317"></span><span>    </span><span class="annot"><a href="#local-6989586621680384913"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span id="local-6989586621680384910"><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621680384910"><span class="hs-identifier hs-var">channel'</span></a></span></span><span> </span><span id="local-6989586621680384909"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384909"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>        </span><span class="hs-comment">-- We should have all requested blocks available on the</span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-comment">-- channel, for consumption.</span><span>
</span><span id="line-320"></span><span>        </span><span class="annot"><span class="annottext">TChan a -&gt; STM (Maybe a)
forall a. TChan a -&gt; STM (Maybe a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">tryReadTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621680384910"><span class="hs-identifier hs-var">channel'</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe a) -&gt; STM (TChan a) -&gt; STM (TChan a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TChan a -&gt; Integer -&gt; STM (TChan a)
forall a. TChan a -&gt; Integer -&gt; STM (TChan a)
</span><a href="#local-6989586621680384913"><span class="hs-identifier hs-var">consume</span></a></span><span> </span><span class="annot"><span class="annottext">TChan a
</span><a href="#local-6989586621680384910"><span class="hs-identifier hs-var">channel'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384909"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span class="hs-comment">-- * Protocol setup</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">{- The node protocols always run in the IO monad. I wanted to use a
   different monad stack (mainly to be able to pass the internal state
   in a `MonadReader` and future proofing) so I wrote some hoisting
   functions for each of the states which transform the `ChainSyncMonad`
   into IO. -}</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span id="local-6989586621680385225"><span id="local-6989586621680385226"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistChainSync"><span class="hs-identifier hs-type">hoistChainSync</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385226"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-332"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ChainSyncServer</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385225"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-333"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385226"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ChainSyncServer</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385225"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-334"></span><span id="hoistChainSync"><span class="annot"><span class="annottext">hoistChainSync :: ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistChainSync"><span class="hs-identifier hs-var hs-var">hoistChainSync</span></a></span></span><span> </span><span id="local-6989586621680384907"><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384907"><span class="hs-identifier hs-var">machine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621680384906"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384906"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar MockNodeServerChainState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block IO a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer :: forall header point tip (m :: * -&gt; *) a.
m (ServerStIdle header point tip m a)
-&gt; ChainSyncServer header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ChainSyncServer</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-337"></span><span>        </span><span class="hs-comment">{- The basic idea is running the reader monad to remove it,
           leaving only IO, which is what we need. We do the same for all
           other states. -}</span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="annottext">runChainSyncServer :: IO (ServerStIdle Block (Point Block) Block IO a)
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">runChainSyncServer</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; ChainSyncMonad (ServerStIdle Block (Point Block) Block IO a)
-&gt; IO (ServerStIdle Block (Point Block) Block IO a)
forall a. MVar MockNodeServerChainState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384906"><span class="hs-identifier hs-var">internalState</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncMonad (ServerStIdle Block (Point Block) Block IO a)
 -&gt; IO (ServerStIdle Block (Point Block) Block IO a))
-&gt; ChainSyncMonad (ServerStIdle Block (Point Block) Block IO a)
-&gt; IO (ServerStIdle Block (Point Block) Block IO a)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-341"></span><span>            </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; ChainSyncMonad
     (ServerStIdle Block (Point Block) Block ChainSyncMonad a)
forall header point tip (m :: * -&gt; *) a.
ChainSyncServer header point tip m a
-&gt; m (ServerStIdle header point tip m a)
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var hs-var">runChainSyncServer</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384907"><span class="hs-identifier hs-var">machine</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStIdle Block (Point Block) Block ChainSyncMonad a)
-&gt; (ServerStIdle Block (Point Block) Block ChainSyncMonad a
    -&gt; ChainSyncMonad (ServerStIdle Block (Point Block) Block IO a))
-&gt; ChainSyncMonad (ServerStIdle Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIdle Block (Point Block) Block ChainSyncMonad a
-&gt; ChainSyncMonad (ServerStIdle Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ServerStIdle Block (Point Block) Block ChainSyncMonad a
-&gt; m (ServerStIdle Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStIdle"><span class="hs-identifier hs-var">hoistStIdle</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span id="local-6989586621680385238"><span id="local-6989586621680385239"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStIdle"><span class="hs-identifier hs-type">hoistStIdle</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385239"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-346"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385238"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-347"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385239"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385238"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-348"></span><span id="hoistStIdle"><span class="annot"><span class="annottext">hoistStIdle :: ServerStIdle Block (Point Block) Block ChainSyncMonad a
-&gt; m (ServerStIdle Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStIdle"><span class="hs-identifier hs-var hs-var">hoistStIdle</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span id="local-6989586621680384903"><span class="annot"><span class="annottext">ChainSyncMonad
  (Either
     (ServerStNext Block (Point Block) Block ChainSyncMonad a)
     (ChainSyncMonad
        (ServerStNext Block (Point Block) Block ChainSyncMonad a)))
</span><a href="#local-6989586621680384903"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span> </span><span id="local-6989586621680384902"><span class="annot"><span class="annottext">[Point Block]
-&gt; ChainSyncMonad
     (ServerStIntersect Block (Point Block) Block ChainSyncMonad a)
</span><a href="#local-6989586621680384902"><span class="hs-identifier hs-var">findIntersect'</span></a></span></span><span> </span><span id="local-6989586621680384901"><span class="annot"><span class="annottext">ChainSyncMonad a
</span><a href="#local-6989586621680384901"><span class="hs-identifier hs-var">done</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621680384900"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384900"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (MVar MockNodeServerChainState)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-var">ask</span></a></span><span>
</span><span id="line-350"></span><span>    </span><span class="annot"><span class="annottext">ServerStIdle Block (Point Block) Block IO a
-&gt; m (ServerStIdle Block (Point Block) Block IO a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIdle :: forall header point tip (m :: * -&gt; *) a.
m (Either
     (ServerStNext header point tip m a)
     (m (ServerStNext header point tip m a)))
-&gt; ([point] -&gt; m (ServerStIntersect header point tip m a))
-&gt; m a
-&gt; ServerStIdle header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIdle</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">recvMsgRequestNext :: IO
  (Either
     (ServerStNext Block (Point Block) Block IO a)
     (IO (ServerStNext Block (Point Block) Block IO a)))
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">recvMsgRequestNext</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-352"></span><span>            </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; ChainSyncMonad
     (Either
        (ServerStNext Block (Point Block) Block IO a)
        (IO (ServerStNext Block (Point Block) Block IO a)))
-&gt; IO
     (Either
        (ServerStNext Block (Point Block) Block IO a)
        (IO (ServerStNext Block (Point Block) Block IO a)))
forall a. MVar MockNodeServerChainState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384900"><span class="hs-identifier hs-var">internalState</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncMonad
   (Either
      (ServerStNext Block (Point Block) Block IO a)
      (IO (ServerStNext Block (Point Block) Block IO a)))
 -&gt; IO
      (Either
         (ServerStNext Block (Point Block) Block IO a)
         (IO (ServerStNext Block (Point Block) Block IO a))))
-&gt; ChainSyncMonad
     (Either
        (ServerStNext Block (Point Block) Block IO a)
        (IO (ServerStNext Block (Point Block) Block IO a)))
-&gt; IO
     (Either
        (ServerStNext Block (Point Block) Block IO a)
        (IO (ServerStNext Block (Point Block) Block IO a)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-353"></span><span>                </span><span class="annot"><span class="annottext">ChainSyncMonad
  (Either
     (ServerStNext Block (Point Block) Block ChainSyncMonad a)
     (ChainSyncMonad
        (ServerStNext Block (Point Block) Block ChainSyncMonad a)))
</span><a href="#local-6989586621680384903"><span class="hs-identifier hs-var">nextState'</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (Either
     (ServerStNext Block (Point Block) Block ChainSyncMonad a)
     (ChainSyncMonad
        (ServerStNext Block (Point Block) Block ChainSyncMonad a)))
-&gt; (Either
      (ServerStNext Block (Point Block) Block ChainSyncMonad a)
      (ChainSyncMonad
         (ServerStNext Block (Point Block) Block ChainSyncMonad a))
    -&gt; ChainSyncMonad
         (Either
            (ServerStNext Block (Point Block) Block IO a)
            (IO (ServerStNext Block (Point Block) Block IO a))))
-&gt; ChainSyncMonad
     (Either
        (ServerStNext Block (Point Block) Block IO a)
        (IO (ServerStNext Block (Point Block) Block IO a)))
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-354"></span><span>                    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680384899"><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384899"><span class="hs-identifier hs-var">stNext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block IO a
-&gt; Either
     (ServerStNext Block (Point Block) Block IO a)
     (IO (ServerStNext Block (Point Block) Block IO a))
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span>         </span><span class="annot"><span class="annottext">(ServerStNext Block (Point Block) Block IO a
 -&gt; Either
      (ServerStNext Block (Point Block) Block IO a)
      (IO (ServerStNext Block (Point Block) Block IO a)))
-&gt; ReaderT
     (MVar MockNodeServerChainState)
     IO
     (ServerStNext Block (Point Block) Block IO a)
-&gt; ChainSyncMonad
     (Either
        (ServerStNext Block (Point Block) Block IO a)
        (IO (ServerStNext Block (Point Block) Block IO a)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>  </span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block ChainSyncMonad a
-&gt; ReaderT
     (MVar MockNodeServerChainState)
     IO
     (ServerStNext Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ServerStNext Block (Point Block) Block ChainSyncMonad a
-&gt; m (ServerStNext Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStNext"><span class="hs-identifier hs-var">hoistStNext</span></a></span><span>     </span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384899"><span class="hs-identifier hs-var">stNext</span></a></span><span>
</span><span id="line-355"></span><span>                    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680384897"><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStNext Block (Point Block) Block ChainSyncMonad a)
</span><a href="#local-6989586621680384897"><span class="hs-identifier hs-var">mNext</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IO (ServerStNext Block (Point Block) Block IO a)
-&gt; Either
     (ServerStNext Block (Point Block) Block IO a)
     (IO (ServerStNext Block (Point Block) Block IO a))
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(IO (ServerStNext Block (Point Block) Block IO a)
 -&gt; Either
      (ServerStNext Block (Point Block) Block IO a)
      (IO (ServerStNext Block (Point Block) Block IO a)))
-&gt; (ServerStNext Block (Point Block) Block IO a
    -&gt; IO (ServerStNext Block (Point Block) Block IO a))
-&gt; ServerStNext Block (Point Block) Block IO a
-&gt; Either
     (ServerStNext Block (Point Block) Block IO a)
     (IO (ServerStNext Block (Point Block) Block IO a))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block IO a
-&gt; IO (ServerStNext Block (Point Block) Block IO a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext Block (Point Block) Block IO a
 -&gt; Either
      (ServerStNext Block (Point Block) Block IO a)
      (IO (ServerStNext Block (Point Block) Block IO a)))
-&gt; ReaderT
     (MVar MockNodeServerChainState)
     IO
     (ServerStNext Block (Point Block) Block IO a)
-&gt; ChainSyncMonad
     (Either
        (ServerStNext Block (Point Block) Block IO a)
        (IO (ServerStNext Block (Point Block) Block IO a)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ServerStNext Block (Point Block) Block ChainSyncMonad a
-&gt; ReaderT
     (MVar MockNodeServerChainState)
     IO
     (ServerStNext Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ServerStNext Block (Point Block) Block ChainSyncMonad a
-&gt; m (ServerStNext Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStNext"><span class="hs-identifier hs-var">hoistStNext</span></a></span><span> </span><span class="annot"><span class="annottext">(ServerStNext Block (Point Block) Block ChainSyncMonad a
 -&gt; ReaderT
      (MVar MockNodeServerChainState)
      IO
      (ServerStNext Block (Point Block) Block IO a))
-&gt; ChainSyncMonad
     (ServerStNext Block (Point Block) Block ChainSyncMonad a)
-&gt; ReaderT
     (MVar MockNodeServerChainState)
     IO
     (ServerStNext Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">=&lt;&lt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStNext Block (Point Block) Block ChainSyncMonad a)
</span><a href="#local-6989586621680384897"><span class="hs-identifier hs-var">mNext</span></a></span><span> </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">recvMsgFindIntersect :: [Point Block]
-&gt; IO (ServerStIntersect Block (Point Block) Block IO a)
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">recvMsgFindIntersect</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680384895"><span class="annot"><span class="annottext">[Point Block]
</span><a href="#local-6989586621680384895"><span class="hs-identifier hs-var">points</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>            </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; ChainSyncMonad
     (ServerStIntersect Block (Point Block) Block IO a)
-&gt; IO (ServerStIntersect Block (Point Block) Block IO a)
forall a. MVar MockNodeServerChainState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384900"><span class="hs-identifier hs-var">internalState</span></a></span><span>
</span><span id="line-358"></span><span>                         </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Point Block]
-&gt; ChainSyncMonad
     (ServerStIntersect Block (Point Block) Block ChainSyncMonad a)
</span><a href="#local-6989586621680384902"><span class="hs-identifier hs-var">findIntersect'</span></a></span><span> </span><span class="annot"><span class="annottext">[Point Block]
</span><a href="#local-6989586621680384895"><span class="hs-identifier hs-var">points</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad
  (ServerStIntersect Block (Point Block) Block ChainSyncMonad a)
-&gt; (ServerStIntersect Block (Point Block) Block ChainSyncMonad a
    -&gt; ChainSyncMonad
         (ServerStIntersect Block (Point Block) Block IO a))
-&gt; ChainSyncMonad
     (ServerStIntersect Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">ServerStIntersect Block (Point Block) Block ChainSyncMonad a
-&gt; ChainSyncMonad
     (ServerStIntersect Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ServerStIntersect Block (Point Block) Block ChainSyncMonad a
-&gt; m (ServerStIntersect Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStIntersect"><span class="hs-identifier hs-var">hoistStIntersect</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-359"></span><span>        </span><span class="annot"><span class="annottext">recvMsgDoneClient :: IO a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">recvMsgDoneClient</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState -&gt; ChainSyncMonad a -&gt; IO a
forall a. MVar MockNodeServerChainState -&gt; ChainSyncMonad a -&gt; IO a
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#runChainSync"><span class="hs-identifier hs-var">runChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384900"><span class="hs-identifier hs-var">internalState</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncMonad a
</span><a href="#local-6989586621680384901"><span class="hs-identifier hs-var">done</span></a></span><span>
</span><span id="line-360"></span><span>   </span><span class="hs-special">}</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span id="local-6989586621680385229"><span id="local-6989586621680385230"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStIntersect"><span class="hs-identifier hs-type">hoistStIntersect</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-363"></span><span>    </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385230"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-364"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIntersect</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385229"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-365"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385230"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStIntersect</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385229"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-366"></span><span id="hoistStIntersect"><span class="annot"><span class="annottext">hoistStIntersect :: ServerStIntersect Block (Point Block) Block ChainSyncMonad a
-&gt; m (ServerStIntersect Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStIntersect"><span class="hs-identifier hs-var hs-var">hoistStIntersect</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">SendMsgIntersectFound</span></a></span><span> </span><span id="local-6989586621680384893"><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384893"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span id="local-6989586621680384892"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384892"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621680384891"><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384891"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>    </span><span class="annot"><span class="annottext">Point Block
-&gt; Block
-&gt; ChainSyncServer Block (Point Block) Block IO a
-&gt; ServerStIntersect Block (Point Block) Block IO a
forall point tip header (m :: * -&gt; *) a.
point
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">SendMsgIntersectFound</span></a></span><span> </span><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384893"><span class="hs-identifier hs-var">point</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384892"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncServer Block (Point Block) Block IO a
 -&gt; ServerStIntersect Block (Point Block) Block IO a)
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
-&gt; m (ServerStIntersect Block (Point Block) Block IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384891"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-368"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStIntersect"><span class="hs-identifier hs-var">hoistStIntersect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">SendMsgIntersectNotFound</span></a></span><span> </span><span id="local-6989586621680384890"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384890"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621680384889"><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384889"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-369"></span><span>    </span><span class="annot"><span class="annottext">Block
-&gt; ChainSyncServer Block (Point Block) Block IO a
-&gt; ServerStIntersect Block (Point Block) Block IO a
forall tip header point (m :: * -&gt; *) a.
tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStIntersect header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">SendMsgIntersectNotFound</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384890"><span class="hs-identifier hs-var">tip'</span></a></span><span>    </span><span class="annot"><span class="annottext">(ChainSyncServer Block (Point Block) Block IO a
 -&gt; ServerStIntersect Block (Point Block) Block IO a)
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
-&gt; m (ServerStIntersect Block (Point Block) Block IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384889"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span id="local-6989586621680385234"><span id="local-6989586621680385235"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStNext"><span class="hs-identifier hs-type">hoistStNext</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-372"></span><span>    </span><span class="annot"><a href="../file:///nix/store/50z9mfcyab831xv3ljzrgw24b0c22y3g-mtl-lib-mtl-2.2.2-haddock-doc/share/doc/mtl/html/src"><span class="hs-identifier hs-type">MonadReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680385235"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-373"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStNext</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#ChainSyncMonad"><span class="hs-identifier hs-type">ChainSyncMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385234"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-374"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385235"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">ServerStNext</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">Tip</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385234"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-375"></span><span id="hoistStNext"><span class="annot"><span class="annottext">hoistStNext :: ServerStNext Block (Point Block) Block ChainSyncMonad a
-&gt; m (ServerStNext Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStNext"><span class="hs-identifier hs-var hs-var">hoistStNext</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">SendMsgRollForward</span></a></span><span> </span><span id="local-6989586621680384888"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384888"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621680384887"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384887"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621680384886"><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384886"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><span class="annottext">Block
-&gt; Block
-&gt; ChainSyncServer Block (Point Block) Block IO a
-&gt; ServerStNext Block (Point Block) Block IO a
forall header tip point (m :: * -&gt; *) a.
header
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStNext header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">SendMsgRollForward</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384888"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384887"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncServer Block (Point Block) Block IO a
 -&gt; ServerStNext Block (Point Block) Block IO a)
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
-&gt; m (ServerStNext Block (Point Block) Block IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384886"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-377"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistStNext"><span class="hs-identifier hs-var">hoistStNext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">SendMsgRollBackward</span></a></span><span> </span><span id="local-6989586621680384884"><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384884"><span class="hs-identifier hs-var">header</span></a></span></span><span> </span><span id="local-6989586621680384883"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384883"><span class="hs-identifier hs-var">tip'</span></a></span></span><span> </span><span id="local-6989586621680384882"><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384882"><span class="hs-identifier hs-var">nextState'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-378"></span><span>    </span><span class="annot"><span class="annottext">Point Block
-&gt; Block
-&gt; ChainSyncServer Block (Point Block) Block IO a
-&gt; ServerStNext Block (Point Block) Block IO a
forall point tip header (m :: * -&gt; *) a.
point
-&gt; tip
-&gt; ChainSyncServer header point tip m a
-&gt; ServerStNext header point tip m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">SendMsgRollBackward</span></a></span><span> </span><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384884"><span class="hs-identifier hs-var">header</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384883"><span class="hs-identifier hs-var">tip'</span></a></span><span> </span><span class="annot"><span class="annottext">(ChainSyncServer Block (Point Block) Block IO a
 -&gt; ServerStNext Block (Point Block) Block IO a)
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
-&gt; m (ServerStNext Block (Point Block) Block IO a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad a
</span><a href="#local-6989586621680384882"><span class="hs-identifier hs-var">nextState'</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">{- This is boilerplate code that sets up the node protocols,
   you can find in:
     ouroboros-network/ouroboros-network/demo/chain-sync.hs -}</span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span id="local-6989586621680385321"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#protocolLoop"><span class="hs-identifier hs-type">protocolLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385321"><span class="hs-identifier hs-type">m</span></a></span><span>
</span><span id="line-386"></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">FilePath</span></a></span><span>
</span><span id="line-387"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span>
</span><span id="line-388"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385321"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span></span><span>
</span><span id="line-389"></span><span id="protocolLoop"><span class="annot"><span class="annottext">protocolLoop :: FilePath -&gt; MVar MockNodeServerChainState -&gt; m Void
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#protocolLoop"><span class="hs-identifier hs-var hs-var">protocolLoop</span></a></span></span><span> </span><span id="local-6989586621680384881"><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680384881"><span class="hs-identifier hs-var">socketPath</span></a></span></span><span> </span><span id="local-6989586621680384880"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384880"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO Void -&gt; m Void
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">liftIO</span></a></span><span> </span><span class="annot"><span class="annottext">(IO Void -&gt; m Void) -&gt; IO Void -&gt; m Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(IOManager -&gt; IO Void) -&gt; IO Void
WithIOManager
</span><a href="../file:///nix/store/3h7idad3jkr1m7rx7xh537d2rhbxrzim-Win32-network-lib-Win32-network-0.1.1.0-haddock-doc/share/doc/Win32-network/html/src"><span class="hs-identifier hs-var">withIOManager</span></a></span><span> </span><span class="annot"><span class="annottext">((IOManager -&gt; IO Void) -&gt; IO Void)
-&gt; (IOManager -&gt; IO Void) -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680384878"><span class="annot"><span class="annottext">IOManager
</span><a href="#local-6989586621680384878"><span class="hs-identifier hs-var">iocp</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-390"></span><span>    </span><span id="local-6989586621680384877"><span class="annot"><span class="annottext">NetworkMutableState LocalAddress
</span><a href="#local-6989586621680384877"><span class="hs-identifier hs-var">networkState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (NetworkMutableState LocalAddress)
forall addr. IO (NetworkMutableState addr)
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">newNetworkMutableState</span></a></span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="annottext">Async ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO () -&gt; IO (Async ())
forall a. IO a -&gt; IO (Async a)
</span><a href="../file:///nix/store/qbfqwxngc2v3vsmy4gi1kzmsvhddq0qv-async-lib-async-2.2.4-haddock-doc/share/doc/async/html/src"><span class="hs-identifier hs-var">async</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO (Async ())) -&gt; IO () -&gt; IO (Async ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkMutableState LocalAddress -&gt; IO ()
forall addr. NetworkMutableState addr -&gt; IO ()
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">cleanNetworkMutableState</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkMutableState LocalAddress
</span><a href="#local-6989586621680384877"><span class="hs-identifier hs-var">networkState</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="annot"><span class="annottext">Snocket IO LocalSocket LocalAddress
-&gt; NetworkServerTracers LocalAddress NodeToClientVersion
-&gt; NetworkMutableState LocalAddress
-&gt; AcceptedConnectionsLimit
-&gt; LocalAddress
-&gt; Codec
     (Handshake NodeToClientVersion Term)
     DeserialiseFailure
     IO
     ByteString
-&gt; ProtocolTimeLimits (Handshake NodeToClientVersion Term)
-&gt; VersionDataCodec
     Term NodeToClientVersion NodeToClientVersionData
-&gt; (NodeToClientVersionData
    -&gt; NodeToClientVersionData -&gt; Accept NodeToClientVersionData)
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (SomeResponderApplication LocalAddress ByteString IO ())
-&gt; ErrorPolicies
-&gt; (LocalAddress -&gt; Async Void -&gt; IO Void)
-&gt; IO Void
forall vNumber vData t fd addr b.
(Ord vNumber, Typeable vNumber, Show vNumber, Ord addr) =&gt;
Snocket IO fd addr
-&gt; NetworkServerTracers addr vNumber
-&gt; NetworkMutableState addr
-&gt; AcceptedConnectionsLimit
-&gt; addr
-&gt; Codec (Handshake vNumber Term) DeserialiseFailure IO ByteString
-&gt; ProtocolTimeLimits (Handshake vNumber Term)
-&gt; VersionDataCodec Term vNumber vData
-&gt; (vData -&gt; vData -&gt; Accept vData)
-&gt; Versions
     vNumber vData (SomeResponderApplication addr ByteString IO b)
-&gt; ErrorPolicies
-&gt; (addr -&gt; Async Void -&gt; IO t)
-&gt; IO t
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">withServerNode</span></a></span><span>
</span><span id="line-393"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IOManager -&gt; Snocket IO LocalSocket LocalAddress
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">localSnocket</span></a></span><span> </span><span class="annot"><span class="annottext">IOManager
</span><a href="#local-6989586621680384878"><span class="hs-identifier hs-var">iocp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>      </span><span class="annot"><span class="annottext">NetworkServerTracers LocalAddress NodeToClientVersion
forall addr vNumber. NetworkServerTracers addr vNumber
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">nullNetworkServerTracers</span></a></span><span>
</span><span id="line-395"></span><span>      </span><span class="annot"><span class="annottext">NetworkMutableState LocalAddress
</span><a href="#local-6989586621680384877"><span class="hs-identifier hs-var">networkState</span></a></span><span>
</span><span id="line-396"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word32 -&gt; Word32 -&gt; DiffTime -&gt; AcceptedConnectionsLimit
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">AcceptedConnectionsLimit</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Bounded a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="annot"><span class="annottext">Word32
forall a. Bounded a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maxBound</span></a></span><span> </span><span class="annot"><span class="annottext">DiffTime
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FilePath -&gt; LocalAddress
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">localAddressFromPath</span></a></span><span> </span><span class="annot"><span class="annottext">FilePath
</span><a href="#local-6989586621680384881"><span class="hs-identifier hs-var">socketPath</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">Codec
  (Handshake NodeToClientVersion Term)
  DeserialiseFailure
  IO
  ByteString
forall (m :: * -&gt; *).
MonadST m =&gt;
Codec
  (Handshake NodeToClientVersion Term)
  DeserialiseFailure
  m
  ByteString
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">nodeToClientHandshakeCodec</span></a></span><span>
</span><span id="line-399"></span><span>      </span><span class="annot"><span class="annottext">ProtocolTimeLimits (Handshake NodeToClientVersion Term)
forall k (vNumber :: k).
ProtocolTimeLimits (Handshake vNumber Term)
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">noTimeLimitsHandshake</span></a></span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(NodeToClientVersion -&gt; CodecCBORTerm Text NodeToClientVersionData)
-&gt; VersionDataCodec
     Term NodeToClientVersion NodeToClientVersionData
forall vNumber vData.
(vNumber -&gt; CodecCBORTerm Text vData)
-&gt; VersionDataCodec Term vNumber vData
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">cborTermVersionDataCodec</span></a></span><span> </span><span class="annot"><span class="annottext">NodeToClientVersion -&gt; CodecCBORTerm Text NodeToClientVersionData
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">nodeToClientCodecCBORTerm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>      </span><span class="annot"><span class="annottext">NodeToClientVersionData
-&gt; NodeToClientVersionData -&gt; Accept NodeToClientVersionData
forall v. Acceptable v =&gt; v -&gt; v -&gt; Accept v
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">acceptableVersion</span></a></span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OuroborosApplication
  'ResponderMode LocalAddress ByteString IO Void ()
-&gt; SomeResponderApplication LocalAddress ByteString IO ()
forall (appType :: MuxMode) addr bytes (m :: * -&gt; *) a b.
(HasResponder appType ~ 'True) =&gt;
OuroborosApplication appType addr bytes m a b
-&gt; SomeResponderApplication addr bytes m b
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">SomeResponderApplication</span></a></span><span> </span><span class="annot"><span class="annottext">(OuroborosApplication
   'ResponderMode LocalAddress ByteString IO Void ()
 -&gt; SomeResponderApplication LocalAddress ByteString IO ())
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (OuroborosApplication
        'ResponderMode LocalAddress ByteString IO Void ())
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (SomeResponderApplication LocalAddress ByteString IO ())
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="annottext">NodeToClientVersion
-&gt; NodeToClientVersionData
-&gt; (ConnectionId LocalAddress
    -&gt; STM IO ControlMessage
    -&gt; NodeToClientProtocols 'ResponderMode ByteString IO Void ())
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (OuroborosApplication
        'ResponderMode LocalAddress ByteString IO Void ())
forall (m :: * -&gt; *) (appType :: MuxMode) bytes a b.
NodeToClientVersion
-&gt; NodeToClientVersionData
-&gt; (ConnectionId LocalAddress
    -&gt; STM m ControlMessage
    -&gt; NodeToClientProtocols appType bytes m a b)
-&gt; Versions
     NodeToClientVersion
     NodeToClientVersionData
     (OuroborosApplication appType LocalAddress bytes m a b)
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">versionedNodeToClientProtocols</span></a></span><span>
</span><span id="line-404"></span><span>          </span><span class="annot"><span class="annottext">NodeToClientVersion
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">nodeToClientVersion</span></a></span><span>
</span><span id="line-405"></span><span>          </span><span class="annot"><span class="annottext">NodeToClientVersionData
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">nodeToClientVersionData</span></a></span><span>
</span><span id="line-406"></span><span>          </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">ConnectionId LocalAddress
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">STM IO ControlMessage
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; NodeToClientProtocols 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#nodeToClientProtocols"><span class="hs-identifier hs-var">nodeToClientProtocols</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384880"><span class="hs-identifier hs-var">internalState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>      </span><span class="annot"><span class="annottext">ErrorPolicies
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">nullErrorPolicies</span></a></span><span>
</span><span id="line-408"></span><span>      </span><span class="annot"><span class="annottext">((LocalAddress -&gt; Async Void -&gt; IO Void) -&gt; IO Void)
-&gt; (LocalAddress -&gt; Async Void -&gt; IO Void) -&gt; IO Void
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">LocalAddress
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680384860"><span class="annot"><span class="annottext">Async Void
</span><a href="#local-6989586621680384860"><span class="hs-identifier hs-var">serverAsync</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Async Void -&gt; IO Void
forall a. Async a -&gt; IO a
</span><a href="../file:///nix/store/qbfqwxngc2v3vsmy4gi1kzmsvhddq0qv-async-lib-async-2.2.4-haddock-doc/share/doc/async/html/src"><span class="hs-identifier hs-var">wait</span></a></span><span> </span><span class="annot"><span class="annottext">Async Void
</span><a href="#local-6989586621680384860"><span class="hs-identifier hs-var">serverAsync</span></a></span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#nodeToClientProtocols"><span class="hs-identifier hs-type">nodeToClientProtocols</span></a></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">NodeToClientProtocols</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///nix/store/kbrd49nyfr5ssaif435cdk5c5apffi69-network-mux-lib-network-mux-0.1.0.1-haddock-doc/share/doc/network-mux/html/src"><span class="hs-identifier hs-type">ResponderMode</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/dy85hyx24kbdxbcbs19gvac43vbvvnjd-bytestring-lib-bytestring-0.10.12.0-haddock-doc/share/doc/bytestring/html/src"><span class="hs-identifier hs-type">LBS.ByteString</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span id="nodeToClientProtocols"><span class="annot"><span class="annottext">nodeToClientProtocols :: MVar MockNodeServerChainState
-&gt; NodeToClientProtocols 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#nodeToClientProtocols"><span class="hs-identifier hs-var hs-var">nodeToClientProtocols</span></a></span></span><span> </span><span id="local-6989586621680384858"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384858"><span class="hs-identifier hs-var">internalState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-414"></span><span>  </span><span class="annot"><span class="annottext">NodeToClientProtocols :: forall (appType :: MuxMode) bytes (m :: * -&gt; *) a b.
RunMiniProtocol appType bytes m a b
-&gt; RunMiniProtocol appType bytes m a b
-&gt; RunMiniProtocol appType bytes m a b
-&gt; RunMiniProtocol appType bytes m a b
-&gt; NodeToClientProtocols appType bytes m a b
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">NodeToClientProtocols</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">localChainSyncProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">localChainSyncProtocol</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#chainSync"><span class="hs-identifier hs-var">chainSync</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384858"><span class="hs-identifier hs-var">internalState</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">localTxSubmissionProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">localTxSubmissionProtocol</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#txSubmission"><span class="hs-identifier hs-var">txSubmission</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384858"><span class="hs-identifier hs-var">internalState</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">localStateQueryProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">localStateQueryProtocol</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall (m :: * -&gt; *) a.
MonadTimer m =&gt;
RunMiniProtocol 'ResponderMode ByteString m Void a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">doNothingResponderProtocol</span></a></span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">localTxMonitorProtocol :: RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">localTxMonitorProtocol</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall (m :: * -&gt; *) a.
MonadTimer m =&gt;
RunMiniProtocol 'ResponderMode ByteString m Void a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">doNothingResponderProtocol</span></a></span><span>
</span><span id="line-419"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-420"></span><span>
</span><span id="line-421"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#chainSync"><span class="hs-identifier hs-type">chainSync</span></a></span><span>
</span><span id="line-422"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-type">RunMiniProtocol</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///nix/store/kbrd49nyfr5ssaif435cdk5c5apffi69-network-mux-lib-network-mux-0.1.0.1-haddock-doc/share/doc/network-mux/html/src"><span class="hs-identifier hs-type">ResponderMode</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/dy85hyx24kbdxbcbs19gvac43vbvvnjd-bytestring-lib-bytestring-0.10.12.0-haddock-doc/share/doc/bytestring/html/src"><span class="hs-identifier hs-type">LBS.ByteString</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span id="chainSync"><span class="annot"><span class="annottext">chainSync :: MVar MockNodeServerChainState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#chainSync"><span class="hs-identifier hs-var hs-var">chainSync</span></a></span></span><span> </span><span id="local-6989586621680384849"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384849"><span class="hs-identifier hs-var">mvChainState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-425"></span><span>     </span><span class="annot"><span class="annottext">MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall bytes (m :: * -&gt; *) b.
MuxPeer bytes m b -&gt; RunMiniProtocol 'ResponderMode bytes m Void b
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">ResponderProtocolOnly</span></a></span><span> </span><span class="annot"><span class="annottext">(MuxPeer ByteString IO ()
 -&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ())
-&gt; MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-426"></span><span>     </span><span class="annot"><span class="annottext">Tracer IO (TraceSendRecv (ChainSync Block (Point Block) Block))
-&gt; Codec
     (ChainSync Block (Point Block) Block)
     DeserialiseFailure
     IO
     ByteString
-&gt; Peer
     (ChainSync Block (Point Block) Block) 'AsServer 'StIdle IO ()
-&gt; MuxPeer ByteString IO ()
forall (pr :: PeerRole) ps (st :: ps) failure bytes (m :: * -&gt; *)
       a.
(Show failure, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; Peer ps pr st m a
-&gt; MuxPeer bytes m a
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">MuxPeer</span></a></span><span>
</span><span id="line-427"></span><span>       </span><span class="annot"><span class="annottext">Tracer IO (TraceSendRecv (ChainSync Block (Point Block) Block))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><a href="../file:///nix/store/nhl1qjsgl4zpvgrmpa6xzrl7bwwbxld1-contra-tracer-lib-contra-tracer-0.1.0.0-haddock-doc/share/doc/contra-tracer/html/src"><span class="hs-identifier hs-var">nullTracer</span></a></span><span>
</span><span id="line-428"></span><span>       </span><span class="annot"><span class="annottext">Codec
  (ChainSync Block (Point Block) Block)
  DeserialiseFailure
  IO
  ByteString
forall block.
(Serialise block, Serialise (HeaderHash block)) =&gt;
Codec
  (ChainSync block (Point block) Block)
  DeserialiseFailure
  IO
  ByteString
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">chainSyncCodec</span></a></span><span>
</span><span id="line-429"></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block IO ()
-&gt; Peer
     (ChainSync Block (Point Block) Block) 'AsServer 'StIdle IO ()
forall header point tip (m :: * -&gt; *) a.
Monad m =&gt;
ChainSyncServer header point tip m a
-&gt; Peer (ChainSync header point tip) 'AsServer 'StIdle m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">ChainSync.chainSyncServerPeer</span></a></span><span>
</span><span id="line-430"></span><span>           </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Reader
  (MVar MockNodeServerChainState)
  (ChainSyncServer Block (Point Block) Block IO ())
-&gt; MVar MockNodeServerChainState
-&gt; ChainSyncServer Block (Point Block) Block IO ()
forall r a. Reader r a -&gt; r -&gt; a
</span><a href="../file:///nix/store/8r01jj9dl6h1x2byph07y6wxfb3ysd8c-transformers-lib-transformers-0.5.6.2-haddock-doc/share/doc/transformers/html/src"><span class="hs-identifier hs-var">runReader</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad ()
-&gt; Reader
     (MVar MockNodeServerChainState)
     (ChainSyncServer Block (Point Block) Block IO ())
forall (m :: * -&gt; *) a.
MonadReader (MVar MockNodeServerChainState) m =&gt;
ChainSyncServer Block (Point Block) Block ChainSyncMonad a
-&gt; m (ChainSyncServer Block (Point Block) Block IO a)
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#hoistChainSync"><span class="hs-identifier hs-var">hoistChainSync</span></a></span><span> </span><span class="annot"><span class="annottext">ChainSyncServer Block (Point Block) Block ChainSyncMonad ()
forall (m :: * -&gt; *).
(MonadReader (MVar MockNodeServerChainState) m, MonadIO m) =&gt;
ChainSyncServer Block (Point Block) Block m ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#chainSyncServer"><span class="hs-identifier hs-var">chainSyncServer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>                      </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384849"><span class="hs-identifier hs-var">mvChainState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#txSubmission"><span class="hs-identifier hs-type">txSubmission</span></a></span><span>
</span><span id="line-434"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-type">RunMiniProtocol</span></a></span><span> </span><span class="hs-special">'</span><span class="annot"><a href="../file:///nix/store/kbrd49nyfr5ssaif435cdk5c5apffi69-network-mux-lib-network-mux-0.1.0.1-haddock-doc/share/doc/network-mux/html/src"><span class="hs-identifier hs-type">ResponderMode</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/dy85hyx24kbdxbcbs19gvac43vbvvnjd-bytestring-lib-bytestring-0.10.12.0-haddock-doc/share/doc/bytestring/html/src"><span class="hs-identifier hs-type">LBS.ByteString</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-436"></span><span id="txSubmission"><span class="annot"><span class="annottext">txSubmission :: MVar MockNodeServerChainState
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#txSubmission"><span class="hs-identifier hs-var hs-var">txSubmission</span></a></span></span><span> </span><span id="local-6989586621680384842"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384842"><span class="hs-identifier hs-var">mvChainState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-437"></span><span>    </span><span class="annot"><span class="annottext">MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall bytes (m :: * -&gt; *) b.
MuxPeer bytes m b -&gt; RunMiniProtocol 'ResponderMode bytes m Void b
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">ResponderProtocolOnly</span></a></span><span> </span><span class="annot"><span class="annottext">(MuxPeer ByteString IO ()
 -&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ())
-&gt; MuxPeer ByteString IO ()
-&gt; RunMiniProtocol 'ResponderMode ByteString IO Void ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-438"></span><span>    </span><span class="annot"><span class="annottext">Tracer
  IO (TraceSendRecv (LocalTxSubmission (Tx BabbageEra) FilePath))
-&gt; Codec
     (LocalTxSubmission (Tx BabbageEra) FilePath)
     DeserialiseFailure
     IO
     ByteString
-&gt; Peer
     (LocalTxSubmission (Tx BabbageEra) FilePath)
     'AsServer
     'StIdle
     IO
     ()
-&gt; MuxPeer ByteString IO ()
forall (pr :: PeerRole) ps (st :: ps) failure bytes (m :: * -&gt; *)
       a.
(Show failure, forall (st' :: ps). Show (ClientHasAgency st'),
 forall (st' :: ps). Show (ServerHasAgency st'), ShowProxy ps) =&gt;
Tracer m (TraceSendRecv ps)
-&gt; Codec ps failure m bytes
-&gt; Peer ps pr st m a
-&gt; MuxPeer bytes m a
</span><a href="../file:///nix/store/bp3m4ac33j7n0825ryxn7zd3w7nyh7f4-ouroboros-network-framework-lib-ouroboros-network-framework-0.1.0.1-haddock-doc/share/doc/ouroboros-network-framework/html/src"><span class="hs-identifier hs-var">MuxPeer</span></a></span><span>
</span><span id="line-439"></span><span>      </span><span class="annot"><span class="annottext">Tracer
  IO (TraceSendRecv (LocalTxSubmission (Tx BabbageEra) FilePath))
forall (m :: * -&gt; *) a. Applicative m =&gt; Tracer m a
</span><a href="../file:///nix/store/nhl1qjsgl4zpvgrmpa6xzrl7bwwbxld1-contra-tracer-lib-contra-tracer-0.1.0.0-haddock-doc/share/doc/contra-tracer/html/src"><span class="hs-identifier hs-var">nullTracer</span></a></span><span>
</span><span id="line-440"></span><span>      </span><span class="annot"><span class="annottext">Codec
  (LocalTxSubmission (Tx BabbageEra) FilePath)
  DeserialiseFailure
  IO
  ByteString
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">txSubmissionCodec</span></a></span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IO (LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ())
-&gt; Peer
     (LocalTxSubmission (Tx BabbageEra) FilePath)
     'AsServer
     'StIdle
     IO
     ()
forall tx reject (m :: * -&gt; *) a.
Monad m =&gt;
m (LocalTxSubmissionServer tx reject m a)
-&gt; Peer (LocalTxSubmission tx reject) 'AsServer 'StIdle m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">TxSubmission.localTxSubmissionServerPeer</span></a></span><span>
</span><span id="line-442"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
-&gt; IO (LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
 -&gt; IO (LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()))
-&gt; LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
-&gt; IO (LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#txSubmissionServer"><span class="hs-identifier hs-var">txSubmissionServer</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384842"><span class="hs-identifier hs-var">mvChainState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-443"></span><span>
</span><span id="line-444"></span><span class="hs-comment">-- * Computing intersections</span><span>
</span><span id="line-445"></span><span>
</span><span id="line-446"></span><span class="hs-comment">-- Given a `Point` find its offset into the chain.</span><span>
</span><span id="line-447"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#pointOffset"><span class="hs-identifier hs-type">pointOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span>
</span><span id="line-448"></span><span>            </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-449"></span><span id="pointOffset"><span class="annot"><span class="annottext">pointOffset :: Point Block -&gt; Integer
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#pointOffset"><span class="hs-identifier hs-var hs-var">pointOffset</span></a></span></span><span> </span><span id="local-6989586621680384838"><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384838"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-450"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Point Block -&gt; WithOrigin SlotNo
forall block. Point block -&gt; WithOrigin SlotNo
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">pointSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Point Block
</span><a href="#local-6989586621680384838"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-451"></span><span>    </span><span class="annot"><span class="annottext">WithOrigin SlotNo
</span><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier hs-var">Origin</span></a></span><span>        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-452"></span><span>    </span><span class="annot"><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier hs-type">At</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier hs-type">SlotNo</span></a></span><span> </span><span id="local-6989586621680384834"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680384834"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621680384834"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-453"></span><span>
</span><span id="line-454"></span><span class="hs-comment">-- Currently selects all points from the blockchain.</span><span>
</span><span id="line-455"></span><span id="local-6989586621680385277"><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#getChainPoints"><span class="hs-identifier hs-type">getChainPoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MonadIO</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680385277"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TChan</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680385277"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-456"></span><span id="getChainPoints"><span class="annot"><span class="annottext">getChainPoints :: TChan Block -&gt; MockNodeServerChainState -&gt; m [Point Block]
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#getChainPoints"><span class="hs-identifier hs-var hs-var">getChainPoints</span></a></span></span><span> </span><span id="local-6989586621680384833"><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384833"><span class="hs-identifier hs-var">ch</span></a></span></span><span> </span><span id="local-6989586621680384832"><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384832"><span class="hs-identifier hs-var">st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>  </span><span id="local-6989586621680384831"><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621680384831"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TChan Block -&gt; m [Block]
forall (m :: * -&gt; *). MonadIO m =&gt; TChan Block -&gt; m [Block]
</span><a href="Cardano.Chain.html#chainNewestFirst"><span class="hs-identifier hs-var">chainNewestFirst</span></a></span><span> </span><span class="annot"><span class="annottext">TChan Block
</span><a href="#local-6989586621680384833"><span class="hs-identifier hs-var">ch</span></a></span><span>
</span><span id="line-458"></span><span>  </span><span class="annot"><span class="annottext">[Point Block] -&gt; m [Point Block]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([Point Block] -&gt; m [Point Block])
-&gt; [Point Block] -&gt; m [Point Block]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; Block -&gt; Point Block)
-&gt; [Slot] -&gt; [Block] -&gt; [Point Block]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">zipWith</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Block -&gt; Point Block
</span><a href="#local-6989586621680384829"><span class="hs-identifier hs-var">mkPoint</span></a></span><span>
</span><span id="line-459"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">MockNodeServerChainState
</span><a href="#local-6989586621680384832"><span class="hs-identifier hs-var">st</span></a></span><span> </span><span class="annot"><span class="annottext">MockNodeServerChainState
-&gt; Getting Slot MockNodeServerChainState Slot -&gt; Slot
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting Slot MockNodeServerChainState Slot
Lens' MockNodeServerChainState Slot
</span><a href="Cardano.Chain.html#currentSlot"><span class="hs-identifier hs-var">currentSlot</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Slot
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-460"></span><span>    </span><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621680384831"><span class="hs-identifier hs-var">chain</span></a></span><span>
</span><span id="line-461"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-462"></span><span>    </span><span class="annot"><a href="#local-6989586621680384829"><span class="hs-identifier hs-type">mkPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">Point</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Block</span></a></span><span>
</span><span id="line-463"></span><span>    </span><span id="local-6989586621680384829"><span class="annot"><span class="annottext">mkPoint :: Slot -&gt; Block -&gt; Point Block
</span><a href="#local-6989586621680384829"><span class="hs-identifier hs-var hs-var">mkPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span id="local-6989586621680384826"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384826"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680384825"><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384825"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-464"></span><span>      </span><span class="annot"><span class="annottext">WithOrigin (Block SlotNo (HeaderHash Block)) -&gt; Point Block
forall block.
WithOrigin (Block SlotNo (HeaderHash block)) -&gt; Point block
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">Point</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block SlotNo BlockId -&gt; WithOrigin (Block SlotNo BlockId)
forall t. t -&gt; WithOrigin t
</span><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier hs-var">At</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SlotNo -&gt; BlockId -&gt; Block SlotNo BlockId
forall slot hash. slot -&gt; hash -&gt; Block slot hash
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">OP.Block</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; SlotNo
</span><a href="../file:///nix/store/23iksdwzvi0j57sz95bbyk0pb1i98fah-cardano-slotting-lib-cardano-slotting-0.1.0.2-haddock-doc/share/doc/cardano-slotting/html/src"><span class="hs-identifier hs-var">SlotNo</span></a></span><span> </span><span class="annot"><span class="annottext">(Word64 -&gt; SlotNo) -&gt; Word64 -&gt; SlotNo
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Word64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680384826"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Block -&gt; BlockId
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">blockId</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621680384825"><span class="hs-identifier hs-var">block</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span class="hs-comment">-- * TxSubmission protocol</span><span>
</span><span id="line-468"></span><span>
</span><span id="line-469"></span><span class="hs-comment">{- I did not use the same approach for this protocol as I did
   for the `ChainSync`. This protocol has only one state and
   it is much simpler. -}</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span class="annot"><a href="Cardano.Protocol.Socket.Mock.Server.html#txSubmissionServer"><span class="hs-identifier hs-type">txSubmissionServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-474"></span><span>    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">MVar</span></a></span><span> </span><span class="annot"><a href="Cardano.Chain.html#MockNodeServerChainState"><span class="hs-identifier hs-type">MockNodeServerChainState</span></a></span><span>
</span><span id="line-475"></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">TxSubmission.LocalTxSubmissionServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.Tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.BabbageEra</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-476"></span><span id="txSubmissionServer"><span class="annot"><span class="annottext">txSubmissionServer :: MVar MockNodeServerChainState
-&gt; LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
</span><a href="Cardano.Protocol.Socket.Mock.Server.html#txSubmissionServer"><span class="hs-identifier hs-var hs-var">txSubmissionServer</span></a></span></span><span> </span><span id="local-6989586621680384820"><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384820"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
</span><a href="#local-6989586621680384819"><span class="hs-identifier hs-var">txSubmissionState</span></a></span><span>
</span><span id="line-477"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-478"></span><span>      </span><span class="annot"><a href="#local-6989586621680384819"><span class="hs-identifier hs-type">txSubmissionState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">TxSubmission.LocalTxSubmissionServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.Tx</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/r16vjy39pj2p47ag6d6qd397xdpngrlp-cardano-api-lib-cardano-api-1.35.4-haddock-doc/share/doc/cardano-api/html/src"><span class="hs-identifier hs-type">C.BabbageEra</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span>      </span><span id="local-6989586621680384819"><span class="annot"><span class="annottext">txSubmissionState :: LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
</span><a href="#local-6989586621680384819"><span class="hs-identifier hs-var hs-var">txSubmissionState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-480"></span><span>        </span><span class="annot"><span class="annottext">LocalTxSubmissionServer :: forall tx reject (m :: * -&gt; *) a.
(tx
 -&gt; m (SubmitResult reject, LocalTxSubmissionServer tx reject m a))
-&gt; a -&gt; LocalTxSubmissionServer tx reject m a
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-type">TxSubmission.LocalTxSubmissionServer</span></a></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-481"></span><span>          </span><span class="annot"><span class="annottext">recvMsgSubmitTx :: Tx BabbageEra
-&gt; IO
     (SubmitResult FilePath,
      LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ())
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">TxSubmission.recvMsgSubmitTx</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-482"></span><span>            </span><span class="hs-glyph">\</span><span id="local-6989586621680384816"><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680384816"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-483"></span><span>                </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
-&gt; (MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; IO ()
forall a. MVar a -&gt; (a -&gt; IO a) -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">modifyMVar_</span></a></span><span> </span><span class="annot"><span class="annottext">MVar MockNodeServerChainState
</span><a href="#local-6989586621680384820"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MockNodeServerChainState -&gt; IO MockNodeServerChainState
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(MockNodeServerChainState -&gt; IO MockNodeServerChainState)
-&gt; (MockNodeServerChainState -&gt; MockNodeServerChainState)
-&gt; MockNodeServerChainState
-&gt; IO MockNodeServerChainState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  MockNodeServerChainState MockNodeServerChainState TxPool TxPool
-&gt; (TxPool -&gt; TxPool)
-&gt; MockNodeServerChainState
-&gt; MockNodeServerChainState
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">over</span></a></span><span> </span><span class="annot"><span class="annottext">ASetter
  MockNodeServerChainState MockNodeServerChainState TxPool TxPool
Lens' MockNodeServerChainState TxPool
</span><a href="Cardano.Chain.html#txPool"><span class="hs-identifier hs-var">txPool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CardanoTx -&gt; TxPool -&gt; TxPool
</span><a href="Cardano.Chain.html#addTxToPool"><span class="hs-identifier hs-var">addTxToPool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SomeCardanoApiTx -&gt; CardanoTx
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">CardanoApiTx</span></a></span><span> </span><span class="annot"><span class="annottext">(SomeCardanoApiTx -&gt; CardanoTx) -&gt; SomeCardanoApiTx -&gt; CardanoTx
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra -&gt; SomeCardanoApiTx
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">CardanoApiEmulatorEraTx</span></a></span><span> </span><span class="annot"><span class="annottext">Tx BabbageEra
</span><a href="#local-6989586621680384816"><span class="hs-identifier hs-var">tx</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>                </span><span class="annot"><span class="annottext">(SubmitResult FilePath,
 LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ())
-&gt; IO
     (SubmitResult FilePath,
      LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubmitResult FilePath
forall reason. SubmitResult reason
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">TxSubmission.SubmitSuccess</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LocalTxSubmissionServer (Tx BabbageEra) FilePath IO ()
</span><a href="#local-6989586621680384819"><span class="hs-identifier hs-var">txSubmissionState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">recvMsgDone :: ()
</span><a href="../file:///nix/store/81aj6sl5d9757dvrbnsb927sgr0bibpp-ouroboros-network-lib-ouroboros-network-0.1.0.1-haddock-doc/share/doc/ouroboros-network/html/src"><span class="hs-identifier hs-var">TxSubmission.recvMsgDone</span></a></span><span>     </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-487"></span></pre></body></html>
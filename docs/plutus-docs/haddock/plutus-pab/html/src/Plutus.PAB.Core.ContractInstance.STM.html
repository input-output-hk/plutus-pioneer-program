<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DerivingStrategies #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase         #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns     #-}</span><span>
</span><span id="line-4"></span><span class="hs-comment">{-

Types and functions for contract instances that communicate with the outside
world via STM. See note [Contract instance thread model].

-}</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Plutus.PAB.Core.ContractInstance.STM</span><span class="hs-special">(</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier">BlockchainEnv</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyBlockchainEnv"><span class="hs-identifier">emptyBlockchainEnv</span></a></span><span>
</span><span id="line-13"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitSlot"><span class="hs-identifier">awaitSlot</span></a></span><span>
</span><span id="line-14"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitTime"><span class="hs-identifier">awaitTime</span></a></span><span>
</span><span id="line-15"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitEndpointResponse"><span class="hs-identifier">awaitEndpointResponse</span></a></span><span>
</span><span id="line-16"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxStatusChange"><span class="hs-identifier">waitForTxStatusChange</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#updateTxChangesR"><span class="hs-identifier">updateTxChangesR</span></a></span><span>
</span><span id="line-18"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxOutStatusChange"><span class="hs-identifier">waitForTxOutStatusChange</span></a></span><span>
</span><span id="line-19"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#currentSlot"><span class="hs-identifier">currentSlot</span></a></span><span>
</span><span id="line-20"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#lastSyncedBlockSlot"><span class="hs-identifier">lastSyncedBlockSlot</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier">InstanceState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstanceState"><span class="hs-identifier">emptyInstanceState</span></a></span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier">OpenEndpoint</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier">OpenTxOutProducedRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier">OpenTxOutSpentRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#clearEndpoints"><span class="hs-identifier">clearEndpoints</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#addEndpoint"><span class="hs-identifier">addEndpoint</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoSpentReq"><span class="hs-identifier">addUtxoSpentReq</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoSpent"><span class="hs-identifier">waitForUtxoSpent</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoProducedReq"><span class="hs-identifier">addUtxoProducedReq</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoProduced"><span class="hs-identifier">waitForUtxoProduced</span></a></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#setActivity"><span class="hs-identifier">setActivity</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#setObservableState"><span class="hs-identifier">setObservableState</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#openEndpoints"><span class="hs-identifier">openEndpoints</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpoint"><span class="hs-identifier">callEndpoint</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#finalResult"><span class="hs-identifier">finalResult</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Activity"><span class="hs-identifier">Activity</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><span class="hs-comment">-- * State of all running contract instances</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier">InstancesState</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstancesState"><span class="hs-identifier">emptyInstancesState</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#insertInstance"><span class="hs-identifier">insertInstance</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#removeInstance"><span class="hs-identifier">removeInstance</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance"><span class="hs-identifier">callEndpointOnInstance</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstanceTimeout"><span class="hs-identifier">callEndpointOnInstanceTimeout</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#observableContractState"><span class="hs-identifier">observableContractState</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#yieldedExportTxs"><span class="hs-identifier">yieldedExportTxs</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceState"><span class="hs-identifier">instanceState</span></a></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceIDs"><span class="hs-identifier">instanceIDs</span></a></span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instancesWithStatuses"><span class="hs-identifier">instancesWithStatuses</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instancesClientEnv"><span class="hs-identifier">instancesClientEnv</span></a></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier">InstanceClientEnv</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">Cardano.Node.Emulator.Params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">Params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">pSlotConfig</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">Cardano.Node.Emulator.TimeSlot</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TimeSlot</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Applicative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Alternative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">empty</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">STM</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier">TMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">TVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier">Control.Concurrent.STM</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">STM</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">guard</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">Value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">fold</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">IORef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.IORef</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IORef</span></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.List.NonEmpty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">NonEmpty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Map</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Map</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier">Set</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">CardanoAddress</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Slot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">TxId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">TxOutRef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ledger.Time</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">POSIXTime</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">Plutus.ChainIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">BlockNumber</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">BlockNumber</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">ChainIndexTx</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">TxIdState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">TxOutBalance</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">TxOutStatus</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">TxStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>                          </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">transactionStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">Plutus.ChainIndex.TxOutBalance</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">transactionOutputStatus</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">Plutus.ChainIndex.UtxoState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">UtxoIndex</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">UtxoState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">_usTxUtxoData</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier">utxoState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Effects</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">ActiveEndpoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">ActiveEndpoint</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">aeDescription</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Resumable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">IterationID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Request</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Request</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">itID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">rqID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">rqRequest</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">RequestID</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Wallet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">ExportTx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html"><span class="hs-identifier">Plutus.PAB.Core.Indexer.TxConfirmationStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier">TCSIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Wallet.Types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">ContractInstanceId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">EndpointDescription</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">EndpointValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">EndpointValue</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>                     </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">NotificationError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">EndpointNotAvailable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">InstanceDoesNotExist</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">MoreThanOneEndpointAvailable</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Wallet.Types</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Wallet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">ContractActivityStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Active</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Done</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Stopped</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">{- Note [Contract instance thread model]

In the PAB we run each contract instance in its own thread, following the
design principles for concurrency described in [1].

As a result
* We use STM for concurrency
* We try to avoid queues and use TVars where possible

Contract instances can make requests to services that are managed by the PAB,
such as the wallet backend, the chain index and the node. From the contract's
POV we assume that these requests are responded to instantaneously. To handle
these requests the PAB uses the
'Wallet.Emulator.MultiAgent.EmulatedWalletEffects' list of effects.

In addition to making requests to PAB services, contract instances can wait for
events to happen. The events that can be waited upon are produced by the
blockchain (transactions added to the ledger, new slots starting) and by
external clients of the PAB including end-users (calling contract endpoints).
To handle this kind of waiting the PAB uses STM and the types defined in this
module.

# QoS

One of the main goals of the queueless STM design is to avoid a degradation
of the quality of service (QoS) when the system is operating at capacity. This
comes at a price: When the system is under pressure, some updates may be
dropped. In practice this a result of the behaviour of STM's 'retry' primitive,
which only guarantees to retry at some point (not immediately) after a variable
has changed. So if the variable changes again before the retry happens, the
intermediate state is not visible.

# Event types

What does this imply for the PAB? Rather than being notified of changes, we want
to be notified of new states. Therefore we choose the following types for the
events that we want to know about.

* Time: TVar with current time
* Modifications to an address: TVar with current UTXO set of that address
* Transactions &amp; rollbacks: TVar with current status of transactions
* Endpoints: For each endpoint a TMVar that changes from empty to full if &amp; when
  the endpoint gets called.

All other requests of the contract are handled using the wallet effects (chain index,
tx construction and signing).

[1] Keynote by Duncan Coutts at the Haskell Symposium 2020. https://vimeo.com/452222780.

-}</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- | An open endpoint that can be responded to.</span><span>
</span><span id="line-134"></span><span class="hs-keyword">data</span><span> </span><span id="OpenEndpoint"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-var">OpenEndpoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>        </span><span id="OpenEndpoint"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-var">OpenEndpoint</span></a></span></span><span>
</span><span id="line-136"></span><span>            </span><span class="hs-special">{</span><span> </span><span id="oepName"><span class="annot"><span class="annottext">OpenEndpoint -&gt; ActiveEndpoint
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#oepName"><span class="hs-identifier hs-var hs-var">oepName</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ActiveEndpoint</span></a></span><span> </span><span class="hs-comment">-- ^ Name of the endpoint</span><span>
</span><span id="line-137"></span><span>            </span><span class="hs-special">,</span><span> </span><span id="oepResponse"><span class="annot"><span class="annottext">OpenEndpoint -&gt; TMVar (EndpointValue Value)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#oepResponse"><span class="hs-identifier hs-var hs-var">oepResponse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">EndpointValue</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ A place to write the response to.</span><span>
</span><span id="line-138"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">-- | A TxOutRef that a contract instance is watching</span><span>
</span><span id="line-141"></span><span class="hs-keyword">data</span><span> </span><span id="OpenTxOutSpentRequest"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier hs-var">OpenTxOutSpentRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>    </span><span id="OpenTxOutSpentRequest"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier hs-var">OpenTxOutSpentRequest</span></a></span></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="osrOutRef"><span class="annot"><span class="annottext">OpenTxOutSpentRequest -&gt; TxOutRef
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#osrOutRef"><span class="hs-identifier hs-var hs-var">osrOutRef</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span> </span><span class="hs-comment">-- ^ The 'TxOutRef' that the instance is watching</span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="osrSpendingTx"><span class="annot"><span class="annottext">OpenTxOutSpentRequest -&gt; TMVar ChainIndexTx
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#osrSpendingTx"><span class="hs-identifier hs-var hs-var">osrSpendingTx</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">ChainIndexTx</span></a></span><span> </span><span class="hs-comment">-- ^ A place to write the spending transaction to</span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-keyword">data</span><span> </span><span id="OpenTxOutProducedRequest"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier hs-var">OpenTxOutProducedRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-148"></span><span>    </span><span id="OpenTxOutProducedRequest"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier hs-var">OpenTxOutProducedRequest</span></a></span></span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="otxAddress"><span class="annot"><span class="annottext">OpenTxOutProducedRequest -&gt; CardanoAddress
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#otxAddress"><span class="hs-identifier hs-var hs-var">otxAddress</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoAddress</span></a></span><span> </span><span class="hs-comment">-- ^ 'Address' that the contract instance is watching (TODO: Should be ViewAddress -- SCP-2628)</span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="otxProducingTxns"><span class="annot"><span class="annottext">OpenTxOutProducedRequest -&gt; TMVar (NonEmpty ChainIndexTx)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#otxProducingTxns"><span class="hs-identifier hs-var hs-var">otxProducingTxns</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">ChainIndexTx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ A place to write the producing transactions to</span><span>
</span><span id="line-151"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- | Data about the blockchain that contract instances</span><span>
</span><span id="line-154"></span><span class="hs-comment">--   may be interested in.</span><span>
</span><span id="line-155"></span><span class="hs-keyword">data</span><span> </span><span id="BlockchainEnv"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-var">BlockchainEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>    </span><span id="BlockchainEnv"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-var">BlockchainEnv</span></a></span></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="beRollbackHistory"><span class="annot"><span class="annottext">BlockchainEnv -&gt; Maybe Int
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beRollbackHistory"><span class="hs-identifier hs-var hs-var">beRollbackHistory</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-comment">-- ^ How much history do we retain in the environment. Zero signifies no trimming is done.</span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="beCurrentSlot"><span class="annot"><span class="annottext">BlockchainEnv -&gt; TVar Slot
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beCurrentSlot"><span class="hs-identifier hs-var hs-var">beCurrentSlot</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span class="hs-comment">-- ^ Actual current slot</span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="beLastSyncedBlockSlot"><span class="annot"><span class="annottext">BlockchainEnv -&gt; TVar Slot
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beLastSyncedBlockSlot"><span class="hs-identifier hs-var hs-var">beLastSyncedBlockSlot</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span class="hs-comment">-- ^ Slot of the last synced block from 'startNodeClient'</span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="beLastSyncedBlockNo"><span class="annot"><span class="annottext">BlockchainEnv -&gt; TVar BlockNumber
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beLastSyncedBlockNo"><span class="hs-identifier hs-var hs-var">beLastSyncedBlockNo</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">BlockNumber</span></a></span><span> </span><span class="hs-comment">-- ^ Last synced block number from 'startNodeClient'.</span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="beTxChanges"><span class="annot"><span class="annottext">BlockchainEnv
-&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beTxChanges"><span class="hs-identifier hs-var hs-var">beTxChanges</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">UtxoIndex</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">TxIdState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier hs-type">TCSIndex</span></a></span><span class="hs-special">)</span><span class="hs-comment">-- ^ Map holding metadata which determines the status of transactions.</span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="beTxOutChanges"><span class="annot"><span class="annottext">BlockchainEnv -&gt; TVar (UtxoIndex TxOutBalance)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beTxOutChanges"><span class="hs-identifier hs-var hs-var">beTxOutChanges</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">UtxoIndex</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">TxOutBalance</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Map holding metadata which determines the status of transaction outputs.</span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="beParams"><span class="annot"><span class="annottext">BlockchainEnv -&gt; Params
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#beParams"><span class="hs-identifier hs-var hs-var">beParams</span></a></span></span><span>              </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-type">Params</span></a></span><span> </span><span class="hs-comment">-- ^ The set of parameters, like protocol parameters and slot configuration.</span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#updateTxChangesR"><span class="hs-identifier hs-type">updateTxChangesR</span></a></span><span>
</span><span id="line-167"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">UtxoIndex</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">TxIdState</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier hs-type">TCSIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier hs-type">TCSIndex</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.Indexer.TxConfirmationStatus.html#TCSIndex"><span class="hs-identifier hs-type">TCSIndex</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span id="updateTxChangesR"><span class="annot"><span class="annottext">updateTxChangesR :: Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
-&gt; (TCSIndex -&gt; IO TCSIndex) -&gt; IO ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#updateTxChangesR"><span class="hs-identifier hs-var hs-var">updateTxChangesR</span></a></span></span><span> </span><span id="local-6989586621680383498"><span class="annot"><span class="annottext">Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="#local-6989586621680383498"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621680383497"><span class="annot"><span class="annottext">TCSIndex -&gt; IO TCSIndex
</span><a href="#local-6989586621680383497"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="#local-6989586621680383498"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-172"></span><span>      </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span>  </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
</span><span class="hs-identifier">_</span></span><span>     </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; IO ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680383496"><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680383496"><span class="hs-identifier hs-var">ixRef</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex -&gt; IO TCSIndex
forall a. IORef a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680383496"><span class="hs-identifier hs-var">ixRef</span></a></span><span> </span><span class="annot"><span class="annottext">IO TCSIndex -&gt; (TCSIndex -&gt; IO TCSIndex) -&gt; IO TCSIndex
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">TCSIndex -&gt; IO TCSIndex
</span><a href="#local-6989586621680383497"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">IO TCSIndex -&gt; (TCSIndex -&gt; IO ()) -&gt; IO ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex -&gt; TCSIndex -&gt; IO ()
forall a. IORef a -&gt; a -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.writeIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><a href="#local-6989586621680383496"><span class="hs-identifier hs-var">ixRef</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">-- | Initialise an empty 'BlockchainEnv' value</span><span>
</span><span id="line-176"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyBlockchainEnv"><span class="hs-identifier hs-type">emptyBlockchainEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-type">Params</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span>
</span><span id="line-177"></span><span id="emptyBlockchainEnv"><span class="annot"><span class="annottext">emptyBlockchainEnv :: Maybe Int -&gt; Params -&gt; STM BlockchainEnv
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyBlockchainEnv"><span class="hs-identifier hs-var hs-var">emptyBlockchainEnv</span></a></span></span><span> </span><span id="local-6989586621680383493"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621680383493"><span class="hs-identifier hs-var">rollbackHistory</span></a></span></span><span> </span><span id="local-6989586621680383492"><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680383492"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><span class="annottext">Maybe Int
-&gt; TVar Slot
-&gt; TVar Slot
-&gt; TVar BlockNumber
-&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
-&gt; TVar (UtxoIndex TxOutBalance)
-&gt; Params
-&gt; BlockchainEnv
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-var">BlockchainEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621680383493"><span class="hs-identifier hs-var">rollbackHistory</span></a></span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">(TVar Slot
 -&gt; TVar Slot
 -&gt; TVar BlockNumber
 -&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
 -&gt; TVar (UtxoIndex TxOutBalance)
 -&gt; Params
 -&gt; BlockchainEnv)
-&gt; STM (TVar Slot)
-&gt; STM
     (TVar Slot
      -&gt; TVar BlockNumber
      -&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
      -&gt; TVar (UtxoIndex TxOutBalance)
      -&gt; Params
      -&gt; BlockchainEnv)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; STM (TVar Slot)
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><span class="hs-number">0</span></span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">STM
  (TVar Slot
   -&gt; TVar BlockNumber
   -&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
   -&gt; TVar (UtxoIndex TxOutBalance)
   -&gt; Params
   -&gt; BlockchainEnv)
-&gt; STM (TVar Slot)
-&gt; STM
     (TVar BlockNumber
      -&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
      -&gt; TVar (UtxoIndex TxOutBalance)
      -&gt; Params
      -&gt; BlockchainEnv)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; STM (TVar Slot)
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><span class="hs-number">0</span></span><span>
</span><span id="line-181"></span><span>        </span><span class="annot"><span class="annottext">STM
  (TVar BlockNumber
   -&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
   -&gt; TVar (UtxoIndex TxOutBalance)
   -&gt; Params
   -&gt; BlockchainEnv)
-&gt; STM (TVar BlockNumber)
-&gt; STM
     (Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
      -&gt; TVar (UtxoIndex TxOutBalance) -&gt; Params -&gt; BlockchainEnv)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNumber -&gt; STM (TVar BlockNumber)
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; BlockNumber
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">BlockNumber</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><span class="annottext">STM
  (Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
   -&gt; TVar (UtxoIndex TxOutBalance) -&gt; Params -&gt; BlockchainEnv)
-&gt; STM (Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex))
-&gt; STM (TVar (UtxoIndex TxOutBalance) -&gt; Params -&gt; BlockchainEnv)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
-&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar (UtxoIndex TxIdState)
 -&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex))
-&gt; STM (TVar (UtxoIndex TxIdState))
-&gt; STM (Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxIdState -&gt; STM (TVar (UtxoIndex TxIdState))
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxIdState
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>        </span><span class="annot"><span class="annottext">STM (TVar (UtxoIndex TxOutBalance) -&gt; Params -&gt; BlockchainEnv)
-&gt; STM (TVar (UtxoIndex TxOutBalance))
-&gt; STM (Params -&gt; BlockchainEnv)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxOutBalance -&gt; STM (TVar (UtxoIndex TxOutBalance))
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxOutBalance
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-184"></span><span>        </span><span class="annot"><span class="annottext">STM (Params -&gt; BlockchainEnv) -&gt; STM Params -&gt; STM BlockchainEnv
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Params -&gt; STM Params
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680383492"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span class="hs-comment">-- | Wait until the current slot is greater than or equal to the</span><span>
</span><span id="line-187"></span><span class="hs-comment">--   target slot, then return the current slot.</span><span>
</span><span id="line-188"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitSlot"><span class="hs-identifier hs-type">awaitSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span>
</span><span id="line-189"></span><span id="awaitSlot"><span class="annot"><span class="annottext">awaitSlot :: Slot -&gt; BlockchainEnv -&gt; STM Slot
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitSlot"><span class="hs-identifier hs-var hs-var">awaitSlot</span></a></span></span><span> </span><span id="local-6989586621680383489"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680383489"><span class="hs-identifier hs-var">targetSlot</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383488"><span class="annot"><span class="annottext">TVar Slot
beCurrentSlot :: TVar Slot
beCurrentSlot :: BlockchainEnv -&gt; TVar Slot
</span><a href="#local-6989586621680383488"><span class="hs-identifier hs-var hs-var">beCurrentSlot</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-190"></span><span>    </span><span id="local-6989586621680383487"><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680383487"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Slot -&gt; STM Slot
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Slot
</span><a href="#local-6989586621680383488"><span class="hs-identifier hs-var">beCurrentSlot</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; STM ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">guard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680383487"><span class="hs-identifier hs-var">current</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; Slot -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680383489"><span class="hs-identifier hs-var">targetSlot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>    </span><span class="annot"><span class="annottext">Slot -&gt; STM Slot
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680383487"><span class="hs-identifier hs-var">current</span></a></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="hs-comment">-- | Wait until the current time is greater than or equal to the</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- target time, then return the current time.</span><span>
</span><span id="line-196"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitTime"><span class="hs-identifier hs-type">awaitTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span>
</span><span id="line-197"></span><span id="awaitTime"><span class="annot"><span class="annottext">awaitTime :: POSIXTime -&gt; BlockchainEnv -&gt; STM POSIXTime
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitTime"><span class="hs-identifier hs-var hs-var">awaitTime</span></a></span></span><span> </span><span id="local-6989586621680383485"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680383485"><span class="hs-identifier hs-var">targetTime</span></a></span></span><span> </span><span id="local-6989586621680383484"><span class="annot"><span class="annottext">be :: BlockchainEnv
</span><a href="#local-6989586621680383484"><span class="hs-identifier hs-var">be</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383483"><span class="annot"><span class="annottext">Params
beParams :: Params
beParams :: BlockchainEnv -&gt; Params
</span><a href="#local-6989586621680383483"><span class="hs-identifier hs-var hs-var">beParams</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-198"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383482"><span class="annot"><span class="annottext">slotConfig :: SlotConfig
</span><a href="#local-6989586621680383482"><span class="hs-identifier hs-var hs-var">slotConfig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Params -&gt; SlotConfig
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var hs-var">pSlotConfig</span></a></span><span> </span><span class="annot"><span class="annottext">Params
</span><a href="#local-6989586621680383483"><span class="hs-identifier hs-var">beParams</span></a></span><span>
</span><span id="line-199"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383481"><span class="annot"><span class="annottext">targetSlot :: Slot
</span><a href="#local-6989586621680383481"><span class="hs-identifier hs-var hs-var">targetSlot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SlotConfig -&gt; POSIXTime -&gt; Slot
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var">TimeSlot.posixTimeToEnclosingSlot</span></a></span><span> </span><span class="annot"><span class="annottext">SlotConfig
</span><a href="#local-6989586621680383482"><span class="hs-identifier hs-var">slotConfig</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680383485"><span class="hs-identifier hs-var">targetTime</span></a></span><span>
</span><span id="line-200"></span><span>    </span><span class="annot"><span class="annottext">SlotConfig -&gt; Slot -&gt; POSIXTime
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var">TimeSlot.slotToEndPOSIXTime</span></a></span><span> </span><span class="annot"><span class="annottext">SlotConfig
</span><a href="#local-6989586621680383482"><span class="hs-identifier hs-var">slotConfig</span></a></span><span> </span><span class="annot"><span class="annottext">(Slot -&gt; POSIXTime) -&gt; STM Slot -&gt; STM POSIXTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Slot -&gt; BlockchainEnv -&gt; STM Slot
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitSlot"><span class="hs-identifier hs-var">awaitSlot</span></a></span><span> </span><span class="annot"><span class="annottext">Slot
</span><a href="#local-6989586621680383481"><span class="hs-identifier hs-var">targetSlot</span></a></span><span> </span><span class="annot"><span class="annottext">BlockchainEnv
</span><a href="#local-6989586621680383484"><span class="hs-identifier hs-var">be</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span class="hs-comment">-- | Wait for an endpoint response.</span><span>
</span><span id="line-203"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitEndpointResponse"><span class="hs-identifier hs-type">awaitEndpointResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ActiveEndpoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">EndpointValue</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span id="awaitEndpointResponse"><span class="annot"><span class="annottext">awaitEndpointResponse :: Request ActiveEndpoint
-&gt; InstanceState -&gt; STM (EndpointValue Value)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#awaitEndpointResponse"><span class="hs-identifier hs-var hs-var">awaitEndpointResponse</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383478"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680383478"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383477"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680383477"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383475"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
issEndpoints :: InstanceState -&gt; TVar (Map (RequestID, IterationID) OpenEndpoint)
issEndpoints :: TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issEndpoints"><span class="hs-identifier hs-var hs-var">issEndpoints</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621680383473"><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
</span><a href="#local-6989586621680383473"><span class="hs-identifier hs-var">currentEndpoints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
-&gt; STM (Map (RequestID, IterationID) OpenEndpoint)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="#local-6989586621680383475"><span class="hs-identifier hs-var">issEndpoints</span></a></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383472"><span class="annot"><span class="annottext">openEndpoint :: Maybe OpenEndpoint
</span><a href="#local-6989586621680383472"><span class="hs-identifier hs-var hs-var">openEndpoint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RequestID, IterationID)
-&gt; Map (RequestID, IterationID) OpenEndpoint -&gt; Maybe OpenEndpoint
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680383478"><span class="hs-identifier hs-var">rqID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680383477"><span class="hs-identifier hs-var">itID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
</span><a href="#local-6989586621680383473"><span class="hs-identifier hs-var">currentEndpoints</span></a></span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe OpenEndpoint
</span><a href="#local-6989586621680383472"><span class="hs-identifier hs-var">openEndpoint</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-208"></span><span>        </span><span class="annot"><span class="annottext">Maybe OpenEndpoint
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (EndpointValue Value)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-209"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-type">OpenEndpoint</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383470"><span class="annot"><span class="annottext">TMVar (EndpointValue Value)
oepResponse :: TMVar (EndpointValue Value)
oepResponse :: OpenEndpoint -&gt; TMVar (EndpointValue Value)
</span><a href="#local-6989586621680383470"><span class="hs-identifier hs-var hs-var">oepResponse</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TMVar (EndpointValue Value) -&gt; STM (EndpointValue Value)
forall a. TMVar a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.readTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar (EndpointValue Value)
</span><a href="#local-6989586621680383470"><span class="hs-identifier hs-var">oepResponse</span></a></span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-comment">-- | Whether the contract instance is still waiting for an event.</span><span>
</span><span id="line-212"></span><span class="hs-keyword">data</span><span> </span><span id="Activity"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Activity"><span class="hs-identifier hs-var">Activity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-213"></span><span>        </span><span id="Active"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Active"><span class="hs-identifier hs-var">Active</span></a></span></span><span>
</span><span id="line-214"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span id="Stopped"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Stopped"><span class="hs-identifier hs-var">Stopped</span></a></span></span><span> </span><span class="hs-comment">-- ^ Instance was stopped before all requests were handled</span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span id="Done"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Done"><span class="hs-identifier hs-var">Done</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Instance finished, possibly with an error</span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680383462"><span id="local-6989586621680383464"><span class="annot"><span class="annottext">Activity -&gt; Activity -&gt; Bool
(Activity -&gt; Activity -&gt; Bool)
-&gt; (Activity -&gt; Activity -&gt; Bool) -&gt; Eq Activity
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Activity -&gt; Activity -&gt; Bool
$c/= :: Activity -&gt; Activity -&gt; Bool
== :: Activity -&gt; Activity -&gt; Bool
$c== :: Activity -&gt; Activity -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383455"><span id="local-6989586621680383457"><span id="local-6989586621680383459"><span class="annot"><span class="annottext">Int -&gt; Activity -&gt; ShowS
[Activity] -&gt; ShowS
Activity -&gt; String
(Int -&gt; Activity -&gt; ShowS)
-&gt; (Activity -&gt; String) -&gt; ([Activity] -&gt; ShowS) -&gt; Show Activity
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Activity] -&gt; ShowS
$cshowList :: [Activity] -&gt; ShowS
show :: Activity -&gt; String
$cshow :: Activity -&gt; String
showsPrec :: Int -&gt; Activity -&gt; ShowS
$cshowsPrec :: Int -&gt; Activity -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- | The state of an active contract instance.</span><span>
</span><span id="line-219"></span><span class="hs-keyword">data</span><span> </span><span id="InstanceState"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-var">InstanceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>    </span><span id="InstanceState"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-var">InstanceState</span></a></span></span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="issEndpoints"><span class="annot"><span class="annottext">InstanceState -&gt; TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issEndpoints"><span class="hs-identifier hs-var hs-var">issEndpoints</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">IterationID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-type">OpenEndpoint</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Open endpoints that can be responded to.</span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="issStatus"><span class="annot"><span class="annottext">InstanceState -&gt; TVar Activity
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issStatus"><span class="hs-identifier hs-var hs-var">issStatus</span></a></span></span><span>           </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Activity"><span class="hs-identifier hs-type">Activity</span></a></span><span> </span><span class="hs-comment">-- ^ Whether the instance is still running.</span><span>
</span><span id="line-223"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="issObservableState"><span class="annot"><span class="annottext">InstanceState -&gt; TVar (Maybe Value)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issObservableState"><span class="hs-identifier hs-var hs-var">issObservableState</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Serialised observable state of the contract instance (if available)</span><span>
</span><span id="line-224"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="issStop"><span class="annot"><span class="annottext">InstanceState -&gt; TMVar ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issStop"><span class="hs-identifier hs-var hs-var">issStop</span></a></span></span><span>             </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ Stop the instance if a value is written into the TMVar.</span><span>
</span><span id="line-225"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="issTxOutRefs"><span class="annot"><span class="annottext">InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issTxOutRefs"><span class="hs-identifier hs-var hs-var">issTxOutRefs</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">IterationID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier hs-type">OpenTxOutSpentRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="issAddressRefs"><span class="annot"><span class="annottext">InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issAddressRefs"><span class="hs-identifier hs-var hs-var">issAddressRefs</span></a></span></span><span>      </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">IterationID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier hs-type">OpenTxOutProducedRequest</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="issYieldedExportTxs"><span class="annot"><span class="annottext">InstanceState -&gt; TVar [ExportTx]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issYieldedExportTxs"><span class="hs-identifier hs-var hs-var">issYieldedExportTxs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">TVar</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ExportTx</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- ^ Partial tx that needs to be balanced, signed and submitted by an external agent.</span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- | An 'InstanceState' value with empty fields</span><span>
</span><span id="line-231"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstanceState"><span class="hs-identifier hs-type">emptyInstanceState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span>
</span><span id="line-232"></span><span id="emptyInstanceState"><span class="annot"><span class="annottext">emptyInstanceState :: STM InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstanceState"><span class="hs-identifier hs-var hs-var">emptyInstanceState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
-&gt; TVar Activity
-&gt; TVar (Maybe Value)
-&gt; TMVar ()
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
-&gt; TVar [ExportTx]
-&gt; InstanceState
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-var">InstanceState</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">(TVar (Map (RequestID, IterationID) OpenEndpoint)
 -&gt; TVar Activity
 -&gt; TVar (Maybe Value)
 -&gt; TMVar ()
 -&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
 -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
 -&gt; TVar [ExportTx]
 -&gt; InstanceState)
-&gt; STM (TVar (Map (RequestID, IterationID) OpenEndpoint))
-&gt; STM
     (TVar Activity
      -&gt; TVar (Maybe Value)
      -&gt; TMVar ()
      -&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
      -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
      -&gt; TVar [ExportTx]
      -&gt; InstanceState)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
-&gt; STM (TVar (Map (RequestID, IterationID) OpenEndpoint))
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">STM
  (TVar Activity
   -&gt; TVar (Maybe Value)
   -&gt; TMVar ()
   -&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
   -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
   -&gt; TVar [ExportTx]
   -&gt; InstanceState)
-&gt; STM (TVar Activity)
-&gt; STM
     (TVar (Maybe Value)
      -&gt; TMVar ()
      -&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
      -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
      -&gt; TVar [ExportTx]
      -&gt; InstanceState)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Activity -&gt; STM (TVar Activity)
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Activity
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#Active"><span class="hs-identifier hs-var">Active</span></a></span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">STM
  (TVar (Maybe Value)
   -&gt; TMVar ()
   -&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
   -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
   -&gt; TVar [ExportTx]
   -&gt; InstanceState)
-&gt; STM (TVar (Maybe Value))
-&gt; STM
     (TMVar ()
      -&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
      -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
      -&gt; TVar [ExportTx]
      -&gt; InstanceState)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; STM (TVar (Maybe Value))
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-237"></span><span>        </span><span class="annot"><span class="annottext">STM
  (TMVar ()
   -&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
   -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
   -&gt; TVar [ExportTx]
   -&gt; InstanceState)
-&gt; STM (TMVar ())
-&gt; STM
     (TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
      -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
      -&gt; TVar [ExportTx]
      -&gt; InstanceState)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TMVar ())
forall a. STM (TMVar a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.newEmptyTMVar</span></a></span><span>
</span><span id="line-238"></span><span>        </span><span class="annot"><span class="annottext">STM
  (TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
   -&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
   -&gt; TVar [ExportTx]
   -&gt; InstanceState)
-&gt; STM (TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest))
-&gt; STM
     (TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
      -&gt; TVar [ExportTx] -&gt; InstanceState)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutSpentRequest
-&gt; STM (TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest))
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutSpentRequest
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-239"></span><span>        </span><span class="annot"><span class="annottext">STM
  (TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
   -&gt; TVar [ExportTx] -&gt; InstanceState)
-&gt; STM
     (TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest))
-&gt; STM (TVar [ExportTx] -&gt; InstanceState)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutProducedRequest
-&gt; STM
     (TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest))
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutProducedRequest
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span class="annot"><span class="annottext">STM (TVar [ExportTx] -&gt; InstanceState)
-&gt; STM (TVar [ExportTx]) -&gt; STM InstanceState
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[ExportTx] -&gt; STM (TVar [ExportTx])
forall a. a -&gt; STM (TVar a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.newTVar</span></a></span><span> </span><span class="annot"><span class="annottext">[ExportTx]
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span class="hs-comment">-- | Events that the contract instances are waiting for, indexed by keys that are</span><span>
</span><span id="line-243"></span><span class="hs-comment">--   readily available in the node client (ie. that can be produced from just a</span><span>
</span><span id="line-244"></span><span class="hs-comment">--   block without any additional information)</span><span>
</span><span id="line-245"></span><span class="hs-keyword">data</span><span> </span><span id="InstanceClientEnv"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-var">InstanceClientEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InstanceClientEnv"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-var">InstanceClientEnv</span></a></span></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ceUtxoSpentRequests"><span class="annot"><span class="annottext">InstanceClientEnv -&gt; Map TxOutRef [OpenTxOutSpentRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoSpentRequests"><span class="hs-identifier hs-var hs-var">ceUtxoSpentRequests</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier hs-type">OpenTxOutSpentRequest</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="ceUtxoProducedRequests"><span class="annot"><span class="annottext">InstanceClientEnv -&gt; Map CardanoAddress [OpenTxOutProducedRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoProducedRequests"><span class="hs-identifier hs-var hs-var">ceUtxoProducedRequests</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoAddress</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier hs-type">OpenTxOutProducedRequest</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- TODO: ViewAddress</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680383439"><span id="local-6989586621680383441"><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Semigroup</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-type">InstanceClientEnv</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-251"></span><span>    </span><span id="local-6989586621680383437"><span class="annot"><span class="annottext">InstanceClientEnv
</span><a href="#local-6989586621680383437"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621680383436"><span class="annot"><span class="annottext">&lt;&gt; :: InstanceClientEnv -&gt; InstanceClientEnv -&gt; InstanceClientEnv
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></a></span></span><span> </span><span id="local-6989586621680383435"><span class="annot"><span class="annottext">InstanceClientEnv
</span><a href="#local-6989586621680383435"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-252"></span><span>        </span><span class="annot"><span class="annottext">InstanceClientEnv :: Map TxOutRef [OpenTxOutSpentRequest]
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
-&gt; InstanceClientEnv
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-type">InstanceClientEnv</span></a></span><span>
</span><span id="line-253"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ceUtxoProducedRequests :: Map CardanoAddress [OpenTxOutProducedRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoProducedRequests"><span class="hs-identifier hs-var">ceUtxoProducedRequests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([OpenTxOutProducedRequest]
 -&gt; [OpenTxOutProducedRequest] -&gt; [OpenTxOutProducedRequest])
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">[OpenTxOutProducedRequest]
-&gt; [OpenTxOutProducedRequest] -&gt; [OpenTxOutProducedRequest]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceClientEnv -&gt; Map CardanoAddress [OpenTxOutProducedRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoProducedRequests"><span class="hs-identifier hs-var hs-var">ceUtxoProducedRequests</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceClientEnv
</span><a href="#local-6989586621680383437"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceClientEnv -&gt; Map CardanoAddress [OpenTxOutProducedRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoProducedRequests"><span class="hs-identifier hs-var hs-var">ceUtxoProducedRequests</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceClientEnv
</span><a href="#local-6989586621680383435"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ceUtxoSpentRequests :: Map TxOutRef [OpenTxOutSpentRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoSpentRequests"><span class="hs-identifier hs-var">ceUtxoSpentRequests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([OpenTxOutSpentRequest]
 -&gt; [OpenTxOutSpentRequest] -&gt; [OpenTxOutSpentRequest])
-&gt; Map TxOutRef [OpenTxOutSpentRequest]
-&gt; Map TxOutRef [OpenTxOutSpentRequest]
-&gt; Map TxOutRef [OpenTxOutSpentRequest]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.unionWith</span></a></span><span> </span><span class="annot"><span class="annottext">[OpenTxOutSpentRequest]
-&gt; [OpenTxOutSpentRequest] -&gt; [OpenTxOutSpentRequest]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceClientEnv -&gt; Map TxOutRef [OpenTxOutSpentRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoSpentRequests"><span class="hs-identifier hs-var hs-var">ceUtxoSpentRequests</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceClientEnv
</span><a href="#local-6989586621680383437"><span class="hs-identifier hs-var">l</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">InstanceClientEnv -&gt; Map TxOutRef [OpenTxOutSpentRequest]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#ceUtxoSpentRequests"><span class="hs-identifier hs-var hs-var">ceUtxoSpentRequests</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceClientEnv
</span><a href="#local-6989586621680383435"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680383429"><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Monoid</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-type">InstanceClientEnv</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621680383427"><span class="annot"><span class="annottext">mappend :: InstanceClientEnv -&gt; InstanceClientEnv -&gt; InstanceClientEnv
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">mappend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">InstanceClientEnv -&gt; InstanceClientEnv -&gt; InstanceClientEnv
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">(&lt;&gt;)</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621680383426"><span class="annot"><span class="annottext">mempty :: InstanceClientEnv
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TxOutRef [OpenTxOutSpentRequest]
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
-&gt; InstanceClientEnv
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-var">InstanceClientEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef [OpenTxOutSpentRequest]
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">Map CardanoAddress [OpenTxOutProducedRequest]
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instancesClientEnv"><span class="hs-identifier hs-type">instancesClientEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-type">InstanceClientEnv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-262"></span><span id="instancesClientEnv"><span class="annot"><span class="annottext">instancesClientEnv :: InstancesState -&gt; IO (STM InstanceClientEnv)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#instancesClientEnv"><span class="hs-identifier hs-var hs-var">instancesClientEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Map ContractInstanceId InstanceState -&gt; STM InstanceClientEnv)
-&gt; IO (Map ContractInstanceId InstanceState)
-&gt; IO (STM InstanceClientEnv)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Map ContractInstanceId InstanceClientEnv -&gt; InstanceClientEnv)
-&gt; STM (Map ContractInstanceId InstanceClientEnv)
-&gt; STM InstanceClientEnv
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Map ContractInstanceId InstanceClientEnv -&gt; InstanceClientEnv
forall (t :: * -&gt; *) m. (Foldable t, Monoid m) =&gt; t m -&gt; m
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fold</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (Map ContractInstanceId InstanceClientEnv)
 -&gt; STM InstanceClientEnv)
-&gt; (Map ContractInstanceId InstanceState
    -&gt; STM (Map ContractInstanceId InstanceClientEnv))
-&gt; Map ContractInstanceId InstanceState
-&gt; STM InstanceClientEnv
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(InstanceState -&gt; STM InstanceClientEnv)
-&gt; Map ContractInstanceId InstanceState
-&gt; STM (Map ContractInstanceId InstanceClientEnv)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState -&gt; STM InstanceClientEnv
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceClientEnv"><span class="hs-identifier hs-var">instanceClientEnv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(IO (Map ContractInstanceId InstanceState)
 -&gt; IO (STM InstanceClientEnv))
-&gt; (InstancesState -&gt; IO (Map ContractInstanceId InstanceState))
-&gt; InstancesState
-&gt; IO (STM InstanceClientEnv)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
-&gt; IO (Map ContractInstanceId InstanceState)
forall a. IORef a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">(IORef (Map ContractInstanceId InstanceState)
 -&gt; IO (Map ContractInstanceId InstanceState))
-&gt; (InstancesState -&gt; IORef (Map ContractInstanceId InstanceState))
-&gt; InstancesState
-&gt; IO (Map ContractInstanceId InstanceState)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InstancesState -&gt; IORef (Map ContractInstanceId InstanceState)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#getInstancesState"><span class="hs-identifier hs-var hs-var">getInstancesState</span></a></span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceClientEnv"><span class="hs-identifier hs-type">instanceClientEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-type">InstanceClientEnv</span></a></span><span>
</span><span id="line-265"></span><span id="instanceClientEnv"><span class="annot"><span class="annottext">instanceClientEnv :: InstanceState -&gt; STM InstanceClientEnv
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceClientEnv"><span class="hs-identifier hs-var hs-var">instanceClientEnv</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383421"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383421"><span class="hs-identifier hs-var hs-var">issTxOutRefs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383420"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383420"><span class="hs-identifier hs-var hs-var">issAddressRefs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-266"></span><span>  </span><span class="annot"><span class="annottext">Map TxOutRef [OpenTxOutSpentRequest]
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
-&gt; InstanceClientEnv
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceClientEnv"><span class="hs-identifier hs-var">InstanceClientEnv</span></a></span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="annottext">(Map TxOutRef [OpenTxOutSpentRequest]
 -&gt; Map CardanoAddress [OpenTxOutProducedRequest]
 -&gt; InstanceClientEnv)
-&gt; STM (Map TxOutRef [OpenTxOutSpentRequest])
-&gt; STM
     (Map CardanoAddress [OpenTxOutProducedRequest]
      -&gt; InstanceClientEnv)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TxOutRef, [OpenTxOutSpentRequest])]
-&gt; Map TxOutRef [OpenTxOutSpentRequest]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(TxOutRef, [OpenTxOutSpentRequest])]
 -&gt; Map TxOutRef [OpenTxOutSpentRequest])
-&gt; (Map (RequestID, IterationID) OpenTxOutSpentRequest
    -&gt; [(TxOutRef, [OpenTxOutSpentRequest])])
-&gt; Map (RequestID, IterationID) OpenTxOutSpentRequest
-&gt; Map TxOutRef [OpenTxOutSpentRequest]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(((RequestID, IterationID), OpenTxOutSpentRequest)
 -&gt; (TxOutRef, [OpenTxOutSpentRequest]))
-&gt; [((RequestID, IterationID), OpenTxOutSpentRequest)]
-&gt; [(TxOutRef, [OpenTxOutSpentRequest])]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680383418"><span class="annot"><span class="annottext">r :: OpenTxOutSpentRequest
</span><a href="#local-6989586621680383418"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier hs-type">OpenTxOutSpentRequest</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383417"><span class="annot"><span class="annottext">TxOutRef
osrOutRef :: TxOutRef
osrOutRef :: OpenTxOutSpentRequest -&gt; TxOutRef
</span><a href="#local-6989586621680383417"><span class="hs-identifier hs-var hs-var">osrOutRef</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680383417"><span class="hs-identifier hs-var">osrOutRef</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">OpenTxOutSpentRequest
</span><a href="#local-6989586621680383418"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OpenTxOutSpentRequest -&gt; (TxOutRef, [OpenTxOutSpentRequest]))
-&gt; (((RequestID, IterationID), OpenTxOutSpentRequest)
    -&gt; OpenTxOutSpentRequest)
-&gt; ((RequestID, IterationID), OpenTxOutSpentRequest)
-&gt; (TxOutRef, [OpenTxOutSpentRequest])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((RequestID, IterationID), OpenTxOutSpentRequest)
-&gt; OpenTxOutSpentRequest
forall a b. (a, b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([((RequestID, IterationID), OpenTxOutSpentRequest)]
 -&gt; [(TxOutRef, [OpenTxOutSpentRequest])])
-&gt; (Map (RequestID, IterationID) OpenTxOutSpentRequest
    -&gt; [((RequestID, IterationID), OpenTxOutSpentRequest)])
-&gt; Map (RequestID, IterationID) OpenTxOutSpentRequest
-&gt; [(TxOutRef, [OpenTxOutSpentRequest])]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutSpentRequest
-&gt; [((RequestID, IterationID), OpenTxOutSpentRequest)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">(Map (RequestID, IterationID) OpenTxOutSpentRequest
 -&gt; Map TxOutRef [OpenTxOutSpentRequest])
-&gt; STM (Map (RequestID, IterationID) OpenTxOutSpentRequest)
-&gt; STM (Map TxOutRef [OpenTxOutSpentRequest])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
-&gt; STM (Map (RequestID, IterationID) OpenTxOutSpentRequest)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383421"><span class="hs-identifier hs-var">issTxOutRefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>    </span><span class="annot"><span class="annottext">STM
  (Map CardanoAddress [OpenTxOutProducedRequest]
   -&gt; InstanceClientEnv)
-&gt; STM (Map CardanoAddress [OpenTxOutProducedRequest])
-&gt; STM InstanceClientEnv
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;*&gt;</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(CardanoAddress, [OpenTxOutProducedRequest])]
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.fromList</span></a></span><span> </span><span class="annot"><span class="annottext">([(CardanoAddress, [OpenTxOutProducedRequest])]
 -&gt; Map CardanoAddress [OpenTxOutProducedRequest])
-&gt; (Map (RequestID, IterationID) OpenTxOutProducedRequest
    -&gt; [(CardanoAddress, [OpenTxOutProducedRequest])])
-&gt; Map (RequestID, IterationID) OpenTxOutProducedRequest
-&gt; Map CardanoAddress [OpenTxOutProducedRequest]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(((RequestID, IterationID), OpenTxOutProducedRequest)
 -&gt; (CardanoAddress, [OpenTxOutProducedRequest]))
-&gt; [((RequestID, IterationID), OpenTxOutProducedRequest)]
-&gt; [(CardanoAddress, [OpenTxOutProducedRequest])]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680383415"><span class="annot"><span class="annottext">r :: OpenTxOutProducedRequest
</span><a href="#local-6989586621680383415"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier hs-type">OpenTxOutProducedRequest</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383414"><span class="annot"><span class="annottext">CardanoAddress
otxAddress :: CardanoAddress
otxAddress :: OpenTxOutProducedRequest -&gt; CardanoAddress
</span><a href="#local-6989586621680383414"><span class="hs-identifier hs-var hs-var">otxAddress</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621680383414"><span class="hs-identifier hs-var">otxAddress</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">OpenTxOutProducedRequest
</span><a href="#local-6989586621680383415"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OpenTxOutProducedRequest
 -&gt; (CardanoAddress, [OpenTxOutProducedRequest]))
-&gt; (((RequestID, IterationID), OpenTxOutProducedRequest)
    -&gt; OpenTxOutProducedRequest)
-&gt; ((RequestID, IterationID), OpenTxOutProducedRequest)
-&gt; (CardanoAddress, [OpenTxOutProducedRequest])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">((RequestID, IterationID), OpenTxOutProducedRequest)
-&gt; OpenTxOutProducedRequest
forall a b. (a, b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([((RequestID, IterationID), OpenTxOutProducedRequest)]
 -&gt; [(CardanoAddress, [OpenTxOutProducedRequest])])
-&gt; (Map (RequestID, IterationID) OpenTxOutProducedRequest
    -&gt; [((RequestID, IterationID), OpenTxOutProducedRequest)])
-&gt; Map (RequestID, IterationID) OpenTxOutProducedRequest
-&gt; [(CardanoAddress, [OpenTxOutProducedRequest])]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutProducedRequest
-&gt; [((RequestID, IterationID), OpenTxOutProducedRequest)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span>  </span><span class="annot"><span class="annottext">(Map (RequestID, IterationID) OpenTxOutProducedRequest
 -&gt; Map CardanoAddress [OpenTxOutProducedRequest])
-&gt; STM (Map (RequestID, IterationID) OpenTxOutProducedRequest)
-&gt; STM (Map CardanoAddress [OpenTxOutProducedRequest])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
-&gt; STM (Map (RequestID, IterationID) OpenTxOutProducedRequest)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383420"><span class="hs-identifier hs-var">issAddressRefs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="hs-comment">-- | Set the 'Activity' of the instance</span><span>
</span><span id="line-271"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#setActivity"><span class="hs-identifier hs-type">setActivity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Activity"><span class="hs-identifier hs-type">Activity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span id="setActivity"><span class="annot"><span class="annottext">setActivity :: Activity -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#setActivity"><span class="hs-identifier hs-var hs-var">setActivity</span></a></span></span><span> </span><span id="local-6989586621680383413"><span class="annot"><span class="annottext">Activity
</span><a href="#local-6989586621680383413"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383412"><span class="annot"><span class="annottext">TVar Activity
issStatus :: TVar Activity
issStatus :: InstanceState -&gt; TVar Activity
</span><a href="#local-6989586621680383412"><span class="hs-identifier hs-var hs-var">issStatus</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Activity -&gt; Activity -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Activity
</span><a href="#local-6989586621680383412"><span class="hs-identifier hs-var">issStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Activity
</span><a href="#local-6989586621680383413"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span class="hs-comment">-- | Empty the list of open enpoints that can be called on the instance</span><span>
</span><span id="line-275"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#clearEndpoints"><span class="hs-identifier hs-type">clearEndpoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span id="clearEndpoints"><span class="annot"><span class="annottext">clearEndpoints :: InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#clearEndpoints"><span class="hs-identifier hs-var hs-var">clearEndpoints</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383410"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
issEndpoints :: TVar (Map (RequestID, IterationID) OpenEndpoint)
issEndpoints :: InstanceState -&gt; TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="#local-6989586621680383410"><span class="hs-identifier hs-var hs-var">issEndpoints</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383409"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383409"><span class="hs-identifier hs-var hs-var">issTxOutRefs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383408"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383408"><span class="hs-identifier hs-var hs-var">issAddressRefs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
-&gt; Map (RequestID, IterationID) OpenEndpoint -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="#local-6989586621680383410"><span class="hs-identifier hs-var">issEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
forall k a. Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
-&gt; Map (RequestID, IterationID) OpenTxOutSpentRequest -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383409"><span class="hs-identifier hs-var">issTxOutRefs</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutSpentRequest
forall k a. Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-279"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
-&gt; Map (RequestID, IterationID) OpenTxOutProducedRequest -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383408"><span class="hs-identifier hs-var">issAddressRefs</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutProducedRequest
forall k a. Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.empty</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="hs-comment">-- | Add an active endpoint to the instance's list of active endpoints.</span><span>
</span><span id="line-282"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#addEndpoint"><span class="hs-identifier hs-type">addEndpoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ActiveEndpoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span id="addEndpoint"><span class="annot"><span class="annottext">addEndpoint :: Request ActiveEndpoint -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#addEndpoint"><span class="hs-identifier hs-var hs-var">addEndpoint</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383406"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680383406"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383405"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680383405"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383404"><span class="annot"><span class="annottext">ActiveEndpoint
rqRequest :: ActiveEndpoint
rqRequest :: forall o. Request o -&gt; o
</span><a href="#local-6989586621680383404"><span class="hs-identifier hs-var hs-var">rqRequest</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383403"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
issEndpoints :: TVar (Map (RequestID, IterationID) OpenEndpoint)
issEndpoints :: InstanceState -&gt; TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="#local-6989586621680383403"><span class="hs-identifier hs-var hs-var">issEndpoints</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621680383402"><span class="annot"><span class="annottext">OpenEndpoint
</span><a href="#local-6989586621680383402"><span class="hs-identifier hs-var">endpoint</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ActiveEndpoint -&gt; TMVar (EndpointValue Value) -&gt; OpenEndpoint
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-var">OpenEndpoint</span></a></span><span> </span><span class="annot"><span class="annottext">ActiveEndpoint
</span><a href="#local-6989586621680383404"><span class="hs-identifier hs-var">rqRequest</span></a></span><span> </span><span class="annot"><span class="annottext">(TMVar (EndpointValue Value) -&gt; OpenEndpoint)
-&gt; STM (TMVar (EndpointValue Value)) -&gt; STM OpenEndpoint
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TMVar (EndpointValue Value))
forall a. STM (TMVar a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.newEmptyTMVar</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
-&gt; (Map (RequestID, IterationID) OpenEndpoint
    -&gt; Map (RequestID, IterationID) OpenEndpoint)
-&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="#local-6989586621680383403"><span class="hs-identifier hs-var">issEndpoints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RequestID, IterationID)
-&gt; OpenEndpoint
-&gt; Map (RequestID, IterationID) OpenEndpoint
-&gt; Map (RequestID, IterationID) OpenEndpoint
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680383406"><span class="hs-identifier hs-var">rqID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680383405"><span class="hs-identifier hs-var">itID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OpenEndpoint
</span><a href="#local-6989586621680383402"><span class="hs-identifier hs-var">endpoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span class="hs-comment">-- | Add a new 'OpenTxOutSpentRequest' to the instance's list of</span><span>
</span><span id="line-288"></span><span class="hs-comment">--   utxo spent requests</span><span>
</span><span id="line-289"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoSpentReq"><span class="hs-identifier hs-type">addUtxoSpentReq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span id="addUtxoSpentReq"><span class="annot"><span class="annottext">addUtxoSpentReq :: Request TxOutRef -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoSpentReq"><span class="hs-identifier hs-var hs-var">addUtxoSpentReq</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383399"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680383399"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383398"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680383398"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383397"><span class="annot"><span class="annottext">TxOutRef
rqRequest :: TxOutRef
rqRequest :: forall o. Request o -&gt; o
</span><a href="#local-6989586621680383397"><span class="hs-identifier hs-var hs-var">rqRequest</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383396"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383396"><span class="hs-identifier hs-var hs-var">issTxOutRefs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621680383395"><span class="annot"><span class="annottext">OpenTxOutSpentRequest
</span><a href="#local-6989586621680383395"><span class="hs-identifier hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; TMVar ChainIndexTx -&gt; OpenTxOutSpentRequest
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier hs-var">OpenTxOutSpentRequest</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680383397"><span class="hs-identifier hs-var">rqRequest</span></a></span><span> </span><span class="annot"><span class="annottext">(TMVar ChainIndexTx -&gt; OpenTxOutSpentRequest)
-&gt; STM (TMVar ChainIndexTx) -&gt; STM OpenTxOutSpentRequest
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TMVar ChainIndexTx)
forall a. STM (TMVar a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.newEmptyTMVar</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
-&gt; (Map (RequestID, IterationID) OpenTxOutSpentRequest
    -&gt; Map (RequestID, IterationID) OpenTxOutSpentRequest)
-&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383396"><span class="hs-identifier hs-var">issTxOutRefs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RequestID, IterationID)
-&gt; OpenTxOutSpentRequest
-&gt; Map (RequestID, IterationID) OpenTxOutSpentRequest
-&gt; Map (RequestID, IterationID) OpenTxOutSpentRequest
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680383399"><span class="hs-identifier hs-var">rqID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680383398"><span class="hs-identifier hs-var">itID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OpenTxOutSpentRequest
</span><a href="#local-6989586621680383395"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>
</span><span id="line-294"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoSpent"><span class="hs-identifier hs-type">waitForUtxoSpent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">ChainIndexTx</span></a></span><span>
</span><span id="line-295"></span><span id="waitForUtxoSpent"><span class="annot"><span class="annottext">waitForUtxoSpent :: Request TxOutRef -&gt; InstanceState -&gt; STM ChainIndexTx
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoSpent"><span class="hs-identifier hs-var hs-var">waitForUtxoSpent</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383394"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680383394"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383393"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680383393"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383392"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
issTxOutRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383392"><span class="hs-identifier hs-var hs-var">issTxOutRefs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621680383391"><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutSpentRequest
</span><a href="#local-6989586621680383391"><span class="hs-identifier hs-var">theMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
-&gt; STM (Map (RequestID, IterationID) OpenTxOutSpentRequest)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutSpentRequest)
</span><a href="#local-6989586621680383392"><span class="hs-identifier hs-var">issTxOutRefs</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(RequestID, IterationID)
-&gt; Map (RequestID, IterationID) OpenTxOutSpentRequest
-&gt; Maybe OpenTxOutSpentRequest
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680383394"><span class="hs-identifier hs-var">rqID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680383393"><span class="hs-identifier hs-var">itID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutSpentRequest
</span><a href="#local-6989586621680383391"><span class="hs-identifier hs-var">theMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">Maybe OpenTxOutSpentRequest
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                                   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM ChainIndexTx
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-299"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutSpentRequest"><span class="hs-identifier hs-type">OpenTxOutSpentRequest</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383390"><span class="annot"><span class="annottext">TMVar ChainIndexTx
osrSpendingTx :: TMVar ChainIndexTx
osrSpendingTx :: OpenTxOutSpentRequest -&gt; TMVar ChainIndexTx
</span><a href="#local-6989586621680383390"><span class="hs-identifier hs-var hs-var">osrSpendingTx</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TMVar ChainIndexTx -&gt; STM ChainIndexTx
forall a. TMVar a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.readTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar ChainIndexTx
</span><a href="#local-6989586621680383390"><span class="hs-identifier hs-var">osrSpendingTx</span></a></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-comment">-- | Add a new 'OpenTxOutProducedRequest' to the instance's list of</span><span>
</span><span id="line-302"></span><span class="hs-comment">--   utxo produced requests</span><span>
</span><span id="line-303"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoProducedReq"><span class="hs-identifier hs-type">addUtxoProducedReq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoAddress</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span id="addUtxoProducedReq"><span class="annot"><span class="annottext">addUtxoProducedReq :: Request CardanoAddress -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#addUtxoProducedReq"><span class="hs-identifier hs-var hs-var">addUtxoProducedReq</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383389"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680383389"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383388"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680383388"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383387"><span class="annot"><span class="annottext">CardanoAddress
rqRequest :: CardanoAddress
rqRequest :: forall o. Request o -&gt; o
</span><a href="#local-6989586621680383387"><span class="hs-identifier hs-var hs-var">rqRequest</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383386"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383386"><span class="hs-identifier hs-var hs-var">issAddressRefs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621680383385"><span class="annot"><span class="annottext">OpenTxOutProducedRequest
</span><a href="#local-6989586621680383385"><span class="hs-identifier hs-var">request</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CardanoAddress
-&gt; TMVar (NonEmpty ChainIndexTx) -&gt; OpenTxOutProducedRequest
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier hs-var">OpenTxOutProducedRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621680383387"><span class="hs-identifier hs-var">rqRequest</span></a></span><span> </span><span class="annot"><span class="annottext">(TMVar (NonEmpty ChainIndexTx) -&gt; OpenTxOutProducedRequest)
-&gt; STM (TMVar (NonEmpty ChainIndexTx))
-&gt; STM OpenTxOutProducedRequest
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">STM (TMVar (NonEmpty ChainIndexTx))
forall a. STM (TMVar a)
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.newEmptyTMVar</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
-&gt; (Map (RequestID, IterationID) OpenTxOutProducedRequest
    -&gt; Map (RequestID, IterationID) OpenTxOutProducedRequest)
-&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.modifyTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383386"><span class="hs-identifier hs-var">issAddressRefs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(RequestID, IterationID)
-&gt; OpenTxOutProducedRequest
-&gt; Map (RequestID, IterationID) OpenTxOutProducedRequest
-&gt; Map (RequestID, IterationID) OpenTxOutProducedRequest
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680383389"><span class="hs-identifier hs-var">rqID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680383388"><span class="hs-identifier hs-var">itID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">OpenTxOutProducedRequest
</span><a href="#local-6989586621680383385"><span class="hs-identifier hs-var">request</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoProduced"><span class="hs-identifier hs-type">waitForUtxoProduced</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">CardanoAddress</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">NonEmpty</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">ChainIndexTx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-309"></span><span id="waitForUtxoProduced"><span class="annot"><span class="annottext">waitForUtxoProduced :: Request CardanoAddress
-&gt; InstanceState -&gt; STM (NonEmpty ChainIndexTx)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForUtxoProduced"><span class="hs-identifier hs-var hs-var">waitForUtxoProduced</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Request</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383384"><span class="annot"><span class="annottext">RequestID
rqID :: RequestID
rqID :: forall o. Request o -&gt; RequestID
</span><a href="#local-6989586621680383384"><span class="hs-identifier hs-var hs-var">rqID</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383383"><span class="annot"><span class="annottext">IterationID
itID :: IterationID
itID :: forall o. Request o -&gt; IterationID
</span><a href="#local-6989586621680383383"><span class="hs-identifier hs-var hs-var">itID</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383382"><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
issAddressRefs :: InstanceState
-&gt; TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383382"><span class="hs-identifier hs-var hs-var">issAddressRefs</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621680383381"><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutProducedRequest
</span><a href="#local-6989586621680383381"><span class="hs-identifier hs-var">theMap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
-&gt; STM (Map (RequestID, IterationID) OpenTxOutProducedRequest)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenTxOutProducedRequest)
</span><a href="#local-6989586621680383382"><span class="hs-identifier hs-var">issAddressRefs</span></a></span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(RequestID, IterationID)
-&gt; Map (RequestID, IterationID) OpenTxOutProducedRequest
-&gt; Maybe OpenTxOutProducedRequest
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestID
</span><a href="#local-6989586621680383384"><span class="hs-identifier hs-var">rqID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IterationID
</span><a href="#local-6989586621680383383"><span class="hs-identifier hs-var">itID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenTxOutProducedRequest
</span><a href="#local-6989586621680383381"><span class="hs-identifier hs-var">theMap</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-312"></span><span>        </span><span class="annot"><span class="annottext">Maybe OpenTxOutProducedRequest
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>                                         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (NonEmpty ChainIndexTx)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-313"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenTxOutProducedRequest"><span class="hs-identifier hs-type">OpenTxOutProducedRequest</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383380"><span class="annot"><span class="annottext">TMVar (NonEmpty ChainIndexTx)
otxProducingTxns :: TMVar (NonEmpty ChainIndexTx)
otxProducingTxns :: OpenTxOutProducedRequest -&gt; TMVar (NonEmpty ChainIndexTx)
</span><a href="#local-6989586621680383380"><span class="hs-identifier hs-var hs-var">otxProducingTxns</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TMVar (NonEmpty ChainIndexTx) -&gt; STM (NonEmpty ChainIndexTx)
forall a. TMVar a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.readTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar (NonEmpty ChainIndexTx)
</span><a href="#local-6989586621680383380"><span class="hs-identifier hs-var">otxProducingTxns</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">-- | Write a new value into the contract instance's observable state.</span><span>
</span><span id="line-316"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#setObservableState"><span class="hs-identifier hs-type">setObservableState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span id="setObservableState"><span class="annot"><span class="annottext">setObservableState :: Value -&gt; InstanceState -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#setObservableState"><span class="hs-identifier hs-var hs-var">setObservableState</span></a></span></span><span> </span><span id="local-6989586621680383379"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383379"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383378"><span class="annot"><span class="annottext">TVar (Maybe Value)
issObservableState :: TVar (Maybe Value)
issObservableState :: InstanceState -&gt; TVar (Maybe Value)
</span><a href="#local-6989586621680383378"><span class="hs-identifier hs-var hs-var">issObservableState</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>    </span><span class="annot"><span class="annottext">TVar (Maybe Value) -&gt; Maybe Value -&gt; STM ()
forall a. TVar a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.writeTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe Value)
</span><a href="#local-6989586621680383378"><span class="hs-identifier hs-var">issObservableState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; Maybe Value
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383379"><span class="hs-identifier hs-var">vl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span class="hs-comment">-- | The list of all endpoints that can be called on the instance</span><span>
</span><span id="line-321"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#openEndpoints"><span class="hs-identifier hs-type">openEndpoints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">IterationID</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-type">OpenEndpoint</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span id="openEndpoints"><span class="annot"><span class="annottext">openEndpoints :: InstanceState -&gt; STM (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#openEndpoints"><span class="hs-identifier hs-var hs-var">openEndpoints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar (Map (RequestID, IterationID) OpenEndpoint)
-&gt; STM (Map (RequestID, IterationID) OpenEndpoint)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar (Map (RequestID, IterationID) OpenEndpoint)
 -&gt; STM (Map (RequestID, IterationID) OpenEndpoint))
-&gt; (InstanceState
    -&gt; TVar (Map (RequestID, IterationID) OpenEndpoint))
-&gt; InstanceState
-&gt; STM (Map (RequestID, IterationID) OpenEndpoint)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState -&gt; TVar (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issEndpoints"><span class="hs-identifier hs-var hs-var">issEndpoints</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span class="hs-comment">-- | Call an endpoint with a JSON value.</span><span>
</span><span id="line-325"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpoint"><span class="hs-identifier hs-type">callEndpoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-type">OpenEndpoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">EndpointValue</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span id="callEndpoint"><span class="annot"><span class="annottext">callEndpoint :: OpenEndpoint -&gt; EndpointValue Value -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpoint"><span class="hs-identifier hs-var hs-var">callEndpoint</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-type">OpenEndpoint</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383377"><span class="annot"><span class="annottext">TMVar (EndpointValue Value)
oepResponse :: TMVar (EndpointValue Value)
oepResponse :: OpenEndpoint -&gt; TMVar (EndpointValue Value)
</span><a href="#local-6989586621680383377"><span class="hs-identifier hs-var hs-var">oepResponse</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TMVar (EndpointValue Value) -&gt; EndpointValue Value -&gt; STM ()
forall a. TMVar a -&gt; a -&gt; STM ()
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.putTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar (EndpointValue Value)
</span><a href="#local-6989586621680383377"><span class="hs-identifier hs-var">oepResponse</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span class="hs-comment">-- | Call an endpoint on a contract instance. Fail immediately if the endpoint is not active.</span><span>
</span><span id="line-329"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance"><span class="hs-identifier hs-type">callEndpointOnInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">EndpointDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">NotificationError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-330"></span><span id="callEndpointOnInstance"><span class="annot"><span class="annottext">callEndpointOnInstance :: InstancesState
-&gt; EndpointDescription
-&gt; Value
-&gt; ContractInstanceId
-&gt; IO (STM (Maybe NotificationError))
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance"><span class="hs-identifier hs-var hs-var">callEndpointOnInstance</span></a></span></span><span> </span><span id="local-6989586621680383375"><span class="annot"><span class="annottext">InstancesState
</span><a href="#local-6989586621680383375"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621680383374"><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383374"><span class="hs-identifier hs-var">endpointDescription</span></a></span></span><span> </span><span id="local-6989586621680383373"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383373"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span id="local-6989586621680383372"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383372"><span class="hs-identifier hs-var">instanceID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-331"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383371"><span class="annot"><span class="annottext">err :: STM (Maybe NotificationError)
</span><a href="#local-6989586621680383371"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe NotificationError -&gt; STM (Maybe NotificationError))
-&gt; Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NotificationError -&gt; Maybe NotificationError
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(NotificationError -&gt; Maybe NotificationError)
-&gt; NotificationError -&gt; Maybe NotificationError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; EndpointDescription -&gt; NotificationError
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">EndpointNotAvailable</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383372"><span class="hs-identifier hs-var">instanceID</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383374"><span class="hs-identifier hs-var">endpointDescription</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">STM (Maybe NotificationError)
-&gt; InstancesState
-&gt; EndpointDescription
-&gt; Value
-&gt; ContractInstanceId
-&gt; IO (STM (Maybe NotificationError))
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance%27"><span class="hs-identifier hs-var">callEndpointOnInstance'</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe NotificationError)
</span><a href="#local-6989586621680383371"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">InstancesState
</span><a href="#local-6989586621680383375"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383374"><span class="hs-identifier hs-var">endpointDescription</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383373"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383372"><span class="hs-identifier hs-var">instanceID</span></a></span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="hs-comment">-- | Call an endpoint on a contract instance. If the endpoint is not active, wait until the</span><span>
</span><span id="line-335"></span><span class="hs-comment">--   TMVar is filled, then fail. (if the endpoint becomes active in the meantime it will be</span><span>
</span><span id="line-336"></span><span class="hs-comment">--   called)</span><span>
</span><span id="line-337"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstanceTimeout"><span class="hs-identifier hs-type">callEndpointOnInstanceTimeout</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-type">STM.TMVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">EndpointDescription</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">NotificationError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span id="callEndpointOnInstanceTimeout"><span class="annot"><span class="annottext">callEndpointOnInstanceTimeout :: TMVar ()
-&gt; InstancesState
-&gt; EndpointDescription
-&gt; Value
-&gt; ContractInstanceId
-&gt; IO (STM (Maybe NotificationError))
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstanceTimeout"><span class="hs-identifier hs-var hs-var">callEndpointOnInstanceTimeout</span></a></span></span><span> </span><span id="local-6989586621680383369"><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621680383369"><span class="hs-identifier hs-var">tmv</span></a></span></span><span> </span><span id="local-6989586621680383368"><span class="annot"><span class="annottext">InstancesState
</span><a href="#local-6989586621680383368"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621680383367"><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383367"><span class="hs-identifier hs-var">endpointDescription</span></a></span></span><span> </span><span id="local-6989586621680383366"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383366"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span id="local-6989586621680383365"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383365"><span class="hs-identifier hs-var">instanceID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383364"><span class="annot"><span class="annottext">err :: STM (Maybe NotificationError)
</span><a href="#local-6989586621680383364"><span class="hs-identifier hs-var hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>            </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TMVar () -&gt; STM ()
forall a. TMVar a -&gt; STM a
</span><a href="../file:///nix/store/b738x068mpk6m31fqb2w33rzbqb41k86-stm-lib-stm-2.5.0.1-haddock-doc/share/doc/stm/html/src"><span class="hs-identifier hs-var">STM.takeTMVar</span></a></span><span> </span><span class="annot"><span class="annottext">TMVar ()
</span><a href="#local-6989586621680383369"><span class="hs-identifier hs-var">tmv</span></a></span><span>
</span><span id="line-341"></span><span>            </span><span class="annot"><span class="annottext">Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe NotificationError -&gt; STM (Maybe NotificationError))
-&gt; Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NotificationError -&gt; Maybe NotificationError
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(NotificationError -&gt; Maybe NotificationError)
-&gt; NotificationError -&gt; Maybe NotificationError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; EndpointDescription -&gt; NotificationError
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">EndpointNotAvailable</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383365"><span class="hs-identifier hs-var">instanceID</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383367"><span class="hs-identifier hs-var">endpointDescription</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">STM (Maybe NotificationError)
-&gt; InstancesState
-&gt; EndpointDescription
-&gt; Value
-&gt; ContractInstanceId
-&gt; IO (STM (Maybe NotificationError))
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance%27"><span class="hs-identifier hs-var">callEndpointOnInstance'</span></a></span><span> </span><span class="annot"><span class="annottext">STM (Maybe NotificationError)
</span><a href="#local-6989586621680383364"><span class="hs-identifier hs-var">err</span></a></span><span> </span><span class="annot"><span class="annottext">InstancesState
</span><a href="#local-6989586621680383368"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383367"><span class="hs-identifier hs-var">endpointDescription</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383366"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383365"><span class="hs-identifier hs-var">instanceID</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="hs-comment">-- | Call an endpoint on a contract instance. The caller can define what to do if the endpoint</span><span>
</span><span id="line-345"></span><span class="hs-comment">--   is not available.</span><span>
</span><span id="line-346"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance%27"><span class="hs-identifier hs-type">callEndpointOnInstance'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">NotificationError</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- ^ What to do when the endpoint is not available</span><span>
</span><span id="line-348"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">EndpointDescription</span></a></span><span>
</span><span id="line-350"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">NotificationError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span id="callEndpointOnInstance%27"><span class="annot"><span class="annottext">callEndpointOnInstance' :: STM (Maybe NotificationError)
-&gt; InstancesState
-&gt; EndpointDescription
-&gt; Value
-&gt; ContractInstanceId
-&gt; IO (STM (Maybe NotificationError))
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpointOnInstance%27"><span class="hs-identifier hs-var hs-var">callEndpointOnInstance'</span></a></span></span><span> </span><span id="local-6989586621680383362"><span class="annot"><span class="annottext">STM (Maybe NotificationError)
</span><a href="#local-6989586621680383362"><span class="hs-identifier hs-var">notAvailable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span id="local-6989586621680383360"><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383360"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621680383359"><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383359"><span class="hs-identifier hs-var">endpointDescription</span></a></span></span><span> </span><span id="local-6989586621680383358"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383358"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span id="local-6989586621680383357"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383357"><span class="hs-identifier hs-var">instanceID</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>    </span><span id="local-6989586621680383356"><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
</span><a href="#local-6989586621680383356"><span class="hs-identifier hs-var">instances</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
-&gt; IO (Map ContractInstanceId InstanceState)
forall a. IORef a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383360"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-355"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
-&gt; Map ContractInstanceId InstanceState -&gt; Maybe InstanceState
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383357"><span class="hs-identifier hs-var">instanceID</span></a></span><span> </span><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
</span><a href="#local-6989586621680383356"><span class="hs-identifier hs-var">instances</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">Maybe InstanceState
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (Maybe NotificationError) -&gt; IO (STM (Maybe NotificationError))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe NotificationError)
 -&gt; IO (STM (Maybe NotificationError)))
-&gt; STM (Maybe NotificationError)
-&gt; IO (STM (Maybe NotificationError))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NotificationError -&gt; Maybe NotificationError
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(NotificationError -&gt; Maybe NotificationError)
-&gt; NotificationError -&gt; Maybe NotificationError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; NotificationError
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">InstanceDoesNotExist</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383357"><span class="hs-identifier hs-var">instanceID</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680383355"><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680383355"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (Maybe NotificationError) -&gt; IO (STM (Maybe NotificationError))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(STM (Maybe NotificationError)
 -&gt; IO (STM (Maybe NotificationError)))
-&gt; STM (Maybe NotificationError)
-&gt; IO (STM (Maybe NotificationError))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>            </span><span id="local-6989586621680383354"><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
</span><a href="#local-6989586621680383354"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">InstanceState -&gt; STM (Map (RequestID, IterationID) OpenEndpoint)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#openEndpoints"><span class="hs-identifier hs-var">openEndpoints</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680383355"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-359"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383353"><span class="annot"><span class="annottext">match :: OpenEndpoint -&gt; Bool
</span><a href="#local-6989586621680383353"><span class="hs-identifier hs-var hs-var">match</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#OpenEndpoint"><span class="hs-identifier hs-type">OpenEndpoint</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">oepName :: OpenEndpoint -&gt; ActiveEndpoint
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#oepName"><span class="hs-identifier hs-var">oepName</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ActiveEndpoint</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">aeDescription :: ActiveEndpoint -&gt; EndpointDescription
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">aeDescription</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680383352"><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383352"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383359"><span class="hs-identifier hs-var">endpointDescription</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointDescription -&gt; EndpointDescription -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383352"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-360"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(OpenEndpoint -&gt; Bool) -&gt; [OpenEndpoint] -&gt; [OpenEndpoint]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">filter</span></a></span><span> </span><span class="annot"><span class="annottext">OpenEndpoint -&gt; Bool
</span><a href="#local-6989586621680383353"><span class="hs-identifier hs-var">match</span></a></span><span> </span><span class="annot"><span class="annottext">([OpenEndpoint] -&gt; [OpenEndpoint])
-&gt; [OpenEndpoint] -&gt; [OpenEndpoint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(((RequestID, IterationID), OpenEndpoint) -&gt; OpenEndpoint)
-&gt; [((RequestID, IterationID), OpenEndpoint)] -&gt; [OpenEndpoint]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">((RequestID, IterationID), OpenEndpoint) -&gt; OpenEndpoint
forall a b. (a, b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">([((RequestID, IterationID), OpenEndpoint)] -&gt; [OpenEndpoint])
-&gt; [((RequestID, IterationID), OpenEndpoint)] -&gt; [OpenEndpoint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
-&gt; [((RequestID, IterationID), OpenEndpoint)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.toList</span></a></span><span> </span><span class="annot"><span class="annottext">Map (RequestID, IterationID) OpenEndpoint
</span><a href="#local-6989586621680383354"><span class="hs-identifier hs-var">mp</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-361"></span><span>                </span><span class="hs-special">[</span><span class="hs-special">]</span><span>   </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (Maybe NotificationError)
</span><a href="#local-6989586621680383362"><span class="hs-identifier hs-var">notAvailable</span></a></span><span>
</span><span id="line-362"></span><span>                </span><span class="hs-special">[</span><span id="local-6989586621680383351"><span class="annot"><span class="annottext">OpenEndpoint
</span><a href="#local-6989586621680383351"><span class="hs-identifier hs-var">ep</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OpenEndpoint -&gt; EndpointValue Value -&gt; STM ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#callEndpoint"><span class="hs-identifier hs-var">callEndpoint</span></a></span><span> </span><span class="annot"><span class="annottext">OpenEndpoint
</span><a href="#local-6989586621680383351"><span class="hs-identifier hs-var">ep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; EndpointValue Value
forall a. a -&gt; EndpointValue a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">EndpointValue</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680383358"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">STM ()
-&gt; STM (Maybe NotificationError) -&gt; STM (Maybe NotificationError)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe NotificationError
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-363"></span><span>                </span><span class="annot"><span class="annottext">[OpenEndpoint]
</span><span class="hs-identifier">_</span></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe NotificationError -&gt; STM (Maybe NotificationError))
-&gt; Maybe NotificationError -&gt; STM (Maybe NotificationError)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">NotificationError -&gt; Maybe NotificationError
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(NotificationError -&gt; Maybe NotificationError)
-&gt; NotificationError -&gt; Maybe NotificationError
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId -&gt; EndpointDescription -&gt; NotificationError
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">MoreThanOneEndpointAvailable</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383357"><span class="hs-identifier hs-var">instanceID</span></a></span><span> </span><span class="annot"><span class="annottext">EndpointDescription
</span><a href="#local-6989586621680383359"><span class="hs-identifier hs-var">endpointDescription</span></a></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span class="hs-comment">-- | The list of all partial txs that need to be balanced on the instance.</span><span>
</span><span id="line-366"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#yieldedExportTxs"><span class="hs-identifier hs-type">yieldedExportTxs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ExportTx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-367"></span><span id="yieldedExportTxs"><span class="annot"><span class="annottext">yieldedExportTxs :: InstanceState -&gt; STM [ExportTx]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#yieldedExportTxs"><span class="hs-identifier hs-var hs-var">yieldedExportTxs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar [ExportTx] -&gt; STM [ExportTx]
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TVar [ExportTx] -&gt; STM [ExportTx])
-&gt; (InstanceState -&gt; TVar [ExportTx])
-&gt; InstanceState
-&gt; STM [ExportTx]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState -&gt; TVar [ExportTx]
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#issYieldedExportTxs"><span class="hs-identifier hs-var hs-var">issYieldedExportTxs</span></a></span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="hs-comment">-- | State of all contract instances that are currently running</span><span>
</span><span id="line-370"></span><span class="hs-keyword">newtype</span><span> </span><span id="InstancesState"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-var">InstancesState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="InstancesState"><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-var">InstancesState</span></a></span></span><span> </span><span class="hs-special">{</span><span> </span><span id="getInstancesState"><span class="annot"><span class="annottext">InstancesState -&gt; IORef (Map ContractInstanceId InstanceState)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#getInstancesState"><span class="hs-identifier hs-var hs-var">getInstancesState</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">IORef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-371"></span><span>
</span><span id="line-372"></span><span class="hs-comment">-- | Initialise the 'InstancesState' with an empty value</span><span>
</span><span id="line-373"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstancesState"><span class="hs-identifier hs-type">emptyInstancesState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span>
</span><span id="line-374"></span><span id="emptyInstancesState"><span class="annot"><span class="annottext">emptyInstancesState :: IO InstancesState
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#emptyInstancesState"><span class="hs-identifier hs-var hs-var">emptyInstancesState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState) -&gt; InstancesState
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-var">InstancesState</span></a></span><span> </span><span class="annot"><span class="annottext">(IORef (Map ContractInstanceId InstanceState) -&gt; InstancesState)
-&gt; IO (IORef (Map ContractInstanceId InstanceState))
-&gt; IO InstancesState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
-&gt; IO (IORef (Map ContractInstanceId InstanceState))
forall a. a -&gt; IO (IORef a)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.newIORef</span></a></span><span> </span><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
forall a. Monoid a =&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span class="hs-comment">-- | The IDs of all contract instances</span><span>
</span><span id="line-377"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceIDs"><span class="hs-identifier hs-type">instanceIDs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Set</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-378"></span><span id="instanceIDs"><span class="annot"><span class="annottext">instanceIDs :: InstancesState -&gt; IO (Set ContractInstanceId)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceIDs"><span class="hs-identifier hs-var hs-var">instanceIDs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span id="local-6989586621680383349"><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383349"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState -&gt; Set ContractInstanceId
forall k a. Map k a -&gt; Set k
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.keysSet</span></a></span><span> </span><span class="annot"><span class="annottext">(Map ContractInstanceId InstanceState -&gt; Set ContractInstanceId)
-&gt; IO (Map ContractInstanceId InstanceState)
-&gt; IO (Set ContractInstanceId)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
-&gt; IO (Map ContractInstanceId InstanceState)
forall a. IORef a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383349"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">-- | The 'InstanceState' of the contract instance. Retries if the state can't</span><span>
</span><span id="line-381"></span><span class="hs-comment">--   be found in the map.</span><span>
</span><span id="line-382"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceState"><span class="hs-identifier hs-type">instanceState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span id="instanceState"><span class="annot"><span class="annottext">instanceState :: ContractInstanceId -&gt; InstancesState -&gt; IO (Maybe InstanceState)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#instanceState"><span class="hs-identifier hs-var hs-var">instanceState</span></a></span></span><span> </span><span id="local-6989586621680383347"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383347"><span class="hs-identifier hs-var">instanceId</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span id="local-6989586621680383346"><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383346"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>    </span><span id="local-6989586621680383345"><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
</span><a href="#local-6989586621680383345"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
-&gt; IO (Map ContractInstanceId InstanceState)
forall a. IORef a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383346"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="annottext">Maybe InstanceState -&gt; IO (Maybe InstanceState)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContractInstanceId
-&gt; Map ContractInstanceId InstanceState -&gt; Maybe InstanceState
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383347"><span class="hs-identifier hs-var">instanceId</span></a></span><span> </span><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
</span><a href="#local-6989586621680383345"><span class="hs-identifier hs-var">mp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span class="hs-comment">-- | Get the observable state of the contract instance. Blocks if the</span><span>
</span><span id="line-388"></span><span class="hs-comment">--   state is not available yet.</span><span>
</span><span id="line-389"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#observableContractState"><span class="hs-identifier hs-type">observableContractState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-390"></span><span id="observableContractState"><span class="annot"><span class="annottext">observableContractState :: InstanceState -&gt; STM Value
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#observableContractState"><span class="hs-identifier hs-var hs-var">observableContractState</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383344"><span class="annot"><span class="annottext">TVar (Maybe Value)
issObservableState :: TVar (Maybe Value)
issObservableState :: InstanceState -&gt; TVar (Maybe Value)
</span><a href="#local-6989586621680383344"><span class="hs-identifier hs-var hs-var">issObservableState</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-391"></span><span>    </span><span id="local-6989586621680383343"><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621680383343"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar (Maybe Value) -&gt; STM (Maybe Value)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (Maybe Value)
</span><a href="#local-6989586621680383344"><span class="hs-identifier hs-var">issObservableState</span></a></span><span>
</span><span id="line-392"></span><span>    </span><span class="annot"><span class="annottext">STM Value -&gt; (Value -&gt; STM Value) -&gt; Maybe Value -&gt; STM Value
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">STM Value
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; STM Value
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621680383343"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="hs-comment">-- | Return the final state of the contract when it is finished (possibly an</span><span>
</span><span id="line-395"></span><span class="hs-comment">--   error)</span><span>
</span><span id="line-396"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#finalResult"><span class="hs-identifier hs-type">finalResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span id="finalResult"><span class="annot"><span class="annottext">finalResult :: InstanceState -&gt; STM (Maybe Value)
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#finalResult"><span class="hs-identifier hs-var hs-var">finalResult</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383341"><span class="annot"><span class="annottext">TVar Activity
issStatus :: TVar Activity
issStatus :: InstanceState -&gt; TVar Activity
</span><a href="#local-6989586621680383341"><span class="hs-identifier hs-var hs-var">issStatus</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>    </span><span id="local-6989586621680383340"><span class="annot"><span class="annottext">Activity
</span><a href="#local-6989586621680383340"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Activity -&gt; STM Activity
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Activity
</span><a href="#local-6989586621680383341"><span class="hs-identifier hs-var">issStatus</span></a></span><span>
</span><span id="line-399"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Activity
</span><a href="#local-6989586621680383340"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Done"><span class="hs-identifier hs-type">Done</span></a></span><span> </span><span id="local-6989586621680383339"><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621680383339"><span class="hs-identifier hs-var">r</span></a></span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; STM (Maybe Value)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><a href="#local-6989586621680383339"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-401"></span><span>        </span><span class="annot"><span class="annottext">Activity
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#Stopped"><span class="hs-identifier hs-var">Stopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Value -&gt; STM (Maybe Value)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-402"></span><span>        </span><span class="annot"><span class="annottext">Activity
</span><span class="hs-identifier">_</span></span><span>       </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM (Maybe Value)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="hs-comment">-- | Insert an 'InstanceState' value into the 'InstancesState'</span><span>
</span><span id="line-405"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#insertInstance"><span class="hs-identifier hs-type">insertInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-406"></span><span id="insertInstance"><span class="annot"><span class="annottext">insertInstance :: ContractInstanceId -&gt; InstanceState -&gt; InstancesState -&gt; IO ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#insertInstance"><span class="hs-identifier hs-var hs-var">insertInstance</span></a></span></span><span> </span><span id="local-6989586621680383338"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383338"><span class="hs-identifier hs-var">instanceID</span></a></span></span><span> </span><span id="local-6989586621680383337"><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680383337"><span class="hs-identifier hs-var">state</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span id="local-6989586621680383336"><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383336"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
-&gt; (Map ContractInstanceId InstanceState
    -&gt; Map ContractInstanceId InstanceState)
-&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.modifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383336"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContractInstanceId
-&gt; InstanceState
-&gt; Map ContractInstanceId InstanceState
-&gt; Map ContractInstanceId InstanceState
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.insert</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383338"><span class="hs-identifier hs-var">instanceID</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState
</span><a href="#local-6989586621680383337"><span class="hs-identifier hs-var">state</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span class="hs-comment">-- | Delete an instance from the 'InstancesState'</span><span>
</span><span id="line-409"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#removeInstance"><span class="hs-identifier hs-type">removeInstance</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span id="removeInstance"><span class="annot"><span class="annottext">removeInstance :: ContractInstanceId -&gt; InstancesState -&gt; IO ()
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#removeInstance"><span class="hs-identifier hs-var hs-var">removeInstance</span></a></span></span><span> </span><span id="local-6989586621680383334"><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383334"><span class="hs-identifier hs-var">instanceID</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span id="local-6989586621680383333"><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383333"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
-&gt; (Map ContractInstanceId InstanceState
    -&gt; Map ContractInstanceId InstanceState)
-&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.modifyIORef'</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383333"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ContractInstanceId
-&gt; Map ContractInstanceId InstanceState
-&gt; Map ContractInstanceId InstanceState
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-var">Map.delete</span></a></span><span> </span><span class="annot"><span class="annottext">ContractInstanceId
</span><a href="#local-6989586621680383334"><span class="hs-identifier hs-var">instanceID</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span class="hs-comment">-- | Wait for the status of a transaction to change.</span><span>
</span><span id="line-413"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxStatusChange"><span class="hs-identifier hs-type">waitForTxStatusChange</span></a></span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">TxStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">TxStatus</span></a></span><span>
</span><span id="line-415"></span><span id="waitForTxStatusChange"><span class="annot"><span class="annottext">waitForTxStatusChange :: TxStatus -&gt; TxId -&gt; BlockchainEnv -&gt; STM TxStatus
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxStatusChange"><span class="hs-identifier hs-var hs-var">waitForTxStatusChange</span></a></span></span><span> </span><span id="local-6989586621680383331"><span class="annot"><span class="annottext">TxStatus
</span><a href="#local-6989586621680383331"><span class="hs-identifier hs-var">oldStatus</span></a></span></span><span> </span><span id="local-6989586621680383330"><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680383330"><span class="hs-identifier hs-var">tx</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383329"><span class="annot"><span class="annottext">Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
beTxChanges :: Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
beTxChanges :: BlockchainEnv
-&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="#local-6989586621680383329"><span class="hs-identifier hs-var hs-var">beTxChanges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383328"><span class="annot"><span class="annottext">TVar BlockNumber
beLastSyncedBlockNo :: TVar BlockNumber
beLastSyncedBlockNo :: BlockchainEnv -&gt; TVar BlockNumber
</span><a href="#local-6989586621680383328"><span class="hs-identifier hs-var hs-var">beLastSyncedBlockNo</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="#local-6989586621680383329"><span class="hs-identifier hs-var">beTxChanges</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-417"></span><span>      </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680383327"><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
</span><a href="#local-6989586621680383327"><span class="hs-identifier hs-var">ix</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>        </span><span id="local-6989586621680383326"><span class="annot"><span class="annottext">BlockNumber
</span><a href="#local-6989586621680383326"><span class="hs-identifier hs-var">blockNumber</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar BlockNumber -&gt; STM BlockNumber
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar BlockNumber
</span><a href="#local-6989586621680383328"><span class="hs-identifier hs-var">beLastSyncedBlockNo</span></a></span><span>
</span><span id="line-419"></span><span>        </span><span id="local-6989586621680383325"><span class="annot"><span class="annottext">TxIdState
</span><a href="#local-6989586621680383325"><span class="hs-identifier hs-var">txIdState</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UtxoState TxIdState -&gt; TxIdState
forall a. UtxoState a -&gt; a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var hs-var">_usTxUtxoData</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoState TxIdState -&gt; TxIdState)
-&gt; (UtxoIndex TxIdState -&gt; UtxoState TxIdState)
-&gt; UtxoIndex TxIdState
-&gt; TxIdState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxIdState -&gt; UtxoState TxIdState
forall a. Monoid a =&gt; UtxoIndex a -&gt; UtxoState a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">utxoState</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoIndex TxIdState -&gt; TxIdState)
-&gt; STM (UtxoIndex TxIdState) -&gt; STM TxIdState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState) -&gt; STM (UtxoIndex TxIdState)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
</span><a href="#local-6989586621680383327"><span class="hs-identifier hs-var">ix</span></a></span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383324"><span class="annot"><span class="annottext">txStatus :: Either TxStatusFailure TxStatus
</span><a href="#local-6989586621680383324"><span class="hs-identifier hs-var hs-var">txStatus</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockNumber -&gt; TxIdState -&gt; TxId -&gt; Either TxStatusFailure TxStatus
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">transactionStatus</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNumber
</span><a href="#local-6989586621680383326"><span class="hs-identifier hs-var">blockNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TxIdState
</span><a href="#local-6989586621680383325"><span class="hs-identifier hs-var">txIdState</span></a></span><span> </span><span class="annot"><span class="annottext">TxId
</span><a href="#local-6989586621680383330"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-comment">-- Succeed only if we _found_ a status and it was different; if</span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-comment">-- the status hasn't changed, _or_ there was an error computing</span><span>
</span><span id="line-423"></span><span>        </span><span class="hs-comment">-- the status, keep retrying.</span><span>
</span><span id="line-424"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either TxStatusFailure TxStatus
</span><a href="#local-6989586621680383324"><span class="hs-identifier hs-var">txStatus</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-425"></span><span>          </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680383323"><span class="annot"><span class="annottext">TxStatus
</span><a href="#local-6989586621680383323"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TxStatus
</span><a href="#local-6989586621680383323"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus -&gt; TxStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus
</span><a href="#local-6989586621680383331"><span class="hs-identifier hs-var">oldStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxStatus -&gt; STM TxStatus
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TxStatus
</span><a href="#local-6989586621680383323"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-426"></span><span>          </span><span class="annot"><span class="annottext">Either TxStatusFailure TxStatus
</span><span class="hs-identifier">_</span></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM TxStatus
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-427"></span><span>      </span><span class="hs-comment">-- This branch gets intercepted in `processTxStatusChangeRequestIO` and</span><span>
</span><span id="line-428"></span><span>      </span><span class="hs-comment">-- handled separateley, so we should never reach this place.</span><span>
</span><span id="line-429"></span><span>      </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; STM TxStatus
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;waitForTxStatusChange called without the STM index available&quot;</span></span><span>
</span><span id="line-431"></span><span>
</span><span id="line-432"></span><span class="hs-comment">-- | Wait for the status of a transaction output to change.</span><span>
</span><span id="line-433"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxOutStatusChange"><span class="hs-identifier hs-type">waitForTxOutStatusChange</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">TxOutStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxOutRef</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-type">TxOutStatus</span></a></span><span>
</span><span id="line-434"></span><span id="waitForTxOutStatusChange"><span class="annot"><span class="annottext">waitForTxOutStatusChange :: TxOutStatus -&gt; TxOutRef -&gt; BlockchainEnv -&gt; STM TxOutStatus
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#waitForTxOutStatusChange"><span class="hs-identifier hs-var hs-var">waitForTxOutStatusChange</span></a></span></span><span> </span><span id="local-6989586621680383320"><span class="annot"><span class="annottext">TxOutStatus
</span><a href="#local-6989586621680383320"><span class="hs-identifier hs-var">oldStatus</span></a></span></span><span> </span><span id="local-6989586621680383319"><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680383319"><span class="hs-identifier hs-var">txOutRef</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383318"><span class="annot"><span class="annottext">Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
beTxChanges :: Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
beTxChanges :: BlockchainEnv
-&gt; Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="#local-6989586621680383318"><span class="hs-identifier hs-var hs-var">beTxChanges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383317"><span class="annot"><span class="annottext">TVar (UtxoIndex TxOutBalance)
beTxOutChanges :: TVar (UtxoIndex TxOutBalance)
beTxOutChanges :: BlockchainEnv -&gt; TVar (UtxoIndex TxOutBalance)
</span><a href="#local-6989586621680383317"><span class="hs-identifier hs-var hs-var">beTxOutChanges</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680383316"><span class="annot"><span class="annottext">TVar BlockNumber
beLastSyncedBlockNo :: TVar BlockNumber
beLastSyncedBlockNo :: BlockchainEnv -&gt; TVar BlockNumber
</span><a href="#local-6989586621680383316"><span class="hs-identifier hs-var hs-var">beLastSyncedBlockNo</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either (TVar (UtxoIndex TxIdState)) (IORef TCSIndex)
</span><a href="#local-6989586621680383318"><span class="hs-identifier hs-var">beTxChanges</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-436"></span><span>      </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621680383315"><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
</span><a href="#local-6989586621680383315"><span class="hs-identifier hs-var">txChanges</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-437"></span><span>        </span><span id="local-6989586621680383314"><span class="annot"><span class="annottext">TxIdState
</span><a href="#local-6989586621680383314"><span class="hs-identifier hs-var">txIdState</span></a></span></span><span>    </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UtxoState TxIdState -&gt; TxIdState
forall a. UtxoState a -&gt; a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var hs-var">_usTxUtxoData</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoState TxIdState -&gt; TxIdState)
-&gt; (UtxoIndex TxIdState -&gt; UtxoState TxIdState)
-&gt; UtxoIndex TxIdState
-&gt; TxIdState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxIdState -&gt; UtxoState TxIdState
forall a. Monoid a =&gt; UtxoIndex a -&gt; UtxoState a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">utxoState</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoIndex TxIdState -&gt; TxIdState)
-&gt; STM (UtxoIndex TxIdState) -&gt; STM TxIdState
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState) -&gt; STM (UtxoIndex TxIdState)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxIdState)
</span><a href="#local-6989586621680383315"><span class="hs-identifier hs-var">txChanges</span></a></span><span>
</span><span id="line-438"></span><span>        </span><span id="local-6989586621680383313"><span class="annot"><span class="annottext">TxOutBalance
</span><a href="#local-6989586621680383313"><span class="hs-identifier hs-var">txOutBalance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UtxoState TxOutBalance -&gt; TxOutBalance
forall a. UtxoState a -&gt; a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var hs-var">_usTxUtxoData</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoState TxOutBalance -&gt; TxOutBalance)
-&gt; (UtxoIndex TxOutBalance -&gt; UtxoState TxOutBalance)
-&gt; UtxoIndex TxOutBalance
-&gt; TxOutBalance
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">UtxoIndex TxOutBalance -&gt; UtxoState TxOutBalance
forall a. Monoid a =&gt; UtxoIndex a -&gt; UtxoState a
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">utxoState</span></a></span><span> </span><span class="annot"><span class="annottext">(UtxoIndex TxOutBalance -&gt; TxOutBalance)
-&gt; STM (UtxoIndex TxOutBalance) -&gt; STM TxOutBalance
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxOutBalance) -&gt; STM (UtxoIndex TxOutBalance)
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar (UtxoIndex TxOutBalance)
</span><a href="#local-6989586621680383317"><span class="hs-identifier hs-var">beTxOutChanges</span></a></span><span>
</span><span id="line-439"></span><span>        </span><span id="local-6989586621680383312"><span class="annot"><span class="annottext">BlockNumber
</span><a href="#local-6989586621680383312"><span class="hs-identifier hs-var">blockNumber</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar BlockNumber -&gt; STM BlockNumber
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar BlockNumber
</span><a href="#local-6989586621680383316"><span class="hs-identifier hs-var">beLastSyncedBlockNo</span></a></span><span>
</span><span id="line-440"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680383311"><span class="annot"><span class="annottext">txOutStatus :: Either TxStatusFailure TxOutStatus
</span><a href="#local-6989586621680383311"><span class="hs-identifier hs-var hs-var">txOutStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockNumber
-&gt; TxIdState
-&gt; TxOutBalance
-&gt; TxOutRef
-&gt; Either TxStatusFailure TxOutStatus
</span><a href="../../../../plutus-chain-index-core/html/src"><span class="hs-identifier hs-var">transactionOutputStatus</span></a></span><span> </span><span class="annot"><span class="annottext">BlockNumber
</span><a href="#local-6989586621680383312"><span class="hs-identifier hs-var">blockNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TxIdState
</span><a href="#local-6989586621680383314"><span class="hs-identifier hs-var">txIdState</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutBalance
</span><a href="#local-6989586621680383313"><span class="hs-identifier hs-var">txOutBalance</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><a href="#local-6989586621680383319"><span class="hs-identifier hs-var">txOutRef</span></a></span><span>
</span><span id="line-441"></span><span>        </span><span class="hs-comment">-- Succeed only if we _found_ a status and it was different; if</span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-comment">-- the status hasn't changed, _or_ there was an error computing</span><span>
</span><span id="line-443"></span><span>        </span><span class="hs-comment">-- the status, keep retrying.</span><span>
</span><span id="line-444"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Either TxStatusFailure TxOutStatus
</span><a href="#local-6989586621680383311"><span class="hs-identifier hs-var">txOutStatus</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-445"></span><span>          </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621680383310"><span class="annot"><span class="annottext">TxOutStatus
</span><a href="#local-6989586621680383310"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TxOutStatus
</span><a href="#local-6989586621680383310"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutStatus -&gt; TxOutStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutStatus
</span><a href="#local-6989586621680383320"><span class="hs-identifier hs-var">oldStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TxOutStatus -&gt; STM TxOutStatus
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutStatus
</span><a href="#local-6989586621680383310"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-446"></span><span>          </span><span class="annot"><span class="annottext">Either TxStatusFailure TxOutStatus
</span><span class="hs-identifier">_</span></span><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">STM TxOutStatus
forall (f :: * -&gt; *) a. Alternative f =&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">empty</span></a></span><span>
</span><span id="line-447"></span><span>      </span><span class="hs-comment">-- This branch gets intercepted in `processTxOutStatusChangeRequestIO` and</span><span>
</span><span id="line-448"></span><span>      </span><span class="hs-comment">-- handled separateley, so we should never reach this place.</span><span>
</span><span id="line-449"></span><span>      </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><span class="annottext">IORef TCSIndex
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-450"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; STM TxOutStatus
forall a. HasCallStack =&gt; String -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;waitForTxOutStatusChange called without the STM index available&quot;</span></span><span>
</span><span id="line-451"></span><span>
</span><span id="line-452"></span><span class="hs-comment">-- | The current slot number</span><span>
</span><span id="line-453"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#currentSlot"><span class="hs-identifier hs-type">currentSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span>
</span><span id="line-454"></span><span id="currentSlot"><span class="annot"><span class="annottext">currentSlot :: BlockchainEnv -&gt; STM Slot
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#currentSlot"><span class="hs-identifier hs-var hs-var">currentSlot</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383309"><span class="annot"><span class="annottext">TVar Slot
beCurrentSlot :: TVar Slot
beCurrentSlot :: BlockchainEnv -&gt; TVar Slot
</span><a href="#local-6989586621680383309"><span class="hs-identifier hs-var hs-var">beCurrentSlot</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Slot -&gt; STM Slot
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Slot
</span><a href="#local-6989586621680383309"><span class="hs-identifier hs-var">beCurrentSlot</span></a></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#lastSyncedBlockSlot"><span class="hs-identifier hs-type">lastSyncedBlockSlot</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Slot</span></a></span><span>
</span><span id="line-457"></span><span id="lastSyncedBlockSlot"><span class="annot"><span class="annottext">lastSyncedBlockSlot :: BlockchainEnv -&gt; STM Slot
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#lastSyncedBlockSlot"><span class="hs-identifier hs-var hs-var">lastSyncedBlockSlot</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#BlockchainEnv"><span class="hs-identifier hs-type">BlockchainEnv</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383308"><span class="annot"><span class="annottext">TVar Slot
beLastSyncedBlockSlot :: TVar Slot
beLastSyncedBlockSlot :: BlockchainEnv -&gt; TVar Slot
</span><a href="#local-6989586621680383308"><span class="hs-identifier hs-var hs-var">beLastSyncedBlockSlot</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TVar Slot -&gt; STM Slot
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Slot
</span><a href="#local-6989586621680383308"><span class="hs-identifier hs-var">beLastSyncedBlockSlot</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span class="hs-comment">-- | The IDs of contract instances with their statuses</span><span>
</span><span id="line-460"></span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#instancesWithStatuses"><span class="hs-identifier hs-type">instancesWithStatuses</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/5giw0zbshrdz1qlvzc0csv9mspljr1ax-containers-lib-containers-0.6.5.1-haddock-doc/share/doc/containers/html/src"><span class="hs-identifier hs-type">Map</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractInstanceId</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Wallet.ContractActivityStatus</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-461"></span><span id="instancesWithStatuses"><span class="annot"><span class="annottext">instancesWithStatuses :: InstancesState
-&gt; IO (STM (Map ContractInstanceId ContractActivityStatus))
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#instancesWithStatuses"><span class="hs-identifier hs-var hs-var">instancesWithStatuses</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstancesState"><span class="hs-identifier hs-type">InstancesState</span></a></span><span> </span><span id="local-6989586621680383307"><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383307"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-462"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680383306"><span class="hs-identifier hs-type">parseStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Activity"><span class="hs-identifier hs-type">Activity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Wallet.ContractActivityStatus</span></a></span><span>
</span><span id="line-463"></span><span>        </span><span id="local-6989586621680383306"><span class="annot"><span class="annottext">parseStatus :: Activity -&gt; ContractActivityStatus
</span><a href="#local-6989586621680383306"><span class="hs-identifier hs-var hs-var">parseStatus</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-464"></span><span>            </span><span class="annot"><span class="annottext">Activity
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#Active"><span class="hs-identifier hs-var">Active</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContractActivityStatus
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Wallet.Active</span></a></span><span>
</span><span id="line-465"></span><span>            </span><span class="annot"><span class="annottext">Activity
</span><a href="Plutus.PAB.Core.ContractInstance.STM.html#Stopped"><span class="hs-identifier hs-var">Stopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContractActivityStatus
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Wallet.Stopped</span></a></span><span>
</span><span id="line-466"></span><span>            </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#Done"><span class="hs-identifier hs-type">Done</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Value
</span><span class="hs-identifier">_</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ContractActivityStatus
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Wallet.Done</span></a></span><span>
</span><span id="line-467"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621680383305"><span class="hs-identifier hs-type">flt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">STM</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Wallet.ContractActivityStatus</span></a></span><span>
</span><span id="line-468"></span><span>        </span><span id="local-6989586621680383305"><span class="annot"><span class="annottext">flt :: InstanceState -&gt; STM ContractActivityStatus
</span><a href="#local-6989586621680383305"><span class="hs-identifier hs-var hs-var">flt</span></a></span></span><span> </span><span class="annot"><a href="Plutus.PAB.Core.ContractInstance.STM.html#InstanceState"><span class="hs-identifier hs-type">InstanceState</span></a></span><span class="hs-special">{</span><span id="local-6989586621680383304"><span class="annot"><span class="annottext">TVar Activity
issStatus :: TVar Activity
issStatus :: InstanceState -&gt; TVar Activity
</span><a href="#local-6989586621680383304"><span class="hs-identifier hs-var hs-var">issStatus</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-469"></span><span>            </span><span id="local-6989586621680383303"><span class="annot"><span class="annottext">Activity
</span><a href="#local-6989586621680383303"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar Activity -&gt; STM Activity
forall a. TVar a -&gt; STM a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">STM.readTVar</span></a></span><span> </span><span class="annot"><span class="annottext">TVar Activity
</span><a href="#local-6989586621680383304"><span class="hs-identifier hs-var">issStatus</span></a></span><span>
</span><span id="line-470"></span><span>            </span><span class="annot"><span class="annottext">ContractActivityStatus -&gt; STM ContractActivityStatus
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(ContractActivityStatus -&gt; STM ContractActivityStatus)
-&gt; ContractActivityStatus -&gt; STM ContractActivityStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Activity -&gt; ContractActivityStatus
</span><a href="#local-6989586621680383306"><span class="hs-identifier hs-var">parseStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Activity
</span><a href="#local-6989586621680383303"><span class="hs-identifier hs-var">status</span></a></span><span>
</span><span id="line-471"></span><span>    </span><span id="local-6989586621680383302"><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
</span><a href="#local-6989586621680383302"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
-&gt; IO (Map ContractInstanceId InstanceState)
forall a. IORef a -&gt; IO a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">IORef.readIORef</span></a></span><span> </span><span class="annot"><span class="annottext">IORef (Map ContractInstanceId InstanceState)
</span><a href="#local-6989586621680383307"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-472"></span><span>    </span><span class="annot"><span class="annottext">STM (Map ContractInstanceId ContractActivityStatus)
-&gt; IO (STM (Map ContractInstanceId ContractActivityStatus))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InstanceState -&gt; STM ContractActivityStatus)
-&gt; Map ContractInstanceId InstanceState
-&gt; STM (Map ContractInstanceId ContractActivityStatus)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">traverse</span></a></span><span> </span><span class="annot"><span class="annottext">InstanceState -&gt; STM ContractActivityStatus
</span><a href="#local-6989586621680383305"><span class="hs-identifier hs-var">flt</span></a></span><span> </span><span class="annot"><span class="annottext">Map ContractInstanceId InstanceState
</span><a href="#local-6989586621680383302"><span class="hs-identifier hs-var">mp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span></pre></body></html>
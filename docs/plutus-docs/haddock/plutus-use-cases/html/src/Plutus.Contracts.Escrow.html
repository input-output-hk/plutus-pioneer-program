<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds            #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass       #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric        #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies   #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts     #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase           #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns       #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE NoImplicitPrelude    #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings    #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell      #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications     #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies         #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators        #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# OPTIONS_GHC -fplugin-opt PlutusTx.Plugin:debug-context #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# OPTIONS_GHC -g -fplugin-opt PlutusTx.Plugin:coverage-all #-}</span><span>
</span><span id="line-17"></span><span class="hs-comment">-- | A general-purpose escrow contract in Plutus</span><span>
</span><span id="line-18"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Plutus.Contracts.Escrow</span><span class="hs-special">(</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><span class="hs-comment">-- $escrow</span></span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier">Escrow</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier">EscrowError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#AsEscrowError"><span class="hs-identifier">AsEscrowError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier">EscrowParams</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier">EscrowTarget</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#payToScriptTarget"><span class="hs-identifier">payToScriptTarget</span></a></span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#payToPaymentPubKeyTarget"><span class="hs-identifier">payToPaymentPubKeyTarget</span></a></span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#targetTotal"><span class="hs-identifier">targetTotal</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#escrowContract"><span class="hs-identifier">escrowContract</span></a></span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#payRedeemRefund"><span class="hs-identifier">payRedeemRefund</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier">typedValidator</span></a></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Actions</span></span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#pay"><span class="hs-identifier">pay</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#payEp"><span class="hs-identifier">payEp</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#redeem"><span class="hs-identifier">redeem</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#redeemEp"><span class="hs-identifier">redeemEp</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#refund"><span class="hs-identifier">refund</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#refundEp"><span class="hs-identifier">refundEp</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemFailReason"><span class="hs-identifier">RedeemFailReason</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemSuccess"><span class="hs-identifier">RedeemSuccess</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier">RefundSuccess</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowSchema"><span class="hs-identifier">EscrowSchema</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Exposed for test endpoints</span></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Action"><span class="hs-identifier">Action</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Coverage</span></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#covIdx"><span class="hs-identifier">covIdx</span></a></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">_1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">has</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">makeClassyPrisms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">only</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">review</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">view</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Monad.Error.Lens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">throwing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">FromJSON</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">ToJSON</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Plutus.V1.Ledger.Api</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">ScriptContext</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">TxInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx.Code</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx.Coverage</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx.Prelude</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">Applicative</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">Semigroup</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">check</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">foldMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">Cardano.Node.Emulator.Params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier">pNetworkId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">POSIXTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">PaymentPubKeyHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">unPaymentPubKeyHash</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">TxId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">getCardanoTxId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">scriptOutputsAt</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">txSignedBy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>               </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">valuePaidTo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">TxConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Constraints</span></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints.ValidityInterval</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Interval</span></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Ledger.Interval</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">after</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">before</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Tx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Tx</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Typed.Scripts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">TypedValidator</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Typed.Scripts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Scripts</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Value</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Value</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">geq</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">lt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">Plutus.Script.Utils.Scripts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">datumHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Plutus.V1.Ledger.Scripts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Datum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Datum</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">DatumHash</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">ValidatorHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Semigroup</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Haskell</span></span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-keyword">type</span><span> </span><span id="EscrowSchema"><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowSchema"><span class="hs-identifier hs-var">EscrowSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>        </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;pay-escrow&quot;</span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-81"></span><span>        </span><span class="annot"><a href="../file:///nix/store/g8vgm61qs4g5v6yyv8hvi8bm9dvsf9sa-row-types-lib-row-types-1.0.1.2-haddock-doc/share/doc/row-types/html/src"><span class="hs-operator hs-type">.\/</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;redeem-escrow&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>        </span><span class="annot"><a href="../file:///nix/store/g8vgm61qs4g5v6yyv8hvi8bm9dvsf9sa-row-types-lib-row-types-1.0.1.2-haddock-doc/share/doc/row-types/html/src"><span class="hs-operator hs-type">.\/</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;refund-escrow&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span id="local-6989586621680973465"><span id="local-6989586621680973466"></span></span><span class="hs-keyword">data</span><span> </span><span id="RedeemFailReason"><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemFailReason"><span class="hs-identifier hs-var">RedeemFailReason</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DeadlinePassed"><span class="annot"><a href="Plutus.Contracts.Escrow.html#DeadlinePassed"><span class="hs-identifier hs-var">DeadlinePassed</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="NotEnoughFundsAtAddress"><span class="annot"><a href="Plutus.Contracts.Escrow.html#NotEnoughFundsAtAddress"><span class="hs-identifier hs-var">NotEnoughFundsAtAddress</span></a></span></span><span>
</span><span id="line-85"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973459"><span id="local-6989586621680973461"><span class="annot"><span class="annottext">RedeemFailReason -&gt; RedeemFailReason -&gt; Bool
(RedeemFailReason -&gt; RedeemFailReason -&gt; Bool)
-&gt; (RedeemFailReason -&gt; RedeemFailReason -&gt; Bool)
-&gt; Eq RedeemFailReason
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: RedeemFailReason -&gt; RedeemFailReason -&gt; Bool
$c/= :: RedeemFailReason -&gt; RedeemFailReason -&gt; Bool
== :: RedeemFailReason -&gt; RedeemFailReason -&gt; Bool
$c== :: RedeemFailReason -&gt; RedeemFailReason -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973452"><span id="local-6989586621680973454"><span id="local-6989586621680973456"><span class="annot"><span class="annottext">Int -&gt; RedeemFailReason -&gt; ShowS
[RedeemFailReason] -&gt; ShowS
RedeemFailReason -&gt; String
(Int -&gt; RedeemFailReason -&gt; ShowS)
-&gt; (RedeemFailReason -&gt; String)
-&gt; ([RedeemFailReason] -&gt; ShowS)
-&gt; Show RedeemFailReason
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RedeemFailReason] -&gt; ShowS
$cshowList :: [RedeemFailReason] -&gt; ShowS
show :: RedeemFailReason -&gt; String
$cshow :: RedeemFailReason -&gt; String
showsPrec :: Int -&gt; RedeemFailReason -&gt; ShowS
$cshowsPrec :: Int -&gt; RedeemFailReason -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. RedeemFailReason -&gt; Rep RedeemFailReason x)
-&gt; (forall x. Rep RedeemFailReason x -&gt; RedeemFailReason)
-&gt; Generic RedeemFailReason
forall x. Rep RedeemFailReason x -&gt; RedeemFailReason
forall x. RedeemFailReason -&gt; Rep RedeemFailReason x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep RedeemFailReason x -&gt; RedeemFailReason
$cfrom :: forall x. RedeemFailReason -&gt; Rep RedeemFailReason x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973440"><span id="local-6989586621680973442"><span id="local-6989586621680973444"><span id="local-6989586621680973446"><span class="annot"><span class="annottext">[RedeemFailReason] -&gt; Encoding
[RedeemFailReason] -&gt; Value
RedeemFailReason -&gt; Encoding
RedeemFailReason -&gt; Value
(RedeemFailReason -&gt; Value)
-&gt; (RedeemFailReason -&gt; Encoding)
-&gt; ([RedeemFailReason] -&gt; Value)
-&gt; ([RedeemFailReason] -&gt; Encoding)
-&gt; ToJSON RedeemFailReason
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [RedeemFailReason] -&gt; Encoding
$ctoEncodingList :: [RedeemFailReason] -&gt; Encoding
toJSONList :: [RedeemFailReason] -&gt; Value
$ctoJSONList :: [RedeemFailReason] -&gt; Value
toEncoding :: RedeemFailReason -&gt; Encoding
$ctoEncoding :: RedeemFailReason -&gt; Encoding
toJSON :: RedeemFailReason -&gt; Value
$ctoJSON :: RedeemFailReason -&gt; Value
</span><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973435"><span id="local-6989586621680973437"><span class="annot"><span class="annottext">Value -&gt; Parser [RedeemFailReason]
Value -&gt; Parser RedeemFailReason
(Value -&gt; Parser RedeemFailReason)
-&gt; (Value -&gt; Parser [RedeemFailReason])
-&gt; FromJSON RedeemFailReason
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [RedeemFailReason]
$cparseJSONList :: Value -&gt; Parser [RedeemFailReason]
parseJSON :: Value -&gt; Parser RedeemFailReason
$cparseJSON :: Value -&gt; Parser RedeemFailReason
</span><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span id="local-6989586621680973432"><span id="local-6989586621680973433"></span></span><span class="hs-keyword">data</span><span> </span><span id="EscrowError"><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier hs-var">EscrowError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-89"></span><span>    </span><span id="RedeemFailed"><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemFailed"><span class="hs-identifier hs-var">RedeemFailed</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemFailReason"><span class="hs-identifier hs-type">RedeemFailReason</span></a></span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="RefundFailed"><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundFailed"><span class="hs-identifier hs-var">RefundFailed</span></a></span></span><span>
</span><span id="line-91"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="EContractError"><span class="annot"><a href="Plutus.Contracts.Escrow.html#EContractError"><span class="hs-identifier hs-var">EContractError</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractError</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973423"><span id="local-6989586621680973425"><span id="local-6989586621680973427"><span class="annot"><span class="annottext">Int -&gt; EscrowError -&gt; ShowS
[EscrowError] -&gt; ShowS
EscrowError -&gt; String
(Int -&gt; EscrowError -&gt; ShowS)
-&gt; (EscrowError -&gt; String)
-&gt; ([EscrowError] -&gt; ShowS)
-&gt; Show EscrowError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [EscrowError] -&gt; ShowS
$cshowList :: [EscrowError] -&gt; ShowS
show :: EscrowError -&gt; String
$cshow :: EscrowError -&gt; String
showsPrec :: Int -&gt; EscrowError -&gt; ShowS
$cshowsPrec :: Int -&gt; EscrowError -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. EscrowError -&gt; Rep EscrowError x)
-&gt; (forall x. Rep EscrowError x -&gt; EscrowError)
-&gt; Generic EscrowError
forall x. Rep EscrowError x -&gt; EscrowError
forall x. EscrowError -&gt; Rep EscrowError x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep EscrowError x -&gt; EscrowError
$cfrom :: forall x. EscrowError -&gt; Rep EscrowError x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973413"><span id="local-6989586621680973415"><span id="local-6989586621680973417"><span id="local-6989586621680973419"><span class="annot"><span class="annottext">[EscrowError] -&gt; Encoding
[EscrowError] -&gt; Value
EscrowError -&gt; Encoding
EscrowError -&gt; Value
(EscrowError -&gt; Value)
-&gt; (EscrowError -&gt; Encoding)
-&gt; ([EscrowError] -&gt; Value)
-&gt; ([EscrowError] -&gt; Encoding)
-&gt; ToJSON EscrowError
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [EscrowError] -&gt; Encoding
$ctoEncodingList :: [EscrowError] -&gt; Encoding
toJSONList :: [EscrowError] -&gt; Value
$ctoJSONList :: [EscrowError] -&gt; Value
toEncoding :: EscrowError -&gt; Encoding
$ctoEncoding :: EscrowError -&gt; Encoding
toJSON :: EscrowError -&gt; Value
$ctoJSON :: EscrowError -&gt; Value
</span><a href="#local-6989586621680973413"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973409"><span id="local-6989586621680973411"><span class="annot"><span class="annottext">Value -&gt; Parser [EscrowError]
Value -&gt; Parser EscrowError
(Value -&gt; Parser EscrowError)
-&gt; (Value -&gt; Parser [EscrowError]) -&gt; FromJSON EscrowError
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [EscrowError]
$cparseJSONList :: Value -&gt; Parser [EscrowError]
parseJSON :: Value -&gt; Parser EscrowError
$cparseJSON :: Value -&gt; Parser EscrowError
</span><a href="#local-6989586621680973409"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span id="_EContractError"><span id="_RefundFailed"><span id="_RedeemFailed"><span id="_EscrowError"><span id="local-6989586621680973398"><span id="local-6989586621680973400"><span id="local-6989586621680973402"><span id="local-6989586621680973404"><span id="local-6989586621680973406"><span id="local-6989586621680973407"><span id="local-6989586621680973408"><span id="AsEscrowError"><span id="local-6989586621680973848"><span class="hs-identifier">makeClassyPrisms</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">EscrowError</span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680973372"><span id="local-6989586621680973374"><span id="local-6989586621680973376"><span id="local-6989586621680973378"><span id="local-6989586621680973380"><span id="local-6989586621680973382"><span id="local-6989586621680973384"><span id="local-6989586621680973386"><span id="local-6989586621680973388"><span id="local-6989586621680973390"><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier hs-type">EscrowError</span></a></span></span></span></span></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-98"></span><span>    </span><span id="local-6989586621680973370"><span class="annot"><span class="annottext">_ContractError :: p ContractError (f ContractError) -&gt; p EscrowError (f EscrowError)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">_ContractError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p ContractError (f ContractError) -&gt; p EscrowError (f EscrowError)
forall r. AsEscrowError r =&gt; Prism' r ContractError
</span><a href="Plutus.Contracts.Escrow.html#_EContractError"><span class="hs-identifier hs-var">_EContractError</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- $escrow</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- The escrow contract implements the exchange of value between multiple</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- parties. It is defined by a list of targets (public keys and script</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- addresses, each associated with a value). It works similar to the</span><span>
</span><span id="line-104"></span><span class="hs-comment">-- crowdfunding contract in that the contributions can be made independently,</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- and the funds can be unlocked only by a transaction that pays the correct</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- amount to each target. A refund is possible if the outputs locked by the</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- contract have not been spent by the deadline. (Compared to the crowdfunding</span><span>
</span><span id="line-108"></span><span class="hs-comment">-- contract, the refund policy is simpler because here because there is no</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- &quot;collection period&quot; during which the outputs may be spent after the deadline</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- has passed. This is because we're assuming that the participants in the</span><span>
</span><span id="line-111"></span><span class="hs-comment">-- escrow contract will make their deposits as quickly as possible after</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- agreeing on a deal)</span><span>
</span><span id="line-113"></span><span class="hs-comment">--</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- The contract supports two modes of operation, manual and automatic. In</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- manual mode, all actions are driven by endpoints that exposed via 'payEp'</span><span>
</span><span id="line-116"></span><span class="hs-comment">-- 'redeemEp' and 'refundEp'. In automatic mode, the 'pay', 'redeem' and</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- 'refund'actions start immediately. This mode is useful when the escrow is</span><span>
</span><span id="line-118"></span><span class="hs-comment">-- called from within another contract, for example during setup (collection of</span><span>
</span><span id="line-119"></span><span class="hs-comment">-- the initial deposits).</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-comment">-- | Defines where the money should go. Usually we have `d = Datum` (when</span><span>
</span><span id="line-122"></span><span class="hs-comment">--   defining `EscrowTarget` values in off-chain code). Sometimes we have</span><span>
</span><span id="line-123"></span><span class="hs-comment">--   `d = DatumHash` (when checking the hashes in on-chain code)</span><span>
</span><span id="line-124"></span><span class="hs-keyword">data</span><span> </span><span id="EscrowTarget"><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier hs-var">EscrowTarget</span></a></span></span><span> </span><span id="local-6989586621680973765"><span class="annot"><a href="#local-6989586621680973765"><span class="hs-identifier hs-type">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-125"></span><span>    </span><span id="PaymentPubKeyTarget"><span class="annot"><a href="Plutus.Contracts.Escrow.html#PaymentPubKeyTarget"><span class="hs-identifier hs-var">PaymentPubKeyTarget</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="ScriptTarget"><span class="annot"><a href="Plutus.Contracts.Escrow.html#ScriptTarget"><span class="hs-identifier hs-var">ScriptTarget</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">ValidatorHash</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973765"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973363"><span id="local-6989586621680973365"><span class="annot"><span class="annottext">a -&gt; EscrowTarget b -&gt; EscrowTarget a
(a -&gt; b) -&gt; EscrowTarget a -&gt; EscrowTarget b
(forall a b. (a -&gt; b) -&gt; EscrowTarget a -&gt; EscrowTarget b)
-&gt; (forall a b. a -&gt; EscrowTarget b -&gt; EscrowTarget a)
-&gt; Functor EscrowTarget
forall a b. a -&gt; EscrowTarget b -&gt; EscrowTarget a
forall a b. (a -&gt; b) -&gt; EscrowTarget a -&gt; EscrowTarget b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; EscrowTarget b -&gt; EscrowTarget a
$c&lt;$ :: forall a b. a -&gt; EscrowTarget b -&gt; EscrowTarget a
fmap :: (a -&gt; b) -&gt; EscrowTarget a -&gt; EscrowTarget b
$cfmap :: forall a b. (a -&gt; b) -&gt; EscrowTarget a -&gt; EscrowTarget b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Functor</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span id="local-6989586621680973358"><span id="local-6989586621680973360"><span id="local-6989586621680973765"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">EscrowTarget</span></span></span></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | An 'EscrowTarget' that pays the value to a public key address.</span><span>
</span><span id="line-132"></span><span id="local-6989586621680973353"><span class="annot"><a href="Plutus.Contracts.Escrow.html#payToPaymentPubKeyTarget"><span class="hs-identifier hs-type">payToPaymentPubKeyTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier hs-type">EscrowTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973353"><span class="hs-identifier hs-type">d</span></a></span></span><span>
</span><span id="line-133"></span><span id="payToPaymentPubKeyTarget"><span class="annot"><span class="annottext">payToPaymentPubKeyTarget :: PaymentPubKeyHash -&gt; Value -&gt; EscrowTarget d
</span><a href="Plutus.Contracts.Escrow.html#payToPaymentPubKeyTarget"><span class="hs-identifier hs-var hs-var">payToPaymentPubKeyTarget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; Value -&gt; EscrowTarget d
forall d. PaymentPubKeyHash -&gt; Value -&gt; EscrowTarget d
</span><a href="Plutus.Contracts.Escrow.html#PaymentPubKeyTarget"><span class="hs-identifier hs-var">PaymentPubKeyTarget</span></a></span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span class="hs-comment">-- | An 'EscrowTarget' that pays the value to a script address, with the</span><span>
</span><span id="line-136"></span><span class="hs-comment">--   given data script.</span><span>
</span><span id="line-137"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#payToScriptTarget"><span class="hs-identifier hs-type">payToScriptTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">ValidatorHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier hs-type">EscrowTarget</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-138"></span><span id="payToScriptTarget"><span class="annot"><span class="annottext">payToScriptTarget :: ValidatorHash -&gt; Datum -&gt; Value -&gt; EscrowTarget Datum
</span><a href="Plutus.Contracts.Escrow.html#payToScriptTarget"><span class="hs-identifier hs-var hs-var">payToScriptTarget</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValidatorHash -&gt; Datum -&gt; Value -&gt; EscrowTarget Datum
forall d. ValidatorHash -&gt; d -&gt; Value -&gt; EscrowTarget d
</span><a href="Plutus.Contracts.Escrow.html#ScriptTarget"><span class="hs-identifier hs-var">ScriptTarget</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">-- | Definition of an escrow contract, consisting of a deadline and a list of targets</span><span>
</span><span id="line-141"></span><span class="hs-keyword">data</span><span> </span><span id="EscrowParams"><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-var">EscrowParams</span></a></span></span><span> </span><span id="local-6989586621680973739"><span class="annot"><a href="#local-6989586621680973739"><span class="hs-identifier hs-type">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-142"></span><span>    </span><span id="EscrowParams"><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-var">EscrowParams</span></a></span></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="escrowDeadline"><span class="annot"><span class="annottext">EscrowParams d -&gt; POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-comment">-- ^ Latest point at which the outputs may be spent.</span><span>
</span><span id="line-145"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="escrowTargets"><span class="annot"><span class="annottext">EscrowParams d -&gt; [EscrowTarget d]
</span><a href="Plutus.Contracts.Escrow.html#escrowTargets"><span class="hs-identifier hs-var hs-var">escrowTargets</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier hs-type">EscrowTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973739"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-146"></span><span>        </span><span class="hs-comment">-- ^ Where the money should go. For each target, the contract checks that</span><span>
</span><span id="line-147"></span><span>        </span><span class="hs-comment">--   the output 'mkTxOutput' of the target is present in the spending</span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-comment">--   transaction.</span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973346"><span id="local-6989586621680973348"><span class="annot"><span class="annottext">a -&gt; EscrowParams b -&gt; EscrowParams a
(a -&gt; b) -&gt; EscrowParams a -&gt; EscrowParams b
(forall a b. (a -&gt; b) -&gt; EscrowParams a -&gt; EscrowParams b)
-&gt; (forall a b. a -&gt; EscrowParams b -&gt; EscrowParams a)
-&gt; Functor EscrowParams
forall a b. a -&gt; EscrowParams b -&gt; EscrowParams a
forall a b. (a -&gt; b) -&gt; EscrowParams a -&gt; EscrowParams b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: a -&gt; EscrowParams b -&gt; EscrowParams a
$c&lt;$ :: forall a b. a -&gt; EscrowParams b -&gt; EscrowParams a
fmap :: (a -&gt; b) -&gt; EscrowParams a -&gt; EscrowParams b
$cfmap :: forall a b. (a -&gt; b) -&gt; EscrowParams a -&gt; EscrowParams b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Functor</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span id="local-6989586621680973342"><span id="local-6989586621680973344"><span id="local-6989586621680973739"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">EscrowParams</span></span></span></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="hs-comment">-- | The total 'Value' that must be paid into the escrow contract</span><span>
</span><span id="line-154"></span><span class="hs-comment">--   before it can be unlocked</span><span>
</span><span id="line-155"></span><span id="local-6989586621680973552"><span class="annot"><a href="Plutus.Contracts.Escrow.html#targetTotal"><span class="hs-identifier hs-type">targetTotal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973552"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span></span><span>
</span><span id="line-156"></span><span id="targetTotal"><span class="annot"><span class="annottext">targetTotal :: EscrowParams d -&gt; Value
</span><a href="Plutus.Contracts.Escrow.html#targetTotal"><span class="hs-identifier hs-var hs-var">targetTotal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Value -&gt; EscrowTarget d -&gt; Value)
-&gt; Value -&gt; [EscrowTarget d] -&gt; Value
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Haskell.foldl</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621680973340"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973340"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span id="local-6989586621680973339"><span class="annot"><span class="annottext">EscrowTarget d
</span><a href="#local-6989586621680973339"><span class="hs-identifier hs-var">tgt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973340"><span class="hs-identifier hs-var">vl</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowTarget d -&gt; Value
forall d. EscrowTarget d -&gt; Value
</span><a href="Plutus.Contracts.Escrow.html#targetValue"><span class="hs-identifier hs-var">targetValue</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowTarget d
</span><a href="#local-6989586621680973339"><span class="hs-identifier hs-var">tgt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value
forall a. Monoid a =&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">mempty</span></a></span><span> </span><span class="annot"><span class="annottext">([EscrowTarget d] -&gt; Value)
-&gt; (EscrowParams d -&gt; [EscrowTarget d]) -&gt; EscrowParams d -&gt; Value
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams d -&gt; [EscrowTarget d]
forall d. EscrowParams d -&gt; [EscrowTarget d]
</span><a href="Plutus.Contracts.Escrow.html#escrowTargets"><span class="hs-identifier hs-var hs-var">escrowTargets</span></a></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span class="hs-comment">-- | The 'Value' specified by an 'EscrowTarget'</span><span>
</span><span id="line-159"></span><span id="local-6989586621680973745"><span class="annot"><a href="Plutus.Contracts.Escrow.html#targetValue"><span class="hs-identifier hs-type">targetValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier hs-type">EscrowTarget</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973745"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span></span><span>
</span><span id="line-160"></span><span id="targetValue"><span class="annot"><span class="annottext">targetValue :: EscrowTarget d -&gt; Value
</span><a href="Plutus.Contracts.Escrow.html#targetValue"><span class="hs-identifier hs-var hs-var">targetValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#PaymentPubKeyTarget"><span class="hs-identifier hs-type">PaymentPubKeyTarget</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680973334"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973334"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973334"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#ScriptTarget"><span class="hs-identifier hs-type">ScriptTarget</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680973333"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973333"><span class="hs-identifier hs-var">vl</span></a></span></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973333"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span class="hs-comment">-- | Create a 'Ledger.TxOut' value for the target</span><span>
</span><span id="line-165"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#mkTx"><span class="hs-identifier hs-type">mkTx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier hs-type">EscrowTarget</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span>
</span><span id="line-166"></span><span id="mkTx"><span class="annot"><span class="annottext">mkTx :: EscrowTarget Datum -&gt; TxConstraints Action PaymentPubKeyHash
</span><a href="Plutus.Contracts.Escrow.html#mkTx"><span class="hs-identifier hs-var hs-var">mkTx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-167"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#PaymentPubKeyTarget"><span class="hs-identifier hs-type">PaymentPubKeyTarget</span></a></span><span> </span><span id="local-6989586621680973331"><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973331"><span class="hs-identifier hs-var">pkh</span></a></span></span><span> </span><span id="local-6989586621680973330"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973330"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>        </span><span class="annot"><span class="annottext">PaymentPubKeyHash
-&gt; Value -&gt; TxConstraints Action PaymentPubKeyHash
forall i o. PaymentPubKeyHash -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustPayToPubKey</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973331"><span class="hs-identifier hs-var">pkh</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973330"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#ScriptTarget"><span class="hs-identifier hs-type">ScriptTarget</span></a></span><span> </span><span id="local-6989586621680973328"><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680973328"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span id="local-6989586621680973327"><span class="annot"><span class="annottext">Datum
</span><a href="#local-6989586621680973327"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621680973326"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973326"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="annottext">ValidatorHash
-&gt; Datum -&gt; Value -&gt; TxConstraints Action PaymentPubKeyHash
forall i o. ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustPayToOtherScriptWithDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680973328"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="#local-6989586621680973327"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973326"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-171"></span><span>        </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Datum -&gt; TxConstraints Action PaymentPubKeyHash
forall i o. Datum -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustIncludeDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="#local-6989586621680973327"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="hs-keyword">data</span><span> </span><span id="Action"><span class="annot"><a href="Plutus.Contracts.Escrow.html#Action"><span class="hs-identifier hs-var">Action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Redeem"><span class="annot"><a href="Plutus.Contracts.Escrow.html#Redeem"><span class="hs-identifier hs-var">Redeem</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Refund"><span class="annot"><a href="Plutus.Contracts.Escrow.html#Refund"><span class="hs-identifier hs-var">Refund</span></a></span></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-keyword">data</span><span> </span><span id="Escrow"><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-var">Escrow</span></a></span></span><span>
</span><span id="line-176"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">Scripts.ValidatorTypes</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="RedeemerType"><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">RedeemerType</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">instance</span><span> </span><span id="DatumType"><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">DatumType</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span id="local-6989586621680973315"><span id="local-6989586621680973317"><span id="local-6989586621680973319"><span class="hs-identifier">PlutusTx.unstableMakeIsData</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Action</span></span></span></span><span>
</span><span id="line-181"></span><span id="local-6989586621680973305"><span id="local-6989586621680973307"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Action</span></span></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#meetsTarget"><span class="hs-pragma hs-type">meetsTarget</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-184"></span><span class="hs-comment">-- | @ptx `meetsTarget` tgt@ if @ptx@ pays at least @targetValue tgt@ to the</span><span>
</span><span id="line-185"></span><span class="hs-comment">--   target address.</span><span>
</span><span id="line-186"></span><span class="hs-comment">--</span><span>
</span><span id="line-187"></span><span class="hs-comment">--   The reason why this does not require the target amount to be equal</span><span>
</span><span id="line-188"></span><span class="hs-comment">--   to the actual amount is to enable any excess funds consumed by the</span><span>
</span><span id="line-189"></span><span class="hs-comment">--   spending transaction to be paid to target addresses. This may happen if</span><span>
</span><span id="line-190"></span><span class="hs-comment">--   the target address is also used as a change address for the spending</span><span>
</span><span id="line-191"></span><span class="hs-comment">--   transaction, and allowing the target to be exceed prevents outsiders from</span><span>
</span><span id="line-192"></span><span class="hs-comment">--   poisoning the contract by adding arbitrary outputs to the script address.</span><span>
</span><span id="line-193"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#meetsTarget"><span class="hs-identifier hs-type">meetsTarget</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowTarget"><span class="hs-identifier hs-type">EscrowTarget</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">DatumHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-194"></span><span id="meetsTarget"><span class="annot"><span class="annottext">meetsTarget :: TxInfo -&gt; EscrowTarget DatumHash -&gt; Bool
</span><a href="Plutus.Contracts.Escrow.html#meetsTarget"><span class="hs-identifier hs-var hs-var">meetsTarget</span></a></span></span><span> </span><span id="local-6989586621680973303"><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680973303"><span class="hs-identifier hs-var">ptx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#PaymentPubKeyTarget"><span class="hs-identifier hs-type">PaymentPubKeyTarget</span></a></span><span> </span><span id="local-6989586621680973302"><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973302"><span class="hs-identifier hs-var">pkh</span></a></span></span><span> </span><span id="local-6989586621680973301"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973301"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>        </span><span class="annot"><span class="annottext">TxInfo -&gt; PubKeyHash -&gt; Value
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">valuePaidTo</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680973303"><span class="hs-identifier hs-var">ptx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; PubKeyHash
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">unPaymentPubKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973302"><span class="hs-identifier hs-var">pkh</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`geq`</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973301"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#ScriptTarget"><span class="hs-identifier hs-type">ScriptTarget</span></a></span><span> </span><span id="local-6989586621680973300"><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680973300"><span class="hs-identifier hs-var">validatorHash</span></a></span></span><span> </span><span id="local-6989586621680973299"><span class="annot"><span class="annottext">DatumHash
</span><a href="#local-6989586621680973299"><span class="hs-identifier hs-var">dataValue</span></a></span></span><span> </span><span id="local-6989586621680973298"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973298"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ValidatorHash -&gt; TxInfo -&gt; [(DatumHash, Value)]
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">scriptOutputsAt</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680973300"><span class="hs-identifier hs-var">validatorHash</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680973303"><span class="hs-identifier hs-var">ptx</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-199"></span><span>            </span><span class="hs-special">[</span><span class="hs-special">(</span><span id="local-6989586621680973297"><span class="annot"><span class="annottext">DatumHash
</span><a href="#local-6989586621680973297"><span class="hs-identifier hs-var">dataValue'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973296"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973296"><span class="hs-identifier hs-var">vl'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>                </span><span class="annot"><span class="annottext">BuiltinString -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceIfFalse</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;dataValue&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DatumHash
</span><a href="#local-6989586621680973297"><span class="hs-identifier hs-var">dataValue'</span></a></span><span> </span><span class="annot"><span class="annottext">DatumHash -&gt; DatumHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">DatumHash
</span><a href="#local-6989586621680973299"><span class="hs-identifier hs-var">dataValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceIfFalse</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;value&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973296"><span class="hs-identifier hs-var">vl'</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`geq`</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973298"><span class="hs-identifier hs-var">vl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>            </span><span class="annot"><span class="annottext">[(DatumHash, Value)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#validate"><span class="hs-pragma hs-type">validate</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-205"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#validate"><span class="hs-identifier hs-type">validate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">DatumHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Action"><span class="hs-identifier hs-type">Action</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">ScriptContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-206"></span><span id="validate"><span class="annot"><span class="annottext">validate :: EscrowParams DatumHash
-&gt; PaymentPubKeyHash -&gt; Action -&gt; ScriptContext -&gt; Bool
</span><a href="Plutus.Contracts.Escrow.html#validate"><span class="hs-identifier hs-var hs-var">validate</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span class="hs-special">{</span><span id="local-6989586621680973291"><span class="annot"><span class="annottext">POSIXTime
escrowDeadline :: POSIXTime
escrowDeadline :: forall d. EscrowParams d -&gt; POSIXTime
</span><a href="#local-6989586621680973291"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973290"><span class="annot"><span class="annottext">[EscrowTarget DatumHash]
escrowTargets :: [EscrowTarget DatumHash]
escrowTargets :: forall d. EscrowParams d -&gt; [EscrowTarget d]
</span><a href="#local-6989586621680973290"><span class="hs-identifier hs-var hs-var">escrowTargets</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680973289"><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973289"><span class="hs-identifier hs-var">contributor</span></a></span></span><span> </span><span id="local-6989586621680973288"><span class="annot"><span class="annottext">Action
</span><a href="#local-6989586621680973288"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">ScriptContext</span></a></span><span class="hs-special">{</span><span id="local-6989586621680973286"><span class="annot"><span class="annottext">TxInfo
scriptContextTxInfo :: ScriptContext -&gt; TxInfo
scriptContextTxInfo :: TxInfo
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">scriptContextTxInfo</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Action
</span><a href="#local-6989586621680973288"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-208"></span><span>        </span><span class="annot"><span class="annottext">Action
</span><a href="Plutus.Contracts.Escrow.html#Redeem"><span class="hs-identifier hs-var">Redeem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>            </span><span class="annot"><span class="annottext">BuiltinString -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceIfFalse</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;escrowDeadline-after&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680973291"><span class="hs-identifier hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; Interval POSIXTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; Interval a -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`after`</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo -&gt; Interval POSIXTime
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">txInfoValidRange</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680973286"><span class="hs-identifier hs-var">scriptContextTxInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceIfFalse</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;meetsTarget&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EscrowTarget DatumHash -&gt; Bool)
-&gt; [EscrowTarget DatumHash] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">all</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxInfo -&gt; EscrowTarget DatumHash -&gt; Bool
</span><a href="Plutus.Contracts.Escrow.html#meetsTarget"><span class="hs-identifier hs-var">meetsTarget</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680973286"><span class="hs-identifier hs-var">scriptContextTxInfo</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EscrowTarget DatumHash]
</span><a href="#local-6989586621680973290"><span class="hs-identifier hs-var">escrowTargets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>        </span><span class="annot"><span class="annottext">Action
</span><a href="Plutus.Contracts.Escrow.html#Refund"><span class="hs-identifier hs-var">Refund</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-212"></span><span>            </span><span class="annot"><span class="annottext">BuiltinString -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceIfFalse</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;escrowDeadline-before&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680973291"><span class="hs-identifier hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; POSIXTime
forall a. AdditiveGroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; Interval POSIXTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; Interval a -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`before`</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo -&gt; Interval POSIXTime
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">txInfoValidRange</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680973286"><span class="hs-identifier hs-var">scriptContextTxInfo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceIfFalse</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;txSignedBy&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680973286"><span class="hs-identifier hs-var">scriptContextTxInfo</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo -&gt; PubKeyHash -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`txSignedBy`</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; PubKeyHash
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">unPaymentPubKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973289"><span class="hs-identifier hs-var">contributor</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-type">typedValidator</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">Scripts.TypedValidator</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span>
</span><span id="line-216"></span><span id="typedValidator"><span class="annot"><span class="annottext">typedValidator :: EscrowParams Datum -&gt; TypedValidator Escrow
</span><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-var hs-var">typedValidator</span></a></span></span><span> </span><span id="local-6989586621680973281"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973281"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EscrowParams DatumHash -&gt; TypedValidator Escrow
</span><a href="#local-6989586621680973280"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Datum -&gt; DatumHash)
-&gt; EscrowParams Datum -&gt; EscrowParams DatumHash
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Haskell.fmap</span></a></span><span> </span><span class="annot"><span class="annottext">Datum -&gt; DatumHash
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">datumHash</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973281"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-217"></span><span>    </span><span id="local-6989586621680973280"><span class="annot"><span class="annottext">go :: EscrowParams DatumHash -&gt; TypedValidator Escrow
</span><a href="#local-6989586621680973280"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompiledCode (EscrowParams DatumHash -&gt; ValidatorType Escrow)
-&gt; CompiledCode (ValidatorType Escrow -&gt; UntypedValidator)
-&gt; EscrowParams DatumHash
-&gt; TypedValidator Escrow
forall a param.
Lift DefaultUni param =&gt;
CompiledCode (param -&gt; ValidatorType a)
-&gt; CompiledCode (ValidatorType a -&gt; UntypedValidator)
-&gt; param
-&gt; TypedValidator a
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.mkTypedValidatorParam</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-special">$$(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.compile</span></a></span><span> </span><span class="hs-special">[||</span><span> </span><span class="hs-identifier">validate</span><span> </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-special">$$(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.compile</span></a></span><span> </span><span class="hs-special">[||</span><span> </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><span id="line-220"></span><span>    </span><span id="local-6989586621680973275"><span class="annot"><span class="annottext">wrap :: (PaymentPubKeyHash -&gt; Action -&gt; ScriptContext -&gt; Bool)
-&gt; UntypedValidator
</span><a href="#local-6989586621680973275"><span class="hs-identifier hs-var hs-var">wrap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PaymentPubKeyHash -&gt; Action -&gt; ScriptContext -&gt; Bool)
-&gt; UntypedValidator
forall sc d r.
(IsScriptContext sc, UnsafeFromData d, UnsafeFromData r) =&gt;
(d -&gt; r -&gt; sc -&gt; Bool) -&gt; UntypedValidator
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.mkUntypedValidator</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#escrowContract"><span class="hs-identifier hs-type">escrowContract</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-224"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowSchema"><span class="hs-identifier hs-type">EscrowSchema</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier hs-type">EscrowError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span id="escrowContract"><span class="annot"><span class="annottext">escrowContract :: EscrowParams Datum -&gt; Contract () EscrowSchema EscrowError ()
</span><a href="Plutus.Contracts.Escrow.html#escrowContract"><span class="hs-identifier hs-var hs-var">escrowContract</span></a></span></span><span> </span><span id="local-6989586621680973273"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973273"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973272"><span class="annot"><span class="annottext">inst :: TypedValidator Escrow
</span><a href="#local-6989586621680973272"><span class="hs-identifier hs-var hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; TypedValidator Escrow
</span><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973273"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-227"></span><span>        </span><span id="local-6989586621680973271"><span class="annot"><span class="annottext">payAndRefund :: Promise
  ()
  ('R
     '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
        &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
        &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
  EscrowError
  RefundSuccess
</span><a href="#local-6989586621680973271"><span class="hs-identifier hs-var hs-var">payAndRefund</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a w (s :: Row *) e b.
(HasEndpoint &quot;pay-escrow&quot; a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;pay-escrow&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value
  -&gt; Contract
       ()
       ('R
          '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
             &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
             &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
       EscrowError
       RefundSuccess)
 -&gt; Promise
      ()
      ('R
         '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
            &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
            &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
      EscrowError
      RefundSuccess)
-&gt; (Value
    -&gt; Contract
         ()
         ('R
            '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
               &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
               &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
         EscrowError
         RefundSuccess)
-&gt; Promise
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     RefundSuccess
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680973268"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973268"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>            </span><span class="annot"><span class="annottext">TxId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum
-&gt; Value
-&gt; Contract
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     TxId
forall w (s :: Row *) e.
AsContractError e =&gt;
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s e TxId
</span><a href="Plutus.Contracts.Escrow.html#pay"><span class="hs-identifier hs-var">pay</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973272"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973273"><span class="hs-identifier hs-var">escrow</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973268"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-229"></span><span>            </span><span class="annot"><span class="annottext">POSIXTime
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">POSIXTime
-&gt; Contract
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     POSIXTime
forall w (s :: Row *) e.
AsContractError e =&gt;
POSIXTime -&gt; Contract w s e POSIXTime
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">awaitTime</span></a></span><span> </span><span class="annot"><span class="annottext">(POSIXTime
 -&gt; Contract
      ()
      ('R
         '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
            &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
            &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
      EscrowError
      POSIXTime)
-&gt; POSIXTime
-&gt; Contract
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     POSIXTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; POSIXTime
forall d. EscrowParams d -&gt; POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973273"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-230"></span><span>            </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum
-&gt; Contract
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     RefundSuccess
forall w (s :: Row *).
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RefundSuccess
</span><a href="Plutus.Contracts.Escrow.html#refund"><span class="hs-identifier hs-var">refund</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973272"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973273"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Promise
   ()
   ('R
      '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
         &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
         &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
   EscrowError
   ()]
-&gt; Contract
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     ()
forall w (s :: Row *) e a. [Promise w s e a] -&gt; Contract w s e a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">selectList</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
        &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
        &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
  EscrowError
  RefundSuccess
-&gt; Promise
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
        &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
        &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
  EscrowError
  RefundSuccess
</span><a href="#local-6989586621680973271"><span class="hs-identifier hs-var">payAndRefund</span></a></span><span>
</span><span id="line-233"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
        &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
        &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
  EscrowError
  RedeemSuccess
-&gt; Promise
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Promise
   ()
   ('R
      '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
         &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
         &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
   EscrowError
   RedeemSuccess
 -&gt; Promise
      ()
      ('R
         '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
            &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
            &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
      EscrowError
      ())
-&gt; Promise
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     RedeemSuccess
-&gt; Promise
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
-&gt; Promise
     ()
     ('R
        '[ &quot;pay-escrow&quot; ':-&gt; (EndpointValue Value, ActiveEndpoint),
           &quot;redeem-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint),
           &quot;refund-escrow&quot; ':-&gt; (EndpointValue (), ActiveEndpoint)])
     EscrowError
     RedeemSuccess
forall w (s :: Row *) e.
(HasEndpoint &quot;redeem-escrow&quot; () s, AsEscrowError e) =&gt;
EscrowParams Datum -&gt; Promise w s e RedeemSuccess
</span><a href="Plutus.Contracts.Escrow.html#redeemEp"><span class="hs-identifier hs-var">redeemEp</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973273"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="hs-comment">-- | 'pay' with an endpoint that gets the owner's public key and the</span><span>
</span><span id="line-237"></span><span class="hs-comment">--   contribution.</span><span>
</span><span id="line-238"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#payEp"><span class="hs-identifier hs-type">payEp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-239"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680973265"><span class="annot"><a href="#local-6989586621680973265"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680973264"><span class="annot"><a href="#local-6989586621680973264"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680973263"><span class="annot"><a href="#local-6989586621680973263"><span class="hs-identifier hs-type">e</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-240"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;pay-escrow&quot;</span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973264"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#AsEscrowError"><span class="hs-identifier hs-type">AsEscrowError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973263"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973265"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973264"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973263"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxId</span></a></span><span>
</span><span id="line-245"></span><span id="payEp"><span class="annot"><span class="annottext">payEp :: EscrowParams Datum -&gt; Promise w s e TxId
</span><a href="Plutus.Contracts.Escrow.html#payEp"><span class="hs-identifier hs-var hs-var">payEp</span></a></span></span><span> </span><span id="local-6989586621680973262"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973262"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Contract w s ContractError TxId -&gt; Contract w s e TxId)
-&gt; Promise w s ContractError TxId -&gt; Promise w s e TxId
forall w1 (s1 :: Row *) e1 a1 w2 (s2 :: Row *) e2 a2.
(Contract w1 s1 e1 a1 -&gt; Contract w2 s2 e2 a2)
-&gt; Promise w1 s1 e1 a1 -&gt; Promise w2 s2 e2 a2
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">promiseMap</span></a></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ContractError -&gt; e)
-&gt; Contract w s ContractError TxId -&gt; Contract w s e TxId
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e ContractError -&gt; ContractError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e ContractError
forall r. AsEscrowError r =&gt; Prism' r ContractError
</span><a href="Plutus.Contracts.Escrow.html#_EContractError"><span class="hs-identifier hs-var">_EContractError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a w (s :: Row *) e b.
(HasEndpoint &quot;pay-escrow&quot; a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;pay-escrow&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; Contract w s ContractError TxId)
 -&gt; Promise w s ContractError TxId)
-&gt; (Value -&gt; Contract w s ContractError TxId)
-&gt; Promise w s ContractError TxId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s ContractError TxId
forall w (s :: Row *) e.
AsContractError e =&gt;
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s e TxId
</span><a href="Plutus.Contracts.Escrow.html#pay"><span class="hs-identifier hs-var">pay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; TypedValidator Escrow
</span><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973262"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973262"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>
</span><span id="line-249"></span><span class="hs-comment">-- | Pay some money into the escrow contract.</span><span>
</span><span id="line-250"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#pay"><span class="hs-identifier hs-type">pay</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-251"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680973667"><span class="annot"><a href="#local-6989586621680973667"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680973666"><span class="annot"><a href="#local-6989586621680973666"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680973668"><span class="annot"><a href="#local-6989586621680973668"><span class="hs-identifier hs-type">e</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-252"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973668"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">TypedValidator</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-comment">-- ^ The instance</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-257"></span><span>    </span><span class="hs-comment">-- ^ The escrow contract</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-comment">-- ^ How much money to pay in</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973667"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973666"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973668"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxId</span></a></span><span>
</span><span id="line-261"></span><span id="pay"><span class="annot"><span class="annottext">pay :: TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s e TxId
</span><a href="Plutus.Contracts.Escrow.html#pay"><span class="hs-identifier hs-var hs-var">pay</span></a></span></span><span> </span><span id="local-6989586621680973259"><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973259"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span id="local-6989586621680973258"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973258"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span id="local-6989586621680973257"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973257"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>    </span><span id="local-6989586621680973256"><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973256"><span class="hs-identifier hs-var">pk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract w s e PaymentPubKeyHash
forall w (s :: Row *) e.
AsContractError e =&gt;
Contract w s e PaymentPubKeyHash
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">ownFirstPaymentPubKeyHash</span></a></span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973254"><span class="annot"><span class="annottext">tx :: TxConstraints Action PaymentPubKeyHash
</span><a href="#local-6989586621680973254"><span class="hs-identifier hs-var hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
-&gt; Value -&gt; TxConstraints Action PaymentPubKeyHash
forall o i. o -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustPayToTheScriptWithDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973256"><span class="hs-identifier hs-var">pk</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973257"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-264"></span><span>          </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityInterval POSIXTime
-&gt; TxConstraints Action PaymentPubKeyHash
forall i o. ValidityInterval POSIXTime -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustValidateInTimeRange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; ValidityInterval POSIXTime
forall a. a -&gt; a -&gt; ValidityInterval a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Interval.interval</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; POSIXTime
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; POSIXTime
forall d. EscrowParams d -&gt; POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973258"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">ScriptLookups Escrow
-&gt; TxConstraints (RedeemerType Escrow) (DatumType Escrow)
-&gt; Contract w s e UnbalancedTx
forall a w (s :: Row *) e.
(ToData (RedeemerType a), FromData (DatumType a),
 ToData (DatumType a), AsContractError e) =&gt;
ScriptLookups a
-&gt; TxConstraints (RedeemerType a) (DatumType a)
-&gt; Contract w s e UnbalancedTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mkTxConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypedValidator Escrow -&gt; ScriptLookups Escrow
forall a. TypedValidator a -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.typedValidatorLookups</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973259"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxConstraints (RedeemerType Escrow) (DatumType Escrow)
TxConstraints Action PaymentPubKeyHash
</span><a href="#local-6989586621680973254"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-266"></span><span>        </span><span class="annot"><span class="annottext">Contract w s e UnbalancedTx
-&gt; (UnbalancedTx -&gt; Contract w s e UnbalancedTx)
-&gt; Contract w s e UnbalancedTx
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w s e UnbalancedTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e UnbalancedTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">adjustUnbalancedTx</span></a></span><span>
</span><span id="line-267"></span><span>        </span><span class="annot"><span class="annottext">Contract w s e UnbalancedTx
-&gt; (UnbalancedTx -&gt; Contract w s e CardanoTx)
-&gt; Contract w s e CardanoTx
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w s e CardanoTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e CardanoTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">submitUnbalancedTx</span></a></span><span>
</span><span id="line-268"></span><span>        </span><span class="annot"><span class="annottext">Contract w s e CardanoTx
-&gt; (CardanoTx -&gt; Contract w s e TxId) -&gt; Contract w s e TxId
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">TxId -&gt; Contract w s e TxId
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TxId -&gt; Contract w s e TxId)
-&gt; (CardanoTx -&gt; TxId) -&gt; CardanoTx -&gt; Contract w s e TxId
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoTx -&gt; TxId
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">getCardanoTxId</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="hs-keyword">newtype</span><span> </span><span id="RedeemSuccess"><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemSuccess"><span class="hs-identifier hs-var">RedeemSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RedeemSuccess"><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemSuccess"><span class="hs-identifier hs-var">RedeemSuccess</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxId</span></a></span><span>
</span><span id="line-271"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973242"><span id="local-6989586621680973244"><span class="annot"><span class="annottext">RedeemSuccess -&gt; RedeemSuccess -&gt; Bool
(RedeemSuccess -&gt; RedeemSuccess -&gt; Bool)
-&gt; (RedeemSuccess -&gt; RedeemSuccess -&gt; Bool) -&gt; Eq RedeemSuccess
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: RedeemSuccess -&gt; RedeemSuccess -&gt; Bool
$c/= :: RedeemSuccess -&gt; RedeemSuccess -&gt; Bool
== :: RedeemSuccess -&gt; RedeemSuccess -&gt; Bool
$c== :: RedeemSuccess -&gt; RedeemSuccess -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973236"><span id="local-6989586621680973238"><span id="local-6989586621680973240"><span class="annot"><span class="annottext">Int -&gt; RedeemSuccess -&gt; ShowS
[RedeemSuccess] -&gt; ShowS
RedeemSuccess -&gt; String
(Int -&gt; RedeemSuccess -&gt; ShowS)
-&gt; (RedeemSuccess -&gt; String)
-&gt; ([RedeemSuccess] -&gt; ShowS)
-&gt; Show RedeemSuccess
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RedeemSuccess] -&gt; ShowS
$cshowList :: [RedeemSuccess] -&gt; ShowS
show :: RedeemSuccess -&gt; String
$cshow :: RedeemSuccess -&gt; String
showsPrec :: Int -&gt; RedeemSuccess -&gt; ShowS
$cshowsPrec :: Int -&gt; RedeemSuccess -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="hs-comment">-- | 'redeem' with an endpoint.</span><span>
</span><span id="line-274"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#redeemEp"><span class="hs-identifier hs-type">redeemEp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-275"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680973651"><span class="annot"><a href="#local-6989586621680973651"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680973653"><span class="annot"><a href="#local-6989586621680973653"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680973652"><span class="annot"><a href="#local-6989586621680973652"><span class="hs-identifier hs-type">e</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-276"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;redeem-escrow&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680973653"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#AsEscrowError"><span class="hs-identifier hs-type">AsEscrowError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973652"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-280"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973651"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973653"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973652"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemSuccess"><span class="hs-identifier hs-type">RedeemSuccess</span></a></span><span>
</span><span id="line-281"></span><span id="redeemEp"><span class="annot"><span class="annottext">redeemEp :: EscrowParams Datum -&gt; Promise w s e RedeemSuccess
</span><a href="Plutus.Contracts.Escrow.html#redeemEp"><span class="hs-identifier hs-var hs-var">redeemEp</span></a></span></span><span> </span><span id="local-6989586621680973235"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973235"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Contract w s EscrowError RedeemSuccess
 -&gt; Contract w s e RedeemSuccess)
-&gt; Promise w s EscrowError RedeemSuccess
-&gt; Promise w s e RedeemSuccess
forall w1 (s1 :: Row *) e1 a1 w2 (s2 :: Row *) e2 a2.
(Contract w1 s1 e1 a1 -&gt; Contract w2 s2 e2 a2)
-&gt; Promise w1 s1 e1 a1 -&gt; Promise w2 s2 e2 a2
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">promiseMap</span></a></span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EscrowError -&gt; e)
-&gt; Contract w s EscrowError RedeemSuccess
-&gt; Contract w s e RedeemSuccess
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e EscrowError -&gt; EscrowError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e EscrowError
forall r. AsEscrowError r =&gt; Prism' r EscrowError
</span><a href="Plutus.Contracts.Escrow.html#_EscrowError"><span class="hs-identifier hs-var">_EscrowError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">forall a w (s :: Row *) e b.
(HasEndpoint &quot;redeem-escrow&quot; a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;redeem-escrow&quot;</span></span><span> </span><span class="annot"><span class="annottext">((() -&gt; Contract w s EscrowError RedeemSuccess)
 -&gt; Promise w s EscrowError RedeemSuccess)
-&gt; (() -&gt; Contract w s EscrowError RedeemSuccess)
-&gt; Promise w s EscrowError RedeemSuccess
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RedeemSuccess
forall w (s :: Row *) e.
AsEscrowError e =&gt;
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s e RedeemSuccess
</span><a href="Plutus.Contracts.Escrow.html#redeem"><span class="hs-identifier hs-var">redeem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; TypedValidator Escrow
</span><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973235"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973235"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>
</span><span id="line-285"></span><span class="hs-comment">-- | Redeem all outputs at the contract address using a transaction that</span><span>
</span><span id="line-286"></span><span class="hs-comment">--   has all the outputs defined in the contract's list of targets.</span><span>
</span><span id="line-287"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#redeem"><span class="hs-identifier hs-type">redeem</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680973593"><span class="annot"><a href="#local-6989586621680973593"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680973592"><span class="annot"><a href="#local-6989586621680973592"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680973594"><span class="annot"><a href="#local-6989586621680973594"><span class="hs-identifier hs-type">e</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#AsEscrowError"><span class="hs-identifier hs-type">AsEscrowError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973594"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">TypedValidator</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973593"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973592"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973594"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemSuccess"><span class="hs-identifier hs-type">RedeemSuccess</span></a></span><span>
</span><span id="line-294"></span><span id="redeem"><span class="annot"><span class="annottext">redeem :: TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s e RedeemSuccess
</span><a href="Plutus.Contracts.Escrow.html#redeem"><span class="hs-identifier hs-var hs-var">redeem</span></a></span></span><span> </span><span id="local-6989586621680973234"><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973234"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span id="local-6989586621680973233"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973233"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EscrowError -&gt; e)
-&gt; Contract w s EscrowError RedeemSuccess
-&gt; Contract w s e RedeemSuccess
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e EscrowError -&gt; EscrowError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e EscrowError
forall r. AsEscrowError r =&gt; Prism' r EscrowError
</span><a href="Plutus.Contracts.Escrow.html#_EscrowError"><span class="hs-identifier hs-var">_EscrowError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract w s EscrowError RedeemSuccess
 -&gt; Contract w s e RedeemSuccess)
-&gt; Contract w s EscrowError RedeemSuccess
-&gt; Contract w s e RedeemSuccess
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>    </span><span id="local-6989586621680973232"><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621680973232"><span class="hs-identifier hs-var">networkId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Params -&gt; NetworkId
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var hs-var">pNetworkId</span></a></span><span> </span><span class="annot"><span class="annottext">(Params -&gt; NetworkId)
-&gt; Contract w s EscrowError Params
-&gt; Contract w s EscrowError NetworkId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError Params
forall w (s :: Row *) e. AsContractError e =&gt; Contract w s e Params
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">getParams</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973229"><span class="annot"><span class="annottext">addr :: AddressInEra BabbageEra
</span><a href="#local-6989586621680973229"><span class="hs-identifier hs-var hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NetworkId -&gt; TypedValidator Escrow -&gt; AddressInEra BabbageEra
forall a. NetworkId -&gt; TypedValidator a -&gt; AddressInEra BabbageEra
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.validatorCardanoAddress</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621680973232"><span class="hs-identifier hs-var">networkId</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973234"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span id="local-6989586621680973227"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973227"><span class="hs-identifier hs-var">unspentOutputs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AddressInEra BabbageEra
-&gt; Contract w s EscrowError (Map TxOutRef DecoratedTxOut)
forall w (s :: Row *) e.
AsContractError e =&gt;
AddressInEra BabbageEra
-&gt; Contract w s e (Map TxOutRef DecoratedTxOut)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">utxosAt</span></a></span><span> </span><span class="annot"><span class="annottext">AddressInEra BabbageEra
</span><a href="#local-6989586621680973229"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-298"></span><span>    </span><span id="local-6989586621680973225"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680973225"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(POSIXTime, POSIXTime) -&gt; POSIXTime
forall a b. (a, b) -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((POSIXTime, POSIXTime) -&gt; POSIXTime)
-&gt; Contract w s EscrowError (POSIXTime, POSIXTime)
-&gt; Contract w s EscrowError POSIXTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError (POSIXTime, POSIXTime)
forall w (s :: Row *) e.
AsContractError e =&gt;
Contract w s e (POSIXTime, POSIXTime)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">currentNodeClientTimeRange</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680973225"><span class="hs-identifier hs-var">current</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; POSIXTime
forall d. EscrowParams d -&gt; POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973233"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">AReview EscrowError RedeemFailReason
-&gt; RedeemFailReason -&gt; Contract w s EscrowError RedeemSuccess
forall e (m :: * -&gt; *) t x.
MonadError e m =&gt;
AReview e t -&gt; t -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing</span></a></span><span> </span><span class="annot"><span class="annottext">AReview EscrowError RedeemFailReason
forall r. AsEscrowError r =&gt; Prism' r RedeemFailReason
</span><a href="Plutus.Contracts.Escrow.html#_RedeemFailed"><span class="hs-identifier hs-var">_RedeemFailed</span></a></span><span> </span><span class="annot"><span class="annottext">RedeemFailReason
</span><a href="Plutus.Contracts.Escrow.html#DeadlinePassed"><span class="hs-identifier hs-var">DeadlinePassed</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(DecoratedTxOut -&gt; Value) -&gt; Map TxOutRef DecoratedTxOut -&gt; Value
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting Value DecoratedTxOut Value -&gt; DecoratedTxOut -&gt; Value
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting Value DecoratedTxOut Value
Lens' DecoratedTxOut Value
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">Tx.decoratedTxOutValue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973227"><span class="hs-identifier hs-var">unspentOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`lt`</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; Value
forall d. EscrowParams d -&gt; Value
</span><a href="Plutus.Contracts.Escrow.html#targetTotal"><span class="hs-identifier hs-var">targetTotal</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973233"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">AReview EscrowError RedeemFailReason
-&gt; RedeemFailReason -&gt; Contract w s EscrowError RedeemSuccess
forall e (m :: * -&gt; *) t x.
MonadError e m =&gt;
AReview e t -&gt; t -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing</span></a></span><span> </span><span class="annot"><span class="annottext">AReview EscrowError RedeemFailReason
forall r. AsEscrowError r =&gt; Prism' r RedeemFailReason
</span><a href="Plutus.Contracts.Escrow.html#_RedeemFailed"><span class="hs-identifier hs-var">_RedeemFailed</span></a></span><span> </span><span class="annot"><span class="annottext">RedeemFailReason
</span><a href="Plutus.Contracts.Escrow.html#NotEnoughFundsAtAddress"><span class="hs-identifier hs-var">NotEnoughFundsAtAddress</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-304"></span><span>      </span><span class="hs-keyword">let</span><span>
</span><span id="line-305"></span><span>          </span><span id="local-6989586621680973220"><span class="annot"><span class="annottext">validityTimeRange :: ValidityInterval POSIXTime
</span><a href="#local-6989586621680973220"><span class="hs-identifier hs-var hs-var">validityTimeRange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; ValidityInterval POSIXTime
forall a. a -&gt; ValidityInterval a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Interval.lessThan</span></a></span><span> </span><span class="annot"><span class="annottext">(POSIXTime -&gt; ValidityInterval POSIXTime)
-&gt; POSIXTime -&gt; ValidityInterval POSIXTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime
forall a. Enum a =&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Haskell.pred</span></a></span><span> </span><span class="annot"><span class="annottext">(POSIXTime -&gt; POSIXTime) -&gt; POSIXTime -&gt; POSIXTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; POSIXTime
forall d. EscrowParams d -&gt; POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973233"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-306"></span><span>          </span><span id="local-6989586621680973217"><span class="annot"><span class="annottext">tx :: TxConstraints Action PaymentPubKeyHash
</span><a href="#local-6989586621680973217"><span class="hs-identifier hs-var hs-var">tx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
-&gt; Action -&gt; TxConstraints Action PaymentPubKeyHash
forall i o. Map TxOutRef DecoratedTxOut -&gt; i -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.collectFromTheScript</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973227"><span class="hs-identifier hs-var">unspentOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Action
</span><a href="Plutus.Contracts.Escrow.html#Redeem"><span class="hs-identifier hs-var">Redeem</span></a></span><span>
</span><span id="line-307"></span><span>                  </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">(EscrowTarget Datum -&gt; TxConstraints Action PaymentPubKeyHash)
-&gt; [EscrowTarget Datum] -&gt; TxConstraints Action PaymentPubKeyHash
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowTarget Datum -&gt; TxConstraints Action PaymentPubKeyHash
</span><a href="Plutus.Contracts.Escrow.html#mkTx"><span class="hs-identifier hs-var">mkTx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; [EscrowTarget Datum]
forall d. EscrowParams d -&gt; [EscrowTarget d]
</span><a href="Plutus.Contracts.Escrow.html#escrowTargets"><span class="hs-identifier hs-var hs-var">escrowTargets</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973233"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-308"></span><span>                  </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityInterval POSIXTime
-&gt; TxConstraints Action PaymentPubKeyHash
forall i o. ValidityInterval POSIXTime -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustValidateInTimeRange</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityInterval POSIXTime
</span><a href="#local-6989586621680973220"><span class="hs-identifier hs-var">validityTimeRange</span></a></span><span>
</span><span id="line-309"></span><span>      </span><span id="local-6989586621680973215"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973215"><span class="hs-identifier hs-var">utx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScriptLookups Escrow
-&gt; TxConstraints (RedeemerType Escrow) (DatumType Escrow)
-&gt; Contract w s EscrowError UnbalancedTx
forall a w (s :: Row *) e.
(ToData (RedeemerType a), FromData (DatumType a),
 ToData (DatumType a), AsContractError e) =&gt;
ScriptLookups a
-&gt; TxConstraints (RedeemerType a) (DatumType a)
-&gt; Contract w s e UnbalancedTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mkTxConstraints</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow -&gt; ScriptLookups Escrow
forall a. TypedValidator a -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.typedValidatorLookups</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973234"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-310"></span><span>                            </span><span class="annot"><span class="annottext">ScriptLookups Escrow
-&gt; ScriptLookups Escrow -&gt; ScriptLookups Escrow
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut -&gt; ScriptLookups Escrow
forall a. Map TxOutRef DecoratedTxOut -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.unspentOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973227"><span class="hs-identifier hs-var">unspentOutputs</span></a></span><span>
</span><span id="line-311"></span><span>                             </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxConstraints (RedeemerType Escrow) (DatumType Escrow)
TxConstraints Action PaymentPubKeyHash
</span><a href="#local-6989586621680973217"><span class="hs-identifier hs-var">tx</span></a></span><span>
</span><span id="line-312"></span><span>      </span><span id="local-6989586621680973213"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973213"><span class="hs-identifier hs-var">adjusted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w s EscrowError UnbalancedTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e UnbalancedTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">adjustUnbalancedTx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973215"><span class="hs-identifier hs-var">utx</span></a></span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">TxId -&gt; RedeemSuccess
</span><a href="Plutus.Contracts.Escrow.html#RedeemSuccess"><span class="hs-identifier hs-var">RedeemSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">(TxId -&gt; RedeemSuccess)
-&gt; (CardanoTx -&gt; TxId) -&gt; CardanoTx -&gt; RedeemSuccess
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoTx -&gt; TxId
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">getCardanoTxId</span></a></span><span> </span><span class="annot"><span class="annottext">(CardanoTx -&gt; RedeemSuccess)
-&gt; Contract w s EscrowError CardanoTx
-&gt; Contract w s EscrowError RedeemSuccess
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w s EscrowError CardanoTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e CardanoTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">submitUnbalancedTx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973213"><span class="hs-identifier hs-var">adjusted</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-keyword">newtype</span><span> </span><span id="RefundSuccess"><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier hs-var">RefundSuccess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RefundSuccess"><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier hs-var">RefundSuccess</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">TxId</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">newtype</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973208"><span id="local-6989586621680973210"><span class="annot"><span class="annottext">RefundSuccess -&gt; RefundSuccess -&gt; Bool
(RefundSuccess -&gt; RefundSuccess -&gt; Bool)
-&gt; (RefundSuccess -&gt; RefundSuccess -&gt; Bool) -&gt; Eq RefundSuccess
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: RefundSuccess -&gt; RefundSuccess -&gt; Bool
$c/= :: RefundSuccess -&gt; RefundSuccess -&gt; Bool
== :: RefundSuccess -&gt; RefundSuccess -&gt; Bool
$c== :: RefundSuccess -&gt; RefundSuccess -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973202"><span id="local-6989586621680973204"><span id="local-6989586621680973206"><span class="annot"><span class="annottext">Int -&gt; RefundSuccess -&gt; ShowS
[RefundSuccess] -&gt; ShowS
RefundSuccess -&gt; String
(Int -&gt; RefundSuccess -&gt; ShowS)
-&gt; (RefundSuccess -&gt; String)
-&gt; ([RefundSuccess] -&gt; ShowS)
-&gt; Show RefundSuccess
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [RefundSuccess] -&gt; ShowS
$cshowList :: [RefundSuccess] -&gt; ShowS
show :: RefundSuccess -&gt; String
$cshow :: RefundSuccess -&gt; String
showsPrec :: Int -&gt; RefundSuccess -&gt; ShowS
$cshowsPrec :: Int -&gt; RefundSuccess -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973198"><span id="local-6989586621680973200"><span class="annot"><span class="annottext">Rep RefundSuccess x -&gt; RefundSuccess
RefundSuccess -&gt; Rep RefundSuccess x
(forall x. RefundSuccess -&gt; Rep RefundSuccess x)
-&gt; (forall x. Rep RefundSuccess x -&gt; RefundSuccess)
-&gt; Generic RefundSuccess
forall x. Rep RefundSuccess x -&gt; RefundSuccess
forall x. RefundSuccess -&gt; Rep RefundSuccess x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
to :: Rep RefundSuccess x -&gt; RefundSuccess
$cto :: forall x. Rep RefundSuccess x -&gt; RefundSuccess
from :: RefundSuccess -&gt; Rep RefundSuccess x
$cfrom :: forall x. RefundSuccess -&gt; Rep RefundSuccess x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Generic</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680973190"><span id="local-6989586621680973192"><span id="local-6989586621680973194"><span id="local-6989586621680973196"><span class="annot"><span class="annottext">[RefundSuccess] -&gt; Encoding
[RefundSuccess] -&gt; Value
RefundSuccess -&gt; Encoding
RefundSuccess -&gt; Value
(RefundSuccess -&gt; Value)
-&gt; (RefundSuccess -&gt; Encoding)
-&gt; ([RefundSuccess] -&gt; Value)
-&gt; ([RefundSuccess] -&gt; Encoding)
-&gt; ToJSON RefundSuccess
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [RefundSuccess] -&gt; Encoding
$ctoEncodingList :: [RefundSuccess] -&gt; Encoding
toJSONList :: [RefundSuccess] -&gt; Value
$ctoJSONList :: [RefundSuccess] -&gt; Value
toEncoding :: RefundSuccess -&gt; Encoding
$ctoEncoding :: RefundSuccess -&gt; Encoding
toJSON :: RefundSuccess -&gt; Value
$ctoJSON :: RefundSuccess -&gt; Value
</span><a href="#local-6989586621680973190"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680973186"><span id="local-6989586621680973188"><span class="annot"><span class="annottext">Value -&gt; Parser [RefundSuccess]
Value -&gt; Parser RefundSuccess
(Value -&gt; Parser RefundSuccess)
-&gt; (Value -&gt; Parser [RefundSuccess]) -&gt; FromJSON RefundSuccess
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [RefundSuccess]
$cparseJSONList :: Value -&gt; Parser [RefundSuccess]
parseJSON :: Value -&gt; Parser RefundSuccess
$cparseJSON :: Value -&gt; Parser RefundSuccess
</span><a href="#local-6989586621680973186"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span class="hs-comment">-- | 'refund' with an endpoint.</span><span>
</span><span id="line-320"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#refundEp"><span class="hs-identifier hs-type">refundEp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680973185"><span class="annot"><a href="#local-6989586621680973185"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680973184"><span class="annot"><a href="#local-6989586621680973184"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;refund-escrow&quot;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680973184"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973185"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973184"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier hs-type">EscrowError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier hs-type">RefundSuccess</span></a></span><span>
</span><span id="line-326"></span><span id="refundEp"><span class="annot"><span class="annottext">refundEp :: EscrowParams Datum -&gt; Promise w s EscrowError RefundSuccess
</span><a href="Plutus.Contracts.Escrow.html#refundEp"><span class="hs-identifier hs-var hs-var">refundEp</span></a></span></span><span> </span><span id="local-6989586621680973183"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973183"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a w (s :: Row *) e b.
(HasEndpoint &quot;refund-escrow&quot; a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;refund-escrow&quot;</span></span><span> </span><span class="annot"><span class="annottext">((() -&gt; Contract w s EscrowError RefundSuccess)
 -&gt; Promise w s EscrowError RefundSuccess)
-&gt; (() -&gt; Contract w s EscrowError RefundSuccess)
-&gt; Promise w s EscrowError RefundSuccess
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RefundSuccess
forall w (s :: Row *).
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RefundSuccess
</span><a href="Plutus.Contracts.Escrow.html#refund"><span class="hs-identifier hs-var">refund</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; TypedValidator Escrow
</span><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973183"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973183"><span class="hs-identifier hs-var">escrow</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span class="hs-comment">-- | Claim a refund of the contribution.</span><span>
</span><span id="line-329"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#refund"><span class="hs-identifier hs-type">refund</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680973662"><span class="annot"><a href="#local-6989586621680973662"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680973661"><span class="annot"><a href="#local-6989586621680973661"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-331"></span><span>    </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">TypedValidator</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#Escrow"><span class="hs-identifier hs-type">Escrow</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973662"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973661"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier hs-type">EscrowError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier hs-type">RefundSuccess</span></a></span><span>
</span><span id="line-334"></span><span id="refund"><span class="annot"><span class="annottext">refund :: TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RefundSuccess
</span><a href="Plutus.Contracts.Escrow.html#refund"><span class="hs-identifier hs-var hs-var">refund</span></a></span></span><span> </span><span id="local-6989586621680973182"><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973182"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span id="local-6989586621680973181"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973181"><span class="hs-identifier hs-var">escrow</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621680973180"><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621680973180"><span class="hs-identifier hs-var">networkId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Params -&gt; NetworkId
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var hs-var">pNetworkId</span></a></span><span> </span><span class="annot"><span class="annottext">(Params -&gt; NetworkId)
-&gt; Contract w s EscrowError Params
-&gt; Contract w s EscrowError NetworkId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError Params
forall w (s :: Row *) e. AsContractError e =&gt; Contract w s e Params
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">getParams</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973179"><span class="annot"><span class="annottext">addr :: AddressInEra BabbageEra
</span><a href="#local-6989586621680973179"><span class="hs-identifier hs-var hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NetworkId -&gt; TypedValidator Escrow -&gt; AddressInEra BabbageEra
forall a. NetworkId -&gt; TypedValidator a -&gt; AddressInEra BabbageEra
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.validatorCardanoAddress</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621680973180"><span class="hs-identifier hs-var">networkId</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973182"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-337"></span><span>    </span><span id="local-6989586621680973178"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973178"><span class="hs-identifier hs-var">unspentOutputs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AddressInEra BabbageEra
-&gt; Contract w s EscrowError (Map TxOutRef DecoratedTxOut)
forall w (s :: Row *) e.
AsContractError e =&gt;
AddressInEra BabbageEra
-&gt; Contract w s e (Map TxOutRef DecoratedTxOut)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">utxosAt</span></a></span><span> </span><span class="annot"><span class="annottext">AddressInEra BabbageEra
</span><a href="#local-6989586621680973179"><span class="hs-identifier hs-var">addr</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621680973177"><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973177"><span class="hs-identifier hs-var">pk</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError PaymentPubKeyHash
forall w (s :: Row *) e.
AsContractError e =&gt;
Contract w s e PaymentPubKeyHash
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">ownFirstPaymentPubKeyHash</span></a></span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973176"><span class="annot"><span class="annottext">pkh :: DatumHash
</span><a href="#local-6989586621680973176"><span class="hs-identifier hs-var hs-var">pkh</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Datum -&gt; DatumHash
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">datumHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Datum -&gt; DatumHash) -&gt; Datum -&gt; DatumHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinData -&gt; Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Datum</span></a></span><span> </span><span class="annot"><span class="annottext">(BuiltinData -&gt; Datum) -&gt; BuiltinData -&gt; Datum
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; BuiltinData
forall a. ToData a =&gt; a -&gt; BuiltinData
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.toBuiltinData</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973177"><span class="hs-identifier hs-var">pk</span></a></span><span>
</span><span id="line-340"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973175"><span class="annot"><span class="annottext">flt :: TxOutRef -&gt; DecoratedTxOut -&gt; Bool
</span><a href="#local-6989586621680973175"><span class="hs-identifier hs-var hs-var">flt</span></a></span></span><span> </span><span class="annot"><span class="annottext">TxOutRef
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680973174"><span class="annot"><span class="annottext">DecoratedTxOut
</span><a href="#local-6989586621680973174"><span class="hs-identifier hs-var">ciTxOut</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Getting Any DecoratedTxOut () -&gt; DecoratedTxOut -&gt; Bool
forall s a. Getting Any s a -&gt; s -&gt; Bool
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">has</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((DatumHash, DatumFromQuery)
 -&gt; Const Any (DatumHash, DatumFromQuery))
-&gt; DecoratedTxOut -&gt; Const Any DecoratedTxOut
Traversal' DecoratedTxOut (DatumHash, DatumFromQuery)
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">Tx.decoratedTxOutScriptDatum</span></a></span><span> </span><span class="annot"><span class="annottext">(((DatumHash, DatumFromQuery)
  -&gt; Const Any (DatumHash, DatumFromQuery))
 -&gt; DecoratedTxOut -&gt; Const Any DecoratedTxOut)
-&gt; ((() -&gt; Const Any ())
    -&gt; (DatumHash, DatumFromQuery)
    -&gt; Const Any (DatumHash, DatumFromQuery))
-&gt; Getting Any DecoratedTxOut ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(DatumHash -&gt; Const Any DatumHash)
-&gt; (DatumHash, DatumFromQuery)
-&gt; Const Any (DatumHash, DatumFromQuery)
forall s t a b. Field1 s t a b =&gt; Lens s t a b
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">_1</span></a></span><span> </span><span class="annot"><span class="annottext">((DatumHash -&gt; Const Any DatumHash)
 -&gt; (DatumHash, DatumFromQuery)
 -&gt; Const Any (DatumHash, DatumFromQuery))
-&gt; ((() -&gt; Const Any ()) -&gt; DatumHash -&gt; Const Any DatumHash)
-&gt; (() -&gt; Const Any ())
-&gt; (DatumHash, DatumFromQuery)
-&gt; Const Any (DatumHash, DatumFromQuery)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">DatumHash -&gt; Prism' DatumHash ()
forall a. Eq a =&gt; a -&gt; Prism' a ()
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">only</span></a></span><span> </span><span class="annot"><span class="annottext">DatumHash
</span><a href="#local-6989586621680973176"><span class="hs-identifier hs-var">pkh</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DecoratedTxOut
</span><a href="#local-6989586621680973174"><span class="hs-identifier hs-var">ciTxOut</span></a></span><span>
</span><span id="line-341"></span><span>        </span><span id="local-6989586621680973172"><span class="annot"><span class="annottext">tx' :: TxConstraints Action PaymentPubKeyHash
</span><a href="#local-6989586621680973172"><span class="hs-identifier hs-var hs-var">tx'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TxOutRef -&gt; DecoratedTxOut -&gt; Bool)
-&gt; Map TxOutRef DecoratedTxOut
-&gt; Action
-&gt; TxConstraints Action PaymentPubKeyHash
forall i o.
(TxOutRef -&gt; DecoratedTxOut -&gt; Bool)
-&gt; Map TxOutRef DecoratedTxOut -&gt; i -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.collectFromTheScriptFilter</span></a></span><span> </span><span class="annot"><span class="annottext">TxOutRef -&gt; DecoratedTxOut -&gt; Bool
</span><a href="#local-6989586621680973175"><span class="hs-identifier hs-var">flt</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973178"><span class="hs-identifier hs-var">unspentOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Action
</span><a href="Plutus.Contracts.Escrow.html#Refund"><span class="hs-identifier hs-var">Refund</span></a></span><span>
</span><span id="line-342"></span><span>                </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; TxConstraints Action PaymentPubKeyHash
forall i o. PaymentPubKeyHash -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustBeSignedBy</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680973177"><span class="hs-identifier hs-var">pk</span></a></span><span>
</span><span id="line-343"></span><span>                </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
-&gt; TxConstraints Action PaymentPubKeyHash
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ValidityInterval POSIXTime
-&gt; TxConstraints Action PaymentPubKeyHash
forall i o. ValidityInterval POSIXTime -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustValidateInTimeRange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime -&gt; ValidityInterval POSIXTime
forall a. a -&gt; ValidityInterval a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Interval.from</span></a></span><span> </span><span class="annot"><span class="annottext">(POSIXTime -&gt; ValidityInterval POSIXTime)
-&gt; POSIXTime -&gt; ValidityInterval POSIXTime
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; POSIXTime
forall d. EscrowParams d -&gt; POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973181"><span class="hs-identifier hs-var">escrow</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash -&gt; Bool
forall i o. TxConstraints i o -&gt; Bool
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.modifiesUtxoSet</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints Action PaymentPubKeyHash
</span><a href="#local-6989586621680973172"><span class="hs-identifier hs-var">tx'</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-346"></span><span>        </span><span id="local-6989586621680973167"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973167"><span class="hs-identifier hs-var">utx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScriptLookups Escrow
-&gt; TxConstraints (RedeemerType Escrow) (DatumType Escrow)
-&gt; Contract w s EscrowError UnbalancedTx
forall a w (s :: Row *) e.
(ToData (RedeemerType a), FromData (DatumType a),
 ToData (DatumType a), AsContractError e) =&gt;
ScriptLookups a
-&gt; TxConstraints (RedeemerType a) (DatumType a)
-&gt; Contract w s e UnbalancedTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mkTxConstraints</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow -&gt; ScriptLookups Escrow
forall a. TypedValidator a -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.typedValidatorLookups</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973182"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-347"></span><span>                              </span><span class="annot"><span class="annottext">ScriptLookups Escrow
-&gt; ScriptLookups Escrow -&gt; ScriptLookups Escrow
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut -&gt; ScriptLookups Escrow
forall a. Map TxOutRef DecoratedTxOut -&gt; ScriptLookups a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.unspentOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973178"><span class="hs-identifier hs-var">unspentOutputs</span></a></span><span>
</span><span id="line-348"></span><span>                               </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TxConstraints (RedeemerType Escrow) (DatumType Escrow)
TxConstraints Action PaymentPubKeyHash
</span><a href="#local-6989586621680973172"><span class="hs-identifier hs-var">tx'</span></a></span><span>
</span><span id="line-349"></span><span>        </span><span id="local-6989586621680973166"><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973166"><span class="hs-identifier hs-var">adjusted</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w s EscrowError UnbalancedTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e UnbalancedTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">adjustUnbalancedTx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973167"><span class="hs-identifier hs-var">utx</span></a></span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">TxId -&gt; RefundSuccess
</span><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier hs-var">RefundSuccess</span></a></span><span> </span><span class="annot"><span class="annottext">(TxId -&gt; RefundSuccess)
-&gt; (CardanoTx -&gt; TxId) -&gt; CardanoTx -&gt; RefundSuccess
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoTx -&gt; TxId
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">getCardanoTxId</span></a></span><span> </span><span class="annot"><span class="annottext">(CardanoTx -&gt; RefundSuccess)
-&gt; Contract w s EscrowError CardanoTx
-&gt; Contract w s EscrowError RefundSuccess
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx -&gt; Contract w s EscrowError CardanoTx
forall w (s :: Row *) e.
AsContractError e =&gt;
UnbalancedTx -&gt; Contract w s e CardanoTx
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">submitUnbalancedTx</span></a></span><span> </span><span class="annot"><span class="annottext">UnbalancedTx
</span><a href="#local-6989586621680973166"><span class="hs-identifier hs-var">adjusted</span></a></span><span>
</span><span id="line-351"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">AReview EscrowError ()
-&gt; () -&gt; Contract w s EscrowError RefundSuccess
forall e (m :: * -&gt; *) t x.
MonadError e m =&gt;
AReview e t -&gt; t -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing</span></a></span><span> </span><span class="annot"><span class="annottext">AReview EscrowError ()
forall r. AsEscrowError r =&gt; Prism' r ()
</span><a href="Plutus.Contracts.Escrow.html#_RefundFailed"><span class="hs-identifier hs-var">_RefundFailed</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span class="hs-comment">-- | Pay some money into the escrow contract. Then release all funds to their</span><span>
</span><span id="line-354"></span><span class="hs-comment">--   specified targets if enough funds were deposited before the deadline,</span><span>
</span><span id="line-355"></span><span class="hs-comment">--   or reclaim the contribution if the goal has not been met.</span><span>
</span><span id="line-356"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#payRedeemRefund"><span class="hs-identifier hs-type">payRedeemRefund</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-357"></span><span>    </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680973165"><span class="annot"><a href="#local-6989586621680973165"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680973164"><span class="annot"><a href="#local-6989586621680973164"><span class="hs-identifier hs-type">s</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-358"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-359"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-360"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973165"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680973164"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier hs-type">EscrowError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier hs-type">RefundSuccess</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RedeemSuccess"><span class="hs-identifier hs-type">RedeemSuccess</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span id="payRedeemRefund"><span class="annot"><span class="annottext">payRedeemRefund :: EscrowParams Datum
-&gt; Value
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
</span><a href="Plutus.Contracts.Escrow.html#payRedeemRefund"><span class="hs-identifier hs-var hs-var">payRedeemRefund</span></a></span></span><span> </span><span id="local-6989586621680973163"><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973163"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621680973162"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973162"><span class="hs-identifier hs-var">vl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-362"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973161"><span class="annot"><span class="annottext">inst :: TypedValidator Escrow
</span><a href="#local-6989586621680973161"><span class="hs-identifier hs-var hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; TypedValidator Escrow
</span><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973163"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-363"></span><span>        </span><span id="local-6989586621680973160"><span class="annot"><span class="annottext">go :: Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
</span><a href="#local-6989586621680973160"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-364"></span><span>            </span><span id="local-6989586621680973159"><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621680973159"><span class="hs-identifier hs-var">networkId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Params -&gt; NetworkId
</span><a href="../../../../cardano-node-emulator/html/src"><span class="hs-identifier hs-var hs-var">pNetworkId</span></a></span><span> </span><span class="annot"><span class="annottext">(Params -&gt; NetworkId)
-&gt; Contract w s EscrowError Params
-&gt; Contract w s EscrowError NetworkId
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError Params
forall w (s :: Row *) e. AsContractError e =&gt; Contract w s e Params
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">getParams</span></a></span><span>
</span><span id="line-365"></span><span>            </span><span id="local-6989586621680973158"><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973158"><span class="hs-identifier hs-var">cur</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AddressInEra BabbageEra
-&gt; Contract w s EscrowError (Map TxOutRef DecoratedTxOut)
forall w (s :: Row *) e.
AsContractError e =&gt;
AddressInEra BabbageEra
-&gt; Contract w s e (Map TxOutRef DecoratedTxOut)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">utxosAt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NetworkId -&gt; TypedValidator Escrow -&gt; AddressInEra BabbageEra
forall a. NetworkId -&gt; TypedValidator a -&gt; AddressInEra BabbageEra
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.validatorCardanoAddress</span></a></span><span> </span><span class="annot"><span class="annottext">NetworkId
</span><a href="#local-6989586621680973159"><span class="hs-identifier hs-var">networkId</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973161"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680973157"><span class="annot"><span class="annottext">presentVal :: Value
</span><a href="#local-6989586621680973157"><span class="hs-identifier hs-var hs-var">presentVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DecoratedTxOut -&gt; Value) -&gt; Map TxOutRef DecoratedTxOut -&gt; Value
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Getting Value DecoratedTxOut Value -&gt; DecoratedTxOut -&gt; Value
forall s (m :: * -&gt; *) a. MonadReader s m =&gt; Getting a s a -&gt; m a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">view</span></a></span><span> </span><span class="annot"><span class="annottext">Getting Value DecoratedTxOut Value
Lens' DecoratedTxOut Value
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">Tx.decoratedTxOutValue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map TxOutRef DecoratedTxOut
</span><a href="#local-6989586621680973158"><span class="hs-identifier hs-var">cur</span></a></span><span>
</span><span id="line-367"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973157"><span class="hs-identifier hs-var">presentVal</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`geq`</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; Value
forall d. EscrowParams d -&gt; Value
</span><a href="Plutus.Contracts.Escrow.html#targetTotal"><span class="hs-identifier hs-var">targetTotal</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973163"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-368"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RedeemSuccess -&gt; Either RefundSuccess RedeemSuccess
forall a b. b -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(RedeemSuccess -&gt; Either RefundSuccess RedeemSuccess)
-&gt; Contract w s EscrowError RedeemSuccess
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RedeemSuccess
forall w (s :: Row *) e.
AsEscrowError e =&gt;
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s e RedeemSuccess
</span><a href="Plutus.Contracts.Escrow.html#redeem"><span class="hs-identifier hs-var">redeem</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973161"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973163"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-369"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-370"></span><span>                    </span><span id="local-6989586621680973156"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680973156"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(POSIXTime, POSIXTime) -&gt; POSIXTime
forall a b. (a, b) -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">snd</span></a></span><span> </span><span class="annot"><span class="annottext">((POSIXTime, POSIXTime) -&gt; POSIXTime)
-&gt; Contract w s EscrowError (POSIXTime, POSIXTime)
-&gt; Contract w s EscrowError POSIXTime
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError (POSIXTime, POSIXTime)
forall w (s :: Row *) e.
AsContractError e =&gt;
Contract w s e (POSIXTime, POSIXTime)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">currentNodeClientTimeRange</span></a></span><span>
</span><span id="line-371"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680973156"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; POSIXTime
forall d. EscrowParams d -&gt; POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var hs-var">escrowDeadline</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973163"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-372"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RefundSuccess -&gt; Either RefundSuccess RedeemSuccess
forall a b. a -&gt; Either a b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(RefundSuccess -&gt; Either RefundSuccess RedeemSuccess)
-&gt; Contract w s EscrowError RefundSuccess
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RefundSuccess
forall w (s :: Row *).
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Contract w s EscrowError RefundSuccess
</span><a href="Plutus.Contracts.Escrow.html#refund"><span class="hs-identifier hs-var">refund</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973161"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973163"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-373"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Contract w s EscrowError Slot
forall w (s :: Row *) e.
AsContractError e =&gt;
Natural -&gt; Contract w s e Slot
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">waitNSlots</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError Slot
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
</span><a href="#local-6989586621680973160"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-comment">-- Pay the value 'vl' into the contract</span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><span class="annottext">TxId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s EscrowError TxId
forall w (s :: Row *) e.
AsContractError e =&gt;
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s e TxId
</span><a href="Plutus.Contracts.Escrow.html#pay"><span class="hs-identifier hs-var">pay</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
</span><a href="#local-6989586621680973161"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680973163"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680973162"><span class="hs-identifier hs-var">vl</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><span class="annottext">Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
</span><a href="#local-6989586621680973160"><span class="hs-identifier hs-var">go</span></a></span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span class="annot"><a href="Plutus.Contracts.Escrow.html#covIdx"><span class="hs-identifier hs-type">covIdx</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">CoverageIndex</span></a></span><span>
</span><span id="line-379"></span><span id="covIdx"><span class="annot"><span class="annottext">covIdx :: CoverageIndex
</span><a href="Plutus.Contracts.Escrow.html#covIdx"><span class="hs-identifier hs-var hs-var">covIdx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompiledCode
  (EscrowParams DatumHash
   -&gt; PaymentPubKeyHash -&gt; Action -&gt; ScriptContext -&gt; Bool)
-&gt; CoverageIndex
forall (uni :: * -&gt; *) fun a.
CompiledCodeIn uni fun a -&gt; CoverageIndex
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">getCovIdx</span></a></span><span> </span><span class="hs-special">$$(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.compile</span></a></span><span> </span><span class="hs-special">[||</span><span> </span><span class="hs-identifier">validate</span><span> </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><span id="line-380"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds       #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE DataKinds             #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE DeriveAnyClass        #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE DeriveGeneric         #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE DerivingStrategies    #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase            #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE MonoLocalBinds        #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns        #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE NoImplicitPrelude     #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings     #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards       #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell       #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications      #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE TypeOperators         #-}</span><span>
</span><span id="line-17"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-unused-matches #-}</span><span>
</span><span id="line-18"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-incomplete-uni-patterns #-}</span><span>
</span><span id="line-19"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-specialise #-}</span><span>
</span><span id="line-20"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-ignore-interface-pragmas #-}</span><span>
</span><span id="line-21"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-omit-interface-pragmas #-}</span><span>
</span><span id="line-22"></span><span class="hs-pragma">{-# OPTIONS_GHC -fplugin-opt PlutusTx.Plugin:debug-context #-}</span><span>
</span><span id="line-23"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Plutus.Contracts.Future</span><span class="hs-special">(</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><span class="hs-comment">-- $future</span></span><span>
</span><span id="line-25"></span><span>      </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier">Future</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier">FutureAccounts</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#mkAccounts"><span class="hs-identifier">mkAccounts</span></a></span><span>
</span><span id="line-28"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier">FutureError</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSchema"><span class="hs-identifier">FutureSchema</span></a></span><span>
</span><span id="line-30"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier">FutureSetup</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier">Role</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#futureContract"><span class="hs-identifier">futureContract</span></a></span><span>
</span><span id="line-33"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#futureStateMachine"><span class="hs-identifier">futureStateMachine</span></a></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#validator"><span class="hs-identifier">validator</span></a></span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#initialiseFuture"><span class="hs-identifier">initialiseFuture</span></a></span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-identifier">initialMargin</span></a></span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#futureAddress"><span class="hs-identifier">futureAddress</span></a></span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-identifier">tokenFor</span></a></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#initialState"><span class="hs-identifier">initialState</span></a></span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#typedValidator"><span class="hs-identifier">typedValidator</span></a></span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#setupTokens"><span class="hs-identifier">setupTokens</span></a></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#setupTokensTrace"><span class="hs-identifier">setupTokensTrace</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Lens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">makeClassyPrisms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">prism'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">review</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Monad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Monad.Error.Lens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">throwing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">Data.Aeson</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">FromJSON</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier">ToJSON</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx.Prelude</span></a></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Address</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">POSIXTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">PaymentPubKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">PaymentPubKeyHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Constraints</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints.TxConstraints</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">TxConstraints</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier">Ledger.Constraints.ValidityInterval</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Interval</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Scripts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">unitDatum</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Tokens</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Typed.Scripts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Scripts</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Value</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Value</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract</span></a></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Oracle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Observation</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Oracle</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Oracle</span></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">loopM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">Plutus.Script.Utils.V1.Address</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">mkValidatorAddress</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">Plutus.Script.Utils.V1.Scripts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier">validatorHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Plutus.V1.Ledger.Api</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Datum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Datum</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Validator</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">ValidatorHash</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.StateMachine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">AsSMContractError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">State</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">StateMachine</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Void</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.StateMachine</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SM</span></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contracts.Currency.html"><span class="hs-identifier">Plutus.Contracts.Currency</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Currency</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html"><span class="hs-identifier">Plutus.Contracts.Escrow</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Escrow.html#AsEscrowError"><span class="hs-identifier">AsEscrowError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier">EscrowError</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier">EscrowParams</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier">RefundSuccess</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html"><span class="hs-identifier">Plutus.Contracts.Escrow</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Escrow</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html"><span class="hs-identifier">Plutus.Contracts.TokenAccount</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier">Account</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html"><span class="hs-identifier">Plutus.Contracts.TokenAccount</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">TokenAccount</span></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Trace.Emulator</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Trace</span></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Wallet.Emulator.Wallet</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Wallet</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Prelude</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Haskell</span></span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="hs-comment">-- $future</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- A futures contract in Plutus. This example illustrates a number of concepts.</span><span>
</span><span id="line-84"></span><span class="hs-comment">--</span><span>
</span><span id="line-85"></span><span class="hs-comment">--   1. Maintaining a margin (a kind of deposit) during the duration of the contract to protect against breach of contract (see note [Futures in Plutus])</span><span>
</span><span id="line-86"></span><span class="hs-comment">--   2. Using oracle values to obtain current pricing information (see note [Oracles] in Plutus.Contracts)</span><span>
</span><span id="line-87"></span><span class="hs-comment">--   3. Writing contracts as state machines</span><span>
</span><span id="line-88"></span><span class="hs-comment">--   4. Using tokens to represent claims on future cash flows</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- | Basic data of a futures contract. `Future` contains all values that do not</span><span>
</span><span id="line-91"></span><span class="hs-comment">--   change during the lifetime of the contract.</span><span>
</span><span id="line-92"></span><span class="hs-comment">--</span><span>
</span><span id="line-93"></span><span id="local-6989586621680982790"><span id="local-6989586621680982791"></span></span><span class="hs-keyword">data</span><span> </span><span id="Future"><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-var">Future</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-94"></span><span>    </span><span id="Future"><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-var">Future</span></a></span></span><span>
</span><span id="line-95"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="ftDeliveryDate"><span class="annot"><span class="annottext">Future -&gt; POSIXTime
</span><a href="Plutus.Contracts.Future.html#ftDeliveryDate"><span class="hs-identifier hs-var hs-var">ftDeliveryDate</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span>
</span><span id="line-96"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftUnits"><span class="annot"><span class="annottext">Future -&gt; Integer
</span><a href="Plutus.Contracts.Future.html#ftUnits"><span class="hs-identifier hs-var hs-var">ftUnits</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-97"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftUnitPrice"><span class="annot"><span class="annottext">Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftUnitPrice"><span class="hs-identifier hs-var hs-var">ftUnitPrice</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftInitialMargin"><span class="annot"><span class="annottext">Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftInitialMargin"><span class="hs-identifier hs-var hs-var">ftInitialMargin</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-99"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftPriceOracle"><span class="annot"><span class="annottext">Future -&gt; PaymentPubKey
</span><a href="Plutus.Contracts.Future.html#ftPriceOracle"><span class="hs-identifier hs-var hs-var">ftPriceOracle</span></a></span></span><span>   </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKey</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftMarginPenalty"><span class="annot"><span class="annottext">Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftMarginPenalty"><span class="hs-identifier hs-var hs-var">ftMarginPenalty</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-101"></span><span>        </span><span class="hs-comment">-- ^ How much a participant loses if they fail to make the required</span><span>
</span><span id="line-102"></span><span>        </span><span class="hs-comment">--   margin payments.</span><span>
</span><span id="line-103"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="annottext">(forall x. Future -&gt; Rep Future x)
-&gt; (forall x. Rep Future x -&gt; Future) -&gt; Generic Future
forall x. Rep Future x -&gt; Future
forall x. Future -&gt; Rep Future x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Future x -&gt; Future
$cfrom :: forall x. Future -&gt; Rep Future x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span class="hs-comment">-- | The two roles involved in the contract.</span><span>
</span><span id="line-106"></span><span id="local-6989586621680982778"><span id="local-6989586621680982779"></span></span><span class="hs-keyword">data</span><span> </span><span id="Role"><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-var">Role</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Long"><span class="annot"><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Short"><span class="annot"><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span></span><span>
</span><span id="line-107"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(forall x. Role -&gt; Rep Role x)
-&gt; (forall x. Rep Role x -&gt; Role) -&gt; Generic Role
forall x. Rep Role x -&gt; Role
forall x. Role -&gt; Rep Role x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Role x -&gt; Role
$cfrom :: forall x. Role -&gt; Rep Role x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982768"><span id="local-6989586621680982770"><span id="local-6989586621680982772"><span class="annot"><span class="annottext">Int -&gt; Role -&gt; ShowS
[Role] -&gt; ShowS
Role -&gt; String
(Int -&gt; Role -&gt; ShowS)
-&gt; (Role -&gt; String) -&gt; ([Role] -&gt; ShowS) -&gt; Show Role
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Role] -&gt; ShowS
$cshowList :: [Role] -&gt; ShowS
show :: Role -&gt; String
$cshow :: Role -&gt; String
showsPrec :: Int -&gt; Role -&gt; ShowS
$cshowsPrec :: Int -&gt; Role -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982759"><span id="local-6989586621680982761"><span id="local-6989586621680982763"><span id="local-6989586621680982765"><span class="annot"><span class="annottext">[Role] -&gt; Encoding
[Role] -&gt; Value
Role -&gt; Encoding
Role -&gt; Value
(Role -&gt; Value)
-&gt; (Role -&gt; Encoding)
-&gt; ([Role] -&gt; Value)
-&gt; ([Role] -&gt; Encoding)
-&gt; ToJSON Role
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [Role] -&gt; Encoding
$ctoEncodingList :: [Role] -&gt; Encoding
toJSONList :: [Role] -&gt; Value
$ctoJSONList :: [Role] -&gt; Value
toEncoding :: Role -&gt; Encoding
$ctoEncoding :: Role -&gt; Encoding
toJSON :: Role -&gt; Value
$ctoJSON :: Role -&gt; Value
</span><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982754"><span id="local-6989586621680982756"><span class="annot"><span class="annottext">Value -&gt; Parser [Role]
Value -&gt; Parser Role
(Value -&gt; Parser Role) -&gt; (Value -&gt; Parser [Role]) -&gt; FromJSON Role
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [Role]
$cparseJSONList :: Value -&gt; Parser [Role]
parseJSON :: Value -&gt; Parser Role
$cparseJSON :: Value -&gt; Parser Role
</span><a href="../file:///nix/store/2m29g1mlr4lg9v93x77b5w3l6pyhq2vj-aeson-lib-aeson-2.0.2.0-haddock-doc/share/doc/aeson/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span> </span><span id="local-6989586621680982750"><span class="annot"><span class="annottext">== :: Role -&gt; Role -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span>   </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-comment">-- | The token accounts that represent ownership of the two sides of the future.</span><span>
</span><span id="line-116"></span><span class="hs-comment">--   When the contract is done, payments will be made to these accounts.</span><span>
</span><span id="line-117"></span><span id="local-6989586621680982747"><span id="local-6989586621680982748"></span></span><span class="hs-keyword">data</span><span> </span><span id="FutureAccounts"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-var">FutureAccounts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-118"></span><span>    </span><span id="FutureAccounts"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-var">FutureAccounts</span></a></span></span><span>
</span><span id="line-119"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="ftoLong"><span class="annot"><span class="annottext">FutureAccounts -&gt; Account
</span><a href="Plutus.Contracts.Future.html#ftoLong"><span class="hs-identifier hs-var hs-var">ftoLong</span></a></span></span><span>         </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier hs-type">Account</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span class="hs-comment">-- ^ The owner of the &quot;long&quot; account (represented by a token)</span><span>
</span><span id="line-121"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftoLongAccount"><span class="annot"><span class="annottext">FutureAccounts -&gt; ValidatorHash
</span><a href="Plutus.Contracts.Future.html#ftoLongAccount"><span class="hs-identifier hs-var hs-var">ftoLongAccount</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">ValidatorHash</span></a></span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-comment">-- ^ Address of the 'TokenAccount' validator script for 'ftoLong'. This</span><span>
</span><span id="line-123"></span><span>        </span><span class="hs-comment">--   hash can be derived from 'ftoLong', but only in off-chain code. We</span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-comment">--   store it here so that we can lift it into on-chain code.</span><span>
</span><span id="line-125"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftoShort"><span class="annot"><span class="annottext">FutureAccounts -&gt; Account
</span><a href="Plutus.Contracts.Future.html#ftoShort"><span class="hs-identifier hs-var hs-var">ftoShort</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier hs-type">Account</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span class="hs-comment">-- ^ The owner of the &quot;short&quot; account (represented by a token).</span><span>
</span><span id="line-127"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftoShortAccount"><span class="annot"><span class="annottext">FutureAccounts -&gt; ValidatorHash
</span><a href="Plutus.Contracts.Future.html#ftoShortAccount"><span class="hs-identifier hs-var hs-var">ftoShortAccount</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">ValidatorHash</span></a></span><span>
</span><span id="line-128"></span><span>        </span><span class="hs-comment">-- ^ Address of the 'TokenAccount' validator script for 'ftoShort'. The</span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-comment">--   comment on 'ftoLongAccount' applies to this as well.</span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982736"><span id="local-6989586621680982738"><span id="local-6989586621680982740"><span class="annot"><span class="annottext">Int -&gt; FutureAccounts -&gt; ShowS
[FutureAccounts] -&gt; ShowS
FutureAccounts -&gt; String
(Int -&gt; FutureAccounts -&gt; ShowS)
-&gt; (FutureAccounts -&gt; String)
-&gt; ([FutureAccounts] -&gt; ShowS)
-&gt; Show FutureAccounts
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FutureAccounts] -&gt; ShowS
$cshowList :: [FutureAccounts] -&gt; ShowS
show :: FutureAccounts -&gt; String
$cshow :: FutureAccounts -&gt; String
showsPrec :: Int -&gt; FutureAccounts -&gt; ShowS
$cshowsPrec :: Int -&gt; FutureAccounts -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. FutureAccounts -&gt; Rep FutureAccounts x)
-&gt; (forall x. Rep FutureAccounts x -&gt; FutureAccounts)
-&gt; Generic FutureAccounts
forall x. Rep FutureAccounts x -&gt; FutureAccounts
forall x. FutureAccounts -&gt; Rep FutureAccounts x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep FutureAccounts x -&gt; FutureAccounts
$cfrom :: forall x. FutureAccounts -&gt; Rep FutureAccounts x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-131"></span><span>          </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982726"><span id="local-6989586621680982728"><span id="local-6989586621680982730"><span id="local-6989586621680982732"><span class="annot"><span class="annottext">[FutureAccounts] -&gt; Encoding
[FutureAccounts] -&gt; Value
FutureAccounts -&gt; Encoding
FutureAccounts -&gt; Value
(FutureAccounts -&gt; Value)
-&gt; (FutureAccounts -&gt; Encoding)
-&gt; ([FutureAccounts] -&gt; Value)
-&gt; ([FutureAccounts] -&gt; Encoding)
-&gt; ToJSON FutureAccounts
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [FutureAccounts] -&gt; Encoding
$ctoEncodingList :: [FutureAccounts] -&gt; Encoding
toJSONList :: [FutureAccounts] -&gt; Value
$ctoJSONList :: [FutureAccounts] -&gt; Value
toEncoding :: FutureAccounts -&gt; Encoding
$ctoEncoding :: FutureAccounts -&gt; Encoding
toJSON :: FutureAccounts -&gt; Value
$ctoJSON :: FutureAccounts -&gt; Value
</span><a href="#local-6989586621680982726"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982722"><span id="local-6989586621680982724"><span class="annot"><span class="annottext">Value -&gt; Parser [FutureAccounts]
Value -&gt; Parser FutureAccounts
(Value -&gt; Parser FutureAccounts)
-&gt; (Value -&gt; Parser [FutureAccounts]) -&gt; FromJSON FutureAccounts
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [FutureAccounts]
$cparseJSONList :: Value -&gt; Parser [FutureAccounts]
parseJSON :: Value -&gt; Parser FutureAccounts
$cparseJSON :: Value -&gt; Parser FutureAccounts
</span><a href="#local-6989586621680982722"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="hs-comment">-- | The two margins.</span><span>
</span><span id="line-134"></span><span id="local-6989586621680982720"><span id="local-6989586621680982721"></span></span><span class="hs-keyword">data</span><span> </span><span id="Margins"><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-var">Margins</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>    </span><span id="Margins"><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-var">Margins</span></a></span></span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="ftsShortMargin"><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsShortMargin"><span class="hs-identifier hs-var hs-var">ftsShortMargin</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-137"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="ftsLongMargin"><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsLongMargin"><span class="hs-identifier hs-var hs-var">ftsLongMargin</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982713"><span id="local-6989586621680982715"><span class="annot"><span class="annottext">Margins -&gt; Margins -&gt; Bool
(Margins -&gt; Margins -&gt; Bool)
-&gt; (Margins -&gt; Margins -&gt; Bool) -&gt; Eq Margins
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Margins -&gt; Margins -&gt; Bool
$c/= :: Margins -&gt; Margins -&gt; Bool
== :: Margins -&gt; Margins -&gt; Bool
$c== :: Margins -&gt; Margins -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982706"><span id="local-6989586621680982708"><span id="local-6989586621680982710"><span class="annot"><span class="annottext">Int -&gt; Margins -&gt; ShowS
[Margins] -&gt; ShowS
Margins -&gt; String
(Int -&gt; Margins -&gt; ShowS)
-&gt; (Margins -&gt; String) -&gt; ([Margins] -&gt; ShowS) -&gt; Show Margins
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Margins] -&gt; ShowS
$cshowList :: [Margins] -&gt; ShowS
show :: Margins -&gt; String
$cshow :: Margins -&gt; String
showsPrec :: Int -&gt; Margins -&gt; ShowS
$cshowsPrec :: Int -&gt; Margins -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. Margins -&gt; Rep Margins x)
-&gt; (forall x. Rep Margins x -&gt; Margins) -&gt; Generic Margins
forall x. Rep Margins x -&gt; Margins
forall x. Margins -&gt; Rep Margins x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep Margins x -&gt; Margins
$cfrom :: forall x. Margins -&gt; Rep Margins x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982696"><span id="local-6989586621680982698"><span id="local-6989586621680982700"><span id="local-6989586621680982702"><span class="annot"><span class="annottext">[Margins] -&gt; Encoding
[Margins] -&gt; Value
Margins -&gt; Encoding
Margins -&gt; Value
(Margins -&gt; Value)
-&gt; (Margins -&gt; Encoding)
-&gt; ([Margins] -&gt; Value)
-&gt; ([Margins] -&gt; Encoding)
-&gt; ToJSON Margins
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [Margins] -&gt; Encoding
$ctoEncodingList :: [Margins] -&gt; Encoding
toJSONList :: [Margins] -&gt; Value
$ctoJSONList :: [Margins] -&gt; Value
toEncoding :: Margins -&gt; Encoding
$ctoEncoding :: Margins -&gt; Encoding
toJSON :: Margins -&gt; Value
$ctoJSON :: Margins -&gt; Value
</span><a href="#local-6989586621680982696"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982692"><span id="local-6989586621680982694"><span class="annot"><span class="annottext">Value -&gt; Parser [Margins]
Value -&gt; Parser Margins
(Value -&gt; Parser Margins)
-&gt; (Value -&gt; Parser [Margins]) -&gt; FromJSON Margins
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [Margins]
$cparseJSONList :: Value -&gt; Parser [Margins]
parseJSON :: Value -&gt; Parser Margins
$cparseJSON :: Value -&gt; Parser Margins
</span><a href="#local-6989586621680982692"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>
</span><span id="line-142"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-143"></span><span>    </span><span id="local-6989586621680982690"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982690"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621680982689"><span class="annot"><span class="annottext">== :: Margins -&gt; Margins -&gt; Bool
</span><a href="#local-6989586621680982689"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span id="local-6989586621680982688"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982688"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsShortMargin"><span class="hs-identifier hs-var hs-var">ftsShortMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982690"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsShortMargin"><span class="hs-identifier hs-var hs-var">ftsShortMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982688"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsLongMargin"><span class="hs-identifier hs-var hs-var">ftsLongMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982690"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsLongMargin"><span class="hs-identifier hs-var hs-var">ftsLongMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982688"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">-- | The state of the future contract.</span><span>
</span><span id="line-146"></span><span id="local-6989586621680982685"><span id="local-6989586621680982686"></span></span><span class="hs-keyword">data</span><span> </span><span id="FutureState"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-var">FutureState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>    </span><span id="Running"><span class="annot"><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-var">Running</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="hs-comment">-- ^ Ongoing contract, with the current margins.</span><span>
</span><span id="line-149"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="Finished"><span class="annot"><a href="Plutus.Contracts.Future.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span></span><span>
</span><span id="line-150"></span><span>    </span><span class="hs-comment">-- ^ Contract is finished.</span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982677"><span id="local-6989586621680982679"><span id="local-6989586621680982681"><span class="annot"><span class="annottext">Int -&gt; FutureState -&gt; ShowS
[FutureState] -&gt; ShowS
FutureState -&gt; String
(Int -&gt; FutureState -&gt; ShowS)
-&gt; (FutureState -&gt; String)
-&gt; ([FutureState] -&gt; ShowS)
-&gt; Show FutureState
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FutureState] -&gt; ShowS
$cshowList :: [FutureState] -&gt; ShowS
show :: FutureState -&gt; String
$cshow :: FutureState -&gt; String
showsPrec :: Int -&gt; FutureState -&gt; ShowS
$cshowsPrec :: Int -&gt; FutureState -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. FutureState -&gt; Rep FutureState x)
-&gt; (forall x. Rep FutureState x -&gt; FutureState)
-&gt; Generic FutureState
forall x. Rep FutureState x -&gt; FutureState
forall x. FutureState -&gt; Rep FutureState x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep FutureState x -&gt; FutureState
$cfrom :: forall x. FutureState -&gt; Rep FutureState x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982671"><span id="local-6989586621680982673"><span class="annot"><span class="annottext">FutureState -&gt; FutureState -&gt; Bool
(FutureState -&gt; FutureState -&gt; Bool)
-&gt; (FutureState -&gt; FutureState -&gt; Bool) -&gt; Eq FutureState
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: FutureState -&gt; FutureState -&gt; Bool
$c/= :: FutureState -&gt; FutureState -&gt; Bool
== :: FutureState -&gt; FutureState -&gt; Bool
$c== :: FutureState -&gt; FutureState -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982663"><span id="local-6989586621680982665"><span id="local-6989586621680982667"><span id="local-6989586621680982669"><span class="annot"><span class="annottext">[FutureState] -&gt; Encoding
[FutureState] -&gt; Value
FutureState -&gt; Encoding
FutureState -&gt; Value
(FutureState -&gt; Value)
-&gt; (FutureState -&gt; Encoding)
-&gt; ([FutureState] -&gt; Value)
-&gt; ([FutureState] -&gt; Encoding)
-&gt; ToJSON FutureState
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [FutureState] -&gt; Encoding
$ctoEncodingList :: [FutureState] -&gt; Encoding
toJSONList :: [FutureState] -&gt; Value
$ctoJSONList :: [FutureState] -&gt; Value
toEncoding :: FutureState -&gt; Encoding
$ctoEncoding :: FutureState -&gt; Encoding
toJSON :: FutureState -&gt; Value
$ctoJSON :: FutureState -&gt; Value
</span><a href="#local-6989586621680982663"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982659"><span id="local-6989586621680982661"><span class="annot"><span class="annottext">Value -&gt; Parser [FutureState]
Value -&gt; Parser FutureState
(Value -&gt; Parser FutureState)
-&gt; (Value -&gt; Parser [FutureState]) -&gt; FromJSON FutureState
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [FutureState]
$cparseJSONList :: Value -&gt; Parser [FutureState]
parseJSON :: Value -&gt; Parser FutureState
$cparseJSON :: Value -&gt; Parser FutureState
</span><a href="#local-6989586621680982659"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>
</span><span id="line-154"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-155"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-type">Running</span></a></span><span> </span><span id="local-6989586621680982657"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982657"><span class="hs-identifier hs-var">ma</span></a></span></span><span> </span><span id="local-6989586621680982656"><span class="annot"><span class="annottext">== :: FutureState -&gt; FutureState -&gt; Bool
</span><a href="#local-6989586621680982656"><span class="hs-operator hs-var hs-var hs-var hs-var">==</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-type">Running</span></a></span><span> </span><span id="local-6989586621680982655"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982655"><span class="hs-identifier hs-var">ma'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982657"><span class="hs-identifier hs-var">ma</span></a></span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Margins -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982655"><span class="hs-identifier hs-var">ma'</span></a></span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><span class="annottext">FutureState
</span><a href="Plutus.Contracts.Future.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>   </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">FutureState
</span><a href="Plutus.Contracts.Future.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="annottext">FutureState
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">FutureState
</span><span class="hs-identifier">_</span></span><span>                    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">-- | Actions that can be performed on the future contract.</span><span>
</span><span id="line-160"></span><span id="local-6989586621680982653"><span id="local-6989586621680982654"></span></span><span class="hs-keyword">data</span><span> </span><span id="FutureAction"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-var">FutureAction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>    </span><span id="AdjustMargin"><span class="annot"><a href="Plutus.Contracts.Future.html#AdjustMargin"><span class="hs-identifier hs-var">AdjustMargin</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-comment">-- ^ Change the margin of one of the roles.</span><span>
</span><span id="line-163"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="Settle"><span class="annot"><a href="Plutus.Contracts.Future.html#Settle"><span class="hs-identifier hs-var">Settle</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>    </span><span class="hs-comment">-- ^ Close the contract at the delivery date by making the agreed payment</span><span>
</span><span id="line-165"></span><span>    </span><span class="hs-comment">--   and returning the margin deposits to their owners</span><span>
</span><span id="line-166"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="SettleEarly"><span class="annot"><a href="Plutus.Contracts.Future.html#SettleEarly"><span class="hs-identifier hs-var">SettleEarly</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">-- ^ Close the contract early after a margin payment has been missed.</span><span>
</span><span id="line-168"></span><span>    </span><span class="hs-comment">--   The value of both margin accounts will be paid to the role that</span><span>
</span><span id="line-169"></span><span>    </span><span class="hs-comment">--   *didn't* violate the margin requirement</span><span>
</span><span id="line-170"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982644"><span id="local-6989586621680982646"><span id="local-6989586621680982648"><span class="annot"><span class="annottext">Int -&gt; FutureAction -&gt; ShowS
[FutureAction] -&gt; ShowS
FutureAction -&gt; String
(Int -&gt; FutureAction -&gt; ShowS)
-&gt; (FutureAction -&gt; String)
-&gt; ([FutureAction] -&gt; ShowS)
-&gt; Show FutureAction
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FutureAction] -&gt; ShowS
$cshowList :: [FutureAction] -&gt; ShowS
show :: FutureAction -&gt; String
$cshow :: FutureAction -&gt; String
showsPrec :: Int -&gt; FutureAction -&gt; ShowS
$cshowsPrec :: Int -&gt; FutureAction -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. FutureAction -&gt; Rep FutureAction x)
-&gt; (forall x. Rep FutureAction x -&gt; FutureAction)
-&gt; Generic FutureAction
forall x. Rep FutureAction x -&gt; FutureAction
forall x. FutureAction -&gt; Rep FutureAction x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep FutureAction x -&gt; FutureAction
$cfrom :: forall x. FutureAction -&gt; Rep FutureAction x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-171"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982634"><span id="local-6989586621680982636"><span id="local-6989586621680982638"><span id="local-6989586621680982640"><span class="annot"><span class="annottext">[FutureAction] -&gt; Encoding
[FutureAction] -&gt; Value
FutureAction -&gt; Encoding
FutureAction -&gt; Value
(FutureAction -&gt; Value)
-&gt; (FutureAction -&gt; Encoding)
-&gt; ([FutureAction] -&gt; Value)
-&gt; ([FutureAction] -&gt; Encoding)
-&gt; ToJSON FutureAction
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [FutureAction] -&gt; Encoding
$ctoEncodingList :: [FutureAction] -&gt; Encoding
toJSONList :: [FutureAction] -&gt; Value
$ctoJSONList :: [FutureAction] -&gt; Value
toEncoding :: FutureAction -&gt; Encoding
$ctoEncoding :: FutureAction -&gt; Encoding
toJSON :: FutureAction -&gt; Value
$ctoJSON :: FutureAction -&gt; Value
</span><a href="#local-6989586621680982634"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982630"><span id="local-6989586621680982632"><span class="annot"><span class="annottext">Value -&gt; Parser [FutureAction]
Value -&gt; Parser FutureAction
(Value -&gt; Parser FutureAction)
-&gt; (Value -&gt; Parser [FutureAction]) -&gt; FromJSON FutureAction
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [FutureAction]
$cparseJSONList :: Value -&gt; Parser [FutureAction]
parseJSON :: Value -&gt; Parser FutureAction
$cparseJSON :: Value -&gt; Parser FutureAction
</span><a href="#local-6989586621680982630"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span id="local-6989586621680982628"><span id="local-6989586621680982629"></span></span><span class="hs-keyword">data</span><span> </span><span id="FutureError"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier hs-var">FutureError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>    </span><span id="TokenSetupFailed"><span class="annot"><a href="Plutus.Contracts.Future.html#TokenSetupFailed"><span class="hs-identifier hs-var">TokenSetupFailed</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Currency.html#CurrencyError"><span class="hs-identifier hs-type">Currency.CurrencyError</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="hs-comment">-- ^ Something went wrong during the setup of the two tokens</span><span>
</span><span id="line-176"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="StateMachineError"><span class="annot"><a href="Plutus.Contracts.Future.html#StateMachineError"><span class="hs-identifier hs-var">StateMachineError</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.SMContractError</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="OtherFutureError"><span class="annot"><a href="Plutus.Contracts.Future.html#OtherFutureError"><span class="hs-identifier hs-var">OtherFutureError</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">ContractError</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="EscrowFailed"><span class="annot"><a href="Plutus.Contracts.Future.html#EscrowFailed"><span class="hs-identifier hs-var">EscrowFailed</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowError"><span class="hs-identifier hs-type">EscrowError</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="hs-comment">-- ^ The escrow that initialises the future contract failed</span><span>
</span><span id="line-180"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span id="EscrowRefunded"><span class="annot"><a href="Plutus.Contracts.Future.html#EscrowRefunded"><span class="hs-identifier hs-var">EscrowRefunded</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#RefundSuccess"><span class="hs-identifier hs-type">RefundSuccess</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="hs-comment">-- ^ The other party didn't make their payment in time so the contract never</span><span>
</span><span id="line-182"></span><span>    </span><span class="hs-comment">--   started.</span><span>
</span><span id="line-183"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982617"><span id="local-6989586621680982619"><span id="local-6989586621680982621"><span class="annot"><span class="annottext">Int -&gt; FutureError -&gt; ShowS
[FutureError] -&gt; ShowS
FutureError -&gt; String
(Int -&gt; FutureError -&gt; ShowS)
-&gt; (FutureError -&gt; String)
-&gt; ([FutureError] -&gt; ShowS)
-&gt; Show FutureError
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FutureError] -&gt; ShowS
$cshowList :: [FutureError] -&gt; ShowS
show :: FutureError -&gt; String
$cshow :: FutureError -&gt; String
showsPrec :: Int -&gt; FutureError -&gt; ShowS
$cshowsPrec :: Int -&gt; FutureError -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. FutureError -&gt; Rep FutureError x)
-&gt; (forall x. Rep FutureError x -&gt; FutureError)
-&gt; Generic FutureError
forall x. Rep FutureError x -&gt; FutureError
forall x. FutureError -&gt; Rep FutureError x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep FutureError x -&gt; FutureError
$cfrom :: forall x. FutureError -&gt; Rep FutureError x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-184"></span><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982607"><span id="local-6989586621680982609"><span id="local-6989586621680982611"><span id="local-6989586621680982613"><span class="annot"><span class="annottext">[FutureError] -&gt; Encoding
[FutureError] -&gt; Value
FutureError -&gt; Encoding
FutureError -&gt; Value
(FutureError -&gt; Value)
-&gt; (FutureError -&gt; Encoding)
-&gt; ([FutureError] -&gt; Value)
-&gt; ([FutureError] -&gt; Encoding)
-&gt; ToJSON FutureError
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [FutureError] -&gt; Encoding
$ctoEncodingList :: [FutureError] -&gt; Encoding
toJSONList :: [FutureError] -&gt; Value
$ctoJSONList :: [FutureError] -&gt; Value
toEncoding :: FutureError -&gt; Encoding
$ctoEncoding :: FutureError -&gt; Encoding
toJSON :: FutureError -&gt; Value
$ctoJSON :: FutureError -&gt; Value
</span><a href="#local-6989586621680982607"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982603"><span id="local-6989586621680982605"><span class="annot"><span class="annottext">Value -&gt; Parser [FutureError]
Value -&gt; Parser FutureError
(Value -&gt; Parser FutureError)
-&gt; (Value -&gt; Parser [FutureError]) -&gt; FromJSON FutureError
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [FutureError]
$cparseJSONList :: Value -&gt; Parser [FutureError]
parseJSON :: Value -&gt; Parser FutureError
$cparseJSON :: Value -&gt; Parser FutureError
</span><a href="#local-6989586621680982603"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span id="_EscrowRefunded"><span id="_EscrowFailed"><span id="_OtherFutureError"><span id="_StateMachineError"><span id="_TokenSetupFailed"><span id="_FutureError"><span id="local-6989586621680982586"><span id="local-6989586621680982588"><span id="local-6989586621680982590"><span id="local-6989586621680982592"><span id="local-6989586621680982594"><span id="local-6989586621680982596"><span id="local-6989586621680982598"><span id="local-6989586621680982599"><span id="local-6989586621680982600"><span id="local-6989586621680982601"><span id="local-6989586621680982602"><span id="AsFutureError"><span id="local-6989586621680983193"><span class="hs-identifier">makeClassyPrisms</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">FutureError</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span>
</span><span id="line-187"></span><span>
</span><span id="line-188"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680982572"><span id="local-6989586621680982574"><span id="local-6989586621680982576"><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier hs-type">FutureError</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-189"></span><span>    </span><span id="local-6989586621680982570"><span class="annot"><span class="annottext">_SMContractError :: p SMContractError (f SMContractError)
-&gt; p FutureError (f FutureError)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">_SMContractError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p SMContractError (f SMContractError)
-&gt; p FutureError (f FutureError)
forall r. AsFutureError r =&gt; Prism' r SMContractError
</span><a href="Plutus.Contracts.Future.html#_StateMachineError"><span class="hs-identifier hs-var">_StateMachineError</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680982548"><span id="local-6989586621680982550"><span id="local-6989586621680982552"><span id="local-6989586621680982554"><span id="local-6989586621680982556"><span id="local-6989586621680982558"><span id="local-6989586621680982560"><span id="local-6989586621680982562"><span id="local-6989586621680982564"><span id="local-6989586621680982566"><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier hs-type">FutureError</span></a></span></span></span></span></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621680982546"><span class="annot"><span class="annottext">_ContractError :: p ContractError (f ContractError) -&gt; p FutureError (f FutureError)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">_ContractError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p ContractError (f ContractError) -&gt; p FutureError (f FutureError)
forall r. AsFutureError r =&gt; Prism' r ContractError
</span><a href="Plutus.Contracts.Future.html#_OtherFutureError"><span class="hs-identifier hs-var">_OtherFutureError</span></a></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680982542"><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsCheckpointError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier hs-type">FutureError</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621680982540"><span class="annot"><span class="annottext">_CheckpointError :: p CheckpointError (f CheckpointError)
-&gt; p FutureError (f FutureError)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">_CheckpointError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">p ContractError (f ContractError) -&gt; p FutureError (f FutureError)
forall r. AsFutureError r =&gt; Prism' r ContractError
</span><a href="Plutus.Contracts.Future.html#_OtherFutureError"><span class="hs-identifier hs-var">_OtherFutureError</span></a></span><span> </span><span class="annot"><span class="annottext">(p ContractError (f ContractError)
 -&gt; p FutureError (f FutureError))
-&gt; (p CheckpointError (f CheckpointError)
    -&gt; p ContractError (f ContractError))
-&gt; p CheckpointError (f CheckpointError)
-&gt; p FutureError (f FutureError)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">p CheckpointError (f CheckpointError)
-&gt; p ContractError (f ContractError)
forall r. AsCheckpointError r =&gt; Prism' r CheckpointError
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">_CheckpointError</span></a></span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-keyword">type</span><span> </span><span id="FutureSchema"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSchema"><span class="hs-identifier hs-var">FutureSchema</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;initialise-future&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>        </span><span class="annot"><a href="../file:///nix/store/g8vgm61qs4g5v6yyv8hvi8bm9dvsf9sa-row-types-lib-row-types-1.0.1.2-haddock-doc/share/doc/row-types/html/src"><span class="hs-operator hs-type">.\/</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;join-future&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><a href="../file:///nix/store/g8vgm61qs4g5v6yyv8hvi8bm9dvsf9sa-row-types-lib-row-types-1.0.1.2-haddock-doc/share/doc/row-types/html/src"><span class="hs-operator hs-type">.\/</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;increase-margin&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-201"></span><span>        </span><span class="annot"><a href="../file:///nix/store/g8vgm61qs4g5v6yyv8hvi8bm9dvsf9sa-row-types-lib-row-types-1.0.1.2-haddock-doc/share/doc/row-types/html/src"><span class="hs-operator hs-type">.\/</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;settle-early&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>        </span><span class="annot"><a href="../file:///nix/store/g8vgm61qs4g5v6yyv8hvi8bm9dvsf9sa-row-types-lib-row-types-1.0.1.2-haddock-doc/share/doc/row-types/html/src"><span class="hs-operator hs-type">.\/</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Endpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;settle-future&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680982529"><span id="local-6989586621680982531"><span id="local-6989586621680982533"><span class="annot"><a href="Plutus.Contracts.Escrow.html#AsEscrowError"><span class="hs-identifier hs-type">AsEscrowError</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier hs-type">FutureError</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621680982527"><span class="annot"><span class="annottext">_EscrowError :: p EscrowError (f EscrowError) -&gt; p FutureError (f FutureError)
</span><a href="Plutus.Contracts.Escrow.html#_EscrowError"><span class="hs-identifier hs-var hs-var hs-var hs-var">_EscrowError</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(EscrowError -&gt; FutureError)
-&gt; (FutureError -&gt; Maybe EscrowError)
-&gt; Prism' FutureError EscrowError
forall b s a. (b -&gt; s) -&gt; (s -&gt; Maybe a) -&gt; Prism s s a b
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">prism'</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowError -&gt; FutureError
</span><a href="Plutus.Contracts.Future.html#EscrowFailed"><span class="hs-identifier hs-var">EscrowFailed</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#EscrowFailed"><span class="hs-identifier hs-type">EscrowFailed</span></a></span><span> </span><span id="local-6989586621680982525"><span class="annot"><span class="annottext">EscrowError
</span><a href="#local-6989586621680982525"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EscrowError -&gt; Maybe EscrowError
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowError
</span><a href="#local-6989586621680982525"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">FutureError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe EscrowError
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span class="annot"><a href="Plutus.Contracts.Future.html#futureContract"><span class="hs-identifier hs-type">futureContract</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSchema"><span class="hs-identifier hs-type">FutureSchema</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier hs-type">FutureError</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span id="futureContract"><span class="annot"><span class="annottext">futureContract :: Future -&gt; Contract () FutureSchema FutureError ()
</span><a href="Plutus.Contracts.Future.html#futureContract"><span class="hs-identifier hs-var hs-var">futureContract</span></a></span></span><span> </span><span id="local-6989586621680982524"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982524"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621680982523"><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982523"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  (StateMachineClient FutureState FutureAction)
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (StateMachineClient FutureState FutureAction)
forall w (s :: Row *) e a. Promise w s e a -&gt; Contract w s e a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">awaitPromise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (StateMachineClient FutureState FutureAction)
forall (s :: Row *) e w.
(HasEndpoint &quot;join-future&quot; (FutureAccounts, FutureSetup) s,
 AsFutureError e) =&gt;
Future
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#joinFuture"><span class="hs-identifier hs-var">joinFuture</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982524"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  (StateMachineClient FutureState FutureAction)
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (StateMachineClient FutureState FutureAction)
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (StateMachineClient FutureState FutureAction)
forall w (s :: Row *) e a.
Promise w s e a -&gt; Promise w s e a -&gt; Promise w s e a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-operator hs-var">`select`</span></a></span><span> </span><span class="annot"><span class="annottext">Future
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (StateMachineClient FutureState FutureAction)
forall (s :: Row *) e w.
(HasEndpoint &quot;initialise-future&quot; (FutureSetup, Role) s,
 AsFutureError e) =&gt;
Future
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#initialiseFuture"><span class="hs-identifier hs-var">initialiseFuture</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982524"><span class="hs-identifier hs-var">ft</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="annottext">Contract
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  ()
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract
   ()
   ('R
      '[ &quot;increase-margin&quot;
         ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
         &quot;initialise-future&quot;
         ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
         &quot;join-future&quot;
         ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
         &quot;settle-early&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint),
         &quot;settle-future&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint)])
   FutureError
   ()
 -&gt; Contract
      ()
      ('R
         '[ &quot;increase-margin&quot;
            ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
            &quot;initialise-future&quot;
            ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
            &quot;join-future&quot;
            ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
            &quot;settle-early&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint),
            &quot;settle-future&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint)])
      FutureError
      ())
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(()
 -&gt; Contract
      ()
      ('R
         '[ &quot;increase-margin&quot;
            ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
            &quot;initialise-future&quot;
            ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
            &quot;join-future&quot;
            ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
            &quot;settle-early&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint),
            &quot;settle-future&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint)])
      FutureError
      (Either () ()))
-&gt; ()
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall (m :: * -&gt; *) a b.
Monad m =&gt;
(a -&gt; m (Either a b)) -&gt; a -&gt; m b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">loopM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Contract
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  (Either () ())
-&gt; ()
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (Either () ())
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract
   ()
   ('R
      '[ &quot;increase-margin&quot;
         ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
         &quot;initialise-future&quot;
         ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
         &quot;join-future&quot;
         ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
         &quot;settle-early&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint),
         &quot;settle-future&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint)])
   FutureError
   (Either () ())
 -&gt; ()
 -&gt; Contract
      ()
      ('R
         '[ &quot;increase-margin&quot;
            ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
            &quot;initialise-future&quot;
            ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
            &quot;join-future&quot;
            ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
            &quot;settle-early&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint),
            &quot;settle-future&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint)])
      FutureError
      (Either () ()))
-&gt; (Promise
      ()
      ('R
         '[ &quot;increase-margin&quot;
            ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
            &quot;initialise-future&quot;
            ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
            &quot;join-future&quot;
            ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
            &quot;settle-early&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint),
            &quot;settle-future&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint)])
      FutureError
      (Either () ())
    -&gt; Contract
         ()
         ('R
            '[ &quot;increase-margin&quot;
               ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
               &quot;initialise-future&quot;
               ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
               &quot;join-future&quot;
               ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
               &quot;settle-early&quot;
               ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                     ActiveEndpoint),
               &quot;settle-future&quot;
               ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                     ActiveEndpoint)])
         FutureError
         (Either () ()))
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (Either () ())
-&gt; ()
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (Either () ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  (Either () ())
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (Either () ())
forall w (s :: Row *) e a. Promise w s e a -&gt; Contract w s e a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">awaitPromise</span></a></span><span> </span><span class="annot"><span class="annottext">(Promise
   ()
   ('R
      '[ &quot;increase-margin&quot;
         ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
         &quot;initialise-future&quot;
         ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
         &quot;join-future&quot;
         ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
         &quot;settle-early&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint),
         &quot;settle-future&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint)])
   FutureError
   (Either () ())
 -&gt; ()
 -&gt; Contract
      ()
      ('R
         '[ &quot;increase-margin&quot;
            ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
            &quot;initialise-future&quot;
            ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
            &quot;join-future&quot;
            ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
            &quot;settle-early&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint),
            &quot;settle-future&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint)])
      FutureError
      (Either () ()))
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (Either () ())
-&gt; ()
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (Either () ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  ()
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     (Either () ())
forall w (s :: Row *) e a b.
Promise w s e a -&gt; Promise w s e b -&gt; Promise w s e (Either a b)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">selectEither</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall (s :: Row *) e w.
(HasEndpoint &quot;increase-margin&quot; (Value, Role) s,
 AsSMContractError e, AsContractError e) =&gt;
StateMachineClient FutureState FutureAction -&gt; Promise w s e ()
</span><a href="Plutus.Contracts.Future.html#increaseMargin"><span class="hs-identifier hs-var">increaseMargin</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982523"><span class="hs-identifier hs-var">client</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall (s :: Row *) e w.
(HasEndpoint &quot;settle-future&quot; (SignedMessage (Observation Value)) s,
 AsFutureError e) =&gt;
StateMachineClient FutureState FutureAction -&gt; Promise w s e ()
</span><a href="Plutus.Contracts.Future.html#settleFuture"><span class="hs-identifier hs-var">settleFuture</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982523"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="annot"><span class="annottext">Promise
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  ()
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall w (s :: Row *) e a.
Promise w s e a -&gt; Promise w s e a -&gt; Promise w s e a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-operator hs-var">`select`</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; Promise
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall (s :: Row *) e w.
(HasEndpoint &quot;settle-early&quot; (SignedMessage (Observation Value)) s,
 AsSMContractError e, AsContractError e) =&gt;
StateMachineClient FutureState FutureAction -&gt; Promise w s e ()
</span><a href="Plutus.Contracts.Future.html#settleEarly"><span class="hs-identifier hs-var">settleEarly</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982523"><span class="hs-identifier hs-var">client</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span class="hs-comment">-- | The data needed to initialise the futures contract.</span><span>
</span><span id="line-213"></span><span id="local-6989586621680982512"><span id="local-6989586621680982513"></span></span><span class="hs-keyword">data</span><span> </span><span id="FutureSetup"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-var">FutureSetup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-214"></span><span>    </span><span id="FutureSetup"><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-var">FutureSetup</span></a></span></span><span>
</span><span id="line-215"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="shortPK"><span class="annot"><span class="annottext">FutureSetup -&gt; PaymentPubKeyHash
</span><a href="Plutus.Contracts.Future.html#shortPK"><span class="hs-identifier hs-var hs-var">shortPK</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="hs-comment">-- ^ Initial owner of the short token</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="longPK"><span class="annot"><span class="annottext">FutureSetup -&gt; PaymentPubKeyHash
</span><a href="Plutus.Contracts.Future.html#longPK"><span class="hs-identifier hs-var hs-var">longPK</span></a></span></span><span>        </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span>
</span><span id="line-218"></span><span>        </span><span class="hs-comment">-- ^ Initial owner of the long token</span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="contractStart"><span class="annot"><span class="annottext">FutureSetup -&gt; POSIXTime
</span><a href="Plutus.Contracts.Future.html#contractStart"><span class="hs-identifier hs-var hs-var">contractStart</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span>
</span><span id="line-220"></span><span>        </span><span class="hs-comment">-- ^ Start of the futures contract itself. By this time the setup code</span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-comment">--   has to be finished, otherwise the contract is void.</span><span>
</span><span id="line-222"></span><span>        </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982502"><span id="local-6989586621680982504"><span id="local-6989586621680982506"><span class="annot"><span class="annottext">Int -&gt; FutureSetup -&gt; ShowS
[FutureSetup] -&gt; ShowS
FutureSetup -&gt; String
(Int -&gt; FutureSetup -&gt; ShowS)
-&gt; (FutureSetup -&gt; String)
-&gt; ([FutureSetup] -&gt; ShowS)
-&gt; Show FutureSetup
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [FutureSetup] -&gt; ShowS
$cshowList :: [FutureSetup] -&gt; ShowS
show :: FutureSetup -&gt; String
$cshow :: FutureSetup -&gt; String
showsPrec :: Int -&gt; FutureSetup -&gt; ShowS
$cshowsPrec :: Int -&gt; FutureSetup -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Haskell.Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. FutureSetup -&gt; Rep FutureSetup x)
-&gt; (forall x. Rep FutureSetup x -&gt; FutureSetup)
-&gt; Generic FutureSetup
forall x. Rep FutureSetup x -&gt; FutureSetup
forall x. FutureSetup -&gt; Rep FutureSetup x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
$cto :: forall x. Rep FutureSetup x -&gt; FutureSetup
$cfrom :: forall x. FutureSetup -&gt; Rep FutureSetup x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>          </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">anyclass</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680982492"><span id="local-6989586621680982494"><span id="local-6989586621680982496"><span id="local-6989586621680982498"><span class="annot"><span class="annottext">[FutureSetup] -&gt; Encoding
[FutureSetup] -&gt; Value
FutureSetup -&gt; Encoding
FutureSetup -&gt; Value
(FutureSetup -&gt; Value)
-&gt; (FutureSetup -&gt; Encoding)
-&gt; ([FutureSetup] -&gt; Value)
-&gt; ([FutureSetup] -&gt; Encoding)
-&gt; ToJSON FutureSetup
forall a.
(a -&gt; Value)
-&gt; (a -&gt; Encoding)
-&gt; ([a] -&gt; Value)
-&gt; ([a] -&gt; Encoding)
-&gt; ToJSON a
toEncodingList :: [FutureSetup] -&gt; Encoding
$ctoEncodingList :: [FutureSetup] -&gt; Encoding
toJSONList :: [FutureSetup] -&gt; Value
$ctoJSONList :: [FutureSetup] -&gt; Value
toEncoding :: FutureSetup -&gt; Encoding
$ctoEncoding :: FutureSetup -&gt; Encoding
toJSON :: FutureSetup -&gt; Value
$ctoJSON :: FutureSetup -&gt; Value
</span><a href="#local-6989586621680982492"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">ToJSON</span></a></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982488"><span id="local-6989586621680982490"><span class="annot"><span class="annottext">Value -&gt; Parser [FutureSetup]
Value -&gt; Parser FutureSetup
(Value -&gt; Parser FutureSetup)
-&gt; (Value -&gt; Parser [FutureSetup]) -&gt; FromJSON FutureSetup
forall a.
(Value -&gt; Parser a) -&gt; (Value -&gt; Parser [a]) -&gt; FromJSON a
parseJSONList :: Value -&gt; Parser [FutureSetup]
$cparseJSONList :: Value -&gt; Parser [FutureSetup]
parseJSON :: Value -&gt; Parser FutureSetup
$cparseJSON :: Value -&gt; Parser FutureSetup
</span><a href="#local-6989586621680982488"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">FromJSON</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-comment">{- note [Futures in Plutus]

A futures contract (&quot;future&quot;) is an agreement to change ownership of an
asset at a certain time (the delivery time) for an agreed price (the forward
price). The time of the transfer, and the price, are fixed at the beginning of
the contract.

A future can be settled either by actually exchanging the asset for the price
(physical settlement) or by exchanging the difference between the forward price
and the spot (current) price.

In Plutus we could do physical settlement for assets that exist on the
blockchain, that is, for tokens and currencies (everything that's a 'Value'). But
the contract implemented here is for cash settlement.

The agreement involves two parties, a buyer (long position) and a seller (short
position). At the delivery time the actual price of the asset (spot price) is
quite likely different from the forward price. If the spot price is higher than
the forward price, then the seller transfers the difference to the buyer. If
the spot price is lower than the forward price, then the buyer transfers money
to the seller. In either case there is a risk that the payer does not meet their
obligation (by simply not paying). To protect against this risk, the contract
includes a kind of deposit called &quot;margin&quot;.

Each party deposits an initial margin. If the price moves against the seller,
then the seller has to top up their margin periodically (in our case, once each
block). Likewise, if it moves against the buyer then the buyer has to top up
their margin. If either party fails to make a margin payment then the contract
will be settled early.

The current value of the underlying asset is determined by an oracle. See note
[Oracles] in Plutus.Contracts. Also note that we
wouldn't need oracles if this was a contract with physical settlement,

The contract has three phases: Initialisation, runtime, and settlement. In the
first phase both parties deposit their initial margins into an escrow contract.
The second phase is when the contract is &quot;live&quot;. In this phase the contract
is a state machine whose state is the 'MarginnAccounts' with the current margins.
The transition from the second to the third phase happens either after the
settlement date, or if the sport price has moved so far that one of the margin
accounts is underfunded. The runtime and settlement phases are modeled as a state
machine, with 'FutureState' and 'FutureAction' types.

-}</span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="annot"><a href="Plutus.Contracts.Future.html#mkAccounts"><span class="hs-identifier hs-type">mkAccounts</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier hs-type">Account</span></a></span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier hs-type">Account</span></a></span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span>
</span><span id="line-275"></span><span id="mkAccounts"><span class="annot"><span class="annottext">mkAccounts :: Account -&gt; Account -&gt; FutureAccounts
</span><a href="Plutus.Contracts.Future.html#mkAccounts"><span class="hs-identifier hs-var hs-var">mkAccounts</span></a></span></span><span> </span><span id="local-6989586621680982487"><span class="annot"><span class="annottext">Account
</span><a href="#local-6989586621680982487"><span class="hs-identifier hs-var">long</span></a></span></span><span> </span><span id="local-6989586621680982486"><span class="annot"><span class="annottext">Account
</span><a href="#local-6989586621680982486"><span class="hs-identifier hs-var">short</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="annottext">FutureAccounts :: Account
-&gt; ValidatorHash -&gt; Account -&gt; ValidatorHash -&gt; FutureAccounts
</span><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ftoLong :: Account
</span><a href="Plutus.Contracts.Future.html#ftoLong"><span class="hs-identifier hs-var">ftoLong</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Account
</span><a href="#local-6989586621680982487"><span class="hs-identifier hs-var">long</span></a></span><span>
</span><span id="line-278"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ftoLongAccount :: ValidatorHash
</span><a href="Plutus.Contracts.Future.html#ftoLongAccount"><span class="hs-identifier hs-var">ftoLongAccount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Account -&gt; ValidatorHash
</span><a href="Plutus.Contracts.TokenAccount.html#validatorHash"><span class="hs-identifier hs-var">TokenAccount.validatorHash</span></a></span><span> </span><span class="annot"><span class="annottext">Account
</span><a href="#local-6989586621680982487"><span class="hs-identifier hs-var">long</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ftoShort :: Account
</span><a href="Plutus.Contracts.Future.html#ftoShort"><span class="hs-identifier hs-var">ftoShort</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Account
</span><a href="#local-6989586621680982486"><span class="hs-identifier hs-var">short</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ftoShortAccount :: ValidatorHash
</span><a href="Plutus.Contracts.Future.html#ftoShortAccount"><span class="hs-identifier hs-var">ftoShortAccount</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Account -&gt; ValidatorHash
</span><a href="Plutus.Contracts.TokenAccount.html#validatorHash"><span class="hs-identifier hs-var">TokenAccount.validatorHash</span></a></span><span> </span><span class="annot"><span class="annottext">Account
</span><a href="#local-6989586621680982486"><span class="hs-identifier hs-var">short</span></a></span><span>
</span><span id="line-281"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-pragma hs-type">tokenFor</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-284"></span><span class="annot"><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-identifier hs-type">tokenFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-285"></span><span id="tokenFor"><span class="annot"><span class="annottext">tokenFor :: Role -&gt; FutureAccounts -&gt; Value
</span><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-identifier hs-var hs-var">tokenFor</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ftoLong :: FutureAccounts -&gt; Account
</span><a href="Plutus.Contracts.Future.html#ftoLong"><span class="hs-identifier hs-var">ftoLong</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier hs-type">Account</span></a></span><span> </span><span id="local-6989586621680982483"><span class="annot"><span class="annottext">AssetClass
</span><a href="#local-6989586621680982483"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AssetClass -&gt; Value
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">token</span></a></span><span> </span><span class="annot"><span class="annottext">AssetClass
</span><a href="#local-6989586621680982483"><span class="hs-identifier hs-var">cur</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ftoShort :: FutureAccounts -&gt; Account
</span><a href="Plutus.Contracts.Future.html#ftoShort"><span class="hs-identifier hs-var">ftoShort</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier hs-type">Account</span></a></span><span> </span><span id="local-6989586621680982481"><span class="annot"><span class="annottext">AssetClass
</span><a href="#local-6989586621680982481"><span class="hs-identifier hs-var">cur</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AssetClass -&gt; Value
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">token</span></a></span><span> </span><span class="annot"><span class="annottext">AssetClass
</span><a href="#local-6989586621680982481"><span class="hs-identifier hs-var">cur</span></a></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#adjustMargin"><span class="hs-pragma hs-type">adjustMargin</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- | Change the margin account of the role by the given amount.</span><span>
</span><span id="line-291"></span><span class="annot"><a href="Plutus.Contracts.Future.html#adjustMargin"><span class="hs-identifier hs-type">adjustMargin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span>
</span><span id="line-292"></span><span id="adjustMargin"><span class="annot"><span class="annottext">adjustMargin :: Role -&gt; Value -&gt; Margins -&gt; Margins
</span><a href="Plutus.Contracts.Future.html#adjustMargin"><span class="hs-identifier hs-var hs-var">adjustMargin</span></a></span></span><span> </span><span id="local-6989586621680982479"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982479"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621680982478"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982478"><span class="hs-identifier hs-var">value</span></a></span></span><span> </span><span id="local-6989586621680982477"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982477"><span class="hs-identifier hs-var">accounts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982479"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982477"><span class="hs-identifier hs-var">accounts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ftsLongMargin :: Value
</span><a href="Plutus.Contracts.Future.html#ftsLongMargin"><span class="hs-identifier hs-var">ftsLongMargin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsLongMargin"><span class="hs-identifier hs-var hs-var">ftsLongMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982477"><span class="hs-identifier hs-var">accounts</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982478"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982477"><span class="hs-identifier hs-var">accounts</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ftsShortMargin :: Value
</span><a href="Plutus.Contracts.Future.html#ftsShortMargin"><span class="hs-identifier hs-var">ftsShortMargin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#ftsShortMargin"><span class="hs-identifier hs-var hs-var">ftsShortMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982477"><span class="hs-identifier hs-var">accounts</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982478"><span class="hs-identifier hs-var">value</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#totalMargin"><span class="hs-pragma hs-type">totalMargin</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-298"></span><span class="hs-comment">-- | The combined value of both margin accounts.</span><span>
</span><span id="line-299"></span><span class="annot"><a href="Plutus.Contracts.Future.html#totalMargin"><span class="hs-identifier hs-type">totalMargin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-300"></span><span id="totalMargin"><span class="annot"><span class="annottext">totalMargin :: Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#totalMargin"><span class="hs-identifier hs-var hs-var">totalMargin</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982474"><span class="annot"><span class="annottext">Value
ftsShortMargin :: Value
ftsShortMargin :: Margins -&gt; Value
</span><a href="#local-6989586621680982474"><span class="hs-identifier hs-var hs-var">ftsShortMargin</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982473"><span class="annot"><span class="annottext">Value
ftsLongMargin :: Value
ftsLongMargin :: Margins -&gt; Value
</span><a href="#local-6989586621680982473"><span class="hs-identifier hs-var hs-var">ftsLongMargin</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982474"><span class="hs-identifier hs-var">ftsShortMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982473"><span class="hs-identifier hs-var">ftsLongMargin</span></a></span><span>
</span><span id="line-302"></span><span>
</span><span id="line-303"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#futureStateMachine"><span class="hs-pragma hs-type">futureStateMachine</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-304"></span><span class="annot"><a href="Plutus.Contracts.Future.html#futureStateMachine"><span class="hs-identifier hs-type">futureStateMachine</span></a></span><span>
</span><span id="line-305"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">StateMachine</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span>
</span><span id="line-308"></span><span id="futureStateMachine"><span class="annot"><span class="annottext">futureStateMachine :: Future -&gt; FutureAccounts -&gt; StateMachine FutureState FutureAction
</span><a href="Plutus.Contracts.Future.html#futureStateMachine"><span class="hs-identifier hs-var hs-var">futureStateMachine</span></a></span></span><span> </span><span id="local-6989586621680982472"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982472"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span id="local-6989586621680982471"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982471"><span class="hs-identifier hs-var">fos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ThreadToken
-&gt; (State FutureState
    -&gt; FutureAction
    -&gt; Maybe (TxConstraints Void Void, State FutureState))
-&gt; (FutureState -&gt; Bool)
-&gt; StateMachine FutureState FutureAction
forall s i.
Maybe ThreadToken
-&gt; (State s -&gt; i -&gt; Maybe (TxConstraints Void Void, State s))
-&gt; (s -&gt; Bool)
-&gt; StateMachine s i
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">SM.mkStateMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ThreadToken
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future
-&gt; FutureAccounts
-&gt; State FutureState
-&gt; FutureAction
-&gt; Maybe (TxConstraints Void Void, State FutureState)
</span><a href="Plutus.Contracts.Future.html#transition"><span class="hs-identifier hs-var">transition</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982472"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982471"><span class="hs-identifier hs-var">fos</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">FutureState -&gt; Bool
</span><a href="#local-6989586621680982468"><span class="hs-identifier hs-var">isFinal</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-309"></span><span>    </span><span id="local-6989586621680982468"><span class="annot"><span class="annottext">isFinal :: FutureState -&gt; Bool
</span><a href="#local-6989586621680982468"><span class="hs-identifier hs-var hs-var">isFinal</span></a></span></span><span> </span><span class="annot"><span class="annottext">FutureState
</span><a href="Plutus.Contracts.Future.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-310"></span><span>    </span><span class="annot"><a href="#local-6989586621680982468"><span class="hs-identifier hs-var">isFinal</span></a></span><span> </span><span class="annot"><span class="annottext">FutureState
</span><span class="hs-identifier">_</span></span><span>        </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span class="annot"><a href="Plutus.Contracts.Future.html#typedValidator"><span class="hs-identifier hs-type">typedValidator</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">Scripts.TypedValidator</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachine</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span id="typedValidator"><span class="annot"><span class="annottext">typedValidator :: Future
-&gt; FutureAccounts
-&gt; TypedValidator (StateMachine FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#typedValidator"><span class="hs-identifier hs-var hs-var">typedValidator</span></a></span></span><span> </span><span id="local-6989586621680982467"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982467"><span class="hs-identifier hs-var">future</span></a></span></span><span> </span><span id="local-6989586621680982466"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982466"><span class="hs-identifier hs-var">ftos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-314"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680982465"><span class="annot"><span class="annottext">val :: CompiledCodeIn
  DefaultUni
  DefaultFun
  (FutureState -&gt; FutureAction -&gt; ScriptContext -&gt; Bool)
</span><a href="#local-6989586621680982465"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">$$(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.compile</span></a></span><span> </span><span class="hs-special">[||</span><span> </span><span class="hs-identifier">validatorParam</span><span> </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>            </span><span class="annot"><span class="annottext">CompiledCode
  (Future
   -&gt; FutureAccounts
   -&gt; FutureState
   -&gt; FutureAction
   -&gt; ScriptContext
   -&gt; Bool)
-&gt; CompiledCodeIn DefaultUni DefaultFun Future
-&gt; CompiledCodeIn
     DefaultUni
     DefaultFun
     (FutureAccounts
      -&gt; FutureState -&gt; FutureAction -&gt; ScriptContext -&gt; Bool)
forall (uni :: * -&gt; *) fun a b.
(Closed uni, Everywhere uni Flat, Flat fun,
 Everywhere uni PrettyConst, GShow uni, Pretty fun) =&gt;
CompiledCodeIn uni fun (a -&gt; b)
-&gt; CompiledCodeIn uni fun a -&gt; CompiledCodeIn uni fun b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">`PlutusTx.applyCode`</span></a></span><span>
</span><span id="line-316"></span><span>                </span><span class="annot"><span class="annottext">Future -&gt; CompiledCodeIn DefaultUni DefaultFun Future
forall (uni :: * -&gt; *) a fun.
(Lift uni a, Throwable uni fun, Typecheckable uni fun) =&gt;
a -&gt; CompiledCodeIn uni fun a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.liftCode</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982467"><span class="hs-identifier hs-var">future</span></a></span><span>
</span><span id="line-317"></span><span>                </span><span class="annot"><span class="annottext">CompiledCodeIn
  DefaultUni
  DefaultFun
  (FutureAccounts
   -&gt; FutureState -&gt; FutureAction -&gt; ScriptContext -&gt; Bool)
-&gt; CompiledCodeIn DefaultUni DefaultFun FutureAccounts
-&gt; CompiledCodeIn
     DefaultUni
     DefaultFun
     (FutureState -&gt; FutureAction -&gt; ScriptContext -&gt; Bool)
forall (uni :: * -&gt; *) fun a b.
(Closed uni, Everywhere uni Flat, Flat fun,
 Everywhere uni PrettyConst, GShow uni, Pretty fun) =&gt;
CompiledCodeIn uni fun (a -&gt; b)
-&gt; CompiledCodeIn uni fun a -&gt; CompiledCodeIn uni fun b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">`PlutusTx.applyCode`</span></a></span><span>
</span><span id="line-318"></span><span>                    </span><span class="annot"><span class="annottext">FutureAccounts
-&gt; CompiledCodeIn DefaultUni DefaultFun FutureAccounts
forall (uni :: * -&gt; *) a fun.
(Lift uni a, Throwable uni fun, Typecheckable uni fun) =&gt;
a -&gt; CompiledCodeIn uni fun a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.liftCode</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982466"><span class="hs-identifier hs-var">ftos</span></a></span><span>
</span><span id="line-319"></span><span>        </span><span id="local-6989586621680982464"><span class="annot"><span class="annottext">validatorParam :: Future
-&gt; FutureAccounts
-&gt; ValidatorType (StateMachine FutureState FutureAction)
</span><a href="#local-6989586621680982464"><span class="hs-identifier hs-var hs-var">validatorParam</span></a></span></span><span> </span><span id="local-6989586621680982458"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982458"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621680982457"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982457"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachine FutureState FutureAction
-&gt; ValidatorType (StateMachine FutureState FutureAction)
forall s i.
ToData s =&gt;
StateMachine s i -&gt; ValidatorType (StateMachine s i)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">SM.mkValidator</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future -&gt; FutureAccounts -&gt; StateMachine FutureState FutureAction
</span><a href="Plutus.Contracts.Future.html#futureStateMachine"><span class="hs-identifier hs-var">futureStateMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982458"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982457"><span class="hs-identifier hs-var">g</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>        </span><span id="local-6989586621680982455"><span class="annot"><span class="annottext">wrap :: (FutureState -&gt; FutureAction -&gt; ScriptContext -&gt; Bool)
-&gt; UntypedValidator
</span><a href="#local-6989586621680982455"><span class="hs-identifier hs-var hs-var">wrap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(UnsafeFromData FutureState, UnsafeFromData FutureAction) =&gt;
(FutureState -&gt; FutureAction -&gt; ScriptContext -&gt; Bool)
-&gt; UntypedValidator
forall sc d r.
(IsScriptContext sc, UnsafeFromData d, UnsafeFromData r) =&gt;
(d -&gt; r -&gt; sc -&gt; Bool) -&gt; UntypedValidator
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.mkUntypedValidator</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">Scripts.ScriptContextV1</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">CompiledCode
  (ValidatorType (StateMachine FutureState FutureAction))
-&gt; CompiledCode
     (ValidatorType (StateMachine FutureState FutureAction)
      -&gt; UntypedValidator)
-&gt; TypedValidator (StateMachine FutureState FutureAction)
forall a.
CompiledCode (ValidatorType a)
-&gt; CompiledCode (ValidatorType a -&gt; UntypedValidator)
-&gt; TypedValidator a
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.mkTypedValidator</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachine</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><span class="annottext">CompiledCode
  (ValidatorType (StateMachine FutureState FutureAction))
CompiledCodeIn
  DefaultUni
  DefaultFun
  (FutureState -&gt; FutureAction -&gt; ScriptContext -&gt; Bool)
</span><a href="#local-6989586621680982465"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-324"></span><span>        </span><span class="hs-special">$$(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.compile</span></a></span><span> </span><span class="hs-special">[||</span><span> </span><span class="hs-identifier">wrap</span><span> </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span class="annot"><a href="Plutus.Contracts.Future.html#machineClient"><span class="hs-identifier hs-type">machineClient</span></a></span><span>
</span><span id="line-327"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-type">Scripts.TypedValidator</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachine</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachineClient</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span>
</span><span id="line-331"></span><span id="machineClient"><span class="annot"><span class="annottext">machineClient :: TypedValidator (StateMachine FutureState FutureAction)
-&gt; Future
-&gt; FutureAccounts
-&gt; StateMachineClient FutureState FutureAction
</span><a href="Plutus.Contracts.Future.html#machineClient"><span class="hs-identifier hs-var hs-var">machineClient</span></a></span></span><span> </span><span id="local-6989586621680982450"><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
</span><a href="#local-6989586621680982450"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span id="local-6989586621680982449"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982449"><span class="hs-identifier hs-var">future</span></a></span></span><span> </span><span id="local-6989586621680982448"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982448"><span class="hs-identifier hs-var">ftos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680982447"><span class="annot"><span class="annottext">machine :: StateMachine FutureState FutureAction
</span><a href="#local-6989586621680982447"><span class="hs-identifier hs-var hs-var">machine</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Future -&gt; FutureAccounts -&gt; StateMachine FutureState FutureAction
</span><a href="Plutus.Contracts.Future.html#futureStateMachine"><span class="hs-identifier hs-var">futureStateMachine</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982449"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982448"><span class="hs-identifier hs-var">ftos</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">StateMachineInstance FutureState FutureAction
-&gt; StateMachineClient FutureState FutureAction
forall state input.
StateMachineInstance state input -&gt; StateMachineClient state input
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">SM.mkStateMachineClient</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StateMachine FutureState FutureAction
-&gt; TypedValidator (StateMachine FutureState FutureAction)
-&gt; StateMachineInstance FutureState FutureAction
forall s i.
StateMachine s i
-&gt; TypedValidator (StateMachine s i) -&gt; StateMachineInstance s i
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">SM.StateMachineInstance</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachine FutureState FutureAction
</span><a href="#local-6989586621680982447"><span class="hs-identifier hs-var">machine</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
</span><a href="#local-6989586621680982450"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span class="annot"><a href="Plutus.Contracts.Future.html#validator"><span class="hs-identifier hs-type">validator</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Validator</span></a></span><span>
</span><span id="line-336"></span><span id="validator"><span class="annot"><span class="annottext">validator :: Future -&gt; FutureAccounts -&gt; Validator
</span><a href="Plutus.Contracts.Future.html#validator"><span class="hs-identifier hs-var hs-var">validator</span></a></span></span><span> </span><span id="local-6989586621680982444"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982444"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span id="local-6989586621680982443"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982443"><span class="hs-identifier hs-var">fos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction) -&gt; Validator
forall a. TypedValidator a -&gt; Validator
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.validatorScript</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future
-&gt; FutureAccounts
-&gt; TypedValidator (StateMachine FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982444"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982443"><span class="hs-identifier hs-var">fos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>
</span><span id="line-338"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#verifyOracle"><span class="hs-pragma hs-type">verifyOracle</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-339"></span><span id="local-6989586621680982967"><span class="annot"><a href="Plutus.Contracts.Future.html#verifyOracle"><span class="hs-identifier hs-type">verifyOracle</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982967"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982967"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621680982967"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-340"></span><span id="verifyOracle"><span class="annot"><span class="annottext">verifyOracle :: PaymentPubKey
-&gt; SignedMessage a -&gt; Maybe (a, TxConstraints Void Void)
</span><a href="Plutus.Contracts.Future.html#verifyOracle"><span class="hs-identifier hs-var hs-var">verifyOracle</span></a></span></span><span> </span><span id="local-6989586621680982440"><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680982440"><span class="hs-identifier hs-var">pubKey</span></a></span></span><span> </span><span id="local-6989586621680982439"><span class="annot"><span class="annottext">SignedMessage a
</span><a href="#local-6989586621680982439"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><span class="annottext">(SignedMessageCheckError -&gt; Maybe (a, TxConstraints Void Void))
-&gt; ((a, TxConstraints Void Void)
    -&gt; Maybe (a, TxConstraints Void Void))
-&gt; Either SignedMessageCheckError (a, TxConstraints Void Void)
-&gt; Maybe (a, TxConstraints Void Void)
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (a, TxConstraints Void Void)
-&gt; SignedMessageCheckError -&gt; Maybe (a, TxConstraints Void Void)
forall a b. a -&gt; b -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">const</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (a, TxConstraints Void Void)
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a, TxConstraints Void Void) -&gt; Maybe (a, TxConstraints Void Void)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">pure</span></a></span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">(Either SignedMessageCheckError (a, TxConstraints Void Void)
 -&gt; Maybe (a, TxConstraints Void Void))
-&gt; Either SignedMessageCheckError (a, TxConstraints Void Void)
-&gt; Maybe (a, TxConstraints Void Void)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
-&gt; SignedMessage a
-&gt; Either SignedMessageCheckError (a, TxConstraints Void Void)
forall a i o.
FromData a =&gt;
PaymentPubKey
-&gt; SignedMessage a
-&gt; Either SignedMessageCheckError (a, TxConstraints i o)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Oracle.verifySignedMessageConstraints</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680982440"><span class="hs-identifier hs-var">pubKey</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessage a
</span><a href="#local-6989586621680982439"><span class="hs-identifier hs-var">sm</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span id="local-6989586621680982435"><span class="annot"><a href="Plutus.Contracts.Future.html#verifyOracleOffChain"><span class="hs-identifier hs-type">verifyOracleOffChain</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.FromData</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982435"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982435"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621680982435"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-345"></span><span id="verifyOracleOffChain"><span class="annot"><span class="annottext">verifyOracleOffChain :: Future -&gt; SignedMessage (Observation a) -&gt; Maybe (POSIXTime, a)
</span><a href="Plutus.Contracts.Future.html#verifyOracleOffChain"><span class="hs-identifier hs-var hs-var">verifyOracleOffChain</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982433"><span class="annot"><span class="annottext">PaymentPubKey
ftPriceOracle :: PaymentPubKey
ftPriceOracle :: Future -&gt; PaymentPubKey
</span><a href="#local-6989586621680982433"><span class="hs-identifier hs-var hs-var">ftPriceOracle</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680982432"><span class="annot"><span class="annottext">SignedMessage (Observation a)
</span><a href="#local-6989586621680982432"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
-&gt; SignedMessage (Observation a)
-&gt; Either SignedMessageCheckError (Observation a)
forall a.
FromData a =&gt;
PaymentPubKey
-&gt; SignedMessage a -&gt; Either SignedMessageCheckError a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Oracle.verifySignedMessageOffChain</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680982433"><span class="hs-identifier hs-var">ftPriceOracle</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessage (Observation a)
</span><a href="#local-6989586621680982432"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessageCheckError
</span><span class="hs-identifier">_</span></span><span>                               </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (POSIXTime, a)
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982429"><span class="annot"><span class="annottext">a
obsValue :: forall a. Observation a -&gt; a
obsValue :: a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">obsValue</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982427"><span class="annot"><span class="annottext">POSIXTime
obsTime :: forall a. Observation a -&gt; POSIXTime
obsTime :: POSIXTime
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">obsTime</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(POSIXTime, a) -&gt; Maybe (POSIXTime, a)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982427"><span class="hs-identifier hs-var">obsTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621680982429"><span class="hs-identifier hs-var">obsValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#transition"><span class="hs-pragma hs-type">transition</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-351"></span><span class="annot"><a href="Plutus.Contracts.Future.html#transition"><span class="hs-identifier hs-type">transition</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span id="transition"><span class="annot"><span class="annottext">transition :: Future
-&gt; FutureAccounts
-&gt; State FutureState
-&gt; FutureAction
-&gt; Maybe (TxConstraints Void Void, State FutureState)
</span><a href="Plutus.Contracts.Future.html#transition"><span class="hs-identifier hs-var hs-var">transition</span></a></span></span><span> </span><span id="local-6989586621680982425"><span class="annot"><span class="annottext">future :: Future
</span><a href="#local-6989586621680982425"><span class="hs-identifier hs-var">future</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982424"><span class="annot"><span class="annottext">POSIXTime
ftDeliveryDate :: POSIXTime
ftDeliveryDate :: Future -&gt; POSIXTime
</span><a href="#local-6989586621680982424"><span class="hs-identifier hs-var hs-var">ftDeliveryDate</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982423"><span class="annot"><span class="annottext">PaymentPubKey
ftPriceOracle :: PaymentPubKey
ftPriceOracle :: Future -&gt; PaymentPubKey
</span><a href="#local-6989586621680982423"><span class="hs-identifier hs-var hs-var">ftPriceOracle</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680982422"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982422"><span class="hs-identifier hs-var">owners</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">State</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateData :: forall s. State s -&gt; s
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateData</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680982419"><span class="annot"><span class="annottext">FutureState
</span><a href="#local-6989586621680982419"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stateValue :: forall s. State s -&gt; Value
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateValue</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680982417"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982417"><span class="hs-identifier hs-var">currentValue</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680982416"><span class="annot"><span class="annottext">FutureAction
</span><a href="#local-6989586621680982416"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FutureState
</span><a href="#local-6989586621680982419"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FutureAction
</span><a href="#local-6989586621680982416"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-354"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-type">Running</span></a></span><span> </span><span id="local-6989586621680982415"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982415"><span class="hs-identifier hs-var">accounts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#AdjustMargin"><span class="hs-identifier hs-type">AdjustMargin</span></a></span><span> </span><span id="local-6989586621680982414"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982414"><span class="hs-keyword hs-var">role</span></a></span></span><span> </span><span id="local-6989586621680982413"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982413"><span class="hs-identifier hs-var">topUp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-355"></span><span>            </span><span class="annot"><span class="annottext">(TxConstraints Void Void, State FutureState)
-&gt; Maybe (TxConstraints Void Void, State FutureState)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
forall a. Monoid a =&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-356"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State :: forall s. s -&gt; Value -&gt; State s
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">State</span></a></span><span>
</span><span id="line-357"></span><span>                    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stateData :: FutureState
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateData</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Margins -&gt; FutureState
</span><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Value -&gt; Margins -&gt; Margins
</span><a href="Plutus.Contracts.Future.html#adjustMargin"><span class="hs-identifier hs-var">adjustMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982414"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982413"><span class="hs-identifier hs-var">topUp</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982415"><span class="hs-identifier hs-var">accounts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stateValue :: Value
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateValue</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982413"><span class="hs-identifier hs-var">topUp</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#totalMargin"><span class="hs-identifier hs-var">totalMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982415"><span class="hs-identifier hs-var">accounts</span></a></span><span>
</span><span id="line-359"></span><span>                    </span><span class="hs-special">}</span><span>
</span><span id="line-360"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-type">Running</span></a></span><span> </span><span id="local-6989586621680982411"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982411"><span class="hs-identifier hs-var">accounts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Settle"><span class="hs-identifier hs-type">Settle</span></a></span><span> </span><span id="local-6989586621680982410"><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982410"><span class="hs-identifier hs-var">ov</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">obsValue :: forall a. Observation a -&gt; a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">obsValue</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680982409"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982409"><span class="hs-identifier hs-var">spotPrice</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">obsTime :: forall a. Observation a -&gt; POSIXTime
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">obsTime</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680982408"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982408"><span class="hs-identifier hs-var">oracleDate</span></a></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982407"><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680982407"><span class="hs-identifier hs-var">oracleConstraints</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
-&gt; SignedMessage (Observation Value)
-&gt; Maybe (Observation Value, TxConstraints Void Void)
forall a.
FromData a =&gt;
PaymentPubKey
-&gt; SignedMessage a -&gt; Maybe (a, TxConstraints Void Void)
</span><a href="Plutus.Contracts.Future.html#verifyOracle"><span class="hs-identifier hs-var">verifyOracle</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680982423"><span class="hs-identifier hs-var">ftPriceOracle</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982410"><span class="hs-identifier hs-var">ov</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982424"><span class="hs-identifier hs-var">ftDeliveryDate</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982408"><span class="hs-identifier hs-var">oracleDate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-363"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680982406"><span class="annot"><span class="annottext">payment :: Payouts
</span><a href="#local-6989586621680982406"><span class="hs-identifier hs-var hs-var">payment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Future -&gt; Margins -&gt; Value -&gt; Payouts
</span><a href="Plutus.Contracts.Future.html#payouts"><span class="hs-identifier hs-var">payouts</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982425"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982411"><span class="hs-identifier hs-var">accounts</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982409"><span class="hs-identifier hs-var">spotPrice</span></a></span><span>
</span><span id="line-364"></span><span>                    </span><span id="local-6989586621680982404"><span class="annot"><span class="annottext">constraints :: TxConstraints Void Void
</span><a href="#local-6989586621680982404"><span class="hs-identifier hs-var hs-var">constraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-365"></span><span>                        </span><span class="annot"><span class="annottext">ValidityInterval POSIXTime -&gt; TxConstraints Void Void
forall i o. ValidityInterval POSIXTime -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustValidateInTimeRange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">POSIXTime -&gt; ValidityInterval POSIXTime
forall a. a -&gt; ValidityInterval a
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Interval.from</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982424"><span class="hs-identifier hs-var">ftDeliveryDate</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-366"></span><span>                        </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680982407"><span class="hs-identifier hs-var">oracleConstraints</span></a></span><span>
</span><span id="line-367"></span><span>                        </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Payouts -&gt; FutureAccounts -&gt; TxConstraints Void Void
</span><a href="Plutus.Contracts.Future.html#payoutsTx"><span class="hs-identifier hs-var">payoutsTx</span></a></span><span> </span><span class="annot"><span class="annottext">Payouts
</span><a href="#local-6989586621680982406"><span class="hs-identifier hs-var">payment</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982422"><span class="hs-identifier hs-var">owners</span></a></span><span>
</span><span id="line-368"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(TxConstraints Void Void, State FutureState)
-&gt; Maybe (TxConstraints Void Void, State FutureState)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680982404"><span class="hs-identifier hs-var">constraints</span></a></span><span>
</span><span id="line-369"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State :: forall s. s -&gt; Value -&gt; State s
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">State</span></a></span><span>
</span><span id="line-370"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stateData :: FutureState
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateData</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FutureState
</span><a href="Plutus.Contracts.Future.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>
</span><span id="line-371"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stateValue :: Value
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateValue</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
forall a. Monoid a =&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-372"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-373"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-type">Running</span></a></span><span> </span><span id="local-6989586621680982399"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982399"><span class="hs-identifier hs-var">accounts</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#SettleEarly"><span class="hs-identifier hs-type">SettleEarly</span></a></span><span> </span><span id="local-6989586621680982398"><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982398"><span class="hs-identifier hs-var">ov</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-375"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">obsValue :: forall a. Observation a -&gt; a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">obsValue</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680982397"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982397"><span class="hs-identifier hs-var">spotPrice</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">obsTime :: forall a. Observation a -&gt; POSIXTime
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">obsTime</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680982396"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982396"><span class="hs-identifier hs-var">oracleDate</span></a></span></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982395"><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680982395"><span class="hs-identifier hs-var">oracleConstraints</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
-&gt; SignedMessage (Observation Value)
-&gt; Maybe (Observation Value, TxConstraints Void Void)
forall a.
FromData a =&gt;
PaymentPubKey
-&gt; SignedMessage a -&gt; Maybe (a, TxConstraints Void Void)
</span><a href="Plutus.Contracts.Future.html#verifyOracle"><span class="hs-identifier hs-var">verifyOracle</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680982423"><span class="hs-identifier hs-var">ftPriceOracle</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982398"><span class="hs-identifier hs-var">ov</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621680982394"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982394"><span class="hs-identifier hs-var">vRole</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Future -&gt; Margins -&gt; Value -&gt; Maybe Role
</span><a href="Plutus.Contracts.Future.html#violatingRole"><span class="hs-identifier hs-var">violatingRole</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982425"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982399"><span class="hs-identifier hs-var">accounts</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982397"><span class="hs-identifier hs-var">spotPrice</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982424"><span class="hs-identifier hs-var">ftDeliveryDate</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982396"><span class="hs-identifier hs-var">oracleDate</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-376"></span><span>                </span><span class="hs-keyword">let</span><span>
</span><span id="line-377"></span><span>                    </span><span id="local-6989586621680982391"><span class="annot"><span class="annottext">total :: Value
</span><a href="#local-6989586621680982391"><span class="hs-identifier hs-var hs-var">total</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Margins -&gt; Value
</span><a href="Plutus.Contracts.Future.html#totalMargin"><span class="hs-identifier hs-var">totalMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982399"><span class="hs-identifier hs-var">accounts</span></a></span><span>
</span><span id="line-378"></span><span>                    </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982390"><span class="annot"><span class="annottext">ValidatorHash
ftoLongAccount :: ValidatorHash
ftoLongAccount :: FutureAccounts -&gt; ValidatorHash
</span><a href="#local-6989586621680982390"><span class="hs-identifier hs-var hs-var">ftoLongAccount</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982389"><span class="annot"><span class="annottext">ValidatorHash
ftoShortAccount :: ValidatorHash
ftoShortAccount :: FutureAccounts -&gt; ValidatorHash
</span><a href="#local-6989586621680982389"><span class="hs-identifier hs-var hs-var">ftoShortAccount</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982422"><span class="hs-identifier hs-var">owners</span></a></span><span>
</span><span id="line-379"></span><span>                    </span><span id="local-6989586621680982388"><span class="annot"><span class="annottext">payment :: TxConstraints Void Void
</span><a href="#local-6989586621680982388"><span class="hs-identifier hs-var hs-var">payment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-380"></span><span>                        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982394"><span class="hs-identifier hs-var">vRole</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-381"></span><span>                          </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints Void Void
forall i o. ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustPayToOtherScriptWithDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680982390"><span class="hs-identifier hs-var">ftoLongAccount</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">unitDatum</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982391"><span class="hs-identifier hs-var">total</span></a></span><span>
</span><span id="line-382"></span><span>                                </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Datum -&gt; TxConstraints Void Void
forall i o. Datum -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustIncludeDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">unitDatum</span></a></span><span>
</span><span id="line-383"></span><span>                          </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints Void Void
forall i o. ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustPayToOtherScriptWithDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680982389"><span class="hs-identifier hs-var">ftoShortAccount</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">unitDatum</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982391"><span class="hs-identifier hs-var">total</span></a></span><span>
</span><span id="line-384"></span><span>                                </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Datum -&gt; TxConstraints Void Void
forall i o. Datum -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustIncludeDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">unitDatum</span></a></span><span>
</span><span id="line-385"></span><span>                    </span><span id="local-6989586621680982385"><span class="annot"><span class="annottext">constraints :: TxConstraints Void Void
</span><a href="#local-6989586621680982385"><span class="hs-identifier hs-var hs-var">constraints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680982388"><span class="hs-identifier hs-var">payment</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680982395"><span class="hs-identifier hs-var">oracleConstraints</span></a></span><span>
</span><span id="line-386"></span><span>                </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(TxConstraints Void Void, State FutureState)
-&gt; Maybe (TxConstraints Void Void, State FutureState)
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TxConstraints Void Void
</span><a href="#local-6989586621680982385"><span class="hs-identifier hs-var">constraints</span></a></span><span>
</span><span id="line-387"></span><span>                        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">State :: forall s. s -&gt; Value -&gt; State s
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">State</span></a></span><span>
</span><span id="line-388"></span><span>                            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stateData :: FutureState
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateData</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FutureState
</span><a href="Plutus.Contracts.Future.html#Finished"><span class="hs-identifier hs-var">Finished</span></a></span><span>
</span><span id="line-389"></span><span>                            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">stateValue :: Value
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">stateValue</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
forall a. Monoid a =&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">mempty</span></a></span><span>
</span><span id="line-390"></span><span>                            </span><span class="hs-special">}</span><span>
</span><span id="line-391"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-392"></span><span>        </span><span class="annot"><span class="annottext">(FutureState, FutureAction)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (TxConstraints Void Void, State FutureState)
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span class="hs-keyword">data</span><span> </span><span id="Payouts"><span class="annot"><a href="Plutus.Contracts.Future.html#Payouts"><span class="hs-identifier hs-var">Payouts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-395"></span><span>    </span><span id="Payouts"><span class="annot"><a href="Plutus.Contracts.Future.html#Payouts"><span class="hs-identifier hs-var">Payouts</span></a></span></span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-special">{</span><span> </span><span id="payoutsShort"><span class="annot"><span class="annottext">Payouts -&gt; Value
</span><a href="Plutus.Contracts.Future.html#payoutsShort"><span class="hs-identifier hs-var hs-var">payoutsShort</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-397"></span><span>        </span><span class="hs-special">,</span><span> </span><span id="payoutsLong"><span class="annot"><span class="annottext">Payouts -&gt; Value
</span><a href="Plutus.Contracts.Future.html#payoutsLong"><span class="hs-identifier hs-var hs-var">payoutsLong</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-398"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#payoutsTx"><span class="hs-pragma hs-type">payoutsTx</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-401"></span><span class="annot"><a href="Plutus.Contracts.Future.html#payoutsTx"><span class="hs-identifier hs-type">payoutsTx</span></a></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Payouts"><span class="hs-identifier hs-type">Payouts</span></a></span><span>
</span><span id="line-403"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span>
</span><span id="line-404"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-type">TxConstraints</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Void</span></a></span><span>
</span><span id="line-405"></span><span id="payoutsTx"><span class="annot"><span class="annottext">payoutsTx :: Payouts -&gt; FutureAccounts -&gt; TxConstraints Void Void
</span><a href="Plutus.Contracts.Future.html#payoutsTx"><span class="hs-identifier hs-var hs-var">payoutsTx</span></a></span></span><span>
</span><span id="line-406"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Future.html#Payouts"><span class="hs-identifier hs-type">Payouts</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982381"><span class="annot"><span class="annottext">Value
payoutsShort :: Value
payoutsShort :: Payouts -&gt; Value
</span><a href="#local-6989586621680982381"><span class="hs-identifier hs-var hs-var">payoutsShort</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982380"><span class="annot"><span class="annottext">Value
payoutsLong :: Value
payoutsLong :: Payouts -&gt; Value
</span><a href="#local-6989586621680982380"><span class="hs-identifier hs-var hs-var">payoutsLong</span></a></span></span><span class="hs-special">}</span><span>
</span><span id="line-407"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982379"><span class="annot"><span class="annottext">ValidatorHash
ftoLongAccount :: ValidatorHash
ftoLongAccount :: FutureAccounts -&gt; ValidatorHash
</span><a href="#local-6989586621680982379"><span class="hs-identifier hs-var hs-var">ftoLongAccount</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982378"><span class="annot"><span class="annottext">ValidatorHash
ftoShortAccount :: ValidatorHash
ftoShortAccount :: FutureAccounts -&gt; ValidatorHash
</span><a href="#local-6989586621680982378"><span class="hs-identifier hs-var hs-var">ftoShortAccount</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-408"></span><span>        </span><span class="annot"><span class="annottext">ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints Void Void
forall i o. ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustPayToOtherScriptWithDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680982379"><span class="hs-identifier hs-var">ftoLongAccount</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">unitDatum</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982380"><span class="hs-identifier hs-var">payoutsLong</span></a></span><span>
</span><span id="line-409"></span><span>        </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints Void Void
forall i o. ValidatorHash -&gt; Datum -&gt; Value -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustPayToOtherScriptWithDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680982378"><span class="hs-identifier hs-var">ftoShortAccount</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">unitDatum</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982381"><span class="hs-identifier hs-var">payoutsShort</span></a></span><span>
</span><span id="line-410"></span><span>        </span><span class="annot"><span class="annottext">TxConstraints Void Void
-&gt; TxConstraints Void Void -&gt; TxConstraints Void Void
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Datum -&gt; TxConstraints Void Void
forall i o. Datum -&gt; TxConstraints i o
</span><a href="../../../../plutus-ledger-constraints/html/src"><span class="hs-identifier hs-var">Constraints.mustIncludeDatumInTx</span></a></span><span> </span><span class="annot"><span class="annottext">Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">unitDatum</span></a></span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#payouts"><span class="hs-pragma hs-type">payouts</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-413"></span><span class="hs-comment">-- | Compute the payouts for each role given the future data,</span><span>
</span><span id="line-414"></span><span class="hs-comment">--   margin accounts, and current (spot) price</span><span>
</span><span id="line-415"></span><span class="annot"><a href="Plutus.Contracts.Future.html#payouts"><span class="hs-identifier hs-type">payouts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Payouts"><span class="hs-identifier hs-type">Payouts</span></a></span><span>
</span><span id="line-416"></span><span id="payouts"><span class="annot"><span class="annottext">payouts :: Future -&gt; Margins -&gt; Value -&gt; Payouts
</span><a href="Plutus.Contracts.Future.html#payouts"><span class="hs-identifier hs-var hs-var">payouts</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982377"><span class="annot"><span class="annottext">Integer
ftUnits :: Integer
ftUnits :: Future -&gt; Integer
</span><a href="#local-6989586621680982377"><span class="hs-identifier hs-var hs-var">ftUnits</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982376"><span class="annot"><span class="annottext">Value
ftUnitPrice :: Value
ftUnitPrice :: Future -&gt; Value
</span><a href="#local-6989586621680982376"><span class="hs-identifier hs-var hs-var">ftUnitPrice</span></a></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982375"><span class="annot"><span class="annottext">Value
ftsShortMargin :: Value
ftsShortMargin :: Margins -&gt; Value
</span><a href="#local-6989586621680982375"><span class="hs-identifier hs-var hs-var">ftsShortMargin</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982374"><span class="annot"><span class="annottext">Value
ftsLongMargin :: Value
ftsLongMargin :: Margins -&gt; Value
</span><a href="#local-6989586621680982374"><span class="hs-identifier hs-var hs-var">ftsLongMargin</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680982373"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982373"><span class="hs-identifier hs-var">spotPrice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-417"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680982372"><span class="annot"><span class="annottext">delta :: Value
</span><a href="#local-6989586621680982372"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Value -&gt; Value
forall s v. Module s v =&gt; s -&gt; v -&gt; v
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">scale</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680982377"><span class="hs-identifier hs-var">ftUnits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982373"><span class="hs-identifier hs-var">spotPrice</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveGroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982376"><span class="hs-identifier hs-var">ftUnitPrice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Payouts :: Value -&gt; Value -&gt; Payouts
</span><a href="Plutus.Contracts.Future.html#Payouts"><span class="hs-identifier hs-type">Payouts</span></a></span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">payoutsShort :: Value
</span><a href="Plutus.Contracts.Future.html#payoutsShort"><span class="hs-identifier hs-var">payoutsShort</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982375"><span class="hs-identifier hs-var">ftsShortMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveGroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982372"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-420"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">payoutsLong :: Value
</span><a href="Plutus.Contracts.Future.html#payoutsLong"><span class="hs-identifier hs-var">payoutsLong</span></a></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982374"><span class="hs-identifier hs-var">ftsLongMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982372"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-421"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="hs-comment">-- | Compute the required margin from the current price of the</span><span>
</span><span id="line-424"></span><span class="hs-comment">--   underlying asset.</span><span>
</span><span id="line-425"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#requiredMargin"><span class="hs-pragma hs-type">requiredMargin</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-426"></span><span class="annot"><a href="Plutus.Contracts.Future.html#requiredMargin"><span class="hs-identifier hs-type">requiredMargin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-427"></span><span id="requiredMargin"><span class="annot"><span class="annottext">requiredMargin :: Future -&gt; Value -&gt; Value
</span><a href="Plutus.Contracts.Future.html#requiredMargin"><span class="hs-identifier hs-var hs-var">requiredMargin</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982368"><span class="annot"><span class="annottext">Integer
ftUnits :: Integer
ftUnits :: Future -&gt; Integer
</span><a href="#local-6989586621680982368"><span class="hs-identifier hs-var hs-var">ftUnits</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982367"><span class="annot"><span class="annottext">Value
ftUnitPrice :: Value
ftUnitPrice :: Future -&gt; Value
</span><a href="#local-6989586621680982367"><span class="hs-identifier hs-var hs-var">ftUnitPrice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982366"><span class="annot"><span class="annottext">Value
ftMarginPenalty :: Value
ftMarginPenalty :: Future -&gt; Value
</span><a href="#local-6989586621680982366"><span class="hs-identifier hs-var hs-var">ftMarginPenalty</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680982365"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982365"><span class="hs-identifier hs-var">spotPrice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-429"></span><span>        </span><span id="local-6989586621680982364"><span class="annot"><span class="annottext">delta :: Value
</span><a href="#local-6989586621680982364"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Value -&gt; Value
forall s v. Module s v =&gt; s -&gt; v -&gt; v
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">scale</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680982368"><span class="hs-identifier hs-var">ftUnits</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982365"><span class="hs-identifier hs-var">spotPrice</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveGroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982367"><span class="hs-identifier hs-var">ftUnitPrice</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-431"></span><span>        </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982366"><span class="hs-identifier hs-var">ftMarginPenalty</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982364"><span class="hs-identifier hs-var">delta</span></a></span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-pragma hs-type">initialMargin</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-434"></span><span class="annot"><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-identifier hs-type">initialMargin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-435"></span><span id="initialMargin"><span class="annot"><span class="annottext">initialMargin :: Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-identifier hs-var hs-var">initialMargin</span></a></span></span><span> </span><span id="local-6989586621680982363"><span class="annot"><span class="annottext">ft :: Future
</span><a href="#local-6989586621680982363"><span class="hs-identifier hs-var">ft</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982362"><span class="annot"><span class="annottext">Value
ftUnitPrice :: Value
ftUnitPrice :: Future -&gt; Value
</span><a href="#local-6989586621680982362"><span class="hs-identifier hs-var hs-var">ftUnitPrice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982361"><span class="annot"><span class="annottext">Value
ftMarginPenalty :: Value
ftMarginPenalty :: Future -&gt; Value
</span><a href="#local-6989586621680982361"><span class="hs-identifier hs-var hs-var">ftMarginPenalty</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982361"><span class="hs-identifier hs-var">ftMarginPenalty</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982362"><span class="hs-identifier hs-var">ftUnitPrice</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#initialState"><span class="hs-pragma hs-type">initialState</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-439"></span><span class="hs-comment">-- | The initial state of the 'Future' contract</span><span>
</span><span id="line-440"></span><span class="annot"><a href="Plutus.Contracts.Future.html#initialState"><span class="hs-identifier hs-type">initialState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span>
</span><span id="line-441"></span><span id="initialState"><span class="annot"><span class="annottext">initialState :: Future -&gt; FutureState
</span><a href="Plutus.Contracts.Future.html#initialState"><span class="hs-identifier hs-var hs-var">initialState</span></a></span></span><span> </span><span id="local-6989586621680982360"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982360"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680982359"><span class="annot"><span class="annottext">im :: Value
</span><a href="#local-6989586621680982359"><span class="hs-identifier hs-var hs-var">im</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-identifier hs-var">initialMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982360"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="hs-keyword">in</span><span>
</span><span id="line-443"></span><span>    </span><span class="annot"><span class="annottext">Margins -&gt; FutureState
</span><a href="Plutus.Contracts.Future.html#Running"><span class="hs-identifier hs-var">Running</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Margins :: Value -&gt; Value -&gt; Margins
</span><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ftsShortMargin :: Value
</span><a href="Plutus.Contracts.Future.html#ftsShortMargin"><span class="hs-identifier hs-var">ftsShortMargin</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982359"><span class="hs-identifier hs-var">im</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ftsLongMargin :: Value
</span><a href="Plutus.Contracts.Future.html#ftsLongMargin"><span class="hs-identifier hs-var">ftsLongMargin</span></a></span><span class="hs-glyph">=</span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982359"><span class="hs-identifier hs-var">im</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>
</span><span id="line-445"></span><span class="annot"><a href="Plutus.Contracts.Future.html#futureAddress"><span class="hs-identifier hs-type">futureAddress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Address</span></a></span><span>
</span><span id="line-446"></span><span id="futureAddress"><span class="annot"><span class="annottext">futureAddress :: Future -&gt; FutureAccounts -&gt; Address
</span><a href="Plutus.Contracts.Future.html#futureAddress"><span class="hs-identifier hs-var hs-var">futureAddress</span></a></span></span><span> </span><span id="local-6989586621680982358"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982358"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span id="local-6989586621680982357"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982357"><span class="hs-identifier hs-var">fo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Validator -&gt; Address
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">mkValidatorAddress</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future -&gt; FutureAccounts -&gt; Validator
</span><a href="Plutus.Contracts.Future.html#validator"><span class="hs-identifier hs-var">validator</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982358"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982357"><span class="hs-identifier hs-var">fo</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#violatingRole"><span class="hs-pragma hs-type">violatingRole</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- | The role that violated its margin requirements</span><span>
</span><span id="line-450"></span><span class="annot"><a href="Plutus.Contracts.Future.html#violatingRole"><span class="hs-identifier hs-type">violatingRole</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span>
</span><span id="line-451"></span><span id="violatingRole"><span class="annot"><span class="annottext">violatingRole :: Future -&gt; Margins -&gt; Value -&gt; Maybe Role
</span><a href="Plutus.Contracts.Future.html#violatingRole"><span class="hs-identifier hs-var hs-var">violatingRole</span></a></span></span><span> </span><span id="local-6989586621680982356"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982356"><span class="hs-identifier hs-var">future</span></a></span></span><span> </span><span id="local-6989586621680982355"><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982355"><span class="hs-identifier hs-var">margins</span></a></span></span><span> </span><span id="local-6989586621680982354"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982354"><span class="hs-identifier hs-var">spotPrice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-452"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-453"></span><span>        </span><span id="local-6989586621680982353"><span class="annot"><span class="annottext">minMargin :: Value
</span><a href="#local-6989586621680982353"><span class="hs-identifier hs-var hs-var">minMargin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Future -&gt; Value -&gt; Value
</span><a href="Plutus.Contracts.Future.html#requiredMargin"><span class="hs-identifier hs-var">requiredMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982356"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982354"><span class="hs-identifier hs-var">spotPrice</span></a></span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><a href="Plutus.Contracts.Future.html#Margins"><span class="hs-identifier hs-type">Margins</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982352"><span class="annot"><span class="annottext">Value
ftsShortMargin :: Value
ftsShortMargin :: Margins -&gt; Value
</span><a href="#local-6989586621680982352"><span class="hs-identifier hs-var hs-var">ftsShortMargin</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982351"><span class="annot"><span class="annottext">Value
ftsLongMargin :: Value
ftsLongMargin :: Margins -&gt; Value
</span><a href="#local-6989586621680982351"><span class="hs-identifier hs-var hs-var">ftsLongMargin</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Margins
</span><a href="#local-6989586621680982355"><span class="hs-identifier hs-var">margins</span></a></span><span>
</span><span id="line-455"></span><span>    </span><span class="hs-keyword">in</span><span>
</span><span id="line-456"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982352"><span class="hs-identifier hs-var">ftsShortMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`lt`</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982353"><span class="hs-identifier hs-var">minMargin</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Maybe Role
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span>
</span><span id="line-457"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982351"><span class="hs-identifier hs-var">ftsLongMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-operator hs-var">`lt`</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982353"><span class="hs-identifier hs-var">minMargin</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Role -&gt; Maybe Role
forall a. a -&gt; Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe Role
forall a. Maybe a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span class="hs-comment">-- | Initialise the contract by</span><span>
</span><span id="line-461"></span><span class="hs-comment">--   * Generating the tokens for long and short</span><span>
</span><span id="line-462"></span><span class="hs-comment">--   * Setting up an escrow contract for the initial margins</span><span>
</span><span id="line-463"></span><span class="hs-comment">--   * Paying the initial margin for the given role</span><span>
</span><span id="line-464"></span><span id="local-6989586621680983070"><span id="local-6989586621680983071"><span id="local-6989586621680983072"><span class="annot"><a href="Plutus.Contracts.Future.html#initialiseFuture"><span class="hs-identifier hs-type">initialiseFuture</span></a></span><span>
</span><span id="line-465"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;initialise-future&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680983072"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-466"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#AsFutureError"><span class="hs-identifier hs-type">AsFutureError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983071"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-467"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span>
</span><span id="line-469"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983070"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983072"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983071"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachineClient</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-470"></span><span id="initialiseFuture"><span class="annot"><span class="annottext">initialiseFuture :: Future
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#initialiseFuture"><span class="hs-identifier hs-var hs-var">initialiseFuture</span></a></span></span><span> </span><span id="local-6989586621680982349"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982349"><span class="hs-identifier hs-var">future</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Contract
   w s FutureError (StateMachineClient FutureState FutureAction)
 -&gt; Contract w s e (StateMachineClient FutureState FutureAction))
-&gt; Promise
     w s FutureError (StateMachineClient FutureState FutureAction)
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
forall w1 (s1 :: Row *) e1 a1 w2 (s2 :: Row *) e2 a2.
(Contract w1 s1 e1 a1 -&gt; Contract w2 s2 e2 a2)
-&gt; Promise w1 s1 e1 a1 -&gt; Promise w2 s2 e2 a2
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">promiseMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FutureError -&gt; e)
-&gt; Contract
     w s FutureError (StateMachineClient FutureState FutureAction)
-&gt; Contract w s e (StateMachineClient FutureState FutureAction)
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e FutureError -&gt; FutureError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e FutureError
forall r. AsFutureError r =&gt; Prism' r FutureError
</span><a href="Plutus.Contracts.Future.html#_FutureError"><span class="hs-identifier hs-var">_FutureError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Promise
   w s FutureError (StateMachineClient FutureState FutureAction)
 -&gt; Promise w s e (StateMachineClient FutureState FutureAction))
-&gt; Promise
     w s FutureError (StateMachineClient FutureState FutureAction)
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall w (s :: Row *) e b.
(HasEndpoint &quot;initialise-future&quot; (FutureSetup, Role) s,
 AsContractError e, FromJSON (FutureSetup, Role)) =&gt;
((FutureSetup, Role) -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;initialise-future&quot;</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((FutureSetup, Role)
  -&gt; Contract
       w s FutureError (StateMachineClient FutureState FutureAction))
 -&gt; Promise
      w s FutureError (StateMachineClient FutureState FutureAction))
-&gt; ((FutureSetup, Role)
    -&gt; Contract
         w s FutureError (StateMachineClient FutureState FutureAction))
-&gt; Promise
     w s FutureError (StateMachineClient FutureState FutureAction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680982345"><span class="annot"><span class="annottext">FutureSetup
</span><a href="#local-6989586621680982345"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982344"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982344"><span class="hs-identifier hs-var">ownRole</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-471"></span><span>    </span><span class="hs-comment">-- Start by setting up the two tokens for the short and long positions.</span><span>
</span><span id="line-472"></span><span>    </span><span id="local-6989586621680982343"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982343"><span class="hs-identifier hs-var">ftos</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract w s FutureError FutureAccounts
forall w (s :: Row *) e.
AsFutureError e =&gt;
Contract w s e FutureAccounts
</span><a href="Plutus.Contracts.Future.html#setupTokens"><span class="hs-identifier hs-var">setupTokens</span></a></span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span>    </span><span class="hs-comment">-- Now we have a 'FutureAccountsValue' with the data of two new and unique</span><span>
</span><span id="line-475"></span><span>    </span><span class="hs-comment">-- tokens that we will use for the future contract. Now we use an escrow</span><span>
</span><span id="line-476"></span><span>    </span><span class="hs-comment">--  contract to initialise the future contract.</span><span>
</span><span id="line-477"></span><span>
</span><span id="line-478"></span><span>    </span><span id="local-6989586621680982342"><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
</span><a href="#local-6989586621680982342"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract
  w
  s
  FutureError
  (TypedValidator (StateMachine FutureState FutureAction))
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
forall w (s :: Row *) e a.
(AsCheckpointError e, FromJSON a, ToJSON a) =&gt;
Contract w s e a -&gt; Contract w s e a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">checkpoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract
   w
   s
   FutureError
   (TypedValidator (StateMachine FutureState FutureAction))
 -&gt; Contract
      w
      s
      FutureError
      (TypedValidator (StateMachine FutureState FutureAction)))
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future
-&gt; FutureAccounts
-&gt; TypedValidator (StateMachine FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982349"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982343"><span class="hs-identifier hs-var">ftos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-481"></span><span>        </span><span id="local-6989586621680982340"><span class="annot"><span class="annottext">client :: StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982340"><span class="hs-identifier hs-var hs-var">client</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
-&gt; Future
-&gt; FutureAccounts
-&gt; StateMachineClient FutureState FutureAction
</span><a href="Plutus.Contracts.Future.html#machineClient"><span class="hs-identifier hs-var">machineClient</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
</span><a href="#local-6989586621680982342"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982349"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982343"><span class="hs-identifier hs-var">ftos</span></a></span><span>
</span><span id="line-482"></span><span>
</span><span id="line-483"></span><span>        </span><span class="hs-comment">-- The escrow parameters 'esc' ensure that the initial margin is paid</span><span>
</span><span id="line-484"></span><span>        </span><span class="hs-comment">-- to the future contract address, and the two tokens are transferred</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-comment">-- to their initial owners.</span><span>
</span><span id="line-486"></span><span>        </span><span id="local-6989586621680982339"><span class="annot"><span class="annottext">escr :: EscrowParams Datum
</span><a href="#local-6989586621680982339"><span class="hs-identifier hs-var hs-var">escr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; Future -&gt; FutureAccounts -&gt; FutureSetup -&gt; EscrowParams Datum
</span><a href="Plutus.Contracts.Future.html#escrowParams"><span class="hs-identifier hs-var">escrowParams</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982340"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982349"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982343"><span class="hs-identifier hs-var">ftos</span></a></span><span> </span><span class="annot"><span class="annottext">FutureSetup
</span><a href="#local-6989586621680982345"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-487"></span><span>
</span><span id="line-488"></span><span>        </span><span class="hs-comment">-- For the escrow to go through, both tokens and 2x the initial margin</span><span>
</span><span id="line-489"></span><span>        </span><span class="hs-comment">-- have to be deposited at the escrow address before the deadline</span><span>
</span><span id="line-490"></span><span>        </span><span class="hs-comment">-- (start of the future contract). Since we are currently in possession</span><span>
</span><span id="line-491"></span><span>        </span><span class="hs-comment">-- of both tokens, we pay the two tokens and our own initial margin to</span><span>
</span><span id="line-492"></span><span>        </span><span class="hs-comment">-- the escrow.</span><span>
</span><span id="line-493"></span><span>        </span><span id="local-6989586621680982337"><span class="annot"><span class="annottext">payment :: Value
</span><a href="#local-6989586621680982337"><span class="hs-identifier hs-var hs-var">payment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-494"></span><span>            </span><span class="annot"><span class="annottext">Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-identifier hs-var">initialMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982349"><span class="hs-identifier hs-var">future</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; FutureAccounts -&gt; Value
</span><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-identifier hs-var">tokenFor</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982343"><span class="hs-identifier hs-var">ftos</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Value -&gt; Value
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Role -&gt; FutureAccounts -&gt; Value
</span><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-identifier hs-var">tokenFor</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982343"><span class="hs-identifier hs-var">ftos</span></a></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span>        </span><span class="hs-comment">-- By using 'Escrow.payRedeemRefund' we make our payment and wait for</span><span>
</span><span id="line-497"></span><span>        </span><span class="hs-comment">-- the other party to make theirs. If they fail to do so within the</span><span>
</span><span id="line-498"></span><span>        </span><span class="hs-comment">-- agreed timeframe, our own initial margin is refunded and the future</span><span>
</span><span id="line-499"></span><span>        </span><span class="hs-comment">-- contract never starts.</span><span>
</span><span id="line-500"></span><span>        </span><span id="local-6989586621680982336"><span class="annot"><span class="annottext">escrowPayment :: Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
</span><a href="#local-6989586621680982336"><span class="hs-identifier hs-var hs-var">escrowPayment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
-&gt; Value
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
forall w (s :: Row *).
EscrowParams Datum
-&gt; Value
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
</span><a href="Plutus.Contracts.Escrow.html#payRedeemRefund"><span class="hs-identifier hs-var">Escrow.payRedeemRefund</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680982339"><span class="hs-identifier hs-var">escr</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982337"><span class="hs-identifier hs-var">payment</span></a></span><span>
</span><span id="line-501"></span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">-- Run 'escrowPayment', wrapping any errors in 'EscrowFailed'. If the escrow</span><span>
</span><span id="line-503"></span><span>    </span><span class="hs-comment">-- contract ended with a refund (ie., 'escrowPayment' returns a 'Left') we</span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">-- throw an 'EscrowRefunded' error. If the escrow contract succeeded, the</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-comment">-- future is initialised and ready to go, so we return the 'FutureAccounts'</span><span>
</span><span id="line-506"></span><span>    </span><span class="hs-comment">-- with the token information.</span><span>
</span><span id="line-507"></span><span>    </span><span id="local-6989586621680982334"><span class="annot"><span class="annottext">Either RefundSuccess RedeemSuccess
</span><a href="#local-6989586621680982334"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(EscrowError -&gt; FutureError)
-&gt; Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
-&gt; Contract w s FutureError (Either RefundSuccess RedeemSuccess)
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview FutureError EscrowError -&gt; EscrowError -&gt; FutureError
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview FutureError EscrowError
forall r. AsFutureError r =&gt; Prism' r EscrowError
</span><a href="Plutus.Contracts.Future.html#_EscrowFailed"><span class="hs-identifier hs-var">_EscrowFailed</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError (Either RefundSuccess RedeemSuccess)
</span><a href="#local-6989586621680982336"><span class="hs-identifier hs-var">escrowPayment</span></a></span><span>
</span><span id="line-508"></span><span>    </span><span class="annot"><span class="annottext">(RefundSuccess
 -&gt; Contract
      w s FutureError (StateMachineClient FutureState FutureAction))
-&gt; (RedeemSuccess
    -&gt; Contract
         w s FutureError (StateMachineClient FutureState FutureAction))
-&gt; Either RefundSuccess RedeemSuccess
-&gt; Contract
     w s FutureError (StateMachineClient FutureState FutureAction)
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">either</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview FutureError RefundSuccess
-&gt; RefundSuccess
-&gt; Contract
     w s FutureError (StateMachineClient FutureState FutureAction)
forall e (m :: * -&gt; *) t x.
MonadError e m =&gt;
AReview e t -&gt; t -&gt; m x
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">throwing</span></a></span><span> </span><span class="annot"><span class="annottext">AReview FutureError RefundSuccess
forall r. AsFutureError r =&gt; Prism' r RefundSuccess
</span><a href="Plutus.Contracts.Future.html#_EscrowRefunded"><span class="hs-identifier hs-var">_EscrowRefunded</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">RedeemSuccess
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; Contract
     w s FutureError (StateMachineClient FutureState FutureAction)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982340"><span class="hs-identifier hs-var">client</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Either RefundSuccess RedeemSuccess
</span><a href="#local-6989586621680982334"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-509"></span><span>
</span><span id="line-510"></span><span class="hs-comment">-- | The @&quot;settle-future&quot;@ endpoint. Given an oracle value with the current spot</span><span>
</span><span id="line-511"></span><span class="hs-comment">--   price, this endpoint creates the final transaction that distributes the</span><span>
</span><span id="line-512"></span><span class="hs-comment">--   funds locked by the future to the token accounts specified in</span><span>
</span><span id="line-513"></span><span class="hs-comment">--   the 'FutureAccounts' argument.</span><span>
</span><span id="line-514"></span><span id="local-6989586621680983050"><span id="local-6989586621680983051"><span id="local-6989586621680983052"><span class="annot"><a href="Plutus.Contracts.Future.html#settleFuture"><span class="hs-identifier hs-type">settleFuture</span></a></span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;settle-future&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680983052"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-516"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#AsFutureError"><span class="hs-identifier hs-type">AsFutureError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983051"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-517"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachineClient</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983050"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983052"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983051"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-520"></span><span id="settleFuture"><span class="annot"><span class="annottext">settleFuture :: StateMachineClient FutureState FutureAction -&gt; Promise w s e ()
</span><a href="Plutus.Contracts.Future.html#settleFuture"><span class="hs-identifier hs-var hs-var">settleFuture</span></a></span></span><span> </span><span id="local-6989586621680982333"><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982333"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Contract w s FutureError () -&gt; Contract w s e ())
-&gt; Promise w s FutureError () -&gt; Promise w s e ()
forall w1 (s1 :: Row *) e1 a1 w2 (s2 :: Row *) e2 a2.
(Contract w1 s1 e1 a1 -&gt; Contract w2 s2 e2 a2)
-&gt; Promise w1 s1 e1 a1 -&gt; Promise w2 s2 e2 a2
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">promiseMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FutureError -&gt; e)
-&gt; Contract w s FutureError () -&gt; Contract w s e ()
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e FutureError -&gt; FutureError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e FutureError
forall r. AsFutureError r =&gt; Prism' r FutureError
</span><a href="Plutus.Contracts.Future.html#_FutureError"><span class="hs-identifier hs-var">_FutureError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Promise w s FutureError () -&gt; Promise w s e ())
-&gt; Promise w s FutureError () -&gt; Promise w s e ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall a w (s :: Row *) e b.
(HasEndpoint &quot;settle-future&quot; a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;settle-future&quot;</span></span><span> </span><span class="annot"><span class="annottext">((SignedMessage (Observation Value) -&gt; Contract w s FutureError ())
 -&gt; Promise w s FutureError ())
-&gt; (SignedMessage (Observation Value)
    -&gt; Contract w s FutureError ())
-&gt; Promise w s FutureError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680982332"><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982332"><span class="hs-identifier hs-var">ov</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-521"></span><span>    </span><span class="annot"><span class="annottext">Contract
  w s FutureError (TransitionResult FutureState FutureAction)
-&gt; Contract w s FutureError ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract
   w s FutureError (TransitionResult FutureState FutureAction)
 -&gt; Contract w s FutureError ())
-&gt; Contract
     w s FutureError (TransitionResult FutureState FutureAction)
-&gt; Contract w s FutureError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; FutureAction
-&gt; Contract
     w s FutureError (TransitionResult FutureState FutureAction)
forall w e state (schema :: Row *) input.
(AsSMContractError e, FromData state, ToData state,
 ToData input) =&gt;
StateMachineClient state input
-&gt; input -&gt; Contract w schema e (TransitionResult state input)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">SM.runStep</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982333"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SignedMessage (Observation Value) -&gt; FutureAction
</span><a href="Plutus.Contracts.Future.html#Settle"><span class="hs-identifier hs-var">Settle</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982332"><span class="hs-identifier hs-var">ov</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span class="hs-comment">-- | The @&quot;settle-early&quot;@ endpoint. Given an oracle value with the current spot</span><span>
</span><span id="line-524"></span><span class="hs-comment">--   price, this endpoint creates the final transaction that distributes the</span><span>
</span><span id="line-525"></span><span class="hs-comment">--   funds locked by the future to the token account of the role that did not</span><span>
</span><span id="line-526"></span><span class="hs-comment">--   violate its obligations. Throws a 'MarginRequirementsNotViolated' error if</span><span>
</span><span id="line-527"></span><span class="hs-comment">--   the spot price is within the margin range.</span><span>
</span><span id="line-528"></span><span id="local-6989586621680983047"><span id="local-6989586621680983048"><span id="local-6989586621680983049"><span class="annot"><a href="Plutus.Contracts.Future.html#settleEarly"><span class="hs-identifier hs-type">settleEarly</span></a></span><span>
</span><span id="line-529"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;settle-early&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680983049"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-530"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983048"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-531"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983048"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-532"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachineClient</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span>
</span><span id="line-534"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983047"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983049"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983048"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-535"></span><span id="settleEarly"><span class="annot"><span class="annottext">settleEarly :: StateMachineClient FutureState FutureAction -&gt; Promise w s e ()
</span><a href="Plutus.Contracts.Future.html#settleEarly"><span class="hs-identifier hs-var hs-var">settleEarly</span></a></span></span><span> </span><span id="local-6989586621680982330"><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982330"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a w (s :: Row *) e b.
(HasEndpoint &quot;settle-early&quot; a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;settle-early&quot;</span></span><span> </span><span class="annot"><span class="annottext">((SignedMessage (Observation Value) -&gt; Contract w s e ())
 -&gt; Promise w s e ())
-&gt; (SignedMessage (Observation Value) -&gt; Contract w s e ())
-&gt; Promise w s e ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680982329"><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982329"><span class="hs-identifier hs-var">ov</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-536"></span><span>    </span><span class="annot"><span class="annottext">Contract w s e (TransitionResult FutureState FutureAction)
-&gt; Contract w s e ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract w s e (TransitionResult FutureState FutureAction)
 -&gt; Contract w s e ())
-&gt; Contract w s e (TransitionResult FutureState FutureAction)
-&gt; Contract w s e ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; FutureAction
-&gt; Contract w s e (TransitionResult FutureState FutureAction)
forall w e state (schema :: Row *) input.
(AsSMContractError e, FromData state, ToData state,
 ToData input) =&gt;
StateMachineClient state input
-&gt; input -&gt; Contract w schema e (TransitionResult state input)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">SM.runStep</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982330"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SignedMessage (Observation Value) -&gt; FutureAction
</span><a href="Plutus.Contracts.Future.html#SettleEarly"><span class="hs-identifier hs-var">SettleEarly</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessage (Observation Value)
</span><a href="#local-6989586621680982329"><span class="hs-identifier hs-var">ov</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>
</span><span id="line-538"></span><span class="hs-comment">-- | The @&quot;increase-margin&quot;@ endpoint. Increses the margin of one of</span><span>
</span><span id="line-539"></span><span class="hs-comment">--   the roles by an amount.</span><span>
</span><span id="line-540"></span><span id="local-6989586621680983053"><span id="local-6989586621680983054"><span id="local-6989586621680983055"><span class="annot"><a href="Plutus.Contracts.Future.html#increaseMargin"><span class="hs-identifier hs-type">increaseMargin</span></a></span><span>
</span><span id="line-541"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;increase-margin&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Role"><span class="hs-identifier hs-type">Role</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680983055"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-542"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsSMContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983054"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-543"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">AsContractError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983054"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-544"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachineClient</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983053"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983055"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983054"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-547"></span><span id="increaseMargin"><span class="annot"><span class="annottext">increaseMargin :: StateMachineClient FutureState FutureAction -&gt; Promise w s e ()
</span><a href="Plutus.Contracts.Future.html#increaseMargin"><span class="hs-identifier hs-var hs-var">increaseMargin</span></a></span></span><span> </span><span id="local-6989586621680982328"><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982328"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a w (s :: Row *) e b.
(HasEndpoint &quot;increase-margin&quot; a s, AsContractError e,
 FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;increase-margin&quot;</span></span><span> </span><span class="annot"><span class="annottext">(((Value, Role) -&gt; Contract w s e ()) -&gt; Promise w s e ())
-&gt; ((Value, Role) -&gt; Contract w s e ()) -&gt; Promise w s e ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680982327"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982327"><span class="hs-identifier hs-var">value</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982326"><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982326"><span class="hs-keyword hs-var">role</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>    </span><span class="annot"><span class="annottext">Contract w s e (TransitionResult FutureState FutureAction)
-&gt; Contract w s e ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract w s e (TransitionResult FutureState FutureAction)
 -&gt; Contract w s e ())
-&gt; Contract w s e (TransitionResult FutureState FutureAction)
-&gt; Contract w s e ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; FutureAction
-&gt; Contract w s e (TransitionResult FutureState FutureAction)
forall w e state (schema :: Row *) input.
(AsSMContractError e, FromData state, ToData state,
 ToData input) =&gt;
StateMachineClient state input
-&gt; input -&gt; Contract w schema e (TransitionResult state input)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">SM.runStep</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982328"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; Value -&gt; FutureAction
</span><a href="Plutus.Contracts.Future.html#AdjustMargin"><span class="hs-identifier hs-var">AdjustMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="#local-6989586621680982326"><span class="hs-keyword hs-var">role</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680982327"><span class="hs-identifier hs-var">value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-549"></span><span>
</span><span id="line-550"></span><span class="hs-comment">-- | The @&quot;join-future&quot;@ endpoint. Join a future contract by paying the initial</span><span>
</span><span id="line-551"></span><span class="hs-comment">--   margin to the escrow that initialises the contract.</span><span>
</span><span id="line-552"></span><span id="local-6989586621680983077"><span id="local-6989586621680983078"><span id="local-6989586621680983080"><span class="annot"><a href="Plutus.Contracts.Future.html#joinFuture"><span class="hs-identifier hs-type">joinFuture</span></a></span><span>
</span><span id="line-553"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">HasEndpoint</span></a></span><span> </span><span class="annot"><span class="hs-string">&quot;join-future&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621680983080"><span class="hs-identifier hs-type">s</span></a></span><span>
</span><span id="line-554"></span><span>       </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#AsFutureError"><span class="hs-identifier hs-type">AsFutureError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983078"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-555"></span><span>       </span><span class="hs-special">)</span><span>
</span><span id="line-556"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span>
</span><span id="line-557"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Promise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983077"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983080"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680983078"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachineClient</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-558"></span><span id="joinFuture"><span class="annot"><span class="annottext">joinFuture :: Future
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#joinFuture"><span class="hs-identifier hs-var hs-var">joinFuture</span></a></span></span><span> </span><span id="local-6989586621680982325"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982325"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Contract
   w s FutureError (StateMachineClient FutureState FutureAction)
 -&gt; Contract w s e (StateMachineClient FutureState FutureAction))
-&gt; Promise
     w s FutureError (StateMachineClient FutureState FutureAction)
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
forall w1 (s1 :: Row *) e1 a1 w2 (s2 :: Row *) e2 a2.
(Contract w1 s1 e1 a1 -&gt; Contract w2 s2 e2 a2)
-&gt; Promise w1 s1 e1 a1 -&gt; Promise w2 s2 e2 a2
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">promiseMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FutureError -&gt; e)
-&gt; Contract
     w s FutureError (StateMachineClient FutureState FutureAction)
-&gt; Contract w s e (StateMachineClient FutureState FutureAction)
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e FutureError -&gt; FutureError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e FutureError
forall r. AsFutureError r =&gt; Prism' r FutureError
</span><a href="Plutus.Contracts.Future.html#_FutureError"><span class="hs-identifier hs-var">_FutureError</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Promise
   w s FutureError (StateMachineClient FutureState FutureAction)
 -&gt; Promise w s e (StateMachineClient FutureState FutureAction))
-&gt; Promise
     w s FutureError (StateMachineClient FutureState FutureAction)
-&gt; Promise w s e (StateMachineClient FutureState FutureAction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">forall w (s :: Row *) e b.
(HasEndpoint &quot;join-future&quot; (FutureAccounts, FutureSetup) s,
 AsContractError e, FromJSON (FutureAccounts, FutureSetup)) =&gt;
((FutureAccounts, FutureSetup) -&gt; Contract w s e b)
-&gt; Promise w s e b
forall (l :: Symbol) a w (s :: Row *) e b.
(HasEndpoint l a s, AsContractError e, FromJSON a) =&gt;
(a -&gt; Contract w s e b) -&gt; Promise w s e b
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">endpoint</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><span class="hs-string">&quot;join-future&quot;</span></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((FutureAccounts, FutureSetup)
  -&gt; Contract
       w s FutureError (StateMachineClient FutureState FutureAction))
 -&gt; Promise
      w s FutureError (StateMachineClient FutureState FutureAction))
-&gt; ((FutureAccounts, FutureSetup)
    -&gt; Contract
         w s FutureError (StateMachineClient FutureState FutureAction))
-&gt; Promise
     w s FutureError (StateMachineClient FutureState FutureAction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621680982324"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982324"><span class="hs-identifier hs-var">owners</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982323"><span class="annot"><span class="annottext">FutureSetup
</span><a href="#local-6989586621680982323"><span class="hs-identifier hs-var">stp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-559"></span><span>    </span><span id="local-6989586621680982322"><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
</span><a href="#local-6989586621680982322"><span class="hs-identifier hs-var">inst</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract
  w
  s
  FutureError
  (TypedValidator (StateMachine FutureState FutureAction))
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
forall w (s :: Row *) e a.
(AsCheckpointError e, FromJSON a, ToJSON a) =&gt;
Contract w s e a -&gt; Contract w s e a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">checkpoint</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract
   w
   s
   FutureError
   (TypedValidator (StateMachine FutureState FutureAction))
 -&gt; Contract
      w
      s
      FutureError
      (TypedValidator (StateMachine FutureState FutureAction)))
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
-&gt; Contract
     w
     s
     FutureError
     (TypedValidator (StateMachine FutureState FutureAction))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future
-&gt; FutureAccounts
-&gt; TypedValidator (StateMachine FutureState FutureAction)
</span><a href="Plutus.Contracts.Future.html#typedValidator"><span class="hs-identifier hs-var">typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982325"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982324"><span class="hs-identifier hs-var">owners</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680982321"><span class="annot"><span class="annottext">client :: StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982321"><span class="hs-identifier hs-var hs-var">client</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
-&gt; Future
-&gt; FutureAccounts
-&gt; StateMachineClient FutureState FutureAction
</span><a href="Plutus.Contracts.Future.html#machineClient"><span class="hs-identifier hs-var">machineClient</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction)
</span><a href="#local-6989586621680982322"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982325"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982324"><span class="hs-identifier hs-var">owners</span></a></span><span>
</span><span id="line-561"></span><span>        </span><span id="local-6989586621680982320"><span class="annot"><span class="annottext">escr :: EscrowParams Datum
</span><a href="#local-6989586621680982320"><span class="hs-identifier hs-var hs-var">escr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; Future -&gt; FutureAccounts -&gt; FutureSetup -&gt; EscrowParams Datum
</span><a href="Plutus.Contracts.Future.html#escrowParams"><span class="hs-identifier hs-var">escrowParams</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982321"><span class="hs-identifier hs-var">client</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982325"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982324"><span class="hs-identifier hs-var">owners</span></a></span><span> </span><span class="annot"><span class="annottext">FutureSetup
</span><a href="#local-6989586621680982323"><span class="hs-identifier hs-var">stp</span></a></span><span>
</span><span id="line-562"></span><span>        </span><span id="local-6989586621680982319"><span class="annot"><span class="annottext">payment :: Contract w s EscrowError TxId
</span><a href="#local-6989586621680982319"><span class="hs-identifier hs-var hs-var">payment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s EscrowError TxId
forall w (s :: Row *) e.
AsContractError e =&gt;
TypedValidator Escrow
-&gt; EscrowParams Datum -&gt; Value -&gt; Contract w s e TxId
</span><a href="Plutus.Contracts.Escrow.html#pay"><span class="hs-identifier hs-var">Escrow.pay</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EscrowParams Datum -&gt; TypedValidator Escrow
</span><a href="Plutus.Contracts.Escrow.html#typedValidator"><span class="hs-identifier hs-var">Escrow.typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680982320"><span class="hs-identifier hs-var">escr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">EscrowParams Datum
</span><a href="#local-6989586621680982320"><span class="hs-identifier hs-var">escr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-identifier hs-var">initialMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982325"><span class="hs-identifier hs-var">ft</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-563"></span><span>    </span><span class="annot"><span class="annottext">Contract w s FutureError TxId -&gt; Contract w s FutureError ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract w s FutureError TxId -&gt; Contract w s FutureError ())
-&gt; Contract w s FutureError TxId -&gt; Contract w s FutureError ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(EscrowError -&gt; FutureError)
-&gt; Contract w s EscrowError TxId -&gt; Contract w s FutureError TxId
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="annot"><span class="annottext">EscrowError -&gt; FutureError
</span><a href="Plutus.Contracts.Future.html#EscrowFailed"><span class="hs-identifier hs-var">EscrowFailed</span></a></span><span> </span><span class="annot"><span class="annottext">Contract w s EscrowError TxId
</span><a href="#local-6989586621680982319"><span class="hs-identifier hs-var">payment</span></a></span><span>
</span><span id="line-564"></span><span>    </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; Contract
     w s FutureError (StateMachineClient FutureState FutureAction)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982321"><span class="hs-identifier hs-var">client</span></a></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span class="hs-comment">-- | Create two unique tokens that can be used for the short and long positions</span><span>
</span><span id="line-567"></span><span class="hs-comment">--   and return a 'FutureAccounts' value for them.</span><span>
</span><span id="line-568"></span><span class="hs-comment">--</span><span>
</span><span id="line-569"></span><span class="hs-comment">--   Note that after 'setupTokens' is complete, both tokens will be locked by a</span><span>
</span><span id="line-570"></span><span class="hs-comment">--   public key output belonging to the wallet that ran 'setupTokens'.</span><span>
</span><span id="line-571"></span><span class="annot"><a href="Plutus.Contracts.Future.html#setupTokens"><span class="hs-identifier hs-type">setupTokens</span></a></span><span>
</span><span id="line-572"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680982918"><span class="annot"><a href="#local-6989586621680982918"><span class="hs-identifier hs-type">w</span></a></span></span><span> </span><span id="local-6989586621680982917"><span class="annot"><a href="#local-6989586621680982917"><span class="hs-identifier hs-type">s</span></a></span></span><span> </span><span id="local-6989586621680982919"><span class="annot"><a href="#local-6989586621680982919"><span class="hs-identifier hs-type">e</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-573"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#AsFutureError"><span class="hs-identifier hs-type">AsFutureError</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982919"><span class="hs-identifier hs-type">e</span></a></span><span>
</span><span id="line-574"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Contract</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982918"><span class="hs-identifier hs-type">w</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982917"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680982919"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span>
</span><span id="line-576"></span><span id="setupTokens"><span class="annot"><span class="annottext">setupTokens :: Contract w s e FutureAccounts
</span><a href="Plutus.Contracts.Future.html#setupTokens"><span class="hs-identifier hs-var hs-var">setupTokens</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FutureError -&gt; e)
-&gt; Contract w s FutureError FutureAccounts
-&gt; Contract w s e FutureAccounts
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AReview e FutureError -&gt; FutureError -&gt; e
forall b (m :: * -&gt; *) t. MonadReader b m =&gt; AReview t b -&gt; m t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier hs-var">review</span></a></span><span> </span><span class="annot"><span class="annottext">AReview e FutureError
forall r. AsFutureError r =&gt; Prism' r FutureError
</span><a href="Plutus.Contracts.Future.html#_FutureError"><span class="hs-identifier hs-var">_FutureError</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Contract w s FutureError FutureAccounts
 -&gt; Contract w s e FutureAccounts)
-&gt; Contract w s FutureError FutureAccounts
-&gt; Contract w s e FutureAccounts
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-577"></span><span>    </span><span id="local-6989586621680982316"><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621680982316"><span class="hs-identifier hs-var">addr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Contract w s FutureError CardanoAddress
forall w (s :: Row *) e.
AsContractError e =&gt;
Contract w s e CardanoAddress
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">ownAddress</span></a></span><span>
</span><span id="line-578"></span><span>
</span><span id="line-579"></span><span>    </span><span class="hs-comment">-- Create the tokens using the currency contract, wrapping any errors in</span><span>
</span><span id="line-580"></span><span>    </span><span class="hs-comment">-- 'TokenSetupFailed'</span><span>
</span><span id="line-581"></span><span>    </span><span id="local-6989586621680982314"><span class="annot"><span class="annottext">OneShotCurrency
</span><a href="#local-6989586621680982314"><span class="hs-identifier hs-var">cur</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CurrencyError -&gt; FutureError)
-&gt; Contract w s CurrencyError OneShotCurrency
-&gt; Contract w s FutureError OneShotCurrency
forall w (s :: Row *) e e' a.
(e -&gt; e') -&gt; Contract w s e a -&gt; Contract w s e' a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">mapError</span></a></span><span> </span><span class="annot"><span class="annottext">CurrencyError -&gt; FutureError
</span><a href="Plutus.Contracts.Future.html#TokenSetupFailed"><span class="hs-identifier hs-var">TokenSetupFailed</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract w s CurrencyError OneShotCurrency
 -&gt; Contract w s FutureError OneShotCurrency)
-&gt; Contract w s CurrencyError OneShotCurrency
-&gt; Contract w s FutureError OneShotCurrency
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoAddress
-&gt; [(TokenName, Integer)]
-&gt; Contract w s CurrencyError OneShotCurrency
forall w (s :: Row *) e.
AsCurrencyError e =&gt;
CardanoAddress
-&gt; [(TokenName, Integer)] -&gt; Contract w s e OneShotCurrency
</span><a href="Plutus.Contracts.Currency.html#mintContract"><span class="hs-identifier hs-var">Currency.mintContract</span></a></span><span> </span><span class="annot"><span class="annottext">CardanoAddress
</span><a href="#local-6989586621680982316"><span class="hs-identifier hs-var">addr</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenName
</span><span class="hs-string">&quot;long&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenName
</span><span class="hs-string">&quot;short&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-582"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680982312"><span class="annot"><span class="annottext">acc :: TokenName -&gt; Account
</span><a href="#local-6989586621680982312"><span class="hs-identifier hs-var hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AssetClass -&gt; Account
</span><a href="Plutus.Contracts.TokenAccount.html#Account"><span class="hs-identifier hs-var">Account</span></a></span><span> </span><span class="annot"><span class="annottext">(AssetClass -&gt; Account)
-&gt; (TokenName -&gt; AssetClass) -&gt; TokenName -&gt; Account
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CurrencySymbol -&gt; TokenName -&gt; AssetClass
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Value.assetClass</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OneShotCurrency -&gt; CurrencySymbol
</span><a href="Plutus.Contracts.Currency.html#currencySymbol"><span class="hs-identifier hs-var">Currency.currencySymbol</span></a></span><span> </span><span class="annot"><span class="annottext">OneShotCurrency
</span><a href="#local-6989586621680982314"><span class="hs-identifier hs-var">cur</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-583"></span><span>    </span><span class="annot"><span class="annottext">FutureAccounts -&gt; Contract w s FutureError FutureAccounts
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(FutureAccounts -&gt; Contract w s FutureError FutureAccounts)
-&gt; FutureAccounts -&gt; Contract w s FutureError FutureAccounts
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Account -&gt; Account -&gt; FutureAccounts
</span><a href="Plutus.Contracts.Future.html#mkAccounts"><span class="hs-identifier hs-var">mkAccounts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenName -&gt; Account
</span><a href="#local-6989586621680982312"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">TokenName
</span><span class="hs-string">&quot;long&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TokenName -&gt; Account
</span><a href="#local-6989586621680982312"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">TokenName
</span><span class="hs-string">&quot;short&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>
</span><span id="line-585"></span><span class="hs-comment">-- | The escrow contract that initialises the future. Both parties have to pay</span><span>
</span><span id="line-586"></span><span class="hs-comment">--   their initial margin to this contract in order to unlock their tokens.</span><span>
</span><span id="line-587"></span><span class="annot"><a href="Plutus.Contracts.Future.html#escrowParams"><span class="hs-identifier hs-type">escrowParams</span></a></span><span>
</span><span id="line-588"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SM.StateMachineClient</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureState"><span class="hs-identifier hs-type">FutureState</span></a></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAction"><span class="hs-identifier hs-type">FutureAction</span></a></span><span>
</span><span id="line-589"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#Future"><span class="hs-identifier hs-type">Future</span></a></span><span>
</span><span id="line-590"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureAccounts"><span class="hs-identifier hs-type">FutureAccounts</span></a></span><span>
</span><span id="line-591"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span>
</span><span id="line-592"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Datum</span></a></span><span>
</span><span id="line-593"></span><span id="escrowParams"><span class="annot"><span class="annottext">escrowParams :: StateMachineClient FutureState FutureAction
-&gt; Future -&gt; FutureAccounts -&gt; FutureSetup -&gt; EscrowParams Datum
</span><a href="Plutus.Contracts.Future.html#escrowParams"><span class="hs-identifier hs-var hs-var">escrowParams</span></a></span></span><span> </span><span id="local-6989586621680982309"><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982309"><span class="hs-identifier hs-var">client</span></a></span></span><span> </span><span id="local-6989586621680982308"><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982308"><span class="hs-identifier hs-var">future</span></a></span></span><span> </span><span id="local-6989586621680982307"><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982307"><span class="hs-identifier hs-var">ftos</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSetup"><span class="hs-identifier hs-type">FutureSetup</span></a></span><span class="hs-special">{</span><span id="local-6989586621680982306"><span class="annot"><span class="annottext">PaymentPubKeyHash
longPK :: PaymentPubKeyHash
longPK :: FutureSetup -&gt; PaymentPubKeyHash
</span><a href="#local-6989586621680982306"><span class="hs-identifier hs-var hs-var">longPK</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982305"><span class="annot"><span class="annottext">PaymentPubKeyHash
shortPK :: PaymentPubKeyHash
shortPK :: FutureSetup -&gt; PaymentPubKeyHash
</span><a href="#local-6989586621680982305"><span class="hs-identifier hs-var hs-var">shortPK</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680982304"><span class="annot"><span class="annottext">POSIXTime
contractStart :: POSIXTime
contractStart :: FutureSetup -&gt; POSIXTime
</span><a href="#local-6989586621680982304"><span class="hs-identifier hs-var hs-var">contractStart</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-594"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-595"></span><span>        </span><span id="local-6989586621680982303"><span class="annot"><span class="annottext">address :: ValidatorHash
</span><a href="#local-6989586621680982303"><span class="hs-identifier hs-var hs-var">address</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Validator -&gt; ValidatorHash
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">validatorHash</span></a></span><span> </span><span class="annot"><span class="annottext">(Validator -&gt; ValidatorHash) -&gt; Validator -&gt; ValidatorHash
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">TypedValidator (StateMachine FutureState FutureAction) -&gt; Validator
forall a. TypedValidator a -&gt; Validator
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.validatorScript</span></a></span><span> </span><span class="annot"><span class="annottext">(TypedValidator (StateMachine FutureState FutureAction)
 -&gt; Validator)
-&gt; TypedValidator (StateMachine FutureState FutureAction)
-&gt; Validator
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineInstance FutureState FutureAction
-&gt; TypedValidator (StateMachine FutureState FutureAction)
forall s i.
StateMachineInstance s i -&gt; TypedValidator (StateMachine s i)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">SM.typedValidator</span></a></span><span> </span><span class="annot"><span class="annottext">(StateMachineInstance FutureState FutureAction
 -&gt; TypedValidator (StateMachine FutureState FutureAction))
-&gt; StateMachineInstance FutureState FutureAction
-&gt; TypedValidator (StateMachine FutureState FutureAction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
-&gt; StateMachineInstance FutureState FutureAction
forall s i. StateMachineClient s i -&gt; StateMachineInstance s i
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">SM.scInstance</span></a></span><span> </span><span class="annot"><span class="annottext">StateMachineClient FutureState FutureAction
</span><a href="#local-6989586621680982309"><span class="hs-identifier hs-var">client</span></a></span><span>
</span><span id="line-596"></span><span>        </span><span id="local-6989586621680982300"><span class="annot"><span class="annottext">dataScript :: Datum
</span><a href="#local-6989586621680982300"><span class="hs-identifier hs-var hs-var">dataScript</span></a></span></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuiltinData -&gt; Datum
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">Datum</span></a></span><span> </span><span class="annot"><span class="annottext">(BuiltinData -&gt; Datum) -&gt; BuiltinData -&gt; Datum
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">FutureState -&gt; BuiltinData
forall a. ToData a =&gt; a -&gt; BuiltinData
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.toBuiltinData</span></a></span><span> </span><span class="annot"><span class="annottext">(FutureState -&gt; BuiltinData) -&gt; FutureState -&gt; BuiltinData
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Future -&gt; FutureState
</span><a href="Plutus.Contracts.Future.html#initialState"><span class="hs-identifier hs-var">initialState</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982308"><span class="hs-identifier hs-var">future</span></a></span><span>
</span><span id="line-597"></span><span>        </span><span id="local-6989586621680982298"><span class="annot"><span class="annottext">targets :: [EscrowTarget Datum]
</span><a href="#local-6989586621680982298"><span class="hs-identifier hs-var hs-var">targets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-598"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">ValidatorHash -&gt; Datum -&gt; Value -&gt; EscrowTarget Datum
</span><a href="Plutus.Contracts.Escrow.html#payToScriptTarget"><span class="hs-identifier hs-var">Escrow.payToScriptTarget</span></a></span><span> </span><span class="annot"><span class="annottext">ValidatorHash
</span><a href="#local-6989586621680982303"><span class="hs-identifier hs-var">address</span></a></span><span>
</span><span id="line-599"></span><span>                </span><span class="annot"><span class="annottext">Datum
</span><a href="#local-6989586621680982300"><span class="hs-identifier hs-var">dataScript</span></a></span><span>
</span><span id="line-600"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Value -&gt; Value
forall s v. Module s v =&gt; s -&gt; v -&gt; v
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">scale</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Future -&gt; Value
</span><a href="Plutus.Contracts.Future.html#initialMargin"><span class="hs-identifier hs-var">initialMargin</span></a></span><span> </span><span class="annot"><span class="annottext">Future
</span><a href="#local-6989586621680982308"><span class="hs-identifier hs-var">future</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-601"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; Value -&gt; EscrowTarget Datum
forall d. PaymentPubKeyHash -&gt; Value -&gt; EscrowTarget d
</span><a href="Plutus.Contracts.Escrow.html#payToPaymentPubKeyTarget"><span class="hs-identifier hs-var">Escrow.payToPaymentPubKeyTarget</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680982306"><span class="hs-identifier hs-var">longPK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; FutureAccounts -&gt; Value
</span><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-identifier hs-var">tokenFor</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Long"><span class="hs-identifier hs-var">Long</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982307"><span class="hs-identifier hs-var">ftos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; Value -&gt; EscrowTarget Datum
forall d. PaymentPubKeyHash -&gt; Value -&gt; EscrowTarget d
</span><a href="Plutus.Contracts.Escrow.html#payToPaymentPubKeyTarget"><span class="hs-identifier hs-var">Escrow.payToPaymentPubKeyTarget</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680982305"><span class="hs-identifier hs-var">shortPK</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Role -&gt; FutureAccounts -&gt; Value
</span><a href="Plutus.Contracts.Future.html#tokenFor"><span class="hs-identifier hs-var">tokenFor</span></a></span><span> </span><span class="annot"><span class="annottext">Role
</span><a href="Plutus.Contracts.Future.html#Short"><span class="hs-identifier hs-var">Short</span></a></span><span> </span><span class="annot"><span class="annottext">FutureAccounts
</span><a href="#local-6989586621680982307"><span class="hs-identifier hs-var">ftos</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-604"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">EscrowParams :: forall d. POSIXTime -&gt; [EscrowTarget d] -&gt; EscrowParams d
</span><a href="Plutus.Contracts.Escrow.html#EscrowParams"><span class="hs-identifier hs-type">EscrowParams</span></a></span><span>
</span><span id="line-605"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">escrowDeadline :: POSIXTime
</span><a href="Plutus.Contracts.Escrow.html#escrowDeadline"><span class="hs-identifier hs-var">escrowDeadline</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680982304"><span class="hs-identifier hs-var">contractStart</span></a></span><span>
</span><span id="line-606"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">escrowTargets :: [EscrowTarget Datum]
</span><a href="Plutus.Contracts.Escrow.html#escrowTargets"><span class="hs-identifier hs-var">escrowTargets</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EscrowTarget Datum]
</span><a href="#local-6989586621680982298"><span class="hs-identifier hs-var">targets</span></a></span><span>
</span><span id="line-607"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-608"></span><span>
</span><span id="line-609"></span><span class="annot"><a href="Plutus.Contracts.Future.html#setupTokensTrace"><span class="hs-identifier hs-type">setupTokensTrace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Trace.EmulatorTrace</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span id="setupTokensTrace"><span class="annot"><span class="annottext">setupTokensTrace :: EmulatorTrace ()
</span><a href="Plutus.Contracts.Future.html#setupTokensTrace"><span class="hs-identifier hs-var hs-var">setupTokensTrace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-611"></span><span>    </span><span class="annot"><span class="annottext">Slot
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Eff EmulatorEffects Slot
forall (effs :: [* -&gt; *]).
Member Waiting effs =&gt;
Natural -&gt; Eff effs Slot
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Trace.waitNSlots</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">1</span></span><span>
</span><span id="line-612"></span><span>    </span><span class="annot"><span class="annottext">ContractHandle
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Wallet
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
-&gt; Eff
     EmulatorEffects
     (ContractHandle
        ()
        ('R
           '[ &quot;increase-margin&quot;
              ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
              &quot;initialise-future&quot;
              ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
              &quot;join-future&quot;
              ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
              &quot;settle-early&quot;
              ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                    ActiveEndpoint),
              &quot;settle-future&quot;
              ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                    ActiveEndpoint)])
        FutureError)
forall (contract :: * -&gt; Row * -&gt; * -&gt; * -&gt; *) w (s :: Row *) e
       (effs :: [* -&gt; *]).
(IsContract contract, ContractConstraints s, Show e, ToJSON e,
 FromJSON e, ToJSON w, FromJSON w, Member StartContract effs,
 Monoid w) =&gt;
Wallet -&gt; contract w s e () -&gt; Eff effs (ContractHandle w s e)
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Trace.activateContractWallet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Wallet
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Wallet.knownWallet</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Contract
  ()
  ('R
     '[ &quot;increase-margin&quot;
        ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
        &quot;initialise-future&quot;
        ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
        &quot;join-future&quot;
        ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
        &quot;settle-early&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint),
        &quot;settle-future&quot;
        ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
              ActiveEndpoint)])
  FutureError
  FutureAccounts
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Contract
   ()
   ('R
      '[ &quot;increase-margin&quot;
         ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
         &quot;initialise-future&quot;
         ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
         &quot;join-future&quot;
         ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
         &quot;settle-early&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint),
         &quot;settle-future&quot;
         ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
               ActiveEndpoint)])
   FutureError
   FutureAccounts
 -&gt; Contract
      ()
      ('R
         '[ &quot;increase-margin&quot;
            ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
            &quot;initialise-future&quot;
            ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
            &quot;join-future&quot;
            ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
            &quot;settle-early&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint),
            &quot;settle-future&quot;
            ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                  ActiveEndpoint)])
      FutureError
      ())
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     FutureAccounts
-&gt; Contract
     ()
     ('R
        '[ &quot;increase-margin&quot;
           ':-&gt; (EndpointValue (Value, Role), ActiveEndpoint),
           &quot;initialise-future&quot;
           ':-&gt; (EndpointValue (FutureSetup, Role), ActiveEndpoint),
           &quot;join-future&quot;
           ':-&gt; (EndpointValue (FutureAccounts, FutureSetup), ActiveEndpoint),
           &quot;settle-early&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint),
           &quot;settle-future&quot;
           ':-&gt; (EndpointValue (SignedMessage (Observation Value)),
                 ActiveEndpoint)])
     FutureError
     ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">AsFutureError FutureError =&gt;
Contract () FutureSchema FutureError FutureAccounts
forall w (s :: Row *) e.
AsFutureError e =&gt;
Contract w s e FutureAccounts
</span><a href="Plutus.Contracts.Future.html#setupTokens"><span class="hs-identifier hs-var">setupTokens</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureSchema"><span class="hs-identifier hs-type">FutureSchema</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="Plutus.Contracts.Future.html#FutureError"><span class="hs-identifier hs-type">FutureError</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-613"></span><span>    </span><span class="annot"><span class="annottext">Eff EmulatorEffects Slot -&gt; EmulatorTrace ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">void</span></a></span><span> </span><span class="annot"><span class="annottext">(Eff EmulatorEffects Slot -&gt; EmulatorTrace ())
-&gt; Eff EmulatorEffects Slot -&gt; EmulatorTrace ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Eff EmulatorEffects Slot
forall (effs :: [* -&gt; *]).
Member Waiting effs =&gt;
Natural -&gt; Eff effs Slot
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Trace.waitNSlots</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">2</span></span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span id="local-6989586621680982286"><span id="local-6989586621680982288"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Future</span></span></span><span>
</span><span id="line-616"></span><span id="local-6989586621680982278"><span id="local-6989586621680982280"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">FutureAccounts</span></span></span><span>
</span><span id="line-617"></span><span id="local-6989586621680982274"><span id="local-6989586621680982276"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Margins</span></span></span><span>
</span><span id="line-618"></span><span id="local-6989586621680982268"><span id="local-6989586621680982270"><span id="local-6989586621680982272"><span class="hs-identifier">PlutusTx.unstableMakeIsData</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Margins</span></span></span></span><span>
</span><span id="line-619"></span><span id="local-6989586621680982259"><span id="local-6989586621680982261"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Role</span></span></span><span>
</span><span id="line-620"></span><span id="local-6989586621680982253"><span id="local-6989586621680982255"><span id="local-6989586621680982257"><span class="hs-identifier">PlutusTx.unstableMakeIsData</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Role</span></span></span></span><span>
</span><span id="line-621"></span><span id="local-6989586621680982249"><span id="local-6989586621680982251"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">FutureState</span></span></span><span>
</span><span id="line-622"></span><span id="local-6989586621680982243"><span id="local-6989586621680982245"><span id="local-6989586621680982247"><span class="hs-identifier">PlutusTx.unstableMakeIsData</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">FutureState</span></span></span></span><span>
</span><span id="line-623"></span><span id="local-6989586621680982239"><span id="local-6989586621680982241"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">FutureAction</span></span></span><span>
</span><span id="line-624"></span><span id="local-6989586621680982233"><span id="local-6989586621680982235"><span id="local-6989586621680982237"><span class="hs-identifier">PlutusTx.unstableMakeIsData</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">FutureAction</span></span></span></span><span>
</span><span id="line-625"></span></pre></body></html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds         #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns    #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE NoImplicitPrelude #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE RecordWildCards   #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TemplateHaskell   #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications  #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies      #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE ViewPatterns      #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# OPTIONS_GHC -Wno-incomplete-uni-patterns #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-ignore-interface-pragmas #-}</span><span>
</span><span id="line-13"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Plutus.Contracts.Swap</span><span class="hs-special">(</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Swap.html#Swap"><span class="hs-identifier">Swap</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Script</span></span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Plutus.Contracts.Swap.html#swapValidator"><span class="hs-identifier">swapValidator</span></a></span><span>
</span><span id="line-17"></span><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-18"></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">POSIXTime</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">PaymentPubKey</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">PaymentPubKeyHash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">unPaymentPubKeyHash</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Ada</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ada</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Ada</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Ada</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Typed.Scripts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Scripts</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier">Ledger.Value</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Value</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Oracle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Observation</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">SignedMessage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier">Plutus.Contract.Oracle</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Oracle</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Plutus.V1.Ledger.Api</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PV1</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier">Plutus.V1.Ledger.Contexts</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PV1</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx</span></a></span><span> </span><span class="hs-keyword">qualified</span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier">PlutusTx.Prelude</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-comment">-- | A swap is an agreement to exchange cashflows at future dates. To keep</span><span>
</span><span id="line-32"></span><span class="hs-comment">--  things simple, this is an interest rate swap (meaning that the cashflows are</span><span>
</span><span id="line-33"></span><span class="hs-comment">--  interest payments on the same principal amount but with two different</span><span>
</span><span id="line-34"></span><span class="hs-comment">--  interest rates, of which one is fixed and one is floating (varying with</span><span>
</span><span id="line-35"></span><span class="hs-comment">--  time)) with only a single payment date.</span><span>
</span><span id="line-36"></span><span class="hs-comment">--</span><span>
</span><span id="line-37"></span><span class="hs-comment">--  At the beginning of the contract, the fixed rate is set to the expected</span><span>
</span><span id="line-38"></span><span class="hs-comment">--  future value of the floating rate (so if the floating rate behaves as</span><span>
</span><span id="line-39"></span><span class="hs-comment">--  expected, the two payments will be exactly equal).</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-keyword">data</span><span> </span><span id="Swap"><span class="annot"><a href="Plutus.Contracts.Swap.html#Swap"><span class="hs-identifier hs-var">Swap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Swap"><span class="annot"><a href="Plutus.Contracts.Swap.html#Swap"><span class="hs-identifier hs-var">Swap</span></a></span></span><span>
</span><span id="line-42"></span><span>    </span><span class="hs-special">{</span><span> </span><span id="swapNotionalAmt"><span class="annot"><span class="annottext">Swap -&gt; Ada
</span><a href="Plutus.Contracts.Swap.html#swapNotionalAmt"><span class="hs-identifier hs-var hs-var">swapNotionalAmt</span></a></span></span><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Ada</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="swapObservationTime"><span class="annot"><span class="annottext">Swap -&gt; POSIXTime
</span><a href="Plutus.Contracts.Swap.html#swapObservationTime"><span class="hs-identifier hs-var hs-var">swapObservationTime</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="swapFixedRate"><span class="annot"><span class="annottext">Swap -&gt; Rational
</span><a href="Plutus.Contracts.Swap.html#swapFixedRate"><span class="hs-identifier hs-var hs-var">swapFixedRate</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-comment">-- ^ Interest rate fixed at the beginning of the contract</span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="swapFloatingRate"><span class="annot"><span class="annottext">Swap -&gt; Rational
</span><a href="Plutus.Contracts.Swap.html#swapFloatingRate"><span class="hs-identifier hs-var hs-var">swapFloatingRate</span></a></span></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-47"></span><span>    </span><span class="hs-comment">-- ^ Interest rate whose value will be observed (by an oracle) on the day</span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-comment">-- of the payment</span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="swapMargin"><span class="annot"><span class="annottext">Swap -&gt; Ada
</span><a href="Plutus.Contracts.Swap.html#swapMargin"><span class="hs-identifier hs-var hs-var">swapMargin</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">Ada</span></a></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-comment">-- ^ Margin deposited at the beginning of the contract to protect against</span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-comment">-- default (one party failing to pay)</span><span>
</span><span id="line-52"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="swapOracle"><span class="annot"><span class="annottext">Swap -&gt; PaymentPubKey
</span><a href="Plutus.Contracts.Swap.html#swapOracle"><span class="hs-identifier hs-var hs-var">swapOracle</span></a></span></span><span>          </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKey</span></a></span><span>
</span><span id="line-53"></span><span>    </span><span class="hs-comment">-- ^ Public key of the oracle (see note [Oracles] in [[Plutus.Contracts]]).</span><span>
</span><span id="line-54"></span><span>    </span><span class="hs-comment">-- Unsure why, but this field needs to be non-strict, otherwise GHC will try</span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-comment">-- to unbox the datatype, which will result in a compilation error such as</span><span>
</span><span id="line-56"></span><span>    </span><span class="hs-comment">-- &quot;GHC Core to PLC plugin: E042:Error: Unsupported feature: Type constructor: GHC.Prim.Addr#&quot;</span><span>
</span><span id="line-57"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span id="local-6989586621680979984"><span id="local-6989586621680979986"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Swap</span></span></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span class="hs-comment">-- | Identities of the parties involved in the swap. This will be the data</span><span>
</span><span id="line-62"></span><span class="hs-comment">--   script which allows us to change the identities during the lifetime of</span><span>
</span><span id="line-63"></span><span class="hs-comment">--   the contract (ie. if one of the parties sells their part of the contract)</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span class="hs-comment">--   In the future we could also put the `swapMargin` value in here to implement</span><span>
</span><span id="line-66"></span><span class="hs-comment">--   a variable margin.</span><span>
</span><span id="line-67"></span><span class="hs-keyword">data</span><span> </span><span id="SwapOwners"><span class="annot"><a href="Plutus.Contracts.Swap.html#SwapOwners"><span class="hs-identifier hs-var">SwapOwners</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SwapOwners"><span class="annot"><a href="Plutus.Contracts.Swap.html#SwapOwners"><span class="hs-identifier hs-var">SwapOwners</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-68"></span><span>    </span><span id="swapOwnersFixedLeg"><span class="annot"><span class="annottext">SwapOwners -&gt; PaymentPubKeyHash
</span><a href="Plutus.Contracts.Swap.html#swapOwnersFixedLeg"><span class="hs-identifier hs-var hs-var">swapOwnersFixedLeg</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span id="swapOwnersFloating"><span class="annot"><span class="annottext">SwapOwners -&gt; PaymentPubKeyHash
</span><a href="Plutus.Contracts.Swap.html#swapOwnersFloating"><span class="hs-identifier hs-var hs-var">swapOwnersFloating</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span id="local-6989586621680979971"><span id="local-6989586621680979973"><span id="local-6989586621680979975"><span class="hs-identifier">PlutusTx.unstableMakeIsData</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">SwapOwners</span></span></span></span><span>
</span><span id="line-73"></span><span id="local-6989586621680979961"><span id="local-6989586621680979963"><span class="hs-identifier">PlutusTx.makeLift</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">SwapOwners</span></span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">type</span><span> </span><span id="SwapOracleMessage"><span class="annot"><a href="Plutus.Contracts.Swap.html#SwapOracleMessage"><span class="hs-identifier hs-var">SwapOracleMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-pragma">{-# INLINABLE</span><span> </span><span class="annot"><a href="Plutus.Contracts.Swap.html#mkValidator"><span class="hs-pragma hs-type">mkValidator</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-78"></span><span class="annot"><a href="Plutus.Contracts.Swap.html#mkValidator"><span class="hs-identifier hs-type">mkValidator</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Swap.html#Swap"><span class="hs-identifier hs-type">Swap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Swap.html#SwapOwners"><span class="hs-identifier hs-type">SwapOwners</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Plutus.Contracts.Swap.html#SwapOracleMessage"><span class="hs-identifier hs-type">SwapOracleMessage</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.ScriptContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-79"></span><span id="mkValidator"><span class="annot"><span class="annottext">mkValidator :: Swap -&gt; SwapOwners -&gt; SwapOracleMessage -&gt; ScriptContext -&gt; Bool
</span><a href="Plutus.Contracts.Swap.html#mkValidator"><span class="hs-identifier hs-var hs-var">mkValidator</span></a></span></span><span> </span><span class="annot"><a href="Plutus.Contracts.Swap.html#Swap"><span class="hs-identifier hs-type">Swap</span></a></span><span class="hs-special">{</span><span id="local-6989586621680979954"><span id="local-6989586621680979955"><span id="local-6989586621680979956"><span id="local-6989586621680979957"><span id="local-6989586621680979958"><span id="local-6989586621680979959"><span class="annot"><span class="annottext">POSIXTime
PaymentPubKey
Ada
Rational
swapOracle :: PaymentPubKey
swapMargin :: Ada
swapFloatingRate :: Rational
swapFixedRate :: Rational
swapObservationTime :: POSIXTime
swapNotionalAmt :: Ada
swapOracle :: Swap -&gt; PaymentPubKey
swapMargin :: Swap -&gt; Ada
swapFloatingRate :: Swap -&gt; Rational
swapFixedRate :: Swap -&gt; Rational
swapObservationTime :: Swap -&gt; POSIXTime
swapNotionalAmt :: Swap -&gt; Ada
</span><a href="#local-6989586621680979954"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span></span></span></span><span class="hs-special">}</span><span> </span><span class="annot"><a href="Plutus.Contracts.Swap.html#SwapOwners"><span class="hs-identifier hs-type">SwapOwners</span></a></span><span class="hs-special">{</span><span id="local-6989586621680979952"><span id="local-6989586621680979953"><span class="annot"><span class="annottext">PaymentPubKeyHash
swapOwnersFloating :: PaymentPubKeyHash
swapOwnersFixedLeg :: PaymentPubKeyHash
swapOwnersFloating :: SwapOwners -&gt; PaymentPubKeyHash
swapOwnersFixedLeg :: SwapOwners -&gt; PaymentPubKeyHash
</span><a href="#local-6989586621680979952"><span class="hs-glyph hs-var hs-var hs-var hs-var">..</span></a></span></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680979951"><span class="annot"><span class="annottext">SwapOracleMessage
</span><a href="#local-6989586621680979951"><span class="hs-identifier hs-var">redeemer</span></a></span></span><span> </span><span id="local-6989586621680979950"><span class="annot"><span class="annottext">p :: ScriptContext
</span><a href="#local-6989586621680979950"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.ScriptContext</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">scriptContextTxInfo :: ScriptContext -&gt; TxInfo
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">PV1.scriptContextTxInfo</span></a></span><span class="hs-glyph">=</span><span id="local-6989586621680979947"><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680979947"><span class="hs-identifier hs-var">txInfo</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>    </span><span class="hs-keyword">let</span><span>
</span><span id="line-81"></span><span>        </span><span class="annot"><a href="#local-6989586621680979946"><span class="hs-identifier hs-type">extractVerifyAt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">SignedMessage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">POSIXTime</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span id="local-6989586621680979946"><span class="annot"><span class="annottext">extractVerifyAt :: SwapOracleMessage -&gt; PaymentPubKey -&gt; POSIXTime -&gt; Rational
</span><a href="#local-6989586621680979946"><span class="hs-identifier hs-var hs-var">extractVerifyAt</span></a></span></span><span> </span><span id="local-6989586621680979945"><span class="annot"><span class="annottext">SwapOracleMessage
</span><a href="#local-6989586621680979945"><span class="hs-identifier hs-var">sm</span></a></span></span><span> </span><span id="local-6989586621680979944"><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680979944"><span class="hs-identifier hs-var">pk</span></a></span></span><span> </span><span id="local-6989586621680979943"><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680979943"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-83"></span><span>            </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ScriptContext
-&gt; PaymentPubKey
-&gt; SwapOracleMessage
-&gt; Either SignedMessageCheckError (Observation Rational)
forall a.
FromData a =&gt;
ScriptContext
-&gt; PaymentPubKey
-&gt; SignedMessage a
-&gt; Either SignedMessageCheckError a
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var">Oracle.verifySignedMessageOnChain</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptContext
</span><a href="#local-6989586621680979950"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680979944"><span class="hs-identifier hs-var">pk</span></a></span><span> </span><span class="annot"><span class="annottext">SwapOracleMessage
</span><a href="#local-6989586621680979945"><span class="hs-identifier hs-var">sm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-84"></span><span>                </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span class="annot"><span class="annottext">SignedMessageCheckError
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BuiltinString -&gt; Rational
forall a. BuiltinString -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceError</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;checkSignatureAndDecode failed&quot;</span></span><span>
</span><span id="line-85"></span><span>                </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span class="annot"><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-type">Observation</span></a></span><span class="hs-special">{</span><span id="local-6989586621680979939"><span class="annot"><span class="annottext">Rational
obsValue :: forall a. Observation a -&gt; a
obsValue :: Rational
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">obsValue</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680979937"><span class="annot"><span class="annottext">POSIXTime
obsTime :: forall a. Observation a -&gt; POSIXTime
obsTime :: POSIXTime
</span><a href="../../../../plutus-contract/html/src"><span class="hs-identifier hs-var hs-var">obsTime</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680979937"><span class="hs-identifier hs-var">obsTime</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime -&gt; POSIXTime -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680979943"><span class="hs-identifier hs-var">time</span></a></span><span>
</span><span id="line-87"></span><span>                        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979939"><span class="hs-identifier hs-var">obsValue</span></a></span><span>
</span><span id="line-88"></span><span>                        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">BuiltinString -&gt; Rational
forall a. BuiltinString -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">traceError</span></a></span><span> </span><span class="annot"><span class="annottext">BuiltinString
</span><span class="hs-string">&quot;wrong time&quot;</span></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span>        </span><span class="hs-comment">-- | Convert an [[Integer]] to a [[Rational]]</span><span>
</span><span id="line-91"></span><span>        </span><span class="annot"><a href="#local-6989586621680979934"><span class="hs-identifier hs-type">fromInt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-92"></span><span>        </span><span id="local-6989586621680979934"><span class="annot"><span class="annottext">fromInt :: Integer -&gt; Rational
</span><a href="#local-6989586621680979934"><span class="hs-identifier hs-var hs-var">fromInt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; Integer -&gt; Rational
forall a. () -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><a href="#local-6989586621680979932"><span class="hs-identifier hs-type">adaValueIn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-95"></span><span>        </span><span id="local-6989586621680979932"><span class="annot"><span class="annottext">adaValueIn :: Value -&gt; Integer
</span><a href="#local-6989586621680979932"><span class="hs-identifier hs-var hs-var">adaValueIn</span></a></span></span><span> </span><span id="local-6989586621680979931"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680979931"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ada -&gt; Integer
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">Ada.getLovelace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; Ada
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var">Ada.fromValue</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680979931"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span>        </span><span class="annot"><a href="#local-6989586621680979928"><span class="hs-identifier hs-type">isPaymentPubKeyOutput</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxOut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-type">PaymentPubKeyHash</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span id="local-6989586621680979928"><span class="annot"><span class="annottext">isPaymentPubKeyOutput :: TxOut -&gt; PaymentPubKeyHash -&gt; Bool
</span><a href="#local-6989586621680979928"><span class="hs-identifier hs-var hs-var">isPaymentPubKeyOutput</span></a></span></span><span> </span><span id="local-6989586621680979927"><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979927"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621680979926"><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680979926"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (PubKeyHash -&gt; Bool) -&gt; Maybe PubKeyHash -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PubKeyHash -&gt; PubKeyHash -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">(==)</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; PubKeyHash
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">unPaymentPubKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680979926"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOut -&gt; Maybe PubKeyHash
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">PV1.pubKeyOutput</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979927"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>        </span><span class="hs-comment">-- Verify the authenticity of the oracle value and compute</span><span>
</span><span id="line-101"></span><span>        </span><span class="hs-comment">-- the payments.</span><span>
</span><span id="line-102"></span><span>        </span><span id="local-6989586621680979923"><span class="annot"><span class="annottext">rt :: Rational
</span><a href="#local-6989586621680979923"><span class="hs-identifier hs-var hs-var">rt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SwapOracleMessage -&gt; PaymentPubKey -&gt; POSIXTime -&gt; Rational
</span><a href="#local-6989586621680979946"><span class="hs-identifier hs-var">extractVerifyAt</span></a></span><span> </span><span class="annot"><span class="annottext">SwapOracleMessage
</span><a href="#local-6989586621680979951"><span class="hs-identifier hs-var">redeemer</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKey
</span><a href="#local-6989586621680979954"><span class="hs-identifier hs-var">swapOracle</span></a></span><span> </span><span class="annot"><span class="annottext">POSIXTime
</span><a href="#local-6989586621680979958"><span class="hs-identifier hs-var">swapObservationTime</span></a></span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><a href="#local-6989586621680979922"><span class="hs-identifier hs-type">rtDiff</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-105"></span><span>        </span><span id="local-6989586621680979922"><span class="annot"><span class="annottext">rtDiff :: Rational
</span><a href="#local-6989586621680979922"><span class="hs-identifier hs-var hs-var">rtDiff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979923"><span class="hs-identifier hs-var">rt</span></a></span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. AdditiveGroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979957"><span class="hs-identifier hs-var">swapFixedRate</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>        </span><span id="local-6989586621680979920"><span class="annot"><span class="annottext">amt :: Integer
</span><a href="#local-6989586621680979920"><span class="hs-identifier hs-var hs-var">amt</span></a></span></span><span>    </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ada -&gt; Integer
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">Ada.getLovelace</span></a></span><span> </span><span class="annot"><span class="annottext">Ada
</span><a href="#local-6989586621680979959"><span class="hs-identifier hs-var">swapNotionalAmt</span></a></span><span>
</span><span id="line-108"></span><span>        </span><span id="local-6989586621680979919"><span class="annot"><span class="annottext">margin :: Integer
</span><a href="#local-6989586621680979919"><span class="hs-identifier hs-var hs-var">margin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ada -&gt; Integer
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">Ada.getLovelace</span></a></span><span> </span><span class="annot"><span class="annottext">Ada
</span><a href="#local-6989586621680979955"><span class="hs-identifier hs-var">swapMargin</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span>        </span><span class="annot"><a href="#local-6989586621680979918"><span class="hs-identifier hs-type">amt'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-111"></span><span>        </span><span id="local-6989586621680979918"><span class="annot"><span class="annottext">amt' :: Rational
</span><a href="#local-6989586621680979918"><span class="hs-identifier hs-var hs-var">amt'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Rational
</span><a href="#local-6989586621680979934"><span class="hs-identifier hs-var">fromInt</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979920"><span class="hs-identifier hs-var">amt</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span>        </span><span class="annot"><a href="#local-6989586621680979917"><span class="hs-identifier hs-type">delta</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">Rational</span></a></span><span>
</span><span id="line-114"></span><span>        </span><span id="local-6989586621680979917"><span class="annot"><span class="annottext">delta :: Rational
</span><a href="#local-6989586621680979917"><span class="hs-identifier hs-var hs-var">delta</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979918"><span class="hs-identifier hs-var">amt'</span></a></span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. MultiplicativeSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979922"><span class="hs-identifier hs-var">rtDiff</span></a></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><a href="#local-6989586621680979915"><span class="hs-identifier hs-type">fixedPayment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-117"></span><span>        </span><span id="local-6989586621680979915"><span class="annot"><span class="annottext">fixedPayment :: Integer
</span><a href="#local-6989586621680979915"><span class="hs-identifier hs-var hs-var">fixedPayment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Integer
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">round</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979918"><span class="hs-identifier hs-var">amt'</span></a></span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979917"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span>        </span><span class="annot"><a href="#local-6989586621680979912"><span class="hs-identifier hs-type">floatPayment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-120"></span><span>        </span><span id="local-6989586621680979912"><span class="annot"><span class="annottext">floatPayment :: Integer
</span><a href="#local-6989586621680979912"><span class="hs-identifier hs-var hs-var">floatPayment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Integer
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">round</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979918"><span class="hs-identifier hs-var">amt'</span></a></span><span> </span><span class="annot"><span class="annottext">Rational -&gt; Rational -&gt; Rational
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Rational
</span><a href="#local-6989586621680979917"><span class="hs-identifier hs-var">delta</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span>        </span><span class="hs-comment">-- Compute the payouts (initial margin +/- the sum of the two</span><span>
</span><span id="line-123"></span><span>        </span><span class="hs-comment">-- payments), ensuring that it is at least 0 and does not exceed</span><span>
</span><span id="line-124"></span><span>        </span><span class="hs-comment">-- the total amount of money at stake (2 * margin)</span><span>
</span><span id="line-125"></span><span>        </span><span class="annot"><a href="#local-6989586621680979911"><span class="hs-identifier hs-type">clamp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/integer-gmp-1.0.3.0/src"><span class="hs-identifier hs-type">Integer</span></a></span><span>
</span><span id="line-126"></span><span>        </span><span id="local-6989586621680979911"><span class="annot"><span class="annottext">clamp :: Integer -&gt; Integer
</span><a href="#local-6989586621680979911"><span class="hs-identifier hs-var hs-var">clamp</span></a></span></span><span> </span><span id="local-6989586621680979910"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979910"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">min</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">max</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. MultiplicativeSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">*</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979919"><span class="hs-identifier hs-var">margin</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979910"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>        </span><span id="local-6989586621680979907"><span class="annot"><span class="annottext">fixedRemainder :: Integer
</span><a href="#local-6989586621680979907"><span class="hs-identifier hs-var hs-var">fixedRemainder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer
</span><a href="#local-6989586621680979911"><span class="hs-identifier hs-var">clamp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979919"><span class="hs-identifier hs-var">margin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. AdditiveGroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979915"><span class="hs-identifier hs-var">fixedPayment</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979912"><span class="hs-identifier hs-var">floatPayment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>        </span><span id="local-6989586621680979906"><span class="annot"><span class="annottext">floatRemainder :: Integer
</span><a href="#local-6989586621680979906"><span class="hs-identifier hs-var hs-var">floatRemainder</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer
</span><a href="#local-6989586621680979911"><span class="hs-identifier hs-var">clamp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979919"><span class="hs-identifier hs-var">margin</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. AdditiveGroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979912"><span class="hs-identifier hs-var">floatPayment</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. AdditiveSemigroup a =&gt; a -&gt; a -&gt; a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979915"><span class="hs-identifier hs-var">fixedPayment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-comment">-- The transaction must have one input from each of the</span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-comment">-- participants.</span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-comment">-- NOTE: Partial match is OK because if it fails then the PLC script</span><span>
</span><span id="line-133"></span><span>        </span><span class="hs-comment">--       terminates with `error` and the validation fails (which is</span><span>
</span><span id="line-134"></span><span>        </span><span class="hs-comment">--       what we want when the number of inputs and outputs is /= 2)</span><span>
</span><span id="line-135"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621680979905"><span class="annot"><span class="annottext">TxInInfo
</span><a href="#local-6989586621680979905"><span class="hs-identifier hs-var">t1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680979904"><span class="annot"><span class="annottext">TxInInfo
</span><a href="#local-6989586621680979904"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxInfo -&gt; [TxInInfo]
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">PV1.txInfoInputs</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680979947"><span class="hs-identifier hs-var">txInfo</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621680979902"><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979902"><span class="hs-identifier hs-var">o1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680979901"><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979901"><span class="hs-identifier hs-var">o2</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TxInfo -&gt; [TxOut]
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">PV1.txInfoOutputs</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680979947"><span class="hs-identifier hs-var">txInfo</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span>        </span><span class="hs-comment">-- Each participant must deposit the margin. But we don't know</span><span>
</span><span id="line-139"></span><span>        </span><span class="hs-comment">-- which of the two participant's deposit we are currently</span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-comment">-- evaluating (this script runs on both). So we use the two</span><span>
</span><span id="line-141"></span><span>        </span><span class="hs-comment">-- predicates iP1 and iP2 to cover both cases</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span>        </span><span class="hs-comment">-- True if the transaction input is the margin payment of the</span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-comment">-- fixed leg</span><span>
</span><span id="line-145"></span><span>        </span><span class="annot"><a href="#local-6989586621680979899"><span class="hs-identifier hs-type">iP1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxInInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-146"></span><span>        </span><span id="local-6989586621680979899"><span class="annot"><span class="annottext">iP1 :: TxInInfo -&gt; Bool
</span><a href="#local-6989586621680979899"><span class="hs-identifier hs-var hs-var">iP1</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxInInfo</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">txInInfoResolved :: TxInInfo -&gt; TxOut
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">PV1.txInInfoResolved</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxOut</span></a></span><span class="hs-special">{</span><span id="local-6989586621680979895"><span class="annot"><span class="annottext">Value
txOutValue :: TxOut -&gt; Value
txOutValue :: Value
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var hs-var">txOutValue</span></a></span></span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>            </span><span class="annot"><span class="annottext">TxInfo -&gt; PubKeyHash -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">PV1.txSignedBy</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680979947"><span class="hs-identifier hs-var">txInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; PubKeyHash
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">unPaymentPubKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680979953"><span class="hs-identifier hs-var">swapOwnersFixedLeg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Integer
</span><a href="#local-6989586621680979932"><span class="hs-identifier hs-var">adaValueIn</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680979895"><span class="hs-identifier hs-var">txOutValue</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979919"><span class="hs-identifier hs-var">margin</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span>        </span><span class="hs-comment">-- True if the transaction input is the margin payment of the</span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-comment">-- floating leg</span><span>
</span><span id="line-151"></span><span>        </span><span class="annot"><a href="#local-6989586621680979891"><span class="hs-identifier hs-type">iP2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxInInfo</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-152"></span><span>        </span><span id="local-6989586621680979891"><span class="annot"><span class="annottext">iP2 :: TxInInfo -&gt; Bool
</span><a href="#local-6989586621680979891"><span class="hs-identifier hs-var hs-var">iP2</span></a></span></span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxInInfo</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">txInInfoResolved :: TxInInfo -&gt; TxOut
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">PV1.txInInfoResolved</span></a></span><span class="hs-glyph">=</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxOut</span></a></span><span class="hs-special">{</span><span id="local-6989586621680979890"><span class="annot"><span class="annottext">Value
txOutValue :: Value
txOutValue :: TxOut -&gt; Value
</span><a href="#local-6989586621680979890"><span class="hs-identifier hs-var hs-var">txOutValue</span></a></span></span><span class="hs-special">}</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-153"></span><span>            </span><span class="annot"><span class="annottext">TxInfo -&gt; PubKeyHash -&gt; Bool
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">PV1.txSignedBy</span></a></span><span> </span><span class="annot"><span class="annottext">TxInfo
</span><a href="#local-6989586621680979947"><span class="hs-identifier hs-var">txInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PaymentPubKeyHash -&gt; PubKeyHash
</span><a href="../../../../plutus-ledger/html/src"><span class="hs-identifier hs-var hs-var">unPaymentPubKeyHash</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680979952"><span class="hs-identifier hs-var">swapOwnersFloating</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Integer
</span><a href="#local-6989586621680979932"><span class="hs-identifier hs-var">adaValueIn</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680979890"><span class="hs-identifier hs-var">txOutValue</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979919"><span class="hs-identifier hs-var">margin</span></a></span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>        </span><span id="local-6989586621680979889"><span class="annot"><span class="annottext">inConditions :: Bool
</span><a href="#local-6989586621680979889"><span class="hs-identifier hs-var hs-var">inConditions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxInInfo -&gt; Bool
</span><a href="#local-6989586621680979899"><span class="hs-identifier hs-var">iP1</span></a></span><span> </span><span class="annot"><span class="annottext">TxInInfo
</span><a href="#local-6989586621680979905"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">TxInInfo -&gt; Bool
</span><a href="#local-6989586621680979891"><span class="hs-identifier hs-var">iP2</span></a></span><span> </span><span class="annot"><span class="annottext">TxInInfo
</span><a href="#local-6989586621680979904"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxInInfo -&gt; Bool
</span><a href="#local-6989586621680979899"><span class="hs-identifier hs-var">iP1</span></a></span><span> </span><span class="annot"><span class="annottext">TxInInfo
</span><a href="#local-6989586621680979904"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">TxInInfo -&gt; Bool
</span><a href="#local-6989586621680979891"><span class="hs-identifier hs-var">iP2</span></a></span><span> </span><span class="annot"><span class="annottext">TxInInfo
</span><a href="#local-6989586621680979905"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>
</span><span id="line-157"></span><span>        </span><span class="hs-comment">-- The transaction must have two outputs, one for each of the</span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-comment">-- participants, which equal the margin adjusted by the difference</span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-comment">-- between fixed and floating payment</span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-comment">-- True if the output is the payment of the fixed leg.</span><span>
</span><span id="line-162"></span><span>        </span><span class="annot"><a href="#local-6989586621680979887"><span class="hs-identifier hs-type">ol1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxOut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-163"></span><span>        </span><span id="local-6989586621680979887"><span class="annot"><span class="annottext">ol1 :: TxOut -&gt; Bool
</span><a href="#local-6989586621680979887"><span class="hs-identifier hs-var hs-var">ol1</span></a></span></span><span> </span><span id="local-6989586621680979886"><span class="annot"><span class="annottext">o :: TxOut
</span><a href="#local-6989586621680979886"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxOut</span></a></span><span class="hs-special">{</span><span id="local-6989586621680979885"><span class="annot"><span class="annottext">Value
txOutValue :: Value
txOutValue :: TxOut -&gt; Value
</span><a href="#local-6989586621680979885"><span class="hs-identifier hs-var hs-var">PV1.txOutValue</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-164"></span><span>            </span><span class="annot"><span class="annottext">TxOut -&gt; PaymentPubKeyHash -&gt; Bool
</span><a href="#local-6989586621680979928"><span class="hs-identifier hs-var">isPaymentPubKeyOutput</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979886"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680979953"><span class="hs-identifier hs-var">swapOwnersFixedLeg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Integer
</span><a href="#local-6989586621680979932"><span class="hs-identifier hs-var">adaValueIn</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680979885"><span class="hs-identifier hs-var">txOutValue</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979907"><span class="hs-identifier hs-var">fixedRemainder</span></a></span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>        </span><span class="hs-comment">-- True if the output is the payment of the floating leg.</span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><a href="#local-6989586621680979883"><span class="hs-identifier hs-type">ol2</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxOut</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-168"></span><span>        </span><span id="local-6989586621680979883"><span class="annot"><span class="annottext">ol2 :: TxOut -&gt; Bool
</span><a href="#local-6989586621680979883"><span class="hs-identifier hs-var hs-var">ol2</span></a></span></span><span> </span><span id="local-6989586621680979882"><span class="annot"><span class="annottext">o :: TxOut
</span><a href="#local-6989586621680979882"><span class="hs-identifier hs-var">o</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.TxOut</span></a></span><span class="hs-special">{</span><span id="local-6989586621680979881"><span class="annot"><span class="annottext">Value
txOutValue :: Value
txOutValue :: TxOut -&gt; Value
</span><a href="#local-6989586621680979881"><span class="hs-identifier hs-var hs-var">PV1.txOutValue</span></a></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-169"></span><span>            </span><span class="annot"><span class="annottext">TxOut -&gt; PaymentPubKeyHash -&gt; Bool
</span><a href="#local-6989586621680979928"><span class="hs-identifier hs-var">isPaymentPubKeyOutput</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979882"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="annot"><span class="annottext">PaymentPubKeyHash
</span><a href="#local-6989586621680979952"><span class="hs-identifier hs-var">swapOwnersFloating</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Value -&gt; Integer
</span><a href="#local-6989586621680979932"><span class="hs-identifier hs-var">adaValueIn</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621680979881"><span class="hs-identifier hs-var">txOutValue</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621680979906"><span class="hs-identifier hs-var">floatRemainder</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-comment">-- NOTE: I didn't include a check that the time is greater</span><span>
</span><span id="line-172"></span><span>        </span><span class="hs-comment">-- than the observation time. This is because the time is</span><span>
</span><span id="line-173"></span><span>        </span><span class="hs-comment">-- already part of the oracle value and we trust the oracle.</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>        </span><span id="local-6989586621680979880"><span class="annot"><span class="annottext">outConditions :: Bool
</span><a href="#local-6989586621680979880"><span class="hs-identifier hs-var hs-var">outConditions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOut -&gt; Bool
</span><a href="#local-6989586621680979887"><span class="hs-identifier hs-var">ol1</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979902"><span class="hs-identifier hs-var">o1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut -&gt; Bool
</span><a href="#local-6989586621680979883"><span class="hs-identifier hs-var">ol2</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979901"><span class="hs-identifier hs-var">o2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TxOut -&gt; Bool
</span><a href="#local-6989586621680979887"><span class="hs-identifier hs-var">ol1</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979901"><span class="hs-identifier hs-var">o2</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut -&gt; Bool
</span><a href="#local-6989586621680979883"><span class="hs-identifier hs-var">ol2</span></a></span><span> </span><span class="annot"><span class="annottext">TxOut
</span><a href="#local-6989586621680979902"><span class="hs-identifier hs-var">o1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>    </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680979889"><span class="hs-identifier hs-var">inConditions</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621680979880"><span class="hs-identifier hs-var">outConditions</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">-- | Validator script for the two transactions that initialise the swap.</span><span>
</span><span id="line-180"></span><span class="hs-comment">--   See note [Swap Transactions]</span><span>
</span><span id="line-181"></span><span class="hs-comment">--   See note [Contracts and Validator Scripts] in</span><span>
</span><span id="line-182"></span><span class="hs-comment">--       Language.Plutus.Coordination.Contracts</span><span>
</span><span id="line-183"></span><span class="annot"><a href="Plutus.Contracts.Swap.html#swapValidator"><span class="hs-identifier hs-type">swapValidator</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Plutus.Contracts.Swap.html#Swap"><span class="hs-identifier hs-type">Swap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-type">PV1.Validator</span></a></span><span>
</span><span id="line-184"></span><span id="swapValidator"><span class="annot"><span class="annottext">swapValidator :: Swap -&gt; Validator
</span><a href="Plutus.Contracts.Swap.html#swapValidator"><span class="hs-identifier hs-var hs-var">swapValidator</span></a></span></span><span> </span><span id="local-6989586621680979879"><span class="annot"><span class="annottext">Swap
</span><a href="#local-6989586621680979879"><span class="hs-identifier hs-var">swp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CompiledCode (BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ())
-&gt; Validator
</span><a href="../../../../plutus-ledger-api/html/src"><span class="hs-identifier hs-var">PV1.mkValidatorScript</span></a></span><span> </span><span class="annot"><span class="annottext">(CompiledCode (BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ())
 -&gt; Validator)
-&gt; CompiledCode (BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ())
-&gt; Validator
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span class="hs-special">$$(</span><span class="annot"><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-type">PlutusTx.compile</span></a></span><span> </span><span class="hs-special">[||</span><span> </span><span class="hs-identifier">validatorParam</span><span> </span><span class="hs-special">||]</span><span class="hs-special">)</span><span>
</span><span id="line-186"></span><span>        </span><span class="annot"><span class="annottext">CompiledCode
  (Swap -&gt; BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ())
-&gt; CompiledCodeIn DefaultUni DefaultFun Swap
-&gt; CompiledCode (BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ())
forall (uni :: * -&gt; *) fun a b.
(Closed uni, Everywhere uni Flat, Flat fun,
 Everywhere uni PrettyConst, GShow uni, Pretty fun) =&gt;
CompiledCodeIn uni fun (a -&gt; b)
-&gt; CompiledCodeIn uni fun a -&gt; CompiledCodeIn uni fun b
</span><a href="../../../../plutus-tx/html/src"><span class="hs-operator hs-var">`PlutusTx.applyCode`</span></a></span><span>
</span><span id="line-187"></span><span>            </span><span class="annot"><span class="annottext">Swap -&gt; CompiledCodeIn DefaultUni DefaultFun Swap
forall (uni :: * -&gt; *) a fun.
(Lift uni a, Throwable uni fun, Typecheckable uni fun) =&gt;
a -&gt; CompiledCodeIn uni fun a
</span><a href="../../../../plutus-tx/html/src"><span class="hs-identifier hs-var">PlutusTx.liftCode</span></a></span><span> </span><span class="annot"><span class="annottext">Swap
</span><a href="#local-6989586621680979879"><span class="hs-identifier hs-var">swp</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621680979876"><span class="annot"><span class="annottext">validatorParam :: Swap -&gt; BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ()
</span><a href="#local-6989586621680979876"><span class="hs-identifier hs-var hs-var">validatorParam</span></a></span></span><span> </span><span id="local-6989586621680979870"><span class="annot"><span class="annottext">Swap
</span><a href="#local-6989586621680979870"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SwapOwners -&gt; SwapOracleMessage -&gt; ScriptContext -&gt; Bool)
-&gt; BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ()
forall sc d r.
(IsScriptContext sc, UnsafeFromData d, UnsafeFromData r) =&gt;
(d -&gt; r -&gt; sc -&gt; Bool)
-&gt; BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ()
</span><a href="../../../../plutus-script-utils/html/src"><span class="hs-identifier hs-var">Scripts.mkUntypedValidator</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Swap -&gt; SwapOwners -&gt; SwapOracleMessage -&gt; ScriptContext -&gt; Bool
</span><a href="Plutus.Contracts.Swap.html#mkValidator"><span class="hs-identifier hs-var">mkValidator</span></a></span><span> </span><span class="annot"><span class="annottext">Swap
</span><a href="#local-6989586621680979870"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-comment">{- Note [Swap Transactions]

The swap involves three transactions at two different times.

1. At t=0. Each participant deposits the margin. The outputs are locked with
   the same validator script, `swapValidator`
2. At t=n. The value of the floating rate, and consequently the values of the
   two payments are determined. Each participant gets their margin plus or
   minus the actual payment.

There is a risk of losing out if the interest rate moves outside the range of
fixedRate +/- (margin / notional amount). In a real financial contract this
would be dealt with by agreeing a &quot;Variation Margin&quot;. This means that the
margin is adjusted at predefined dates before the actual payment is due. If one
of the parties fails to make the variation margin payment, the contract ends
prematurely and the other party gets to keep both margins.

Plutus should be able to handle variation margins in a series of validation
scripts. But it seems to me that they could get quite messy so I don't want to
write them by hand :) We can probably use TH to generate them at compile time.

-}</span><span>
</span><span id="line-212"></span></pre></body></html>
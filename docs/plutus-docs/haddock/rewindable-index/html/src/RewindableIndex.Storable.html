<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">RewindableIndex.Storable</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * State</span></span><span>
</span><span id="line-3"></span><span>    </span><span class="annot"><a href="RewindableIndex.Storable.html#Config"><span class="hs-identifier">Config</span></a></span><span>
</span><span id="line-4"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#memoryBufferSize"><span class="hs-identifier">memoryBufferSize</span></a></span><span>
</span><span id="line-5"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier">State</span></a></span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier">handle</span></a></span><span>
</span><span id="line-7"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#config"><span class="hs-identifier">config</span></a></span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#emptyState"><span class="hs-identifier">emptyState</span></a></span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier">Storage</span></a></span><span>
</span><span id="line-10"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier">storage</span></a></span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#events"><span class="hs-identifier">events</span></a></span><span>
</span><span id="line-12"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier">cursor</span></a></span><span>
</span><span id="line-13"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#getMemoryEvents"><span class="hs-identifier">getMemoryEvents</span></a></span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#getEvents"><span class="hs-identifier">getEvents</span></a></span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#filterWithQueryInterval"><span class="hs-identifier">filterWithQueryInterval</span></a></span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier">StorableEvent</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier">StorablePoint</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableQuery"><span class="hs-identifier">StorableQuery</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableResult"><span class="hs-identifier">StorableResult</span></a></span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier">StorableMonad</span></a></span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><span class="hs-comment">-- * API</span></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#QueryInterval"><span class="hs-identifier">QueryInterval</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Buffered"><span class="hs-identifier">Buffered</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Queryable"><span class="hs-identifier">Queryable</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Resumable"><span class="hs-identifier">Resumable</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Rewindable"><span class="hs-identifier">Rewindable</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#HasPoint"><span class="hs-identifier">HasPoint</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#insert"><span class="hs-identifier">insert</span></a></span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#insertMany"><span class="hs-identifier">insertMany</span></a></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#rewind"><span class="hs-identifier">rewind</span></a></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#resume"><span class="hs-identifier">resume</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#query"><span class="hs-identifier">query</span></a></span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Control.Applicative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&lt;|&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Lens.Operators</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator">(%~)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator">(.~)</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator">(^.)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-identifier">Control.Lens.TH</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Lens</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier">Control.Monad.Primitive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier">PrimMonad</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier">PrimState</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">foldlM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Function</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&amp;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Data.Functor</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator">(&lt;&amp;&gt;)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier">Data.Vector</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier">Data.Vector.Generic</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VG</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier">Data.Vector.Mutable</span></a></span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">VM</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">GHC.Generics</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-comment">{-
   The extensible parts of the indexers are the way data is stored into some form
   of persistent storage. The interface used for working blockchain events is defined
   in this module.

   There are quite a bit of type variables that are involed in defining this interface.
   Some of them stand for the type of database connection (h), the type of events (e),
   the type of points along the blockchain (denoted by p), the type of queries (q) and
   results.

   The following data families implement the observation that most of the variables
   can be derived from the way information is stored in the database, so there is
   quite a bit of convenience in reducing the number of type variables to just two.
   One that stands for the database connection (which should be a newtype for each
   indexer) and one for the monad in which the indexer runs (usually IO).
-}</span><span>
</span><span id="line-63"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableEvent"><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-var">StorableEvent</span></a></span></span><span> </span><span id="local-6989586621679114893"><span class="annot"><a href="#local-6989586621679114893"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorablePoint"><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-var">StorablePoint</span></a></span></span><span> </span><span id="local-6989586621679114892"><span class="annot"><a href="#local-6989586621679114892"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-66"></span><span>
</span><span id="line-67"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableQuery"><span class="annot"><a href="RewindableIndex.Storable.html#StorableQuery"><span class="hs-identifier hs-var">StorableQuery</span></a></span></span><span> </span><span id="local-6989586621679114891"><span class="annot"><a href="#local-6989586621679114891"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-keyword">data</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableResult"><span class="annot"><a href="RewindableIndex.Storable.html#StorableResult"><span class="hs-identifier hs-var">StorableResult</span></a></span></span><span> </span><span id="local-6989586621679114890"><span class="annot"><a href="#local-6989586621679114890"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><span id="StorableMonad"><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-var">StorableMonad</span></a></span></span><span> </span><span id="local-6989586621679114889"><span class="annot"><a href="#local-6989586621679114889"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-operator">*</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-operator">*</span></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-comment">{-
   Query intervals are a necessary tool to make the queries a little safer. As we can
   assume that there will be multiple concurrent indexers running there is no guarantee
   that they are all synchronised upto the same block, so specifying a query validity
   will ensure that the queries data is acceptably synchronised across all queried
   indexers.
-}</span><span>
</span><span id="line-80"></span><span id="local-6989586621679114887"><span id="local-6989586621679114888"></span></span><span class="hs-keyword">data</span><span> </span><span id="QueryInterval"><span class="annot"><a href="RewindableIndex.Storable.html#QueryInterval"><span class="hs-identifier hs-var">QueryInterval</span></a></span></span><span> </span><span id="local-6989586621679114886"><span class="annot"><a href="#local-6989586621679114886"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-81"></span><span>    </span><span id="QEverything"><span class="annot"><a href="RewindableIndex.Storable.html#QEverything"><span class="hs-identifier hs-var">QEverything</span></a></span></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="QInterval"><span class="annot"><a href="RewindableIndex.Storable.html#QInterval"><span class="hs-identifier hs-var">QInterval</span></a></span></span><span> </span><span class="annot"><a href="#local-6989586621679114886"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114886"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679114878"><span id="local-6989586621679114880"><span id="local-6989586621679114882"><span class="annot"><span class="annottext">Int -&gt; QueryInterval p -&gt; ShowS
[QueryInterval p] -&gt; ShowS
QueryInterval p -&gt; String
(Int -&gt; QueryInterval p -&gt; ShowS)
-&gt; (QueryInterval p -&gt; String)
-&gt; ([QueryInterval p] -&gt; ShowS)
-&gt; Show (QueryInterval p)
forall p. Show p =&gt; Int -&gt; QueryInterval p -&gt; ShowS
forall p. Show p =&gt; [QueryInterval p] -&gt; ShowS
forall p. Show p =&gt; QueryInterval p -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [QueryInterval p] -&gt; ShowS
$cshowList :: forall p. Show p =&gt; [QueryInterval p] -&gt; ShowS
show :: QueryInterval p -&gt; String
$cshow :: forall p. Show p =&gt; QueryInterval p -&gt; String
showsPrec :: Int -&gt; QueryInterval p -&gt; ShowS
$cshowsPrec :: forall p. Show p =&gt; Int -&gt; QueryInterval p -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679114873"><span id="local-6989586621679114875"><span class="annot"><span class="annottext">QueryInterval p -&gt; QueryInterval p -&gt; Bool
(QueryInterval p -&gt; QueryInterval p -&gt; Bool)
-&gt; (QueryInterval p -&gt; QueryInterval p -&gt; Bool)
-&gt; Eq (QueryInterval p)
forall p. Eq p =&gt; QueryInterval p -&gt; QueryInterval p -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: QueryInterval p -&gt; QueryInterval p -&gt; Bool
$c/= :: forall p. Eq p =&gt; QueryInterval p -&gt; QueryInterval p -&gt; Bool
== :: QueryInterval p -&gt; QueryInterval p -&gt; Bool
$c== :: forall p. Eq p =&gt; QueryInterval p -&gt; QueryInterval p -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(forall x. QueryInterval p -&gt; Rep (QueryInterval p) x)
-&gt; (forall x. Rep (QueryInterval p) x -&gt; QueryInterval p)
-&gt; Generic (QueryInterval p)
forall x. Rep (QueryInterval p) x -&gt; QueryInterval p
forall x. QueryInterval p -&gt; Rep (QueryInterval p) x
forall a.
(forall x. a -&gt; Rep a x) -&gt; (forall x. Rep a x -&gt; a) -&gt; Generic a
forall p x. Rep (QueryInterval p) x -&gt; QueryInterval p
forall p x. QueryInterval p -&gt; Rep (QueryInterval p) x
$cto :: forall p x. Rep (QueryInterval p) x -&gt; QueryInterval p
$cfrom :: forall p x. QueryInterval p -&gt; Rep (QueryInterval p) x
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var">Generic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span class="hs-comment">{-
   The first, `Buffered` class explains what it means for an indexer to be accumulating
   a set of results that will be flushed to disk when the memory buffer is fully filled.

   The memory layout of the indexer has been simplified by a lot since the previous
   version and it looks something like this:

   |e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|e|                                     |
   |-------------------|---------------|-------------------------------------|
   |   memory/buffer   |  disk/events  |       disk/aggregate (optional)     |

   When the buffer is filled with events, they all get flushed to disk. We need this
   operation for performance reasons. Most databases will have significantly improved
   performance for batch inserts.

   Rollbacks will only happen in the memory or disk/events storage area, so the
   developer has to make sure that the allocated space for the buffer and the
   disk/events is greater than the K parameter.

   The last part disk/aggregate represents some aggregated data. At some point the
   developer should write code to aggregate the disk/events into the aggregate
   section of the database. We did not provide any special handling of this for the
   following reasons:

     1) A lot of indexers will not require aggregated data. Only storing events should
        be enough for most applications.
     2) Data aggregation can be implemented at database level and probably be more
        efficient than what Haskell can do here.
     3) We can always extend the interface to include direct support for this pattern
        if there is a demand from the users of the API.
-}</span><span>
</span><span id="line-116"></span><span class="hs-keyword">class</span><span> </span><span id="Buffered"><span class="annot"><a href="RewindableIndex.Storable.html#Buffered"><span class="hs-identifier hs-var">Buffered</span></a></span></span><span> </span><span id="local-6989586621679114982"><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-117"></span><span>  </span><span class="hs-comment">-- This function persists the memory/buffer events to disk.</span><span>
</span><span id="line-118"></span><span>  </span><span id="local-6989586621679114960"><span id="persistToStorage"><span class="annot"><a href="RewindableIndex.Storable.html#persistToStorage"><span class="hs-identifier hs-type">persistToStorage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114960"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114960"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-comment">{- This function retrieves the events from the disk/events area.
     If the user chooses to only store events, without accumulating them, this function
     is expected to return the events over which rollbacks can occur in order to keep
     things performant -}</span><span>
</span><span id="line-124"></span><span>  </span><span id="getStoredEvents"><span class="annot"><a href="RewindableIndex.Storable.html#getStoredEvents"><span class="hs-identifier hs-type">getStoredEvents</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114982"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-comment">{-
   All information from indexers should be made accessible through queries. Queries
   act a lot like folds over the event stream. Each query introduces two indexed types:
   one for the type of requests (called StorableQuery) and one for responses (called
   StorableResult).

   All queries include a validity interval. If the data is not available for a specified
   interval, the returned result should specify that. It is also recommended that the result
   includes the slot number at which the query was ran.
-}</span><span>
</span><span id="line-136"></span><span class="hs-keyword">class</span><span> </span><span id="Queryable"><span class="annot"><a href="RewindableIndex.Storable.html#Queryable"><span class="hs-identifier hs-var">Queryable</span></a></span></span><span> </span><span id="local-6989586621679114919"><span class="annot"><a href="#local-6989586621679114919"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-137"></span><span>  </span><span id="local-6989586621679114917"><span id="queryStorage"><span class="annot"><a href="RewindableIndex.Storable.html#queryStorage"><span class="hs-identifier hs-type">queryStorage</span></a></span></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114917"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#QueryInterval"><span class="hs-identifier hs-type">QueryInterval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114919"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114917"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114919"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114919"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableQuery"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114919"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114919"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableResult"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114919"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-comment">{-
   One of the reasons why indexers were born was to solve one of the issues very specific
   to blockchains: rollbacks. The basic idea was simple, keep a history of the blockchain
   data and whenever we have a rollback restore the version which is the target of the
   rollback.

   This is what the next class is meant to do.
-}</span><span>
</span><span id="line-153"></span><span class="hs-keyword">class</span><span> </span><span id="Rewindable"><span class="annot"><a href="RewindableIndex.Storable.html#Rewindable"><span class="hs-identifier hs-var">Rewindable</span></a></span></span><span> </span><span id="local-6989586621679114946"><span class="annot"><a href="#local-6989586621679114946"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-154"></span><span>  </span><span id="rewindStorage"><span class="annot"><a href="RewindableIndex.Storable.html#rewindStorage"><span class="hs-identifier hs-type">rewindStorage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114946"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114946"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114946"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114946"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">{-
   Another feature of indexers is the ability to resume from a previously stored event.
   One way of implementing this is to make sure that there is always at least one event
   present on disk, event which includes the slot number when it was generated.

   This function should return the most recent resume point. The plan is to support
   multiple resume points, but for now there is no way to ensure that no data duplication
   happens (the same events get reinserted).

   This will not be a problem if the indexer learns how to remove the `old` slots
   so there will be no duplication. This may be implemented later if the API users
   request it.
-}</span><span>
</span><span id="line-169"></span><span class="hs-keyword">class</span><span> </span><span id="Resumable"><span class="annot"><a href="RewindableIndex.Storable.html#Resumable"><span class="hs-identifier hs-var">Resumable</span></a></span></span><span> </span><span id="local-6989586621679114931"><span class="annot"><a href="#local-6989586621679114931"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>  </span><span id="resumeFromStorage"><span class="annot"><a href="RewindableIndex.Storable.html#resumeFromStorage"><span class="hs-identifier hs-type">resumeFromStorage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679114931"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114931"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114931"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span class="hs-comment">{-
   The next class is witnessing the fact that events contain enough information to
   retrieve the point when they were produced.
-}</span><span>
</span><span id="line-176"></span><span class="hs-keyword">class</span><span> </span><span id="HasPoint"><span class="annot"><a href="RewindableIndex.Storable.html#HasPoint"><span class="hs-identifier hs-var">HasPoint</span></a></span></span><span> </span><span id="local-6989586621679114935"><span class="annot"><a href="#local-6989586621679114935"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span id="local-6989586621679114934"><span class="annot"><a href="#local-6989586621679114934"><span class="hs-identifier hs-type">p</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-177"></span><span>  </span><span id="getPoint"><span class="annot"><a href="RewindableIndex.Storable.html#getPoint"><span class="hs-identifier hs-type">getPoint</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679114935"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114934"><span class="hs-identifier hs-type">p</span></a></span><span>
</span><span id="line-178"></span><span>
</span><span id="line-179"></span><span class="hs-comment">{-
   The configuration includes hints about the amount of events stored in memory and
   on disk. This information is used by the storage engine to decide how much memory
   to allocated and when to flush the memory buffer or roll the disk events into
   an aggregate database structure.
-}</span><span>
</span><span id="line-185"></span><span class="hs-keyword">newtype</span><span> </span><span id="Config"><span class="annot"><a href="RewindableIndex.Storable.html#Config"><span class="hs-identifier hs-var">Config</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Config"><span class="annot"><a href="RewindableIndex.Storable.html#Config"><span class="hs-identifier hs-var">Config</span></a></span></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_memoryBufferSize"><span class="annot"><span class="annottext">Config -&gt; Int
</span><a href="RewindableIndex.Storable.html#_memoryBufferSize"><span class="hs-identifier hs-var hs-var">_memoryBufferSize</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679114855"><span id="local-6989586621679114857"><span id="local-6989586621679114859"><span class="annot"><span class="annottext">Int -&gt; Config -&gt; ShowS
[Config] -&gt; ShowS
Config -&gt; String
(Int -&gt; Config -&gt; ShowS)
-&gt; (Config -&gt; String) -&gt; ([Config] -&gt; ShowS) -&gt; Show Config
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Config] -&gt; ShowS
$cshowList :: [Config] -&gt; ShowS
show :: Config -&gt; String
$cshow :: Config -&gt; String
showsPrec :: Int -&gt; Config -&gt; ShowS
$cshowsPrec :: Int -&gt; Config -&gt; ShowS
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679114851"><span id="local-6989586621679114853"><span class="annot"><span class="annottext">Config -&gt; Config -&gt; Bool
(Config -&gt; Config -&gt; Bool)
-&gt; (Config -&gt; Config -&gt; Bool) -&gt; Eq Config
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Config -&gt; Config -&gt; Bool
$c/= :: Config -&gt; Config -&gt; Bool
== :: Config -&gt; Config -&gt; Bool
$c== :: Config -&gt; Config -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></a></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span class="hs-special">$(</span><span id="memoryBufferSize"><span class="hs-identifier">Lens.makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Config</span></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-keyword">data</span><span> </span><span id="Storage"><span class="annot"><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier hs-var">Storage</span></a></span></span><span> </span><span id="local-6989586621679115003"><span class="annot"><a href="#local-6989586621679115003"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Storage"><span class="annot"><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier hs-var">Storage</span></a></span></span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_events"><span class="annot"><span class="annottext">Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="RewindableIndex.Storable.html#_events"><span class="hs-identifier hs-var hs-var">_events</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-type">VM.MVector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679115003"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679115003"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_cursor"><span class="annot"><span class="annottext">Storage h -&gt; Int
</span><a href="RewindableIndex.Storable.html#_cursor"><span class="hs-identifier hs-var hs-var">_cursor</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-194"></span><span class="hs-special">$(</span><span id="cursor"><span id="events"><span id="local-6989586621679114995"><span id="local-6989586621679115003"><span class="hs-identifier">Lens.makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">Storage</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-keyword">data</span><span> </span><span id="State"><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span> </span><span id="local-6989586621679115004"><span class="annot"><a href="#local-6989586621679115004"><span class="hs-identifier hs-type">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="State"><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-var">State</span></a></span></span><span>
</span><span id="line-197"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="_config"><span class="annot"><span class="annottext">State h -&gt; Config
</span><a href="RewindableIndex.Storable.html#_config"><span class="hs-identifier hs-var hs-var">_config</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_storage"><span class="annot"><span class="annottext">State h -&gt; Storage h
</span><a href="RewindableIndex.Storable.html#_storage"><span class="hs-identifier hs-var hs-var">_storage</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679115004"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="_handle"><span class="annot"><span class="annottext">State h -&gt; h
</span><a href="RewindableIndex.Storable.html#_handle"><span class="hs-identifier hs-var hs-var">_handle</span></a></span></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621679115004"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-201"></span><span class="hs-special">$(</span><span id="storage"><span id="config"><span id="handle"><span id="local-6989586621679115004"><span class="hs-identifier">Lens.makeLenses</span><span> </span><span class="hs-special">''</span><span class="hs-identifier">State</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span id="local-6989586621679114843"><span class="annot"><a href="RewindableIndex.Storable.html#emptyState"><span class="hs-identifier hs-type">emptyState</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114843"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Int</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114843"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114843"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114843"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-208"></span><span id="emptyState"><span class="annot"><span class="annottext">emptyState :: Int -&gt; h -&gt; StorableMonad h (State h)
</span><a href="RewindableIndex.Storable.html#emptyState"><span class="hs-identifier hs-var hs-var">emptyState</span></a></span></span><span> </span><span id="local-6989586621679114842"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114842"><span class="hs-identifier hs-var">memBuf</span></a></span></span><span> </span><span id="local-6989586621679114841"><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679114841"><span class="hs-identifier hs-var">hdl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-209"></span><span>  </span><span id="local-6989586621679114840"><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="#local-6989586621679114840"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; StorableMonad
     h (MVector (PrimState (StorableMonad h)) (StorableEvent h))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
Int -&gt; m (MVector (PrimState m) a)
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">VM.new</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114842"><span class="hs-identifier hs-var">memBuf</span></a></span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; StorableMonad h (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State :: forall h. Config -&gt; Storage h -&gt; h -&gt; State h
</span><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_config :: Config
</span><a href="RewindableIndex.Storable.html#_config"><span class="hs-identifier hs-var">_config</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Config :: Int -&gt; Config
</span><a href="RewindableIndex.Storable.html#Config"><span class="hs-identifier hs-type">Config</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_memoryBufferSize :: Int
</span><a href="RewindableIndex.Storable.html#_memoryBufferSize"><span class="hs-identifier hs-var">_memoryBufferSize</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114842"><span class="hs-identifier hs-var">memBuf</span></a></span><span>
</span><span id="line-211"></span><span>                                  </span><span class="hs-special">}</span><span>
</span><span id="line-212"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_storage :: Storage h
</span><a href="RewindableIndex.Storable.html#_storage"><span class="hs-identifier hs-var">_storage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage :: forall h.
MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; Int -&gt; Storage h
</span><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_events :: MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="RewindableIndex.Storable.html#_events"><span class="hs-identifier hs-var">_events</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="#local-6989586621679114840"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-213"></span><span>                                    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_cursor :: Int
</span><a href="RewindableIndex.Storable.html#_cursor"><span class="hs-identifier hs-var">_cursor</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-214"></span><span>                                    </span><span class="hs-special">}</span><span>
</span><span id="line-215"></span><span>               </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">_handle :: h
</span><a href="RewindableIndex.Storable.html#_handle"><span class="hs-identifier hs-var">_handle</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679114841"><span class="hs-identifier hs-var">hdl</span></a></span><span>
</span><span id="line-216"></span><span>               </span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- Get events from the memory buffer.</span><span>
</span><span id="line-219"></span><span id="local-6989586621679114992"><span class="annot"><a href="RewindableIndex.Storable.html#getMemoryEvents"><span class="hs-identifier hs-type">getMemoryEvents</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114992"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-type">V.MVector</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimState</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114992"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114992"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-222"></span><span id="getMemoryEvents"><span class="annot"><span class="annottext">getMemoryEvents :: Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="RewindableIndex.Storable.html#getMemoryEvents"><span class="hs-identifier hs-var hs-var">getMemoryEvents</span></a></span></span><span> </span><span id="local-6989586621679114838"><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114838"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall s a. Int -&gt; Int -&gt; MVector s a -&gt; MVector s a
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">VM.slice</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114838"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h -&gt; Getting Int (Storage h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting Int (Storage h) Int
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114838"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; Getting
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
     (Storage h)
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
  (Storage h)
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
forall h h.
Lens
  (Storage h)
  (Storage h)
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
</span><a href="RewindableIndex.Storable.html#events"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="hs-comment">-- Get events from memory buffer and disk buffer.</span><span>
</span><span id="line-225"></span><span id="local-6989586621679114836"><span class="annot"><a href="RewindableIndex.Storable.html#getEvents"><span class="hs-identifier hs-type">getEvents</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114836"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114836"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114836"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114836"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114836"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-230"></span><span id="getEvents"><span class="annot"><span class="annottext">getEvents :: State h -&gt; StorableMonad h [StorableEvent h]
</span><a href="RewindableIndex.Storable.html#getEvents"><span class="hs-identifier hs-var hs-var">getEvents</span></a></span></span><span> </span><span id="local-6989586621679114835"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114835"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>  </span><span id="local-6989586621679114834"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114834"><span class="hs-identifier hs-var">memoryEs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall h.
Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="RewindableIndex.Storable.html#getMemoryEvents"><span class="hs-identifier hs-var">getMemoryEvents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114835"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>              </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; (MVector (PrimState (StorableMonad h)) (StorableEvent h)
    -&gt; StorableMonad h (Vector (StorableEvent h)))
-&gt; StorableMonad h (Vector (StorableEvent h))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; StorableMonad h (Vector (StorableEvent h))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">StorableMonad h (Vector (StorableEvent h))
-&gt; (Vector (StorableEvent h) -&gt; [StorableEvent h])
-&gt; StorableMonad h [StorableEvent h]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (StorableEvent h) -&gt; [StorableEvent h]
forall a. Vector a -&gt; [a]
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">V.toList</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span id="local-6989586621679114831"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114831"><span class="hs-identifier hs-var">diskEs</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">h -&gt; StorableMonad h [StorableEvent h]
forall h. Buffered h =&gt; h -&gt; StorableMonad h [StorableEvent h]
</span><a href="RewindableIndex.Storable.html#getStoredEvents"><span class="hs-identifier hs-var">getStoredEvents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114835"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">[StorableEvent h] -&gt; StorableMonad h [StorableEvent h]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">([StorableEvent h] -&gt; StorableMonad h [StorableEvent h])
-&gt; [StorableEvent h] -&gt; StorableMonad h [StorableEvent h]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114831"><span class="hs-identifier hs-var">diskEs</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h] -&gt; [StorableEvent h] -&gt; [StorableEvent h]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114834"><span class="hs-identifier hs-var">memoryEs</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span id="local-6989586621679114949"><span class="annot"><a href="RewindableIndex.Storable.html#insert"><span class="hs-identifier hs-type">insert</span></a></span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114949"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-238"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114949"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114949"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114949"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114949"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114949"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-242"></span><span id="insert"><span class="annot"><span class="annottext">insert :: StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="RewindableIndex.Storable.html#insert"><span class="hs-identifier hs-var hs-var">insert</span></a></span></span><span> </span><span id="local-6989586621679114830"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114830"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679114829"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114829"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>  </span><span id="local-6989586621679114828"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114828"><span class="hs-identifier hs-var">state'</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
State h -&gt; StorableMonad h (State h)
</span><a href="RewindableIndex.Storable.html#flushBuffer"><span class="hs-identifier hs-var">flushBuffer</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114829"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span id="local-6989586621679114826"><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114826"><span class="hs-identifier hs-var">storage'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StorableEvent h -&gt; Storage h -&gt; StorableMonad h (Storage h)
forall h.
PrimMonad (StorableMonad h) =&gt;
StorableEvent h -&gt; Storage h -&gt; StorableMonad h (Storage h)
</span><a href="RewindableIndex.Storable.html#appendEvent"><span class="hs-identifier hs-var">appendEvent</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114830"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114828"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; StorableMonad h (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114828"><span class="hs-identifier hs-var">state'</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">_storage :: Storage h
</span><a href="RewindableIndex.Storable.html#_storage"><span class="hs-identifier hs-var">_storage</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114826"><span class="hs-identifier hs-var">storage'</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span id="local-6989586621679114977"><span class="annot"><a href="RewindableIndex.Storable.html#appendEvent"><span class="hs-identifier hs-type">appendEvent</span></a></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114977"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114977"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114977"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114977"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#Storage"><span class="hs-identifier hs-type">Storage</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114977"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-252"></span><span id="appendEvent"><span class="annot"><span class="annottext">appendEvent :: StorableEvent h -&gt; Storage h -&gt; StorableMonad h (Storage h)
</span><a href="RewindableIndex.Storable.html#appendEvent"><span class="hs-identifier hs-var hs-var">appendEvent</span></a></span></span><span> </span><span id="local-6989586621679114824"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114824"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621679114823"><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114823"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679114822"><span class="annot"><span class="annottext">cr :: Int
</span><a href="#local-6989586621679114822"><span class="hs-identifier hs-var hs-var">cr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114823"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h -&gt; Getting Int (Storage h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting Int (Storage h) Int
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; Int -&gt; StorableEvent h -&gt; StorableMonad h ()
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; Int -&gt; a -&gt; m ()
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">VM.write</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114823"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; Getting
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
     (Storage h)
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
  (Storage h)
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
forall h h.
Lens
  (Storage h)
  (Storage h)
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
</span><a href="RewindableIndex.Storable.html#events"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114822"><span class="hs-identifier hs-var">cr</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114824"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">Storage h -&gt; StorableMonad h (Storage h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; StorableMonad h (Storage h))
-&gt; Storage h -&gt; StorableMonad h (Storage h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h
</span><a href="#local-6989586621679114823"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Storage h -&gt; (Storage h -&gt; Storage h) -&gt; Storage h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Int) -&gt; Storage h -&gt; Storage h
forall s t a b. ASetter s t a b -&gt; (a -&gt; b) -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">%~</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span id="local-6989586621679114978"><span class="annot"><a href="RewindableIndex.Storable.html#flushBuffer"><span class="hs-identifier hs-type">flushBuffer</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114978"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114978"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114978"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114978"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114978"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-262"></span><span id="flushBuffer"><span class="annot"><span class="annottext">flushBuffer :: State h -&gt; StorableMonad h (State h)
</span><a href="RewindableIndex.Storable.html#flushBuffer"><span class="hs-identifier hs-var hs-var">flushBuffer</span></a></span></span><span> </span><span id="local-6989586621679114819"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114819"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679114818"><span class="annot"><span class="annottext">cr :: Int
</span><a href="#local-6989586621679114818"><span class="hs-identifier hs-var hs-var">cr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114819"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting Int (State h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Const Int (Storage h))
-&gt; State h -&gt; Const Int (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Const Int (Storage h))
 -&gt; State h -&gt; Const Int (State h))
-&gt; ((Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h))
-&gt; Getting Int (State h) Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span>
</span><span id="line-264"></span><span>      </span><span id="local-6989586621679114816"><span class="annot"><span class="annottext">es :: MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="#local-6989586621679114816"><span class="hs-identifier hs-var hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall h.
Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="RewindableIndex.Storable.html#getMemoryEvents"><span class="hs-identifier hs-var">getMemoryEvents</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h
 -&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h))
-&gt; Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114819"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span>
</span><span id="line-265"></span><span>      </span><span id="local-6989586621679114815"><span class="annot"><span class="annottext">mx :: Int
</span><a href="#local-6989586621679114815"><span class="hs-identifier hs-var hs-var">mx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114819"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting Int (State h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Config -&gt; Const Int Config) -&gt; State h -&gt; Const Int (State h)
forall h. Lens' (State h) Config
</span><a href="RewindableIndex.Storable.html#config"><span class="hs-identifier hs-var">config</span></a></span><span> </span><span class="annot"><span class="annottext">((Config -&gt; Const Int Config) -&gt; State h -&gt; Const Int (State h))
-&gt; ((Int -&gt; Const Int Int) -&gt; Config -&gt; Const Int Config)
-&gt; Getting Int (State h) Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; Config -&gt; Const Int Config
Iso' Config Int
</span><a href="RewindableIndex.Storable.html#memoryBufferSize"><span class="hs-identifier hs-var">memoryBufferSize</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114815"><span class="hs-identifier hs-var">mx</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114818"><span class="hs-identifier hs-var">cr</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621679114814"><span class="annot"><span class="annottext">Vector (StorableEvent h)
</span><a href="#local-6989586621679114814"><span class="hs-identifier hs-var">v</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; StorableMonad h (Vector (StorableEvent h))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="#local-6989586621679114816"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span id="local-6989586621679114813"><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679114813"><span class="hs-identifier hs-var">h'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Vector (StorableEvent h) -&gt; h -&gt; StorableMonad h h
forall h (f :: * -&gt; *).
(Buffered h, Foldable f) =&gt;
f (StorableEvent h) -&gt; h -&gt; StorableMonad h h
</span><a href="RewindableIndex.Storable.html#persistToStorage"><span class="hs-identifier hs-var">persistToStorage</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (StorableEvent h)
</span><a href="#local-6989586621679114814"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114819"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; StorableMonad h (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114819"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Identity (Storage h))
-&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Identity (Storage h))
 -&gt; State h -&gt; Identity (State h))
-&gt; ((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Identity Int)
-&gt; State h
-&gt; Identity (State h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; State h -&gt; Identity (State h))
-&gt; Int -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-271"></span><span>             </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(h -&gt; Identity h) -&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) h
</span><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">((h -&gt; Identity h) -&gt; State h -&gt; Identity (State h))
-&gt; h -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679114813"><span class="hs-identifier hs-var">h'</span></a></span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">State h -&gt; StorableMonad h (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114819"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span id="local-6989586621679114811"><span id="local-6989586621679114812"><span class="annot"><a href="RewindableIndex.Storable.html#insertMany"><span class="hs-identifier hs-type">insertMany</span></a></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Foldable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114812"><span class="hs-identifier hs-type">f</span></a></span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Buffered"><span class="hs-identifier hs-type">Buffered</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114811"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114811"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-278"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114812"><span class="hs-identifier hs-type">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114811"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114811"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114811"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114811"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-281"></span><span id="insertMany"><span class="annot"><span class="annottext">insertMany :: f (StorableEvent h) -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="RewindableIndex.Storable.html#insertMany"><span class="hs-identifier hs-var hs-var">insertMany</span></a></span></span><span> </span><span id="local-6989586621679114810"><span class="annot"><span class="annottext">f (StorableEvent h)
</span><a href="#local-6989586621679114810"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621679114809"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114809"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="annottext">(State h -&gt; StorableEvent h -&gt; StorableMonad h (State h))
-&gt; State h -&gt; f (StorableEvent h) -&gt; StorableMonad h (State h)
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">foldlM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679114808"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114808"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621679114807"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114807"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
forall h.
(Buffered h, PrimMonad (StorableMonad h)) =&gt;
StorableEvent h -&gt; State h -&gt; StorableMonad h (State h)
</span><a href="RewindableIndex.Storable.html#insert"><span class="hs-identifier hs-var">insert</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114807"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114808"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114809"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f (StorableEvent h)
</span><a href="#local-6989586621679114810"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span class="annot"><a href="RewindableIndex.Storable.html#rewind"><span class="hs-identifier hs-type">rewind</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679114806"><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-286"></span><span>     </span><span class="annot"><a href="RewindableIndex.Storable.html#Rewindable"><span class="hs-identifier hs-type">Rewindable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#HasPoint"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-288"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Eq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span id="rewind"><span class="annot"><span class="annottext">rewind :: StorablePoint h -&gt; State h -&gt; StorableMonad h (Maybe (State h))
</span><a href="RewindableIndex.Storable.html#rewind"><span class="hs-identifier hs-var hs-var">rewind</span></a></span></span><span> </span><span id="local-6989586621679114805"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114805"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621679114804"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114804"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-294"></span><span>  </span><span id="local-6989586621679114803"><span class="annot"><span class="annottext">Maybe (State h)
</span><a href="#local-6989586621679114803"><span class="hs-identifier hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StorableMonad h (Maybe (State h))
</span><a href="#local-6989586621679114802"><span class="hs-identifier hs-var">rewindMemory</span></a></span><span>
</span><span id="line-295"></span><span>  </span><span id="local-6989586621679114801"><span class="annot"><span class="annottext">Maybe h
</span><a href="#local-6989586621679114801"><span class="hs-identifier hs-var">h'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StorablePoint h -&gt; h -&gt; StorableMonad h (Maybe h)
forall h.
Rewindable h =&gt;
StorablePoint h -&gt; h -&gt; StorableMonad h (Maybe h)
</span><a href="RewindableIndex.Storable.html#rewindStorage"><span class="hs-identifier hs-var">rewindStorage</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114805"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114804"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-comment">-- The implementation here is a little non-trivial. If the rollback point is in memory</span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-comment">-- then we don't need to rewind the disk. If we need to rewind to some point stored</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-comment">-- on disk, then the memory needs to be reset.</span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><span class="annottext">Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State h) -&gt; StorableMonad h (Maybe (State h)))
-&gt; Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (State h)
</span><a href="#local-6989586621679114803"><span class="hs-identifier hs-var">m'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (State h) -&gt; Maybe (State h) -&gt; Maybe (State h)
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;|&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; h -&gt; State h
</span><a href="#local-6989586621679114800"><span class="hs-identifier hs-var">resetMemory</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114804"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">(h -&gt; State h) -&gt; Maybe h -&gt; Maybe (State h)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe h
</span><a href="#local-6989586621679114801"><span class="hs-identifier hs-var">h'</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><a href="#local-6989586621679114802"><span class="hs-identifier hs-type">rewindMemory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>    </span><span id="local-6989586621679114802"><span class="annot"><span class="annottext">rewindMemory :: StorableMonad h (Maybe (State h))
</span><a href="#local-6989586621679114802"><span class="hs-identifier hs-var hs-var">rewindMemory</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>      </span><span id="local-6989586621679114798"><span class="annot"><span class="annottext">Vector (StorableEvent h)
</span><a href="#local-6989586621679114798"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; StorableMonad h (Vector (StorableEvent h))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">(MVector (PrimState (StorableMonad h)) (StorableEvent h)
 -&gt; StorableMonad h (Vector (StorableEvent h)))
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; StorableMonad h (Vector (StorableEvent h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall s a. Int -&gt; Int -&gt; MVector s a -&gt; MVector s a
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">VM.slice</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114804"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting Int (State h) Int -&gt; Int
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Const Int (Storage h))
-&gt; State h -&gt; Const Int (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Const Int (Storage h))
 -&gt; State h -&gt; Const Int (State h))
-&gt; ((Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h))
-&gt; Getting Int (State h) Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Const Int Int) -&gt; Storage h -&gt; Const Int (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114804"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h
-&gt; Getting
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
     (State h)
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h
 -&gt; Const
      (MVector (PrimState (StorableMonad h)) (StorableEvent h))
      (Storage h))
-&gt; State h
-&gt; Const
     (MVector (PrimState (StorableMonad h)) (StorableEvent h)) (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h
  -&gt; Const
       (MVector (PrimState (StorableMonad h)) (StorableEvent h))
       (Storage h))
 -&gt; State h
 -&gt; Const
      (MVector (PrimState (StorableMonad h)) (StorableEvent h))
      (State h))
-&gt; ((MVector (PrimState (StorableMonad h)) (StorableEvent h)
     -&gt; Const
          (MVector (PrimState (StorableMonad h)) (StorableEvent h))
          (MVector (PrimState (StorableMonad h)) (StorableEvent h)))
    -&gt; Storage h
    -&gt; Const
         (MVector (PrimState (StorableMonad h)) (StorableEvent h))
         (Storage h))
-&gt; Getting
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
     (State h)
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(MVector (PrimState (StorableMonad h)) (StorableEvent h)
 -&gt; Const
      (MVector (PrimState (StorableMonad h)) (StorableEvent h))
      (MVector (PrimState (StorableMonad h)) (StorableEvent h)))
-&gt; Storage h
-&gt; Const
     (MVector (PrimState (StorableMonad h)) (StorableEvent h))
     (Storage h)
forall h h.
Lens
  (Storage h)
  (Storage h)
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
  (MVector (PrimState (StorableMonad h)) (StorableEvent h))
</span><a href="RewindableIndex.Storable.html#events"><span class="hs-identifier hs-var">events</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="annottext">Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (State h) -&gt; StorableMonad h (Maybe (State h)))
-&gt; Maybe (State h) -&gt; StorableMonad h (Maybe (State h))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-305"></span><span>        </span><span id="local-6989586621679114797"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114797"><span class="hs-identifier hs-var">ix</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(StorableEvent h -&gt; Bool) -&gt; Vector (StorableEvent h) -&gt; Maybe Int
forall (v :: * -&gt; *) a.
Vector v a =&gt;
(a -&gt; Bool) -&gt; v a -&gt; Maybe Int
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">VG.findIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679114795"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114795"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorableEvent h -&gt; StorablePoint h
forall e p. HasPoint e p =&gt; e -&gt; p
</span><a href="RewindableIndex.Storable.html#getPoint"><span class="hs-identifier hs-var">getPoint</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114795"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h -&gt; StorablePoint h -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114805"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Vector (StorableEvent h)
</span><a href="#local-6989586621679114798"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-306"></span><span>        </span><span class="annot"><span class="annottext">State h -&gt; Maybe (State h)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">(State h -&gt; Maybe (State h)) -&gt; State h -&gt; Maybe (State h)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114804"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Identity (Storage h))
-&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Identity (Storage h))
 -&gt; State h -&gt; Identity (State h))
-&gt; ((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Identity Int)
-&gt; State h
-&gt; Identity (State h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; State h -&gt; Identity (State h))
-&gt; Int -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621679114797"><span class="hs-identifier hs-var">ix</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><a href="#local-6989586621679114800"><span class="hs-identifier hs-type">resetMemory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114806"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-308"></span><span>    </span><span id="local-6989586621679114800"><span class="annot"><span class="annottext">resetMemory :: State h -&gt; h -&gt; State h
</span><a href="#local-6989586621679114800"><span class="hs-identifier hs-var hs-var">resetMemory</span></a></span></span><span> </span><span id="local-6989586621679114794"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114794"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span id="local-6989586621679114793"><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679114793"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>      </span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114794"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(h -&gt; Identity h) -&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) h
</span><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span>  </span><span class="annot"><span class="annottext">((h -&gt; Identity h) -&gt; State h -&gt; Identity (State h))
-&gt; h -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">h
</span><a href="#local-6989586621679114793"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-310"></span><span>         </span><span class="annot"><span class="annottext">State h -&gt; (State h -&gt; State h) -&gt; State h
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Storage h -&gt; Identity (Storage h))
-&gt; State h -&gt; Identity (State h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span> </span><span class="annot"><span class="annottext">((Storage h -&gt; Identity (Storage h))
 -&gt; State h -&gt; Identity (State h))
-&gt; ((Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h))
-&gt; (Int -&gt; Identity Int)
-&gt; State h
-&gt; Identity (State h)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Identity Int) -&gt; Storage h -&gt; Identity (Storage h)
forall h. Lens' (Storage h) Int
</span><a href="RewindableIndex.Storable.html#cursor"><span class="hs-identifier hs-var">cursor</span></a></span><span> </span><span class="annot"><span class="annottext">((Int -&gt; Identity Int) -&gt; State h -&gt; Identity (State h))
-&gt; Int -&gt; State h -&gt; State h
forall s t a b. ASetter s t a b -&gt; b -&gt; s -&gt; t
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">.~</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span id="local-6989586621679114792"><span class="annot"><a href="RewindableIndex.Storable.html#resume"><span class="hs-identifier hs-type">resume</span></a></span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Resumable"><span class="hs-identifier hs-type">Resumable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114792"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-314"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114792"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-315"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114792"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114792"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-316"></span><span id="resume"><span class="annot"><span class="annottext">resume :: State h -&gt; StorableMonad h [StorablePoint h]
</span><a href="RewindableIndex.Storable.html#resume"><span class="hs-identifier hs-var hs-var">resume</span></a></span></span><span> </span><span id="local-6989586621679114791"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114791"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">h -&gt; StorableMonad h [StorablePoint h]
forall h. Resumable h =&gt; h -&gt; StorableMonad h [StorablePoint h]
</span><a href="RewindableIndex.Storable.html#resumeFromStorage"><span class="hs-identifier hs-var">resumeFromStorage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114791"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>
</span><span id="line-318"></span><span class="hs-comment">{-
   This function is a bit non-trivial to think about. The question it is trying to
   answer is: Which events are valid for a given query interval.

   The answer is quite a bit more complicated than it seems at first sight. We would
   like to select the latest event within the interval and everything that goes
   before it (so we get a proper history). If we can't find any event less than the
   end, that means that the query interval has filtered all existing events.

   This functionality is important, because it should also be implemented at the
   database level to filter the on-disk events.
-}</span><span>
</span><span id="line-330"></span><span class="annot"><a href="RewindableIndex.Storable.html#filterWithQueryInterval"><span class="hs-identifier hs-type">filterWithQueryInterval</span></a></span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679114916"><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-332"></span><span>     </span><span class="annot"><a href="RewindableIndex.Storable.html#HasPoint"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#QueryInterval"><span class="hs-identifier hs-type">QueryInterval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-335"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-337"></span><span id="filterWithQueryInterval"><span class="annot"><span class="annottext">filterWithQueryInterval :: QueryInterval (StorablePoint h)
-&gt; [StorableEvent h] -&gt; [StorableEvent h]
</span><a href="RewindableIndex.Storable.html#filterWithQueryInterval"><span class="hs-identifier hs-var hs-var">filterWithQueryInterval</span></a></span></span><span> </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint h)
</span><a href="RewindableIndex.Storable.html#QEverything"><span class="hs-identifier hs-var">QEverything</span></a></span><span> </span><span id="local-6989586621679114790"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114790"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114790"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-338"></span><span class="annot"><a href="RewindableIndex.Storable.html#filterWithQueryInterval"><span class="hs-identifier hs-var">filterWithQueryInterval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#QInterval"><span class="hs-identifier hs-type">QInterval</span></a></span><span> </span><span id="local-6989586621679114789"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114789"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span id="local-6989586621679114788"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114788"><span class="hs-identifier hs-var">end</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679114787"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114787"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-339"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679114786"><span class="annot"><span class="annottext">es' :: [StorableEvent h]
</span><a href="#local-6989586621679114786"><span class="hs-identifier hs-var hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StorableEvent h -&gt; Bool) -&gt; [StorableEvent h] -&gt; [StorableEvent h]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">takeWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StorablePoint h -&gt; Bool) -&gt; StorableEvent h -&gt; Bool
</span><a href="#local-6989586621679114784"><span class="hs-identifier hs-var">withPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679114783"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114783"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114783"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h -&gt; StorablePoint h -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114788"><span class="hs-identifier hs-var">end</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114787"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-340"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[StorableEvent h] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114786"><span class="hs-identifier hs-var">es'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(StorablePoint h -&gt; Bool) -&gt; StorableEvent h -&gt; Bool
</span><a href="#local-6989586621679114784"><span class="hs-identifier hs-var">withPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679114778"><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114778"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114778"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h -&gt; StorablePoint h -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114789"><span class="hs-identifier hs-var">start</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[StorableEvent h] -&gt; StorableEvent h
forall a. [a] -&gt; a
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-identifier hs-var">last</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114786"><span class="hs-identifier hs-var">es'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-341"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114786"><span class="hs-identifier hs-var">es'</span></a></span><span>
</span><span id="line-342"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><a href="#local-6989586621679114784"><span class="hs-identifier hs-type">withPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114916"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-345"></span><span>    </span><span id="local-6989586621679114784"><span class="annot"><span class="annottext">withPoint :: (StorablePoint h -&gt; Bool) -&gt; StorableEvent h -&gt; Bool
</span><a href="#local-6989586621679114784"><span class="hs-identifier hs-var hs-var">withPoint</span></a></span></span><span> </span><span id="local-6989586621679114776"><span class="annot"><span class="annottext">StorablePoint h -&gt; Bool
</span><a href="#local-6989586621679114776"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621679114775"><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114775"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679114774"><span class="annot"><span class="annottext">p :: StorablePoint h
</span><a href="#local-6989586621679114774"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StorableEvent h -&gt; StorablePoint h
forall e p. HasPoint e p =&gt; e -&gt; p
</span><a href="RewindableIndex.Storable.html#getPoint"><span class="hs-identifier hs-var">getPoint</span></a></span><span> </span><span class="annot"><span class="annottext">StorableEvent h
</span><a href="#local-6989586621679114775"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">StorablePoint h -&gt; Bool
</span><a href="#local-6989586621679114776"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">StorablePoint h
</span><a href="#local-6989586621679114774"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span id="local-6989586621679114773"><span class="annot"><a href="RewindableIndex.Storable.html#query"><span class="hs-identifier hs-type">query</span></a></span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#HasPoint"><span class="hs-identifier hs-type">HasPoint</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableEvent"><span class="hs-identifier hs-type">StorableEvent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/ghc-prim-0.6.1/src"><span class="hs-identifier hs-type">Ord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#Queryable"><span class="hs-identifier hs-type">Queryable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="../file:///nix/store/qgn7wh2y0g1f8xcr4mah2szbmyw29mwk-primitive-lib-primitive-0.7.4.0-haddock-doc/share/doc/primitive/html/src"><span class="hs-identifier hs-type">PrimMonad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#QueryInterval"><span class="hs-identifier hs-type">QueryInterval</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorablePoint"><span class="hs-identifier hs-type">StorablePoint</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#State"><span class="hs-identifier hs-type">State</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-354"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableQuery"><span class="hs-identifier hs-type">StorableQuery</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span>
</span><span id="line-355"></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="RewindableIndex.Storable.html#StorableMonad"><span class="hs-identifier hs-type">StorableMonad</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="RewindableIndex.Storable.html#StorableResult"><span class="hs-identifier hs-type">StorableResult</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679114773"><span class="hs-identifier hs-type">h</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-356"></span><span id="query"><span class="annot"><span class="annottext">query :: QueryInterval (StorablePoint h)
-&gt; State h -&gt; StorableQuery h -&gt; StorableMonad h (StorableResult h)
</span><a href="RewindableIndex.Storable.html#query"><span class="hs-identifier hs-var hs-var">query</span></a></span></span><span> </span><span id="local-6989586621679114772"><span class="annot"><span class="annottext">QueryInterval (StorablePoint h)
</span><a href="#local-6989586621679114772"><span class="hs-identifier hs-var">qi</span></a></span></span><span> </span><span id="local-6989586621679114771"><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114771"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621679114770"><span class="annot"><span class="annottext">StorableQuery h
</span><a href="#local-6989586621679114770"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>  </span><span id="local-6989586621679114769"><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114769"><span class="hs-identifier hs-var">es</span></a></span></span><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
forall h.
Storage h
-&gt; MVector (PrimState (StorableMonad h)) (StorableEvent h)
</span><a href="RewindableIndex.Storable.html#getMemoryEvents"><span class="hs-identifier hs-var">getMemoryEvents</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114771"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting (Storage h) (State h) (Storage h) -&gt; Storage h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting (Storage h) (State h) (Storage h)
forall h. Lens' (State h) (Storage h)
</span><a href="RewindableIndex.Storable.html#storage"><span class="hs-identifier hs-var">storage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; (MVector (PrimState (StorableMonad h)) (StorableEvent h)
    -&gt; StorableMonad h (Vector (StorableEvent h)))
-&gt; StorableMonad h (Vector (StorableEvent h))
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">MVector (PrimState (StorableMonad h)) (StorableEvent h)
-&gt; StorableMonad h (Vector (StorableEvent h))
forall (m :: * -&gt; *) a.
PrimMonad m =&gt;
MVector (PrimState m) a -&gt; m (Vector a)
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">V.freeze</span></a></span><span> </span><span class="annot"><span class="annottext">StorableMonad h (Vector (StorableEvent h))
-&gt; (Vector (StorableEvent h) -&gt; [StorableEvent h])
-&gt; StorableMonad h [StorableEvent h]
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; (a -&gt; b) -&gt; f b
</span><a href="../file:///nix/store/sc7phsrhp1xzn7n38mdjvapkbif3753i-ghc-8.10.7-doc/share/doc/ghc/html/libraries/base-4.14.3.0/src"><span class="hs-operator hs-var">&lt;&amp;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Vector (StorableEvent h) -&gt; [StorableEvent h]
forall a. Vector a -&gt; [a]
</span><a href="../file:///nix/store/aivw0rvzpz665gw9019zpvi6d4mxbdfi-vector-lib-vector-0.12.3.1-haddock-doc/share/doc/vector/html/src"><span class="hs-identifier hs-var">V.toList</span></a></span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint h)
-&gt; [StorableEvent h]
-&gt; h
-&gt; StorableQuery h
-&gt; StorableMonad h (StorableResult h)
forall h (f :: * -&gt; *).
(Queryable h, Foldable f) =&gt;
QueryInterval (StorablePoint h)
-&gt; f (StorableEvent h)
-&gt; h
-&gt; StorableQuery h
-&gt; StorableMonad h (StorableResult h)
</span><a href="RewindableIndex.Storable.html#queryStorage"><span class="hs-identifier hs-var">queryStorage</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint h)
</span><a href="#local-6989586621679114772"><span class="hs-identifier hs-var">qi</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QueryInterval (StorablePoint h)
-&gt; [StorableEvent h] -&gt; [StorableEvent h]
forall h.
(HasPoint (StorableEvent h) (StorablePoint h),
 Ord (StorablePoint h)) =&gt;
QueryInterval (StorablePoint h)
-&gt; [StorableEvent h] -&gt; [StorableEvent h]
</span><a href="RewindableIndex.Storable.html#filterWithQueryInterval"><span class="hs-identifier hs-var">filterWithQueryInterval</span></a></span><span> </span><span class="annot"><span class="annottext">QueryInterval (StorablePoint h)
</span><a href="#local-6989586621679114772"><span class="hs-identifier hs-var">qi</span></a></span><span> </span><span class="annot"><span class="annottext">[StorableEvent h]
</span><a href="#local-6989586621679114769"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">State h
</span><a href="#local-6989586621679114771"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">State h -&gt; Getting h (State h) h -&gt; h
forall s a. s -&gt; Getting a s a -&gt; a
</span><a href="../file:///nix/store/lwkxqy8dgzjvz62gfx89dnvl9mm03scy-lens-lib-lens-4.19.2-haddock-doc/share/doc/lens/html/src"><span class="hs-operator hs-var">^.</span></a></span><span> </span><span class="annot"><span class="annottext">Getting h (State h) h
forall h. Lens' (State h) h
</span><a href="RewindableIndex.Storable.html#handle"><span class="hs-identifier hs-var">handle</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StorableQuery h
</span><a href="#local-6989586621679114770"><span class="hs-identifier hs-var">q</span></a></span><span>
</span><span id="line-359"></span></pre></body></html>
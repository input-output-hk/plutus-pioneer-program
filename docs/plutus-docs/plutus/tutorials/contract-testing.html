<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property-based testing of Plutus contracts &mdash; Plutus Tools SDK User Guide 1.0.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Testing Plutus Contracts with Contract Models" href="contract-models.html" />
    <link rel="prev" title="Extending the basic Plutus app with the constraints API" href="basic-apps-constraints.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #fcfcfc" >
            <a href="../../index.html" class="icon icon-home"> Plutus Tools SDK User Guide
            <img src="../../_static/cardano-logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Explore Plutus</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../explanations/index.html">Explanations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html">Plutus tools in development</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#logical-components">Logical components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#marconi">1. Marconi</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#plutus-use-case-examples">2. Plutus use case examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#pab-plutus-application-backend">3. PAB (Plutus application backend)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#contract-monad-emulator">4. Contract monad emulator</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#plutus-contract-model-testing">5. Plutus contract model testing</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#plutus-contract-state-machine">6. Plutus contract state machine</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#contract-api-also-known-as-contract-monad">7. Contract API (also known as Contract monad)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#plutus-chain-index">8. Plutus chain index</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#plutus-ledger-constraints">9. Plutus ledger constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#plutus-tx-constraints">10. Plutus Tx constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#id10">11. Plutus ledger</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/plutus-tools-component-descriptions.html#plutus-script-utils">12. Plutus script utils</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/rollback.html">What is a rollback?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../explanations/rollback.html#what-does-this-mean-for-dapps">What does this mean for dapps?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/pab.html">What is the PAB?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../explanations/pab.html#client-interface">Client interface</a></li>
<li class="toctree-l3"><a class="reference internal" href="../explanations/pab.html#other-components">Other components</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../explanations/pab.html#chain-index">Chain index</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/pab.html#alonzo-node">Alonzo node</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/pab.html#wallet">Wallet</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../explanations/pab.html#deployment-scenarios">Deployment Scenarios</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../explanations/pab.html#hosted">Hosted</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/pab.html#in-browser">In-browser</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../explanations/order-book-pattern.html">What is the order book pattern?</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../explanations/order-book-pattern.html#example-distributed-exchange">Example: Distributed exchange</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../explanations/order-book-pattern.html#orders-and-plutus-scripts">Orders and Plutus scripts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/order-book-pattern.html#decentralisation">Decentralisation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../explanations/order-book-pattern.html#generalising-the-pattern">Generalising the pattern</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../explanations/order-book-pattern.html#off-chain-oracles">Off-chain oracles</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/order-book-pattern.html#on-chain-oracles">On-chain oracles</a></li>
<li class="toctree-l4"><a class="reference internal" href="../explanations/order-book-pattern.html#state-machines">State machines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../explanations/order-book-pattern.html#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic-apps.html">Writing a basic Plutus app in an emulated environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="basic-apps.html#defining-the-types">Defining the types</a><ul>
<li class="toctree-l4"><a class="reference internal" href="basic-apps.html#instances-for-data-types">Instances for data types</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="basic-apps.html#defining-the-validator-script">Defining the validator script</a></li>
<li class="toctree-l3"><a class="reference internal" href="basic-apps.html#asking-for-input">Asking for input</a></li>
<li class="toctree-l3"><a class="reference internal" href="basic-apps.html#locking-the-funds">Locking the funds</a></li>
<li class="toctree-l3"><a class="reference internal" href="basic-apps.html#unlocking-the-funds">Unlocking the funds</a></li>
<li class="toctree-l3"><a class="reference internal" href="basic-apps.html#running-the-app-on-the-plutus-apps-emulator">Running the app on the Plutus apps emulator</a></li>
<li class="toctree-l3"><a class="reference internal" href="basic-apps.html#exercise">Exercise</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="basic-apps-constraints.html">Extending the basic Plutus app with the constraints API</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Property-based testing of Plutus contracts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#an-overview-of-the-guessing-game">An overview of the guessing game</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#emulated-wallets">Emulated wallets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#values-and-tokens">Values and <span class="xref std std-term">tokens</span></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#introducing-contract-models">Introducing contract models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generating-actions">Generating actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modelling-expectations">Modelling expectations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#restricting-test-cases-with-preconditions">Restricting test cases with preconditions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performing-actions">Performing actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#shrinking-actions">Shrinking Actions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#debugging-the-model">Debugging the model</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#adding-delays-to-test-cases">Adding delays to test cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rerunning-a-failed-test">Rerunning a failed test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#controlling-the-log-level">Controlling the log-level</a></li>
<li class="toctree-l4"><a class="reference internal" href="#refining-preconditions">Refining preconditions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#measuring-and-tuning-distributions">Measuring and tuning distributions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#custom-generators-vs-preconditions">Custom generators vs preconditions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#instrumenting-contract-models-to-gather-statistics">Instrumenting contract models to gather statistics</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#goal-directed-testing-with-dynamic-logic">Goal-directed testing with dynamic logic</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#introducing-the-dynamic-logic-monad">Introducing the dynamic logic monad</a></li>
<li class="toctree-l4"><a class="reference internal" href="#quantifiers-in-dynamic-logic">Quantifiers in dynamic logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="#repeating-a-dynamic-logic-test">Repeating a dynamic logic test</a></li>
<li class="toctree-l4"><a class="reference internal" href="#something-good-is-always-possible">Something good is always possible</a></li>
<li class="toctree-l4"><a class="reference internal" href="#monitoring-and-tuning-dynamic-logic-tests">Monitoring and tuning dynamic logic tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#more-dynamic-logic">More dynamic logic</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#limitations">Limitations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#testing-only-via-contract-endpoints">Testing only via <span class="xref std std-term">contract endpoints</span></a></li>
<li class="toctree-l4"><a class="reference internal" href="#test-assumptions-on-timing">Test assumptions on timing</a></li>
<li class="toctree-l4"><a class="reference internal" href="#testing-for-information-leaks">Testing for information leaks</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#further-examples">Further Examples</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="contract-models.html">Testing Plutus Contracts with Contract Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#basic-contract-models">Basic Contract Models</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#example-a-simple-escrow-contract">Example: A Simple Escrow Contract</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#the-contract-model-type">The Contract Model Type</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#what-contracts-shall-we-test">What contracts shall we test?</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#what-actions-should-tests-perform">What actions should tests perform?</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#generating-actions">Generating Actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#running-tests-and-debugging-the-model">Running tests and debugging the model</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#analysing-the-distribution-of-tests">Analysing the distribution of tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#exercises">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#parameterising-models-and-dynamic-contract-instances">Parameterising Models and Dynamic Contract Instances</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#adding-an-initial-action-and-test-case-phases">Adding an initial action, and test case phases</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#dynamic-contract-instances">Dynamic contract instances</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#running-our-extended-tests-another-design-issue">Running our extended tests; another design issue</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#id3">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#testing-no-locked-funds-with-dynamic-logic">Testing “No Locked Funds” with Dynamic Logic</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#writing-and-testing-properties-using-dynamic-logic">Writing and testing properties using Dynamic Logic</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#digression-revisiting-a-design-decision">Digression: revisiting a design decision</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#fair-s-fair-unilateral-strategies">Fair’s fair: Unilateral strategies</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#fixing-the-contract-refunds">Fixing the contract: refunds</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#id4">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#taking-time-into-account">Taking Time into Account</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#slots-and-posixtime">Slots and POSIXTime</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#initialising-the-deadline">Initialising the deadline</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#modelling-the-passage-of-time">Modelling the passage of time</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#monitoring-and-the-distribution-of-tests">Monitoring and the distribution of tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#no-locked-funds">No locked funds?</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#digression-testing-the-model-alone-for-speed">Digression: testing the model alone for speed</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#id5">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#measuring-coverage-of-on-chain-code">Measuring coverage of on-chain code</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#adding-a-coverage-index">Adding a coverage index</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#measuring-coverage">Measuring coverage</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#interpreting-the-coverage-annotations">Interpreting the coverage annotations</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#the-generated-coverage-report">The generated coverage report</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#crashes-and-how-to-tolerate-them">Crashes, and how to tolerate them</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#id6">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#debugging-the-auction-contract-with-model-assertions">Debugging the Auction contract with model assertions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#modelling-the-auction-contract">Modelling the Auction contract</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#id7">No locked funds?</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#model-assertions-and-unexpected-expectations">Model assertions, and unexpected expectations.</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#crashing-the-auction">Crashing the auction</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#coverage-of-the-auction-contract">Coverage of the Auction contract</a></li>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#id8">Exercises</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="contract-models.html#becoming-level-1-certification-ready">Becoming Level 1 Certification Ready</a><ul>
<li class="toctree-l4"><a class="reference internal" href="contract-models.html#id9">Exercises</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../howtos/index.html">How-to guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../howtos/getting-started.html">How to get started with the Plutus Platform</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howtos/getting-started.html#further-reading">Further reading</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howtos/writing-a-scalable-app.html">How to write a scalable Plutus app</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#the-building-blocks">The building blocks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#transaction-outputs">Transaction outputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#state-of-transaction-outputs">State of transaction outputs</a></li>
<li class="toctree-l4"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#changing-the-state-of-our-app">Changing the state of our app</a></li>
<li class="toctree-l4"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#minting-policy-scripts">Minting Policy Scripts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#scalability-guidelines">Scalability guidelines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#examples">Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#decentralised-exchange">Decentralised exchange</a></li>
<li class="toctree-l4"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#marlowe">Marlowe</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../howtos/writing-a-scalable-app.html#summary">Summary</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howtos/handling-blockchain-events.html">How to handle blockchain events</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howtos/handling-blockchain-events.html#transaction-output-lifecycle">Transaction output lifecycle</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../howtos/handling-blockchain-events.html#transaction-states">Transaction states</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../howtos/handling-blockchain-events.html#pab-functions-for-listening-to-state-changes">PAB functions for listening to state changes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howtos/analysing-scripts.html">How to analyse the cost and size of Plutus scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howtos/analysing-scripts.html#resource-use-of-plutus-scripts">Resource use of Plutus scripts</a></li>
<li class="toctree-l3"><a class="reference internal" href="../howtos/analysing-scripts.html#examples">Examples</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../howtos/analysing-scripts.html#validator-scripts">Validator scripts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../howtos/analysing-scripts.html#partial-transactions">Partial transactions</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../howtos/plutus-spending-script-example.html">Plutus Scripts</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../howtos/plutus-spending-script-example.html#what-is-a-plutus-spending-script">What is a Plutus spending script?</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../howtos/plutus-spending-script-example.html#an-example-of-using-a-plutus-spending-script">An example of using a Plutus spending script</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../troubleshooting.html">Troubleshooting</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../troubleshooting.html#error-codes">Error codes</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Architectural decision records</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../adr/index.html">Architectural Decision Records</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0001-record-architecture-decisions.html">ADR 1: Record architectural decisions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0001-record-architecture-decisions.html#authors">Authors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0001-record-architecture-decisions.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0001-record-architecture-decisions.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0001-record-architecture-decisions.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0001-record-architecture-decisions.html#implications">Implications</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0001-record-architecture-decisions.html#adr-template">ADR template</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0002-repository-standardization.html">ADR 2: Repository Standardization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0002-repository-standardization.html#authors">Authors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0002-repository-standardization.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0002-repository-standardization.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0002-repository-standardization.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0002-repository-standardization.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0002-repository-standardization.html#implications">Implications</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0003-marconi-monorepo.html">ADR 3: Move Marconi into a separate repository</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0003-marconi-monorepo.html#authors">Authors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0003-marconi-monorepo.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0003-marconi-monorepo.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0003-marconi-monorepo.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0003-marconi-monorepo.html#implications">Implications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0003-marconi-monorepo.html#related-decisions">Related Decisions</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0004-marconi-initiative.html">ADR 4: Making a case for Marconi</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#design-principles-of-marconi">Design principles of Marconi</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#indexing-solution">Indexing solution</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#query-and-storage">Query and storage</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#identification-of-events">Identification of events</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0004-marconi-initiative.html#event-streams">Event streams</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html">ADR 5: PAB and indexing component integration</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#decisions">Decisions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#alternative-solutions">Alternative solutions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#make-sure-all-components-are-in-sync">Make sure all components are in sync</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#add-indexing-specific-functions-in-the-contract-api">Add indexing specific functions in the Contract API</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#query-functions-should-interact-with-a-single-source-of-truth">Query functions should interact with a single source of truth</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#implications">Implications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0005-pab-indexing-solution-integration.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0006-common-contract-api.html">ADR 6: Common Contract API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0006-common-contract-api.html#authors">Authors</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0006-common-contract-api.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0006-common-contract-api.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0006-common-contract-api.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0006-common-contract-api.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0006-common-contract-api.html#implications">Implications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0006-common-contract-api.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0007-support-reference-inputs-in-constraint-library.html">ADR 7: Support reference inputs in constraint library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0007-support-reference-inputs-in-constraint-library.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0007-support-reference-inputs-in-constraint-library.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0007-support-reference-inputs-in-constraint-library.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0007-support-reference-inputs-in-constraint-library.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0007-support-reference-inputs-in-constraint-library.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0007-support-reference-inputs-in-constraint-library.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0008-support-inline-datums-in-constraint-library.html">ADR 8: Support inline datums in constraint library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0008-support-inline-datums-in-constraint-library.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0008-support-inline-datums-in-constraint-library.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0008-support-inline-datums-in-constraint-library.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0008-support-inline-datums-in-constraint-library.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0008-support-inline-datums-in-constraint-library.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0008-support-inline-datums-in-constraint-library.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0009-support-reference-scripts-in-constraint-library.html">ADR 9: Support reference scripts in constraint library</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0009-support-reference-scripts-in-constraint-library.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0009-support-reference-scripts-in-constraint-library.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0009-support-reference-scripts-in-constraint-library.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0009-support-reference-scripts-in-constraint-library.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0009-support-reference-scripts-in-constraint-library.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0009-support-reference-scripts-in-constraint-library.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html">ADR 10: Rolling back on-disk data for Marconi indexers</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#decision">Decision</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#events">Events</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#queries">Queries</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#api-design">API Design</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0010-marconi-indexer-rollbacks.html#implementation">Implementation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html">ADR 11: Support return and total collateral when building transactions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html#alternatives">Alternatives</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0011-support-return-and-total-collateral-when-building-transactions.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html">ADR 12: Commit to data types in cardano-api</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#alternatives">Alternatives</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#define-our-own-data-types-for-off-chain-use">Define our own data types for off-chain use</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#implications">Implications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0012-commit-to-data-types-in-cardano-api.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html">ADR 13: Transaction validity time range fix</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#implications">Implications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#alternatives">Alternatives</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#add-mustvalidateinslotrange-constraint">Add <code class="docutils literal notranslate"><span class="pre">MustValidateInSlotRange</span></code> constraint</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#remove-mustvalidateintimerange">Remove <code class="docutils literal notranslate"><span class="pre">mustValidateInTimeRange</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#alter-mustvalidateintimerange">Alter <code class="docutils literal notranslate"><span class="pre">mustValidateInTimeRange</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0013-tx-validity-time-range-fix.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0014-marconi-query-interface.html">ADR 14: Marconi Query Interface</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0014-marconi-query-interface.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0014-marconi-query-interface.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0014-marconi-query-interface.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0014-marconi-query-interface.html#decision">Decision</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0014-marconi-query-interface.html#implications">Implications</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0015-time-conversion.html">ADR 15: Time conversion semantic change</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#implications">Implications</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#alternatives">Alternatives</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0015-time-conversion.html#changing-the-representation-of-slotconfig-to-the-correct-one">Changing the representation of <code class="docutils literal notranslate"><span class="pre">SlotConfig</span></code> to the correct one</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0015-time-conversion.html#directly-use-epochinfo-in-the-emulator-and-contract-api">Directly use EpochInfo in the emulator and Contract API</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0015-time-conversion.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0016-cardano-node-emulator.html">ADR 16: Self-contained cardano-node emulator component</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0016-cardano-node-emulator.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0016-cardano-node-emulator.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0016-cardano-node-emulator.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0016-cardano-node-emulator.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0016-cardano-node-emulator.html#argument">Argument</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0016-cardano-node-emulator.html#notes">Notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html">ADR 17: End-to-end testing strategy for Plutus, cardano-ledger-api and cardano-node-client</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#author-s">Author(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#status">Status</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#context">Context</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#decision">Decision</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#types-of-plutus-tests-for-the-plutus-e2e-tests-haskell-framework">Types of Plutus tests for the <code class="docutils literal notranslate"><span class="pre">plutus-e2e-tests</span></code> Haskell framework</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#argument">Argument</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#pros-of-building-and-maintaining-our-own-test-framework">Pros of building and maintaining our own test framework</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#cons-of-building-and-maintaining-our-own-test-framework">Cons of building and maintaining our own test framework</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#additional-considerations">Additional Considerations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#alternatives">Alternatives</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#notes">Notes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../adr/0017-end-to-end-testing-strategy.html#other-places-spinning-up-a-local-testnet">Other places spinning up a local testnet</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../reference/index.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/examples.html">Examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/cost-model-parameters.html">Cost model parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/glossary.html">Glossary</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/bibliography.html">Bibliography</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/index.html#elsewhere">Elsewhere</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #fcfcfc" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Plutus Tools SDK User Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="index.html">Tutorials</a> &raquo;</li>
      <li>Property-based testing of Plutus contracts</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/input-output-hk/plutus/blob/master/doc/plutus/tutorials/contract-testing.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="property-based-testing-of-plutus-contracts">
<span id="contract-testing-tutorial"></span><h1>Property-based testing of Plutus contracts<a class="headerlink" href="#property-based-testing-of-plutus-contracts" title="Permalink to this heading"></a></h1>
<p>Plutus comes with a library for testing contracts using
QuickCheck. Tests generated by this library perform a sequence of
calls to <a class="reference internal" href="../../reference/glossary.html#term-contract-endpoint"><span class="xref std std-term">contract endpoints</span></a>, checking that <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a> end up in the
correct wallets at the end of each test. These sequences can be
generated at random, or in a more directed way to check that desirable
states always remain reachable. This tutorial introduces the testing
library by walking through a simple example: a contract that
implements a guessing game.</p>
<section id="an-overview-of-the-guessing-game">
<h2>An overview of the guessing game<a class="headerlink" href="#an-overview-of-the-guessing-game" title="Permalink to this heading"></a></h2>
<p>The source code of the guessing game contract is provided as an
example <a class="reference external" href="https://github.com/input-output-hk/plutus-apps/blob/master/plutus-use-cases/src/Plutus/Contracts/GameStateMachine.hs">here</a>, and the <a class="reference external" href="https://github.com/input-output-hk/plutus-apps/blob/master/plutus-use-cases/test/Spec/GameStateMachine.hs">final test code is here</a>.</p>
<p>The game is played as follows:</p>
<blockquote>
<div><ul class="simple">
<li><p>The first player locks a sum of Ada in the contract, which is
donated as a prize. The prize is protected by a secret password.</p></li>
<li><p>Any player can now try to guess the password, by submitting a
‘guess’ transaction that attempts to withdraw some or all of the
prize, along with a guess at the password, and a new password to
replace the old one. If the guess is correct, and the contract
contains enough Ada, then the guesser receives the withdrawal and
the remainder of the prize is now protected by the new password. If
the guess is wrong, the transaction is not accepted, and nothing
changes.</p></li>
</ul>
</div></blockquote>
<p>As an extra wrinkle, when the first player locks the prize, a new
<a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> is also minted. Only the player currently holding the <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> is
allowed to make a guess–which gives us an opportunity to illustrate
minting and passing around <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a>.</p>
<p>The generated tests will exercise the contract by locking the prize,
then moving the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> and making guesses at random, checking that
the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> and Ada move as they should.</p>
<section id="emulated-wallets">
<h3>Emulated wallets<a class="headerlink" href="#emulated-wallets" title="Permalink to this heading"></a></h3>
<p>To test contracts, we need emulated wallets. These and many other
useful definitions for testing can be imported via</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Plutus.Contract.Test</span><span class="w"> </span><span class="p">(</span><span class="kt">Wallet</span><span class="p">,</span><span class="w"> </span><span class="nf">minLogLevel</span><span class="p">,</span><span class="w"> </span><span class="nf">mockWalletAddress</span><span class="p">,</span><span class="w"> </span><span class="nf">w1</span><span class="p">,</span><span class="w"> </span><span class="nf">w2</span><span class="p">,</span><span class="w"> </span><span class="nf">w3</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>Now we can create a number of wallets: in this
tutorial, we’ll settle for three:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">wallets</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">[</span><span class="kt">Wallet</span><span class="p">]</span><span class="w"></span>
<span class="nf">wallets</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">w1</span><span class="p">,</span><span class="w"> </span><span class="n">w2</span><span class="p">,</span><span class="w"> </span><span class="n">w3</span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="values-and-tokens">
<h3>Values and <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a><a class="headerlink" href="#values-and-tokens" title="Permalink to this heading"></a></h3>
<p>Wallets contain ‘values’, which are mixtures of different quantities
of one or more types of <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>. The most common <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> is, of course, the Ada;
we can import functions manipulating Ada, and the <code class="docutils literal notranslate"><span class="pre">Value</span></code> type
itself, as follows:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Ledger.Ada</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">Ada</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Ledger.Address</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">Address</span><span class="w"></span>
<span class="kr">import</span><span class="w"> </span><span class="nn">Ledger.Value</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">Value</span><span class="w"></span>
</pre></div>
</div>
<p>With these imports, we can construct values in the Ada <a class="reference internal" href="../../reference/glossary.html#term-currency"><span class="xref std std-term">currency</span></a>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; Ada.lovelaceValueOf 1
Value (Map [(,Map [(,1)])])
</pre></div>
</div>
<p>We will also need a game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>. After importing the <code class="docutils literal notranslate"><span class="pre">Scripts</span></code> module</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Ledger.Typed.Scripts</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">Scripts</span><span class="w"></span>
</pre></div>
</div>
<p>we can define it as follows, applying a minting policy defined in the code under test (imported as module <code class="docutils literal notranslate"><span class="pre">G</span></code>):</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Plutus.Contracts.GameStateMachine</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">G</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Cardano.Node.Emulator.TimeSlot</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">TimeSlot</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Data.Default</span><span class="w"> </span><span class="p">(</span><span class="kt">Default</span><span class="w"> </span><span class="p">(</span><span class="nf">def</span><span class="p">))</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">gameParam</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameParam</span><span class="w"></span>
<span class="nf">gameParam</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameParam</span><span class="w"> </span><span class="p">(</span><span class="kt">Address</span><span class="o">.</span><span class="n">toPlutusAddress</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">mockWalletAddress</span><span class="w"> </span><span class="n">w1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">TimeSlot</span><span class="o">.</span><span class="n">scSlotZeroTime</span><span class="w"> </span><span class="n">def</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">guessTokenVal</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Value</span><span class="o">.</span><span class="kt">Value</span><span class="w"></span>
<span class="nf">guessTokenVal</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">    </span><span class="kr">let</span><span class="w"> </span><span class="n">sym</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Scripts</span><span class="o">.</span><span class="n">forwardingMintingPolicyHash</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">typedValidator</span><span class="w"> </span><span class="n">gameParam</span><span class="w"></span>
<span class="w">    </span><span class="kr">in</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">token</span><span class="w"> </span><span class="n">sym</span><span class="w"> </span><span class="s">&quot;guess&quot;</span><span class="w"></span>
</pre></div>
</div>
<p>The value of the <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> is (with long hash values abbreviated):</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; guessTokenVal
Value (Map [(f687...,Map [(guess,1)])])
</pre></div>
</div>
<p>We can even construct a <code class="docutils literal notranslate"><span class="pre">Value</span></code> containing an Ada and a game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; Ada.lovelaceValueOf 1 &lt;&gt; guessTokenVal
Value (Map [(,Map [(,1)]),(f687...,Map [(guess,1)])])
</pre></div>
</div>
<p>If you inspect the output closely, you will see that a <code class="docutils literal notranslate"><span class="pre">Value</span></code>
contains maps nested within another <code class="docutils literal notranslate"><span class="pre">Map</span></code>. The outer <code class="docutils literal notranslate"><span class="pre">Map</span></code> is
indexed by hashes of minting policy <a class="reference internal" href="../../reference/glossary.html#term-script"><span class="xref std std-term">scripts</span></a>, so each inner <code class="docutils literal notranslate"><span class="pre">Map</span></code>
contains a bag of <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a> managed by the same policy. <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">Token</span></a> names can
be chosen freely, and each policy can manage any number of its own
<a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> types. In this case the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> is called a “guess”, and the
<a class="reference internal" href="../../reference/glossary.html#term-script"><span class="xref std std-term">script</span></a> managing game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a> has the hash f687… A little confusingly,
the Ada <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> name is displayed as an empty string, as is the hash of
the corresponding minting policy.</p>
</section>
</section>
<section id="introducing-contract-models">
<h2>Introducing contract models<a class="headerlink" href="#introducing-contract-models" title="Permalink to this heading"></a></h2>
<p>We test contracts using a <em>model</em> of the system, which includes the
state(s) of all the agents involved–the on-chain state, the off-chain
state on your computer, the off-chain state on anyone else’s
computer–everything relevant to the contract(s) under test. The first
job to be done is thus defining that model. To do so, we import the
contract modelling library</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Plutus.Contract.Test.ContractModel</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">CM</span><span class="w"></span>
</pre></div>
</div>
<p>and define the model type:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"></span>
</pre></div>
</div>
<p>This definition is incomplete: we shall fill in further details as we proceed.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">GameModel</span></code> type must be an instance of the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a>
class, which has an associated datatype defining the kinds of
<em>actions</em> that will be performed in generated tests.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">instance</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">ContractModel</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>

<span class="w">    </span><span class="kr">data</span><span class="w"> </span><span class="kt">Action</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Lock</span><span class="w">      </span><span class="kt">Wallet</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="kt">Integer</span><span class="w"></span>
<span class="w">                          </span><span class="o">|</span><span class="w"> </span><span class="kt">Guess</span><span class="w">     </span><span class="kt">Wallet</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="kt">Integer</span><span class="w"></span>
<span class="w">                          </span><span class="o">|</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="kt">Wallet</span><span class="w"></span>
<span class="w">        </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Eq</span><span class="p">,</span><span class="w"> </span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">Generic</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>In this case we define three actions:</p>
<blockquote>
<div><ul class="simple">
<li><p>a <code class="docutils literal notranslate"><span class="pre">Lock</span></code> action to be performed by the first player when starting
the game, containing the player’s wallet (from which the Ada will
be taken), the secret password, and the prize amount.</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">Guess</span></code> action to be performed by the other players, containing
the player’s wallet (to receive the prize), the player’s guess, a
new password, and the amount to be claimed if the guess is right.</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> action, to give the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> to a player so they
can make a guess.</p></li>
</ul>
</div></blockquote>
<p>A generated test is called <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:Actions" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Actions</span></code></a>, and is, as the name suggests, essentially a
sequence of <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a> values. We can
run tests by using <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:propRunActions_" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">propRunActions_</span></code></a>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">prop_Game</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Actions</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Property</span><span class="w"></span>
<span class="nf">prop_Game</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">propRunActions_</span><span class="w"> </span><span class="n">actions</span><span class="w"></span>
</pre></div>
</div>
<p>When we test this property, <code class="docutils literal notranslate"><span class="pre">quickCheck</span></code> will generate random
action sequences to be tested, checking at the end of each test that <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a> are
transferred correctly, and contracts didn’t crash.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is also a more general function <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:propRunActions" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">propRunActions</span></code></a> that allows
the check at the end of each test to be customized.</p>
</div>
</div></blockquote>
<p>But how does <code class="docutils literal notranslate"><span class="pre">quickCheck</span></code> know what code to run when you check <code class="docutils literal notranslate"><span class="pre">prop_Game</span></code>?
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:propRunActions_" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">propRunActions_</span></code></a> needs to create a handle
for each contract instance, which is used to invoke their
<a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoints</span></a> from the test. Different contracts have different <a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoints</span></a>,
of different types–and thus different <a class="reference internal" href="../../reference/glossary.html#term-schema"><span class="xref std std-term">schemas</span></a>. When we invoke an
<a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoint</span></a>, we need to know the <a class="reference internal" href="../../reference/glossary.html#term-schema"><span class="xref std std-term">schema</span></a> of the contract we are invoking,
and the type of errors it can return, so that the type-checker can
ensure that the call is valid. We thus need to know the <em>type</em> of
contract that each handle refers to.</p>
<p>To achieve this, every contract instance in a test is <em>named</em> by a
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractInstanceKey</span></code></a>, another
associated datatype of the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class; we talk to a
contract instance by referring to its
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractInstanceKey</span></code></a>. The
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractInstanceKey</span></code></a> type is
parameterised <em>both</em> on the type of the contract model, and on the observable
state, <a class="reference internal" href="../../reference/glossary.html#term-schema"><span class="xref std std-term">schema</span></a>, and error type of the contract it refers to. Since the
same test may refer to contracts of several different types,
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractInstanceKey</span></code></a> is defined as a
GADT.</p>
<p>In this particular case, there is only one type of contract under
test, and so it suffices to define a <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractInstanceKey</span></code></a> type with a single
constructor. There is one contract instance running in each emulated wallet, so
we simply distinguish contract instance keys by the wallet they are running in:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="kr">data</span><span class="w"> </span><span class="kt">ContractInstanceKey</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">schema</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="kr">where</span><span class="w"></span>
<span class="w">        </span><span class="kt">WalletKey</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Wallet</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">ContractInstanceKey</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameStateMachineSchema</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameError</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
</pre></div>
</div>
<p>Once this type is defined, we can tell QuickCheck what code to run for a given
contract by filling in the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">initialInstances</span></code></a>,
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">instanceWallet</span></code></a>, and
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">instanceContract</span></code></a> fields of the
<code class="docutils literal notranslate"><span class="pre">ContractModel</span></code> class:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">initialInstances</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">(`</span><span class="kt">CM</span><span class="o">.</span><span class="kt">StartContract</span><span class="p">`</span><span class="w"> </span><span class="nb">()</span><span class="p">)</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">WalletKey</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">wallets</span><span class="w"></span>

<span class="w">    </span><span class="n">instanceContract</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kt">WalletKey</span><span class="p">{}</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">contract</span><span class="w"></span>

<span class="w">    </span><span class="n">instanceWallet</span><span class="w"> </span><span class="p">(</span><span class="kt">WalletKey</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
</pre></div>
</div>
<p>This specifies (reading top to bottom) that we should create one
contract instance per wallet <code class="docutils literal notranslate"><span class="pre">w</span></code>, that will run <code class="docutils literal notranslate"><span class="pre">G.contract</span></code>, in wallet <code class="docutils literal notranslate"><span class="pre">w</span></code>.</p>
<p>Now we can run tests, although of course they will not yet succeed:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck prop_Game
*** Failed! (after 1 test and 1 shrink):
Exception:
  GSM.hs:65:10-32: No instance nor default method for class operation arbitraryAction
</pre></div>
</div>
<p>The contract modelling library cannot generate test cases, unless <em>we</em>
specify how to generate an <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a>, which we will do next.</p>
<section id="generating-actions">
<h3>Generating actions<a class="headerlink" href="#generating-actions" title="Permalink to this heading"></a></h3>
<p>To generate actions, we need to be able to generate wallets, guesses,
and suitable values of Ada, since these appear as action parameters.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">genWallet</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Gen</span><span class="w"> </span><span class="kt">Wallet</span><span class="w"></span>
<span class="nf">genWallet</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">elements</span><span class="w"> </span><span class="n">wallets</span><span class="w"></span>

<span class="nf">genGuess</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Gen</span><span class="w"> </span><span class="kt">String</span><span class="w"></span>
<span class="nf">genGuess</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">elements</span><span class="w"> </span><span class="p">[</span><span class="s">&quot;hello&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;secret&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hunter2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;*******&quot;</span><span class="p">]</span><span class="w"></span>

<span class="nf">genValue</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Gen</span><span class="w"> </span><span class="kt">Integer</span><span class="w"></span>
<span class="nf">genValue</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">getNonNegative</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">arbitrary</span><span class="w"></span>
</pre></div>
</div>
<p>We choose wallets from the three available, and we choose passwords
from a small set, so that random guesses will often be
correct. We choose Ada amounts to be non-negative integers, because
negative amounts would be error cases that we choose not to test.</p>
<p>Now we can define a generator for <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a>, as a method of the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">arbitraryAction</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">oneof</span><span class="w"> </span><span class="o">$</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">Lock</span><span class="w">      </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genValue</span><span class="w">              </span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">Guess</span><span class="w">     </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genValue</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w">                                        </span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>With this method defined, we can start to generate test cases. Using
<code class="docutils literal notranslate"><span class="pre">sample</span></code> we can see what action sequences look like:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; sample (arbitrary :: Gen (Actions GameModel))
Actions
  [Lock (Wallet 2) &quot;hunter2&quot; 5,
   Guess (Wallet 3) &quot;*******&quot; &quot;hello&quot; 6,
   Guess (Wallet 1) &quot;secret&quot; &quot;*******&quot; 10,
   Guess (Wallet 3) &quot;*******&quot; &quot;*******&quot; 6,
   GiveToken (Wallet 3),
   Guess (Wallet 2) &quot;hunter2&quot; &quot;hunter2&quot; 15]
.
.
</pre></div>
</div>
<p>We can even run ‘tests’ now, although they don’t do much yet:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck prop_Game
+++ OK, passed 100 tests:

Actions (2263 in total):
33.94% Lock
33.89% Guess
32.17% GiveToken
</pre></div>
</div>
<p>The output tells us the distribution of generated actions, aggregated
across all the tests. We can see that each action was generated around
one third of the time, which is to be expected since our generator
does not weight them at all. Keep an eye on this table as we extend
our generation; if any <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a> disappears altogether, or is generated
very rarely, then this indicates a problem in our tests.</p>
</section>
<section id="modelling-expectations">
<h3>Modelling expectations<a class="headerlink" href="#modelling-expectations" title="Permalink to this heading"></a></h3>
<p>The ultimate purpose of our tests is to check that funds are
transferred correctly by each operation–for example, that after a
guess, the guesser receives the requested Ada only if the guess was
correct. An important part of a <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> defines how funds
are expected to move. However, it’s clear that in order to define how
we expect funds to move after a <code class="docutils literal notranslate"><span class="pre">Guess</span></code>, we need to know more than
just where all the Ada are. We need to know:</p>
<ul class="simple">
<li><p>what the current secret password is, so we can decide whether or
not the guess is correct.</p></li>
<li><p>whether or not the guesser currently holds the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>, and so is
entitled to make a guess.</p></li>
<li><p>how much Ada is currently locked in the contract, so we can
determine whether the guesser is requesting funds that actually
exist.</p></li>
</ul>
<p>These all depend on the previous steps in the test case. To keep track
of such information, we store it in a <em>contract state</em>, which is the
type parameter of the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class. (Note that this contract
state is a part of the <em>model</em>, it may be quite different from the
contract state in the implementation). In this case the contract state
is the <code class="docutils literal notranslate"><span class="pre">GameModel</span></code> type, so let’s complete its definition:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">data</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="n">_gameValue</span><span class="w">     </span><span class="ow">::</span><span class="w"> </span><span class="kt">Integer</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">_hasToken</span><span class="w">      </span><span class="ow">::</span><span class="w"> </span><span class="kt">Maybe</span><span class="w"> </span><span class="kt">Wallet</span><span class="w"></span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">_currentSecret</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w">  </span><span class="kr">deriving</span><span class="w"> </span><span class="p">(</span><span class="kt">Show</span><span class="p">,</span><span class="w"> </span><span class="kt">Generic</span><span class="p">)</span><span class="w"></span>

<span class="nf">makeLenses</span><span class="w"> </span><span class="kt">&#39;GameModel</span><span class="w"></span>
</pre></div>
</div>
<p>Initially the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> does not exist, so we record its current
owner as a <code class="docutils literal notranslate"><span class="pre">Maybe</span> <span class="pre">Wallet</span></code>, so that we can represent the initial
situation before its creation. The locked funds are always in Ada, so
in the model it suffices to store an integer.</p>
<p>Now we can define the initial state of the model at the start of each
test case, <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">initialState</span></code></a>, and a <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">nextState</span></code></a> function to model the way
we expect each operation to change the state. These are both methods
in the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class.</p>
<p>The initial state just records that the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> does not exist yet,
and assigns default values to the other fields.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">initialState</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"></span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="n">_gameValue</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="n">_hasToken</span><span class="w">      </span><span class="ow">=</span><span class="w"> </span><span class="kt">Nothing</span><span class="w"></span>
<span class="w">        </span><span class="p">,</span><span class="w"> </span><span class="n">_currentSecret</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">nextState</span></code></a> function is defined in the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:Spec" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Spec</span></code></a> monad</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">nextState</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Action</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Spec</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
</pre></div>
</div>
<p>and defines the expected effect of each operation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Lock</span></code> operation creates the contract, initializing the model
contract state (using <code class="docutils literal notranslate"><span class="pre">%=</span></code> and generated <code class="docutils literal notranslate"><span class="pre">Lens</span></code> operations),
mints the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> (using <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:mint" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">mint</span></code></a>), deposits it in the creator’s
wallet, and withdraws the Ada locked in the contract (using <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:deposit" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">deposit</span></code></a>
and <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:withdraw" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">withdraw</span></code></a>):</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">nextState</span><span class="w"> </span><span class="p">(</span><span class="kt">Lock</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">hasToken</span><span class="w">      </span><span class="o">.=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">        </span><span class="n">currentSecret</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">secret</span><span class="w"></span>
<span class="w">        </span><span class="n">gameValue</span><span class="w">     </span><span class="o">.=</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">mint</span><span class="w"> </span><span class="n">guessTokenVal</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">deposit</span><span class="w">  </span><span class="n">w</span><span class="w"> </span><span class="n">guessTokenVal</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">withdraw</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
</pre></div>
</div>
<p>A <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> actually tracks not only the contract model state (in
our case the <code class="docutils literal notranslate"><span class="pre">GameModel</span></code> type), but also the quantities of <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a>
expected to be in each wallet, which are checked at the end of each
test. It is these expectations that are manipulated by <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:mint" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">mint</span></code></a>,
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:deposit" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">deposit</span></code></a>, etc… don’t confuse them with operations that <em>actually</em>
mint or move <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a> in the implementation. The <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ModelState" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ModelState</span></code></a> type
contains all of this information.</p>
<p>When making a guess, we need to check parts of the contract state
(which we read using <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:viewContractState" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">viewContractState</span></code></a>), and then we update the
stored password, game value, and wallet contents appropriately.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">nextState</span><span class="w"> </span><span class="p">(</span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">correctGuess</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="w"> </span><span class="o">==</span><span class="p">)</span><span class="w">    </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">        </span><span class="n">holdsToken</span><span class="w">   </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">==</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
<span class="w">        </span><span class="n">enoughAda</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;=</span><span class="p">)</span><span class="w">    </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">correctGuess</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">holdsToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">enoughAda</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="n">currentSecret</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">new</span><span class="w"></span>
<span class="w">            </span><span class="n">gameValue</span><span class="w">     </span><span class="o">%=</span><span class="w"> </span><span class="n">subtract</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">            </span><span class="kt">CM</span><span class="o">.</span><span class="n">deposit</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> just transfers the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> from one wallet to another using <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:transfer" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">transfer</span></code></a>.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">nextState</span><span class="w"> </span><span class="p">(</span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">w0</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">fromJust</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">transfer</span><span class="w"> </span><span class="n">w0</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">guessTokenVal</span><span class="w"></span>
<span class="w">        </span><span class="n">hasToken</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
</pre></div>
</div>
<p>At the end of each test, the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> framework checks that
every wallet contains the <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">tokens</span></a> that the model says it should.</p>
<p>We can exercise the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">nextState</span></code></a> function already by generating and
‘running’ tests, even though we have not yet connected these tests to
the real contract. Doing so immediately reveals a problem:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck prop_Game
*** Failed! (after 3 tests and 3 shrinks):
Exception:
  Maybe.fromJust: Nothing
  CallStack (from HasCallStack):
    error, called at libraries/base/Data/Maybe.hs:148:21 in base:Data.Maybe
    fromJust, called at GSM0.hs:122:15 in main:GSM0
Actions
 [GiveToken (Wallet 1)]
</pre></div>
</div>
<p>Looking at the last two lines, we see the generated test sequence, and
the problem is evident: we generated a test <em>that only gives the game
:term:`token`</em> to wallet 1, but this makes no sense because the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> has
not yet been minted–so the <code class="docutils literal notranslate"><span class="pre">fromJust</span></code> in the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">nextState</span></code></a> function
fails. We will see how to prevent this in the next section.</p>
</section>
<section id="restricting-test-cases-with-preconditions">
<h3>Restricting test cases with preconditions<a class="headerlink" href="#restricting-test-cases-with-preconditions" title="Permalink to this heading"></a></h3>
<p>As we just saw, not every sequence of actions makes sense as a test
case; we need a way to <em>restrict</em> test cases to be ‘sensible’. Note
this is <em>not</em> the same as restricting tests to ‘the happy path’: we
<em>want</em> to test unexpected sequences of actions, and indeed, this is
part of the strength of property-based testing. But there are some
actions–like trying to give the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> to a wallet before it has been
minted–that are not even interesting to test. These are the cases
that we rule out by defining preconditions for actions; the effect is
to prevent such test cases ever being generated.</p>
<p>To introduce preconditions, we add a definition of the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">precondition</span></code></a> method to our
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> instance.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">precondition</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">ModelState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Action</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Bool</span><span class="w"></span>
</pre></div>
</div>
<p>The <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">precondition</span></code></a> is parameterised on the entire model state, which
includes the contents of wallets as well as our contract state, so we
will need to extract this state as well as the fields we need from
it. For now, we just restrict <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> actions to states in which
the token exists:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">precondition</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="p">(</span><span class="kt">GiveToken</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">isJust</span><span class="w"> </span><span class="n">tok</span><span class="w"></span>
<span class="w">        </span><span class="kr">where</span><span class="w"></span>
<span class="w">            </span><span class="n">tok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
<span class="w">    </span><span class="n">precondition</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="kr">_</span><span class="w">             </span><span class="ow">=</span><span class="w"> </span><span class="kt">True</span><span class="w"></span>
</pre></div>
</div>
<p>Now if we try to run tests, something more interesting happens:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck prop_Game
*** Failed! Assertion failed (after 2 tests):
Actions
 [Lock (Wallet 1) &quot;hello&quot; 0]
Expected funds of W1 to change by
  Value (Map [(f687...,Map [(guess,1)])])
but they did not change
Test failed.
Emulator log:
[INFO] Slot 1: TxnValidate 4feb...
[INFO] Slot 1: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:
                 Contract instance started
[INFO] Slot 1: 00000000-0000-4000-8000-000000000001 {Contract instance for wallet 2}:
                 Contract instance started
[INFO] Slot 1: 00000000-0000-4000-8000-000000000002 {Contract instance for wallet 3}:
                 Contract instance started
</pre></div>
</div>
<p>The test has failed, of course. The generated (and simplified) test case only performs one action:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Actions
 [Lock (Wallet 1) &quot;hello&quot; 0]
</pre></div>
</div>
<p>Wallet 1 attempts to create a game contract guarding zero
Ada. Inspecting the error message, we can see that wallet 1 ended up
with the wrong contents:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Expected funds of W1 to change by
  Value (Map [(f687...,Map [(guess,1)])])
but they did not change
</pre></div>
</div>
<p>Our model predicted that wallet 1 would end up containing the game
<a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>, but in fact its contents were unchanged.</p>
<p>In this test, we have actually performed actions in the emulator, as
the log shows us: one transaction has been validated, and we have
started three contract instances (one for each wallet in the
test). But we have <em>not</em> created a game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> for wallet 1, because
thus far we have not defined how actions in a test should be
performed–so the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> action in the test case behaves as a no-op,
which of course does not deposit a game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> in wallet 1. It is time
to link actions in a test to the emulator.</p>
</section>
<section id="performing-actions">
<h3>Performing actions<a class="headerlink" href="#performing-actions" title="Permalink to this heading"></a></h3>
<p>So far we are generating actions, but we have not yet linked them to
the contract they are supposed to test–so ‘running’ the tests, as we
did above, did not invoke the contract at all. To do so, we must import the emulator</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Plutus.Trace.Emulator</span><span class="w"> </span><span class="n">qualified</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="kt">Trace</span><span class="w"></span>
</pre></div>
</div>
<p>Then we define the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a> method of the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">perform</span><span class="w"></span>
<span class="w">     </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">HandleFun</span><span class="w"> </span><span class="n">state</span><span class="w"></span>
<span class="w">     </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">CM</span><span class="o">.</span><span class="kt">SymToken</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Value</span><span class="o">.</span><span class="kt">AssetClass</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">ModelState</span><span class="w"> </span><span class="n">state</span><span class="w"></span>
<span class="w">     </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Action</span><span class="w"> </span><span class="n">state</span><span class="w"></span>
<span class="w">     </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">SpecificationEmulatorTrace</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
</pre></div>
</div>
<p>The job of the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a> method in this case is just to invoke the
contract end-points, using the API defined in the code under test, and
transfer the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> from one wallet to another as specified by
<code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> actions.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">gameParam</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameParam</span><span class="w"></span>
<span class="nf">gameParam</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameParam</span><span class="w"> </span><span class="p">(</span><span class="kt">Address</span><span class="o">.</span><span class="n">toPlutusAddress</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">mockWalletAddress</span><span class="w"> </span><span class="n">w1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">TimeSlot</span><span class="o">.</span><span class="n">scSlotZeroTime</span><span class="w"> </span><span class="n">def</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">perform</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">        </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="kt">Trace</span><span class="o">.</span><span class="n">callEndpoint</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;lock&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">handle</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">WalletKey</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="kt">G</span><span class="o">.</span><span class="kt">LockArgs</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">lockArgsGameParam</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">gameParam</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">lockArgsSecret</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">secretArg</span><span class="w"> </span><span class="n">new</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">lockArgsValue</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="kt">Trace</span><span class="o">.</span><span class="n">callEndpoint</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;guess&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">handle</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">WalletKey</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="kt">G</span><span class="o">.</span><span class="kt">GuessArgs</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsGameParam</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">gameParam</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessTokenTarget</span><span class="w">   </span><span class="ow">=</span><span class="w"> </span><span class="kt">Address</span><span class="o">.</span><span class="n">toPlutusAddress</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">mockWalletAddress</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsOldSecret</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">old</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsNewSecret</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">secretArg</span><span class="w"> </span><span class="n">new</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsValueTakenOut</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="kr">let</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">fromJust</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kt">Trace</span><span class="o">.</span><span class="n">payToWallet</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="n">guessTokenVal</span><span class="w"></span>
<span class="w">            </span><span class="n">return</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
</pre></div>
</div>
<p>Every call to an end-point must be associated with one of the contract
instances defined in our <code class="docutils literal notranslate"><span class="pre">initialInstances</span></code>; the <code class="docutils literal notranslate"><span class="pre">handle</span></code> argument to
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a> lets us find the contract handle associated with each
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractInstanceKey</span></code></a>.</p>
<p>For the most part, it is good practice to keep the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a> function
simple: a direct relationship between actions in a test case and calls
to <a class="reference internal" href="../../reference/glossary.html#term-contract-endpoint"><span class="xref std std-term">contract endpoints</span></a> makes interpreting test failures much easier.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Helping shrinking work better by choosing test case actions well</strong></p>
<p>In the definition of <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a> above, the <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> action is a little
surprising: when we call the emulator, we have to specify not only the
wallet to give the <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> <em>to</em>, but also the wallet to take the <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>
<em>from</em>. So why did we choose to define a <code class="docutils literal notranslate"><span class="pre">GiveToken</span> <span class="pre">w</span></code> action to
include in test cases, rather than an action <code class="docutils literal notranslate"><span class="pre">PassToken</span> <span class="pre">w</span> <span class="pre">w'</span></code>, which
would correspond more directly to the code in <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a>?</p>
<p>The answer is that using <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> actions instead helps
QuickCheck to shrink failing tests more effectively. QuickCheck
shrinks test cases by attempting to remove actions from
them–essentially replacing an action by a no-op. But consider a
sequence such as</p>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>PassToken w1 w2
PassToken w2 w3
</pre></div>
</div>
</div></blockquote>
<p>which transfers the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> in two steps from wallet 1 to
wallet 3. Deleting either one of these steps means the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> will
end up in the wrong place, probably causing the next steps in the test
to behave very differently (and thus, preventing this shrinking
step). But given the sequence</p>
<blockquote>
<div><div class="highlight-text notranslate"><div class="highlight"><pre><span></span>GiveToken w2
GiveToken w3
</pre></div>
</div>
</div></blockquote>
<p>the first <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> can be deleted without affecting the behaviour
of the second at all. Thus, by making <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>-passing steps independent
of each other, we make it easier for QuickCheck to shrink a failing
test without drastic changes to its behaviour.</p>
</div>
</div></blockquote>
</section>
<section id="shrinking-actions">
<h3>Shrinking Actions<a class="headerlink" href="#shrinking-actions" title="Permalink to this heading"></a></h3>
<p>Before starting to run tests seriously, it is useful to make sure that
any failing tests will shrink well to small examples. By default, the
contract modelling library tries to shrink tests by removing actions,
but it cannot know how to shrink the actions themselves. We can
specify this shrinking by defining the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">shrinkAction</span></code></a> operation in the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">shrinkAction</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">ModelState</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Action</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">CM</span><span class="o">.</span><span class="kt">Action</span><span class="w"> </span><span class="n">state</span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>This function returns a list of ‘simpler’ actions that should be tried
as replacements for the given <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a>, when QuickCheck is simplifying
a failed test. In this case we define a shrinking function for wallets:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">shrinkWallet</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Wallet</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="p">[</span><span class="kt">Wallet</span><span class="p">]</span><span class="w"></span>
<span class="nf">shrinkWallet</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="p">[</span><span class="n">w&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">wallets</span><span class="p">,</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>and shrink actions by shrinking the wallet and Ada parameters.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">shrinkAction</span><span class="w"> </span><span class="n">_s</span><span class="w"> </span><span class="p">(</span><span class="kt">Lock</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="kt">Lock</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">shrinkWallet</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="kt">Lock</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">val&#39;</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">shrink</span><span class="w"> </span><span class="n">val</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="n">shrinkAction</span><span class="w"> </span><span class="n">_s</span><span class="w"> </span><span class="p">(</span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">shrinkWallet</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"></span>
<span class="w">    </span><span class="n">shrinkAction</span><span class="w"> </span><span class="n">_s</span><span class="w"> </span><span class="p">(</span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="kt">Guess</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">shrinkWallet</span><span class="w"> </span><span class="n">w</span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">val&#39;</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="n">shrink</span><span class="w"> </span><span class="n">val</span><span class="p">]</span><span class="w"></span>
</pre></div>
</div>
<p>We choose not to shrink password/guess parameters, because they are
not really significant–one password is as good as another in a failed
test.</p>
</section>
</section>
<section id="debugging-the-model">
<h2>Debugging the model<a class="headerlink" href="#debugging-the-model" title="Permalink to this heading"></a></h2>
<p>At this point, the contract model is complete, and tests are
runnable. However, they do not pass, and so we need to adapt either
the tests or the contract to resolve the inconsistencies revealed. Testing <code class="docutils literal notranslate"><span class="pre">prop_Game</span></code> now results in:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck prop_Game
*** Failed! Falsified (after 6 tests and 3 shrinks):
Actions
 [Lock (Wallet 1) &quot;hunter2&quot; 0]
Expected funds of W1 to change by
  Value (Map [(f687...,Map [(guess,1)])])
but they did not change
Test failed.
Emulator log:
... 49 lines of emulator log messages ...
</pre></div>
</div>
<p>In this test, wallet 1 attempts to lock zero Ada, and our model predicts
that wallet 1 should receive a game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>–but this did not
happen. To understand why, we need to study the emulator log. Here are the relevant parts:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>...
[INFO] Slot 1: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:
                 Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;lock&quot;),...
[INFO] Slot 1: W1: Balancing an unbalanced transaction:
                     Tx:
                       Tx 2542...:
                         {inputs:
                         outputs:
                           - Value (Map []) addressed to
                             ScriptAddress: d1e1...
...
[INFO] Slot 1: W1: TxSubmit: 2542...
[INFO] Slot 2: TxnValidate 2542...
[INFO] Slot 2: W1: Balancing an unbalanced transaction:
                     Tx:
                       Tx 1eba...:
                         {inputs:
                            - 2542...!0
                              Redeemer: &lt;&gt;
                         outputs:
                           - Value (Map []) addressed to
                             ScriptAddress: d1e1...
                         mint: Value (Map [(f687...,Map [(guess,1)])])
...
[INFO] Slot 2: W1: TxSubmit: 2d66...
</pre></div>
</div>
<p>Here we see the <a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoint</span></a> call to <code class="docutils literal notranslate"><span class="pre">lock</span></code> being received during slot
1, resulting in a transaction with ID <code class="docutils literal notranslate"><span class="pre">2542...</span></code>, which pays zero Ada
to the contract <a class="reference internal" href="../../reference/glossary.html#term-script"><span class="xref std std-term">script</span></a>. The transaction is balanced (which has no
effect in this case), submitted, and validated by the emulator at
slot 2. Then another transaction, <code class="docutils literal notranslate"><span class="pre">1eba...</span></code>, is created, which
mints the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>. This transaction is in turn balanced (resulting
in a new hash, <code class="docutils literal notranslate"><span class="pre">2d66...</span></code>), and submitted without error–but although
no errors are reported, <em>this transaction is not validated</em>.</p>
<p>Since the transaction is submitted in slot 2, we would expect it to be
validated in slot 3. In fact, the problem here is just that the test
stopped too early, before the blockchain had validated this second
transaction. The solution is just to delay long enough for the
blockchain to validate all the transactions we have submitted.</p>
<section id="adding-delays-to-test-cases">
<h3>Adding delays to test cases<a class="headerlink" href="#adding-delays-to-test-cases" title="Permalink to this heading"></a></h3>
<p>To give the blockchain time to validate the transactions generated by
a <code class="docutils literal notranslate"><span class="pre">Lock</span></code> call, we need to delay by two slots. Why two?  Because the
<code class="docutils literal notranslate"><span class="pre">Lock</span></code> <a class="reference internal" href="../../reference/glossary.html#term-contract-endpoint"><span class="xref std std-term">contract endpoint</span></a> submits two transactions to the
blockchain. Likewise, we delay one slot after each of the other
actions. (If the delays we insert are too short, we will discover this
later via failed tests).</p>
<p>We add a call to <code class="docutils literal notranslate"><span class="pre">delay</span></code> in each branch of <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">gameParam</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameParam</span><span class="w"></span>
<span class="nf">gameParam</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="kt">GameParam</span><span class="w"> </span><span class="p">(</span><span class="kt">Address</span><span class="o">.</span><span class="n">toPlutusAddress</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">mockWalletAddress</span><span class="w"> </span><span class="n">w1</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">TimeSlot</span><span class="o">.</span><span class="n">scSlotZeroTime</span><span class="w"> </span><span class="n">def</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">perform</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">        </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="kt">Trace</span><span class="o">.</span><span class="n">callEndpoint</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;lock&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">handle</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">WalletKey</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="kt">G</span><span class="o">.</span><span class="kt">LockArgs</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">lockArgsGameParam</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">gameParam</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">lockArgsSecret</span><span class="w">    </span><span class="ow">=</span><span class="w"> </span><span class="n">secretArg</span><span class="w"> </span><span class="n">new</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">lockArgsValue</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="kt">CM</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
<span class="w">        </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="kt">Trace</span><span class="o">.</span><span class="n">callEndpoint</span><span class="w"> </span><span class="o">@</span><span class="s">&quot;guess&quot;</span><span class="w"> </span><span class="p">(</span><span class="n">handle</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">WalletKey</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="kt">G</span><span class="o">.</span><span class="kt">GuessArgs</span><span class="w"></span>
<span class="w">                    </span><span class="p">{</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsGameParam</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="n">gameParam</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessTokenTarget</span><span class="w">       </span><span class="ow">=</span><span class="w"> </span><span class="kt">Address</span><span class="o">.</span><span class="n">toPlutusAddress</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">mockWalletAddress</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsOldSecret</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="n">old</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsNewSecret</span><span class="w">     </span><span class="ow">=</span><span class="w"> </span><span class="n">secretArg</span><span class="w"> </span><span class="n">new</span><span class="w"></span>
<span class="w">                    </span><span class="p">,</span><span class="w"> </span><span class="kt">G</span><span class="o">.</span><span class="n">guessArgsValueTakenOut</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">                    </span><span class="p">}</span><span class="w"></span>
<span class="w">            </span><span class="kt">CM</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">        </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="kr">let</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">fromJust</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="kt">Trace</span><span class="o">.</span><span class="n">payToWallet</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">w&#39;</span><span class="w"> </span><span class="n">guessTokenVal</span><span class="w"></span>
<span class="w">            </span><span class="kt">CM</span><span class="o">.</span><span class="n">delay</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>This makes the <em>emulator</em> delay one or two slots, but we also need to
delay in our <em>model</em>, to keep the model state in sync with the
emulator. We do this using corresponding calls to <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:wait" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">wait</span></code></a> in the
definition of <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">nextState</span></code></a>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">nextState</span><span class="w"> </span><span class="p">(</span><span class="kt">Lock</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">hasToken</span><span class="w">      </span><span class="o">.=</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">        </span><span class="n">currentSecret</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">secret</span><span class="w"></span>
<span class="w">        </span><span class="n">gameValue</span><span class="w">     </span><span class="o">.=</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">mint</span><span class="w"> </span><span class="n">guessTokenVal</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">deposit</span><span class="w">  </span><span class="n">w</span><span class="w"> </span><span class="n">guessTokenVal</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">withdraw</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">wait</span><span class="w"> </span><span class="mi">2</span><span class="w"></span>
</pre></div>
</div>
<p>and similarly in the other cases.</p>
<p>Does this change fix the problem? To find out, we should <em>rerun</em> the
same test case, after updating the code.</p>
</section>
<section id="rerunning-a-failed-test">
<h3>Rerunning a failed test<a class="headerlink" href="#rerunning-a-failed-test" title="Permalink to this heading"></a></h3>
<p>The best way to save and rerun a QuickCheck test case is to
copy-and-paste it from the QuickCheck output into your code. Since
<code class="docutils literal notranslate"><span class="pre">prop_Game</span></code> is just a function that takes the generated test as an
argument, then we can rerun a test by passing it to the
property. In this case let us define</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">testLock</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Property</span><span class="w"></span>
<span class="nf">testLock</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">flip</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllDL</span><span class="w"> </span><span class="n">prop_Game</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="s">&quot;hunter2&quot;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">testLock</span></code> is itself a <code class="docutils literal notranslate"><span class="pre">Property</span></code>, so we can test it using
<code class="docutils literal notranslate"><span class="pre">quickCheck</span></code>. Testing it <em>before</em> adding the delays in the last section
generates the same output as before.  Testing it <em>after</em> the delays
are added results in</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck testLock
+++ OK, passed 100 tests.

Actions (100 in total):
100% Lock
</pre></div>
</div>
<p>The test passes, and the problem is fixed.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since there is no random generation in this test,
there is no real need to test it 100 times. This can be avoided by
adding <code class="docutils literal notranslate"><span class="pre">withMaxSuccess</span></code> to the definition:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">testLock</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Property</span><span class="w"></span>
<span class="w"> </span><span class="n">testLock</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">withMaxSuccess</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">flip</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllDL</span><span class="w"> </span><span class="n">prop_Game</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="s">&quot;hunter2&quot;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We save the <strong>failing test case</strong>, not the random seed used
to generate it. This is the only way to be sure that we repeat the
<em>same</em> test that just failed. Usually, a failed test that QuickCheck
reports is the result of both random generation <em>and shrinking</em>, not random
generation alone. Reusing the same random seed would usually
regenerate a much larger test, which might well fail for a different
reason, leading QuickCheck to report a different shrunk failing
test. It is then impossible to know for sure whether or not the change just
made to the code fixed the problem it was intended to fix–it might
just have changed the way failed tests shrink. By rerunning exactly
the same test case we can be sure that our change did fix that
problem, at least.</p>
</div>
</div></blockquote>
</section>
<section id="controlling-the-log-level">
<h3>Controlling the log-level<a class="headerlink" href="#controlling-the-log-level" title="Permalink to this heading"></a></h3>
<p>When we rerun random tests, they fail for a different reason:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck prop_Game
*** Failed! Assertion failed (after 5 tests and 7 shrinks):
Actions
 [Lock (Wallet 1) &quot;hunter2&quot; 0,
  Lock (Wallet 1) &quot;hello&quot; 0]
Outcome of Contract instance for wallet 1:
  False
Failed &#39;Contract instance stopped with error&#39;
Test failed.
Emulator log:
... 73 lines of emulator log messages ...
</pre></div>
</div>
<p>Looking at the failing test case,</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Actions
 [Lock (Wallet 1) &quot;hunter2&quot; 0,
  Lock (Wallet 1) &quot;hello&quot; 0]
</pre></div>
</div>
<p>we can see that it does something unexpected: wallet 1 tries to lock
<em>twice</em>. Our model allows this, but the error message tells us that
the contract instance crashed.</p>
<p>The emulator log output can be rather overwhelming, but we can eliminate the
<code class="docutils literal notranslate"><span class="pre">INFO</span></code> messages by running the test sequence with appropriate options. If we
define</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="kr">import</span><span class="w"> </span><span class="nn">Control.Monad.Freer.Extras.Log</span><span class="w"> </span><span class="p">(</span><span class="kt">LogLevel</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">propGame&#39;</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">LogLevel</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Actions</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Property</span><span class="w"></span>
<span class="nf">propGame&#39;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">propRunActionsWithOptions</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="n">set</span><span class="w"> </span><span class="n">minLogLevel</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">defaultCheckOptionsContractModel</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="kt">CM</span><span class="o">.</span><span class="n">defaultCoverageOptions</span><span class="w"></span>
<span class="w">                    </span><span class="p">(</span><span class="nf">\</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">pure</span><span class="w"> </span><span class="kt">True</span><span class="p">)</span><span class="w"></span>
<span class="w">                    </span><span class="n">s</span><span class="w"></span>
</pre></div>
</div>
<p>then we can re-run the test and see more succinct output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ propGame&#39; Warning
*** Failed! Assertion failed (after 7 tests and 4 shrinks):
Actions
 [Lock (Wallet 1) &quot;hello&quot; 0,
  Lock (Wallet 1) &quot;*******&quot; 0]
Outcome of Contract instance for wallet 1:
  False
Failed &#39;Contract instance stopped with error&#39;
Test failed.
Emulator log:
[WARNING] Slot 4: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:
                    Contract instance stopped with error: GameSMError (ChooserError &quot;Found 2 outputs, expected 1&quot;)
</pre></div>
</div>
<p>Now we see the problem: an error in the game implementation that
stopped the second contract call, because two unspent transaction
outputs had been created. These two outputs are the Ada amounts
addressed to the contract <a class="reference internal" href="../../reference/glossary.html#term-script"><span class="xref std std-term">script</span></a> that are created by the first
transaction of each call to the <code class="docutils literal notranslate"><span class="pre">Lock</span></code> <a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoint</span></a>. The off-chain
contract is not designed to cope with more than one such <a class="reference internal" href="../../reference/glossary.html#term-UTXO"><span class="xref std std-term">UTXO</span></a>; it is
now in a broken state. In fact, the Ada now locked in these <a class="reference internal" href="../../reference/glossary.html#term-UTXO"><span class="xref std std-term">UTXOs</span></a>
cannot be recovered by the present <a class="reference internal" href="../../reference/glossary.html#term-off-chain-code"><span class="xref std std-term">off-chain code</span></a>–the only way to
recover the money is to revise the contract so that it can accept
multiple <a class="reference internal" href="../../reference/glossary.html#term-UTXO"><span class="xref std std-term">UTXOs</span></a>. Arguably, this is a bug in the contract: if any wallet
tries to start the game for a second time, the Ada will be lost (until
the bug is fixed).</p>
</section>
<section id="refining-preconditions">
<h3>Refining preconditions<a class="headerlink" href="#refining-preconditions" title="Permalink to this heading"></a></h3>
<p>We just learned that a second <code class="docutils literal notranslate"><span class="pre">Lock</span></code> call puts the contract into a
broken state. But this is not how the game was intended to be used, so
the developer might reasonably respond “you shouldn’t do that”. There
could also be other problems in the code that we cannot presently
find, because they are masked by the double-lock bug. Since a test
case with two <code class="docutils literal notranslate"><span class="pre">Lock</span></code> calls is easy to generate, then QuickCheck is
likely to report this particular problem in almost every subsequent
run–unless we explicitly prevent it from doing so.</p>
<p>We can easily avoid this by <em>strengthening the precondition</em> of
<code class="docutils literal notranslate"><span class="pre">Lock</span></code>, so that it can only be performed once per test case. We
do so by checking whether any wallet holds the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">precondition</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">            </span><span class="kt">Lock</span><span class="w"> </span><span class="p">{}</span><span class="w">     </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">isNothing</span><span class="w"> </span><span class="n">tok</span><span class="w"></span>
<span class="w">            </span><span class="kt">Guess</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">True</span><span class="w"></span>
<span class="w">            </span><span class="kt">GiveToken</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">isJust</span><span class="w"> </span><span class="n">tok</span><span class="w"></span>
<span class="w">        </span><span class="kr">where</span><span class="w"></span>
<span class="w">            </span><span class="n">tok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
</pre></div>
</div>
<p>Now the double-lock test case can no longer be generated. If we save
the test case</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">testDoubleLock</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Property</span><span class="w"></span>
<span class="nf">testDoubleLock</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">flip</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllDL</span><span class="w"> </span><span class="n">prop_Game</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="s">&quot;*******&quot;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
<span class="w">  </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="s">&quot;secret&quot;</span><span class="w"> </span><span class="mi">0</span><span class="w"></span>
</pre></div>
</div>
<p>and try to rerun it, then QuickCheck will not do so:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck testDoubleLock
*** Gave up! Passed only 0 tests; 1000 discarded tests.
</pre></div>
</div>
<p>When a precondition cannot be satisfied, then QuickCheck ‘gives up’ as
we see here–the faulty test case was discarded (1000 times).</p>
<p>Rerunning random tests finds another ‘bug’:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ propGame&#39; Warning
*** Failed! Assertion failed (after 10 tests and 6 shrinks):
Actions
 [Lock (Wallet 2) &quot;hello&quot; 0,
  Guess (Wallet 1) &quot;hello&quot; &quot;secret&quot; 0]
Outcome of Contract instance for wallet 1:
  False
Failed &#39;Contract instance stopped with error&#39;
Test failed.
Emulator log:
[WARNING] Slot 3: W1: handleTx failed: InsufficientFunds &quot;Total: Value (Map [(,Map [(,100000000)])]) expected: Value (Map [(f687...,Map [(guess,1)])])&quot;
[WARNING] Slot 3: 00000000-0000-4000-8000-000000000000 {Contract instance for wallet 1}:
                    Contract instance stopped with error: GameSMError (SMCContractError (WalletError (InsufficientFunds &quot;Total: Value (Map [(,Map [(,100000000)])]) expected: Value (Map [(f687...,Map [(guess,1)])])&quot;)))
</pre></div>
</div>
<p>In this case, the contract instance in wallet 1 crashes, because the
wallet contains ‘insufficient funds’. Reading the last line closely,
we see that although the wallet contained 100 million Ada, it <em>lacked</em>
the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>, and so making a guess was not allowed.</p>
<p>Arguably, the <a class="reference internal" href="../../reference/glossary.html#term-off-chain-code"><span class="xref std std-term">off-chain code</span></a> should not have tried to submit the guess
transaction without holding the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>, and the contract instance
should not have crashed. Or we might take the view that no harm is
done, since the transaction is rejected anyway. But the crashing
contract does cause tests to fail, which–as before–is likely to
prevent us discovering other problems.</p>
<p>We can strengthen the precondition of <code class="docutils literal notranslate"><span class="pre">Guess</span></code> to prevent this from
happening.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">precondition</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">            </span><span class="kt">Lock</span><span class="w"> </span><span class="p">{}</span><span class="w">       </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">isNothing</span><span class="w"> </span><span class="n">tok</span><span class="w"></span>
<span class="w">            </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">tok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">            </span><span class="kt">GiveToken</span><span class="w"> </span><span class="kr">_</span><span class="w">   </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">isJust</span><span class="w"> </span><span class="n">tok</span><span class="w"></span>
<span class="w">        </span><span class="kr">where</span><span class="w"></span>
<span class="w">            </span><span class="n">tok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
</pre></div>
</div>
<p>With this change, the tests <em>still</em> fail, and we must study the entire
log output to understand why:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ prop_Game
*** Failed! Assertion failed (after 36 tests and 35 shrinks):
Actions
 [Lock (Wallet 1) &quot;*******&quot; 1,
  GiveToken (Wallet 2),
  Guess (Wallet 2) &quot;*******&quot; &quot;hello&quot; 2,
  Guess (Wallet 2) &quot;*******&quot; &quot;hunter2&quot; 1]
Expected funds of W2 to change by
  Value (Map [(,Map [(,1)]),(f687...,Map [(guess,1)])])
but they changed by
  Value (Map [(f687...,Map [(guess,1)])])
Test failed.
Emulator log:
... 52 lines of log output ...
[INFO] Slot 4: 00000000-0000-4000-8000-000000000001 {Contract instance for wallet 2}:
                 Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;guess&quot;),...Number 2.0...
... 25 lines of log output ...
[INFO] Slot 5: TxnValidationFail ab0d...: NegativeValue ...
[INFO] Slot 5: 00000000-0000-4000-8000-000000000001 {Contract instance for wallet 2}:
                 Receive endpoint call: Object (fromList [(&quot;tag&quot;,String &quot;guess&quot;),...Number 1.0...
</pre></div>
</div>
<p>In this case, we lock one Ada, and then wallet 2 makes two guesses,
both with the correct password. The first guess tries to withdraw more
Ada than are available, which our model predicts should be a
no-op. Recall we defined:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">nextState</span><span class="w"> </span><span class="p">(</span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">correctGuess</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="w"> </span><span class="o">==</span><span class="p">)</span><span class="w">    </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">        </span><span class="n">holdsToken</span><span class="w">   </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">==</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
<span class="w">        </span><span class="n">enoughAda</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;=</span><span class="p">)</span><span class="w">    </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
<span class="w">        </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">correctGuess</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">holdsToken</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">enoughAda</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">            </span><span class="n">currentSecret</span><span class="w"> </span><span class="o">.=</span><span class="w"> </span><span class="n">new</span><span class="w"></span>
<span class="w">            </span><span class="n">gameValue</span><span class="w">     </span><span class="o">%=</span><span class="w"> </span><span class="n">subtract</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">            </span><span class="kt">CM</span><span class="o">.</span><span class="n">deposit</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Ada</span><span class="o">.</span><span class="n">lovelaceValueOf</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">wait</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
</pre></div>
</div>
<p>Our model predicts that the second guess, with the correct password
and a withdrawal of only one Ada, ought to succeed. That is why we
expected wallet 2 to end up with the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>, and one Ada. However,
wallet 2 did not receive the Ada, only the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>. Reading the
emulator log reveals why: in slot 4 we called the <code class="docutils literal notranslate"><span class="pre">guess</span></code> <a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoint</span></a>
to withdraw two Ada, which would leave -1 Ada locked by the contract,
but the transaction submitted to the blockchain was not validated, and
we see the error message <code class="docutils literal notranslate"><span class="pre">NegativeValue</span></code>. We made the second
<a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoint</span></a> call, for the second guess, but nothing more happened. This
is because the validation failure <em>did not crash the off-chain
contract instance</em> (which would have provoked a test failure after the
first guess), it just left it waiting for a result from the
blockchain. As a result, the contract instance is hanging, and ignores
the second guess.</p>
<p>We can avoid this problem too, by strengthening the precondition
further:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">precondition</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">case</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="kr">of</span><span class="w"></span>
<span class="w">            </span><span class="kt">Lock</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">v</span><span class="w">    </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">isNothing</span><span class="w"> </span><span class="n">tok</span><span class="w"></span>
<span class="w">            </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">tok</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">            </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w</span><span class="w">   </span><span class="ow">-&gt;</span><span class="w"> </span><span class="n">isJust</span><span class="w"> </span><span class="n">tok</span><span class="w"></span>
<span class="w">        </span><span class="kr">where</span><span class="w"></span>
<span class="w">            </span><span class="n">tok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
</pre></div>
</div>
<p>Now the tests pass:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck . withMaxSuccess 10000 $ prop_Game
+++ OK, passed 10000 tests.

Actions (241234 in total):
87.1324% GiveToken
 9.0854% Guess
 3.7822% Lock
</pre></div>
</div>
<p>It is good practice to run <em>far more</em> than 100 tests, once tests are
passing.</p>
<p>In this section we discovered ways to crash the off-line
contract instances, or leave them hanging. We debugged the problems by
strengthening preconditions–but of course, the problems are still
there. We have just avoided provoking them with our tests, which
enabled us to continue testing and find more problems. But unless
these problems are corrected, enabling our preconditions to be
weakened again, then all we know from our tests is that the contract
behaves correctly <em>provided callers obey the preconditions</em>.</p>
</section>
</section>
<section id="measuring-and-tuning-distributions">
<h2>Measuring and tuning distributions<a class="headerlink" href="#measuring-and-tuning-distributions" title="Permalink to this heading"></a></h2>
<p>Running successful tests displays statistics over the test cases
generated. By default, testing a <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> just displays the
distribution of types of action. Looking at the output above, we can
see that the vast majority of actions were <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> actions; only
9% were guesses, and fewer than 4% were <code class="docutils literal notranslate"><span class="pre">Lock</span></code> actions.</p>
<p>It is not a surprise that there were relatively few <code class="docutils literal notranslate"><span class="pre">Lock</span></code> actions:
our precondition guarantees that there can be at most one <code class="docutils literal notranslate"><span class="pre">Lock</span></code> per
test case, and this is intentional, so of course the other actions are
much more common. However, we almost certainly <em>don’t</em> want to test
<code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> almost ten times as often as <code class="docutils literal notranslate"><span class="pre">Guess</span></code>. What is going
on?</p>
<p>The problem is this: after a <code class="docutils literal notranslate"><span class="pre">Lock</span></code> as the first action of a test
case, <em>every attempt to generate a</em> <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> <em>action will succeed</em>;
that is, the precondition of the generated action will be
<code class="docutils literal notranslate"><span class="pre">True</span></code>. But for <code class="docutils literal notranslate"><span class="pre">Guess</span></code> actions, many randomly generated actions
will not satisfy the precondition we ended up with, either because the
wallet does not contain the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>, or because the amount to be
withdrawn is greater than the amount available.</p>
<p>To achieve a better distribution of tests, we need to redefine the
action generator so that <code class="docutils literal notranslate"><span class="pre">Guess</span></code> actions more often satisfy their
precondition. The action generator is itself parameterized on the
contract state, so we could <em>guarantee</em> that generated guesses satisfy
their preconditions by redefining it as follows:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">arbitraryAction</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">oneof</span><span class="w"> </span><span class="o">$</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">Lock</span><span class="w">      </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genValue</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w">   </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w">  </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">choose</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">tok</span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="kr">where</span><span class="w"></span>
<span class="w">            </span><span class="n">tok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
</pre></div>
</div>
<p>With this change, <code class="docutils literal notranslate"><span class="pre">Guess</span></code> and <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> actions become equally
frequent:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck . withMaxSuccess 1000 $ prop_Game
+++ OK, passed 1000 tests.

Actions (23917 in total):
48.271% GiveToken
47.845% Guess
 3.884% Lock
</pre></div>
</div>
<section id="custom-generators-vs-preconditions">
<h3>Custom generators vs preconditions<a class="headerlink" href="#custom-generators-vs-preconditions" title="Permalink to this heading"></a></h3>
<p>It may seem like wasted effort to encode the form of valid <code class="docutils literal notranslate"><span class="pre">Guess</span></code>
actions twice, once in the precondition, and then again in the
generator. Would it not be sufficient to write the generator to target
successful guesses in the first place, and omit the precondition?</p>
<p>The answer is <strong>no</strong>: it would not. By writing the generator
carefully, we can ensure that the <em>generated</em> <code class="docutils literal notranslate"><span class="pre">Guess</span></code> actions are
valid, but as soon as a test fails, and QuickCheck begins to shrink
it, then the precondition becomes essential. Without it,
QuickCheck might remove a <code class="docutils literal notranslate"><span class="pre">GiveToken</span></code> action that makes a subsequent
<code class="docutils literal notranslate"><span class="pre">Guess</span></code> valid, and then report that the resulting test (not
surprisingly) failed. It is only preconditions that ensure that
<em>shrunk</em> test cases make sense.</p>
<p>Thus, the action generator cannot <em>ensure</em> that actions in test cases
are valid; it can only skew the <em>distribution</em> of actions towards
valid ones. This means there is no need for the action generator to
guarantee that the actions it generates are valid; they will in any
case have to pass the precondition before they are included in a test
case. In fact, it is a little dangerous to define a generator so that
<em>only</em> actions satisfying the precondition are generated, because we
might later choose to weaken the precondition. If we do so, and forget
to change the generator too, then we might end up with less thorough
testing than we expect. So rather than generate guesses as we did above,
it would be better to define</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">arbitraryAction</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">oneof</span><span class="w"> </span><span class="o">$</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">Lock</span><span class="w">      </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genValue</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="n">frequency</span><span class="w"> </span><span class="o">$</span><span class="w"></span>
<span class="w">          </span><span class="p">[</span><span class="w"> </span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w">   </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w">  </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">choose</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">val</span><span class="p">))</span><span class="w"></span>
<span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="kt">Just</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">[</span><span class="n">tok</span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">          </span><span class="p">[</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genGuess</span><span class="w"> </span><span class="o">&lt;*&gt;</span><span class="w"> </span><span class="n">genValue</span><span class="p">)</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="p">]</span><span class="w"> </span><span class="o">++</span><span class="w"></span>
<span class="w">        </span><span class="p">[</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="n">genWallet</span><span class="w"> </span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="kr">where</span><span class="w"></span>
<span class="w">            </span><span class="n">tok</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">hasToken</span><span class="w"></span>
<span class="w">            </span><span class="n">val</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
</pre></div>
</div>
<p>which generates valid guesses <em>most</em> of the time, with the occasional
possibly-invalid one. This approach results in test cases with a
reasonable balance between guessing and passing the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>, while
ensuring that if the preconditions are later changed, then we can
still generate every test case we could before.</p>
</section>
<section id="instrumenting-contract-models-to-gather-statistics">
<h3>Instrumenting contract models to gather statistics<a class="headerlink" href="#instrumenting-contract-models-to-gather-statistics" title="Permalink to this heading"></a></h3>
<p>It is possible to gather further statistics about the tests we are
generating. For example, we might wonder what proportion of <code class="docutils literal notranslate"><span class="pre">Guess</span></code>
actions are correct guesses. We can find out by defining the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">monitoring</span></code></a> method in the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">monitoring</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">CM</span><span class="o">.</span><span class="kt">ModelState</span><span class="w"> </span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">ModelState</span><span class="w"> </span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">Action</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Property</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Property</span><span class="w"></span>
</pre></div>
</div>
<p>This function is called for every <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a> in a test case,
and given the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ModelState" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ModelState</span></code></a> before and after the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a>. Its result is a function that is applied to the
property being tested, so it can use any of the QuickCheck functions for analysing test case
distribution or adding output to counterexamples.</p>
<p>To create a table showing the proportion of guesses which were right or wrong, we can define
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">monitoring</span></code></a> as</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">monitoring</span><span class="w"> </span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="kr">_</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">guess</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"></span>
<span class="w">        </span><span class="n">tabulate</span><span class="w"> </span><span class="s">&quot;Guesses&quot;</span><span class="w"> </span><span class="p">[</span><span class="kr">if</span><span class="w"> </span><span class="n">guess</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="kr">then</span><span class="w"> </span><span class="s">&quot;Right&quot;</span><span class="w"> </span><span class="kr">else</span><span class="w"> </span><span class="s">&quot;Wrong&quot;</span><span class="p">]</span><span class="w"></span>
<span class="w">        </span><span class="kr">where</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">^.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">contractState</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">    </span><span class="n">monitoring</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="kr">_</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="n">id</span><span class="w"></span>
</pre></div>
</div>
<p>This generates output such as this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck . withMaxSuccess 1000 $ prop_Game
+++ OK, passed 1000 tests.

Actions (23917 in total):
48.271% GiveToken
47.845% Guess
 3.884% Lock

Guesses (11443 in total):
75.417% Wrong
24.583% Right
</pre></div>
</div>
<p>Around 25% of guesses were correct in this test run, which is not
surprising since we chose guesses uniformly from a list of four
possibilities (and the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">precondition</span></code></a> for guesses does not depend on
the choice). Since correct guesses are probably at least as
interesting to test as incorrect ones, a sensible next step would be
to modify the guess generator to guess correctly more often–perhaps
half the time. We leave this as an exercise for the reader.</p>
<p>It is always good practice to make measurements of the distribution of
test cases like this, and then improve test case generation to that
the distribution looks reasonable. Otherwise there is a risk of
developing a false sense of security, engendered by running many
thousands of trivial tests.</p>
</section>
</section>
<section id="goal-directed-testing-with-dynamic-logic">
<h2>Goal-directed testing with dynamic logic<a class="headerlink" href="#goal-directed-testing-with-dynamic-logic" title="Permalink to this heading"></a></h2>
<p>The tests we have developed so far test that <em>‘nothing bad ever
happens’</em>-the funds in a test always end up where the model says that they
should. To put it another way, funds are never stolen. But this does
not really cover everything we want to test: we also want to know that
<em>‘something good eventually happens’</em>, or at least, <em>‘something good
is always possible’</em>. Concretely, this will often mean testing that
the funds in a contract can always be recovered–they cannot end up
locked in a contract for ever. And indeed, in the case of the game
contract, we would like to check that no matter what has happened
previously, the Ada locked by the contract can always be recovered by
a player who knows the password.</p>
<p>Here we are really identifying desirable ‘goal states’, namely those
in which all the Ada have been recovered from the contract, and aiming
to test that a goal state is always reachable. Obviously, random tests
are quite unlikely to end in a goal state, so no particular conclusion
can be drawn from one that does not. It is also hard to see how
QuickCheck might determine automatically whether a goal state is
reachable or not. So we test this kind of property by allowing the
tester to <em>specify a strategy</em> for reaching a goal state; QuickCheck
then tests that this strategy always works.</p>
<section id="introducing-the-dynamic-logic-monad">
<h3>Introducing the dynamic logic monad<a class="headerlink" href="#introducing-the-dynamic-logic-monad" title="Permalink to this heading"></a></h3>
<p>We write this kind of test using ‘dynamic logic’ wrapped in a monad, which just means that we write
test case generators that can mix random actions, specified actions, and assertions. These
generators are little programs in the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:DL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">DL</span></code></a> monad, such as
this one:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">unitTest</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">unitTest</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="w"> </span><span class="mi">10</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w2</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w2</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="w"> </span><span class="s">&quot;new secret&quot;</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</pre></div>
</div>
<p>This <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:DL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">DL</span></code></a> fragment simply specifies a unit test in terms
of the underlying <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> we have already seen,
using <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:action" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">action</span></code></a> to include a specific
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a> in the test. To run such a test, we must specify
a QuickCheck property such as</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">propDL</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Property</span><span class="w"></span>
<span class="nf">propDL</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllDL</span><span class="w"> </span><span class="n">dl</span><span class="w"> </span><span class="n">prop_Game</span><span class="w"></span>
</pre></div>
</div>
<p>which uses <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:forAllDL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">forAllDL</span></code></a> to generate a test sequence from the
<code class="docutils literal notranslate"><span class="pre">dl</span></code> provided, and runs it using the same underlying property as before. The execution is checked
against the model, so <em>we do not need to add any further assertions</em> to this unit test. This gives
us a very convenient way to define unit tests for a contract specified by a
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a>.</p>
<p>We can run this test as follows:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck . withMaxSuccess 1 $ propDL unitTest
+++ OK, passed 1 test.

Actions (3 in total):
33% GiveToken
33% Guess
33% Lock
</pre></div>
</div>
</section>
<section id="quantifiers-in-dynamic-logic">
<h3>Quantifiers in dynamic logic<a class="headerlink" href="#quantifiers-in-dynamic-logic" title="Permalink to this heading"></a></h3>
<p>As well as writing unit tests in the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:DL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">DL</span></code></a> monad, we can add random
generation. For example, if we wanted to generalize the unit test
above a little to lock a random amount of Ada in the contract, then
we could instead write:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">unitTest</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">unitTest</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">     </span><span class="n">val</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllQ</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">chooseQ</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w2</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w2</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="w"> </span><span class="s">&quot;new secret&quot;</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</pre></div>
</div>
<p>Here <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:forAllQ" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">forAllQ</span></code></a> lets us generate a random value using
<cite>Test.QuickCheck.DynamicLogic.Quantify.chooseQ</cite> from <cite>quickcheck-dynamic</cite>:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">chooseQ</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="p">(</span><span class="kt">Arbitrary</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">Random</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="kt">Ord</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">Quantification</span><span class="w"> </span><span class="n">a</span><span class="w"></span>
</pre></div>
</div>
<p><a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:forAllQ" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">forAllQ</span></code></a> takes a
<cite>Test.QuickCheck.DynamicLogic.Quantify.Quantification</cite>, which resembles a QuickCheck
generator, but with a more limited API to support its use in dynamic
logic.</p>
<p>When this is tested, random values in the range 1-20 are locked… and
a test fails:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ propDL unitTest
*** Failed! Falsified (after 3 tests):
BadPrecondition
  [Witness (1 :: Integer),
   Do $ Lock (Wallet 1) &quot;hello&quot; 1,
   Do $ GiveToken (Wallet 2)]
  [Action (Guess (Wallet 2) &quot;hello&quot; &quot;new secret&quot; 3)]
  (GameModel {_gameValue = 1, _hasToken = Just (Wallet 2), _currentSecret = &quot;hello&quot;})
</pre></div>
</div>
<p>Dynamic logic test cases are a little more complex than the simple
action sequences we have seen so far, and they give us a little more
information. Every such test contains a list of <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a>, tagged
<code class="docutils literal notranslate"><span class="pre">Do</span></code>, and <em>witnesses</em>, tagged <code class="docutils literal notranslate"><span class="pre">Witness</span></code>. The witnesses record the
results of random choices made by <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:forAllQ" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">forAllQ</span></code></a>: in this case, the Ada
value to be locked was chosen to be 1. The test proceeds by
locking the Ada and giving the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> to wallet 2, but the third
action we specified–making the guess–cannot be run, because its
precondition is <code class="docutils literal notranslate"><span class="pre">False</span></code>. This is what the
<code class="docutils literal notranslate"><span class="pre">BadPrecondition</span></code> tells
us, and the action that could not be performed appears as</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Action (Guess (Wallet 2) &quot;hello&quot; &quot;new secret&quot; 3)]
</pre></div>
</div>
<p>The last component is the model state at that point: we can see that
the <code class="docutils literal notranslate"><span class="pre">gameValue</span></code> is only 1 Ada, so of course we cannot withdraw 3.</p>
<blockquote>
<div><div class="admonition note">
<p class="admonition-title">Note</p>
<p>We saw earlier that when tests are <em>generated</em> from a
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a>, then QuickCheck only generates actions whose
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">precondition</span></code></a> is satisfied. On the other hand, when we use dynamic
logic to specify an action explicitly like this, then there is no
guarantee that its precondition will hold, and so a ‘bad
precondition’ error becomes a possibility. The problem here is
really that this generalized unit test is inconsistent with our
model.</p>
</div>
</div></blockquote>
</section>
<section id="repeating-a-dynamic-logic-test">
<h3>Repeating a dynamic logic test<a class="headerlink" href="#repeating-a-dynamic-logic-test" title="Permalink to this heading"></a></h3>
<p>Once again, we can copy-and-paste the failed testcase into our source
code:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">badUnitTest</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">badUnitTest</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">  </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w1</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="w"> </span><span class="mi">1</span><span class="w"></span>
<span class="w">  </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w2</span><span class="w"></span>
<span class="w">  </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w2</span><span class="w"> </span><span class="s">&quot;hello&quot;</span><span class="w"> </span><span class="s">&quot;new secret&quot;</span><span class="w"> </span><span class="mi">3</span><span class="w"></span>
</pre></div>
</div>
<p>We can rerun the test by supplying the precise action sequence that was generated:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL badUnitTest prop_Game
*** Failed! Falsified (after 1 test):
</pre></div>
</div>
<p>If we now correct <code class="docutils literal notranslate"><span class="pre">unitTest</span></code> and do freshly generated random tests
we see that the issue is resolved:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL unitTest prop_Game
+++ OK, passed 100 tests.

Actions (300 in total):
33.3% GiveToken
33.3% Guess
33.3% Lock
</pre></div>
</div>
<p>In this case the saved test ‘passes’ because it no longer matches the
modified <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:DL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">DL</span></code></a> test, so it is not a counterexample to the property we
are testing.</p>
</section>
<section id="something-good-is-always-possible">
<h3>Something good is always possible<a class="headerlink" href="#something-good-is-always-possible" title="Permalink to this heading"></a></h3>
<p>We saw above how to generate random <em>parameters</em> to actions in dynamic
logic tests; what gives them their real power is that we can also include
random <em>actions</em>.</p>
<p>Suppose we want to test that no Ada remain locked in the game contract
for ever. We could try to specify this with a <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:DL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">DL</span></code></a> test that requires that <em>no
Ada remain locked in the contract after any sequence of actions</em>. We
can include a random sequence of actions in a <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:DL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">DL</span></code></a> test using
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:anyActions_" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">anyActions_</span></code></a>, and we can make assertions about the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ModelState" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ModelState</span></code></a> using
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:assertModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">assertModel</span></code></a>. Thus we can define</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">anyActions_</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">assertModel</span><span class="w"> </span><span class="s">&quot;Locked funds should be zero&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">symIsZero</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">lockedValue</span><span class="w"></span>
</pre></div>
</div>
<p>to assert that, after any sequence of actions, no funds should remain
locked (<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:lockedValue" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">lockedValue</span></code></a> extracts the total value locked in contracts from
the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ModelState" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ModelState</span></code></a>).</p>
<p>Of course, this test fails:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL noLockedFunds prop_Game
*** Failed! Falsified (after 1 test and 2 shrinks):
BadPrecondition
  [Do $ Lock (Wallet 1) &quot;*******&quot; 1]
  [Assert &quot;Locked funds should be zero&quot;]
  (GameModel {_gameValue = 1, _hasToken = Just (Wallet 1), _currentSecret = &quot;*******&quot;})
</pre></div>
</div>
<p>If all we do is lock one Ada, then obviously the locked funds are not
zero. The failed assertion is reported as a
<code class="docutils literal notranslate"><span class="pre">BadPrecondition</span></code> (for the assertion).</p>
<p>The property we wrote above is wrong: what we really intended to say
was that <em>after a correct guess that requests all the funds</em>, then no
locked funds remain. Let us write a property that says that any wallet
can recover the funds by making such a guess. To program our strategy,
we will need to read the secret password, and the value remaining in
the contract, from the contract model:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">anyActions_</span><span class="w"></span>
<span class="w">     </span><span class="n">w</span><span class="w">      </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllQ</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">elementsQ</span><span class="w"> </span><span class="n">wallets</span><span class="w"></span>
<span class="w">     </span><span class="n">secret</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">     </span><span class="n">val</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">assertModel</span><span class="w"> </span><span class="s">&quot;Locked funds should be zero&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">symIsZero</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">lockedValue</span><span class="w"></span>
</pre></div>
</div>
<p>After a random sequence of actions, we choose a random wallet and
construct a correct guess that recovers all the locked Ada to this
wallet. But this property also fails!</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL noLockedFunds prop_Game
*** Failed! Falsified (after 1 test and 2 shrinks):
BadPrecondition
  [Witness (Wallet 1 :: Wallet)]
  [Action (Guess (Wallet 1) &quot;&quot; &quot;&quot; 0)]
  (GameModel {_gameValue = 0, _hasToken = Nothing, _currentSecret = &quot;&quot;})
</pre></div>
</div>
<p>Here QuickCheck has chosen the arbitrary sequence of actions to be
<em>empty</em>, so the contract has not even been locked–and of course, in
that case, a <code class="docutils literal notranslate"><span class="pre">Guess</span></code> is not possible. To pass the test, our strategy
must work in <em>every</em> situation. However, if the contract has not been
locked, then there are no locked funds, so the assertion in this
property would pass without our doing anything at all. Perhaps we
should only make a <code class="docutils literal notranslate"><span class="pre">Guess</span></code> if there are actually funds to be
recovered:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">anyActions_</span><span class="w"></span>
<span class="w">     </span><span class="n">w</span><span class="w">      </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllQ</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">elementsQ</span><span class="w"> </span><span class="n">wallets</span><span class="w"></span>
<span class="w">     </span><span class="n">secret</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">     </span><span class="n">val</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
<span class="w">     </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">         </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">assertModel</span><span class="w"> </span><span class="s">&quot;Locked funds should be zero&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">symIsZero</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">lockedValue</span><span class="w"></span>
</pre></div>
</div>
<p>This is better, but testing the property still fails:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL noLockedFunds prop_Game
*** Failed! Falsified (after 1 test and 1 shrink):
BadPrecondition
  [Do $ Lock (Wallet 1) &quot;*******&quot; 1,
   Witness (Wallet 2 :: Wallet)]
  [Action (Guess (Wallet 2) &quot;&quot; &quot;*******&quot; 1)]
  (GameModel {_gameValue = 1, _hasToken = Just (Wallet 1), _currentSecret = &quot;*******&quot;})
</pre></div>
</div>
<p>In this case we locked 1 Ada in the contract, chose wallet 2 to
recover the funds, and then tried to make a correct guess–but the
precondition for <code class="docutils literal notranslate"><span class="pre">Guess</span></code> still failed. And this is no surprise: the
wallet does not hold the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a>. This test case shows that, as
part of our strategy for recovering the funds, we also need to give
the game <a class="reference internal" href="../../reference/glossary.html#term-token"><span class="xref std std-term">token</span></a> to the wallet that will make the guess.</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">anyActions_</span><span class="w"></span>
<span class="w">     </span><span class="n">w</span><span class="w">      </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllQ</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">elementsQ</span><span class="w"> </span><span class="n">wallets</span><span class="w"></span>
<span class="w">     </span><span class="n">secret</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">     </span><span class="n">val</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
<span class="w">     </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">         </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">         </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">assertModel</span><span class="w"> </span><span class="s">&quot;Locked funds should be zero&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">symIsZero</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">lockedValue</span><span class="w"></span>
</pre></div>
</div>
<p>Now we expect the tests to pass:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL noLockedFunds prop_Game
*** Failed! Falsified (after 1 test):
BadPrecondition
  [Do $ Lock (Wallet 1) &quot;hello&quot; 5,
   Witness (Wallet 3 :: Wallet),
   Do $ GiveToken (Wallet 3),
   Do $ Guess (Wallet 3) &quot;&quot; &quot;hello&quot; 5]
  [Assert &quot;Locked funds should be zero&quot;]
  (GameModel {_gameValue = 5, _hasToken = Just (Wallet 3), _currentSecret = &quot;hello&quot;})
</pre></div>
</div>
<p>They do not! We can see from the last line that, in the final state,
our model indeed says that there are still 5 Ada locked in the
contract. This is the effect of the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">nextState</span></code></a> function in our model,
so let us inspect the relevant part of its code:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w">    </span><span class="n">nextState</span><span class="w"> </span><span class="p">(</span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">old</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">val</span><span class="p">)</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="n">correctGuess</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="n">old</span><span class="w"> </span><span class="o">==</span><span class="p">)</span><span class="w">    </span><span class="o">&lt;$&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">        </span><span class="c1">-- ...</span><span class="w"></span>
</pre></div>
</div>
<p>Comparing carefully with the failed test, we see that our strategy is
supplying the empty string as the old password (the guess), and the
correct password as the new one–so the guess is wrong, and the Ada
was not recovered. Swapping the two password arguments to <code class="docutils literal notranslate"><span class="pre">Guess</span></code>
does, at last, make the tests pass.</p>
<p>For this simple contract, recovering the locked funds is easy–but as
we have seen, writing a property that says that it is always possible
forces us to be precise about our strategy, and reveals anything we
might have overlooked.</p>
</section>
<section id="monitoring-and-tuning-dynamic-logic-tests">
<h3>Monitoring and tuning dynamic logic tests<a class="headerlink" href="#monitoring-and-tuning-dynamic-logic-tests" title="Permalink to this heading"></a></h3>
<p>The dynamic logic test we have developed only uses our recovery
strategy if there are locked funds remaining after a random sequence of
actions. How often does that happen? Given that tests contain many
more guesses than <code class="docutils literal notranslate"><span class="pre">Lock</span></code> actions, there is a risk that the contract is
usually holding no funds before we even consider using our
strategy. To find out, we can <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:monitor" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">monitor</span></code></a> the contract model during our
tests. As in the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">monitoring</span></code></a> method of the
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">ContractModel</span></code></a> class, we
can use any of the QuickCheck operations for analyzing test cases, but
instead of applying the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">monitoring</span></code></a> at every action in a test case, we
can <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:monitor" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">monitor</span></code></a> at selected points.</p>
<p>In this case, we choose to label test cases that actually invoke our
fund recovery strategy:</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">noLockedFunds</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">anyActions_</span><span class="w"></span>
<span class="w">     </span><span class="n">w</span><span class="w">      </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllQ</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">elementsQ</span><span class="w"> </span><span class="n">wallets</span><span class="w"></span>
<span class="w">     </span><span class="n">secret</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">     </span><span class="n">val</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
<span class="w">     </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">         </span><span class="kt">CM</span><span class="o">.</span><span class="n">monitor</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="s">&quot;Unlocking funds&quot;</span><span class="w"></span>
<span class="w">         </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">         </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">     </span><span class="kt">CM</span><span class="o">.</span><span class="n">assertModel</span><span class="w"> </span><span class="s">&quot;Locked funds should be zero&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">symIsZero</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">lockedValue</span><span class="w"></span>
</pre></div>
</div>
<p>With the addition of the <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:monitor" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">monitor</span></code></a> line, QuickCheck tells us what
proportion of our tests actually leave funds to recover:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL noLockedFunds prop_Game
+++ OK, passed 100 tests (31% Unlocking funds).

Actions (5112 in total):
49.24% GiveToken
48.81% Guess
 1.96% Lock
</pre></div>
</div>
<p>We can see that around 30% of generated tests leave some Ada in the
contract for our strategy to recover. This is a bit low–it means that
two thirds of our tests do not actually test the strategy. But it is
easy to address: we can simply use the dynamic logic to specify the
initial <code class="docutils literal notranslate"><span class="pre">Lock</span></code> action <em>explicitly</em>, and generate larger amounts for
the initial funds locked in the game (lines 3-5 below):</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="nf">noLockedFunds</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="kt">GameModel</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="nf">noLockedFunds</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="n">w0</span><span class="p">,</span><span class="w"> </span><span class="n">funds</span><span class="p">,</span><span class="w"> </span><span class="n">pass</span><span class="p">)</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllQ</span><span class="w"> </span><span class="p">(</span><span class="kt">CM</span><span class="o">.</span><span class="n">elementsQ</span><span class="w"> </span><span class="n">wallets</span><span class="p">,</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">chooseQ</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">10000</span><span class="p">),</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">elementsQ</span><span class="w"> </span><span class="n">guesses</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Lock</span><span class="w"> </span><span class="n">w0</span><span class="w"> </span><span class="n">pass</span><span class="w"> </span><span class="n">funds</span><span class="w"></span>
<span class="w">    </span><span class="kt">CM</span><span class="o">.</span><span class="n">anyActions_</span><span class="w"></span>
<span class="w">    </span><span class="n">w</span><span class="w">      </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">forAllQ</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">elementsQ</span><span class="w"> </span><span class="n">wallets</span><span class="w"></span>
<span class="w">    </span><span class="n">secret</span><span class="w"> </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">currentSecret</span><span class="w"></span>
<span class="w">    </span><span class="n">val</span><span class="w">    </span><span class="ow">&lt;-</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">viewContractState</span><span class="w"> </span><span class="n">gameValue</span><span class="w"></span>
<span class="w">    </span><span class="n">when</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kr">do</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">monitor</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="n">label</span><span class="w"> </span><span class="s">&quot;Unlocking funds&quot;</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">GiveToken</span><span class="w"> </span><span class="n">w</span><span class="w"></span>
<span class="w">        </span><span class="kt">CM</span><span class="o">.</span><span class="n">action</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">Guess</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="n">secret</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="n">val</span><span class="w"></span>
<span class="w">    </span><span class="kt">CM</span><span class="o">.</span><span class="n">assertModel</span><span class="w"> </span><span class="s">&quot;Locked funds should be zero&quot;</span><span class="w"> </span><span class="o">$</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">symIsZero</span><span class="w"> </span><span class="o">.</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">lockedValue</span><span class="w"></span>
</pre></div>
</div>
<p>With this addition, a much higher proportion of tests actually
exercise our recovery strategy:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&gt; quickCheck $ forAllDL noLockedFunds prop_Game
+++ OK, passed 100 tests (74% Unlocking funds).

Actions (5198 in total):
49.75% GiveToken
48.33% Guess
 1.92% Lock
</pre></div>
</div>
</section>
<section id="more-dynamic-logic">
<h3>More dynamic logic<a class="headerlink" href="#more-dynamic-logic" title="Permalink to this heading"></a></h3>
<p>Dynamic logic tests are much more expressive than we have seen
hitherto. The <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:DL" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">DL</span></code></a> monad is an instance of <code class="docutils literal notranslate"><span class="pre">Alternative</span></code>, so we can
write tests with random control flow, weight choices suitably, and so
on. For example, <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:anyActions" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">anyActions</span></code></a>, which generates a random sequence of
actions of expected length <code class="docutils literal notranslate"><span class="pre">n</span></code>, is defined by</p>
<div class="highlight-haskell notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">anyActions</span><span class="w"> </span><span class="ow">::</span><span class="w"> </span><span class="kt">Int</span><span class="w"> </span><span class="ow">-&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="kt">DL</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="nb">()</span><span class="w"></span>
<span class="w"> </span><span class="n">anyActions</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="ow">=</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">stopping</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;|&gt;</span><span class="w"> </span><span class="kt">CM</span><span class="o">.</span><span class="n">weight</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">fromIntegral</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">&lt;|&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">CM</span><span class="o">.</span><span class="n">anyAction</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">anyActions</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"></span>
</pre></div>
</div>
<p>This code makes a random choice between three alternatives, expressed
using <code class="docutils literal notranslate"><span class="pre">(&lt;|&gt;)</span></code>. The first two alternatives terminate (and return
<code class="docutils literal notranslate"><span class="pre">()</span></code>), while the last alternative performs a random action followed
by another random sequence of actions. The second alternative is
weighted by <code class="docutils literal notranslate"><span class="pre">1/n</span></code>, so the third is chosen <code class="docutils literal notranslate"><span class="pre">n</span></code> times as often,
resulting in an expected length of <code class="docutils literal notranslate"><span class="pre">n</span></code> actions. The first
alternative is guarded by <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:stopping" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">stopping</span></code></a>, which means it will be chosen
<em>only</em> if the test case is ‘getting too long’; in this case
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:anyActions" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">anyActions</span></code></a> will generate an empty sequence. We can exercise fine
control over the way test cases are generated, including specifying
strategies for bringing a long test case to a close. See the
documentation for more details.</p>
</section>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Permalink to this heading"></a></h2>
<p>The tests we have developed here suffer from three main limitations:</p>
<blockquote>
<div><ul class="simple">
<li><p>We test only via the off-chain <a class="reference internal" href="../../reference/glossary.html#term-contract-endpoint"><span class="xref std std-term">contract endpoints</span></a></p></li>
<li><p>We test under favourable assumptions on timing</p></li>
<li><p>We don’t test for information leaks</p></li>
</ul>
</div></blockquote>
<p>What are the implications, and how can we address them?</p>
<section id="testing-only-via-contract-endpoints">
<h3>Testing only via <a class="reference internal" href="../../reference/glossary.html#term-contract-endpoint"><span class="xref std std-term">contract endpoints</span></a><a class="headerlink" href="#testing-only-via-contract-endpoints" title="Permalink to this heading"></a></h3>
<p>We tested that the guessing game contract behaves as it should,
<em>provided transactions are submitted using the off-chain contract
code</em>. But what if a malicious actor writes their <em>own</em> off-chain
code, submitting transactions that the contract’s own <a class="reference internal" href="../../reference/glossary.html#term-off-chain-code"><span class="xref std std-term">off-chain code</span></a>
cannot generate? Is it possible, for example, to steal the Ada locked
by the game, <em>without</em> submitting a guess? Our tests do not cover
this.</p>
<p>One way to mitigate this problem is to add additional ‘attack’
<a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoints</span></a> to the contract under test, that carry out a variety of
conceivable attacks. Our contract model would then model these attack
actions as no-ops, to represent the fact that the attacks fail; our
tests would then check that the attacks fail in all circumstances, and
with all parameters.</p>
<p>If we think of the guessing game, not as a game, but instead as a
contract that protects funds with a password, then we might consider
‘guessing’ with the correct password as a correct withdrawal, and
guessing with an incorrect password as an attack. Our model does test
that these attacks always fail; this approach can be used in general
to test that contracts are robust against <em>anticipated</em> attacks.</p>
</section>
<section id="test-assumptions-on-timing">
<h3>Test assumptions on timing<a class="headerlink" href="#test-assumptions-on-timing" title="Permalink to this heading"></a></h3>
<p>Our tests wait for the transactions generated by an
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a> to complete before performing the next
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a> (because we inserted calls to <code class="docutils literal notranslate"><span class="pre">delay</span></code> into
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">perform</span></code></a>, and
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#v:wait" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">wait</span></code></a> into
<a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">nextState</span></code></a>). In reality, different wallets may perform
actions simultaneously. This usually results in two or more transactions that try to spend the same
<a class="reference internal" href="../../reference/glossary.html#term-UTXO"><span class="xref std std-term">UTXO</span></a>, leading all but the first to fail.</p>
<p><a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">Endpoint</span></a> calls that submit several transactions are
even more problematic, because such a call may fail part way through,
leaving the blockchain in an intermediate, and possibly invalid
state. Arguably, contracts should be written to undo the effects of
earlier transactions if later ones fail–although, as we saw, the
<code class="docutils literal notranslate"><span class="pre">Lock</span></code> <a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoint</span></a> of the game contract (which is implemented
as two transactions) does not do this: a second call to <code class="docutils literal notranslate"><span class="pre">Lock</span></code> fails
after the first transaction, and leaves the blockchain in a state that
the contract cannot handle.</p>
<p>It is possible to test this kind of behaviour in our framework, by <em>not</em> delaying before the next
action, so that several actions can be started in the same slot. Delays must then be included as an
explicit <a class="reference external" href="../../haddock/plutus-contract/html/Plutus-Contract-Test-ContractModel-Interface.html#t:ContractModel" title="(in plutus-contract v1.1.0.0)"><code class="docutils literal notranslate"><span class="pre">Action</span></code></a> in test cases instead. However,
modelling becomes considerably harder, because the model must predict <em>which</em> transaction of several
simultaneous ones succeeds, and must take into account how many transactions each end-point call
results in, and which slot each is expected to be commited in. It isn’t clear that the extra
modelling effort is really worthwhile.</p>
<p>Moreover, in reality transactions might be delayed, which means that
<a class="reference internal" href="../../reference/glossary.html#term-endpoint"><span class="xref std std-term">endpoint</span></a> calls that generate several transactions might end up
being interleaved in unexpected ways. The emulator doesn’t currently
simulate this, and so these kinds of tests cannot yet be run.</p>
</section>
<section id="testing-for-information-leaks">
<h3>Testing for information leaks<a class="headerlink" href="#testing-for-information-leaks" title="Permalink to this heading"></a></h3>
<p>We have tested that only a guess containing the correct secret can
withdraw Ada from the game contract. So to steal the money, an
adversary must discover the secret. But recall that an adversary can
access everything on the blockchain, and also the contents of
transactions.</p>
<p>There are least two serious bugs that the game contract could contain,
that would permit an adversary to steal all the money:</p>
<blockquote>
<div><ul class="simple">
<li><p>The secret could be stored in plain text in the contract state,
instead of encrypted. The contract state is stored on the
blockchain. The adversary could simply read the secret from the
blockchain, and then make a correct guess to steal the money.</p></li>
<li><p>The secret might be stored in encrypted form on the blockchain, but
<code class="docutils literal notranslate"><span class="pre">Guess</span></code> transactions might contain an <em>encrypted</em> guess, rather
than a plain text guess (as they do in this implementation). Then
the adversary could simply read the encrypted secret from the
blockchain, and submit it in a guess transaction to steal the
money.</p></li>
</ul>
</div></blockquote>
<p>Neither of these bugs would be detected by our tests, nor is it clear
how they could be.</p>
<p>This test framework is a powerful tool for testing that contracts
behave correctly, when used as intended–but users should be aware of
the limitations in this section, and be careful to avoid the pitfalls
they expose.</p>
</section>
</section>
<section id="further-examples">
<h2>Further Examples<a class="headerlink" href="#further-examples" title="Permalink to this heading"></a></h2>
<p>In addition to the model for the <a class="reference external" href="https://github.com/input-output-hk/plutus-apps/blob/master/plutus-use-cases/test/Spec/GameStateMachine.hs">Game</a> contract presented in this
tutorial, there are also models for the <a class="reference external" href="https://github.com/input-output-hk/plutus-apps/blob/master/plutus-use-cases/test/Spec/Prism.hs">Prism</a> and the <a class="reference external" href="https://github.com/input-output-hk/plutus-apps/blob/master/plutus-use-cases/test/Spec/Auction.hs">Auction</a> example
contracts in the <code class="docutils literal notranslate"><span class="pre">plutus-use-cases</span></code> project.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="basic-apps-constraints.html" class="btn btn-neutral float-left" title="Extending the basic Plutus app with the constraints API" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="contract-models.html" class="btn btn-neutral float-right" title="Testing Plutus Contracts with Contract Models" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1980, IOHK.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>
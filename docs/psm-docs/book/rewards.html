<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Certificates and withdrawals of the rewards - Plutus-simple-model tutorial</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="install.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="quick-start.html"><strong aria-hidden="true">3.</strong> Quick start</a></li><li class="chapter-item expanded "><a href="use-tasty.html"><strong aria-hidden="true">4.</strong> Testing with Tasty</a></li><li class="chapter-item expanded "><a href="create-tx.html"><strong aria-hidden="true">5.</strong> Creation of transactions</a></li><li class="chapter-item expanded "><a href="typed-validator.html"><strong aria-hidden="true">6.</strong> Typed validators</a></li><li class="chapter-item expanded "><a href="test-scripts.html"><strong aria-hidden="true">7.</strong> Test scripts</a></li><li class="chapter-item expanded "><a href="time.html"><strong aria-hidden="true">8.</strong> Work with time</a></li><li class="chapter-item expanded "><a href="logs.html"><strong aria-hidden="true">9.</strong> Using logs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="logs/log-debug.html"><strong aria-hidden="true">9.1.</strong> Log debug information</a></li><li class="chapter-item expanded "><a href="logs/log-error.html"><strong aria-hidden="true">9.2.</strong> Log custom errors</a></li><li class="chapter-item expanded "><a href="logs/skip-logs.html"><strong aria-hidden="true">9.3.</strong> How to skip messages from logs</a></li><li class="chapter-item expanded "><a href="logs/human-readable-names.html"><strong aria-hidden="true">9.4.</strong> Human readable names</a></li></ol></li><li class="chapter-item expanded "><a href="fake-coins.html"><strong aria-hidden="true">10.</strong> Custom coins</a></li><li class="chapter-item expanded "><a href="check-balance.html"><strong aria-hidden="true">11.</strong> Check balances</a></li><li class="chapter-item expanded "><a href="unit-tests.html"><strong aria-hidden="true">12.</strong> How to use in unit tests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="unit-tests/negative.html"><strong aria-hidden="true">12.1.</strong> Write negative tests</a></li><li class="chapter-item expanded "><a href="unit-tests/custom-fail.html"><strong aria-hidden="true">12.2.</strong> Fail on a custom condition</a></li><li class="chapter-item expanded "><a href="unit-tests/check-budget.html"><strong aria-hidden="true">12.3.</strong> Check TX budget</a></li></ol></li><li class="chapter-item expanded "><a href="box.html"><strong aria-hidden="true">13.</strong> Box - a typed TxOut</a></li><li class="chapter-item expanded "><a href="staking.html"><strong aria-hidden="true">14.</strong> Staking and certificates</a></li><li class="chapter-item expanded "><a href="rewards.html" class="active"><strong aria-hidden="true">15.</strong> Certificates and withdrawals of the rewards</a></li><li class="chapter-item expanded "><a href="ledger-export.html"><strong aria-hidden="true">16.</strong> Ledger reexports</a></li><li class="chapter-item expanded "><a href="query.html"><strong aria-hidden="true">17.</strong> How to query Blockchain</a></li><li class="chapter-item expanded "><a href="plutus-v2.html"><strong aria-hidden="true">18.</strong> Plutus V2 features</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Plutus-simple-model tutorial</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="certificates-and-withdrawals-of-the-rewards"><a class="header" href="#certificates-and-withdrawals-of-the-rewards">Certificates and withdrawals of the rewards</a></h1>
<p>In cardano staking pools are driving force behind confirmation of transactions.
For the work pool owners receive fees. The fees get distributed among 
staking credentials that delegate to pool. </p>
<p>So we have staking pool operator (SPO) who is chosen for this round to
confirm TX. And for this work SPO gets the fees. Fees are collected 
to the addresses that are called staking credentials. Users can delegate staking credential
to the pool owner (SPO). </p>
<p>So far we have ignored the fees, but in real scenario every transaction should contain fees.
To pay fee in the transaction we can use function. The fees are fairly distributed among
all staking credentials that belong to the pool:</p>
<pre><code class="language-haskell">-- Pay fee for TX confirmation. The fees are payed in ADA (Lovelace)
payFee :: Ada -&gt; Tx
</code></pre>
<p>The <code>Ada</code> is a newtpye wrapper over <code>Integer</code> that specifies amount of lovelaces.
It is defined in the module <code>Plutus.Model.Ledger.Ada</code>.</p>
<h4 id="how-reward-distribution-works"><a class="header" href="#how-reward-distribution-works">How reward distribution works</a></h4>
<p>For each round of TX confirmation there is a pool called <strong>leader</strong> that confirms
TX. For that the pool receives fees and fairly distributes them among stake credentials
that delegate to that pool.</p>
<p>For this testing framework we go over a list of pools one by one and on each TX-confirmation
we choose the next pool. All staking credentials delegated to the pool receive equal amount of fees.
When blockchain initialised we have a single pool id and stake credential that 
belongs to the admin (user who owns all funds on genesis TX). </p>
<p>So to test some Stake validator we need to register it in the blockchain
and delegate it to admin's pool. We can get the pool of the admin by calling <code>(head &lt;$&gt; getPools)</code>.
This gives the pool identifier of the only pool that is registered.
After that we create TX that registers taking credential and delegates it to admin's pool.
We can provide enough fees for that TX to check the stake validator properties. </p>
<p>As an example we can use the test-case in the module <code>Suites.Plutus.Model.Script.Test.Staking</code>.
It implements a basic stake validator and checks that it works (see the directory <code>test</code> for this repo).</p>
<h4 id="certificates"><a class="header" href="#certificates">Certificates</a></h4>
<p>To work with pools and staking credentials we use certificates (<code>DCert</code> in Plutus).
We have functions that trigger actions with pools and staking credentials:</p>
<p>First we need to register staking credential by pub key hash (rewards belong to certain key)
or by the script. For the script there is guarding logic that regulates spending of rewards
for staking credential. For the key we require that TX is signed by the given key to spend the reward.</p>
<pre><code class="language-haskell">registerStakeKey    :: PubKeyHash -&gt; Tx

registerStakeScript :: TypedStake redeemer -&gt; Tx
</code></pre>
<p>Also we can deregistrate the staking credential:</p>
<pre><code class="language-haskell">deregisterStakeKey    :: PubKeyHash -&gt; Tx

deregisterStakeScript :: IsValidator (TypedStake redeemer) =&gt; 
  TypedStake redeemer -&gt; redeemer -&gt; Tx
</code></pre>
<p>A staking credential can get rewards only over a pool. To associate it with pool
we use the function delegate:</p>
<pre><code class="language-haskell">delegateStakeKey    :: PubKeyHash -&gt; PoolId -&gt; Tx

delegateStakeScript :: IsValidator (TypedStake redeemer) =&gt; 
  TypedStake redeemer -&gt; redeemer -&gt; PoolId -&gt; Tx
</code></pre>
<p>The type <code>PoolId</code> is just a <code>newtype</code> wrapper for <code>PubKeyHash</code>:</p>
<pre><code class="language-haskell">newtype PoolId = PoolId { unPoolId :: PubKeyHash }
</code></pre>
<p>As blockchain starts we have only one pool and staking credential associated with it.
It is guarded by admin's pub key hash.</p>
<p>We can register or deregister (retire) pools with functions:</p>
<pre><code class="language-haskell">registerPool :: PoolId -&gt; Tx
retirePool   :: PoolId -&gt; Tx
</code></pre>
<p>Alas above functions do not work (need to fix conversion to VrfKey) at the moment.
Use direct insertion/removal of pools with <code>insertPool</code> and <code>deletePool</code> to manage stake pools:</p>
<pre><code class="language-haskell">insertPool :: PoolId -&gt; Run ()
deletePool :: PoolId -&gt; Run ()
</code></pre>
<p>For staking validators each of those functions is going to trigger validation with purpose
<code>Certifying DCert</code>. Where <code>DCert</code> can be one of the following:</p>
<pre><code class="language-haskell">data DCert
  = DCertDelegRegKey StakingCredential     -- register stake
  | DCertDelegDeRegKey StakingCredential   -- deregister stake
  | DCertDelegDelegate                     -- delegate stake to pool
      StakingCredential
      -- ^ delegator
      PubKeyHash
      -- ^ delegatee
  | -- | A digest of the PoolParams
    DCertPoolRegister                     -- register pool
      PubKeyHash
      -- ^ poolId
      PubKeyHash
      -- ^ pool VFR
  | -- | The retiremant certificate and the Epoch N
    DCertPoolRetire PubKeyHash Integer   -- retire the pool 
                                         -- NB: Should be Word64 but we only have Integer on-chain
  | -- | A really terse Digest
    DCertGenesis                         -- not supported for testing yet
  | -- | Another really terse Digest
    DCertMir                             -- not supported for testing yet
</code></pre>
<h4 id="query-staking-credentials-and-pools"><a class="header" href="#query-staking-credentials-and-pools">Query staking credentials and pools</a></h4>
<p>We can collect various stats during execution on how many coins we have for rewards
and where staking credential belongs to.</p>
<pre><code class="language-haskell">-- get all pools
getPools :: Run [PoolId]

-- get staking credential by pool
stakesAt :: PoolId -&gt; Run [StakingCredential]

-- get rewards for a StakingCredential, PubKeyHash and StakeValidator or TypedStake
rewardAt :: HasStakingCredential cred =&gt; cred -&gt; Run Integer

-- query if pool is registered
hasPool :: PoolId -&gt; Run Bool

-- query if staking credential is registered
hasStake :: HasStakingCredential cred =&gt; cred -&gt; Run Bool
</code></pre>
<h4 id="utility-functions-to-create-staking-credentials"><a class="header" href="#utility-functions-to-create-staking-credentials">Utility functions to create staking credentials</a></h4>
<p>We can create staking credential out of pub key hash or stake validator
with function:</p>
<pre><code class="language-haskell">toStakingCredential :: HasStakingCredential a =&gt; a -&gt; StakingCredential
</code></pre>
<h4 id="withdrawals-of-the-rewards"><a class="header" href="#withdrawals-of-the-rewards">Withdrawals of the rewards</a></h4>
<p>When staking credential has some rewards we can withdraw it and send
to some address. To do it we need to spend all rewards, so we need to 
provide exact amount that is stored in the rewards of the staking credential
at the time of TX confirmation. </p>
<p>We can query the current amount with function <code>rewardAt</code>:</p>
<pre><code class="language-haskell">-- get rewards for a StakingCredential
rewardAt :: StakingCredential -&gt; Run Integer
</code></pre>
<p>To get rewards we need to include in transaction this part:</p>
<pre><code class="language-haskell">withdrawStakeKey    :: PubKeyHash -&gt; Integer -&gt; Tx

withdrawStakeScript :: (IsValidator script) =&gt; 
  TypedStake script -&gt; RedeemerType script -&gt; Integer -&gt; Tx
</code></pre>
<p>As with certificates we can withdraw by pub key hash (needs to be signed by that key)
and also by validator. </p>
<p>To test withdraws we need to have rewards. We can easily generate rewards by 
making transactions that contain fees granted with <code>payFee</code> function.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="staking.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="ledger-export.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="staking.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="ledger-export.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>

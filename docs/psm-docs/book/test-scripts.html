<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Test scripts - Plutus-simple-model tutorial</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="install.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="quick-start.html"><strong aria-hidden="true">3.</strong> Quick start</a></li><li class="chapter-item expanded "><a href="use-tasty.html"><strong aria-hidden="true">4.</strong> Testing with Tasty</a></li><li class="chapter-item expanded "><a href="create-tx.html"><strong aria-hidden="true">5.</strong> Creation of transactions</a></li><li class="chapter-item expanded "><a href="typed-validator.html"><strong aria-hidden="true">6.</strong> Typed validators</a></li><li class="chapter-item expanded "><a href="test-scripts.html" class="active"><strong aria-hidden="true">7.</strong> Test scripts</a></li><li class="chapter-item expanded "><a href="time.html"><strong aria-hidden="true">8.</strong> Work with time</a></li><li class="chapter-item expanded "><a href="logs.html"><strong aria-hidden="true">9.</strong> Using logs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="logs/log-debug.html"><strong aria-hidden="true">9.1.</strong> Log debug information</a></li><li class="chapter-item expanded "><a href="logs/log-error.html"><strong aria-hidden="true">9.2.</strong> Log custom errors</a></li><li class="chapter-item expanded "><a href="logs/skip-logs.html"><strong aria-hidden="true">9.3.</strong> How to skip messages from logs</a></li><li class="chapter-item expanded "><a href="logs/human-readable-names.html"><strong aria-hidden="true">9.4.</strong> Human readable names</a></li></ol></li><li class="chapter-item expanded "><a href="fake-coins.html"><strong aria-hidden="true">10.</strong> Custom coins</a></li><li class="chapter-item expanded "><a href="check-balance.html"><strong aria-hidden="true">11.</strong> Check balances</a></li><li class="chapter-item expanded "><a href="unit-tests.html"><strong aria-hidden="true">12.</strong> How to use in unit tests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="unit-tests/negative.html"><strong aria-hidden="true">12.1.</strong> Write negative tests</a></li><li class="chapter-item expanded "><a href="unit-tests/custom-fail.html"><strong aria-hidden="true">12.2.</strong> Fail on a custom condition</a></li><li class="chapter-item expanded "><a href="unit-tests/check-budget.html"><strong aria-hidden="true">12.3.</strong> Check TX budget</a></li></ol></li><li class="chapter-item expanded "><a href="box.html"><strong aria-hidden="true">13.</strong> Box - a typed TxOut</a></li><li class="chapter-item expanded "><a href="staking.html"><strong aria-hidden="true">14.</strong> Staking and certificates</a></li><li class="chapter-item expanded "><a href="rewards.html"><strong aria-hidden="true">15.</strong> Certificates and withdrawals of the rewards</a></li><li class="chapter-item expanded "><a href="ledger-export.html"><strong aria-hidden="true">16.</strong> Ledger reexports</a></li><li class="chapter-item expanded "><a href="query.html"><strong aria-hidden="true">17.</strong> How to query Blockchain</a></li><li class="chapter-item expanded "><a href="plutus-v2.html"><strong aria-hidden="true">18.</strong> Plutus V2 features</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Plutus-simple-model tutorial</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="testing-scripts"><a class="header" href="#testing-scripts">Testing scripts</a></h1>
<p>In this chapter we will learn how to work with scripts.
As an example we are going to test the hash game script.
Let's initialise the game. For that we spend a prize to the UTXO guarded
by game validator:</p>
<pre><code class="language-haskell">initGame :: PubKeyHash -&gt; Value -&gt; BuiltinByteString -&gt; Run ()
initGame pkh prize answer = do   -- args: user, prize value , answer for puzzletype
  sp &lt;- spend pkh prize          -- read users UTXO that we should spend
  submitTx pkh $                 -- create TX, sign it and post to 
    initGameTx sp prize answer   -- ledger with user's secret key

-- pure function to create TX
initGameTx :: UserSpend -&gt; Value -&gt; BuiltinByteString -&gt; Tx
</code></pre>
<p>Let's discuss the function bit by bit. To create TX we need to first determine the inputs.
Input is set of UTXO's that we'd like to spend. For that we use function</p>
<pre><code class="language-haskell">spend :: PubKeyHash -&gt; Value -&gt; Run UserSpend
</code></pre>
<p>For a given user and value it returns a value of <code>UserSpend</code> which holds
a set of input UTXOs that cover the value that we want to spend, and also it has change to spend back to user.
In the UTXO model we can not split the input. If it's bigger than we need we have to destroy it
and create one UTXO that is given to someone else and another one that is spent back to user.
We can think about the latter UTXO as a change.</p>
<p>Note that it is going to produce run-time exception if there are not enough funds to spend.
To avoid run-time errors there is safer variant called <code>spend'</code>.
Also, we can use safer alternative <code>withSpend</code>. It logs an error
if user has no funds to spend and continues execution which can
be helpful in some test cases:</p>
<pre><code class="language-haskell">withSpend :: PubKeyHash -&gt; Value -&gt; (UserSpend -&gt; Run ()) -&gt; Run ()
</code></pre>
<p>When we know what inputs to spend we need to make a TX. We do it with function <code>initGameTx</code>. We will discuss it soon.
After that we should sign TX with the key of the sender and send it to
ledger. We use function <code>submitTx</code> for that.</p>
<p>Let's discuss how to create TX:</p>
<pre><code class="language-haskell">initGameTx :: UserSpend -&gt; Value -&gt; BuiltinByteString -&gt; Tx
initGameTx usp val answer =
  mconcat
    [ userSpend usp
    , payToScript gameScript (HashDatum $ GuessHash $ Plutus.sha2_256 answer) val
    ]
</code></pre>
<p>We create transaction by accumulation of monoidal parts. As Plutus Tx is monoid it's convenient
to assemble it from tiny parts. For our task there are just two parts:</p>
<ul>
<li>for inputs and outputs of user spend</li>
<li>pay prize to the script and form right datum for it.</li>
</ul>
<p>We use function to make right part for spending the user inputs and sending change back to user:</p>
<pre><code class="language-haskell">userSpend :: UserSpend -&gt; Tx
</code></pre>
<p>To pay to script we use function:</p>
<pre><code class="language-haskell">data DatumMode a 
  = HashDatum a      -- ^ store datum hash in TxOut
  | InlineDatum a    -- ^ store inlined datum value in TxOut

payToScript :: 
     (HasAddress script, HashDatum script)
  =&gt; script 
  -&gt; DatumMode (DatumType script) 
  -&gt; Value 
  -&gt; Tx
</code></pre>
<p>So it uses address of the validator, datum for it (of proper type) and value to protect with the contract.
As simple as that. Our type <code>Game</code> is <code>TypedValidator GameDatum GameRedeemer</code> and
for typed valdiator first type argument corresponds to <code>DatumType</code>.
As input we can use <code>TypedValidator</code>, <code>TypedValidatorHash</code> and <code>AppendStaking</code>-wrappers.</p>
<p>Note that in example we wrap it in <code>HashDatum</code>. Starting from Babbage era 
we can store not only datum hashes in <code>TxOut</code> but also we can inline datum values
stright into <code>TxOut</code>. To distinguish between two cases we use <code>DatumMode</code> wrapper.
It's available from Babbage era. In Alonzo era we can use only <code>HashDatum</code> mode.</p>
<p>Let's create another Tx to post solution to the puzzle. It seems to be more involved but don't be scary.
We will take it bit by bit:</p>
<pre><code class="language-haskell">guess :: PubKeyHash -&gt; BuiltinByteString -&gt; Run Bool
guess pkh answer = do
  utxos &lt;- utxoAt gameScript             -- get game script UTXO
  let [(gameRef, gameOut)] = utxos       --   we know there is only one game UTXO
  mDat &lt;- datumAt @GameDatum gameRef     -- read game's datum
  case mDat of                           -- if there is a datum
    Just dat -&gt; do                       -- let's create TX, sign it and submit
      submitTx pkh $ guessTx pkh gameRef (txOutValue gameOut) dat answer
    Nothing -&gt; logError &quot;No datum&quot;
</code></pre>
<p>This function is a bit bigger because now we want to spend not only our funds but also the fund of the script.
For that we look up the script UTXO (<code>utxoAt</code>) and look up its datum (<code>datumAt</code>) and when it all succeeds
we can form the right TX, sign it with our key and post it to blockchain.</p>
<p>Functions that query blockchain are often defined on addresses or <code>TxOutRef</code>'s:</p>
<pre><code class="language-haskell">utxoAt  :: HasAddress addr =&gt; addr -&gt; Run [(TxOutRef, TxOut)]
datumAt :: TxOutRef -&gt; Run (Maybe a)
</code></pre>
<p>Note that <code>datumAt</code> reads both hashed and inlined datums with the same interface.</p>
<p>With <code>logError</code> we can report custom errors. It will save the error to the log
and the whole test will fail with <code>testNoErrors</code> function or <code>noErrors</code> function.</p>
<p>Our <code>gameScript</code> has instance of <code>HasAddress</code>. It is an address of underlying script.
We should query the datum separately because <code>TxOut</code> contains only hash of it.
Let's look at the pure function that creates TX. Again we assemble TX from monoidal parts:</p>
<pre><code class="language-haskell">guessTx :: PubKeyHash -&gt; TxOutRef -&gt; Value -&gt; GameDatum -&gt; BuiltinByteString -&gt; Tx
guessTx pkh gameRef gameVal dat answer =
  mconcat
    [ spendScript gameScript gameRef (Guess answer) dat
    , payToKey pkh gameVal
    ]
</code></pre>
<p>We do two things:</p>
<ul>
<li>spend script with right datum and redeemer</li>
<li>pay the prize back to us</li>
</ul>
<p>To spend script we use function:</p>
<pre><code class="language-haskell">spendScript :: IsValidator script 
  =&gt; script -&gt; TxOutRef -&gt; RedeemerType script -&gt; DatumType script -&gt; Tx
</code></pre>
<p>We provide validator definition, reference to the UTXO of the script, and its redeemer and datum type.</p>
<p>The next thing is that we want to take the prize. For that we create output that holds the prize and
protected by our own pub key. We do it with the function:</p>
<pre><code class="language-haskell">payToKey :: PubKeyHash -&gt; Value -&gt; Tx
</code></pre>
<p>For V2 plutus (Babbage era and above) we can also use reference inputs.
They are inputs that we can only read datum and we don't need to spend them.
They came in two flavors to read inlined and hashed datum inputs:</p>
<pre><code class="language-haskell">refInputInline :: TxOutRef -&gt; Tx
refInputHash   :: ToData datum =&gt; TxOutRef -&gt; datum -&gt; Tx
</code></pre>
<p>Note that it's improtant to respect the way datum is stored and use corresponding 
type of reference input.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="typed-validator.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="time.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="typed-validator.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="time.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>

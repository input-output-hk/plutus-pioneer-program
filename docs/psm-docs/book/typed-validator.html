<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Typed validators - Plutus-simple-model tutorial</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="install.html"><strong aria-hidden="true">2.</strong> Installation</a></li><li class="chapter-item expanded "><a href="quick-start.html"><strong aria-hidden="true">3.</strong> Quick start</a></li><li class="chapter-item expanded "><a href="use-tasty.html"><strong aria-hidden="true">4.</strong> Testing with Tasty</a></li><li class="chapter-item expanded "><a href="create-tx.html"><strong aria-hidden="true">5.</strong> Creation of transactions</a></li><li class="chapter-item expanded "><a href="typed-validator.html" class="active"><strong aria-hidden="true">6.</strong> Typed validators</a></li><li class="chapter-item expanded "><a href="test-scripts.html"><strong aria-hidden="true">7.</strong> Test scripts</a></li><li class="chapter-item expanded "><a href="time.html"><strong aria-hidden="true">8.</strong> Work with time</a></li><li class="chapter-item expanded "><a href="logs.html"><strong aria-hidden="true">9.</strong> Using logs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="logs/log-debug.html"><strong aria-hidden="true">9.1.</strong> Log debug information</a></li><li class="chapter-item expanded "><a href="logs/log-error.html"><strong aria-hidden="true">9.2.</strong> Log custom errors</a></li><li class="chapter-item expanded "><a href="logs/skip-logs.html"><strong aria-hidden="true">9.3.</strong> How to skip messages from logs</a></li><li class="chapter-item expanded "><a href="logs/human-readable-names.html"><strong aria-hidden="true">9.4.</strong> Human readable names</a></li></ol></li><li class="chapter-item expanded "><a href="fake-coins.html"><strong aria-hidden="true">10.</strong> Custom coins</a></li><li class="chapter-item expanded "><a href="check-balance.html"><strong aria-hidden="true">11.</strong> Check balances</a></li><li class="chapter-item expanded "><a href="unit-tests.html"><strong aria-hidden="true">12.</strong> How to use in unit tests</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="unit-tests/negative.html"><strong aria-hidden="true">12.1.</strong> Write negative tests</a></li><li class="chapter-item expanded "><a href="unit-tests/custom-fail.html"><strong aria-hidden="true">12.2.</strong> Fail on a custom condition</a></li><li class="chapter-item expanded "><a href="unit-tests/check-budget.html"><strong aria-hidden="true">12.3.</strong> Check TX budget</a></li></ol></li><li class="chapter-item expanded "><a href="box.html"><strong aria-hidden="true">13.</strong> Box - a typed TxOut</a></li><li class="chapter-item expanded "><a href="staking.html"><strong aria-hidden="true">14.</strong> Staking and certificates</a></li><li class="chapter-item expanded "><a href="rewards.html"><strong aria-hidden="true">15.</strong> Certificates and withdrawals of the rewards</a></li><li class="chapter-item expanded "><a href="ledger-export.html"><strong aria-hidden="true">16.</strong> Ledger reexports</a></li><li class="chapter-item expanded "><a href="query.html"><strong aria-hidden="true">17.</strong> How to query Blockchain</a></li><li class="chapter-item expanded "><a href="plutus-v2.html"><strong aria-hidden="true">18.</strong> Plutus V2 features</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Plutus-simple-model tutorial</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="typed-validators"><a class="header" href="#typed-validators">Typed validators</a></h1>
<p>You might be familiar with the notion of <code>TypedValidator</code> from the library <code>plutus-ledger</code>
which comes from the repo <code>plutus-apps</code>. In practice <code>plutus-apps</code> is heavy-weight and 
often becomes obsolete. To mitigate it's shortcomings in this library we stay at the 
plutus level. We work with types that are supported by <code>plutus-ledger-api</code> and
don't use higher-level types from <code>plutus-ledger</code>.</p>
<p>Nonetheless it's great to have type-safety and watch out for which datums and redeemers are
applied to specific validators. For that the library <code>plutus-simple-model</code> uses 
lightweight wrappers to enforce types for datums and redeemers based on scripts. 
They are defined in the module <code>Plutus.Model.Validator</code>.</p>
<p>There are three types of typed valdiators:</p>
<ul>
<li>
<p>typed validators for scripts: </p>
<pre><code class="language-haskell">newtype TypedValidator datum redeemer = TypedValidator (Versioned Validator)
</code></pre>
</li>
<li>
<p>typed minting policies:</p>
<pre><code class="language-haskell">newtype TypedPolicy redeemer = TypedPolicy (Versioned MintingPolicy)
</code></pre>
</li>
<li>
<p>typed stake validators:</p>
<pre><code class="language-haskell">newtype StakeValidator redeemer = TypedStake (Versioned StakeValidator)
</code></pre>
</li>
</ul>
<p>Where <code>Versioned</code> attaches plutus language version to the entity.
Plutus has several versions of the language (at the moment they are V1 and V2).
We can tag entities with Language version by functions:</p>
<pre><code class="language-haskell">toV1, toV2 :: a -&gt; Versioned a
</code></pre>
<p>We use trick with phantom types to attach type info to the underlying script.
Also we have type classes that can extract the type info:</p>
<pre><code class="language-haskell">type IsData a = (ToData a, FromData a)

class IsData (DatumType a) =&gt; HasDatum a where
  type DatumType a :: Type

class IsData (RedeemerType a) =&gt; HasRedeemer a where
  type RedeemerType a :: Type
</code></pre>
<p>Also we can extract language and underlying validator or hash:</p>
<pre><code class="language-haskell">class HasLanguage a where
  getLanguage :: a -&gt; C.Language
  -- ^ Get plutus language version

class HasValidator a where
  toValidator :: a -&gt; Validator
  -- ^ Get internal validator

class HasValidatorHash a where
  toValidatorHash :: a -&gt; ValidatorHash
  -- ^ Get internal validator
</code></pre>
<p>We have constraints synonyms for validator and validator hash based entities:</p>
<pre><code class="language-haskell">type IsValidator a = (HasAddress a, HasDatum a, HasRedeemer a, HasLanguage a, HasValidator a)

type IsValidatorHash a = (HasAddress a, HasDatum a, HasRedeemer a, HasLanguage a, HasValidatorHash a)
</code></pre>
<p>In <code>plutus-ledger</code> we created a special tag for example <code>Game</code> and we 
instanciated similiar type class called <code>ValidatorTypes</code> to specify datum and redeemer types.</p>
<p>In <code>plutus-simple-model</code> we have instances of type class <code>IsValidator</code> for all typed scripts:
<code>TypedValidator</code>, <code>TypedPolciy</code> and <code>TypedStake</code>. Instead of defining a type tag we
just use it as type synonym for:</p>
<pre><code class="language-haskell">type Game = TypedValidator GameDatum GameRedeemer
</code></pre>
<p>We can create validator with plutus or plutarch and wrap it to <code>TypedValidator</code>:</p>
<pre><code class="language-haskell">gameScript :: Game
gameScript = TypedValidator $ toV1 $ mkValidatorScript $$(PlutusTx.compile [|| gameContract ||])
</code></pre>
<p>We have constructors to create typed validators for different versions of the Plutus.
To define which version we are going to use we import constructors from <code>Plutus.Model.V1</code>
or <code>Plutus.Model.V2</code>. We have constructors like <code>mkTypedValidator</code> or <code>mkTypedPolicy</code>
with the same names but internally they use corresponding language tag to
annotate the version of the language properly.</p>
<p>Let's imagine that we work with PlutusV1. Then we import:</p>
<pre><code class="language-haskell">import Plutus.Model.V1
</code></pre>
<p>And we have alias <code>mkTypedValidator</code> which combines wrappers:</p>
<pre><code class="language-haskell">gameScript = mkTypedValidator $$(PlutusTx.compile [|| gameContract ||])
</code></pre>
<p>Based on this <code>gameContract</code> should have type <code>BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ()</code>.
But in plutus development we used to write typed valdiators and then wrap them <code>mkTypedValidator</code>.</p>
<p>For plutus development there is function to make script defined in type-safe way 
to work on raw builtin data (it's also defined in corresponding <code>Plutus.Model.V1</code> or <code>.V2</code> module):</p>
<pre><code class="language-haskell">toBuiltinValidator :: (UnsafeFromData datum, UnsafeFromData redeemer) 
  =&gt; (datum -&gt; redeemer -&gt; ScriptContext -&gt; Bool)
  -&gt; (BuiltinData -&gt; BuiltinData -&gt; BuiltinData -&gt; ()) 
</code></pre>
<p>So in plutus development we can define validator:</p>
<pre><code class="language-haskell">import Plutus.Model.V1

gameContract :: GameDatum -&gt; GameRedeemer -&gt; ScriptContext -&gt; Bool
gameContract = ...

gameScript :: Game
gameScript = TypedValidator $ 
  mkValidatorScript $$(PlutusTx.compile [|| toBuiltinValidator gameContract ||])
</code></pre>
<p>Note that plutus onchain code should also use proper Plutus version.
Actually <code>toBuiltinValidator</code> won't work on wrong version.</p>
<p>Similiar functions are defined for minting policies and stake valdiators:</p>
<pre><code class="language-haskell">mkTypedPolicy :: CompiledCode (BuiltinData -&gt; BuiltinData -&gt; ()) -&gt; TypedPolicy redeemer
mkTypedStake  :: CompiledCode (BuiltinData -&gt; BuiltinData -&gt; ()) -&gt; TypedStake redeemer

toBuiltinPolicy :: (UnsafeFromData redeemer)
  =&gt; (redeemer -&gt; ScriptContext -&gt; Bool) -&gt; (BuiltinData -&gt; BuiltinData -&gt; ())

toBuiltinStake :: (UnsafeFromData redeemer)
  =&gt; (redeemer -&gt; ScriptContext -&gt; Bool) -&gt; (BuiltinData -&gt; BuiltinData -&gt; ())
</code></pre>
<h2 id="example-of-typed-validator"><a class="header" href="#example-of-typed-validator">Example of typed validator</a></h2>
<p>Let's define a game of hash guessing. </p>
<pre><code class="language-haskell">newtype GameDatum = GuessHash Plutus.BuiltinByteString
  deriving (Eq)

newtype GameAct = Guess Plutus.BuiltinByteString

PlutusTx.unstableMakeIsData ''GameDatum
PlutusTx.unstableMakeIsData ''GameAct
</code></pre>
<p>We have some secret bytestring that is hashed with SHA256 and result of hashing
is open to everybody. If user can guess the origin user can take the value of the UTXO.</p>
<p>Let's define a contract for this logic:</p>
<pre><code class="language-haskell">gameContract :: GameDatum -&gt; GameAct -&gt; ScriptContext -&gt; Bool
gameContract (GuessHash h) (Guess answer) _ =
  Plutus.sha2_256 answer Plutus.== h
</code></pre>
<p>Let's compile the script and create <code>TypedValidator</code> for testing with our library:</p>
<pre><code class="language-haskell">import Plutus.Model (toBuiltinValidator, TypedValidator, mkTypedValidator)

type Game = TypedValidator GameDatum GameAct

-- | The GeroGov validator script instance
gameScript :: Game
gameScript = mkTypedValidator $$(PlutusTx.compile [|| toBuiltinValidator gameContract ||])
</code></pre>
<p>We have to define it in separate module than the types definition otherwise GHC
complains on mixing compilation with QuasiQuotes with derivation of <code>UnsafeData</code> instances
with template haskell.</p>
<p>That's it! This is our contract that we are going to test.</p>
<h2 id="pay-to-script-by-validatorhash"><a class="header" href="#pay-to-script-by-validatorhash">Pay to script by ValidatorHash</a></h2>
<p>Sometimes we don't have the validator definition but we want to pay to specific script
by <code>ValidatorHash</code>. For that we can use the same function <code>payToScript</code>
but we should use <code>TypeValidatorHash</code>-wrapper instead of <code>TypedValidator</code>:</p>
<pre><code class="language-haskell">newtype TypedValidatorHash datum redeemer = TypedValidatorHash (Versioned ValidatorHash)
</code></pre>
<p>In this case our script can be defined like this:</p>
<pre><code class="language-haskell">gameScript :: Game
gameScript = TypedValidatorHash $ toV1 gameValHash
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="create-tx.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="test-scripts.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="create-tx.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="test-scripts.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <!-- Livereload script (if served using the cli tool) -->
        <script>
            const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsAddress = wsProtocol + "//" + location.host + "/" + "__livereload";
            const socket = new WebSocket(wsAddress);
            socket.onmessage = function (event) {
                if (event.data === "reload") {
                    socket.close();
                    location.reload();
                }
            };

            window.onbeforeunload = function() {
                socket.close();
            }
        </script>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
